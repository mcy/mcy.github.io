<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Better Trait Resolution in Rust &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Better Trait Resolution in Rust &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/trait-rez-wishlist-84fcd78a6ec5e4ee8cf2aece6499da29b9f685a3.png"> <meta property="og:title" content="Better Trait Resolution in Rust &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/trait-rez-wishlist-84fcd78a6ec5e4ee8cf2aece6499da29b9f685a3.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2023/04/04/trait-rez-wishlist/"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2023-04-04 • 1311 words • 10 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#rust">#rust</a> • <a href="https://mcyoung.xyz/tags.html#language-design">#language-design</a> </span> <h1><a href="/2023/04/04/trait-rez-wishlist/"> Better Trait Resolution in Rust </a></h1> </div> <div class="post"> <p>Traits are the core of polymorphism in Rust. Let’s review:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">trait</span> <span class="n">Stringer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Stringer</span> <span class="k">for</span> <span class="nb">i32</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="nd">format!</span><span class="p">(</span><span class="s">"{self}"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Prints `42`.</span>
<span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="mi">42</span><span class="nf">.string</span><span class="p">());</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj ZSI6InB1YiBmbiBtYWluKCkge1xudHJhaXQgU3RyaW5nZXIge1xuICBmbiBz dHJpbmcoJnNlbGYpIC0+IFN0cmluZztcbn1cblxuaW1wbCBTdHJpbmdlciBm b3IgaTMyIHtcbiAgZm4gc3RyaW5nKCZzZWxmKSAtPiBTdHJpbmcge1xuICAg IGZvcm1hdCEoXCJ7c2VsZn1cIilcbiAgfVxufVxuXG4vLyBQcmludHMgYDQy YC5cbnByaW50bG4hKFwie31cIiwgNDIuc3RyaW5nKCkpO1xufVxuIiwiY29t cGlsZXJzIjpbXSwiZXhlY3V0b3JzIjpbeyJjb21waWxlclZpc2libGUiOmZh bHNlLCJjb21waWxlck91dHB1dFZpc2libGUiOnRydWUsImNvbXBpbGVyIjp7 ImlkIjoiYmV0YSIsIm9wdGlvbnMiOiIifX1dfV19 ">godbolt</a><div class="codeblock-button">Rust</div></div></div> <p>Notice that we call the trait method <code class="language-plaintext highlighter-rouge">Stringer::string</code> directly on the value in question. This means that traits (at least, those currently in scope) inject their methods into the namespace of anything that implements them.</p> <p>Now, this isn’t immediately a problem, because Rust’s namespace lookup rules are such that methods <em>inherent</em> to a type are searched for first:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">trait</span> <span class="n">Stringer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Woofer</span><span class="p">;</span>
<span class="k">impl</span> <span class="n">Stringer</span> <span class="k">for</span> <span class="n">Woofer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="nd">format!</span><span class="p">(</span><span class="s">"woof"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Woofer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="nd">format!</span><span class="p">(</span><span class="s">"bark"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Prints `bark`.</span>
<span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">Woofer</span><span class="nf">.string</span><span class="p">());</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj ZSI6InB1YiBmbiBtYWluKCkge1xudHJhaXQgU3RyaW5nZXIge1xuICBmbiBz dHJpbmcoJnNlbGYpIC0+IFN0cmluZztcbn1cblxuc3RydWN0IFdvb2Zlcjtc bmltcGwgU3RyaW5nZXIgZm9yIFdvb2ZlciB7XG4gIGZuIHN0cmluZygmc2Vs ZikgLT4gU3RyaW5nIHtcbiAgICBmb3JtYXQhKFwid29vZlwiKVxuICB9XG59 XG5cbmltcGwgV29vZmVyIHtcbiAgZm4gc3RyaW5nKCZzZWxmKSAtPiBTdHJp bmcge1xuICAgIGZvcm1hdCEoXCJiYXJrXCIpXG4gIH1cbn1cblxuLy8gUHJp bnRzIGBiYXJrYC5cbnByaW50bG4hKFwie31cIiwgV29vZmVyLnN0cmluZygp KTtcbn1cbiIsImNvbXBpbGVycyI6W10sImV4ZWN1dG9ycyI6W3siY29tcGls ZXJWaXNpYmxlIjpmYWxzZSwiY29tcGlsZXJPdXRwdXRWaXNpYmxlIjp0cnVl LCJjb21waWxlciI6eyJpZCI6ImJldGEiLCJvcHRpb25zIjoiIn19XX1dfQ== ">godbolt</a><div class="codeblock-button">Rust</div></div></div> <p>This means that traits cannot <em>easily</em> break downstream code by adding new methods, but there are a few possible hazards:</p> <ul> <li> <p>If the owner of a type adds a method with the same name as a trait method, it will override direct (i.e., <code class="language-plaintext highlighter-rouge">foo.string()</code>) calls to that trait method, even if the type owner is unaware of the trait method.</p> </li> <li> <p>If traits <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code> are in scope, and <code class="language-plaintext highlighter-rouge">String</code> implements both, and we call <code class="language-plaintext highlighter-rouge">str.foo()</code> (which resolves to <code class="language-plaintext highlighter-rouge">A::foo()</code>), and later <code class="language-plaintext highlighter-rouge">B</code> adds a new method <code class="language-plaintext highlighter-rouge">B::foo()</code>, the callsite for <code class="language-plaintext highlighter-rouge">String</code> will break. <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code>’s owners do not need to be aware of each other for this to happen.</p> </li> </ul> <p>Of course, Rust has a disambiguation mechanism. Given any trait implementation <code class="language-plaintext highlighter-rouge">Foo: Bar</code>, we can reference its items by writing <code class="language-plaintext highlighter-rouge">&lt;Foo as Bar&gt;::baz</code>. However, this syntax is <em>very</em> unweildy (it doesn’t work with method chaining), so it doesn’t get used. As a result, small evolution hazards can build up in a large codebase.</p> <p>Those who know me know that I often talk about a syntax that I call <code class="language-plaintext highlighter-rouge">foo.Trait::method()</code>, or “qualified method call syntax”. In this post, I want to discuss this syntax in more detail, and some related ideas, and how they factor into type and trait design.</p> <h2 id="paths-as-methods"><a href="#paths-as-methods">Paths-as-Methods</a></h2> <p>This idea isn’t new; others have proposed it, and it forms the core of Carbon’s version of trait method calls (you can read more about Carbon’s name lookup story <a href="https://github.com/carbon-language/carbon-lang/blob/trunk/docs/design/expressions/member_access.md">here</a>).</p> <p>Let’s recreate the original example in Carbon (bear in mind that I am not an expert on this language, and the semantics are still up in the air).</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n">interface</span> <span class="n">Stringer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nb">String</span><span class="p">[</span><span class="k">self</span><span class="p">:</span> <span class="k">Self</span><span class="p">]()</span> <span class="k">-&gt;</span> <span class="nb">String</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">external</span> <span class="k">impl</span> <span class="nb">i32</span> <span class="k">as</span> <span class="n">Stringer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nb">String</span><span class="p">[</span><span class="k">self</span><span class="p">:</span> <span class="k">Self</span><span class="p">]()</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Carbon</span><span class="nf">.Print</span><span class="p">(</span><span class="mf">42.</span><span class="p">(</span><span class="n">Stringer</span><span class="py">.String</span><span class="p">)())</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Carbon</div></div></div> <p>Notice <code class="language-plaintext highlighter-rouge">42.(Stringer.String)()</code>: Carbon <em>requires</em> that we qualify the method call, because <code class="language-plaintext highlighter-rouge">42</code> has the concrete type <code class="language-plaintext highlighter-rouge">i32</code>. If this were in a generic context and we had a type variable bounded by <code class="language-plaintext highlighter-rouge">Stringer</code>, we could just write <code class="language-plaintext highlighter-rouge">x.String()</code>; no ambiguity.</p> <p>In Carbon, all qualification uses <code class="language-plaintext highlighter-rouge">.</code>, so they have to add parens. Because Rust uses <code class="language-plaintext highlighter-rouge">::</code> for qualifying paths, we don’t have this syntactic abiguity, so we can augment the syntax to allow more path expressions after the <code class="language-plaintext highlighter-rouge">.</code>.</p> <p>The current grammar is</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-text" data-lang="text">MethodCallExpression :
   Expression . PathExprSegment (CallParams?)

PathExprSegment :
   PathIdentSegment (:: GenericArgs)?</code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Plaintext</div></div></div> <p>That is, exactly one identifier and an optional turbofish. I would like to see this extended to allow any <code class="language-plaintext highlighter-rouge">QualifiedPathInExpression</code> after the <code class="language-plaintext highlighter-rouge">.</code> and before the parens. This would allow, for example:</p> <ul> <li><code class="language-plaintext highlighter-rouge">expr.Trait::method()</code></li> <li><code class="language-plaintext highlighter-rouge">expr.Self::method()</code></li> <li><code class="language-plaintext highlighter-rouge">expr.&lt;Foo as Trait&gt;::method()</code></li> <li><code class="language-plaintext highlighter-rouge">expr.::path::to::Trait::&lt;Args&gt;::method::&lt;MoreArgs&gt;()</code></li> </ul> <p>These would all be desugared as the equivalent UFCS, taking into account that method call syntax can trigger autoref.</p> <ul> <li><code class="language-plaintext highlighter-rouge">Trait::method(expr)</code></li> <li><code class="language-plaintext highlighter-rouge">Self::method(expr)</code></li> <li><code class="language-plaintext highlighter-rouge">&lt;Foo as Trait&gt;::method(expr)</code></li> <li><code class="language-plaintext highlighter-rouge">::path::to::Trait::&lt;Args&gt;::method::&lt;MoreArgs&gt;(expr)</code></li> </ul> <p>The method would still need to be valid to have been called via <code class="language-plaintext highlighter-rouge">.</code> syntax; I’m not proposing we add the following, even though it is unambiguous.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<span class="p">}</span>

<span class="c1">// Would be equivalent to `square(42)`.</span>
<span class="mi">42</span><span class="py">.self</span><span class="p">::</span><span class="nf">square</span><span class="p">()</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Trait method callers can now use qualified method call syntax where they might want to use UFCS without issues around wordiness.</p> <h2 id="impl-modality"><a href="#impl-modality">Impl Modality</a></h2> <p>Of course, this isn’t the only idea from Carbon’s interfaces worth stealing; Carbon also has a notion of “external” and “internal” <code class="language-plaintext highlighter-rouge">impl</code>s; I will call these “<code class="language-plaintext highlighter-rouge">impl</code> modes”.</p> <p>An external <code class="language-plaintext highlighter-rouge">impl</code> is like the one we showed above, whose methods can only be found by qualified lookup: <code class="language-plaintext highlighter-rouge">foo.(Bar.Baz)()</code>. An internal <code class="language-plaintext highlighter-rouge">impl</code> is one which is “part” of a type.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n">interface</span> <span class="n">Stringer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nb">String</span><span class="p">[</span><span class="k">self</span><span class="p">:</span> <span class="k">Self</span><span class="p">]()</span> <span class="k">-&gt;</span> <span class="nb">String</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">class</span> <span class="n">Woofer</span> <span class="p">{</span>
  <span class="k">impl</span> <span class="k">as</span> <span class="n">Stringer</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nb">String</span><span class="p">[</span><span class="k">self</span><span class="p">:</span> <span class="k">Self</span><span class="p">]()</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="n">w</span><span class="p">:</span> <span class="n">Woofer</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
  <span class="n">w</span><span class="nf">.String</span><span class="p">()</span>  <span class="c1">// Unqualified!</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Carbon</div></div></div> <p>This also implies that we don’t need to import <code class="language-plaintext highlighter-rouge">Stringer</code> to call <code class="language-plaintext highlighter-rouge">w.String()</code>.</p> <p>There are definitely traits in Rust which fit into these modes.</p> <p><code class="language-plaintext highlighter-rouge">Clone</code> and <code class="language-plaintext highlighter-rouge">Iterator</code> almost always want to be internal. An iterator exists to implement <code class="language-plaintext highlighter-rouge">Iterator</code>, and cloning is a fundamental operation. Because both of these traits are in the prelude, it’s not a problem, but it is a problem for traits provided by a non-<code class="language-plaintext highlighter-rouge">std</code> crate, like <a href="https://docs.rs/rand/latest/rand/trait.Rng.html"><code class="language-plaintext highlighter-rouge">rand::Rng</code></a>. The lack of a way to do this leads to the proliferation of <code class="language-plaintext highlighter-rouge">prelude</code> modules and namespace pollution. (I think that <code class="language-plaintext highlighter-rouge">prelude</code>s are bad library design.)</p> <p>On the other hand, something like <code class="language-plaintext highlighter-rouge">Debug</code> wants to be external very badly. It almost never makes sense to call <code class="language-plaintext highlighter-rouge">foo.fmt()</code>, since that gets called for you by <code class="language-plaintext highlighter-rouge">println!</code> and friends; not to mention that all of the <code class="language-plaintext highlighter-rouge">std::fmt</code> traits have a method <code class="language-plaintext highlighter-rouge">fmt()</code>, making such a call likely to need disambiguation with UFCS. <code class="language-plaintext highlighter-rouge">Borrow</code> is similar; it exists to be a bound for things like <code class="language-plaintext highlighter-rouge">Cow</code> more than to provide the <code class="language-plaintext highlighter-rouge">.borrow()</code> method.</p> <p>There’s also a third mode, which I will call “extension impls”. These want to inject methods into a type, either to extend it, like <a href="https://docs.rs/itertools/latest/itertools/"><code class="language-plaintext highlighter-rouge">itertools</code></a>, or as part of some framework, like <a href="https://docs.rs/tap/latest/tap/"><code class="language-plaintext highlighter-rouge">tap</code></a>. This use of traits is somewhat controversial, but I can sympathize with wanting to have this.</p> <p>If we have paths-as-methods, we can use this classification to move towards something more like the Carbon model of method lookup, without impacting existing uses.</p> <p>My strawman is to add a <code class="language-plaintext highlighter-rouge">#[mode]</code> attribute to place on trait <code class="language-plaintext highlighter-rouge">impls</code>, which allows a caller to select the behavior:</p> <ul> <li><code class="language-plaintext highlighter-rouge">#[mode(extension)]</code> is today’s behavior. The <code class="language-plaintext highlighter-rouge">impl</code>’s trait must be in scope so that unqualified calls like <code class="language-plaintext highlighter-rouge">foo.method()</code> resolve to it.</li> <li><code class="language-plaintext highlighter-rouge">#[mode(internal)]</code> makes it so that <code class="language-plaintext highlighter-rouge">foo.method()</code> can resolve to a method from this <code class="language-plaintext highlighter-rouge">impl</code> without its trait being in scope<sup id="fnref:internal-restrictions" role="doc-noteref"><a href="#fn:internal-restrictions" class="footnote" rel="footnote">1</a></sup>. It can only be applied to <code class="language-plaintext highlighter-rouge">impl</code>s that are such that you could write a corresponding inherent impl, so things like <code class="language-plaintext highlighter-rouge">#[mode(internal)] impl&lt;T&gt; Trait for T { .. }</code> are forbidden.</li> <li><code class="language-plaintext highlighter-rouge">#[mode(external)]</code> makes it so that <code class="language-plaintext highlighter-rouge">foo.method()</code> never resolves to a method from this <code class="language-plaintext highlighter-rouge">impl</code>. It must be called as <code class="language-plaintext highlighter-rouge">Trait::method(foo)</code> or <code class="language-plaintext highlighter-rouge">foo.Trait::method()</code>.</li> </ul> <p>Every trait would be <code class="language-plaintext highlighter-rouge">#[mode(extension)]</code> if not annotated, and it would be easy to migrate to external-by-default across an edition. Similarly, we could change whether a <code class="language-plaintext highlighter-rouge">std</code> impl is external vs extension based on the edition of the caller, and provide a <code class="language-plaintext highlighter-rouge">cargo fix</code> rewrite to convert from <code class="language-plaintext highlighter-rouge">foo.method()</code> to <code class="language-plaintext highlighter-rouge">foo.Trait::method()</code>.</p> <p>It may also make sense for traits to be able to specify the default modality of their <code class="language-plaintext highlighter-rouge">impl</code>s, but I haven’t thought very carefully about this.</p> <p>Note that moving in the external -&gt; extension -&gt; internal direction is not a breaking change, but moving the other way is.</p> <h2 id="what-about-delegation"><a href="#what-about-delegation">What about Delegation?</a></h2> <p>A related feature that I will touch on lightly is delegation; that is, being able to write something like the following:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c1">// crate a</span>
<span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">boing</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// crate b</span>
<span class="k">trait</span> <span class="n">Bar</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">boing</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Bar</span> <span class="k">for</span> <span class="n">Foo</span> <span class="p">{</span>
  <span class="k">use</span> <span class="nn">Foo</span><span class="p">::</span><span class="n">boing</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The <code class="language-plaintext highlighter-rouge">use</code> in the <code class="language-plaintext highlighter-rouge">impl</code> indicates that we want to re-use <code class="language-plaintext highlighter-rouge">Foo::boing</code> to implement <code class="language-plaintext highlighter-rouge">&lt;Foo as Bar&gt;::boing</code>. This saves us having to write out a function signature, and results in less work for the compiler because that’s one less function we risk asking LLVM to codegen for us (at scale, this is a Big Deal).</p> <p>You could imagine using delegation instead of <code class="language-plaintext highlighter-rouge">#[mode]</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Woofer</span><span class="p">;</span>
<span class="k">impl</span> <span class="n">Stringer</span> <span class="k">for</span> <span class="n">Woofer</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="nd">format!</span><span class="p">(</span><span class="s">"woof"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Woofer</span> <span class="p">{</span>
  <span class="k">use</span> <span class="nn">Stringer</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The reason I haven’t gone down this road is because delegation is a very large feature, and doesn’t give us a clean way to express <code class="language-plaintext highlighter-rouge">#[mode(external)]</code>, which is a big part of what I want. A delegation-compatible way to express this proposal is to not add <code class="language-plaintext highlighter-rouge">#[mode(internal)]</code>, and add <code class="language-plaintext highlighter-rouge">use Trait::method;</code> and <code class="language-plaintext highlighter-rouge">use Trait::*;</code> (and no other variations) inside of inherent <code class="language-plaintext highlighter-rouge">impl</code> blocks.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>I don’t have the personal bandwidth to write RFCs for any of this stuff, but it’s something I talk about a lot as a potential evolution hazard for Rust. I hope that putting these ideas to paper can help make name resolution in Rust more robust.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:internal-restrictions" role="doc-endnote"> <p>This needs to carry a bunch of other restrictions, because it’s equivalent to adding inherent methods to the implee. For example, none of the methods can have the same name as a method in any other inherent or internal impl block, and internal impl methods should take lookup priority over extension impl methods during name lookup. <a href="#fnref:internal-restrictions" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-05-13</span> / <h6 style="display:inline"><a href="/2025/05/13/protobuf-tip-5/">Protobuf Tip #5: Avoid import public/weak</a></h6> <li> <span class="post-meta">2025-04-29</span> / <h6 style="display:inline"><a href="/2025/04/29/protobuf-tip-4/">Protobuf Tip #4: Accepting Mistakes We Can't Fix</a></h6> <li> <span class="post-meta">2025-04-22</span> / <h6 style="display:inline"><a href="/2025/04/22/protobuf-tip-3/">Protobuf Tip #3: Enum Names Need Prefixes</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2023-04-04</span> <span class="censored">•</span> <span class="censored">1311</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">10</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#rust"><span class="censored">#rust</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#language-design"><span class="censored">#language-design</span></a> </span> <h1><a href="/2023/04/04/trait-rez-wishlist/"> <span class="censored">Better</span> <span class="censored">Trait</span> <span class="censored">Resolution</span> <span class="censored">in</span> <span class="censored">Rust</span> </a></h1> </div> <div class="post"> <p><span class="censored">Traits</span> <span class="censored">are</span> <span class="censored">the</span> <span class="censored">core</span> <span class="censored">of</span> <span class="censored">polymorphism</span> <span class="censored">in</span> <span class="censored">Rust.</span> <span class="censored">Let’s</span> <span class="censored">review:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">trait</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">string</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="k"><span class="censored">for</span></span> <span class="nb"><span class="censored">i32</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">string</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="nd"><span class="censored">format!</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"{self}"</span></span><span class="p"><span class="censored">)</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">Prints</span> <span class="censored">`42`.</span></span>
<span class="nd"><span class="censored">println!</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"{}"</span></span><span class="p"><span class="censored">,</span></span> <span class="mi"><span class="censored">42</span></span><span class="nf"><span class="censored">.string</span></span><span class="p"><span class="censored">());</span></span></code></pre></figure><div class="codeblock-buttons"> <a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj%0AZSI6InB1YiBmbiBtYWluKCkge1xudHJhaXQgU3RyaW5nZXIge1xuICBmbiBz%0AdHJpbmcoJnNlbGYpIC0+IFN0cmluZztcbn1cblxuaW1wbCBTdHJpbmdlciBm%0Ab3IgaTMyIHtcbiAgZm4gc3RyaW5nKCZzZWxmKSAtPiBTdHJpbmcge1xuICAg%0AIGZvcm1hdCEoXCJ7c2VsZn1cIilcbiAgfVxufVxuXG4vLyBQcmludHMgYDQy%0AYC5cbnByaW50bG4hKFwie31cIiwgNDIuc3RyaW5nKCkpO1xufVxuIiwiY29t%0AcGlsZXJzIjpbXSwiZXhlY3V0b3JzIjpbeyJjb21waWxlclZpc2libGUiOmZh%0AbHNlLCJjb21waWxlck91dHB1dFZpc2libGUiOnRydWUsImNvbXBpbGVyIjp7%0AImlkIjoiYmV0YSIsIm9wdGlvbnMiOiIifX1dfV19%0A"><span class="censored">godbolt</span></a><div class="codeblock-button"><span class="censored">Rust</span></div> </div> </div> <p><span class="censored">Notice</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">call</span> <span class="censored">the</span> <span class="censored">trait</span> <span class="censored">method</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Stringer::string</span></code> <span class="censored">directly</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">in</span> <span class="censored">question.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">traits</span> <span class="censored">(at</span> <span class="censored">least,</span> <span class="censored">those</span> <span class="censored">currently</span> <span class="censored">in</span> <span class="censored">scope)</span> <span class="censored">inject</span> <span class="censored">their</span> <span class="censored">methods</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">namespace</span> <span class="censored">of</span> <span class="censored">anything</span> <span class="censored">that</span> <span class="censored">implements</span> <span class="censored">them.</span></p> <p><span class="censored">Now,</span> <span class="censored">this</span> <span class="censored">isn’t</span> <span class="censored">immediately</span> <span class="censored">a</span> <span class="censored">problem,</span> <span class="censored">because</span> <span class="censored">Rust’s</span> <span class="censored">namespace</span> <span class="censored">lookup</span> <span class="censored">rules</span> <span class="censored">are</span> <span class="censored">such</span> <span class="censored">that</span> <span class="censored">methods</span> <em><span class="censored">inherent</span></em> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">are</span> <span class="censored">searched</span> <span class="censored">for</span> <span class="censored">first:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">trait</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">string</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">struct</span></span> <span class="n"><span class="censored">Woofer</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="k"><span class="censored">for</span></span> <span class="n"><span class="censored">Woofer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">string</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="nd"><span class="censored">format!</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"woof"</span></span><span class="p"><span class="censored">)</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Woofer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">string</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="nd"><span class="censored">format!</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"bark"</span></span><span class="p"><span class="censored">)</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">Prints</span> <span class="censored">`bark`.</span></span>
<span class="nd"><span class="censored">println!</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"{}"</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">Woofer</span></span><span class="nf"><span class="censored">.string</span></span><span class="p"><span class="censored">());</span></span></code></pre></figure><div class="codeblock-buttons"> <a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj%0AZSI6InB1YiBmbiBtYWluKCkge1xudHJhaXQgU3RyaW5nZXIge1xuICBmbiBz%0AdHJpbmcoJnNlbGYpIC0+IFN0cmluZztcbn1cblxuc3RydWN0IFdvb2Zlcjtc%0AbmltcGwgU3RyaW5nZXIgZm9yIFdvb2ZlciB7XG4gIGZuIHN0cmluZygmc2Vs%0AZikgLT4gU3RyaW5nIHtcbiAgICBmb3JtYXQhKFwid29vZlwiKVxuICB9XG59%0AXG5cbmltcGwgV29vZmVyIHtcbiAgZm4gc3RyaW5nKCZzZWxmKSAtPiBTdHJp%0Abmcge1xuICAgIGZvcm1hdCEoXCJiYXJrXCIpXG4gIH1cbn1cblxuLy8gUHJp%0AbnRzIGBiYXJrYC5cbnByaW50bG4hKFwie31cIiwgV29vZmVyLnN0cmluZygp%0AKTtcbn1cbiIsImNvbXBpbGVycyI6W10sImV4ZWN1dG9ycyI6W3siY29tcGls%0AZXJWaXNpYmxlIjpmYWxzZSwiY29tcGlsZXJPdXRwdXRWaXNpYmxlIjp0cnVl%0ALCJjb21waWxlciI6eyJpZCI6ImJldGEiLCJvcHRpb25zIjoiIn19XX1dfQ==%0A"><span class="censored">godbolt</span></a><div class="codeblock-button"><span class="censored">Rust</span></div> </div> </div> <p><span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">traits</span> <span class="censored">cannot</span> <em><span class="censored">easily</span></em> <span class="censored">break</span> <span class="censored">downstream</span> <span class="censored">code</span> <span class="censored">by</span> <span class="censored">adding</span> <span class="censored">new</span> <span class="censored">methods,</span> <span class="censored">but</span> <span class="censored">there</span> <span class="censored">are</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">possible</span> <span class="censored">hazards:</span></p> <ul> <li> <p><span class="censored">If</span> <span class="censored">the</span> <span class="censored">owner</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">adds</span> <span class="censored">a</span> <span class="censored">method</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">name</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">trait</span> <span class="censored">method,</span> <span class="censored">it</span> <span class="censored">will</span> <span class="censored">override</span> <span class="censored">direct</span> <span class="censored">(i.e.,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.string()</span></code><span class="censored">)</span> <span class="censored">calls</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">trait</span> <span class="censored">method,</span> <span class="censored">even</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">type</span> <span class="censored">owner</span> <span class="censored">is</span> <span class="censored">unaware</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">trait</span> <span class="censored">method.</span></p> </li> <li> <p><span class="censored">If</span> <span class="censored">traits</span> <code class="language-plaintext highlighter-rouge"><span class="censored">A</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">B</span></code> <span class="censored">are</span> <span class="censored">in</span> <span class="censored">scope,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">String</span></code> <span class="censored">implements</span> <span class="censored">both,</span> <span class="censored">and</span> <span class="censored">we</span> <span class="censored">call</span> <code class="language-plaintext highlighter-rouge"><span class="censored">str.foo()</span></code> <span class="censored">(which</span> <span class="censored">resolves</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">A::foo()</span></code><span class="censored">),</span> <span class="censored">and</span> <span class="censored">later</span> <code class="language-plaintext highlighter-rouge"><span class="censored">B</span></code> <span class="censored">adds</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">method</span> <code class="language-plaintext highlighter-rouge"><span class="censored">B::foo()</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">callsite</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">String</span></code> <span class="censored">will</span> <span class="censored">break.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">A</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">B</span></code><span class="censored">’s</span> <span class="censored">owners</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">aware</span> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">other</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">to</span> <span class="censored">happen.</span></p> </li> </ul> <p><span class="censored">Of</span> <span class="censored">course,</span> <span class="censored">Rust</span> <span class="censored">has</span> <span class="censored">a</span> <span class="censored">disambiguation</span> <span class="censored">mechanism.</span> <span class="censored">Given</span> <span class="censored">any</span> <span class="censored">trait</span> <span class="censored">implementation</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Foo:</span> <span class="censored">Bar</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">reference</span> <span class="censored">its</span> <span class="censored">items</span> <span class="censored">by</span> <span class="censored">writing</span> <code class="language-plaintext highlighter-rouge"><span class="censored"><foo> <span class="censored">as</span> <span class="censored">Bar&gt;::baz</span></foo></span></code><span class="censored">.</span> <span class="censored">However,</span> <span class="censored">this</span> <span class="censored">syntax</span> <span class="censored">is</span> <em><span class="censored">very</span></em> <span class="censored">unweildy</span> <span class="censored">(it</span> <span class="censored">doesn’t</span> <span class="censored">work</span> <span class="censored">with</span> <span class="censored">method</span> <span class="censored">chaining),</span> <span class="censored">so</span> <span class="censored">it</span> <span class="censored">doesn’t</span> <span class="censored">get</span> <span class="censored">used.</span> <span class="censored">As</span> <span class="censored">a</span> <span class="censored">result,</span> <span class="censored">small</span> <span class="censored">evolution</span> <span class="censored">hazards</span> <span class="censored">can</span> <span class="censored">build</span> <span class="censored">up</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">large</span> <span class="censored">codebase.</span></p> <p><span class="censored">Those</span> <span class="censored">who</span> <span class="censored">know</span> <span class="censored">me</span> <span class="censored">know</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">often</span> <span class="censored">talk</span> <span class="censored">about</span> <span class="censored">a</span> <span class="censored">syntax</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">call</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.Trait::method()</span></code><span class="censored">,</span> <span class="censored">or</span> <span class="censored">“qualified</span> <span class="censored">method</span> <span class="censored">call</span> <span class="censored">syntax”.</span> <span class="censored">In</span> <span class="censored">this</span> <span class="censored">post,</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">discuss</span> <span class="censored">this</span> <span class="censored">syntax</span> <span class="censored">in</span> <span class="censored">more</span> <span class="censored">detail,</span> <span class="censored">and</span> <span class="censored">some</span> <span class="censored">related</span> <span class="censored">ideas,</span> <span class="censored">and</span> <span class="censored">how</span> <span class="censored">they</span> <span class="censored">factor</span> <span class="censored">into</span> <span class="censored">type</span> <span class="censored">and</span> <span class="censored">trait</span> <span class="censored">design.</span></p> <h2 id="paths-as-methods"><a href="#paths-as-methods"><span class="censored">Paths-as-Methods</span></a></h2> <p><span class="censored">This</span> <span class="censored">idea</span> <span class="censored">isn’t</span> <span class="censored">new;</span> <span class="censored">others</span> <span class="censored">have</span> <span class="censored">proposed</span> <span class="censored">it,</span> <span class="censored">and</span> <span class="censored">it</span> <span class="censored">forms</span> <span class="censored">the</span> <span class="censored">core</span> <span class="censored">of</span> <span class="censored">Carbon’s</span> <span class="censored">version</span> <span class="censored">of</span> <span class="censored">trait</span> <span class="censored">method</span> <span class="censored">calls</span> <span class="censored">(you</span> <span class="censored">can</span> <span class="censored">read</span> <span class="censored">more</span> <span class="censored">about</span> <span class="censored">Carbon’s</span> <span class="censored">name</span> <span class="censored">lookup</span> <span class="censored">story</span> <a href="https://github.com/carbon-language/carbon-lang/blob/trunk/docs/design/expressions/member_access.md"><span class="censored">here</span></a><span class="censored">).</span></p> <p><span class="censored">Let’s</span> <span class="censored">recreate</span> <span class="censored">the</span> <span class="censored">original</span> <span class="censored">example</span> <span class="censored">in</span> <span class="censored">Carbon</span> <span class="censored">(bear</span> <span class="censored">in</span> <span class="censored">mind</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">am</span> <span class="censored">not</span> <span class="censored">an</span> <span class="censored">expert</span> <span class="censored">on</span> <span class="censored">this</span> <span class="censored">language,</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">semantics</span> <span class="censored">are</span> <span class="censored">still</span> <span class="censored">up</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">air).</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n"><span class="censored">interface</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">[</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">:</span></span> <span class="k"><span class="censored">Self</span></span><span class="p"><span class="censored">]()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="n"><span class="censored">external</span></span> <span class="k"><span class="censored">impl</span></span> <span class="nb"><span class="censored">i32</span></span> <span class="k"><span class="censored">as</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">[</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">:</span></span> <span class="k"><span class="censored">Self</span></span><span class="p"><span class="censored">]()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">...</span></span> <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">Run</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">Carbon</span></span><span class="nf"><span class="censored">.Print</span></span><span class="p"><span class="censored">(</span></span><span class="mf"><span class="censored">42.</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">Stringer</span></span><span class="py"><span class="censored">.String</span></span><span class="p"><span class="censored">)())</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Carbon</span></div></div> </div> <p><span class="censored">Notice</span> <code class="language-plaintext highlighter-rouge"><span class="censored">42.(Stringer.String)()</span></code><span class="censored">:</span> <span class="censored">Carbon</span> <em><span class="censored">requires</span></em> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">qualify</span> <span class="censored">the</span> <span class="censored">method</span> <span class="censored">call,</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">42</span></code> <span class="censored">has</span> <span class="censored">the</span> <span class="censored">concrete</span> <span class="censored">type</span> <code class="language-plaintext highlighter-rouge"><span class="censored">i32</span></code><span class="censored">.</span> <span class="censored">If</span> <span class="censored">this</span> <span class="censored">were</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">generic</span> <span class="censored">context</span> <span class="censored">and</span> <span class="censored">we</span> <span class="censored">had</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">variable</span> <span class="censored">bounded</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Stringer</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">just</span> <span class="censored">write</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x.String()</span></code><span class="censored">;</span> <span class="censored">no</span> <span class="censored">ambiguity.</span></p> <p><span class="censored">In</span> <span class="censored">Carbon,</span> <span class="censored">all</span> <span class="censored">qualification</span> <span class="censored">uses</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.</span></code><span class="censored">,</span> <span class="censored">so</span> <span class="censored">they</span> <span class="censored">have</span> <span class="censored">to</span> <span class="censored">add</span> <span class="censored">parens.</span> <span class="censored">Because</span> <span class="censored">Rust</span> <span class="censored">uses</span> <code class="language-plaintext highlighter-rouge"><span class="censored">::</span></code> <span class="censored">for</span> <span class="censored">qualifying</span> <span class="censored">paths,</span> <span class="censored">we</span> <span class="censored">don’t</span> <span class="censored">have</span> <span class="censored">this</span> <span class="censored">syntactic</span> <span class="censored">abiguity,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">augment</span> <span class="censored">the</span> <span class="censored">syntax</span> <span class="censored">to</span> <span class="censored">allow</span> <span class="censored">more</span> <span class="censored">path</span> <span class="censored">expressions</span> <span class="censored">after</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.</span></code><span class="censored">.</span></p> <p><span class="censored">The</span> <span class="censored">current</span> <span class="censored">grammar</span> <span class="censored">is</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span class="censored">MethodCallExpression</span> <span class="censored">:</span>
   <span class="censored">Expression</span> <span class="censored">.</span> <span class="censored">PathExprSegment</span> <span class="censored">(CallParams?)</span>

<span class="censored">PathExprSegment</span> <span class="censored">:</span>
   <span class="censored">PathIdentSegment</span> <span class="censored">(::</span> <span class="censored">GenericArgs)?</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Plaintext</span></div></div> </div> <p><span class="censored">That</span> <span class="censored">is,</span> <span class="censored">exactly</span> <span class="censored">one</span> <span class="censored">identifier</span> <span class="censored">and</span> <span class="censored">an</span> <span class="censored">optional</span> <span class="censored">turbofish.</span> <span class="censored">I</span> <span class="censored">would</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">see</span> <span class="censored">this</span> <span class="censored">extended</span> <span class="censored">to</span> <span class="censored">allow</span> <span class="censored">any</span> <code class="language-plaintext highlighter-rouge"><span class="censored">QualifiedPathInExpression</span></code> <span class="censored">after</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.</span></code> <span class="censored">and</span> <span class="censored">before</span> <span class="censored">the</span> <span class="censored">parens.</span> <span class="censored">This</span> <span class="censored">would</span> <span class="censored">allow,</span> <span class="censored">for</span> <span class="censored">example:</span></p> <ul> <li><code class="language-plaintext highlighter-rouge"><span class="censored">expr.Trait::method()</span></code></li> <li><code class="language-plaintext highlighter-rouge"><span class="censored">expr.Self::method()</span></code></li> <li><code class="language-plaintext highlighter-rouge"><span class="censored">expr.<foo> <span class="censored">as</span> <span class="censored">Trait&gt;::method()</span></foo></span></code></li> <li><code class="language-plaintext highlighter-rouge"><span class="censored">expr.::path::to::Trait::<args>::method::<moreargs>()</moreargs></args></span></code></li> </ul> <p><span class="censored">These</span> <span class="censored">would</span> <span class="censored">all</span> <span class="censored">be</span> <span class="censored">desugared</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">equivalent</span> <span class="censored">UFCS,</span> <span class="censored">taking</span> <span class="censored">into</span> <span class="censored">account</span> <span class="censored">that</span> <span class="censored">method</span> <span class="censored">call</span> <span class="censored">syntax</span> <span class="censored">can</span> <span class="censored">trigger</span> <span class="censored">autoref.</span></p> <ul> <li><code class="language-plaintext highlighter-rouge"><span class="censored">Trait::method(expr)</span></code></li> <li><code class="language-plaintext highlighter-rouge"><span class="censored">Self::method(expr)</span></code></li> <li><code class="language-plaintext highlighter-rouge"><span class="censored"><foo> <span class="censored">as</span> <span class="censored">Trait&gt;::method(expr)</span></foo></span></code></li> <li><code class="language-plaintext highlighter-rouge"><span class="censored">::path::to::Trait::<args>::method::<moreargs>(expr)</moreargs></args></span></code></li> </ul> <p><span class="censored">The</span> <span class="censored">method</span> <span class="censored">would</span> <span class="censored">still</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">valid</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">called</span> <span class="censored">via</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.</span></code> <span class="censored">syntax;</span> <span class="censored">I’m</span> <span class="censored">not</span> <span class="censored">proposing</span> <span class="censored">we</span> <span class="censored">add</span> <span class="censored">the</span> <span class="censored">following,</span> <span class="censored">even</span> <span class="censored">though</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">unambiguous.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">square</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">:</span></span> <span class="nb"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">i32</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">*</span></span> <span class="n"><span class="censored">x</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">Would</span> <span class="censored">be</span> <span class="censored">equivalent</span> <span class="censored">to</span> <span class="censored">`square(42)`.</span></span>
<span class="mi"><span class="censored">42</span></span><span class="py"><span class="censored">.self</span></span><span class="p"><span class="censored">::</span></span><span class="nf"><span class="censored">square</span></span><span class="p"><span class="censored">()</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">Trait</span> <span class="censored">method</span> <span class="censored">callers</span> <span class="censored">can</span> <span class="censored">now</span> <span class="censored">use</span> <span class="censored">qualified</span> <span class="censored">method</span> <span class="censored">call</span> <span class="censored">syntax</span> <span class="censored">where</span> <span class="censored">they</span> <span class="censored">might</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">UFCS</span> <span class="censored">without</span> <span class="censored">issues</span> <span class="censored">around</span> <span class="censored">wordiness.</span></p> <h2 id="impl-modality"><a href="#impl-modality"><span class="censored">Impl</span> <span class="censored">Modality</span></a></h2> <p><span class="censored">Of</span> <span class="censored">course,</span> <span class="censored">this</span> <span class="censored">isn’t</span> <span class="censored">the</span> <span class="censored">only</span> <span class="censored">idea</span> <span class="censored">from</span> <span class="censored">Carbon’s</span> <span class="censored">interfaces</span> <span class="censored">worth</span> <span class="censored">stealing;</span> <span class="censored">Carbon</span> <span class="censored">also</span> <span class="censored">has</span> <span class="censored">a</span> <span class="censored">notion</span> <span class="censored">of</span> <span class="censored">“external”</span> <span class="censored">and</span> <span class="censored">“internal”</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code><span class="censored">s;</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">call</span> <span class="censored">these</span> <span class="censored">“</span><code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code> <span class="censored">modes”.</span></p> <p><span class="censored">An</span> <span class="censored">external</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code> <span class="censored">is</span> <span class="censored">like</span> <span class="censored">the</span> <span class="censored">one</span> <span class="censored">we</span> <span class="censored">showed</span> <span class="censored">above,</span> <span class="censored">whose</span> <span class="censored">methods</span> <span class="censored">can</span> <span class="censored">only</span> <span class="censored">be</span> <span class="censored">found</span> <span class="censored">by</span> <span class="censored">qualified</span> <span class="censored">lookup:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.(Bar.Baz)()</span></code><span class="censored">.</span> <span class="censored">An</span> <span class="censored">internal</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code> <span class="censored">is</span> <span class="censored">one</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">“part”</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">type.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n"><span class="censored">interface</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">[</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">:</span></span> <span class="k"><span class="censored">Self</span></span><span class="p"><span class="censored">]()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="n"><span class="censored">class</span></span> <span class="n"><span class="censored">Woofer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">impl</span></span> <span class="k"><span class="censored">as</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="k"><span class="censored">fn</span></span> <span class="nb"><span class="censored">String</span></span><span class="p"><span class="censored">[</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">:</span></span> <span class="k"><span class="censored">Self</span></span><span class="p"><span class="censored">]()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">...</span></span> <span class="p"><span class="censored">}</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">Run</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">w</span></span><span class="p"><span class="censored">:</span></span> <span class="n"><span class="censored">Woofer</span></span> <span class="o"><span class="censored">=</span></span> <span class="o"><span class="censored">...</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">w</span></span><span class="nf"><span class="censored">.String</span></span><span class="p"><span class="censored">()</span></span>  <span class="c1"><span class="censored">//</span> <span class="censored">Unqualified!</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Carbon</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">also</span> <span class="censored">implies</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">don’t</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">import</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Stringer</span></code> <span class="censored">to</span> <span class="censored">call</span> <code class="language-plaintext highlighter-rouge"><span class="censored">w.String()</span></code><span class="censored">.</span></p> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">definitely</span> <span class="censored">traits</span> <span class="censored">in</span> <span class="censored">Rust</span> <span class="censored">which</span> <span class="censored">fit</span> <span class="censored">into</span> <span class="censored">these</span> <span class="censored">modes.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">Clone</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Iterator</span></code> <span class="censored">almost</span> <span class="censored">always</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">internal.</span> <span class="censored">An</span> <span class="censored">iterator</span> <span class="censored">exists</span> <span class="censored">to</span> <span class="censored">implement</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Iterator</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">cloning</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">fundamental</span> <span class="censored">operation.</span> <span class="censored">Because</span> <span class="censored">both</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">traits</span> <span class="censored">are</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">prelude,</span> <span class="censored">it’s</span> <span class="censored">not</span> <span class="censored">a</span> <span class="censored">problem,</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">problem</span> <span class="censored">for</span> <span class="censored">traits</span> <span class="censored">provided</span> <span class="censored">by</span> <span class="censored">a</span> <span class="censored">non-</span><code class="language-plaintext highlighter-rouge"><span class="censored">std</span></code> <span class="censored">crate,</span> <span class="censored">like</span> <a href="https://docs.rs/rand/latest/rand/trait.Rng.html"><code class="language-plaintext highlighter-rouge"><span class="censored">rand::Rng</span></code></a><span class="censored">.</span> <span class="censored">The</span> <span class="censored">lack</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">this</span> <span class="censored">leads</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">proliferation</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">prelude</span></code> <span class="censored">modules</span> <span class="censored">and</span> <span class="censored">namespace</span> <span class="censored">pollution.</span> <span class="censored">(I</span> <span class="censored">think</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">prelude</span></code><span class="censored">s</span> <span class="censored">are</span> <span class="censored">bad</span> <span class="censored">library</span> <span class="censored">design.)</span></p> <p><span class="censored">On</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">hand,</span> <span class="censored">something</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Debug</span></code> <span class="censored">wants</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">external</span> <span class="censored">very</span> <span class="censored">badly.</span> <span class="censored">It</span> <span class="censored">almost</span> <span class="censored">never</span> <span class="censored">makes</span> <span class="censored">sense</span> <span class="censored">to</span> <span class="censored">call</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.fmt()</span></code><span class="censored">,</span> <span class="censored">since</span> <span class="censored">that</span> <span class="censored">gets</span> <span class="censored">called</span> <span class="censored">for</span> <span class="censored">you</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">println!</span></code> <span class="censored">and</span> <span class="censored">friends;</span> <span class="censored">not</span> <span class="censored">to</span> <span class="censored">mention</span> <span class="censored">that</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::fmt</span></code> <span class="censored">traits</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">method</span> <code class="language-plaintext highlighter-rouge"><span class="censored">fmt()</span></code><span class="censored">,</span> <span class="censored">making</span> <span class="censored">such</span> <span class="censored">a</span> <span class="censored">call</span> <span class="censored">likely</span> <span class="censored">to</span> <span class="censored">need</span> <span class="censored">disambiguation</span> <span class="censored">with</span> <span class="censored">UFCS.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Borrow</span></code> <span class="censored">is</span> <span class="censored">similar;</span> <span class="censored">it</span> <span class="censored">exists</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">bound</span> <span class="censored">for</span> <span class="censored">things</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Cow</span></code> <span class="censored">more</span> <span class="censored">than</span> <span class="censored">to</span> <span class="censored">provide</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.borrow()</span></code> <span class="censored">method.</span></p> <p><span class="censored">There’s</span> <span class="censored">also</span> <span class="censored">a</span> <span class="censored">third</span> <span class="censored">mode,</span> <span class="censored">which</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">call</span> <span class="censored">“extension</span> <span class="censored">impls”.</span> <span class="censored">These</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">inject</span> <span class="censored">methods</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">type,</span> <span class="censored">either</span> <span class="censored">to</span> <span class="censored">extend</span> <span class="censored">it,</span> <span class="censored">like</span> <a href="https://docs.rs/itertools/latest/itertools/"><code class="language-plaintext highlighter-rouge"><span class="censored">itertools</span></code></a><span class="censored">,</span> <span class="censored">or</span> <span class="censored">as</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">some</span> <span class="censored">framework,</span> <span class="censored">like</span> <a href="https://docs.rs/tap/latest/tap/"><code class="language-plaintext highlighter-rouge"><span class="censored">tap</span></code></a><span class="censored">.</span> <span class="censored">This</span> <span class="censored">use</span> <span class="censored">of</span> <span class="censored">traits</span> <span class="censored">is</span> <span class="censored">somewhat</span> <span class="censored">controversial,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">can</span> <span class="censored">sympathize</span> <span class="censored">with</span> <span class="censored">wanting</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">this.</span></p> <p><span class="censored">If</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">paths-as-methods,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">use</span> <span class="censored">this</span> <span class="censored">classification</span> <span class="censored">to</span> <span class="censored">move</span> <span class="censored">towards</span> <span class="censored">something</span> <span class="censored">more</span> <span class="censored">like</span> <span class="censored">the</span> <span class="censored">Carbon</span> <span class="censored">model</span> <span class="censored">of</span> <span class="censored">method</span> <span class="censored">lookup,</span> <span class="censored">without</span> <span class="censored">impacting</span> <span class="censored">existing</span> <span class="censored">uses.</span></p> <p><span class="censored">My</span> <span class="censored">strawman</span> <span class="censored">is</span> <span class="censored">to</span> <span class="censored">add</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode]</span></code> <span class="censored">attribute</span> <span class="censored">to</span> <span class="censored">place</span> <span class="censored">on</span> <span class="censored">trait</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impls</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">allows</span> <span class="censored">a</span> <span class="censored">caller</span> <span class="censored">to</span> <span class="censored">select</span> <span class="censored">the</span> <span class="censored">behavior:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(extension)]</span></code> <span class="censored">is</span> <span class="censored">today’s</span> <span class="censored">behavior.</span> <span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code><span class="censored">’s</span> <span class="censored">trait</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">in</span> <span class="censored">scope</span> <span class="censored">so</span> <span class="censored">that</span> <span class="censored">unqualified</span> <span class="censored">calls</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.method()</span></code> <span class="censored">resolve</span> <span class="censored">to</span> <span class="censored">it.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(internal)]</span></code> <span class="censored">makes</span> <span class="censored">it</span> <span class="censored">so</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.method()</span></code> <span class="censored">can</span> <span class="censored">resolve</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">method</span> <span class="censored">from</span> <span class="censored">this</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code> <span class="censored">without</span> <span class="censored">its</span> <span class="censored">trait</span> <span class="censored">being</span> <span class="censored">in</span> <span class="censored">scope</span><sup id="fnref:internal-restrictions" role="doc-noteref"><a href="#fn:internal-restrictions" class="footnote" rel="footnote"><span class="censored">1</span></a></sup><span class="censored">.</span> <span class="censored">It</span> <span class="censored">can</span> <span class="censored">only</span> <span class="censored">be</span> <span class="censored">applied</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code><span class="censored">s</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">such</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">could</span> <span class="censored">write</span> <span class="censored">a</span> <span class="censored">corresponding</span> <span class="censored">inherent</span> <span class="censored">impl,</span> <span class="censored">so</span> <span class="censored">things</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(internal)]</span> <span class="censored">impl<t></t></span> <span class="censored">Trait</span> <span class="censored">for</span> <span class="censored">T</span> <span class="censored">{</span> <span class="censored">..</span> <span class="censored">}</span></code> <span class="censored">are</span> <span class="censored">forbidden.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(external)]</span></code> <span class="censored">makes</span> <span class="censored">it</span> <span class="censored">so</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.method()</span></code> <span class="censored">never</span> <span class="censored">resolves</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">method</span> <span class="censored">from</span> <span class="censored">this</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code><span class="censored">.</span> <span class="censored">It</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">called</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Trait::method(foo)</span></code> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.Trait::method()</span></code><span class="censored">.</span> </li> </ul> <p><span class="censored">Every</span> <span class="censored">trait</span> <span class="censored">would</span> <span class="censored">be</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(extension)]</span></code> <span class="censored">if</span> <span class="censored">not</span> <span class="censored">annotated,</span> <span class="censored">and</span> <span class="censored">it</span> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">migrate</span> <span class="censored">to</span> <span class="censored">external-by-default</span> <span class="censored">across</span> <span class="censored">an</span> <span class="censored">edition.</span> <span class="censored">Similarly,</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">change</span> <span class="censored">whether</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std</span></code> <span class="censored">impl</span> <span class="censored">is</span> <span class="censored">external</span> <span class="censored">vs</span> <span class="censored">extension</span> <span class="censored">based</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">edition</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">caller,</span> <span class="censored">and</span> <span class="censored">provide</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">cargo</span> <span class="censored">fix</span></code> <span class="censored">rewrite</span> <span class="censored">to</span> <span class="censored">convert</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.method()</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.Trait::method()</span></code><span class="censored">.</span></p> <p><span class="censored">It</span> <span class="censored">may</span> <span class="censored">also</span> <span class="censored">make</span> <span class="censored">sense</span> <span class="censored">for</span> <span class="censored">traits</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">specify</span> <span class="censored">the</span> <span class="censored">default</span> <span class="censored">modality</span> <span class="censored">of</span> <span class="censored">their</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code><span class="censored">s,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">haven’t</span> <span class="censored">thought</span> <span class="censored">very</span> <span class="censored">carefully</span> <span class="censored">about</span> <span class="censored">this.</span></p> <p><span class="censored">Note</span> <span class="censored">that</span> <span class="censored">moving</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">external</span> <span class="censored">-&gt;</span> <span class="censored">extension</span> <span class="censored">-&gt;</span> <span class="censored">internal</span> <span class="censored">direction</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">a</span> <span class="censored">breaking</span> <span class="censored">change,</span> <span class="censored">but</span> <span class="censored">moving</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">way</span> <span class="censored">is.</span></p> <h2 id="what-about-delegation"><a href="#what-about-delegation"><span class="censored">What</span> <span class="censored">about</span> <span class="censored">Delegation?</span></a></h2> <p><span class="censored">A</span> <span class="censored">related</span> <span class="censored">feature</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">touch</span> <span class="censored">on</span> <span class="censored">lightly</span> <span class="censored">is</span> <span class="censored">delegation;</span> <span class="censored">that</span> <span class="censored">is,</span> <span class="censored">being</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">something</span> <span class="censored">like</span> <span class="censored">the</span> <span class="censored">following:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c1"><span class="censored">//</span> <span class="censored">crate</span> <span class="censored">a</span></span>
<span class="k"><span class="censored">struct</span></span> <span class="n"><span class="censored">Foo</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">...</span></span> <span class="p"><span class="censored">}</span></span>
<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Foo</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">boing</span></span><span class="p"><span class="censored">()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">i32</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">...</span></span> <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">crate</span> <span class="censored">b</span></span>
<span class="k"><span class="censored">trait</span></span> <span class="n"><span class="censored">Bar</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">boing</span></span><span class="p"><span class="censored">()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">i32</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Bar</span></span> <span class="k"><span class="censored">for</span></span> <span class="n"><span class="censored">Foo</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">use</span></span> <span class="nn"><span class="censored">Foo</span></span><span class="p"><span class="censored">::</span></span><span class="n"><span class="censored">boing</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">use</span></code> <span class="censored">in</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code> <span class="censored">indicates</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">re-use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Foo::boing</span></code> <span class="censored">to</span> <span class="censored">implement</span> <code class="language-plaintext highlighter-rouge"><span class="censored"><foo> <span class="censored">as</span> <span class="censored">Bar&gt;::boing</span></foo></span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">saves</span> <span class="censored">us</span> <span class="censored">having</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">out</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">signature,</span> <span class="censored">and</span> <span class="censored">results</span> <span class="censored">in</span> <span class="censored">less</span> <span class="censored">work</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">because</span> <span class="censored">that’s</span> <span class="censored">one</span> <span class="censored">less</span> <span class="censored">function</span> <span class="censored">we</span> <span class="censored">risk</span> <span class="censored">asking</span> <span class="censored">LLVM</span> <span class="censored">to</span> <span class="censored">codegen</span> <span class="censored">for</span> <span class="censored">us</span> <span class="censored">(at</span> <span class="censored">scale,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">Big</span> <span class="censored">Deal).</span></p> <p><span class="censored">You</span> <span class="censored">could</span> <span class="censored">imagine</span> <span class="censored">using</span> <span class="censored">delegation</span> <span class="censored">instead</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode]</span></code><span class="censored">:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">struct</span></span> <span class="n"><span class="censored">Woofer</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Stringer</span></span> <span class="k"><span class="censored">for</span></span> <span class="n"><span class="censored">Woofer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">string</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="nb"><span class="censored">String</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="nd"><span class="censored">format!</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"woof"</span></span><span class="p"><span class="censored">)</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">Woofer</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">use</span></span> <span class="nn"><span class="censored">Stringer</span></span><span class="p"><span class="censored">::</span></span><span class="o"><span class="censored">*</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">The</span> <span class="censored">reason</span> <span class="censored">I</span> <span class="censored">haven’t</span> <span class="censored">gone</span> <span class="censored">down</span> <span class="censored">this</span> <span class="censored">road</span> <span class="censored">is</span> <span class="censored">because</span> <span class="censored">delegation</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">large</span> <span class="censored">feature,</span> <span class="censored">and</span> <span class="censored">doesn’t</span> <span class="censored">give</span> <span class="censored">us</span> <span class="censored">a</span> <span class="censored">clean</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">express</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(external)]</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">big</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">want.</span> <span class="censored">A</span> <span class="censored">delegation-compatible</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">express</span> <span class="censored">this</span> <span class="censored">proposal</span> <span class="censored">is</span> <span class="censored">to</span> <span class="censored">not</span> <span class="censored">add</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#[mode(internal)]</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">add</span> <code class="language-plaintext highlighter-rouge"><span class="censored">use</span> <span class="censored">Trait::method;</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">use</span> <span class="censored">Trait::*;</span></code> <span class="censored">(and</span> <span class="censored">no</span> <span class="censored">other</span> <span class="censored">variations)</span> <span class="censored">inside</span> <span class="censored">of</span> <span class="censored">inherent</span> <code class="language-plaintext highlighter-rouge"><span class="censored">impl</span></code> <span class="censored">blocks.</span></p> <h2 id="conclusion"><a href="#conclusion"><span class="censored">Conclusion</span></a></h2> <p><span class="censored">I</span> <span class="censored">don’t</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">personal</span> <span class="censored">bandwidth</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">RFCs</span> <span class="censored">for</span> <span class="censored">any</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">stuff,</span> <span class="censored">but</span> <span class="censored">it’s</span> <span class="censored">something</span> <span class="censored">I</span> <span class="censored">talk</span> <span class="censored">about</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">potential</span> <span class="censored">evolution</span> <span class="censored">hazard</span> <span class="censored">for</span> <span class="censored">Rust.</span> <span class="censored">I</span> <span class="censored">hope</span> <span class="censored">that</span> <span class="censored">putting</span> <span class="censored">these</span> <span class="censored">ideas</span> <span class="censored">to</span> <span class="censored">paper</span> <span class="censored">can</span> <span class="censored">help</span> <span class="censored">make</span> <span class="censored">name</span> <span class="censored">resolution</span> <span class="censored">in</span> <span class="censored">Rust</span> <span class="censored">more</span> <span class="censored">robust.</span></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:internal-restrictions" role="doc-endnote"> <p><span class="censored">This</span> <span class="censored">needs</span> <span class="censored">to</span> <span class="censored">carry</span> <span class="censored">a</span> <span class="censored">bunch</span> <span class="censored">of</span> <span class="censored">other</span> <span class="censored">restrictions,</span> <span class="censored">because</span> <span class="censored">it’s</span> <span class="censored">equivalent</span> <span class="censored">to</span> <span class="censored">adding</span> <span class="censored">inherent</span> <span class="censored">methods</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">implee.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">none</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">methods</span> <span class="censored">can</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">name</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">method</span> <span class="censored">in</span> <span class="censored">any</span> <span class="censored">other</span> <span class="censored">inherent</span> <span class="censored">or</span> <span class="censored">internal</span> <span class="censored">impl</span> <span class="censored">block,</span> <span class="censored">and</span> <span class="censored">internal</span> <span class="censored">impl</span> <span class="censored">methods</span> <span class="censored">should</span> <span class="censored">take</span> <span class="censored">lookup</span> <span class="censored">priority</span> <span class="censored">over</span> <span class="censored">extension</span> <span class="censored">impl</span> <span class="censored">methods</span> <span class="censored">during</span> <span class="censored">name</span> <span class="censored">lookup. </span><a href="#fnref:internal-restrictions" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-05-13</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/05/13/protobuf-tip-5/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#5:</span> <span class="censored">Avoid</span> <span class="censored">import</span> <span class="censored">public/weak</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-04-29</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/04/29/protobuf-tip-4/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#4:</span> <span class="censored">Accepting</span> <span class="censored">Mistakes</span> <span class="censored">We</span> <span class="censored">Can't</span> <span class="censored">Fix</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-04-22</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/04/22/protobuf-tip-3/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#3:</span> <span class="censored">Enum</span> <span class="censored">Names</span> <span class="censored">Need</span> <span class="censored">Prefixes</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>