<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> The Taxonomy of Pointers &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="The Taxonomy of Pointers &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/ptr-taxonomy-a830752bf2e5dafb3f2a543e5f333bb5542e480d.png"> <meta property="og:title" content="The Taxonomy of Pointers &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/ptr-taxonomy-a830752bf2e5dafb3f2a543e5f333bb5542e480d.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2021/05/24/ptr-taxonomy/"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2021-05-24 • 2069 words • 22 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#c++">#c++</a> • <a href="https://mcyoung.xyz/tags.html#rust">#rust</a> • <a href="https://mcyoung.xyz/tags.html#pointers">#pointers</a> </span> <h1><a href="/2021/05/24/ptr-taxonomy/"> The Taxonomy of Pointers </a></h1> </div> <div class="post"> <p>Writing <code class="language-plaintext highlighter-rouge">unsafe</code> in Rust usually involves manual management of memory. Although, ideally, we’d like to exclusively use references for this, sometimes the constraints they apply are too strong. This post is a guide on those constraints and how to weaken them for correctness.</p> <p>“Unmanaged” languages, like C++ and Rust, provide <em>pointer</em> types for manipulating memory. These types serve different purposes and provide different guarantees. These guarantees are useful for the optimizer but get in the way of correctness of low-level code. This is especially true in Rust, where these constraints are very tight.</p> <blockquote> <p>NB: This post only surveys <em>data</em> pointers. Function pointers are their own beast, but generally are less fussy, since they all have static lifetime<sup id="fnref:go-nuts" role="doc-noteref"><a href="#fn:go-nuts" class="footnote" rel="footnote">1</a></sup>.</p> </blockquote> <h2 id="basic-c-pointers"><a href="#basic-c-pointers">Basic C++ Pointers</a></h2> <p>First, let’s survey C++. We have three pointer types: the traditional C pointer <code class="language-plaintext highlighter-rouge">T*</code>, C++ references <code class="language-plaintext highlighter-rouge">T&amp;</code>, and rvalue references <code class="language-plaintext highlighter-rouge">T&amp;&amp;</code>. These generally have pretty weak guarantees.</p> <p>Pointers provide virtually no guarantees at all: they can be null, point to uninitialized memory, or point to nothing at all! C++ Only requires that they be aligned<sup id="fnref:unaligned" role="doc-noteref"><a href="#fn:unaligned" class="footnote" rel="footnote">2</a></sup>. They are little more than an address (until they are dereferenced, of course).</p> <p>References, on the other hand, are intended to be the “primary” pointer type. A <code class="language-plaintext highlighter-rouge">T&amp;</code> cannot be null, is well-aligned, and is intended to only refer to live memory (although it’s not something C++ can really guarantee for lack of a borrow-checker). References are short-lived.</p> <p>C++ uses non-nullness to its advantage. For example, Clang will absolutely delete code of the form</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span><span class="o">&amp;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">x</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">DoSomething</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>Because references cannot be null, and dereferencing the null pointer is always UB, the compiler may make this fairly strong assumption.</p> <p>Rvalue references, <code class="language-plaintext highlighter-rouge">T&amp;&amp;</code>, are not meaningfully different from normal references, beyond their role in overload resolution.</p> <p>Choosing a C++ (primitive) pointer type is well-studied and not the primary purpose of this blog. Rather, we’re interested in how these map to Rust, which has significantly more complicated pointers.</p> <h2 id="basic-rust-pointers"><a href="#basic-rust-pointers">Basic Rust Pointers</a></h2> <p>Like C++, Rust has two broad pointer types: <code class="language-plaintext highlighter-rouge">*const T</code> and <code class="language-plaintext highlighter-rouge">*mut T</code>, the raw pointers, and <code class="language-plaintext highlighter-rouge">&amp;T</code> and <code class="language-plaintext highlighter-rouge">&amp;mut T</code>, the references.</p> <p>Rust pointer have even fewer constraints than C++ pointers; they need not even be aligned<sup id="fnref:unaligned-access" role="doc-noteref"><a href="#fn:unaligned-access" class="footnote" rel="footnote">3</a></sup>! The <code class="language-plaintext highlighter-rouge">const</code>/<code class="language-plaintext highlighter-rouge">mut</code> specifier is basically irrelevant, but is useful as programmer book-keeping tool. Rust also does not enforce the dreaded strict-aliasing rule<sup id="fnref:strict-aliasing" role="doc-noteref"><a href="#fn:strict-aliasing" class="footnote" rel="footnote">4</a></sup> on its pointers.</p> <p>On the other hand, Rust references are among the most constrained objects in any language that I know of. A shared reference <code class="language-plaintext highlighter-rouge">&amp;'a T</code>, lasting for the lifetime <code class="language-plaintext highlighter-rouge">'a</code>, satisfies:</p> <ul> <li>Non-null, and well-aligned (like in C++).</li> <li>Points to a valid, initialized <code class="language-plaintext highlighter-rouge">T</code> for the duration of <code class="language-plaintext highlighter-rouge">'a</code>.</li> <li><code class="language-plaintext highlighter-rouge">T</code> is never ever mutated for the duration of the reference: the compiler may fold separate reads into one at will. Stronger still, no <code class="language-plaintext highlighter-rouge">&amp;mut T</code> is reachable from any thread while the reference is reachable.</li> </ul> <p>Stronger still are <code class="language-plaintext highlighter-rouge">&amp;'a mut T</code> references, sometimes called <em>unique</em> references, because in addition to being well-aligned and pointing to a valid <code class="language-plaintext highlighter-rouge">T</code> at all times, no other reachable reference ever aliases it in any thread; this is equivalent to a C <code class="language-plaintext highlighter-rouge">T* restrict</code> pointer.</p> <p>Unlike C++, which has two almost-identical pointer types, Rust’s two pointer types provide either no guarantees or <em>all</em> of them. The following <code class="language-plaintext highlighter-rouge">unsafe</code> operations are all UB:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">null</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">null</span><span class="p">()</span> <span class="p">};</span>

<span class="c1">// A reference to u8 need not be sufficiently aligned</span>
<span class="c1">// for a reference to u32.</span>
<span class="k">let</span> <span class="n">unaligned</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">0u8</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u8</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">};</span>

<span class="c1">// More on this type later...</span>
<span class="k">let</span> <span class="n">uninit</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="nn">MaybeUninit</span><span class="p">::</span><span class="nf">uninit</span><span class="p">()</span><span class="nf">.as_ptr</span><span class="p">()</span> <span class="p">};</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">unsafe</span> <span class="p">{</span>
  <span class="c1">// Not UB in C++ with const_cast!</span>
  <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
  <span class="p">(</span><span class="n">p</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">i32</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">i32</span><span class="p">)</span><span class="nf">.write</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Two mutable references live at the same time pointing to</span>
<span class="c1">// the same memory. This would also be fine in C++!</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">let</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">y</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">i32</span><span class="p">)</span> <span class="p">};</span>
<span class="k">let</span> <span class="n">p2</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">y</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">i32</span><span class="p">)</span> <span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <h3 id="wide-pointers"><a href="#wide-pointers">Wide Pointers</a></h3> <p>Rust also provides the slice types <code class="language-plaintext highlighter-rouge">&amp;[T]</code><sup id="fnref:std-span" role="doc-noteref"><a href="#fn:std-span" class="footnote" rel="footnote">5</a></sup> (of which you get mutable/immutable reference and pointer varieties) and dynamic trait object types <code class="language-plaintext highlighter-rouge">&amp;dyn Tr</code> (again, all four basic pointer types are available).</p> <p><code class="language-plaintext highlighter-rouge">&amp;[T]</code> is a <code class="language-plaintext highlighter-rouge">usize</code><sup id="fnref:usize" role="doc-noteref"><a href="#fn:usize" class="footnote" rel="footnote">6</a></sup> length plus a pointer to that many <code class="language-plaintext highlighter-rouge">T</code>s. The pointer type of the slice specifies the guarantees on the pointed-to buffer. <code class="language-plaintext highlighter-rouge">*mut [T]</code>, for example, has no meaningful guarantees, but still contains the length<sup id="fnref:ptr-len" role="doc-noteref"><a href="#fn:ptr-len" class="footnote" rel="footnote">7</a></sup>. Note that the length is part of the pointer value, <em>not</em> the pointee.</p> <p><code class="language-plaintext highlighter-rouge">&amp;dyn Tr</code> is a trait object. For our purposes, it consists of a pointer to some data plus a pointer to a static vtable. <code class="language-plaintext highlighter-rouge">*mut dyn Tr</code> is technically a valid type<sup id="fnref:raw-vtable" role="doc-noteref"><a href="#fn:raw-vtable" class="footnote" rel="footnote">8</a></sup>. Overall, trait objects aren’t really relevant to this post; they are rarely used this way in <code class="language-plaintext highlighter-rouge">unsafe</code> settings.</p> <h2 id="weakening-the-guarantees"><a href="#weakening-the-guarantees">Weakening the Guarantees</a></h2> <p>Suppose we’re building some kind of data structure; in Rust, data structures will need some sprinkling of <code class="language-plaintext highlighter-rouge">unsafe</code>, since they will need to shovel around memory directly. Typically this is done using raw pointers, but it is preferable to use the <em>least weakened</em> pointer type to allow the compiler to perform whatever optimizations it can.</p> <p>There are a number of orthogonal guarantees on <code class="language-plaintext highlighter-rouge">&amp;T</code> and <code class="language-plaintext highlighter-rouge">&amp;mut T</code> we might want to relax:</p> <ul> <li>Non-nullness.</li> <li>Well-aligned-ness.</li> <li>Validity and initialized-ness of the pointee.</li> <li>Allocated-ness of the pointee (implied by initialized-ness).</li> <li>Global uniqueness of an <code class="language-plaintext highlighter-rouge">&amp;mut T</code>.</li> </ul> <h3 id="pointer-to-zst"><a href="#pointer-to-zst">Pointer to ZST</a></h3> <p>The last three of these properties are irrelevant for a zero-sized type. For example, we can generate infinite <code class="language-plaintext highlighter-rouge">&amp;mut ()</code> with no consequences:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">unique_unit</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="k">mut</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="p">(</span><span class="mi">0x1</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="p">())</span> <span class="p">}</span> 
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>We materialize a non-null, well-aligned pointer and reborrow it into a static reference; because there is no data to point to, none of the usual worries about the pointee itself apply. However, the pointer itself must still be non-null and well-aligned; <code class="language-plaintext highlighter-rouge">0x1</code> is not a valid address for an <code class="language-plaintext highlighter-rouge">&amp;[u32; 0]</code>, but <code class="language-plaintext highlighter-rouge">0x4</code> is<sup id="fnref:but-you-cannot-free-it" role="doc-noteref"><a href="#fn:but-you-cannot-free-it" class="footnote" rel="footnote">9</a></sup>.</p> <p>This also applies to empty slices; in fact, the compiler will happily promote the expression <code class="language-plaintext highlighter-rouge">&amp;mut []</code> to an arbitrary lifetime:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">unique_empty</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="k">mut</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="p">{</span>
  <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[]</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <h3 id="null-references"><a href="#null-references">Null References</a></h3> <p>The most well-known manner of weakening is <code class="language-plaintext highlighter-rouge">Option&lt;&amp;T&gt;</code>. Rust guarantees that this is ABI-compatible with a C pointer <code class="language-plaintext highlighter-rouge">const T*</code>, with <code class="language-plaintext highlighter-rouge">Option::&lt;&amp;T&gt;::None</code> being a null pointer on the C side. This “null pointer optimization” applies to any type recursively containing at least one <code class="language-plaintext highlighter-rouge">T&amp;</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">DoSomething</span><span class="p">(</span><span class="n">ptr</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="k">mut</span> <span class="nb">u32</span><span class="o">&gt;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">do_something</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">DoSomething</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span>  <span class="c1">// C will see a `NULL` as the argument.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The same effect can be achieved for a pointer type using the <a href="https://doc.rust-lang.org/std/ptr/struct.NonNull.html"><code class="language-plaintext highlighter-rouge">NonNull&lt;T&gt;</code></a> standard library type: <code class="language-plaintext highlighter-rouge">Option&lt;NonNull&lt;T&gt;&gt;</code> is identical to <code class="language-plaintext highlighter-rouge">*mut T</code>. This is most beneficial for types which would otherwise contain a raw pointer:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">ptr</span><span class="p">:</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
  <span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">assert_eq!</span><span class="p">(</span><span class="nn">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;&gt;</span><span class="p">(),</span> <span class="nn">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;&gt;&gt;</span><span class="p">())</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <h3 id="uninitialized-pointee"><a href="#uninitialized-pointee">Uninitialized Pointee</a></h3> <p>No matter what, a <code class="language-plaintext highlighter-rouge">&amp;T</code> cannot point to uninitialized memory, since the compiler is free to assume it may read such references at any time with no consequences.</p> <p>The following classic C pattern is verboten:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Foo</span> <span class="n">foo</span><span class="p">;</span>
<span class="n">initialize_foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C</div></div></div> <p>Rust doesn’t provide any particularly easy ways to allocate memory without initializing it, too, so this usually isn’t a problem. The <a href="https://doc.rust-lang.org/core/mem/union.MaybeUninit.html#method.assume_init_ref"><code class="language-plaintext highlighter-rouge">MaybeUninit&lt;T&gt;</code></a> type can be used for safely allocating memory without initializing it, via <code class="language-plaintext highlighter-rouge">MaybeUninit::uninit()</code>.</p> <p>This type acts as a sort of “optimization barrier” that prevents the compiler from assuming the pointee is initialized. <code class="language-plaintext highlighter-rouge">&amp;MaybeUninit&lt;T&gt;</code> is a pointer to potentially uninitialized but definitely allocated memory. It has the same layout as <code class="language-plaintext highlighter-rouge">&amp;T</code>, and Rust provides functions like <code class="language-plaintext highlighter-rouge">assume_init_ref()</code> for asserting that a <code class="language-plaintext highlighter-rouge">&amp;MaybeUninit&lt;T&gt;</code> is definitely initialized. This assertion is similar in consequence to dereferencing a raw pointer.</p> <p><code class="language-plaintext highlighter-rouge">&amp;MaybeUninit&lt;T&gt;</code> and <code class="language-plaintext highlighter-rouge">&amp;mut MaybeUninit&lt;T&gt;</code> should almost be viewed as pointer types in their own right, since they can be converted to/from <code class="language-plaintext highlighter-rouge">&amp;T</code> and <code class="language-plaintext highlighter-rouge">&amp;mut T</code> under certain circumstances.</p> <p>Because <code class="language-plaintext highlighter-rouge">T</code> is almost a “subtype” of <code class="language-plaintext highlighter-rouge">MaybeUninit&lt;T&gt;</code>, we are entitled<sup id="fnref:requires-transmute" role="doc-noteref"><a href="#fn:requires-transmute" class="footnote" rel="footnote">10</a></sup> to “forget” that the referent of a <code class="language-plaintext highlighter-rouge">&amp;T</code> is initialized converting it to a <code class="language-plaintext highlighter-rouge">&amp;MaybeUninit&lt;T&gt;</code>. This makes sense because <code class="language-plaintext highlighter-rouge">&amp;T</code> is covariant<sup id="fnref:covariance" role="doc-noteref"><a href="#fn:covariance" class="footnote" rel="footnote">11</a></sup> in <code class="language-plaintext highlighter-rouge">&amp;T</code>. However, this is not true of <code class="language-plaintext highlighter-rouge">&amp;mut T</code>, since it’s not covariant:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">let</span> <span class="n">uninit</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nf">transmute</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">x</span><span class="p">)</span> <span class="p">};</span>
<span class="o">*</span><span class="n">uninit</span> <span class="o">=</span> <span class="nn">MaybeUninit</span><span class="p">::</span><span class="nf">uninit</span><span class="p">();</span>  <span class="c1">// Oops, `x` is now uninit!</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>These types are useful for talking to C++ without giving up too many guarantees. <code class="language-plaintext highlighter-rouge">Option&lt;&amp;MaybeUninit&lt;T&gt;&gt;</code> is an almost perfect model of a <code class="language-plaintext highlighter-rouge">const T*</code>, under the assumption that most pointers in C++ are valid most of the time.</p> <p><code class="language-plaintext highlighter-rouge">MaybeUninit&lt;T&gt;</code> also finds use in working with raw blocks of memory, such as in a <code class="language-plaintext highlighter-rouge">Vec</code>-style growable slice:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">SliceVec</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// Backing memory. The first `len` elements of it are</span>
  <span class="c1">// known to be initialized, but no more than that.</span>
  <span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="k">mut</span> <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">],</span>
  <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">SliceVec</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">push</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.len</span> <span class="o">&lt;</span> <span class="n">data</span><span class="nf">.len</span><span class="p">());</span>

    <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="k">self</span><span class="py">.len</span><span class="p">]</span> <span class="o">=</span> <span class="nn">MaybeUninit</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="k">self</span><span class="py">.len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <h3 id="aliased-pointee"><a href="#aliased-pointee">Aliased Pointee</a></h3> <p><code class="language-plaintext highlighter-rouge">&amp;mut T</code> can never alias any other pointer, but is also the mechanism by which we perform mutation. It can’t even alias with pointers that Rust can’t see; Rust assumes no one else can touch this memory. Thus, <code class="language-plaintext highlighter-rouge">&amp;mut T</code> is not an appropriate analogue for <code class="language-plaintext highlighter-rouge">T&amp;</code>.</p> <p>Like with uninitialized memory, Rust provides a “barrier” wrapper type, <a href="https://doc.rust-lang.org/std/cell/struct.UnsafeCell.html"><code class="language-plaintext highlighter-rouge">UnsafeCell&lt;T&gt;</code></a>. <code class="language-plaintext highlighter-rouge">UnsafeCell&lt;T&gt;</code> is the “interior mutability” primitive, which permits us to mutate through an <code class="language-plaintext highlighter-rouge">&amp;UnsafeCell&lt;T&gt;</code> so long as concurrent reads and writes do not occur. We may even convert it to a <code class="language-plaintext highlighter-rouge">&amp;mut T</code> when we’re sure we’re holding the only reference.</p> <p><code class="language-plaintext highlighter-rouge">UnsafeCell&lt;T&gt;</code> forms the basis of the <code class="language-plaintext highlighter-rouge">Cell&lt;T&gt;</code>, <code class="language-plaintext highlighter-rouge">RefCell&lt;T&gt;</code>, and <code class="language-plaintext highlighter-rouge">Mutex&lt;T&gt;</code> types, each of which performs a sort of “dynamic borrow-checking”:</p> <ul> <li><code class="language-plaintext highlighter-rouge">Cell&lt;T&gt;</code> only permits direct loads and stores.</li> <li><code class="language-plaintext highlighter-rouge">RefCell&lt;T&gt;</code> maintains a counter of references into it, which it uses to dynamically determine if a mutable reference would be unique.</li> <li><code class="language-plaintext highlighter-rouge">Mutex&lt;T&gt;</code>, which is like <code class="language-plaintext highlighter-rouge">RefCell&lt;T&gt;</code> but using concurrency primitives to maintain uniqueness.</li> </ul> <p>Because of this, Rust must treat <code class="language-plaintext highlighter-rouge">&amp;UnsafeCell&lt;T&gt;</code> as always aliasing, but because we can mutate through it, it is a much closer analogue to a C++ <code class="language-plaintext highlighter-rouge">T&amp;</code>. However, because <code class="language-plaintext highlighter-rouge">&amp;T</code> assumes the pointee is never mutated, it cannot coexist with a <code class="language-plaintext highlighter-rouge">&amp;UnsafeCell&lt;T&gt;</code> to the same memory, if mutation is performed through it. The following is explicitly UB:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>

<span class="c1">// This is ok; creating the reference to UnsafeCell does not</span>
<span class="c1">// immediately trigger UB.</span>
<span class="k">let</span> <span class="n">q</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">transmute</span><span class="p">::</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="p">};</span>

<span class="c1">// But writing to it does!</span>
<span class="n">q</span><span class="nf">.get</span><span class="p">()</span><span class="nf">.write</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The <code class="language-plaintext highlighter-rouge">Cell&lt;T&gt;</code> type is useful for non-aliasing references to plain-old-data types, which tend to be <code class="language-plaintext highlighter-rouge">Copy</code>. It allows us to perform mutation without having to utter <code class="language-plaintext highlighter-rouge">unsafe</code>. For example, the correct type for a shared mutable buffer in Rust is <code class="language-plaintext highlighter-rouge">&amp;[Cell&lt;u8&gt;]</code>, which can be freely <code class="language-plaintext highlighter-rouge">memcpy</code>‘d, without worrying about aliasing<sup id="fnref:but-thread-safety" role="doc-noteref"><a href="#fn:but-thread-safety" class="footnote" rel="footnote">12</a></sup>.</p> <p>This is most useful for sharing memory with another language, like C++, which cannot respect Rust’s aliasing rules.</p> <h3 id="combined-barriers"><a href="#combined-barriers">Combined Barriers</a></h3> <p>To recap:</p> <ul> <li>Non-nullness can be disabled with <code class="language-plaintext highlighter-rouge">Option&lt;&amp;T&gt;</code>.</li> <li>Initialized-ness can be disabled with <code class="language-plaintext highlighter-rouge">&amp;MaybeUninit&lt;T&gt;</code>.</li> <li>Uniqueness can be disabled with <code class="language-plaintext highlighter-rouge">&amp;UnsafeCell&lt;T&gt;</code>.</li> </ul> <blockquote> <p>There is no way to disable alignment and validity restrictions: references must always be aligned and have a valid lifetime attached. If these are unachievable, raw pointers are your only option.</p> </blockquote> <p>We can combine these various “weakenings” to produce aligned, lifetime-bound references to data with different properties. For example:</p> <ul> <li><code class="language-plaintext highlighter-rouge">&amp;UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;</code> is as close as we can get to a C++ <code class="language-plaintext highlighter-rouge">T&amp;</code>.</li> <li><code class="language-plaintext highlighter-rouge">Option&lt;&amp;UnsafeCell&lt;T&gt;&gt;</code> is a like a raw pointer, but to initialized memory.</li> <li><code class="language-plaintext highlighter-rouge">Option&lt;&amp;mut MaybeUninit&lt;T&gt;&gt;</code> is like a raw pointer, but with alignment, aliasing, and lifetime requirements.</li> <li><code class="language-plaintext highlighter-rouge">UnsafeCell&lt;&amp;[T]&gt;</code> permits us to mutate the pointer to the buffer and its length, but not the values it points to themselves.</li> <li><code class="language-plaintext highlighter-rouge">UnsafeCell&lt;&amp;[UnsafeCell&lt;T&gt;]&gt;</code> lets us mutate both the buffer and its actual pointer/length.</li> </ul> <p>Interestingly, there is no equivalent to a C++ raw pointer: there is no way to create a guaranteed-aligned pointer without a designated lifetime<sup id="fnref:unsafe-lifetime" role="doc-noteref"><a href="#fn:unsafe-lifetime" class="footnote" rel="footnote">13</a></sup>.</p> <h2 id="other-pointers"><a href="#other-pointers">Other Pointers</a></h2> <p>Rust and C++ have many other pointer types, such as smart pointers. However, in both languages, both are built in terms of these basic pointer types. Hopefully this article is a useful reference for anyone writing <code class="language-plaintext highlighter-rouge">unsafe</code> abstraction that wishes to avoid using raw pointers when possible.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:go-nuts" role="doc-endnote"> <p>Except in Go, which synthesizes vtables <em>on the fly</em>. Story for another day. <a href="#fnref:go-nuts" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:unaligned" role="doc-endnote"> <p>It is, apparently, a little-known fact that constructing unaligned pointers, but then never dereferencing them, is still UB in C++. C++ could, for example, store information in the lower bits of such a pointer. The in-memory representation of a pointer is actually unspecified! <a href="#fnref:unaligned" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:unaligned-access" role="doc-endnote"> <p>This is useful when paired with the Rust <code class="language-plaintext highlighter-rouge">&lt;*const T&gt;::read_unaligned()</code> function, which can be compiled down to a normal load on architectures that do not have alignment restrictions, like x86_64 and aarch64. <a href="#fnref:unaligned-access" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:strict-aliasing" role="doc-endnote"> <p>Another story for another time. <a href="#fnref:strict-aliasing" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:std-span" role="doc-endnote"> <p>Comparable to the C++20 <a href="https://en.cppreference.com/w/cpp/container/span"><code class="language-plaintext highlighter-rouge">std::span&lt;T&gt;</code></a> type. <a href="#fnref:std-span" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:usize" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge">usize</code> is Rust’s machine word type, compare <code class="language-plaintext highlighter-rouge">std::uintptr_t</code>. <a href="#fnref:usize" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ptr-len" role="doc-endnote"> <p>The length of a <code class="language-plaintext highlighter-rouge">*mut [T]</code> can be accessed via the unstable <a href="https://doc.rust-lang.org/std/primitive.pointer.html#method.len-1"><code class="language-plaintext highlighter-rouge">&lt;*mut [T]&gt;::len()</code></a> method. <a href="#fnref:ptr-len" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:raw-vtable" role="doc-endnote"> <p>It is also not a type I have encountered enough to have much knowledge on. For example, I don’t actually know if the vtable half of a <code class="language-plaintext highlighter-rouge">*mut dyn Tr</code> must always be valid or not; I suspect the answer is “no”, but I couldn’t find a citation for this. <a href="#fnref:raw-vtable" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:but-you-cannot-free-it" role="doc-endnote"> <p>Note that you <em>cannot</em> continue to use a reference to freed, zero-sized memory. This subtle distinction is called out in <a href="https://doc.rust-lang.org/std/ptr/index.html#safety">https://doc.rust-lang.org/std/ptr/index.html#safety</a>. <a href="#fnref:but-you-cannot-free-it" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:requires-transmute" role="doc-endnote"> <p>Currently, a <code class="language-plaintext highlighter-rouge">transmute</code> must be used to perform this operation, but I see no reason way this would permit us to perform an illegal mutation without uttering <code class="language-plaintext highlighter-rouge">unsafe</code> a second time. In particular, <code class="language-plaintext highlighter-rouge">MaybeUninit::assume_init_read()</code>, which could be used to perform illegal copies, is an <code class="language-plaintext highlighter-rouge">unsafe</code> function. <a href="#fnref:requires-transmute" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:covariance" role="doc-endnote"> <p>A covariant type <code class="language-plaintext highlighter-rouge">Cov&lt;T&gt;</code> is once where, if <code class="language-plaintext highlighter-rouge">T</code> is a subtype of <code class="language-plaintext highlighter-rouge">U</code>, then <code class="language-plaintext highlighter-rouge">Cov&lt;T&gt;</code> is a subtype of <code class="language-plaintext highlighter-rouge">Cov&lt;U&gt;</code>. This isn’t particularly noticeable in Rust, where the only subtyping relationships are <code class="language-plaintext highlighter-rouge">&amp;'a T</code> subtypes <code class="language-plaintext highlighter-rouge">&amp;'b T</code> when <code class="language-plaintext highlighter-rouge">'a</code> outlives <code class="language-plaintext highlighter-rouge">'b</code>, but is nonetheless important for advanced type design. <a href="#fnref:covariance" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:but-thread-safety" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge">Cell&lt;T&gt;</code> does not provide synchronization; you still need locks to share it between threads. <a href="#fnref:but-thread-safety" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:unsafe-lifetime" role="doc-endnote"> <p>I have previously proposed a sort of <code class="language-plaintext highlighter-rouge">'unsafe</code> or <code class="language-plaintext highlighter-rouge">'!</code> “lifetime” that is intended to be the lifetime of dangling references (a bit of an oxymoron). This would allow us to express this concept, but I need to flesh out the concept more. <a href="#fnref:unsafe-lifetime" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-07-14</span> / <h6 style="display:inline"><a href="/2025/07/14/best/">The Best C++ Library</a></h6> <li> <span class="post-meta">2025-07-07</span> / <h6 style="display:inline"><a href="/2025/07/07/nosplit/">What's //go:nosplit for?</a></h6> <li> <span class="post-meta">2025-06-03</span> / <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/">Protobuf Tip #7: Scoping It Out</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2021-05-24</span> <span class="censored">•</span> <span class="censored">2069</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">22</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#c++"><span class="censored">#c++</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#rust"><span class="censored">#rust</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#pointers"><span class="censored">#pointers</span></a> </span> <h1><a href="/2021/05/24/ptr-taxonomy/"> <span class="censored">The</span> <span class="censored">Taxonomy</span> <span class="censored">of</span> <span class="censored">Pointers</span> </a></h1> </div> <div class="post"> <p><span class="censored">Writing</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code> <span class="censored">in</span> <span class="censored">Rust</span> <span class="censored">usually</span> <span class="censored">involves</span> <span class="censored">manual</span> <span class="censored">management</span> <span class="censored">of</span> <span class="censored">memory.</span> <span class="censored">Although,</span> <span class="censored">ideally,</span> <span class="censored">we’d</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">exclusively</span> <span class="censored">use</span> <span class="censored">references</span> <span class="censored">for</span> <span class="censored">this,</span> <span class="censored">sometimes</span> <span class="censored">the</span> <span class="censored">constraints</span> <span class="censored">they</span> <span class="censored">apply</span> <span class="censored">are</span> <span class="censored">too</span> <span class="censored">strong.</span> <span class="censored">This</span> <span class="censored">post</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">guide</span> <span class="censored">on</span> <span class="censored">those</span> <span class="censored">constraints</span> <span class="censored">and</span> <span class="censored">how</span> <span class="censored">to</span> <span class="censored">weaken</span> <span class="censored">them</span> <span class="censored">for</span> <span class="censored">correctness.</span></p> <p><span class="censored">“Unmanaged”</span> <span class="censored">languages,</span> <span class="censored">like</span> <span class="censored">C++</span> <span class="censored">and</span> <span class="censored">Rust,</span> <span class="censored">provide</span> <em><span class="censored">pointer</span></em> <span class="censored">types</span> <span class="censored">for</span> <span class="censored">manipulating</span> <span class="censored">memory.</span> <span class="censored">These</span> <span class="censored">types</span> <span class="censored">serve</span> <span class="censored">different</span> <span class="censored">purposes</span> <span class="censored">and</span> <span class="censored">provide</span> <span class="censored">different</span> <span class="censored">guarantees.</span> <span class="censored">These</span> <span class="censored">guarantees</span> <span class="censored">are</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">optimizer</span> <span class="censored">but</span> <span class="censored">get</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">way</span> <span class="censored">of</span> <span class="censored">correctness</span> <span class="censored">of</span> <span class="censored">low-level</span> <span class="censored">code.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">especially</span> <span class="censored">true</span> <span class="censored">in</span> <span class="censored">Rust,</span> <span class="censored">where</span> <span class="censored">these</span> <span class="censored">constraints</span> <span class="censored">are</span> <span class="censored">very</span> <span class="censored">tight.</span></p> <blockquote> <p><span class="censored">NB:</span> <span class="censored">This</span> <span class="censored">post</span> <span class="censored">only</span> <span class="censored">surveys</span> <em><span class="censored">data</span></em> <span class="censored">pointers.</span> <span class="censored">Function</span> <span class="censored">pointers</span> <span class="censored">are</span> <span class="censored">their</span> <span class="censored">own</span> <span class="censored">beast,</span> <span class="censored">but</span> <span class="censored">generally</span> <span class="censored">are</span> <span class="censored">less</span> <span class="censored">fussy,</span> <span class="censored">since</span> <span class="censored">they</span> <span class="censored">all</span> <span class="censored">have</span> <span class="censored">static</span> <span class="censored">lifetime</span><sup id="fnref:go-nuts" role="doc-noteref"><a href="#fn:go-nuts" class="footnote" rel="footnote"><span class="censored">1</span></a></sup><span class="censored">.</span></p> </blockquote> <h2 id="basic-c-pointers"><a href="#basic-c-pointers"><span class="censored">Basic</span> <span class="censored">C++</span> <span class="censored">Pointers</span></a></h2> <p><span class="censored">First,</span> <span class="censored">let’s</span> <span class="censored">survey</span> <span class="censored">C++.</span> <span class="censored">We</span> <span class="censored">have</span> <span class="censored">three</span> <span class="censored">pointer</span> <span class="censored">types:</span> <span class="censored">the</span> <span class="censored">traditional</span> <span class="censored">C</span> <span class="censored">pointer</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T*</span></code><span class="censored">,</span> <span class="censored">C++</span> <span class="censored">references</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">rvalue</span> <span class="censored">references</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;&amp;</span></code><span class="censored">.</span> <span class="censored">These</span> <span class="censored">generally</span> <span class="censored">have</span> <span class="censored">pretty</span> <span class="censored">weak</span> <span class="censored">guarantees.</span></p> <p><span class="censored">Pointers</span> <span class="censored">provide</span> <span class="censored">virtually</span> <span class="censored">no</span> <span class="censored">guarantees</span> <span class="censored">at</span> <span class="censored">all:</span> <span class="censored">they</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">null,</span> <span class="censored">point</span> <span class="censored">to</span> <span class="censored">uninitialized</span> <span class="censored">memory,</span> <span class="censored">or</span> <span class="censored">point</span> <span class="censored">to</span> <span class="censored">nothing</span> <span class="censored">at</span> <span class="censored">all!</span> <span class="censored">C++</span> <span class="censored">Only</span> <span class="censored">requires</span> <span class="censored">that</span> <span class="censored">they</span> <span class="censored">be</span> <span class="censored">aligned</span><sup id="fnref:unaligned" role="doc-noteref"><a href="#fn:unaligned" class="footnote" rel="footnote"><span class="censored">2</span></a></sup><span class="censored">.</span> <span class="censored">They</span> <span class="censored">are</span> <span class="censored">little</span> <span class="censored">more</span> <span class="censored">than</span> <span class="censored">an</span> <span class="censored">address</span> <span class="censored">(until</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">dereferenced,</span> <span class="censored">of</span> <span class="censored">course).</span></p> <p><span class="censored">References,</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">hand,</span> <span class="censored">are</span> <span class="censored">intended</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">the</span> <span class="censored">“primary”</span> <span class="censored">pointer</span> <span class="censored">type.</span> <span class="censored">A</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code> <span class="censored">cannot</span> <span class="censored">be</span> <span class="censored">null,</span> <span class="censored">is</span> <span class="censored">well-aligned,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">intended</span> <span class="censored">to</span> <span class="censored">only</span> <span class="censored">refer</span> <span class="censored">to</span> <span class="censored">live</span> <span class="censored">memory</span> <span class="censored">(although</span> <span class="censored">it’s</span> <span class="censored">not</span> <span class="censored">something</span> <span class="censored">C++</span> <span class="censored">can</span> <span class="censored">really</span> <span class="censored">guarantee</span> <span class="censored">for</span> <span class="censored">lack</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">borrow-checker).</span> <span class="censored">References</span> <span class="censored">are</span> <span class="censored">short-lived.</span></p> <p><span class="censored">C++</span> <span class="censored">uses</span> <span class="censored">non-nullness</span> <span class="censored">to</span> <span class="censored">its</span> <span class="censored">advantage.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">Clang</span> <span class="censored">will</span> <span class="censored">absolutely</span> <span class="censored">delete</span> <span class="censored">code</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">form</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">auto</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">Foo</span></span><span class="p"><span class="censored">();</span></span>
<span class="k"><span class="censored">if</span></span> <span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">==</span></span> <span class="nb"><span class="censored">nullptr</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">DoSomething</span></span><span class="p"><span class="censored">();</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">Because</span> <span class="censored">references</span> <span class="censored">cannot</span> <span class="censored">be</span> <span class="censored">null,</span> <span class="censored">and</span> <span class="censored">dereferencing</span> <span class="censored">the</span> <span class="censored">null</span> <span class="censored">pointer</span> <span class="censored">is</span> <span class="censored">always</span> <span class="censored">UB,</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">may</span> <span class="censored">make</span> <span class="censored">this</span> <span class="censored">fairly</span> <span class="censored">strong</span> <span class="censored">assumption.</span></p> <p><span class="censored">Rvalue</span> <span class="censored">references,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;&amp;</span></code><span class="censored">,</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">meaningfully</span> <span class="censored">different</span> <span class="censored">from</span> <span class="censored">normal</span> <span class="censored">references,</span> <span class="censored">beyond</span> <span class="censored">their</span> <span class="censored">role</span> <span class="censored">in</span> <span class="censored">overload</span> <span class="censored">resolution.</span></p> <p><span class="censored">Choosing</span> <span class="censored">a</span> <span class="censored">C++</span> <span class="censored">(primitive)</span> <span class="censored">pointer</span> <span class="censored">type</span> <span class="censored">is</span> <span class="censored">well-studied</span> <span class="censored">and</span> <span class="censored">not</span> <span class="censored">the</span> <span class="censored">primary</span> <span class="censored">purpose</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">blog.</span> <span class="censored">Rather,</span> <span class="censored">we’re</span> <span class="censored">interested</span> <span class="censored">in</span> <span class="censored">how</span> <span class="censored">these</span> <span class="censored">map</span> <span class="censored">to</span> <span class="censored">Rust,</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">significantly</span> <span class="censored">more</span> <span class="censored">complicated</span> <span class="censored">pointers.</span></p> <h2 id="basic-rust-pointers"><a href="#basic-rust-pointers"><span class="censored">Basic</span> <span class="censored">Rust</span> <span class="censored">Pointers</span></a></h2> <p><span class="censored">Like</span> <span class="censored">C++,</span> <span class="censored">Rust</span> <span class="censored">has</span> <span class="censored">two</span> <span class="censored">broad</span> <span class="censored">pointer</span> <span class="censored">types:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*const</span> <span class="censored">T</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*mut</span> <span class="censored">T</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">raw</span> <span class="censored">pointers,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">references.</span></p> <p><span class="censored">Rust</span> <span class="censored">pointer</span> <span class="censored">have</span> <span class="censored">even</span> <span class="censored">fewer</span> <span class="censored">constraints</span> <span class="censored">than</span> <span class="censored">C++</span> <span class="censored">pointers;</span> <span class="censored">they</span> <span class="censored">need</span> <span class="censored">not</span> <span class="censored">even</span> <span class="censored">be</span> <span class="censored">aligned</span><sup id="fnref:unaligned-access" role="doc-noteref"><a href="#fn:unaligned-access" class="footnote" rel="footnote"><span class="censored">3</span></a></sup><span class="censored">!</span> <span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">const</span></code><span class="censored">/</span><code class="language-plaintext highlighter-rouge"><span class="censored">mut</span></code> <span class="censored">specifier</span> <span class="censored">is</span> <span class="censored">basically</span> <span class="censored">irrelevant,</span> <span class="censored">but</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">as</span> <span class="censored">programmer</span> <span class="censored">book-keeping</span> <span class="censored">tool.</span> <span class="censored">Rust</span> <span class="censored">also</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">enforce</span> <span class="censored">the</span> <span class="censored">dreaded</span> <span class="censored">strict-aliasing</span> <span class="censored">rule</span><sup id="fnref:strict-aliasing" role="doc-noteref"><a href="#fn:strict-aliasing" class="footnote" rel="footnote"><span class="censored">4</span></a></sup> <span class="censored">on</span> <span class="censored">its</span> <span class="censored">pointers.</span></p> <p><span class="censored">On</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">hand,</span> <span class="censored">Rust</span> <span class="censored">references</span> <span class="censored">are</span> <span class="censored">among</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">constrained</span> <span class="censored">objects</span> <span class="censored">in</span> <span class="censored">any</span> <span class="censored">language</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">know</span> <span class="censored">of.</span> <span class="censored">A</span> <span class="censored">shared</span> <span class="censored">reference</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;'a</span> <span class="censored">T</span></code><span class="censored">,</span> <span class="censored">lasting</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">lifetime</span> <code class="language-plaintext highlighter-rouge"><span class="censored">'a</span></code><span class="censored">,</span> <span class="censored">satisfies:</span></p> <ul> <li> <span class="censored">Non-null,</span> <span class="censored">and</span> <span class="censored">well-aligned</span> <span class="censored">(like</span> <span class="censored">in</span> <span class="censored">C++).</span> </li> <li> <span class="censored">Points</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">valid,</span> <span class="censored">initialized</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T</span></code> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">duration</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">'a</span></code><span class="censored">.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">T</span></code> <span class="censored">is</span> <span class="censored">never</span> <span class="censored">ever</span> <span class="censored">mutated</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">duration</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">reference:</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">may</span> <span class="censored">fold</span> <span class="censored">separate</span> <span class="censored">reads</span> <span class="censored">into</span> <span class="censored">one</span> <span class="censored">at</span> <span class="censored">will.</span> <span class="censored">Stronger</span> <span class="censored">still,</span> <span class="censored">no</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code> <span class="censored">is</span> <span class="censored">reachable</span> <span class="censored">from</span> <span class="censored">any</span> <span class="censored">thread</span> <span class="censored">while</span> <span class="censored">the</span> <span class="censored">reference</span> <span class="censored">is</span> <span class="censored">reachable.</span> </li> </ul> <p><span class="censored">Stronger</span> <span class="censored">still</span> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;'a</span> <span class="censored">mut</span> <span class="censored">T</span></code> <span class="censored">references,</span> <span class="censored">sometimes</span> <span class="censored">called</span> <em><span class="censored">unique</span></em> <span class="censored">references,</span> <span class="censored">because</span> <span class="censored">in</span> <span class="censored">addition</span> <span class="censored">to</span> <span class="censored">being</span> <span class="censored">well-aligned</span> <span class="censored">and</span> <span class="censored">pointing</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">valid</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T</span></code> <span class="censored">at</span> <span class="censored">all</span> <span class="censored">times,</span> <span class="censored">no</span> <span class="censored">other</span> <span class="censored">reachable</span> <span class="censored">reference</span> <span class="censored">ever</span> <span class="censored">aliases</span> <span class="censored">it</span> <span class="censored">in</span> <span class="censored">any</span> <span class="censored">thread;</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">equivalent</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">C</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T*</span> <span class="censored">restrict</span></code> <span class="censored">pointer.</span></p> <p><span class="censored">Unlike</span> <span class="censored">C++,</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">two</span> <span class="censored">almost-identical</span> <span class="censored">pointer</span> <span class="censored">types,</span> <span class="censored">Rust’s</span> <span class="censored">two</span> <span class="censored">pointer</span> <span class="censored">types</span> <span class="censored">provide</span> <span class="censored">either</span> <span class="censored">no</span> <span class="censored">guarantees</span> <span class="censored">or</span> <em><span class="censored">all</span></em> <span class="censored">of</span> <span class="censored">them.</span> <span class="censored">The</span> <span class="censored">following</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code> <span class="censored">operations</span> <span class="censored">are</span> <span class="censored">all</span> <span class="censored">UB:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">null</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">&amp;*</span></span><span class="nn"><span class="censored">ptr</span></span><span class="p"><span class="censored">::</span></span><span class="nf"><span class="censored">null</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">};</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">A</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">u8</span> <span class="censored">need</span> <span class="censored">not</span> <span class="censored">be</span> <span class="censored">sufficiently</span> <span class="censored">aligned</span></span>
<span class="c1"><span class="censored">//</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">u32.</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">unaligned</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">&amp;*</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="mi"><span class="censored">0u8</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">const</span></span> <span class="nb"><span class="censored">u8</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">const</span></span> <span class="nb"><span class="censored">u32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">};</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">More</span> <span class="censored">on</span> <span class="censored">this</span> <span class="censored">type</span> <span class="censored">later...</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">uninit</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">&amp;*</span></span><span class="nn"><span class="censored">MaybeUninit</span></span><span class="p"><span class="censored">::</span></span><span class="nf"><span class="censored">uninit</span></span><span class="p"><span class="censored">()</span></span><span class="nf"><span class="censored">.as_ptr</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">};</span></span>

<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">Not</span> <span class="censored">UB</span> <span class="censored">in</span> <span class="censored">C++</span> <span class="censored">with</span> <span class="censored">const_cast!</span></span>
  <span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">p</span></span> <span class="o"><span class="censored">=</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span>
  <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">p</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">const</span></span> <span class="nb"><span class="censored">i32</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">mut</span></span> <span class="nb"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span><span class="nf"><span class="censored">.write</span></span><span class="p"><span class="censored">(</span></span><span class="mi"><span class="censored">42</span></span><span class="p"><span class="censored">);</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">Two</span> <span class="censored">mutable</span> <span class="censored">references</span> <span class="censored">live</span> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">time</span> <span class="censored">pointing</span> <span class="censored">to</span></span>
<span class="c1"><span class="censored">//</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">memory.</span> <span class="censored">This</span> <span class="censored">would</span> <span class="censored">also</span> <span class="censored">be</span> <span class="censored">fine</span> <span class="censored">in</span> <span class="censored">C++!</span></span>
<span class="k"><span class="censored">let</span></span> <span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">y</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">p1</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">&amp;*</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">y</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">mut</span></span> <span class="nb"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">};</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">p2</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">&amp;*</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">y</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">mut</span></span> <span class="nb"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">};</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <h3 id="wide-pointers"><a href="#wide-pointers"><span class="censored">Wide</span> <span class="censored">Pointers</span></a></h3> <p><span class="censored">Rust</span> <span class="censored">also</span> <span class="censored">provides</span> <span class="censored">the</span> <span class="censored">slice</span> <span class="censored">types</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;[T]</span></code><sup id="fnref:std-span" role="doc-noteref"><a href="#fn:std-span" class="footnote" rel="footnote"><span class="censored">5</span></a></sup> <span class="censored">(of</span> <span class="censored">which</span> <span class="censored">you</span> <span class="censored">get</span> <span class="censored">mutable/immutable</span> <span class="censored">reference</span> <span class="censored">and</span> <span class="censored">pointer</span> <span class="censored">varieties)</span> <span class="censored">and</span> <span class="censored">dynamic</span> <span class="censored">trait</span> <span class="censored">object</span> <span class="censored">types</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;dyn</span> <span class="censored">Tr</span></code> <span class="censored">(again,</span> <span class="censored">all</span> <span class="censored">four</span> <span class="censored">basic</span> <span class="censored">pointer</span> <span class="censored">types</span> <span class="censored">are</span> <span class="censored">available).</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">&amp;[T]</span></code> <span class="censored">is</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">usize</span></code><sup id="fnref:usize" role="doc-noteref"><a href="#fn:usize" class="footnote" rel="footnote"><span class="censored">6</span></a></sup> <span class="censored">length</span> <span class="censored">plus</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">many</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T</span></code><span class="censored">s.</span> <span class="censored">The</span> <span class="censored">pointer</span> <span class="censored">type</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">slice</span> <span class="censored">specifies</span> <span class="censored">the</span> <span class="censored">guarantees</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">pointed-to</span> <span class="censored">buffer.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*mut</span> <span class="censored">[T]</span></code><span class="censored">,</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">has</span> <span class="censored">no</span> <span class="censored">meaningful</span> <span class="censored">guarantees,</span> <span class="censored">but</span> <span class="censored">still</span> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">length</span><sup id="fnref:ptr-len" role="doc-noteref"><a href="#fn:ptr-len" class="footnote" rel="footnote"><span class="censored">7</span></a></sup><span class="censored">.</span> <span class="censored">Note</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">length</span> <span class="censored">is</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">pointer</span> <span class="censored">value,</span> <em><span class="censored">not</span></em> <span class="censored">the</span> <span class="censored">pointee.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">&amp;dyn</span> <span class="censored">Tr</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">trait</span> <span class="censored">object.</span> <span class="censored">For</span> <span class="censored">our</span> <span class="censored">purposes,</span> <span class="censored">it</span> <span class="censored">consists</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">some</span> <span class="censored">data</span> <span class="censored">plus</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">static</span> <span class="censored">vtable.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*mut</span> <span class="censored">dyn</span> <span class="censored">Tr</span></code> <span class="censored">is</span> <span class="censored">technically</span> <span class="censored">a</span> <span class="censored">valid</span> <span class="censored">type</span><sup id="fnref:raw-vtable" role="doc-noteref"><a href="#fn:raw-vtable" class="footnote" rel="footnote"><span class="censored">8</span></a></sup><span class="censored">.</span> <span class="censored">Overall,</span> <span class="censored">trait</span> <span class="censored">objects</span> <span class="censored">aren’t</span> <span class="censored">really</span> <span class="censored">relevant</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">post;</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">rarely</span> <span class="censored">used</span> <span class="censored">this</span> <span class="censored">way</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code> <span class="censored">settings.</span></p> <h2 id="weakening-the-guarantees"><a href="#weakening-the-guarantees"><span class="censored">Weakening</span> <span class="censored">the</span> <span class="censored">Guarantees</span></a></h2> <p><span class="censored">Suppose</span> <span class="censored">we’re</span> <span class="censored">building</span> <span class="censored">some</span> <span class="censored">kind</span> <span class="censored">of</span> <span class="censored">data</span> <span class="censored">structure;</span> <span class="censored">in</span> <span class="censored">Rust,</span> <span class="censored">data</span> <span class="censored">structures</span> <span class="censored">will</span> <span class="censored">need</span> <span class="censored">some</span> <span class="censored">sprinkling</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code><span class="censored">,</span> <span class="censored">since</span> <span class="censored">they</span> <span class="censored">will</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">shovel</span> <span class="censored">around</span> <span class="censored">memory</span> <span class="censored">directly.</span> <span class="censored">Typically</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">done</span> <span class="censored">using</span> <span class="censored">raw</span> <span class="censored">pointers,</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">preferable</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">the</span> <em><span class="censored">least</span> <span class="censored">weakened</span></em> <span class="censored">pointer</span> <span class="censored">type</span> <span class="censored">to</span> <span class="censored">allow</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">to</span> <span class="censored">perform</span> <span class="censored">whatever</span> <span class="censored">optimizations</span> <span class="censored">it</span> <span class="censored">can.</span></p> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">a</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">orthogonal</span> <span class="censored">guarantees</span> <span class="censored">on</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code> <span class="censored">we</span> <span class="censored">might</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">relax:</span></p> <ul> <li><span class="censored">Non-nullness.</span></li> <li><span class="censored">Well-aligned-ness.</span></li> <li> <span class="censored">Validity</span> <span class="censored">and</span> <span class="censored">initialized-ness</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">pointee.</span> </li> <li> <span class="censored">Allocated-ness</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">pointee</span> <span class="censored">(implied</span> <span class="censored">by</span> <span class="censored">initialized-ness).</span> </li> <li> <span class="censored">Global</span> <span class="censored">uniqueness</span> <span class="censored">of</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code><span class="censored">.</span> </li> </ul> <h3 id="pointer-to-zst"><a href="#pointer-to-zst"><span class="censored">Pointer</span> <span class="censored">to</span> <span class="censored">ZST</span></a></h3> <p><span class="censored">The</span> <span class="censored">last</span> <span class="censored">three</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">properties</span> <span class="censored">are</span> <span class="censored">irrelevant</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">zero-sized</span> <span class="censored">type.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">generate</span> <span class="censored">infinite</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">()</span></code> <span class="censored">with</span> <span class="censored">no</span> <span class="censored">consequences:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">unique_unit</span></span><span class="p"><span class="censored">()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">'static</span></span> <span class="k"><span class="censored">mut</span></span> <span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="o"><span class="censored">*</span></span><span class="p"><span class="censored">(</span></span><span class="mi"><span class="censored">0x1</span></span> <span class="k"><span class="censored">as</span></span> <span class="o"><span class="censored">*</span></span><span class="k"><span class="censored">mut</span></span> <span class="p"><span class="censored">())</span></span> <span class="p"><span class="censored">}</span></span> 
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">We</span> <span class="censored">materialize</span> <span class="censored">a</span> <span class="censored">non-null,</span> <span class="censored">well-aligned</span> <span class="censored">pointer</span> <span class="censored">and</span> <span class="censored">reborrow</span> <span class="censored">it</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">static</span> <span class="censored">reference;</span> <span class="censored">because</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">no</span> <span class="censored">data</span> <span class="censored">to</span> <span class="censored">point</span> <span class="censored">to,</span> <span class="censored">none</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">usual</span> <span class="censored">worries</span> <span class="censored">about</span> <span class="censored">the</span> <span class="censored">pointee</span> <span class="censored">itself</span> <span class="censored">apply.</span> <span class="censored">However,</span> <span class="censored">the</span> <span class="censored">pointer</span> <span class="censored">itself</span> <span class="censored">must</span> <span class="censored">still</span> <span class="censored">be</span> <span class="censored">non-null</span> <span class="censored">and</span> <span class="censored">well-aligned;</span> <code class="language-plaintext highlighter-rouge"><span class="censored">0x1</span></code> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">a</span> <span class="censored">valid</span> <span class="censored">address</span> <span class="censored">for</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;[u32;</span> <span class="censored">0]</span></code><span class="censored">,</span> <span class="censored">but</span> <code class="language-plaintext highlighter-rouge"><span class="censored">0x4</span></code> <span class="censored">is</span><sup id="fnref:but-you-cannot-free-it" role="doc-noteref"><a href="#fn:but-you-cannot-free-it" class="footnote" rel="footnote"><span class="censored">9</span></a></sup><span class="censored">.</span></p> <p><span class="censored">This</span> <span class="censored">also</span> <span class="censored">applies</span> <span class="censored">to</span> <span class="censored">empty</span> <span class="censored">slices;</span> <span class="censored">in</span> <span class="censored">fact,</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">will</span> <span class="censored">happily</span> <span class="censored">promote</span> <span class="censored">the</span> <span class="censored">expression</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">[]</span></code> <span class="censored">to</span> <span class="censored">an</span> <span class="censored">arbitrary</span> <span class="censored">lifetime:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">fn</span></span> <span class="n"><span class="censored">unique_empty</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">T</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">()</span></span> <span class="k"><span class="censored">-&gt;</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">'static</span></span> <span class="k"><span class="censored">mut</span></span> <span class="p"><span class="censored">[</span></span><span class="n"><span class="censored">T</span></span><span class="p"><span class="censored">]</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="p"><span class="censored">[]</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <h3 id="null-references"><a href="#null-references"><span class="censored">Null</span> <span class="censored">References</span></a></h3> <p><span class="censored">The</span> <span class="censored">most</span> <span class="censored">well-known</span> <span class="censored">manner</span> <span class="censored">of</span> <span class="censored">weakening</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Option&lt;&amp;T&gt;</span></code><span class="censored">.</span> <span class="censored">Rust</span> <span class="censored">guarantees</span> <span class="censored">that</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">ABI-compatible</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">C</span> <span class="censored">pointer</span> <code class="language-plaintext highlighter-rouge"><span class="censored">const</span> <span class="censored">T*</span></code><span class="censored">,</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Option::&lt;&amp;T&gt;::None</span></code> <span class="censored">being</span> <span class="censored">a</span> <span class="censored">null</span> <span class="censored">pointer</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">C</span> <span class="censored">side.</span> <span class="censored">This</span> <span class="censored">“null</span> <span class="censored">pointer</span> <span class="censored">optimization”</span> <span class="censored">applies</span> <span class="censored">to</span> <span class="censored">any</span> <span class="censored">type</span> <span class="censored">recursively</span> <span class="censored">containing</span> <span class="censored">at</span> <span class="censored">least</span> <span class="censored">one</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code><span class="censored">.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">extern</span></span> <span class="s"><span class="censored">"C"</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">DoSomething</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">:</span></span> <span class="nb"><span class="censored">Option</span></span><span class="o"><span class="censored">&lt;&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="nb"><span class="censored">u32</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">);</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">do_something</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="nf"><span class="censored">DoSomething</span></span><span class="p"><span class="censored">(</span></span><span class="nb"><span class="censored">None</span></span><span class="p"><span class="censored">);</span></span>  <span class="c1"><span class="censored">//</span> <span class="censored">C</span> <span class="censored">will</span> <span class="censored">see</span> <span class="censored">a</span> <span class="censored">`NULL`</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">argument.</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">The</span> <span class="censored">same</span> <span class="censored">effect</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">achieved</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">type</span> <span class="censored">using</span> <span class="censored">the</span> <a href="https://doc.rust-lang.org/std/ptr/struct.NonNull.html"><code class="language-plaintext highlighter-rouge"><span class="censored">NonNull<t></t></span></code></a> <span class="censored">standard</span> <span class="censored">library</span> <span class="censored">type:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Option<nonnull>&gt;</nonnull></span></code> <span class="censored">is</span> <span class="censored">identical</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*mut</span> <span class="censored">T</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">most</span> <span class="censored">beneficial</span> <span class="censored">for</span> <span class="censored">types</span> <span class="censored">which</span> <span class="censored">would</span> <span class="censored">otherwise</span> <span class="censored">contain</span> <span class="censored">a</span> <span class="censored">raw</span> <span class="censored">pointer:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">struct</span></span> <span class="nb"><span class="censored">Vec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">T</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">:</span></span> <span class="n"><span class="censored">NonNull</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">T</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">,</span></span>
  <span class="n"><span class="censored">len</span></span><span class="p"><span class="censored">:</span></span> <span class="nb"><span class="censored">usize</span></span><span class="p"><span class="censored">,</span></span>
  <span class="n"><span class="censored">cap</span></span><span class="p"><span class="censored">:</span></span> <span class="nb"><span class="censored">usize</span></span><span class="p"><span class="censored">,</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="nd"><span class="censored">assert_eq!</span></span><span class="p"><span class="censored">(</span></span><span class="nn"><span class="censored">size_of</span></span><span class="p"><span class="censored">::</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">Vec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">u8</span></span><span class="o"><span class="censored">&gt;&gt;</span></span><span class="p"><span class="censored">(),</span></span> <span class="nn"><span class="censored">size_of</span></span><span class="p"><span class="censored">::</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">Option</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">Vec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">u8</span></span><span class="o"><span class="censored">&gt;&gt;&gt;</span></span><span class="p"><span class="censored">())</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <h3 id="uninitialized-pointee"><a href="#uninitialized-pointee"><span class="censored">Uninitialized</span> <span class="censored">Pointee</span></a></h3> <p><span class="censored">No</span> <span class="censored">matter</span> <span class="censored">what,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">cannot</span> <span class="censored">point</span> <span class="censored">to</span> <span class="censored">uninitialized</span> <span class="censored">memory,</span> <span class="censored">since</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">is</span> <span class="censored">free</span> <span class="censored">to</span> <span class="censored">assume</span> <span class="censored">it</span> <span class="censored">may</span> <span class="censored">read</span> <span class="censored">such</span> <span class="censored">references</span> <span class="censored">at</span> <span class="censored">any</span> <span class="censored">time</span> <span class="censored">with</span> <span class="censored">no</span> <span class="censored">consequences.</span></p> <p><span class="censored">The</span> <span class="censored">following</span> <span class="censored">classic</span> <span class="censored">C</span> <span class="censored">pattern</span> <span class="censored">is</span> <span class="censored">verboten:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n"><span class="censored">Foo</span></span> <span class="n"><span class="censored">foo</span></span><span class="p"><span class="censored">;</span></span>
<span class="n"><span class="censored">initialize_foo</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">foo</span></span><span class="p"><span class="censored">);</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C</span></div></div> </div> <p><span class="censored">Rust</span> <span class="censored">doesn’t</span> <span class="censored">provide</span> <span class="censored">any</span> <span class="censored">particularly</span> <span class="censored">easy</span> <span class="censored">ways</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">memory</span> <span class="censored">without</span> <span class="censored">initializing</span> <span class="censored">it,</span> <span class="censored">too,</span> <span class="censored">so</span> <span class="censored">this</span> <span class="censored">usually</span> <span class="censored">isn’t</span> <span class="censored">a</span> <span class="censored">problem.</span> <span class="censored">The</span> <a href="https://doc.rust-lang.org/core/mem/union.MaybeUninit.html#method.assume_init_ref"><code class="language-plaintext highlighter-rouge"><span class="censored">MaybeUninit<t></t></span></code></a> <span class="censored">type</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">safely</span> <span class="censored">allocating</span> <span class="censored">memory</span> <span class="censored">without</span> <span class="censored">initializing</span> <span class="censored">it,</span> <span class="censored">via</span> <code class="language-plaintext highlighter-rouge"><span class="censored">MaybeUninit::uninit()</span></code><span class="censored">.</span></p> <p><span class="censored">This</span> <span class="censored">type</span> <span class="censored">acts</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">sort</span> <span class="censored">of</span> <span class="censored">“optimization</span> <span class="censored">barrier”</span> <span class="censored">that</span> <span class="censored">prevents</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">from</span> <span class="censored">assuming</span> <span class="censored">the</span> <span class="censored">pointee</span> <span class="censored">is</span> <span class="censored">initialized.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;MaybeUninit<t></t></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">potentially</span> <span class="censored">uninitialized</span> <span class="censored">but</span> <span class="censored">definitely</span> <span class="censored">allocated</span> <span class="censored">memory.</span> <span class="censored">It</span> <span class="censored">has</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">layout</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">Rust</span> <span class="censored">provides</span> <span class="censored">functions</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">assume_init_ref()</span></code> <span class="censored">for</span> <span class="censored">asserting</span> <span class="censored">that</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;MaybeUninit<t></t></span></code> <span class="censored">is</span> <span class="censored">definitely</span> <span class="censored">initialized.</span> <span class="censored">This</span> <span class="censored">assertion</span> <span class="censored">is</span> <span class="censored">similar</span> <span class="censored">in</span> <span class="censored">consequence</span> <span class="censored">to</span> <span class="censored">dereferencing</span> <span class="censored">a</span> <span class="censored">raw</span> <span class="censored">pointer.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">&amp;MaybeUninit<t></t></span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">MaybeUninit<t></t></span></code> <span class="censored">should</span> <span class="censored">almost</span> <span class="censored">be</span> <span class="censored">viewed</span> <span class="censored">as</span> <span class="censored">pointer</span> <span class="censored">types</span> <span class="censored">in</span> <span class="censored">their</span> <span class="censored">own</span> <span class="censored">right,</span> <span class="censored">since</span> <span class="censored">they</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">converted</span> <span class="censored">to/from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code> <span class="censored">under</span> <span class="censored">certain</span> <span class="censored">circumstances.</span></p> <p><span class="censored">Because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T</span></code> <span class="censored">is</span> <span class="censored">almost</span> <span class="censored">a</span> <span class="censored">“subtype”</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">MaybeUninit<t></t></span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">are</span> <span class="censored">entitled</span><sup id="fnref:requires-transmute" role="doc-noteref"><a href="#fn:requires-transmute" class="footnote" rel="footnote"><span class="censored">10</span></a></sup> <span class="censored">to</span> <span class="censored">“forget”</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">referent</span> <span class="censored">of</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">is</span> <span class="censored">initialized</span> <span class="censored">converting</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;MaybeUninit<t></t></span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">makes</span> <span class="censored">sense</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">is</span> <span class="censored">covariant</span><sup id="fnref:covariance" role="doc-noteref"><a href="#fn:covariance" class="footnote" rel="footnote"><span class="censored">11</span></a></sup> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code><span class="censored">.</span> <span class="censored">However,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">true</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code><span class="censored">,</span> <span class="censored">since</span> <span class="censored">it’s</span> <span class="censored">not</span> <span class="censored">covariant:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">let</span></span> <span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">uninit</span></span><span class="p"><span class="censored">:</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">MaybeUninit</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">i32</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="nf"><span class="censored">transmute</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">};</span></span>
<span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">uninit</span></span> <span class="o"><span class="censored">=</span></span> <span class="nn"><span class="censored">MaybeUninit</span></span><span class="p"><span class="censored">::</span></span><span class="nf"><span class="censored">uninit</span></span><span class="p"><span class="censored">();</span></span>  <span class="c1"><span class="censored">//</span> <span class="censored">Oops,</span> <span class="censored">`x`</span> <span class="censored">is</span> <span class="censored">now</span> <span class="censored">uninit!</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">These</span> <span class="censored">types</span> <span class="censored">are</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">talking</span> <span class="censored">to</span> <span class="censored">C++</span> <span class="censored">without</span> <span class="censored">giving</span> <span class="censored">up</span> <span class="censored">too</span> <span class="censored">many</span> <span class="censored">guarantees.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Option&lt;&amp;MaybeUninit<t>&gt;</t></span></code> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">almost</span> <span class="censored">perfect</span> <span class="censored">model</span> <span class="censored">of</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">const</span> <span class="censored">T*</span></code><span class="censored">,</span> <span class="censored">under</span> <span class="censored">the</span> <span class="censored">assumption</span> <span class="censored">that</span> <span class="censored">most</span> <span class="censored">pointers</span> <span class="censored">in</span> <span class="censored">C++</span> <span class="censored">are</span> <span class="censored">valid</span> <span class="censored">most</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">time.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">MaybeUninit<t></t></span></code> <span class="censored">also</span> <span class="censored">finds</span> <span class="censored">use</span> <span class="censored">in</span> <span class="censored">working</span> <span class="censored">with</span> <span class="censored">raw</span> <span class="censored">blocks</span> <span class="censored">of</span> <span class="censored">memory,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">in</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Vec</span></code><span class="censored">-style</span> <span class="censored">growable</span> <span class="censored">slice:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">struct</span></span> <span class="n"><span class="censored">SliceVec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nv"><span class="censored">'a</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">T</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">Backing</span> <span class="censored">memory.</span> <span class="censored">The</span> <span class="censored">first</span> <span class="censored">`len`</span> <span class="censored">elements</span> <span class="censored">of</span> <span class="censored">it</span> <span class="censored">are</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">known</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">initialized,</span> <span class="censored">but</span> <span class="censored">no</span> <span class="censored">more</span> <span class="censored">than</span> <span class="censored">that.</span></span>
  <span class="n"><span class="censored">data</span></span><span class="p"><span class="censored">:</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="nv"><span class="censored">'a</span></span> <span class="k"><span class="censored">mut</span></span> <span class="p"><span class="censored">[</span></span><span class="n"><span class="censored">MaybeUninit</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">T</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">],</span></span>
  <span class="n"><span class="censored">len</span></span><span class="p"><span class="censored">:</span></span> <span class="nb"><span class="censored">usize</span></span><span class="p"><span class="censored">,</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">impl</span></span> <span class="n"><span class="censored">SliceVec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nv"><span class="censored">'a</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">T</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">fn</span></span> <span class="nf"><span class="censored">push</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="k"><span class="censored">mut</span></span> <span class="k"><span class="censored">self</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">:</span></span> <span class="n"><span class="censored">T</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="nd"><span class="censored">assert!</span></span><span class="p"><span class="censored">(</span></span><span class="k"><span class="censored">self</span></span><span class="py"><span class="censored">.len</span></span> <span class="o"><span class="censored">&lt;</span></span> <span class="n"><span class="censored">data</span></span><span class="nf"><span class="censored">.len</span></span><span class="p"><span class="censored">());</span></span>

    <span class="k"><span class="censored">self</span></span><span class="py"><span class="censored">.data</span></span><span class="p"><span class="censored">[</span></span><span class="k"><span class="censored">self</span></span><span class="py"><span class="censored">.len</span></span><span class="p"><span class="censored">]</span></span> <span class="o"><span class="censored">=</span></span> <span class="nn"><span class="censored">MaybeUninit</span></span><span class="p"><span class="censored">::</span></span><span class="nf"><span class="censored">new</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">);</span></span>
    <span class="k"><span class="censored">self</span></span><span class="py"><span class="censored">.len</span></span> <span class="o"><span class="censored">+=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <h3 id="aliased-pointee"><a href="#aliased-pointee"><span class="censored">Aliased</span> <span class="censored">Pointee</span></a></h3> <p><code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code> <span class="censored">can</span> <span class="censored">never</span> <span class="censored">alias</span> <span class="censored">any</span> <span class="censored">other</span> <span class="censored">pointer,</span> <span class="censored">but</span> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">the</span> <span class="censored">mechanism</span> <span class="censored">by</span> <span class="censored">which</span> <span class="censored">we</span> <span class="censored">perform</span> <span class="censored">mutation.</span> <span class="censored">It</span> <span class="censored">can’t</span> <span class="censored">even</span> <span class="censored">alias</span> <span class="censored">with</span> <span class="censored">pointers</span> <span class="censored">that</span> <span class="censored">Rust</span> <span class="censored">can’t</span> <span class="censored">see;</span> <span class="censored">Rust</span> <span class="censored">assumes</span> <span class="censored">no</span> <span class="censored">one</span> <span class="censored">else</span> <span class="censored">can</span> <span class="censored">touch</span> <span class="censored">this</span> <span class="censored">memory.</span> <span class="censored">Thus,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">an</span> <span class="censored">appropriate</span> <span class="censored">analogue</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code><span class="censored">.</span></p> <p><span class="censored">Like</span> <span class="censored">with</span> <span class="censored">uninitialized</span> <span class="censored">memory,</span> <span class="censored">Rust</span> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">“barrier”</span> <span class="censored">wrapper</span> <span class="censored">type,</span> <a href="https://doc.rust-lang.org/std/cell/struct.UnsafeCell.html"><code class="language-plaintext highlighter-rouge"><span class="censored">UnsafeCell<t></t></span></code></a><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">UnsafeCell<t></t></span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">“interior</span> <span class="censored">mutability”</span> <span class="censored">primitive,</span> <span class="censored">which</span> <span class="censored">permits</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">mutate</span> <span class="censored">through</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;UnsafeCell<t></t></span></code> <span class="censored">so</span> <span class="censored">long</span> <span class="censored">as</span> <span class="censored">concurrent</span> <span class="censored">reads</span> <span class="censored">and</span> <span class="censored">writes</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">occur.</span> <span class="censored">We</span> <span class="censored">may</span> <span class="censored">even</span> <span class="censored">convert</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;mut</span> <span class="censored">T</span></code> <span class="censored">when</span> <span class="censored">we’re</span> <span class="censored">sure</span> <span class="censored">we’re</span> <span class="censored">holding</span> <span class="censored">the</span> <span class="censored">only</span> <span class="censored">reference.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">UnsafeCell<t></t></span></code> <span class="censored">forms</span> <span class="censored">the</span> <span class="censored">basis</span> <span class="censored">of</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Cell<t></t></span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">RefCell<t></t></span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Mutex<t></t></span></code> <span class="censored">types,</span> <span class="censored">each</span> <span class="censored">of</span> <span class="censored">which</span> <span class="censored">performs</span> <span class="censored">a</span> <span class="censored">sort</span> <span class="censored">of</span> <span class="censored">“dynamic</span> <span class="censored">borrow-checking”:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">Cell<t></t></span></code> <span class="censored">only</span> <span class="censored">permits</span> <span class="censored">direct</span> <span class="censored">loads</span> <span class="censored">and</span> <span class="censored">stores.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">RefCell<t></t></span></code> <span class="censored">maintains</span> <span class="censored">a</span> <span class="censored">counter</span> <span class="censored">of</span> <span class="censored">references</span> <span class="censored">into</span> <span class="censored">it,</span> <span class="censored">which</span> <span class="censored">it</span> <span class="censored">uses</span> <span class="censored">to</span> <span class="censored">dynamically</span> <span class="censored">determine</span> <span class="censored">if</span> <span class="censored">a</span> <span class="censored">mutable</span> <span class="censored">reference</span> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">unique.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">Mutex<t></t></span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">RefCell<t></t></span></code> <span class="censored">but</span> <span class="censored">using</span> <span class="censored">concurrency</span> <span class="censored">primitives</span> <span class="censored">to</span> <span class="censored">maintain</span> <span class="censored">uniqueness.</span> </li> </ul> <p><span class="censored">Because</span> <span class="censored">of</span> <span class="censored">this,</span> <span class="censored">Rust</span> <span class="censored">must</span> <span class="censored">treat</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;UnsafeCell<t></t></span></code> <span class="censored">as</span> <span class="censored">always</span> <span class="censored">aliasing,</span> <span class="censored">but</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">mutate</span> <span class="censored">through</span> <span class="censored">it,</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">much</span> <span class="censored">closer</span> <span class="censored">analogue</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">C++</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code><span class="censored">.</span> <span class="censored">However,</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;T</span></code> <span class="censored">assumes</span> <span class="censored">the</span> <span class="censored">pointee</span> <span class="censored">is</span> <span class="censored">never</span> <span class="censored">mutated,</span> <span class="censored">it</span> <span class="censored">cannot</span> <span class="censored">coexist</span> <span class="censored">with</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;UnsafeCell<t></t></span></code> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">memory,</span> <span class="censored">if</span> <span class="censored">mutation</span> <span class="censored">is</span> <span class="censored">performed</span> <span class="censored">through</span> <span class="censored">it.</span> <span class="censored">The</span> <span class="censored">following</span> <span class="censored">is</span> <span class="censored">explicitly</span> <span class="censored">UB:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k"><span class="censored">let</span></span> <span class="k"><span class="censored">mut</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">p</span></span> <span class="o"><span class="censored">=</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">ok;</span> <span class="censored">creating</span> <span class="censored">the</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">UnsafeCell</span> <span class="censored">does</span> <span class="censored">not</span></span>
<span class="c1"><span class="censored">//</span> <span class="censored">immediately</span> <span class="censored">trigger</span> <span class="censored">UB.</span></span>
<span class="k"><span class="censored">let</span></span> <span class="n"><span class="censored">q</span></span> <span class="o"><span class="censored">=</span></span> <span class="k"><span class="censored">unsafe</span></span> <span class="p"><span class="censored">{</span></span> <span class="nn"><span class="censored">transmute</span></span><span class="p"><span class="censored">::</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">_</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">UnsafeCell</span></span><span class="o"><span class="censored">&lt;</span></span><span class="nb"><span class="censored">i32</span></span><span class="o"><span class="censored">&gt;&gt;</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">};</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">But</span> <span class="censored">writing</span> <span class="censored">to</span> <span class="censored">it</span> <span class="censored">does!</span></span>
<span class="n"><span class="censored">q</span></span><span class="nf"><span class="censored">.get</span></span><span class="p"><span class="censored">()</span></span><span class="nf"><span class="censored">.write</span></span><span class="p"><span class="censored">(</span></span><span class="mi"><span class="censored">42</span></span><span class="p"><span class="censored">);</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Rust</span></div></div> </div> <p><span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Cell<t></t></span></code> <span class="censored">type</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">non-aliasing</span> <span class="censored">references</span> <span class="censored">to</span> <span class="censored">plain-old-data</span> <span class="censored">types,</span> <span class="censored">which</span> <span class="censored">tend</span> <span class="censored">to</span> <span class="censored">be</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Copy</span></code><span class="censored">.</span> <span class="censored">It</span> <span class="censored">allows</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">perform</span> <span class="censored">mutation</span> <span class="censored">without</span> <span class="censored">having</span> <span class="censored">to</span> <span class="censored">utter</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code><span class="censored">.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">the</span> <span class="censored">correct</span> <span class="censored">type</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">shared</span> <span class="censored">mutable</span> <span class="censored">buffer</span> <span class="censored">in</span> <span class="censored">Rust</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;[Cell<u8>]</u8></span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">freely</span> <code class="language-plaintext highlighter-rouge"><span class="censored">memcpy</span></code><span class="censored">‘d,</span> <span class="censored">without</span> <span class="censored">worrying</span> <span class="censored">about</span> <span class="censored">aliasing</span><sup id="fnref:but-thread-safety" role="doc-noteref"><a href="#fn:but-thread-safety" class="footnote" rel="footnote"><span class="censored">12</span></a></sup><span class="censored">.</span></p> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">most</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">sharing</span> <span class="censored">memory</span> <span class="censored">with</span> <span class="censored">another</span> <span class="censored">language,</span> <span class="censored">like</span> <span class="censored">C++,</span> <span class="censored">which</span> <span class="censored">cannot</span> <span class="censored">respect</span> <span class="censored">Rust’s</span> <span class="censored">aliasing</span> <span class="censored">rules.</span></p> <h3 id="combined-barriers"><a href="#combined-barriers"><span class="censored">Combined</span> <span class="censored">Barriers</span></a></h3> <p><span class="censored">To</span> <span class="censored">recap:</span></p> <ul> <li> <span class="censored">Non-nullness</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">disabled</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Option&lt;&amp;T&gt;</span></code><span class="censored">.</span> </li> <li> <span class="censored">Initialized-ness</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">disabled</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;MaybeUninit<t></t></span></code><span class="censored">.</span> </li> <li> <span class="censored">Uniqueness</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">disabled</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;UnsafeCell<t></t></span></code><span class="censored">.</span> </li> </ul> <blockquote> <p><span class="censored">There</span> <span class="censored">is</span> <span class="censored">no</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">disable</span> <span class="censored">alignment</span> <span class="censored">and</span> <span class="censored">validity</span> <span class="censored">restrictions:</span> <span class="censored">references</span> <span class="censored">must</span> <span class="censored">always</span> <span class="censored">be</span> <span class="censored">aligned</span> <span class="censored">and</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">valid</span> <span class="censored">lifetime</span> <span class="censored">attached.</span> <span class="censored">If</span> <span class="censored">these</span> <span class="censored">are</span> <span class="censored">unachievable,</span> <span class="censored">raw</span> <span class="censored">pointers</span> <span class="censored">are</span> <span class="censored">your</span> <span class="censored">only</span> <span class="censored">option.</span></p> </blockquote> <p><span class="censored">We</span> <span class="censored">can</span> <span class="censored">combine</span> <span class="censored">these</span> <span class="censored">various</span> <span class="censored">“weakenings”</span> <span class="censored">to</span> <span class="censored">produce</span> <span class="censored">aligned,</span> <span class="censored">lifetime-bound</span> <span class="censored">references</span> <span class="censored">to</span> <span class="censored">data</span> <span class="censored">with</span> <span class="censored">different</span> <span class="censored">properties.</span> <span class="censored">For</span> <span class="censored">example:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;UnsafeCell<maybeuninit>&gt;</maybeuninit></span></code> <span class="censored">is</span> <span class="censored">as</span> <span class="censored">close</span> <span class="censored">as</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">get</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">C++</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code><span class="censored">.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">Option&lt;&amp;UnsafeCell<t>&gt;</t></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">like</span> <span class="censored">a</span> <span class="censored">raw</span> <span class="censored">pointer,</span> <span class="censored">but</span> <span class="censored">to</span> <span class="censored">initialized</span> <span class="censored">memory.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">Option&lt;&amp;mut</span> <span class="censored">MaybeUninit<t>&gt;</t></span></code> <span class="censored">is</span> <span class="censored">like</span> <span class="censored">a</span> <span class="censored">raw</span> <span class="censored">pointer,</span> <span class="censored">but</span> <span class="censored">with</span> <span class="censored">alignment,</span> <span class="censored">aliasing,</span> <span class="censored">and</span> <span class="censored">lifetime</span> <span class="censored">requirements.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">UnsafeCell&lt;&amp;[T]&gt;</span></code> <span class="censored">permits</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">mutate</span> <span class="censored">the</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">buffer</span> <span class="censored">and</span> <span class="censored">its</span> <span class="censored">length,</span> <span class="censored">but</span> <span class="censored">not</span> <span class="censored">the</span> <span class="censored">values</span> <span class="censored">it</span> <span class="censored">points</span> <span class="censored">to</span> <span class="censored">themselves.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">UnsafeCell&lt;&amp;[UnsafeCell<t>]&gt;</t></span></code> <span class="censored">lets</span> <span class="censored">us</span> <span class="censored">mutate</span> <span class="censored">both</span> <span class="censored">the</span> <span class="censored">buffer</span> <span class="censored">and</span> <span class="censored">its</span> <span class="censored">actual</span> <span class="censored">pointer/length.</span> </li> </ul> <p><span class="censored">Interestingly,</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">no</span> <span class="censored">equivalent</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">C++</span> <span class="censored">raw</span> <span class="censored">pointer:</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">no</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">create</span> <span class="censored">a</span> <span class="censored">guaranteed-aligned</span> <span class="censored">pointer</span> <span class="censored">without</span> <span class="censored">a</span> <span class="censored">designated</span> <span class="censored">lifetime</span><sup id="fnref:unsafe-lifetime" role="doc-noteref"><a href="#fn:unsafe-lifetime" class="footnote" rel="footnote"><span class="censored">13</span></a></sup><span class="censored">.</span></p> <h2 id="other-pointers"><a href="#other-pointers"><span class="censored">Other</span> <span class="censored">Pointers</span></a></h2> <p><span class="censored">Rust</span> <span class="censored">and</span> <span class="censored">C++</span> <span class="censored">have</span> <span class="censored">many</span> <span class="censored">other</span> <span class="censored">pointer</span> <span class="censored">types,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">smart</span> <span class="censored">pointers.</span> <span class="censored">However,</span> <span class="censored">in</span> <span class="censored">both</span> <span class="censored">languages,</span> <span class="censored">both</span> <span class="censored">are</span> <span class="censored">built</span> <span class="censored">in</span> <span class="censored">terms</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">basic</span> <span class="censored">pointer</span> <span class="censored">types.</span> <span class="censored">Hopefully</span> <span class="censored">this</span> <span class="censored">article</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">useful</span> <span class="censored">reference</span> <span class="censored">for</span> <span class="censored">anyone</span> <span class="censored">writing</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code> <span class="censored">abstraction</span> <span class="censored">that</span> <span class="censored">wishes</span> <span class="censored">to</span> <span class="censored">avoid</span> <span class="censored">using</span> <span class="censored">raw</span> <span class="censored">pointers</span> <span class="censored">when</span> <span class="censored">possible.</span></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:go-nuts" role="doc-endnote"> <p><span class="censored">Except</span> <span class="censored">in</span> <span class="censored">Go,</span> <span class="censored">which</span> <span class="censored">synthesizes</span> <span class="censored">vtables</span> <em><span class="censored">on</span> <span class="censored">the</span> <span class="censored">fly</span></em><span class="censored">.</span> <span class="censored">Story</span> <span class="censored">for</span> <span class="censored">another</span> <span class="censored">day. </span><a href="#fnref:go-nuts" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:unaligned" role="doc-endnote"> <p><span class="censored">It</span> <span class="censored">is,</span> <span class="censored">apparently,</span> <span class="censored">a</span> <span class="censored">little-known</span> <span class="censored">fact</span> <span class="censored">that</span> <span class="censored">constructing</span> <span class="censored">unaligned</span> <span class="censored">pointers,</span> <span class="censored">but</span> <span class="censored">then</span> <span class="censored">never</span> <span class="censored">dereferencing</span> <span class="censored">them,</span> <span class="censored">is</span> <span class="censored">still</span> <span class="censored">UB</span> <span class="censored">in</span> <span class="censored">C++.</span> <span class="censored">C++</span> <span class="censored">could,</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">store</span> <span class="censored">information</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">lower</span> <span class="censored">bits</span> <span class="censored">of</span> <span class="censored">such</span> <span class="censored">a</span> <span class="censored">pointer.</span> <span class="censored">The</span> <span class="censored">in-memory</span> <span class="censored">representation</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">unspecified! </span><a href="#fnref:unaligned" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:unaligned-access" role="doc-endnote"> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">when</span> <span class="censored">paired</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">Rust</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&lt;*const</span> <span class="censored">T&gt;::read_unaligned()</span></code> <span class="censored">function,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">compiled</span> <span class="censored">down</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">normal</span> <span class="censored">load</span> <span class="censored">on</span> <span class="censored">architectures</span> <span class="censored">that</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">have</span> <span class="censored">alignment</span> <span class="censored">restrictions,</span> <span class="censored">like</span> <span class="censored">x86_64</span> <span class="censored">and</span> <span class="censored">aarch64. </span><a href="#fnref:unaligned-access" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:strict-aliasing" role="doc-endnote"> <p><span class="censored">Another</span> <span class="censored">story</span> <span class="censored">for</span> <span class="censored">another</span> <span class="censored">time. </span><a href="#fnref:strict-aliasing" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:std-span" role="doc-endnote"> <p><span class="censored">Comparable</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">C++20</span> <a href="https://en.cppreference.com/w/cpp/container/span"><code class="language-plaintext highlighter-rouge"><span class="censored">std::span<t></t></span></code></a> <span class="censored">type. </span><a href="#fnref:std-span" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:usize" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge"><span class="censored">usize</span></code> <span class="censored">is</span> <span class="censored">Rust’s</span> <span class="censored">machine</span> <span class="censored">word</span> <span class="censored">type,</span> <span class="censored">compare</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::uintptr_t</span></code><span class="censored">. </span><a href="#fnref:usize" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:ptr-len" role="doc-endnote"> <p><span class="censored">The</span> <span class="censored">length</span> <span class="censored">of</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*mut</span> <span class="censored">[T]</span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">accessed</span> <span class="censored">via</span> <span class="censored">the</span> <span class="censored">unstable</span> <a href="https://doc.rust-lang.org/std/primitive.pointer.html#method.len-1"><code class="language-plaintext highlighter-rouge"><span class="censored">&lt;*mut</span> <span class="censored">[T]&gt;::len()</span></code></a> <span class="censored">method. </span><a href="#fnref:ptr-len" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:raw-vtable" role="doc-endnote"> <p><span class="censored">It</span> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">not</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">encountered</span> <span class="censored">enough</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">much</span> <span class="censored">knowledge</span> <span class="censored">on.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">I</span> <span class="censored">don’t</span> <span class="censored">actually</span> <span class="censored">know</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">vtable</span> <span class="censored">half</span> <span class="censored">of</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*mut</span> <span class="censored">dyn</span> <span class="censored">Tr</span></code> <span class="censored">must</span> <span class="censored">always</span> <span class="censored">be</span> <span class="censored">valid</span> <span class="censored">or</span> <span class="censored">not;</span> <span class="censored">I</span> <span class="censored">suspect</span> <span class="censored">the</span> <span class="censored">answer</span> <span class="censored">is</span> <span class="censored">“no”,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">couldn’t</span> <span class="censored">find</span> <span class="censored">a</span> <span class="censored">citation</span> <span class="censored">for</span> <span class="censored">this. </span><a href="#fnref:raw-vtable" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:but-you-cannot-free-it" role="doc-endnote"> <p><span class="censored">Note</span> <span class="censored">that</span> <span class="censored">you</span> <em><span class="censored">cannot</span></em> <span class="censored">continue</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">a</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">freed,</span> <span class="censored">zero-sized</span> <span class="censored">memory.</span> <span class="censored">This</span> <span class="censored">subtle</span> <span class="censored">distinction</span> <span class="censored">is</span> <span class="censored">called</span> <span class="censored">out</span> <span class="censored">in</span> <a href="https://doc.rust-lang.org/std/ptr/index.html#safety"><span class="censored">https://doc.rust-lang.org/std/ptr/index.html#safety</span></a><span class="censored">. </span><a href="#fnref:but-you-cannot-free-it" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:requires-transmute" role="doc-endnote"> <p><span class="censored">Currently,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">transmute</span></code> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">perform</span> <span class="censored">this</span> <span class="censored">operation,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">see</span> <span class="censored">no</span> <span class="censored">reason</span> <span class="censored">way</span> <span class="censored">this</span> <span class="censored">would</span> <span class="censored">permit</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">perform</span> <span class="censored">an</span> <span class="censored">illegal</span> <span class="censored">mutation</span> <span class="censored">without</span> <span class="censored">uttering</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code> <span class="censored">a</span> <span class="censored">second</span> <span class="censored">time.</span> <span class="censored">In</span> <span class="censored">particular,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">MaybeUninit::assume_init_read()</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">perform</span> <span class="censored">illegal</span> <span class="censored">copies,</span> <span class="censored">is</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">unsafe</span></code> <span class="censored">function. </span><a href="#fnref:requires-transmute" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:covariance" role="doc-endnote"> <p><span class="censored">A</span> <span class="censored">covariant</span> <span class="censored">type</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Cov<t></t></span></code> <span class="censored">is</span> <span class="censored">once</span> <span class="censored">where,</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">subtype</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">U</span></code><span class="censored">,</span> <span class="censored">then</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Cov<t></t></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">subtype</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Cov<u></u></span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">isn’t</span> <span class="censored">particularly</span> <span class="censored">noticeable</span> <span class="censored">in</span> <span class="censored">Rust,</span> <span class="censored">where</span> <span class="censored">the</span> <span class="censored">only</span> <span class="censored">subtyping</span> <span class="censored">relationships</span> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;'a</span> <span class="censored">T</span></code> <span class="censored">subtypes</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;'b</span> <span class="censored">T</span></code> <span class="censored">when</span> <code class="language-plaintext highlighter-rouge"><span class="censored">'a</span></code> <span class="censored">outlives</span> <code class="language-plaintext highlighter-rouge"><span class="censored">'b</span></code><span class="censored">,</span> <span class="censored">but</span> <span class="censored">is</span> <span class="censored">nonetheless</span> <span class="censored">important</span> <span class="censored">for</span> <span class="censored">advanced</span> <span class="censored">type</span> <span class="censored">design. </span><a href="#fnref:covariance" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:but-thread-safety" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge"><span class="censored">Cell<t></t></span></code> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">provide</span> <span class="censored">synchronization;</span> <span class="censored">you</span> <span class="censored">still</span> <span class="censored">need</span> <span class="censored">locks</span> <span class="censored">to</span> <span class="censored">share</span> <span class="censored">it</span> <span class="censored">between</span> <span class="censored">threads. </span><a href="#fnref:but-thread-safety" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:unsafe-lifetime" role="doc-endnote"> <p><span class="censored">I</span> <span class="censored">have</span> <span class="censored">previously</span> <span class="censored">proposed</span> <span class="censored">a</span> <span class="censored">sort</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">'unsafe</span></code> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">'!</span></code> <span class="censored">“lifetime”</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">intended</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">the</span> <span class="censored">lifetime</span> <span class="censored">of</span> <span class="censored">dangling</span> <span class="censored">references</span> <span class="censored">(a</span> <span class="censored">bit</span> <span class="censored">of</span> <span class="censored">an</span> <span class="censored">oxymoron).</span> <span class="censored">This</span> <span class="censored">would</span> <span class="censored">allow</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">express</span> <span class="censored">this</span> <span class="censored">concept,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">flesh</span> <span class="censored">out</span> <span class="censored">the</span> <span class="censored">concept</span> <span class="censored">more. </span><a href="#fnref:unsafe-lifetime" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-07-14</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/14/best/"><span class="censored">The</span> <span class="censored">Best</span> <span class="censored">C++</span> <span class="censored">Library</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-07</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/07/nosplit/"><span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-06-03</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#7:</span> <span class="censored">Scoping</span> <span class="censored">It</span> <span class="censored">Out</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>