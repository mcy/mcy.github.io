<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> The Best C++ Library &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="The Best C++ Library &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/best-324791d367b2da8330f31470b1da337fb47d4e35.png"> <meta property="og:title" content="The Best C++ Library &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/best-324791d367b2da8330f31470b1da337fb47d4e35.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/07/14/best/"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-07-14 • 4003 words • 44 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#c++">#c++</a> • <a href="https://mcyoung.xyz/tags.html#language-design">#language-design</a> • <a href="https://mcyoung.xyz/tags.html#metaprogramming">#metaprogramming</a> </span> <h1><a href="/2025/07/14/best/"> The Best C++ Library </a></h1> </div> <div class="post"> <p>It’s no secret that my taste in programming languages is very weird for a programming language <del>enthusiast</del> professional. Several of my <a href="https://mcyoung.xyz/2025/07/07/nosplit/">last</a> <a href="https://mcyoung.xyz/2025/04/21/go-arenas/">few</a> <a href="https://mcyoung.xyz/2024/12/16/rangefuncs/">posts</a> are about Go, broadly regarded as the programming language equivalent of eating plain oatmeal for breakfast.</p> <p>To make up for that, I’m going to write about the programming language equivalent of diluting your morning coffee with <a href="https://en.wikipedia.org/wiki/Everclear">Everclear</a>. I am, of course, talking about C++.</p> <p>If you’ve ever had the misfortune of doing C++ professionally, you’ll know that the C++ standard library is really bad. Where to begin?</p> <p>Well, the associative containers are terrible. Due to bone-headed API decisions, <a href="https://en.cppreference.com/w/cpp/container/unordered_map.html"><code class="language-plaintext highlighter-rouge">std::unordered_map</code></a> MUST be a closed-addressing, array-of-linked-lists map, not a Swisstable, despite closed-addressing being an outdated technology. <a href="https://www.cppreference.com/w/cpp/container/map.html"><code class="language-plaintext highlighter-rouge">std::map</code></a>, which is not what you usually want, <em>must</em> be a red-black tree. It can’t be a b-tree, like every sensible language provides for the ordered map.</p> <p><a href="https://en.cppreference.com/w/cpp/utility/optional.html"><code class="language-plaintext highlighter-rouge">std::optional</code></a> is a massive pain in the ass to use, and is full of footguns, like <code class="language-plaintext highlighter-rouge">operator*</code>. <code class="language-plaintext highlighter-rouge">std::variant</code> is also really annoying to use. <a href="https://en.cppreference.com/w/cpp/filesystem.html"><code class="language-plaintext highlighter-rouge">std::filesystem</code></a> is full of sharp edges. And where are the APIs for signals?</p> <p>Everything is extremely wordy. <a href="https://en.cppreference.com/w/cpp/thread/hardware_destructive_interference_size.html"><code class="language-plaintext highlighter-rouge">std::hardware_destructive_interference_size</code></a> could have been called <code class="language-plaintext highlighter-rouge">std::cache_line</code>. <a href="https://en.cppreference.com/w/cpp/container/span/subspan"><code class="language-plaintext highlighter-rouge">std::span::subspan</code></a> could have used <code class="language-plaintext highlighter-rouge">opeartor[]</code>. The standard algorithms are super wordy, because they deal with iterator pairs. Oh my god, iterator pairs. They added <a href="https://en.cppreference.com/w/cpp/ranges.html"><code class="language-plaintext highlighter-rouge">std::ranges</code></a>, which do not measure up to Rust’s <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html"><code class="language-plaintext highlighter-rouge">Iterator</code></a> at all!</p> <p>I’m so mad about all this! The people in charge of C++ clearly, actively hate their users!<sup id="fnref:terrible-people" role="doc-noteref"><a href="#fn:terrible-people" class="footnote" rel="footnote">1</a></sup> They want C++ to be as hard and unpleasant as possible to use. Many brilliant people that I am lucky to consider friends and colleagues, including Titus Winters, JeanHeyd Meneide, Matt Fowles-Kulukundis, and Andy Soffer, have tried and mostly failed<sup id="fnref:jh" role="doc-noteref"><a href="#fn:jh" class="footnote" rel="footnote">2</a></sup> to improve the language.</p> <p>This is much to say that I believe C++ in its current form is unfixable. But that’s only due to the small-mindedness of a small cabal based out of Redmond. What if we could do whatever we wanted? What if we used C++’s incredible library-building language features to build a brand-new language?</p> <p>For the last year-or-so I’ve been playing with a wild idea: what would C++ look like if we did it over again? Starting from an empty C++20 file with no access to the standard library, what can we build in its place?</p> <h2 id="starting-over"><a href="#starting-over">Starting Over</a></h2> <p>Titus started Abseil while at Google, whose namespace, <code class="language-plaintext highlighter-rouge">absl</code>, is sometimes said to stand for “a better standard library”<sup id="fnref:abcl" role="doc-noteref"><a href="#fn:abcl" class="footnote" rel="footnote">3</a></sup>. To me, Abseil is important because it was an attempt to work with the existing standard library and make it better, while retaining a high level of implementation quality that a C++ shop’s home-grown utility library won’t have, and a uniformity of vision that <a href="https://www.boost.org/">Boost</a> is too all-over-the-place to achieve.</p> <p>Rather than trying to coexist with the standard library, I want to surpass it. As a form of performance art, I want to discover what the standard library would look like if we designed it <em>today</em>, in 2025.</p> <p>In this sense, I want to build something that isn’t just <em>better</em>. It should be the C++ standard library from the best possible world. It is the best possible library. This is why my library’s namespace is <code class="language-plaintext highlighter-rouge">best</code>.</p> <p>In general, I am trying not to directly copy either what C++, or Abseil, or Rust, or Go did. However, each of them has really interesting ideas, and the best library probably lies in some middle-ground somewhere.</p> <p>The rest of this post will be about what I have achieved with <code class="language-plaintext highlighter-rouge">best</code> so far, and where I want to take it. You can look at the code <a href="https://github.com/mcy/best">here</a>.</p> <h3 id="building-a-foundation"><a href="#building-a-foundation">Building a Foundation</a></h3> <p>We’re throwing out everything, and that includes <code class="language-plaintext highlighter-rouge">&lt;type_traits&gt;</code>. This is a header which shows its age: alias templates were’t added until C++14, and variable templates were added in C++17. As a result, many things that really aught to be concepts have names like <code class="language-plaintext highlighter-rouge">best::is_same_v</code>. All of these now have concept equivalents in <code class="language-plaintext highlighter-rouge">&lt;concepts&gt;</code>.</p> <p>I have opted to try to classify type traits into separate headers to make them easier to find. They all live under <code class="language-plaintext highlighter-rouge">//best/meta/traits</code>, and they form the leaves of the dependency graph.</p> <p>For example, <code class="language-plaintext highlighter-rouge">arrays.h</code> contains all of the array traits, such as <code class="language-plaintext highlighter-rouge">best::is_array</code>, <code class="language-plaintext highlighter-rouge">best::un_array</code> (to remove an array extent), and <code class="language-plaintext highlighter-rouge">best::as_array</code>, which applies an extent to a type T, such that <code class="language-plaintext highlighter-rouge">best::as_array&lt;T, 0&gt;</code> is not an error.</p> <p><code class="language-plaintext highlighter-rouge">types.h</code> contains very low-level metaprogramming helpers, such as:</p> <ul> <li><code class="language-plaintext highlighter-rouge">best::id</code> and <code class="language-plaintext highlighter-rouge">best::val</code>, the identity traits for type- and value-kinded traits.</li> <li><code class="language-plaintext highlighter-rouge">best::same&lt;...&gt;</code>, which returns whether an entire <em>pack</em> of types is all equal.</li> <li><code class="language-plaintext highlighter-rouge">best::lie</code>, our version of <code class="language-plaintext highlighter-rouge">std::declval</code>.</li> <li><code class="language-plaintext highlighter-rouge">best::select</code>, our <code class="language-plaintext highlighter-rouge">std::conditional_t</code>.</li> <li><code class="language-plaintext highlighter-rouge">best::abridge</code>, a “symbol compression” mechanism for shortening the names of otherwise huge symbols.</li> </ul> <p><code class="language-plaintext highlighter-rouge">funcs.h</code> provides <code class="language-plaintext highlighter-rouge">best::tame</code>, which removes the qualifiers from an <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/p0172r0.html">abominable function type</a>. <code class="language-plaintext highlighter-rouge">quals.h</code> provides <code class="language-plaintext highlighter-rouge">best::qualifies_to</code>, necessary for determining if a type is “more const” than another. <code class="language-plaintext highlighter-rouge">empty.h</code> provides a standard empty type that interoperates cleanly with <code class="language-plaintext highlighter-rouge">void</code>.</p> <p>On top of the type traits is the metaprogramming library <code class="language-plaintext highlighter-rouge">//best/meta</code>, which includes generalized constructibility traits in <code class="language-plaintext highlighter-rouge">init.h</code> (e.g., to check that you can, in fact, initialize a <code class="language-plaintext highlighter-rouge">T&amp;</code> from a <code class="language-plaintext highlighter-rouge">T&amp;&amp;</code>, for example). <code class="language-plaintext highlighter-rouge">tlist.h</code> provides a very general type-level heterogenous list abstraction; a parameter pack as-a-type.</p> <p>The other part of “the foundation” is <code class="language-plaintext highlighter-rouge">//best/base</code>, which mostly provides access to intrinsics, portability helpers, macros, and “tag types” such as our versions of <code class="language-plaintext highlighter-rouge">std::in_place</code>. For example, <code class="language-plaintext highlighter-rouge">macro.h</code> provides <code class="language-plaintext highlighter-rouge">BEST_STRINGIFY()</code>, <code class="language-plaintext highlighter-rouge">port.h</code> provides <code class="language-plaintext highlighter-rouge">BEST_HAS_INCLUDE()</code>, and <code class="language-plaintext highlighter-rouge">hint.h</code> provides <code class="language-plaintext highlighter-rouge">best::unreachable()</code>.</p> <p><code class="language-plaintext highlighter-rouge">guard.h</code> provides our version of the Rust <code class="language-plaintext highlighter-rouge">?</code> operator, which is not an expression because statement expressions are broken in Clang.</p> <p>Finally, within <code class="language-plaintext highlighter-rouge">//best/container</code> we find <code class="language-plaintext highlighter-rouge">best::object</code>, a special type for turning any C++ type into an object (i.e., a type that you can form a reference to). This is useful for manipulating any type generically, without tripping over the assign-through semantics of references. For example, <code class="language-plaintext highlighter-rouge">best::object&lt;T&amp;&gt;</code> is essentially a pointer.</p> <h3 id="adt-containers"><a href="#adt-containers">“ADT” Containers</a></h3> <p>On top of this foundation we build the basic algebraic data types of <code class="language-plaintext highlighter-rouge">best</code>: <code class="language-plaintext highlighter-rouge">best::row</code> and <code class="language-plaintext highlighter-rouge">best::choice</code>, which replace <code class="language-plaintext highlighter-rouge">std::tuple</code> and <code class="language-plaintext highlighter-rouge">std::variant</code>.</p> <p><code class="language-plaintext highlighter-rouge">best::row&lt;A, B, C&gt;</code> is a heterogenous collection of values, stored inside of <code class="language-plaintext highlighter-rouge">best::object</code>s. This means that <code class="language-plaintext highlighter-rouge">best::row&lt;int&amp;&gt;</code> has natural rebinding, rather than assign-through, semantics.</p> <p>Accessing elements is done with <code class="language-plaintext highlighter-rouge">at()</code>: <code class="language-plaintext highlighter-rouge">my_row.at&lt;0&gt;()</code> returns a reference to the first element. Getting the first element is so common that you can also use <code class="language-plaintext highlighter-rouge">my_row.first()</code>. Using <code class="language-plaintext highlighter-rouge">my_row.object&lt;0&gt;()</code> will return a reference to a <code class="language-plaintext highlighter-rouge">best::object</code> instead, which can be used for rebinding references. For example:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">best</span><span class="o">::</span><span class="n">row</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&amp;&gt;</span> <span class="n">a</span><span class="p">{</span><span class="n">x</span><span class="p">};</span>
<span class="n">a</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>     <span class="c1">// Writes to x.</span>
<span class="n">a</span><span class="p">.</span><span class="n">object</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>  <span class="c1">// Rebinds a.0 to y.</span>
<span class="n">a</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>    <span class="c1">// Writes to y.</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>There is also <code class="language-plaintext highlighter-rouge">second()</code> and <code class="language-plaintext highlighter-rouge">last()</code>, for the other two most common elements to access.</p> <p><code class="language-plaintext highlighter-rouge">best::row</code> is named so in reference to database rows: it provides many operations for slicing and dicing that <code class="language-plaintext highlighter-rouge">std::tuple</code> does not.</p> <p>For example, in addition to extracting single elements, it’s also possible to access contiguous subsequences, using <code class="language-plaintext highlighter-rouge">best::bounds</code>: <code class="language-plaintext highlighter-rouge">a.at&lt;best::bounds{.start = 1, .end = 10}&gt;()</code>! There are also a plethora of mutation operations:</p> <ul> <li><code class="language-plaintext highlighter-rouge">a + b</code> concatenates tuples, copying or moving as appropriate (<code class="language-plaintext highlighter-rouge">a + BEST_MOVE(b)</code> will move out of the elements of <code class="language-plaintext highlighter-rouge">b</code>, for example).</li> <li><code class="language-plaintext highlighter-rouge">a.push(x)</code> returns a copy of <code class="language-plaintext highlighter-rouge">a</code> with <code class="language-plaintext highlighter-rouge">x</code> appended, while <code class="language-plaintext highlighter-rouge">a.insert&lt;n&gt;(x)</code> does the same at an arbitrary index.</li> <li><code class="language-plaintext highlighter-rouge">a.update&lt;n&gt;(x)</code> <em>replaces</em> the <code class="language-plaintext highlighter-rouge">n</code>th element with <code class="language-plaintext highlighter-rouge">x</code>, potentially of a different type.</li> <li><code class="language-plaintext highlighter-rouge">a.remove&lt;n&gt;()</code> deletes the <code class="language-plaintext highlighter-rouge">n</code>th element, while <code class="language-plaintext highlighter-rouge">a.erase&lt;...&gt;()</code> deletes a contiguous range.</li> <li><code class="language-plaintext highlighter-rouge">a.splice&lt;best::bounds{...}&gt;(...)</code> splices a row into another row, offering a general replace/delete operation that all of the above operations are implemented in terms of.</li> <li><code class="language-plaintext highlighter-rouge">gather()</code> and <code class="language-plaintext highlighter-rouge">scatter()</code> are even more general, allowing for non-contiguous indexing.</li> </ul> <p>Meanwhile, <code class="language-plaintext highlighter-rouge">std::apply</code> is a method now: <code class="language-plaintext highlighter-rouge">a.apply(f)</code> calls <code class="language-plaintext highlighter-rouge">f</code> with <code class="language-plaintext highlighter-rouge">a</code>’s elements as its arguments. <code class="language-plaintext highlighter-rouge">a.each(f)</code> is similar, but instead expands to <code class="language-plaintext highlighter-rouge">n</code> unary calls of <code class="language-plaintext highlighter-rouge">f</code>, one with each element.</p> <p>And <em>of course</em>, <code class="language-plaintext highlighter-rouge">best::row</code> supports structured bindings.</p> <p>Meanwhile, <code class="language-plaintext highlighter-rouge">best::choice&lt;A, B, C&gt;</code> contains precisely one value from various types. There is an underlying <code class="language-plaintext highlighter-rouge">best::pun&lt;A, B, C&gt;</code> type that implements a variadic untagged union that works around many of C++’s bugs relating to unions with members of non-trivial type.</p> <p>The most common way to operate on a choice is to <code class="language-plaintext highlighter-rouge">match</code> on it:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">choice</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="o">*</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span><span class="o">&gt;</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">z</span><span class="p">.</span><span class="n">match</span><span class="p">(</span>
  <span class="p">[](</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span><span class="p">;</span> <span class="p">},</span>
  <span class="p">[](</span><span class="kt">int</span><span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span> <span class="p">},</span>
  <span class="p">[]</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>Which case gets called here is chosen by overload resolution, allowing us to write a default case as <code class="language-plaintext highlighter-rouge">[](auto&amp;&amp;) { ... }</code>.</p> <p>Which variant is currently selected can be checked with <code class="language-plaintext highlighter-rouge">z.which()</code>, while specific variants can be accessed with <code class="language-plaintext highlighter-rouge">z.at()</code>, just like a <code class="language-plaintext highlighter-rouge">best::row</code>, except that it returns a <code class="language-plaintext highlighter-rouge">best::option&lt;T&amp;&gt;</code>.</p> <p><code class="language-plaintext highlighter-rouge">best::choice</code> is what all of the other sum types, like <code class="language-plaintext highlighter-rouge">best::option</code> and <code class="language-plaintext highlighter-rouge">best::result</code>, are built out of. All of the clever layout optimizations live here.</p> <p>Speaking of <code class="language-plaintext highlighter-rouge">best::option&lt;T&gt;</code>, that’s our option type. It’s close in spirit to what <a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code class="language-plaintext highlighter-rouge">Option&lt;T&gt;</code></a> is in Rust. <code class="language-plaintext highlighter-rouge">best</code> has a generic niche mechanism that user types can opt into, allowing <code class="language-plaintext highlighter-rouge">best::option&lt;T&amp;&gt;</code> to be the same size as a pointer, using <code class="language-plaintext highlighter-rouge">nullptr</code> for the <code class="language-plaintext highlighter-rouge">best::none</code> variant.</p> <p><code class="language-plaintext highlighter-rouge">best::option</code> provides the usual transformation operations: <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">then</code>, <code class="language-plaintext highlighter-rouge">filter</code>. Emptiness can be checked with <code class="language-plaintext highlighter-rouge">is_empty()</code> or <code class="language-plaintext highlighter-rouge">has_value()</code>. You can even pass a predicate to <code class="language-plaintext highlighter-rouge">has_value()</code> to check the value with, if it’s present: <code class="language-plaintext highlighter-rouge">x.has_value([](auto&amp; x) { return x == 42; })</code>.</p> <p>The value can be accessed using <code class="language-plaintext highlighter-rouge">operator*</code> and <code class="language-plaintext highlighter-rouge">operator-&gt;</code>, like <code class="language-plaintext highlighter-rouge">std::optional</code>; however, this operation is checked, instead of causing UB if the option is empty. <code class="language-plaintext highlighter-rouge">value_or()</code> can be used to unwrap with a default; the default can be any number of arguments, which are used to construct the default, or even a callback. For example:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">option</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span> <span class="n">x</span><span class="p">;</span>

<span class="c1">// Pass arguments to the constructor.</span>
<span class="n">do_something</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">value_or</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">foo</span><span class="p">));</span>

<span class="c1">// Execute arbitrary logic if the value is missing.</span>
<span class="n">do_something</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">value_or</span><span class="p">([]</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Foo</span><span class="p">(...);</span>
<span class="p">}))</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">best::option&lt;void&gt;</code> also Just Works (in fact, <code class="language-plaintext highlighter-rouge">best::option&lt;T&gt;</code> is a <code class="language-plaintext highlighter-rouge">best::choice&lt;void, T&gt;</code> internally), allowing for truly generic manipulation of optional results.</p> <p><code class="language-plaintext highlighter-rouge">best::result&lt;T, E&gt;</code> is, unsurprisingly, the analogue of Rust’s <a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code class="language-plaintext highlighter-rouge">Result&lt;T, E&gt;</code></a>. Because it’s a <code class="language-plaintext highlighter-rouge">best::choice</code> internally, <code class="language-plaintext highlighter-rouge">best::result&lt;void, E&gt;</code> works as you might expect, and is a common return value for I/O operations.</p> <p>It’s very similar to <code class="language-plaintext highlighter-rouge">best::option</code>, including offering <code class="language-plaintext highlighter-rouge">operator-&gt;</code> for accessing the “ok” variant. This enables succinct idioms:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fallible</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">r</span><span class="o">-&gt;</span><span class="n">do_something</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">best</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">err</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">r.ok()</code> and <code class="language-plaintext highlighter-rouge">r.err()</code> return <code class="language-plaintext highlighter-rouge">best::option</code>s containing references to the ok and error variants, depending on which is actually present; meanwhile, a <code class="language-plaintext highlighter-rouge">best::option</code> can be converted into a <code class="language-plaintext highlighter-rouge">best::result</code> using <code class="language-plaintext highlighter-rouge">ok_or()</code> or <code class="language-plaintext highlighter-rouge">err_or()</code>, just like in Rust.</p> <p><code class="language-plaintext highlighter-rouge">best::result</code>s are constructed using <code class="language-plaintext highlighter-rouge">best::ok</code> and <code class="language-plaintext highlighter-rouge">best::err</code>. For example:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">result</span><span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">best</span><span class="o">::</span><span class="n">ok</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">foo</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>These internally use <code class="language-plaintext highlighter-rouge">best::args</code>, a wrapper over <code class="language-plaintext highlighter-rouge">best::row</code> that represents a “delayed initialization” that can be stored in a value. It will implicitly convert into any type that can be constructed from its elements. For example:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">best</span><span class="o">::</span><span class="n">args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">foo</span><span class="p">);</span>  <span class="c1">// Calls Foo::Foo(args, to, foo).</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>Also, every one of the above types is a structural type, meaning it can be used for non-type template parameters!</p> <h3 id="memory-and-pointers"><a href="#memory-and-pointers">Memory and Pointers</a></h3> <p>Of course, all of these ADTs need to be built on top of pointer operations, which is where <code class="language-plaintext highlighter-rouge">//best/memory</code> comes in. <code class="language-plaintext highlighter-rouge">best::ptr&lt;T&gt;</code> is a generalized pointer type that provides many of the same operations as Rust’s raw pointers, including offsetting, copying, and indexing. Like Rust pointers, <code class="language-plaintext highlighter-rouge">best::ptr&lt;T&gt;</code> can be a fat pointer, i.e., it can carry additional metadata on top of the pointer. For example, <code class="language-plaintext highlighter-rouge">best::ptr&lt;int[]&gt;</code> remembers the size of the array.</p> <p>Providing metadata for a <code class="language-plaintext highlighter-rouge">best::ptr</code> is done through a member alias called <code class="language-plaintext highlighter-rouge">BestPtrMetadata</code>. This alias should be private, which <code class="language-plaintext highlighter-rouge">best</code> is given access to by befriending <code class="language-plaintext highlighter-rouge">best::access</code>. Types with custom metadata will usually not be directly constructible (because they are of variable size), and must be manipulated exclusively through types like <code class="language-plaintext highlighter-rouge">best::ptr</code>.</p> <p>Specifying custom metadata allows specifying what the pointer dereferences to. For example, <code class="language-plaintext highlighter-rouge">best::ptr&lt;int[]&gt;</code> dereferences to a <code class="language-plaintext highlighter-rouge">best::span&lt;int&gt;</code>, meaning that all the span operations are accessible through <code class="language-plaintext highlighter-rouge">operator-&gt;</code>: for example, <code class="language-plaintext highlighter-rouge">my_array_ptr-&gt;first()</code>.</p> <p>Most of this may seem a bit over-complicated, since ordinary C++ raw pointers and references are fine for most uses. However, <code class="language-plaintext highlighter-rouge">best::ptr</code> is the foundation upon which <code class="language-plaintext highlighter-rouge">best::box&lt;T&gt;</code> is built on. <code class="language-plaintext highlighter-rouge">best::box&lt;T&gt;</code> is a replacement for <a href="https://en.cppreference.com/w/cpp/memory/unique_ptr.html"><code class="language-plaintext highlighter-rouge">std::unique_ptr&lt;T&gt;</code></a> that fixes its const correctness and adds Rust <a href="https://doc.rust-lang.org/std/boxed/struct.Box.html"><code class="language-plaintext highlighter-rouge">Box</code></a>-like helpers. <code class="language-plaintext highlighter-rouge">best::box&lt;T[]&gt;</code> also works, but unlike <code class="language-plaintext highlighter-rouge">std::unique_ptr&lt;T[]&gt;</code>, it remembers its size, just like <code class="language-plaintext highlighter-rouge">best::ptr&lt;T[]&gt;</code>.</p> <p><code class="language-plaintext highlighter-rouge">best::box</code> is parameterized by its allocator, which must satisfy <code class="language-plaintext highlighter-rouge">best::allocator</code>, a much less insane API than what <a href="https://en.cppreference.com/w/cpp/memory/allocator.html"><code class="language-plaintext highlighter-rouge">std::allocator</code></a> offers. <code class="language-plaintext highlighter-rouge">best::malloc</code> is a singleton allocator representing the system allocator.</p> <p><code class="language-plaintext highlighter-rouge">best::span&lt;T&gt;</code>, mentioned before, is the contiguous memory abstraction, replacing <a href="https://en.cppreference.com/w/cpp/container/span.html"><code class="language-plaintext highlighter-rouge">std::span</code></a>. Like <code class="language-plaintext highlighter-rouge">std::span</code>, <code class="language-plaintext highlighter-rouge">best::span&lt;T, n&gt;</code> is a fixed-length span of <code class="language-plaintext highlighter-rouge">n</code> elements. Unlike <code class="language-plaintext highlighter-rouge">std::span</code>, the second parameter is a <code class="language-plaintext highlighter-rouge">best::option&lt;size_t&gt;</code>, not a <code class="language-plaintext highlighter-rouge">size_t</code> that uses <code class="language-plaintext highlighter-rouge">-1</code> as a sentinel.</p> <p><code class="language-plaintext highlighter-rouge">best::span&lt;T&gt;</code> tries to approximate the API of <a href="https://doc.rust-lang.org/std/primitive.slice.html">Rust slices</a>, providing indexing, slicing, splicing, search, sort, and more. Naturally, it’s also iterable, both forwards and backwards, and provides splitting iterators, just like Rust.</p> <p>Slicing and indexing is always bounds-checked. Indexing can be done with <code class="language-plaintext highlighter-rouge">size_t</code> values, while slicing uses a <code class="language-plaintext highlighter-rouge">best::bounds</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">xs</span> <span class="o">=</span> <span class="p">...;</span>
<span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="k">auto</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[{.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mi">6</span><span class="p">}];</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">best::bounds</code> is a generic mechanism for specifying slicing bounds, similar to Rust’s <a href="https://doc.rust-lang.org/std/ops/struct.Range.html">range types</a>. You can specify the start and end (exclusive), like <code class="language-plaintext highlighter-rouge">x..y</code> in Rust. You can also specify an inclusive end using <code class="language-plaintext highlighter-rouge">.inclusive_end = 5</code>, equivalent to Rust’s <code class="language-plaintext highlighter-rouge">x..=y</code>. And you can specify a count, like C++’s slicing operations prefer: <code class="language-plaintext highlighter-rouge">{.start = 1, .count = 5}</code>. <code class="language-plaintext highlighter-rouge">best::bounds</code> itself provides all of the necessary helpers for performing bounds checks and crashing with a nice error message. <code class="language-plaintext highlighter-rouge">best::bounds</code> is also iterable, as we’ll see shortly.</p> <p><code class="language-plaintext highlighter-rouge">best::layout</code> is a copy of Rust’s <a href="https://doc.rust-lang.org/std/alloc/struct.Layout.html"><code class="language-plaintext highlighter-rouge">Layout</code></a> type, providing similar helpers for performing C++-specific size and address calculations.</p> <h3 id="iterators"><a href="#iterators">Iterators</a></h3> <p>C++ iterator pairs suck. C++ ranges suck. <code class="language-plaintext highlighter-rouge">best</code> provides a new paradigm for iteration that is essentially just Rust <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html"><code class="language-plaintext highlighter-rouge">Iterator</code>s</a> hammered into a C++ shape. This library lives in <code class="language-plaintext highlighter-rouge">//best/iter</code>.</p> <p>To define an iterator, you define an <em>iterator implementation type</em>, which must define a member function named <code class="language-plaintext highlighter-rouge">next()</code> that returns a <code class="language-plaintext highlighter-rouge">best::option</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">my_iter_impl</span> <span class="k">final</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">best</span><span class="o">::</span><span class="n">option</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">();</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>This type is an implementation detail; the actual iterator type is <code class="language-plaintext highlighter-rouge">best::iter&lt;my_iter_impl&gt;</code>. <code class="language-plaintext highlighter-rouge">best::iter</code> provides all kinds of helpers, just like <code class="language-plaintext highlighter-rouge">Iterator</code>, for adapting the iterator or consuming items out of it.</p> <p>Iterators can override the behavior of some of these adaptors to be more efficient, such as for making <code class="language-plaintext highlighter-rouge">count()</code> constant-time rather than linear. Iterators can also offer extra methods if they define the member alias <code class="language-plaintext highlighter-rouge">BestIterArrow</code>; for example, the iterators for <code class="language-plaintext highlighter-rouge">best::span</code> have a <code class="language-plaintext highlighter-rouge">-&gt;rest()</code> method for returning the part of the slice that has not been yielded by <code class="language-plaintext highlighter-rouge">next()</code> yet.</p> <p>One of the most important extension points is <code class="language-plaintext highlighter-rouge">size_hint()</code>, analogous to <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.size_hint"><code class="language-plaintext highlighter-rouge">Iterator::size_hint()</code></a>, for right-sizing containers that the iterator is converted to, such as a <code class="language-plaintext highlighter-rouge">best::vec</code>.</p> <p>And of course, <code class="language-plaintext highlighter-rouge">best::iter</code> provides <code class="language-plaintext highlighter-rouge">begin/end</code> so that it can be used in a C++ range-for loop, just like C++20 ranges do. <code class="language-plaintext highlighter-rouge">best::int_range&lt;I&gt;</code><sup id="fnref:interval" role="doc-noteref"><a href="#fn:interval" class="footnote" rel="footnote">4</a></sup>, which <code class="language-plaintext highlighter-rouge">best::bounds</code> is an instantiation of, is also an iterator, and can be used much like Rust ranges would:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">i</span> <span class="o">:</span> <span class="n">best</span><span class="o">::</span><span class="n">int_range</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">{.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">200</span><span class="p">})</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">best::int_range</code> will carefully handle all of the awkward corner cases around overflow, such as <code class="language-plaintext highlighter-rouge">best::int_range&lt;uint8_t&gt;{.end_inclusive = 255}</code>.</p> <h3 id="heap-containers"><a href="#heap-containers">Heap Containers</a></h3> <p>Iterators brings us to the most complex container type that’s checked in right now, <code class="language-plaintext highlighter-rouge">best::vec</code>. Not only can you customize its allocator type, but you can customize its small vector optimization type.</p> <p>In <code class="language-plaintext highlighter-rouge">libc++</code>, <code class="language-plaintext highlighter-rouge">std::string</code>s of at most 23 bytes are stored <em>inline</em>, meaning that the strings’s own storage, rather than heap storage, is used to hold them. <code class="language-plaintext highlighter-rouge">best::vec</code> generalizes this, by allowing any trivially copyable type to be inlined. Thus, a <code class="language-plaintext highlighter-rouge">best::vec&lt;int&gt;</code> will hold at most five <code class="language-plaintext highlighter-rouge">int</code>s inline, on 64-bit targets.</p> <p><code class="language-plaintext highlighter-rouge">best::vec</code> mostly copies the APIs of <code class="language-plaintext highlighter-rouge">std::vector</code> and Rust’s <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code class="language-plaintext highlighter-rouge">Vec</code></a>. Indexing and slicing works the same as with <code class="language-plaintext highlighter-rouge">best::span</code>, and all of the <code class="language-plaintext highlighter-rouge">best::span</code> operations can be accessed through <code class="language-plaintext highlighter-rouge">-&gt;</code>, allowing for things like <code class="language-plaintext highlighter-rouge">my_vec-&gt;sort(...)</code>.</p> <p>I have an active (failing) PR which adds <code class="language-plaintext highlighter-rouge">best::table&lt;K, V&gt;</code>, a general hash table implementation that can be used as either a map or a set. Internally it’s backed by a Swisstable<sup id="fnref:swisstable" role="doc-noteref"><a href="#fn:swisstable" class="footnote" rel="footnote">5</a></sup> implementation. Its API resembles neither <code class="language-plaintext highlighter-rouge">std::unordered_map</code>, <code class="language-plaintext highlighter-rouge">absl::flat_hash_map</code>, or Rust’s <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code class="language-plaintext highlighter-rouge">HashMap</code></a>. Instead, everything is done through a general entry API, similar to that of Rust, but optimized for clarity and minimizing hash lookups. I want to get it merged soonish.</p> <p>Beyond <code class="language-plaintext highlighter-rouge">best::table</code>, I plan to add <em>at least</em> the following containers:</p> <ul> <li><code class="language-plaintext highlighter-rouge">best::tree</code>, a btree map/set with a similar API.</li> <li><code class="language-plaintext highlighter-rouge">best::heap</code>, a simple min-heap implementation.</li> <li><code class="language-plaintext highlighter-rouge">best::lru</code>, a <code class="language-plaintext highlighter-rouge">best::table</code> with a linked list running through it for in-order iteration and oldest-member eviction.</li> <li><code class="language-plaintext highlighter-rouge">best::ring</code>, a ring buffer like <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code class="language-plaintext highlighter-rouge">VecDeque</code></a>.</li> <li><code class="language-plaintext highlighter-rouge">best::trie</code>, a port of my <a href="https://docs.rs/twie/latest/twie/"><code class="language-plaintext highlighter-rouge">twie</code> crate</a>.</li> </ul> <p>Possible other ideas: <a href="https://research.swtch.com/sparse">Russ’s sparse array</a>, splay trees, something like Java’s <a href="https://docs.oracle.com/javase/8/docs/api/java/util/EnumMap.html"><code class="language-plaintext highlighter-rouge">EnumMap</code></a>, bitset types, and so on.</p> <h3 id="text-handling"><a href="#text-handling">Text Handling</a></h3> <p><code class="language-plaintext highlighter-rouge">best</code>’s string handling is intended to resemble Rust’s as much as possible; it lives within <code class="language-plaintext highlighter-rouge">//best/text</code>. <code class="language-plaintext highlighter-rouge">best::rune</code> is the Unicode scalar type, which is such that it is <em>always</em> within the valid range for a Unicode scalar, but including the unpaired surrogates. It offers a number of relatively simple character operations, but I plan to extend it to all kinds of character classes in the future.</p> <p><code class="language-plaintext highlighter-rouge">best::str</code> is our replacement for <a href="https://en.cppreference.com/w/cpp/string/basic_string_view.html"><code class="language-plaintext highlighter-rouge">best::string_view</code></a>, close to Rust’s <a href="https://doc.rust-lang.org/std/primitive.str.html"><code class="language-plaintext highlighter-rouge">str</code></a>: a sequence of valid UTF-8 bytes, with all kinds of string manipulation operations, such as rune search, splitting, indexing, and so on.</p> <p><code class="language-plaintext highlighter-rouge">best::rune</code> and <code class="language-plaintext highlighter-rouge">best::str</code> use compiler extensions to ensure that when constructed from literals, they’re constructed from <em>valid</em> literals. This means that the following won’t compile!</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">str</span> <span class="n">invalid</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xFF</span><span class="s">"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">best::str</code> is a <code class="language-plaintext highlighter-rouge">best::span</code> under the hood, which can be accessed and manipulated the same way as the underlying <code class="language-plaintext highlighter-rouge">&amp;[u8]</code> to <code class="language-plaintext highlighter-rouge">&amp;str</code> is.</p> <p><code class="language-plaintext highlighter-rouge">best::strbuf</code> is our <a href="https://en.cppreference.com/w/cpp/string/basic_string.html"><code class="language-plaintext highlighter-rouge">std::string</code></a> equivalent. There isn’t very much to say about it, because it works just like you’d expect, and provides a Rust <a href="https://doc.rust-lang.org/std/string/struct.String.html"><code class="language-plaintext highlighter-rouge">String</code></a>-like API.</p> <p>Where this library really shines is that everything is parametrized over encodings. <code class="language-plaintext highlighter-rouge">best::str</code> is actually a <code class="language-plaintext highlighter-rouge">best::text&lt;best::utf8&gt;</code>; <code class="language-plaintext highlighter-rouge">best::str16</code> is then <code class="language-plaintext highlighter-rouge">best::text&lt;best::utf16&gt;</code>. You can write your own text encodings, too, so long as they are relatively tame and you provide rune encode/decode for them. <code class="language-plaintext highlighter-rouge">best::encoding</code> is the concept</p> <p><code class="language-plaintext highlighter-rouge">best::text</code> is always validly encoded; however, sometimes, that’s not possible. For this reason we have <code class="language-plaintext highlighter-rouge">best::pretext</code>, which is “presumed validly encoded”; its operations can fail or produce replacement characters if invalid code units are found. There is no <code class="language-plaintext highlighter-rouge">best::pretextbuf</code>; instead, you would generally use something like a <code class="language-plaintext highlighter-rouge">best::vec&lt;uint8_t&gt;</code> instead.</p> <p>Unlike C++, the fact that a <code class="language-plaintext highlighter-rouge">best::textbuf</code> is a <code class="language-plaintext highlighter-rouge">best::vec</code> under the hood is part of the public interface, allowing for cheap conversions and, of course, we get <code class="language-plaintext highlighter-rouge">best::vec</code>’s small vector optimization for free.</p> <p><code class="language-plaintext highlighter-rouge">best</code> provides the following encodings out of the box: <code class="language-plaintext highlighter-rouge">best::utf8</code>, <code class="language-plaintext highlighter-rouge">best::utf16</code>, <code class="language-plaintext highlighter-rouge">best::utf32</code>, <code class="language-plaintext highlighter-rouge">best::wtf8</code>, <code class="language-plaintext highlighter-rouge">best::ascii</code>, and <code class="language-plaintext highlighter-rouge">best::latin1</code>.</p> <h3 id="formatting"><a href="#formatting">Formatting</a></h3> <p><code class="language-plaintext highlighter-rouge">//best/text:format</code> provides a Rust <code class="language-plaintext highlighter-rouge">format!()</code>-style text formatting library. It’s as easy as:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span> <span class="n">str</span> <span class="o">=</span> <span class="n">best</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">"my number: 0x{:08x}"</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>Through the power of compiler extensions and <code class="language-plaintext highlighter-rouge">constexpr</code>, the format is actually checked at compile time!</p> <p>The available formats are the same as Rust’s, including the <code class="language-plaintext highlighter-rouge">{}</code> vs <code class="language-plaintext highlighter-rouge">{:?}</code> distinction. But it’s actually way more flexible. You can use any ASCII letter, and types can provide multiple custom formatting schemes using letters. By convention, <code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">X</code>, <code class="language-plaintext highlighter-rouge">b</code>, and <code class="language-plaintext highlighter-rouge">o</code> all mean numeric bases. <code class="language-plaintext highlighter-rouge">q</code> will quote strings, runes, and other text objects; <code class="language-plaintext highlighter-rouge">p</code> will print pointer addresses.</p> <p>The special format <code class="language-plaintext highlighter-rouge">{:!}</code> “forwards from above”; when used in a formatting implementation, it uses the format specifier the caller used. This is useful for causing formats to be “passed through”, such as when printing lists or <code class="language-plaintext highlighter-rouge">best::option</code>.</p> <p>Any type can be made formattable by providing a friend template ADL extension (FTADLE) called <code class="language-plaintext highlighter-rouge">BestFmt</code>. This is analogous to implementing a trait like <code class="language-plaintext highlighter-rouge">fmt::Debug</code> in Rust, however, all formatting operations use the same function; this is similar to <a href="https://pkg.go.dev/fmt#Formatter"><code class="language-plaintext highlighter-rouge">fmt.Formatter</code></a> in Go.</p> <p>The <code class="language-plaintext highlighter-rouge">best::formatter</code> type, which gets passed into <code class="language-plaintext highlighter-rouge">BestFmt</code>, is similar to Rust’s <a href="https://doc.rust-lang.org/std/fmt/struct.Formatter.html"><code class="language-plaintext highlighter-rouge">Formatter</code></a>. Beyond being a sink, it also exposes information on the specifier for the formatting operation via <code class="language-plaintext highlighter-rouge">current_spec()</code>, and helpers for printing indented lists and blocks.</p> <p><code class="language-plaintext highlighter-rouge">BestFmtQuery</code> is a related FTADLE that is called to determine what the valid format specifiers for this type are. This allows the format validator to reject formats that a type does not support, such as formatting a <code class="language-plaintext highlighter-rouge">best::str</code> with <code class="language-plaintext highlighter-rouge">{:x}</code>.</p> <p><code class="language-plaintext highlighter-rouge">best::format</code> returns (or appends to) a <code class="language-plaintext highlighter-rouge">best::strbuf</code>; <code class="language-plaintext highlighter-rouge">best::println</code> and <code class="language-plaintext highlighter-rouge">best::eprintln</code> can be used to write to stdout and stderr.</p> <h3 id="reflection"><a href="#reflection">Reflection</a></h3> <p>Within the metaprogramming library, <code class="language-plaintext highlighter-rouge">//best/meta:reflect</code> offers a basic form of reflection. It’s not C++26 reflection, because that’s wholely overkill. Instead, it provides a method for introspecting the members of structs and enums.</p> <p>For example, suppose that we want to have a default way of formatting arbitrary <a href="https://en.cppreference.com/w/cpp/language/aggregate_initialization.html">aggregate</a> structs. The code for doing this is actually devilishly simple:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">BestFmt</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">fmt</span><span class="p">,</span> <span class="k">const</span> <span class="n">best</span><span class="o">::</span><span class="n">is_reflected_struct</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Reflect the type of the struct.</span>
  <span class="k">auto</span> <span class="n">refl</span> <span class="o">=</span> <span class="n">best</span><span class="o">::</span><span class="n">reflect</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="c1">// Start formatting a "record" (key-value pairs).</span>
  <span class="k">auto</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">.</span><span class="n">record</span><span class="p">(</span><span class="n">refl</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>

  <span class="c1">// For each field in the struct...</span>
  <span class="n">refl</span><span class="p">.</span><span class="n">each</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span> <span class="n">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add a field to the formatting record...</span>
    <span class="n">rec</span><span class="p">.</span><span class="n">field</span><span class="p">(</span>
      <span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span>   <span class="c1">// ...whose name is the field...</span>
      <span class="n">value</span><span class="o">-&gt;*</span><span class="n">field</span><span class="p">,</span>  <span class="c1">// ...and with the appropriate value.</span>
    <span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">best::reflect</code> provides access to the fields (or enum variants) of a user-defined type that opts itself in by providing the <code class="language-plaintext highlighter-rouge">BestReflect</code> FTADLE, which tells the reflection framework what the fields are. The simplest version of this FTADLE looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">friend</span> <span class="k">constexpr</span> <span class="k">auto</span> <span class="nf">BestReflect</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">MyStruct</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">mirror</span><span class="p">.</span><span class="n">infer</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">best::mirror</code> is essentially a “reflection builder” that offers fine-grained control over what reflection actually shows of a struct. This allows for hiding fields, or attaching <em>tags</em> to specific fields, which generic functions can then introspect using <code class="language-plaintext highlighter-rouge">best::reflected_field::tags()</code>.</p> <p>The functions on <code class="language-plaintext highlighter-rouge">best::reflected_type</code> allow iterating over and searching for specific fields (or enum variants); these <code class="language-plaintext highlighter-rouge">best::reflected_field</code>s provide metadata about a field (such as its name) and allow accessing it, with the same syntax as a pointer-to-member: <code class="language-plaintext highlighter-rouge">value-&gt;*field</code>.</p> <p>Explaining the full breadth (and implementation tricks) of <code class="language-plaintext highlighter-rouge">best::reflect</code> would be a post of its own, so I’ll leave it at that.</p> <h3 id="unit-tests-and-apps"><a href="#unit-tests-and-apps">Unit Tests and Apps</a></h3> <p><code class="language-plaintext highlighter-rouge">best</code> provides a unit testing framework under <code class="language-plaintext highlighter-rouge">//best/test</code>, like any good standard library should. To define a test, you define a special kind of global variable:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">test</span> <span class="n">MyTest</span> <span class="o">=</span> <span class="p">[](</span><span class="n">best</span><span class="o">::</span><span class="n">test</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Test code.</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>This is very similar to a Go unit test, which defines a function that starts with <code class="language-plaintext highlighter-rouge">Test</code> and takes a <code class="language-plaintext highlighter-rouge">*testing.T</code> as its argument. The <code class="language-plaintext highlighter-rouge">best::test&amp;</code> value offers test assertions and test failures. Through the power of looking at debuginfo, we can extract the name <code class="language-plaintext highlighter-rouge">MyTest</code> from the binary, and use that as the name of the test directly.</p> <p>That’s right, this is a C++ test framework with <em>no macros at all</em>!</p> <p>Meanwhile, at <code class="language-plaintext highlighter-rouge">//best/cli</code> we can find a robust CLI parsing library, in the spirit of <a href="https://docs.rs/clap/latest/clap/_derive/index.html"><code class="language-plaintext highlighter-rouge">#[derive(clap::Parser)]</code></a> and other similar Rust libraries. The way it works is you first define a reflectable struct, whose fields correspond to CLI flags. A very basic example of this can be found in <code class="language-plaintext highlighter-rouge">test.h</code>, since test binaries define their own flags:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">test</span><span class="o">::</span><span class="n">flags</span> <span class="k">final</span> <span class="p">{</span>
  <span class="n">best</span><span class="o">::</span><span class="n">vec</span><span class="o">&lt;</span><span class="n">best</span><span class="o">::</span><span class="n">strbuf</span><span class="o">&gt;</span> <span class="n">skip</span><span class="p">;</span>
  <span class="n">best</span><span class="o">::</span><span class="n">vec</span><span class="o">&lt;</span><span class="n">best</span><span class="o">::</span><span class="n">strbuf</span><span class="o">&gt;</span> <span class="n">filters</span><span class="p">;</span>

  <span class="k">constexpr</span> <span class="k">friend</span> <span class="k">auto</span> <span class="n">BestReflect</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">,</span> <span class="n">flags</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">.</span><span class="n">infer</span><span class="p">()</span>
      <span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">best</span><span class="o">::</span><span class="n">cli</span><span class="o">::</span><span class="n">app</span><span class="p">{.</span><span class="n">about</span> <span class="o">=</span> <span class="s">"a best unit test binary"</span><span class="p">})</span>
      <span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flags</span><span class="o">::</span><span class="n">skip</span><span class="p">,</span>
            <span class="n">best</span><span class="o">::</span><span class="n">cli</span><span class="o">::</span><span class="n">flag</span><span class="p">{</span>
              <span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="s">"FILTER"</span><span class="p">,</span>
              <span class="p">.</span><span class="n">help</span> <span class="o">=</span> <span class="s">"Skip tests whose names contain FILTER"</span><span class="p">,</span>
            <span class="p">})</span>
      <span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flags</span><span class="o">::</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">best</span><span class="o">::</span><span class="n">cli</span><span class="o">::</span><span class="n">positional</span><span class="p">{</span>
              <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"FILTERS"</span><span class="p">,</span>
              <span class="p">.</span><span class="n">help</span> <span class="o">=</span> <span class="s">"Include only tests whose names contain FILTER"</span><span class="p">,</span>
            <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>Using <code class="language-plaintext highlighter-rouge">best::mirror::with</code>, we can apply tags to the individual fields that describe how they should be parsed and displayed as CLI flags. A more complicated, full-featured example can be found at <a href="https://github.com/mcy/best/blob/main/best/cli/toy_flags.h"><code class="language-plaintext highlighter-rouge">toy_flags.h</code></a>, which exercises most of the CLI parser’s features.</p> <p><code class="language-plaintext highlighter-rouge">best::parse_flags&lt;MyFlags&gt;(...)</code> can be used to parse a particular flag struct from program inputs, independent of the actual <code class="language-plaintext highlighter-rouge">argv</code> of the program. A <code class="language-plaintext highlighter-rouge">best::cli</code> contains the actual parser metadata, but this is not generally user-accessible; it is constructed automatically using reflection.</p> <p>Streamlining top-level app execution can be done using <code class="language-plaintext highlighter-rouge">best::app</code>, which fully replaces the <code class="language-plaintext highlighter-rouge">main()</code> function. Defining an app is very similar to defining a test:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">best</span><span class="o">::</span><span class="n">app</span> <span class="n">MyApp</span> <span class="o">=</span> <span class="p">[](</span><span class="n">MyFlags</span><span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do something cool!</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>This will automatically record the program inputs, run the flag parser for <code class="language-plaintext highlighter-rouge">MyFlags</code> (printing <code class="language-plaintext highlighter-rouge">--help</code> and existing, when requested), and then call the body of the lambda.</p> <p>The lambda can either return <code class="language-plaintext highlighter-rouge">void</code>, an <code class="language-plaintext highlighter-rouge">int</code> (as an exit code) or even a <code class="language-plaintext highlighter-rouge">best::result</code>, like Rust. <code class="language-plaintext highlighter-rouge">best::app</code> is also where the <code class="language-plaintext highlighter-rouge">argv</code> of the program can be requested by other parts of the program.</p> <h2 id="whats-next"><a href="#whats-next">What’s Next?</a></h2> <p>There’s still a lot of stuff I want to add to <code class="language-plaintext highlighter-rouge">best</code>. There’s no synchronization primitives, neither atomics nor locks or channels. There’s no I/O; I have a work-in-progress PR to add <code class="language-plaintext highlighter-rouge">best::path</code> and <code class="language-plaintext highlighter-rouge">best::file</code>. I’d like to write my own math library, <code class="language-plaintext highlighter-rouge">best::rc</code> (reference-counting), and portable SIMD. There’s also some other OS APIs I want to build, such as signals and subprocesses. I want to add a robust PRNG, time APIs, networking, and stack symbolization.</p> <p>Building the best C++ library is a lot of work, not the least because C++ is a very tricky language and writing exhaustive tests is tedious. But it manages to make C++ fun for me again!</p> <p>I would love to see contributions some day. I don’t expect anyone to actually use this, but to me, it proves C++ could be so much better.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:terrible-people" role="doc-endnote"> <p>They are also <a href="https://patricia.no/2022/03/08/cppcon.html">terrible people</a>. <a href="#fnref:terrible-people" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:jh" role="doc-endnote"> <p>I will grant that JeanHeyd has made significant process where many people believed was impossible. He appears to have the indomitable willpower of a shōnen protagonist. <a href="#fnref:jh" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:abcl" role="doc-endnote"> <p>I have heard an apocryphal story that the namespace was going to be <code class="language-plaintext highlighter-rouge">abc</code> or <code class="language-plaintext highlighter-rouge">abcl</code>, because it was “Alphabet’s library”. This name was ultimately shot down by the office of the CEO, or so the legend goes. <a href="#fnref:abcl" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:interval" role="doc-endnote"> <p>This may get renamed to <code class="language-plaintext highlighter-rouge">best::interval</code> or even <code class="language-plaintext highlighter-rouge">best::range</code> We’ll see! <a href="#fnref:interval" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:swisstable" role="doc-endnote"> <p>The fourth time I’ve written one in my career, lmao. I also wrote a <a href="https://github.com/google/cwisstable">C implementation</a> at one point. My friend Matt has an <a href="https://www.youtube.com/watch?v=ncHmEUmJZf4">excellent introduction</a> to the Swisstable data structure. <a href="#fnref:swisstable" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-07-16</span> / <h6 style="display:inline"><a href="/2025/07/16/hyperpb/">Parsing Protobuf Like Never Before</a></h6> <li> <span class="post-meta">2025-07-07</span> / <h6 style="display:inline"><a href="/2025/07/07/nosplit/">What's //go:nosplit for?</a></h6> <li> <span class="post-meta">2025-06-03</span> / <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/">Protobuf Tip #7: Scoping It Out</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-07-14</span> <span class="censored">•</span> <span class="censored">4003</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">44</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#c++"><span class="censored">#c++</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#language-design"><span class="censored">#language-design</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#metaprogramming"><span class="censored">#metaprogramming</span></a> </span> <h1><a href="/2025/07/14/best/"> <span class="censored">The</span> <span class="censored">Best</span> <span class="censored">C++</span> <span class="censored">Library</span> </a></h1> </div> <div class="post"> <p><span class="censored">It’s</span> <span class="censored">no</span> <span class="censored">secret</span> <span class="censored">that</span> <span class="censored">my</span> <span class="censored">taste</span> <span class="censored">in</span> <span class="censored">programming</span> <span class="censored">languages</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">weird</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">programming</span> <span class="censored">language</span> <del><span class="censored">enthusiast</span></del> <span class="censored">professional.</span> <span class="censored">Several</span> <span class="censored">of</span> <span class="censored">my</span> <a href="https://mcyoung.xyz/2025/07/07/nosplit/"><span class="censored">last</span></a> <a href="https://mcyoung.xyz/2025/04/21/go-arenas/"><span class="censored">few</span></a> <a href="https://mcyoung.xyz/2024/12/16/rangefuncs/"><span class="censored">posts</span></a> <span class="censored">are</span> <span class="censored">about</span> <span class="censored">Go,</span> <span class="censored">broadly</span> <span class="censored">regarded</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">programming</span> <span class="censored">language</span> <span class="censored">equivalent</span> <span class="censored">of</span> <span class="censored">eating</span> <span class="censored">plain</span> <span class="censored">oatmeal</span> <span class="censored">for</span> <span class="censored">breakfast.</span></p> <p><span class="censored">To</span> <span class="censored">make</span> <span class="censored">up</span> <span class="censored">for</span> <span class="censored">that,</span> <span class="censored">I’m</span> <span class="censored">going</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">about</span> <span class="censored">the</span> <span class="censored">programming</span> <span class="censored">language</span> <span class="censored">equivalent</span> <span class="censored">of</span> <span class="censored">diluting</span> <span class="censored">your</span> <span class="censored">morning</span> <span class="censored">coffee</span> <span class="censored">with</span> <a href="https://en.wikipedia.org/wiki/Everclear"><span class="censored">Everclear</span></a><span class="censored">.</span> <span class="censored">I</span> <span class="censored">am,</span> <span class="censored">of</span> <span class="censored">course,</span> <span class="censored">talking</span> <span class="censored">about</span> <span class="censored">C++.</span></p> <p><span class="censored">If</span> <span class="censored">you’ve</span> <span class="censored">ever</span> <span class="censored">had</span> <span class="censored">the</span> <span class="censored">misfortune</span> <span class="censored">of</span> <span class="censored">doing</span> <span class="censored">C++</span> <span class="censored">professionally,</span> <span class="censored">you’ll</span> <span class="censored">know</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">C++</span> <span class="censored">standard</span> <span class="censored">library</span> <span class="censored">is</span> <span class="censored">really</span> <span class="censored">bad.</span> <span class="censored">Where</span> <span class="censored">to</span> <span class="censored">begin?</span></p> <p><span class="censored">Well,</span> <span class="censored">the</span> <span class="censored">associative</span> <span class="censored">containers</span> <span class="censored">are</span> <span class="censored">terrible.</span> <span class="censored">Due</span> <span class="censored">to</span> <span class="censored">bone-headed</span> <span class="censored">API</span> <span class="censored">decisions,</span> <a href="https://en.cppreference.com/w/cpp/container/unordered_map.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::unordered_map</span></code></a> <span class="censored">MUST</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">closed-addressing,</span> <span class="censored">array-of-linked-lists</span> <span class="censored">map,</span> <span class="censored">not</span> <span class="censored">a</span> <span class="censored">Swisstable,</span> <span class="censored">despite</span> <span class="censored">closed-addressing</span> <span class="censored">being</span> <span class="censored">an</span> <span class="censored">outdated</span> <span class="censored">technology.</span> <a href="https://www.cppreference.com/w/cpp/container/map.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::map</span></code></a><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">what</span> <span class="censored">you</span> <span class="censored">usually</span> <span class="censored">want,</span> <em><span class="censored">must</span></em> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">red-black</span> <span class="censored">tree.</span> <span class="censored">It</span> <span class="censored">can’t</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">b-tree,</span> <span class="censored">like</span> <span class="censored">every</span> <span class="censored">sensible</span> <span class="censored">language</span> <span class="censored">provides</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">ordered</span> <span class="censored">map.</span></p> <p><a href="https://en.cppreference.com/w/cpp/utility/optional.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::optional</span></code></a> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">massive</span> <span class="censored">pain</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">ass</span> <span class="censored">to</span> <span class="censored">use,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">full</span> <span class="censored">of</span> <span class="censored">footguns,</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">operator*</span></code><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::variant</span></code> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">really</span> <span class="censored">annoying</span> <span class="censored">to</span> <span class="censored">use.</span> <a href="https://en.cppreference.com/w/cpp/filesystem.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::filesystem</span></code></a> <span class="censored">is</span> <span class="censored">full</span> <span class="censored">of</span> <span class="censored">sharp</span> <span class="censored">edges.</span> <span class="censored">And</span> <span class="censored">where</span> <span class="censored">are</span> <span class="censored">the</span> <span class="censored">APIs</span> <span class="censored">for</span> <span class="censored">signals?</span></p> <p><span class="censored">Everything</span> <span class="censored">is</span> <span class="censored">extremely</span> <span class="censored">wordy.</span> <a href="https://en.cppreference.com/w/cpp/thread/hardware_destructive_interference_size.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::hardware_destructive_interference_size</span></code></a> <span class="censored">could</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">called</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::cache_line</span></code><span class="censored">.</span> <a href="https://en.cppreference.com/w/cpp/container/span/subspan"><code class="language-plaintext highlighter-rouge"><span class="censored">std::span::subspan</span></code></a> <span class="censored">could</span> <span class="censored">have</span> <span class="censored">used</span> <code class="language-plaintext highlighter-rouge"><span class="censored">opeartor[]</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">standard</span> <span class="censored">algorithms</span> <span class="censored">are</span> <span class="censored">super</span> <span class="censored">wordy,</span> <span class="censored">because</span> <span class="censored">they</span> <span class="censored">deal</span> <span class="censored">with</span> <span class="censored">iterator</span> <span class="censored">pairs.</span> <span class="censored">Oh</span> <span class="censored">my</span> <span class="censored">god,</span> <span class="censored">iterator</span> <span class="censored">pairs.</span> <span class="censored">They</span> <span class="censored">added</span> <a href="https://en.cppreference.com/w/cpp/ranges.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::ranges</span></code></a><span class="censored">,</span> <span class="censored">which</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">measure</span> <span class="censored">up</span> <span class="censored">to</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Iterator</span></code></a> <span class="censored">at</span> <span class="censored">all!</span></p> <p><span class="censored">I’m</span> <span class="censored">so</span> <span class="censored">mad</span> <span class="censored">about</span> <span class="censored">all</span> <span class="censored">this!</span> <span class="censored">The</span> <span class="censored">people</span> <span class="censored">in</span> <span class="censored">charge</span> <span class="censored">of</span> <span class="censored">C++</span> <span class="censored">clearly,</span> <span class="censored">actively</span> <span class="censored">hate</span> <span class="censored">their</span> <span class="censored">users!</span><sup id="fnref:terrible-people" role="doc-noteref"><a href="#fn:terrible-people" class="footnote" rel="footnote"><span class="censored">1</span></a></sup> <span class="censored">They</span> <span class="censored">want</span> <span class="censored">C++</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">as</span> <span class="censored">hard</span> <span class="censored">and</span> <span class="censored">unpleasant</span> <span class="censored">as</span> <span class="censored">possible</span> <span class="censored">to</span> <span class="censored">use.</span> <span class="censored">Many</span> <span class="censored">brilliant</span> <span class="censored">people</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">am</span> <span class="censored">lucky</span> <span class="censored">to</span> <span class="censored">consider</span> <span class="censored">friends</span> <span class="censored">and</span> <span class="censored">colleagues,</span> <span class="censored">including</span> <span class="censored">Titus</span> <span class="censored">Winters,</span> <span class="censored">JeanHeyd</span> <span class="censored">Meneide,</span> <span class="censored">Matt</span> <span class="censored">Fowles-Kulukundis,</span> <span class="censored">and</span> <span class="censored">Andy</span> <span class="censored">Soffer,</span> <span class="censored">have</span> <span class="censored">tried</span> <span class="censored">and</span> <span class="censored">mostly</span> <span class="censored">failed</span><sup id="fnref:jh" role="doc-noteref"><a href="#fn:jh" class="footnote" rel="footnote"><span class="censored">2</span></a></sup> <span class="censored">to</span> <span class="censored">improve</span> <span class="censored">the</span> <span class="censored">language.</span></p> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">much</span> <span class="censored">to</span> <span class="censored">say</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">believe</span> <span class="censored">C++</span> <span class="censored">in</span> <span class="censored">its</span> <span class="censored">current</span> <span class="censored">form</span> <span class="censored">is</span> <span class="censored">unfixable.</span> <span class="censored">But</span> <span class="censored">that’s</span> <span class="censored">only</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">small-mindedness</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">small</span> <span class="censored">cabal</span> <span class="censored">based</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">Redmond.</span> <span class="censored">What</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">do</span> <span class="censored">whatever</span> <span class="censored">we</span> <span class="censored">wanted?</span> <span class="censored">What</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">used</span> <span class="censored">C++’s</span> <span class="censored">incredible</span> <span class="censored">library-building</span> <span class="censored">language</span> <span class="censored">features</span> <span class="censored">to</span> <span class="censored">build</span> <span class="censored">a</span> <span class="censored">brand-new</span> <span class="censored">language?</span></p> <p><span class="censored">For</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">year-or-so</span> <span class="censored">I’ve</span> <span class="censored">been</span> <span class="censored">playing</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">wild</span> <span class="censored">idea:</span> <span class="censored">what</span> <span class="censored">would</span> <span class="censored">C++</span> <span class="censored">look</span> <span class="censored">like</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">did</span> <span class="censored">it</span> <span class="censored">over</span> <span class="censored">again?</span> <span class="censored">Starting</span> <span class="censored">from</span> <span class="censored">an</span> <span class="censored">empty</span> <span class="censored">C++20</span> <span class="censored">file</span> <span class="censored">with</span> <span class="censored">no</span> <span class="censored">access</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">standard</span> <span class="censored">library,</span> <span class="censored">what</span> <span class="censored">can</span> <span class="censored">we</span> <span class="censored">build</span> <span class="censored">in</span> <span class="censored">its</span> <span class="censored">place?</span></p> <h2 id="starting-over"><a href="#starting-over"><span class="censored">Starting</span> <span class="censored">Over</span></a></h2> <p><span class="censored">Titus</span> <span class="censored">started</span> <span class="censored">Abseil</span> <span class="censored">while</span> <span class="censored">at</span> <span class="censored">Google,</span> <span class="censored">whose</span> <span class="censored">namespace,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">absl</span></code><span class="censored">,</span> <span class="censored">is</span> <span class="censored">sometimes</span> <span class="censored">said</span> <span class="censored">to</span> <span class="censored">stand</span> <span class="censored">for</span> <span class="censored">“a</span> <span class="censored">better</span> <span class="censored">standard</span> <span class="censored">library”</span><sup id="fnref:abcl" role="doc-noteref"><a href="#fn:abcl" class="footnote" rel="footnote"><span class="censored">3</span></a></sup><span class="censored">.</span> <span class="censored">To</span> <span class="censored">me,</span> <span class="censored">Abseil</span> <span class="censored">is</span> <span class="censored">important</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">was</span> <span class="censored">an</span> <span class="censored">attempt</span> <span class="censored">to</span> <span class="censored">work</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">existing</span> <span class="censored">standard</span> <span class="censored">library</span> <span class="censored">and</span> <span class="censored">make</span> <span class="censored">it</span> <span class="censored">better,</span> <span class="censored">while</span> <span class="censored">retaining</span> <span class="censored">a</span> <span class="censored">high</span> <span class="censored">level</span> <span class="censored">of</span> <span class="censored">implementation</span> <span class="censored">quality</span> <span class="censored">that</span> <span class="censored">a</span> <span class="censored">C++</span> <span class="censored">shop’s</span> <span class="censored">home-grown</span> <span class="censored">utility</span> <span class="censored">library</span> <span class="censored">won’t</span> <span class="censored">have,</span> <span class="censored">and</span> <span class="censored">a</span> <span class="censored">uniformity</span> <span class="censored">of</span> <span class="censored">vision</span> <span class="censored">that</span> <a href="https://www.boost.org/"><span class="censored">Boost</span></a> <span class="censored">is</span> <span class="censored">too</span> <span class="censored">all-over-the-place</span> <span class="censored">to</span> <span class="censored">achieve.</span></p> <p><span class="censored">Rather</span> <span class="censored">than</span> <span class="censored">trying</span> <span class="censored">to</span> <span class="censored">coexist</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">standard</span> <span class="censored">library,</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">surpass</span> <span class="censored">it.</span> <span class="censored">As</span> <span class="censored">a</span> <span class="censored">form</span> <span class="censored">of</span> <span class="censored">performance</span> <span class="censored">art,</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">discover</span> <span class="censored">what</span> <span class="censored">the</span> <span class="censored">standard</span> <span class="censored">library</span> <span class="censored">would</span> <span class="censored">look</span> <span class="censored">like</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">designed</span> <span class="censored">it</span> <em><span class="censored">today</span></em><span class="censored">,</span> <span class="censored">in</span> <span class="censored">2025.</span></p> <p><span class="censored">In</span> <span class="censored">this</span> <span class="censored">sense,</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">build</span> <span class="censored">something</span> <span class="censored">that</span> <span class="censored">isn’t</span> <span class="censored">just</span> <em><span class="censored">better</span></em><span class="censored">.</span> <span class="censored">It</span> <span class="censored">should</span> <span class="censored">be</span> <span class="censored">the</span> <span class="censored">C++</span> <span class="censored">standard</span> <span class="censored">library</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">possible</span> <span class="censored">world.</span> <span class="censored">It</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">possible</span> <span class="censored">library.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">why</span> <span class="censored">my</span> <span class="censored">library’s</span> <span class="censored">namespace</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code><span class="censored">.</span></p> <p><span class="censored">In</span> <span class="censored">general,</span> <span class="censored">I</span> <span class="censored">am</span> <span class="censored">trying</span> <span class="censored">not</span> <span class="censored">to</span> <span class="censored">directly</span> <span class="censored">copy</span> <span class="censored">either</span> <span class="censored">what</span> <span class="censored">C++,</span> <span class="censored">or</span> <span class="censored">Abseil,</span> <span class="censored">or</span> <span class="censored">Rust,</span> <span class="censored">or</span> <span class="censored">Go</span> <span class="censored">did.</span> <span class="censored">However,</span> <span class="censored">each</span> <span class="censored">of</span> <span class="censored">them</span> <span class="censored">has</span> <span class="censored">really</span> <span class="censored">interesting</span> <span class="censored">ideas,</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">library</span> <span class="censored">probably</span> <span class="censored">lies</span> <span class="censored">in</span> <span class="censored">some</span> <span class="censored">middle-ground</span> <span class="censored">somewhere.</span></p> <p><span class="censored">The</span> <span class="censored">rest</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">post</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">about</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">achieved</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code> <span class="censored">so</span> <span class="censored">far,</span> <span class="censored">and</span> <span class="censored">where</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">take</span> <span class="censored">it.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">look</span> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">code</span> <a href="https://github.com/mcy/best"><span class="censored">here</span></a><span class="censored">.</span></p> <h3 id="building-a-foundation"><a href="#building-a-foundation"><span class="censored">Building</span> <span class="censored">a</span> <span class="censored">Foundation</span></a></h3> <p><span class="censored">We’re</span> <span class="censored">throwing</span> <span class="censored">out</span> <span class="censored">everything,</span> <span class="censored">and</span> <span class="censored">that</span> <span class="censored">includes</span> <code class="language-plaintext highlighter-rouge"><span class="censored"><type_traits></type_traits></span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">header</span> <span class="censored">which</span> <span class="censored">shows</span> <span class="censored">its</span> <span class="censored">age:</span> <span class="censored">alias</span> <span class="censored">templates</span> <span class="censored">were’t</span> <span class="censored">added</span> <span class="censored">until</span> <span class="censored">C++14,</span> <span class="censored">and</span> <span class="censored">variable</span> <span class="censored">templates</span> <span class="censored">were</span> <span class="censored">added</span> <span class="censored">in</span> <span class="censored">C++17.</span> <span class="censored">As</span> <span class="censored">a</span> <span class="censored">result,</span> <span class="censored">many</span> <span class="censored">things</span> <span class="censored">that</span> <span class="censored">really</span> <span class="censored">aught</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">concepts</span> <span class="censored">have</span> <span class="censored">names</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::is_same_v</span></code><span class="censored">.</span> <span class="censored">All</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">now</span> <span class="censored">have</span> <span class="censored">concept</span> <span class="censored">equivalents</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored"><concepts></concepts></span></code><span class="censored">.</span></p> <p><span class="censored">I</span> <span class="censored">have</span> <span class="censored">opted</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">to</span> <span class="censored">classify</span> <span class="censored">type</span> <span class="censored">traits</span> <span class="censored">into</span> <span class="censored">separate</span> <span class="censored">headers</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">them</span> <span class="censored">easier</span> <span class="censored">to</span> <span class="censored">find.</span> <span class="censored">They</span> <span class="censored">all</span> <span class="censored">live</span> <span class="censored">under</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/meta/traits</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">they</span> <span class="censored">form</span> <span class="censored">the</span> <span class="censored">leaves</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">dependency</span> <span class="censored">graph.</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">arrays.h</span></code> <span class="censored">contains</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">array</span> <span class="censored">traits,</span> <span class="censored">such</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::is_array</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::un_array</span></code> <span class="censored">(to</span> <span class="censored">remove</span> <span class="censored">an</span> <span class="censored">array</span> <span class="censored">extent),</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::as_array</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">applies</span> <span class="censored">an</span> <span class="censored">extent</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">T,</span> <span class="censored">such</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::as_array<t> <span class="censored">0&gt;</span></t></span></code> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">an</span> <span class="censored">error.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">types.h</span></code> <span class="censored">contains</span> <span class="censored">very</span> <span class="censored">low-level</span> <span class="censored">metaprogramming</span> <span class="censored">helpers,</span> <span class="censored">such</span> <span class="censored">as:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::id</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::val</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">identity</span> <span class="censored">traits</span> <span class="censored">for</span> <span class="censored">type-</span> <span class="censored">and</span> <span class="censored">value-kinded</span> <span class="censored">traits.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::same&lt;...&gt;</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">returns</span> <span class="censored">whether</span> <span class="censored">an</span> <span class="censored">entire</span> <em><span class="censored">pack</span></em> <span class="censored">of</span> <span class="censored">types</span> <span class="censored">is</span> <span class="censored">all</span> <span class="censored">equal.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::lie</span></code><span class="censored">,</span> <span class="censored">our</span> <span class="censored">version</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::declval</span></code><span class="censored">.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::select</span></code><span class="censored">,</span> <span class="censored">our</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::conditional_t</span></code><span class="censored">.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::abridge</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">“symbol</span> <span class="censored">compression”</span> <span class="censored">mechanism</span> <span class="censored">for</span> <span class="censored">shortening</span> <span class="censored">the</span> <span class="censored">names</span> <span class="censored">of</span> <span class="censored">otherwise</span> <span class="censored">huge</span> <span class="censored">symbols.</span> </li> </ul> <p><code class="language-plaintext highlighter-rouge"><span class="censored">funcs.h</span></code> <span class="censored">provides</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::tame</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">removes</span> <span class="censored">the</span> <span class="censored">qualifiers</span> <span class="censored">from</span> <span class="censored">an</span> <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/p0172r0.html"><span class="censored">abominable</span> <span class="censored">function</span> <span class="censored">type</span></a><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">quals.h</span></code> <span class="censored">provides</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::qualifies_to</span></code><span class="censored">,</span> <span class="censored">necessary</span> <span class="censored">for</span> <span class="censored">determining</span> <span class="censored">if</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">is</span> <span class="censored">“more</span> <span class="censored">const”</span> <span class="censored">than</span> <span class="censored">another.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">empty.h</span></code> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">standard</span> <span class="censored">empty</span> <span class="censored">type</span> <span class="censored">that</span> <span class="censored">interoperates</span> <span class="censored">cleanly</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">void</span></code><span class="censored">.</span></p> <p><span class="censored">On</span> <span class="censored">top</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">type</span> <span class="censored">traits</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">metaprogramming</span> <span class="censored">library</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/meta</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">includes</span> <span class="censored">generalized</span> <span class="censored">constructibility</span> <span class="censored">traits</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">init.h</span></code> <span class="censored">(e.g.,</span> <span class="censored">to</span> <span class="censored">check</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">can,</span> <span class="censored">in</span> <span class="censored">fact,</span> <span class="censored">initialize</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;</span></code> <span class="censored">from</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">T&amp;&amp;</span></code><span class="censored">,</span> <span class="censored">for</span> <span class="censored">example).</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tlist.h</span></code> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">general</span> <span class="censored">type-level</span> <span class="censored">heterogenous</span> <span class="censored">list</span> <span class="censored">abstraction;</span> <span class="censored">a</span> <span class="censored">parameter</span> <span class="censored">pack</span> <span class="censored">as-a-type.</span></p> <p><span class="censored">The</span> <span class="censored">other</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">“the</span> <span class="censored">foundation”</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/base</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">mostly</span> <span class="censored">provides</span> <span class="censored">access</span> <span class="censored">to</span> <span class="censored">intrinsics,</span> <span class="censored">portability</span> <span class="censored">helpers,</span> <span class="censored">macros,</span> <span class="censored">and</span> <span class="censored">“tag</span> <span class="censored">types”</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">our</span> <span class="censored">versions</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::in_place</span></code><span class="censored">.</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">macro.h</span></code> <span class="censored">provides</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BEST_STRINGIFY()</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">port.h</span></code> <span class="censored">provides</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BEST_HAS_INCLUDE()</span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hint.h</span></code> <span class="censored">provides</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::unreachable()</span></code><span class="censored">.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">guard.h</span></code> <span class="censored">provides</span> <span class="censored">our</span> <span class="censored">version</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">Rust</span> <code class="language-plaintext highlighter-rouge"><span class="censored">?</span></code> <span class="censored">operator,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">an</span> <span class="censored">expression</span> <span class="censored">because</span> <span class="censored">statement</span> <span class="censored">expressions</span> <span class="censored">are</span> <span class="censored">broken</span> <span class="censored">in</span> <span class="censored">Clang.</span></p> <p><span class="censored">Finally,</span> <span class="censored">within</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/container</span></code> <span class="censored">we</span> <span class="censored">find</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::object</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">special</span> <span class="censored">type</span> <span class="censored">for</span> <span class="censored">turning</span> <span class="censored">any</span> <span class="censored">C++</span> <span class="censored">type</span> <span class="censored">into</span> <span class="censored">an</span> <span class="censored">object</span> <span class="censored">(i.e.,</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">form</span> <span class="censored">a</span> <span class="censored">reference</span> <span class="censored">to).</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">manipulating</span> <span class="censored">any</span> <span class="censored">type</span> <span class="censored">generically,</span> <span class="censored">without</span> <span class="censored">tripping</span> <span class="censored">over</span> <span class="censored">the</span> <span class="censored">assign-through</span> <span class="censored">semantics</span> <span class="censored">of</span> <span class="censored">references.</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::object<t></t></span></code> <span class="censored">is</span> <span class="censored">essentially</span> <span class="censored">a</span> <span class="censored">pointer.</span></p> <h3 id="adt-containers"><a href="#adt-containers"><span class="censored">“ADT”</span> <span class="censored">Containers</span></a></h3> <p><span class="censored">On</span> <span class="censored">top</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">foundation</span> <span class="censored">we</span> <span class="censored">build</span> <span class="censored">the</span> <span class="censored">basic</span> <span class="censored">algebraic</span> <span class="censored">data</span> <span class="censored">types</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code><span class="censored">:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::row</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::choice</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">replace</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::tuple</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::variant</span></code><span class="censored">.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::row<a> <span class="censored">B,</span> <span class="censored">C&gt;</span></a></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">heterogenous</span> <span class="censored">collection</span> <span class="censored">of</span> <span class="censored">values,</span> <span class="censored">stored</span> <span class="censored">inside</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::object</span></code><span class="censored">s.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::row<int></int></span></code> <span class="censored">has</span> <span class="censored">natural</span> <span class="censored">rebinding,</span> <span class="censored">rather</span> <span class="censored">than</span> <span class="censored">assign-through,</span> <span class="censored">semantics.</span></p> <p><span class="censored">Accessing</span> <span class="censored">elements</span> <span class="censored">is</span> <span class="censored">done</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">at()</span></code><span class="censored">:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">my_row.at&lt;0&gt;()</span></code> <span class="censored">returns</span> <span class="censored">a</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">first</span> <span class="censored">element.</span> <span class="censored">Getting</span> <span class="censored">the</span> <span class="censored">first</span> <span class="censored">element</span> <span class="censored">is</span> <span class="censored">so</span> <span class="censored">common</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">also</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">my_row.first()</span></code><span class="censored">.</span> <span class="censored">Using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">my_row.object&lt;0&gt;()</span></code> <span class="censored">will</span> <span class="censored">return</span> <span class="censored">a</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::object</span></code> <span class="censored">instead,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">rebinding</span> <span class="censored">references.</span> <span class="censored">For</span> <span class="censored">example:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">y</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">row</span></span><span class="o"><span class="censored">&lt;</span></span><span class="kt"><span class="censored">int</span></span><span class="o"><span class="censored">&amp;&gt;</span></span> <span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">{</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">};</span></span>
<span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">at</span></span><span class="o"><span class="censored">&lt;</span></span><span class="mi"><span class="censored">0</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">()</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">42</span></span><span class="p"><span class="censored">;</span></span>     <span class="c1"><span class="censored">//</span> <span class="censored">Writes</span> <span class="censored">to</span> <span class="censored">x.</span></span>
<span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">object</span></span><span class="o"><span class="censored">&lt;</span></span><span class="mi"><span class="censored">0</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">()</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>  <span class="c1"><span class="censored">//</span> <span class="censored">Rebinds</span> <span class="censored">a.0</span> <span class="censored">to</span> <span class="censored">y.</span></span>
<span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">at</span></span><span class="o"><span class="censored">&lt;</span></span><span class="mi"><span class="censored">0</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">()</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">2</span></span><span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span>    <span class="c1"><span class="censored">//</span> <span class="censored">Writes</span> <span class="censored">to</span> <span class="censored">y.</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">There</span> <span class="censored">is</span> <span class="censored">also</span> <code class="language-plaintext highlighter-rouge"><span class="censored">second()</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">last()</span></code><span class="censored">,</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">two</span> <span class="censored">most</span> <span class="censored">common</span> <span class="censored">elements</span> <span class="censored">to</span> <span class="censored">access.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::row</span></code> <span class="censored">is</span> <span class="censored">named</span> <span class="censored">so</span> <span class="censored">in</span> <span class="censored">reference</span> <span class="censored">to</span> <span class="censored">database</span> <span class="censored">rows:</span> <span class="censored">it</span> <span class="censored">provides</span> <span class="censored">many</span> <span class="censored">operations</span> <span class="censored">for</span> <span class="censored">slicing</span> <span class="censored">and</span> <span class="censored">dicing</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::tuple</span></code> <span class="censored">does</span> <span class="censored">not.</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <span class="censored">in</span> <span class="censored">addition</span> <span class="censored">to</span> <span class="censored">extracting</span> <span class="censored">single</span> <span class="censored">elements,</span> <span class="censored">it’s</span> <span class="censored">also</span> <span class="censored">possible</span> <span class="censored">to</span> <span class="censored">access</span> <span class="censored">contiguous</span> <span class="censored">subsequences,</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::bounds</span></code><span class="censored">:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a.at<best::bounds> <span class="censored">=</span> <span class="censored">1,</span> <span class="censored">.end</span> <span class="censored">=</span> <span class="censored">10}&gt;()</span></best::bounds></span></code><span class="censored">!</span> <span class="censored">There</span> <span class="censored">are</span> <span class="censored">also</span> <span class="censored">a</span> <span class="censored">plethora</span> <span class="censored">of</span> <span class="censored">mutation</span> <span class="censored">operations:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">a</span> <span class="censored">+</span> <span class="censored">b</span></code> <span class="censored">concatenates</span> <span class="censored">tuples,</span> <span class="censored">copying</span> <span class="censored">or</span> <span class="censored">moving</span> <span class="censored">as</span> <span class="censored">appropriate</span> <span class="censored">(</span><code class="language-plaintext highlighter-rouge"><span class="censored">a</span> <span class="censored">+</span> <span class="censored">BEST_MOVE(b)</span></code> <span class="censored">will</span> <span class="censored">move</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">elements</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b</span></code><span class="censored">,</span> <span class="censored">for</span> <span class="censored">example).</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">a.push(x)</span></code> <span class="censored">returns</span> <span class="censored">a</span> <span class="censored">copy</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a</span></code> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x</span></code> <span class="censored">appended,</span> <span class="censored">while</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a.insert<n>(x)</n></span></code> <span class="censored">does</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">at</span> <span class="censored">an</span> <span class="censored">arbitrary</span> <span class="censored">index.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">a.update<n>(x)</n></span></code> <em><span class="censored">replaces</span></em> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">n</span></code><span class="censored">th</span> <span class="censored">element</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x</span></code><span class="censored">,</span> <span class="censored">potentially</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">different</span> <span class="censored">type.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">a.remove<n>()</n></span></code> <span class="censored">deletes</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">n</span></code><span class="censored">th</span> <span class="censored">element,</span> <span class="censored">while</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a.erase&lt;...&gt;()</span></code> <span class="censored">deletes</span> <span class="censored">a</span> <span class="censored">contiguous</span> <span class="censored">range.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">a.splice<best::bounds>(...)</best::bounds></span></code> <span class="censored">splices</span> <span class="censored">a</span> <span class="censored">row</span> <span class="censored">into</span> <span class="censored">another</span> <span class="censored">row,</span> <span class="censored">offering</span> <span class="censored">a</span> <span class="censored">general</span> <span class="censored">replace/delete</span> <span class="censored">operation</span> <span class="censored">that</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">above</span> <span class="censored">operations</span> <span class="censored">are</span> <span class="censored">implemented</span> <span class="censored">in</span> <span class="censored">terms</span> <span class="censored">of.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">gather()</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">scatter()</span></code> <span class="censored">are</span> <span class="censored">even</span> <span class="censored">more</span> <span class="censored">general,</span> <span class="censored">allowing</span> <span class="censored">for</span> <span class="censored">non-contiguous</span> <span class="censored">indexing.</span> </li> </ul> <p><span class="censored">Meanwhile,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::apply</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">method</span> <span class="censored">now:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a.apply(f)</span></code> <span class="censored">calls</span> <code class="language-plaintext highlighter-rouge"><span class="censored">f</span></code> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a</span></code><span class="censored">’s</span> <span class="censored">elements</span> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">arguments.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a.each(f)</span></code> <span class="censored">is</span> <span class="censored">similar,</span> <span class="censored">but</span> <span class="censored">instead</span> <span class="censored">expands</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">n</span></code> <span class="censored">unary</span> <span class="censored">calls</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">f</span></code><span class="censored">,</span> <span class="censored">one</span> <span class="censored">with</span> <span class="censored">each</span> <span class="censored">element.</span></p> <p><span class="censored">And</span> <em><span class="censored">of</span> <span class="censored">course</span></em><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::row</span></code> <span class="censored">supports</span> <span class="censored">structured</span> <span class="censored">bindings.</span></p> <p><span class="censored">Meanwhile,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::choice<a> <span class="censored">B,</span> <span class="censored">C&gt;</span></a></span></code> <span class="censored">contains</span> <span class="censored">precisely</span> <span class="censored">one</span> <span class="censored">value</span> <span class="censored">from</span> <span class="censored">various</span> <span class="censored">types.</span> <span class="censored">There</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">underlying</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::pun<a> <span class="censored">B,</span> <span class="censored">C&gt;</span></a></span></code> <span class="censored">type</span> <span class="censored">that</span> <span class="censored">implements</span> <span class="censored">a</span> <span class="censored">variadic</span> <span class="censored">untagged</span> <span class="censored">union</span> <span class="censored">that</span> <span class="censored">works</span> <span class="censored">around</span> <span class="censored">many</span> <span class="censored">of</span> <span class="censored">C++’s</span> <span class="censored">bugs</span> <span class="censored">relating</span> <span class="censored">to</span> <span class="censored">unions</span> <span class="censored">with</span> <span class="censored">members</span> <span class="censored">of</span> <span class="censored">non-trivial</span> <span class="censored">type.</span></p> <p><span class="censored">The</span> <span class="censored">most</span> <span class="censored">common</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">operate</span> <span class="censored">on</span> <span class="censored">a</span> <span class="censored">choice</span> <span class="censored">is</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">match</span></code> <span class="censored">on</span> <span class="censored">it:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">choice</span></span><span class="o"><span class="censored">&lt;</span></span><span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">*</span></span><span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">,</span></span> <span class="kt"><span class="censored">void</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">z</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">42</span></span><span class="p"><span class="censored">;</span></span>
<span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">result</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">z</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">match</span></span><span class="p"><span class="censored">(</span></span>
  <span class="p"><span class="censored">[](</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span> <span class="p"><span class="censored">},</span></span>
  <span class="p"><span class="censored">[](</span></span><span class="kt"><span class="censored">int</span></span><span class="o"><span class="censored">*</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="k"><span class="censored">return</span></span> <span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span> <span class="p"><span class="censored">},</span></span>
  <span class="p"><span class="censored">[]</span></span> <span class="p"><span class="censored">{</span></span> <span class="k"><span class="censored">return</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span> <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">);</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">Which</span> <span class="censored">case</span> <span class="censored">gets</span> <span class="censored">called</span> <span class="censored">here</span> <span class="censored">is</span> <span class="censored">chosen</span> <span class="censored">by</span> <span class="censored">overload</span> <span class="censored">resolution,</span> <span class="censored">allowing</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">a</span> <span class="censored">default</span> <span class="censored">case</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">[](auto&amp;&amp;)</span> <span class="censored">{</span> <span class="censored">...</span> <span class="censored">}</span></code><span class="censored">.</span></p> <p><span class="censored">Which</span> <span class="censored">variant</span> <span class="censored">is</span> <span class="censored">currently</span> <span class="censored">selected</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">checked</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">z.which()</span></code><span class="censored">,</span> <span class="censored">while</span> <span class="censored">specific</span> <span class="censored">variants</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">accessed</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">z.at()</span></code><span class="censored">,</span> <span class="censored">just</span> <span class="censored">like</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::row</span></code><span class="censored">,</span> <span class="censored">except</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">returns</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option<t></t></span></code><span class="censored">.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::choice</span></code> <span class="censored">is</span> <span class="censored">what</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">sum</span> <span class="censored">types,</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::result</span></code><span class="censored">,</span> <span class="censored">are</span> <span class="censored">built</span> <span class="censored">out</span> <span class="censored">of.</span> <span class="censored">All</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">clever</span> <span class="censored">layout</span> <span class="censored">optimizations</span> <span class="censored">live</span> <span class="censored">here.</span></p> <p><span class="censored">Speaking</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option<t></t></span></code><span class="censored">,</span> <span class="censored">that’s</span> <span class="censored">our</span> <span class="censored">option</span> <span class="censored">type.</span> <span class="censored">It’s</span> <span class="censored">close</span> <span class="censored">in</span> <span class="censored">spirit</span> <span class="censored">to</span> <span class="censored">what</span> <a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Option<t></t></span></code></a> <span class="censored">is</span> <span class="censored">in</span> <span class="censored">Rust.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code> <span class="censored">has</span> <span class="censored">a</span> <span class="censored">generic</span> <span class="censored">niche</span> <span class="censored">mechanism</span> <span class="censored">that</span> <span class="censored">user</span> <span class="censored">types</span> <span class="censored">can</span> <span class="censored">opt</span> <span class="censored">into,</span> <span class="censored">allowing</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option<t></t></span></code> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">size</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">pointer,</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">nullptr</span></code> <span class="censored">for</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::none</span></code> <span class="censored">variant.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code> <span class="censored">provides</span> <span class="censored">the</span> <span class="censored">usual</span> <span class="censored">transformation</span> <span class="censored">operations:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">map</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">then</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">filter</span></code><span class="censored">.</span> <span class="censored">Emptiness</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">checked</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">is_empty()</span></code> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">has_value()</span></code><span class="censored">.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">even</span> <span class="censored">pass</span> <span class="censored">a</span> <span class="censored">predicate</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">has_value()</span></code> <span class="censored">to</span> <span class="censored">check</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">with,</span> <span class="censored">if</span> <span class="censored">it’s</span> <span class="censored">present:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x.has_value([](auto&amp;</span> <span class="censored">x)</span> <span class="censored">{</span> <span class="censored">return</span> <span class="censored">x</span> <span class="censored">==</span> <span class="censored">42;</span> <span class="censored">})</span></code><span class="censored">.</span></p> <p><span class="censored">The</span> <span class="censored">value</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">accessed</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">operator*</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">operator-&gt;</span></code><span class="censored">,</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::optional</span></code><span class="censored">;</span> <span class="censored">however,</span> <span class="censored">this</span> <span class="censored">operation</span> <span class="censored">is</span> <span class="censored">checked,</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">causing</span> <span class="censored">UB</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">option</span> <span class="censored">is</span> <span class="censored">empty.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">value_or()</span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">unwrap</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">default;</span> <span class="censored">the</span> <span class="censored">default</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">any</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">arguments,</span> <span class="censored">which</span> <span class="censored">are</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">construct</span> <span class="censored">the</span> <span class="censored">default,</span> <span class="censored">or</span> <span class="censored">even</span> <span class="censored">a</span> <span class="censored">callback.</span> <span class="censored">For</span> <span class="censored">example:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">option</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">Foo</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">Pass</span> <span class="censored">arguments</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">constructor.</span></span>
<span class="n"><span class="censored">do_something</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">value_or</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">args</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">to</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">foo</span></span><span class="p"><span class="censored">));</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">Execute</span> <span class="censored">arbitrary</span> <span class="censored">logic</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">is</span> <span class="censored">missing.</span></span>
<span class="n"><span class="censored">do_something</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">value_or</span></span><span class="p"><span class="censored">([]</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">Foo</span></span><span class="p"><span class="censored">(...);</span></span>
<span class="p"><span class="censored">}))</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::option<void></void></span></code> <span class="censored">also</span> <span class="censored">Just</span> <span class="censored">Works</span> <span class="censored">(in</span> <span class="censored">fact,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option<t></t></span></code> <span class="censored">is</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::choice<void> <span class="censored">T&gt;</span></void></span></code> <span class="censored">internally),</span> <span class="censored">allowing</span> <span class="censored">for</span> <span class="censored">truly</span> <span class="censored">generic</span> <span class="censored">manipulation</span> <span class="censored">of</span> <span class="censored">optional</span> <span class="censored">results.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::result<t> <span class="censored">E&gt;</span></t></span></code> <span class="censored">is,</span> <span class="censored">unsurprisingly,</span> <span class="censored">the</span> <span class="censored">analogue</span> <span class="censored">of</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Result<t> <span class="censored">E&gt;</span></t></span></code></a><span class="censored">.</span> <span class="censored">Because</span> <span class="censored">it’s</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::choice</span></code> <span class="censored">internally,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::result<void> <span class="censored">E&gt;</span></void></span></code> <span class="censored">works</span> <span class="censored">as</span> <span class="censored">you</span> <span class="censored">might</span> <span class="censored">expect,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">common</span> <span class="censored">return</span> <span class="censored">value</span> <span class="censored">for</span> <span class="censored">I/O</span> <span class="censored">operations.</span></p> <p><span class="censored">It’s</span> <span class="censored">very</span> <span class="censored">similar</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code><span class="censored">,</span> <span class="censored">including</span> <span class="censored">offering</span> <code class="language-plaintext highlighter-rouge"><span class="censored">operator-&gt;</span></code> <span class="censored">for</span> <span class="censored">accessing</span> <span class="censored">the</span> <span class="censored">“ok”</span> <span class="censored">variant.</span> <span class="censored">This</span> <span class="censored">enables</span> <span class="censored">succinct</span> <span class="censored">idioms:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">if</span></span> <span class="p"><span class="censored">(</span></span><span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">r</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">fallible</span></span><span class="p"><span class="censored">())</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">r</span></span><span class="o"><span class="censored">-&gt;</span></span><span class="n"><span class="censored">do_something</span></span><span class="p"><span class="censored">();</span></span>
<span class="p"><span class="censored">}</span></span> <span class="k"><span class="censored">else</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">println</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"{}"</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">r</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">err</span></span><span class="p"><span class="censored">());</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">r.ok()</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">r.err()</span></code> <span class="censored">return</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code><span class="censored">s</span> <span class="censored">containing</span> <span class="censored">references</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">ok</span> <span class="censored">and</span> <span class="censored">error</span> <span class="censored">variants,</span> <span class="censored">depending</span> <span class="censored">on</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">present;</span> <span class="censored">meanwhile,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">converted</span> <span class="censored">into</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::result</span></code> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">ok_or()</span></code> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">err_or()</span></code><span class="censored">,</span> <span class="censored">just</span> <span class="censored">like</span> <span class="censored">in</span> <span class="censored">Rust.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::result</span></code><span class="censored">s</span> <span class="censored">are</span> <span class="censored">constructed</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ok</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::err</span></code><span class="censored">.</span> <span class="censored">For</span> <span class="censored">example:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">result</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">Foo</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">Error</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">r</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">ok</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">args</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">to</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">foo</span></span><span class="p"><span class="censored">);</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">These</span> <span class="censored">internally</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::args</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">wrapper</span> <span class="censored">over</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::row</span></code> <span class="censored">that</span> <span class="censored">represents</span> <span class="censored">a</span> <span class="censored">“delayed</span> <span class="censored">initialization”</span> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">stored</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">value.</span> <span class="censored">It</span> <span class="censored">will</span> <span class="censored">implicitly</span> <span class="censored">convert</span> <span class="censored">into</span> <span class="censored">any</span> <span class="censored">type</span> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">constructed</span> <span class="censored">from</span> <span class="censored">its</span> <span class="censored">elements.</span> <span class="censored">For</span> <span class="censored">example:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">Foo</span></span> <span class="n"><span class="censored">foo</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">args</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">args</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">to</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">foo</span></span><span class="p"><span class="censored">);</span></span>  <span class="c1"><span class="censored">//</span> <span class="censored">Calls</span> <span class="censored">Foo::Foo(args,</span> <span class="censored">to,</span> <span class="censored">foo).</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">Also,</span> <span class="censored">every</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">above</span> <span class="censored">types</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">structural</span> <span class="censored">type,</span> <span class="censored">meaning</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">non-type</span> <span class="censored">template</span> <span class="censored">parameters!</span></p> <h3 id="memory-and-pointers"><a href="#memory-and-pointers"><span class="censored">Memory</span> <span class="censored">and</span> <span class="censored">Pointers</span></a></h3> <p><span class="censored">Of</span> <span class="censored">course,</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">ADTs</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">built</span> <span class="censored">on</span> <span class="censored">top</span> <span class="censored">of</span> <span class="censored">pointer</span> <span class="censored">operations,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">where</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/memory</span></code> <span class="censored">comes</span> <span class="censored">in.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr<t></t></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">generalized</span> <span class="censored">pointer</span> <span class="censored">type</span> <span class="censored">that</span> <span class="censored">provides</span> <span class="censored">many</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">operations</span> <span class="censored">as</span> <span class="censored">Rust’s</span> <span class="censored">raw</span> <span class="censored">pointers,</span> <span class="censored">including</span> <span class="censored">offsetting,</span> <span class="censored">copying,</span> <span class="censored">and</span> <span class="censored">indexing.</span> <span class="censored">Like</span> <span class="censored">Rust</span> <span class="censored">pointers,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr<t></t></span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">fat</span> <span class="censored">pointer,</span> <span class="censored">i.e.,</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">carry</span> <span class="censored">additional</span> <span class="censored">metadata</span> <span class="censored">on</span> <span class="censored">top</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">pointer.</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr<int></int></span></code> <span class="censored">remembers</span> <span class="censored">the</span> <span class="censored">size</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">array.</span></p> <p><span class="censored">Providing</span> <span class="censored">metadata</span> <span class="censored">for</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr</span></code> <span class="censored">is</span> <span class="censored">done</span> <span class="censored">through</span> <span class="censored">a</span> <span class="censored">member</span> <span class="censored">alias</span> <span class="censored">called</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BestPtrMetadata</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">alias</span> <span class="censored">should</span> <span class="censored">be</span> <span class="censored">private,</span> <span class="censored">which</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code> <span class="censored">is</span> <span class="censored">given</span> <span class="censored">access</span> <span class="censored">to</span> <span class="censored">by</span> <span class="censored">befriending</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::access</span></code><span class="censored">.</span> <span class="censored">Types</span> <span class="censored">with</span> <span class="censored">custom</span> <span class="censored">metadata</span> <span class="censored">will</span> <span class="censored">usually</span> <span class="censored">not</span> <span class="censored">be</span> <span class="censored">directly</span> <span class="censored">constructible</span> <span class="censored">(because</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">of</span> <span class="censored">variable</span> <span class="censored">size),</span> <span class="censored">and</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">manipulated</span> <span class="censored">exclusively</span> <span class="censored">through</span> <span class="censored">types</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr</span></code><span class="censored">.</span></p> <p><span class="censored">Specifying</span> <span class="censored">custom</span> <span class="censored">metadata</span> <span class="censored">allows</span> <span class="censored">specifying</span> <span class="censored">what</span> <span class="censored">the</span> <span class="censored">pointer</span> <span class="censored">dereferences</span> <span class="censored">to.</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr<int></int></span></code> <span class="censored">dereferences</span> <span class="censored">to</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::span<int></int></span></code><span class="censored">,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">span</span> <span class="censored">operations</span> <span class="censored">are</span> <span class="censored">accessible</span> <span class="censored">through</span> <code class="language-plaintext highlighter-rouge"><span class="censored">operator-&gt;</span></code><span class="censored">:</span> <span class="censored">for</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">my_array_ptr-&gt;first()</span></code><span class="censored">.</span></p> <p><span class="censored">Most</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">may</span> <span class="censored">seem</span> <span class="censored">a</span> <span class="censored">bit</span> <span class="censored">over-complicated,</span> <span class="censored">since</span> <span class="censored">ordinary</span> <span class="censored">C++</span> <span class="censored">raw</span> <span class="censored">pointers</span> <span class="censored">and</span> <span class="censored">references</span> <span class="censored">are</span> <span class="censored">fine</span> <span class="censored">for</span> <span class="censored">most</span> <span class="censored">uses.</span> <span class="censored">However,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">foundation</span> <span class="censored">upon</span> <span class="censored">which</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::box<t></t></span></code> <span class="censored">is</span> <span class="censored">built</span> <span class="censored">on.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::box<t></t></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">replacement</span> <span class="censored">for</span> <a href="https://en.cppreference.com/w/cpp/memory/unique_ptr.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::unique_ptr<t></t></span></code></a> <span class="censored">that</span> <span class="censored">fixes</span> <span class="censored">its</span> <span class="censored">const</span> <span class="censored">correctness</span> <span class="censored">and</span> <span class="censored">adds</span> <span class="censored">Rust</span> <a href="https://doc.rust-lang.org/std/boxed/struct.Box.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Box</span></code></a><span class="censored">-like</span> <span class="censored">helpers.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::box<t></t></span></code> <span class="censored">also</span> <span class="censored">works,</span> <span class="censored">but</span> <span class="censored">unlike</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::unique_ptr<t></t></span></code><span class="censored">,</span> <span class="censored">it</span> <span class="censored">remembers</span> <span class="censored">its</span> <span class="censored">size,</span> <span class="censored">just</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ptr<t></t></span></code><span class="censored">.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::box</span></code> <span class="censored">is</span> <span class="censored">parameterized</span> <span class="censored">by</span> <span class="censored">its</span> <span class="censored">allocator,</span> <span class="censored">which</span> <span class="censored">must</span> <span class="censored">satisfy</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::allocator</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">much</span> <span class="censored">less</span> <span class="censored">insane</span> <span class="censored">API</span> <span class="censored">than</span> <span class="censored">what</span> <a href="https://en.cppreference.com/w/cpp/memory/allocator.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::allocator</span></code></a> <span class="censored">offers.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::malloc</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">singleton</span> <span class="censored">allocator</span> <span class="censored">representing</span> <span class="censored">the</span> <span class="censored">system</span> <span class="censored">allocator.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::span<t></t></span></code><span class="censored">,</span> <span class="censored">mentioned</span> <span class="censored">before,</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">contiguous</span> <span class="censored">memory</span> <span class="censored">abstraction,</span> <span class="censored">replacing</span> <a href="https://en.cppreference.com/w/cpp/container/span.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::span</span></code></a><span class="censored">.</span> <span class="censored">Like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::span</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::span<t> <span class="censored">n&gt;</span></t></span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">fixed-length</span> <span class="censored">span</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">n</span></code> <span class="censored">elements.</span> <span class="censored">Unlike</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::span</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">second</span> <span class="censored">parameter</span> <span class="censored">is</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option<size_t></size_t></span></code><span class="censored">,</span> <span class="censored">not</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">size_t</span></code> <span class="censored">that</span> <span class="censored">uses</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-1</span></code> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">sentinel.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::span<t></t></span></code> <span class="censored">tries</span> <span class="censored">to</span> <span class="censored">approximate</span> <span class="censored">the</span> <span class="censored">API</span> <span class="censored">of</span> <a href="https://doc.rust-lang.org/std/primitive.slice.html"><span class="censored">Rust</span> <span class="censored">slices</span></a><span class="censored">,</span> <span class="censored">providing</span> <span class="censored">indexing,</span> <span class="censored">slicing,</span> <span class="censored">splicing,</span> <span class="censored">search,</span> <span class="censored">sort,</span> <span class="censored">and</span> <span class="censored">more.</span> <span class="censored">Naturally,</span> <span class="censored">it’s</span> <span class="censored">also</span> <span class="censored">iterable,</span> <span class="censored">both</span> <span class="censored">forwards</span> <span class="censored">and</span> <span class="censored">backwards,</span> <span class="censored">and</span> <span class="censored">provides</span> <span class="censored">splitting</span> <span class="censored">iterators,</span> <span class="censored">just</span> <span class="censored">like</span> <span class="censored">Rust.</span></p> <p><span class="censored">Slicing</span> <span class="censored">and</span> <span class="censored">indexing</span> <span class="censored">is</span> <span class="censored">always</span> <span class="censored">bounds-checked.</span> <span class="censored">Indexing</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">done</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">size_t</span></code> <span class="censored">values,</span> <span class="censored">while</span> <span class="censored">slicing</span> <span class="censored">uses</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::bounds</span></code><span class="censored">:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">span</span></span><span class="o"><span class="censored">&lt;</span></span><span class="kt"><span class="censored">int</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">xs</span></span> <span class="o"><span class="censored">=</span></span> <span class="p"><span class="censored">...;</span></span>
<span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">xs</span></span><span class="p"><span class="censored">[</span></span><span class="mi"><span class="censored">5</span></span><span class="p"><span class="censored">];</span></span>
<span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">ys</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">xs</span></span><span class="p"><span class="censored">[{.</span></span><span class="n"><span class="censored">start</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">,</span></span> <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">end</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">6</span></span><span class="p"><span class="censored">}];</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::bounds</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">generic</span> <span class="censored">mechanism</span> <span class="censored">for</span> <span class="censored">specifying</span> <span class="censored">slicing</span> <span class="censored">bounds,</span> <span class="censored">similar</span> <span class="censored">to</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/ops/struct.Range.html"><span class="censored">range</span> <span class="censored">types</span></a><span class="censored">.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">specify</span> <span class="censored">the</span> <span class="censored">start</span> <span class="censored">and</span> <span class="censored">end</span> <span class="censored">(exclusive),</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x..y</span></code> <span class="censored">in</span> <span class="censored">Rust.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">also</span> <span class="censored">specify</span> <span class="censored">an</span> <span class="censored">inclusive</span> <span class="censored">end</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.inclusive_end</span> <span class="censored">=</span> <span class="censored">5</span></code><span class="censored">,</span> <span class="censored">equivalent</span> <span class="censored">to</span> <span class="censored">Rust’s</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x..=y</span></code><span class="censored">.</span> <span class="censored">And</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">specify</span> <span class="censored">a</span> <span class="censored">count,</span> <span class="censored">like</span> <span class="censored">C++’s</span> <span class="censored">slicing</span> <span class="censored">operations</span> <span class="censored">prefer:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{.start</span> <span class="censored">=</span> <span class="censored">1,</span> <span class="censored">.count</span> <span class="censored">=</span> <span class="censored">5}</span></code><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::bounds</span></code> <span class="censored">itself</span> <span class="censored">provides</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">necessary</span> <span class="censored">helpers</span> <span class="censored">for</span> <span class="censored">performing</span> <span class="censored">bounds</span> <span class="censored">checks</span> <span class="censored">and</span> <span class="censored">crashing</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">nice</span> <span class="censored">error</span> <span class="censored">message.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::bounds</span></code> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">iterable,</span> <span class="censored">as</span> <span class="censored">we’ll</span> <span class="censored">see</span> <span class="censored">shortly.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::layout</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">copy</span> <span class="censored">of</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/alloc/struct.Layout.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Layout</span></code></a> <span class="censored">type,</span> <span class="censored">providing</span> <span class="censored">similar</span> <span class="censored">helpers</span> <span class="censored">for</span> <span class="censored">performing</span> <span class="censored">C++-specific</span> <span class="censored">size</span> <span class="censored">and</span> <span class="censored">address</span> <span class="censored">calculations.</span></p> <h3 id="iterators"><a href="#iterators"><span class="censored">Iterators</span></a></h3> <p><span class="censored">C++</span> <span class="censored">iterator</span> <span class="censored">pairs</span> <span class="censored">suck.</span> <span class="censored">C++</span> <span class="censored">ranges</span> <span class="censored">suck.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">paradigm</span> <span class="censored">for</span> <span class="censored">iteration</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">essentially</span> <span class="censored">just</span> <span class="censored">Rust</span> <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Iterator</span></code><span class="censored">s</span></a> <span class="censored">hammered</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">C++</span> <span class="censored">shape.</span> <span class="censored">This</span> <span class="censored">library</span> <span class="censored">lives</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/iter</span></code><span class="censored">.</span></p> <p><span class="censored">To</span> <span class="censored">define</span> <span class="censored">an</span> <span class="censored">iterator,</span> <span class="censored">you</span> <span class="censored">define</span> <span class="censored">an</span> <em><span class="censored">iterator</span> <span class="censored">implementation</span> <span class="censored">type</span></em><span class="censored">,</span> <span class="censored">which</span> <span class="censored">must</span> <span class="censored">define</span> <span class="censored">a</span> <span class="censored">member</span> <span class="censored">function</span> <span class="censored">named</span> <code class="language-plaintext highlighter-rouge"><span class="censored">next()</span></code> <span class="censored">that</span> <span class="censored">returns</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code><span class="censored">:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">class</span></span> <span class="nc"><span class="censored">my_iter_impl</span></span> <span class="k"><span class="censored">final</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="nl"><span class="censored">public:</span></span>
    <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">option</span></span><span class="o"><span class="censored">&lt;</span></span><span class="kt"><span class="censored">int</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">next</span></span><span class="p"><span class="censored">();</span></span>
<span class="p"><span class="censored">};</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">type</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">implementation</span> <span class="censored">detail;</span> <span class="censored">the</span> <span class="censored">actual</span> <span class="censored">iterator</span> <span class="censored">type</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::iter<my_iter_impl></my_iter_impl></span></code><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::iter</span></code> <span class="censored">provides</span> <span class="censored">all</span> <span class="censored">kinds</span> <span class="censored">of</span> <span class="censored">helpers,</span> <span class="censored">just</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Iterator</span></code><span class="censored">,</span> <span class="censored">for</span> <span class="censored">adapting</span> <span class="censored">the</span> <span class="censored">iterator</span> <span class="censored">or</span> <span class="censored">consuming</span> <span class="censored">items</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">it.</span></p> <p><span class="censored">Iterators</span> <span class="censored">can</span> <span class="censored">override</span> <span class="censored">the</span> <span class="censored">behavior</span> <span class="censored">of</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">adaptors</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">more</span> <span class="censored">efficient,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">for</span> <span class="censored">making</span> <code class="language-plaintext highlighter-rouge"><span class="censored">count()</span></code> <span class="censored">constant-time</span> <span class="censored">rather</span> <span class="censored">than</span> <span class="censored">linear.</span> <span class="censored">Iterators</span> <span class="censored">can</span> <span class="censored">also</span> <span class="censored">offer</span> <span class="censored">extra</span> <span class="censored">methods</span> <span class="censored">if</span> <span class="censored">they</span> <span class="censored">define</span> <span class="censored">the</span> <span class="censored">member</span> <span class="censored">alias</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BestIterArrow</span></code><span class="censored">;</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">the</span> <span class="censored">iterators</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::span</span></code> <span class="censored">have</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-&gt;rest()</span></code> <span class="censored">method</span> <span class="censored">for</span> <span class="censored">returning</span> <span class="censored">the</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">slice</span> <span class="censored">that</span> <span class="censored">has</span> <span class="censored">not</span> <span class="censored">been</span> <span class="censored">yielded</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">next()</span></code> <span class="censored">yet.</span></p> <p><span class="censored">One</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">important</span> <span class="censored">extension</span> <span class="censored">points</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">size_hint()</span></code><span class="censored">,</span> <span class="censored">analogous</span> <span class="censored">to</span> <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.size_hint"><code class="language-plaintext highlighter-rouge"><span class="censored">Iterator::size_hint()</span></code></a><span class="censored">,</span> <span class="censored">for</span> <span class="censored">right-sizing</span> <span class="censored">containers</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">iterator</span> <span class="censored">is</span> <span class="censored">converted</span> <span class="censored">to,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec</span></code><span class="censored">.</span></p> <p><span class="censored">And</span> <span class="censored">of</span> <span class="censored">course,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::iter</span></code> <span class="censored">provides</span> <code class="language-plaintext highlighter-rouge"><span class="censored">begin/end</span></code> <span class="censored">so</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">C++</span> <span class="censored">range-for</span> <span class="censored">loop,</span> <span class="censored">just</span> <span class="censored">like</span> <span class="censored">C++20</span> <span class="censored">ranges</span> <span class="censored">do.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::int_range<i></i></span></code><sup id="fnref:interval" role="doc-noteref"><a href="#fn:interval" class="footnote" rel="footnote"><span class="censored">4</span></a></sup><span class="censored">,</span> <span class="censored">which</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::bounds</span></code> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">instantiation</span> <span class="censored">of,</span> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">an</span> <span class="censored">iterator,</span> <span class="censored">and</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">much</span> <span class="censored">like</span> <span class="censored">Rust</span> <span class="censored">ranges</span> <span class="censored">would:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">for</span></span> <span class="p"><span class="censored">(</span></span><span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">i</span></span> <span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">int_range</span></span><span class="o"><span class="censored">&lt;</span></span><span class="kt"><span class="censored">int</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">{.</span></span><span class="n"><span class="censored">start</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">,</span></span> <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">count</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">200</span></span><span class="p"><span class="censored">})</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">...</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::int_range</span></code> <span class="censored">will</span> <span class="censored">carefully</span> <span class="censored">handle</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">awkward</span> <span class="censored">corner</span> <span class="censored">cases</span> <span class="censored">around</span> <span class="censored">overflow,</span> <span class="censored">such</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::int_range<uint8_t>{.end_inclusive</uint8_t></span> <span class="censored">=</span> <span class="censored">255}</span></code><span class="censored">.</span></p> <h3 id="heap-containers"><a href="#heap-containers"><span class="censored">Heap</span> <span class="censored">Containers</span></a></h3> <p><span class="censored">Iterators</span> <span class="censored">brings</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">complex</span> <span class="censored">container</span> <span class="censored">type</span> <span class="censored">that’s</span> <span class="censored">checked</span> <span class="censored">in</span> <span class="censored">right</span> <span class="censored">now,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec</span></code><span class="censored">.</span> <span class="censored">Not</span> <span class="censored">only</span> <span class="censored">can</span> <span class="censored">you</span> <span class="censored">customize</span> <span class="censored">its</span> <span class="censored">allocator</span> <span class="censored">type,</span> <span class="censored">but</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">customize</span> <span class="censored">its</span> <span class="censored">small</span> <span class="censored">vector</span> <span class="censored">optimization</span> <span class="censored">type.</span></p> <p><span class="censored">In</span> <code class="language-plaintext highlighter-rouge"><span class="censored">libc++</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::string</span></code><span class="censored">s</span> <span class="censored">of</span> <span class="censored">at</span> <span class="censored">most</span> <span class="censored">23</span> <span class="censored">bytes</span> <span class="censored">are</span> <span class="censored">stored</span> <em><span class="censored">inline</span></em><span class="censored">,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">strings’s</span> <span class="censored">own</span> <span class="censored">storage,</span> <span class="censored">rather</span> <span class="censored">than</span> <span class="censored">heap</span> <span class="censored">storage,</span> <span class="censored">is</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">hold</span> <span class="censored">them.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec</span></code> <span class="censored">generalizes</span> <span class="censored">this,</span> <span class="censored">by</span> <span class="censored">allowing</span> <span class="censored">any</span> <span class="censored">trivially</span> <span class="censored">copyable</span> <span class="censored">type</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">inlined.</span> <span class="censored">Thus,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec<int></int></span></code> <span class="censored">will</span> <span class="censored">hold</span> <span class="censored">at</span> <span class="censored">most</span> <span class="censored">five</span> <code class="language-plaintext highlighter-rouge"><span class="censored">int</span></code><span class="censored">s</span> <span class="censored">inline,</span> <span class="censored">on</span> <span class="censored">64-bit</span> <span class="censored">targets.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::vec</span></code> <span class="censored">mostly</span> <span class="censored">copies</span> <span class="censored">the</span> <span class="censored">APIs</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::vector</span></code> <span class="censored">and</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Vec</span></code></a><span class="censored">.</span> <span class="censored">Indexing</span> <span class="censored">and</span> <span class="censored">slicing</span> <span class="censored">works</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">as</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::span</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::span</span></code> <span class="censored">operations</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">accessed</span> <span class="censored">through</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-&gt;</span></code><span class="censored">,</span> <span class="censored">allowing</span> <span class="censored">for</span> <span class="censored">things</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">my_vec-&gt;sort(...)</span></code><span class="censored">.</span></p> <p><span class="censored">I</span> <span class="censored">have</span> <span class="censored">an</span> <span class="censored">active</span> <span class="censored">(failing)</span> <span class="censored">PR</span> <span class="censored">which</span> <span class="censored">adds</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::table<k> <span class="censored">V&gt;</span></k></span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">general</span> <span class="censored">hash</span> <span class="censored">table</span> <span class="censored">implementation</span> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">as</span> <span class="censored">either</span> <span class="censored">a</span> <span class="censored">map</span> <span class="censored">or</span> <span class="censored">a</span> <span class="censored">set.</span> <span class="censored">Internally</span> <span class="censored">it’s</span> <span class="censored">backed</span> <span class="censored">by</span> <span class="censored">a</span> <span class="censored">Swisstable</span><sup id="fnref:swisstable" role="doc-noteref"><a href="#fn:swisstable" class="footnote" rel="footnote"><span class="censored">5</span></a></sup> <span class="censored">implementation.</span> <span class="censored">Its</span> <span class="censored">API</span> <span class="censored">resembles</span> <span class="censored">neither</span> <code class="language-plaintext highlighter-rouge"><span class="censored">std::unordered_map</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">absl::flat_hash_map</span></code><span class="censored">,</span> <span class="censored">or</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code class="language-plaintext highlighter-rouge"><span class="censored">HashMap</span></code></a><span class="censored">.</span> <span class="censored">Instead,</span> <span class="censored">everything</span> <span class="censored">is</span> <span class="censored">done</span> <span class="censored">through</span> <span class="censored">a</span> <span class="censored">general</span> <span class="censored">entry</span> <span class="censored">API,</span> <span class="censored">similar</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">of</span> <span class="censored">Rust,</span> <span class="censored">but</span> <span class="censored">optimized</span> <span class="censored">for</span> <span class="censored">clarity</span> <span class="censored">and</span> <span class="censored">minimizing</span> <span class="censored">hash</span> <span class="censored">lookups.</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">it</span> <span class="censored">merged</span> <span class="censored">soonish.</span></p> <p><span class="censored">Beyond</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::table</span></code><span class="censored">,</span> <span class="censored">I</span> <span class="censored">plan</span> <span class="censored">to</span> <span class="censored">add</span> <em><span class="censored">at</span> <span class="censored">least</span></em> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">containers:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::tree</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">btree</span> <span class="censored">map/set</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">similar</span> <span class="censored">API.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::heap</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">simple</span> <span class="censored">min-heap</span> <span class="censored">implementation.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::lru</span></code><span class="censored">,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::table</span></code> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">linked</span> <span class="censored">list</span> <span class="censored">running</span> <span class="censored">through</span> <span class="censored">it</span> <span class="censored">for</span> <span class="censored">in-order</span> <span class="censored">iteration</span> <span class="censored">and</span> <span class="censored">oldest-member</span> <span class="censored">eviction.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ring</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">ring</span> <span class="censored">buffer</span> <span class="censored">like</span> <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code class="language-plaintext highlighter-rouge"><span class="censored">VecDeque</span></code></a><span class="censored">.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">best::trie</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">port</span> <span class="censored">of</span> <span class="censored">my</span> <a href="https://docs.rs/twie/latest/twie/"><code class="language-plaintext highlighter-rouge"><span class="censored">twie</span></code> <span class="censored">crate</span></a><span class="censored">.</span> </li> </ul> <p><span class="censored">Possible</span> <span class="censored">other</span> <span class="censored">ideas:</span> <a href="https://research.swtch.com/sparse"><span class="censored">Russ’s</span> <span class="censored">sparse</span> <span class="censored">array</span></a><span class="censored">,</span> <span class="censored">splay</span> <span class="censored">trees,</span> <span class="censored">something</span> <span class="censored">like</span> <span class="censored">Java’s</span> <a href="https://docs.oracle.com/javase/8/docs/api/java/util/EnumMap.html"><code class="language-plaintext highlighter-rouge"><span class="censored">EnumMap</span></code></a><span class="censored">,</span> <span class="censored">bitset</span> <span class="censored">types,</span> <span class="censored">and</span> <span class="censored">so</span> <span class="censored">on.</span></p> <h3 id="text-handling"><a href="#text-handling"><span class="censored">Text</span> <span class="censored">Handling</span></a></h3> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code><span class="censored">’s</span> <span class="censored">string</span> <span class="censored">handling</span> <span class="censored">is</span> <span class="censored">intended</span> <span class="censored">to</span> <span class="censored">resemble</span> <span class="censored">Rust’s</span> <span class="censored">as</span> <span class="censored">much</span> <span class="censored">as</span> <span class="censored">possible;</span> <span class="censored">it</span> <span class="censored">lives</span> <span class="censored">within</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/text</span></code><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::rune</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">Unicode</span> <span class="censored">scalar</span> <span class="censored">type,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">such</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">is</span> <em><span class="censored">always</span></em> <span class="censored">within</span> <span class="censored">the</span> <span class="censored">valid</span> <span class="censored">range</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">Unicode</span> <span class="censored">scalar,</span> <span class="censored">but</span> <span class="censored">including</span> <span class="censored">the</span> <span class="censored">unpaired</span> <span class="censored">surrogates.</span> <span class="censored">It</span> <span class="censored">offers</span> <span class="censored">a</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">relatively</span> <span class="censored">simple</span> <span class="censored">character</span> <span class="censored">operations,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">plan</span> <span class="censored">to</span> <span class="censored">extend</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">all</span> <span class="censored">kinds</span> <span class="censored">of</span> <span class="censored">character</span> <span class="censored">classes</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">future.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::str</span></code> <span class="censored">is</span> <span class="censored">our</span> <span class="censored">replacement</span> <span class="censored">for</span> <a href="https://en.cppreference.com/w/cpp/string/basic_string_view.html"><code class="language-plaintext highlighter-rouge"><span class="censored">best::string_view</span></code></a><span class="censored">,</span> <span class="censored">close</span> <span class="censored">to</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/primitive.str.html"><code class="language-plaintext highlighter-rouge"><span class="censored">str</span></code></a><span class="censored">:</span> <span class="censored">a</span> <span class="censored">sequence</span> <span class="censored">of</span> <span class="censored">valid</span> <span class="censored">UTF-8</span> <span class="censored">bytes,</span> <span class="censored">with</span> <span class="censored">all</span> <span class="censored">kinds</span> <span class="censored">of</span> <span class="censored">string</span> <span class="censored">manipulation</span> <span class="censored">operations,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">rune</span> <span class="censored">search,</span> <span class="censored">splitting,</span> <span class="censored">indexing,</span> <span class="censored">and</span> <span class="censored">so</span> <span class="censored">on.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::rune</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::str</span></code> <span class="censored">use</span> <span class="censored">compiler</span> <span class="censored">extensions</span> <span class="censored">to</span> <span class="censored">ensure</span> <span class="censored">that</span> <span class="censored">when</span> <span class="censored">constructed</span> <span class="censored">from</span> <span class="censored">literals,</span> <span class="censored">they’re</span> <span class="censored">constructed</span> <span class="censored">from</span> <em><span class="censored">valid</span></em> <span class="censored">literals.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">won’t</span> <span class="censored">compile!</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">str</span></span> <span class="n"><span class="censored">invalid</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"</span></span><span class="se"><span class="censored">\xFF</span></span><span class="s"><span class="censored">"</span></span><span class="p"><span class="censored">;</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::str</span></code> <span class="censored">is</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::span</span></code> <span class="censored">under</span> <span class="censored">the</span> <span class="censored">hood,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">accessed</span> <span class="censored">and</span> <span class="censored">manipulated</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">way</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">underlying</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;[u8]</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;str</span></code> <span class="censored">is.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::strbuf</span></code> <span class="censored">is</span> <span class="censored">our</span> <a href="https://en.cppreference.com/w/cpp/string/basic_string.html"><code class="language-plaintext highlighter-rouge"><span class="censored">std::string</span></code></a> <span class="censored">equivalent.</span> <span class="censored">There</span> <span class="censored">isn’t</span> <span class="censored">very</span> <span class="censored">much</span> <span class="censored">to</span> <span class="censored">say</span> <span class="censored">about</span> <span class="censored">it,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">works</span> <span class="censored">just</span> <span class="censored">like</span> <span class="censored">you’d</span> <span class="censored">expect,</span> <span class="censored">and</span> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">Rust</span> <a href="https://doc.rust-lang.org/std/string/struct.String.html"><code class="language-plaintext highlighter-rouge"><span class="censored">String</span></code></a><span class="censored">-like</span> <span class="censored">API.</span></p> <p><span class="censored">Where</span> <span class="censored">this</span> <span class="censored">library</span> <span class="censored">really</span> <span class="censored">shines</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">everything</span> <span class="censored">is</span> <span class="censored">parametrized</span> <span class="censored">over</span> <span class="censored">encodings.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::str</span></code> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::text<best::utf8></best::utf8></span></code><span class="censored">;</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::str16</span></code> <span class="censored">is</span> <span class="censored">then</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::text<best::utf16></best::utf16></span></code><span class="censored">.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">write</span> <span class="censored">your</span> <span class="censored">own</span> <span class="censored">text</span> <span class="censored">encodings,</span> <span class="censored">too,</span> <span class="censored">so</span> <span class="censored">long</span> <span class="censored">as</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">relatively</span> <span class="censored">tame</span> <span class="censored">and</span> <span class="censored">you</span> <span class="censored">provide</span> <span class="censored">rune</span> <span class="censored">encode/decode</span> <span class="censored">for</span> <span class="censored">them.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::encoding</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">concept</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::text</span></code> <span class="censored">is</span> <span class="censored">always</span> <span class="censored">validly</span> <span class="censored">encoded;</span> <span class="censored">however,</span> <span class="censored">sometimes,</span> <span class="censored">that’s</span> <span class="censored">not</span> <span class="censored">possible.</span> <span class="censored">For</span> <span class="censored">this</span> <span class="censored">reason</span> <span class="censored">we</span> <span class="censored">have</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::pretext</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">“presumed</span> <span class="censored">validly</span> <span class="censored">encoded”;</span> <span class="censored">its</span> <span class="censored">operations</span> <span class="censored">can</span> <span class="censored">fail</span> <span class="censored">or</span> <span class="censored">produce</span> <span class="censored">replacement</span> <span class="censored">characters</span> <span class="censored">if</span> <span class="censored">invalid</span> <span class="censored">code</span> <span class="censored">units</span> <span class="censored">are</span> <span class="censored">found.</span> <span class="censored">There</span> <span class="censored">is</span> <span class="censored">no</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::pretextbuf</span></code><span class="censored">;</span> <span class="censored">instead,</span> <span class="censored">you</span> <span class="censored">would</span> <span class="censored">generally</span> <span class="censored">use</span> <span class="censored">something</span> <span class="censored">like</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec<uint8_t></uint8_t></span></code> <span class="censored">instead.</span></p> <p><span class="censored">Unlike</span> <span class="censored">C++,</span> <span class="censored">the</span> <span class="censored">fact</span> <span class="censored">that</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::textbuf</span></code> <span class="censored">is</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec</span></code> <span class="censored">under</span> <span class="censored">the</span> <span class="censored">hood</span> <span class="censored">is</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">public</span> <span class="censored">interface,</span> <span class="censored">allowing</span> <span class="censored">for</span> <span class="censored">cheap</span> <span class="censored">conversions</span> <span class="censored">and,</span> <span class="censored">of</span> <span class="censored">course,</span> <span class="censored">we</span> <span class="censored">get</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::vec</span></code><span class="censored">’s</span> <span class="censored">small</span> <span class="censored">vector</span> <span class="censored">optimization</span> <span class="censored">for</span> <span class="censored">free.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code> <span class="censored">provides</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">encodings</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">box:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::utf8</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::utf16</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::utf32</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::wtf8</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::ascii</span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::latin1</span></code><span class="censored">.</span></p> <h3 id="formatting"><a href="#formatting"><span class="censored">Formatting</span></a></h3> <p><code class="language-plaintext highlighter-rouge"><span class="censored">//best/text:format</span></code> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">Rust</span> <code class="language-plaintext highlighter-rouge"><span class="censored">format!()</span></code><span class="censored">-style</span> <span class="censored">text</span> <span class="censored">formatting</span> <span class="censored">library.</span> <span class="censored">It’s</span> <span class="censored">as</span> <span class="censored">easy</span> <span class="censored">as:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">str</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">format</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"my</span> <span class="censored">number:</span> <span class="censored">0x{:08x}"</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">);</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">Through</span> <span class="censored">the</span> <span class="censored">power</span> <span class="censored">of</span> <span class="censored">compiler</span> <span class="censored">extensions</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">constexpr</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">format</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">checked</span> <span class="censored">at</span> <span class="censored">compile</span> <span class="censored">time!</span></p> <p><span class="censored">The</span> <span class="censored">available</span> <span class="censored">formats</span> <span class="censored">are</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">as</span> <span class="censored">Rust’s,</span> <span class="censored">including</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{}</span></code> <span class="censored">vs</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{:?}</span></code> <span class="censored">distinction.</span> <span class="censored">But</span> <span class="censored">it’s</span> <span class="censored">actually</span> <span class="censored">way</span> <span class="censored">more</span> <span class="censored">flexible.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">use</span> <span class="censored">any</span> <span class="censored">ASCII</span> <span class="censored">letter,</span> <span class="censored">and</span> <span class="censored">types</span> <span class="censored">can</span> <span class="censored">provide</span> <span class="censored">multiple</span> <span class="censored">custom</span> <span class="censored">formatting</span> <span class="censored">schemes</span> <span class="censored">using</span> <span class="censored">letters.</span> <span class="censored">By</span> <span class="censored">convention,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">X</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b</span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">o</span></code> <span class="censored">all</span> <span class="censored">mean</span> <span class="censored">numeric</span> <span class="censored">bases.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">q</span></code> <span class="censored">will</span> <span class="censored">quote</span> <span class="censored">strings,</span> <span class="censored">runes,</span> <span class="censored">and</span> <span class="censored">other</span> <span class="censored">text</span> <span class="censored">objects;</span> <code class="language-plaintext highlighter-rouge"><span class="censored">p</span></code> <span class="censored">will</span> <span class="censored">print</span> <span class="censored">pointer</span> <span class="censored">addresses.</span></p> <p><span class="censored">The</span> <span class="censored">special</span> <span class="censored">format</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{:!}</span></code> <span class="censored">“forwards</span> <span class="censored">from</span> <span class="censored">above”;</span> <span class="censored">when</span> <span class="censored">used</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">formatting</span> <span class="censored">implementation,</span> <span class="censored">it</span> <span class="censored">uses</span> <span class="censored">the</span> <span class="censored">format</span> <span class="censored">specifier</span> <span class="censored">the</span> <span class="censored">caller</span> <span class="censored">used.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">causing</span> <span class="censored">formats</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">“passed</span> <span class="censored">through”,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">when</span> <span class="censored">printing</span> <span class="censored">lists</span> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::option</span></code><span class="censored">.</span></p> <p><span class="censored">Any</span> <span class="censored">type</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">made</span> <span class="censored">formattable</span> <span class="censored">by</span> <span class="censored">providing</span> <span class="censored">a</span> <span class="censored">friend</span> <span class="censored">template</span> <span class="censored">ADL</span> <span class="censored">extension</span> <span class="censored">(FTADLE)</span> <span class="censored">called</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BestFmt</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">analogous</span> <span class="censored">to</span> <span class="censored">implementing</span> <span class="censored">a</span> <span class="censored">trait</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">fmt::Debug</span></code> <span class="censored">in</span> <span class="censored">Rust,</span> <span class="censored">however,</span> <span class="censored">all</span> <span class="censored">formatting</span> <span class="censored">operations</span> <span class="censored">use</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">function;</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">similar</span> <span class="censored">to</span> <a href="https://pkg.go.dev/fmt#Formatter"><code class="language-plaintext highlighter-rouge"><span class="censored">fmt.Formatter</span></code></a> <span class="censored">in</span> <span class="censored">Go.</span></p> <p><span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::formatter</span></code> <span class="censored">type,</span> <span class="censored">which</span> <span class="censored">gets</span> <span class="censored">passed</span> <span class="censored">into</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BestFmt</span></code><span class="censored">,</span> <span class="censored">is</span> <span class="censored">similar</span> <span class="censored">to</span> <span class="censored">Rust’s</span> <a href="https://doc.rust-lang.org/std/fmt/struct.Formatter.html"><code class="language-plaintext highlighter-rouge"><span class="censored">Formatter</span></code></a><span class="censored">.</span> <span class="censored">Beyond</span> <span class="censored">being</span> <span class="censored">a</span> <span class="censored">sink,</span> <span class="censored">it</span> <span class="censored">also</span> <span class="censored">exposes</span> <span class="censored">information</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">specifier</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">formatting</span> <span class="censored">operation</span> <span class="censored">via</span> <code class="language-plaintext highlighter-rouge"><span class="censored">current_spec()</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">helpers</span> <span class="censored">for</span> <span class="censored">printing</span> <span class="censored">indented</span> <span class="censored">lists</span> <span class="censored">and</span> <span class="censored">blocks.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">BestFmtQuery</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">related</span> <span class="censored">FTADLE</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">called</span> <span class="censored">to</span> <span class="censored">determine</span> <span class="censored">what</span> <span class="censored">the</span> <span class="censored">valid</span> <span class="censored">format</span> <span class="censored">specifiers</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">type</span> <span class="censored">are.</span> <span class="censored">This</span> <span class="censored">allows</span> <span class="censored">the</span> <span class="censored">format</span> <span class="censored">validator</span> <span class="censored">to</span> <span class="censored">reject</span> <span class="censored">formats</span> <span class="censored">that</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">support,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">formatting</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::str</span></code> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{:x}</span></code><span class="censored">.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::format</span></code> <span class="censored">returns</span> <span class="censored">(or</span> <span class="censored">appends</span> <span class="censored">to)</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::strbuf</span></code><span class="censored">;</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::println</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::eprintln</span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">to</span> <span class="censored">stdout</span> <span class="censored">and</span> <span class="censored">stderr.</span></p> <h3 id="reflection"><a href="#reflection"><span class="censored">Reflection</span></a></h3> <p><span class="censored">Within</span> <span class="censored">the</span> <span class="censored">metaprogramming</span> <span class="censored">library,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/meta:reflect</span></code> <span class="censored">offers</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">form</span> <span class="censored">of</span> <span class="censored">reflection.</span> <span class="censored">It’s</span> <span class="censored">not</span> <span class="censored">C++26</span> <span class="censored">reflection,</span> <span class="censored">because</span> <span class="censored">that’s</span> <span class="censored">wholely</span> <span class="censored">overkill.</span> <span class="censored">Instead,</span> <span class="censored">it</span> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">method</span> <span class="censored">for</span> <span class="censored">introspecting</span> <span class="censored">the</span> <span class="censored">members</span> <span class="censored">of</span> <span class="censored">structs</span> <span class="censored">and</span> <span class="censored">enums.</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <span class="censored">suppose</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">default</span> <span class="censored">way</span> <span class="censored">of</span> <span class="censored">formatting</span> <span class="censored">arbitrary</span> <a href="https://en.cppreference.com/w/cpp/language/aggregate_initialization.html"><span class="censored">aggregate</span></a> <span class="censored">structs.</span> <span class="censored">The</span> <span class="censored">code</span> <span class="censored">for</span> <span class="censored">doing</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">devilishly</span> <span class="censored">simple:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt"><span class="censored">void</span></span> <span class="nf"><span class="censored">BestFmt</span></span><span class="p"><span class="censored">(</span></span><span class="k"><span class="censored">auto</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">fmt</span></span><span class="p"><span class="censored">,</span></span> <span class="k"><span class="censored">const</span></span> <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">is_reflected_struct</span></span> <span class="k"><span class="censored">auto</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">value</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">Reflect</span> <span class="censored">the</span> <span class="censored">type</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">struct.</span></span>
  <span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">refl</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">reflect</span></span><span class="o"><span class="censored">&lt;</span></span><span class="k"><span class="censored">decltype</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">value</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">&gt;</span></span><span class="p"><span class="censored">;</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">Start</span> <span class="censored">formatting</span> <span class="censored">a</span> <span class="censored">"record"</span> <span class="censored">(key-value</span> <span class="censored">pairs).</span></span>
  <span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">rec</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">fmt</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">record</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">refl</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">name</span></span><span class="p"><span class="censored">());</span></span>

  <span class="c1"><span class="censored">//</span> <span class="censored">For</span> <span class="censored">each</span> <span class="censored">field</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">struct...</span></span>
  <span class="n"><span class="censored">refl</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">each</span></span><span class="p"><span class="censored">([</span></span><span class="o"><span class="censored">&amp;</span></span><span class="p"><span class="censored">](</span></span><span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">field</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="c1"><span class="censored">//</span> <span class="censored">Add</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">formatting</span> <span class="censored">record...</span></span>
    <span class="n"><span class="censored">rec</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">field</span></span><span class="p"><span class="censored">(</span></span>
      <span class="n"><span class="censored">field</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">name</span></span><span class="p"><span class="censored">(),</span></span>   <span class="c1"><span class="censored">//</span> <span class="censored">...whose</span> <span class="censored">name</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">field...</span></span>
      <span class="n"><span class="censored">value</span></span><span class="o"><span class="censored">-&gt;*</span></span><span class="n"><span class="censored">field</span></span><span class="p"><span class="censored">,</span></span>  <span class="c1"><span class="censored">//</span> <span class="censored">...and</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">appropriate</span> <span class="censored">value.</span></span>
    <span class="p"><span class="censored">);</span></span>
  <span class="p"><span class="censored">});</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::reflect</span></code> <span class="censored">provides</span> <span class="censored">access</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">fields</span> <span class="censored">(or</span> <span class="censored">enum</span> <span class="censored">variants)</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">user-defined</span> <span class="censored">type</span> <span class="censored">that</span> <span class="censored">opts</span> <span class="censored">itself</span> <span class="censored">in</span> <span class="censored">by</span> <span class="censored">providing</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BestReflect</span></code> <span class="censored">FTADLE,</span> <span class="censored">which</span> <span class="censored">tells</span> <span class="censored">the</span> <span class="censored">reflection</span> <span class="censored">framework</span> <span class="censored">what</span> <span class="censored">the</span> <span class="censored">fields</span> <span class="censored">are.</span> <span class="censored">The</span> <span class="censored">simplest</span> <span class="censored">version</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">FTADLE</span> <span class="censored">looks</span> <span class="censored">like</span> <span class="censored">this:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">friend</span></span> <span class="k"><span class="censored">constexpr</span></span> <span class="k"><span class="censored">auto</span></span> <span class="nf"><span class="censored">BestReflect</span></span><span class="p"><span class="censored">(</span></span><span class="k"><span class="censored">auto</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">mirror</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">MyStruct</span></span><span class="o"><span class="censored">*</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">mirror</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">infer</span></span><span class="p"><span class="censored">();</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::mirror</span></code> <span class="censored">is</span> <span class="censored">essentially</span> <span class="censored">a</span> <span class="censored">“reflection</span> <span class="censored">builder”</span> <span class="censored">that</span> <span class="censored">offers</span> <span class="censored">fine-grained</span> <span class="censored">control</span> <span class="censored">over</span> <span class="censored">what</span> <span class="censored">reflection</span> <span class="censored">actually</span> <span class="censored">shows</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">struct.</span> <span class="censored">This</span> <span class="censored">allows</span> <span class="censored">for</span> <span class="censored">hiding</span> <span class="censored">fields,</span> <span class="censored">or</span> <span class="censored">attaching</span> <em><span class="censored">tags</span></em> <span class="censored">to</span> <span class="censored">specific</span> <span class="censored">fields,</span> <span class="censored">which</span> <span class="censored">generic</span> <span class="censored">functions</span> <span class="censored">can</span> <span class="censored">then</span> <span class="censored">introspect</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::reflected_field::tags()</span></code><span class="censored">.</span></p> <p><span class="censored">The</span> <span class="censored">functions</span> <span class="censored">on</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::reflected_type</span></code> <span class="censored">allow</span> <span class="censored">iterating</span> <span class="censored">over</span> <span class="censored">and</span> <span class="censored">searching</span> <span class="censored">for</span> <span class="censored">specific</span> <span class="censored">fields</span> <span class="censored">(or</span> <span class="censored">enum</span> <span class="censored">variants);</span> <span class="censored">these</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::reflected_field</span></code><span class="censored">s</span> <span class="censored">provide</span> <span class="censored">metadata</span> <span class="censored">about</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">(such</span> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">name)</span> <span class="censored">and</span> <span class="censored">allow</span> <span class="censored">accessing</span> <span class="censored">it,</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">syntax</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">pointer-to-member:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">value-&gt;*field</span></code><span class="censored">.</span></p> <p><span class="censored">Explaining</span> <span class="censored">the</span> <span class="censored">full</span> <span class="censored">breadth</span> <span class="censored">(and</span> <span class="censored">implementation</span> <span class="censored">tricks)</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::reflect</span></code> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">post</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">own,</span> <span class="censored">so</span> <span class="censored">I’ll</span> <span class="censored">leave</span> <span class="censored">it</span> <span class="censored">at</span> <span class="censored">that.</span></p> <h3 id="unit-tests-and-apps"><a href="#unit-tests-and-apps"><span class="censored">Unit</span> <span class="censored">Tests</span> <span class="censored">and</span> <span class="censored">Apps</span></a></h3> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">unit</span> <span class="censored">testing</span> <span class="censored">framework</span> <span class="censored">under</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/test</span></code><span class="censored">,</span> <span class="censored">like</span> <span class="censored">any</span> <span class="censored">good</span> <span class="censored">standard</span> <span class="censored">library</span> <span class="censored">should.</span> <span class="censored">To</span> <span class="censored">define</span> <span class="censored">a</span> <span class="censored">test,</span> <span class="censored">you</span> <span class="censored">define</span> <span class="censored">a</span> <span class="censored">special</span> <span class="censored">kind</span> <span class="censored">of</span> <span class="censored">global</span> <span class="censored">variable:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">test</span></span> <span class="n"><span class="censored">MyTest</span></span> <span class="o"><span class="censored">=</span></span> <span class="p"><span class="censored">[](</span></span><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">test</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">t</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">Test</span> <span class="censored">code.</span></span>
<span class="p"><span class="censored">};</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">similar</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">Go</span> <span class="censored">unit</span> <span class="censored">test,</span> <span class="censored">which</span> <span class="censored">defines</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">that</span> <span class="censored">starts</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">Test</span></code> <span class="censored">and</span> <span class="censored">takes</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*testing.T</span></code> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">argument.</span> <span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::test&amp;</span></code> <span class="censored">value</span> <span class="censored">offers</span> <span class="censored">test</span> <span class="censored">assertions</span> <span class="censored">and</span> <span class="censored">test</span> <span class="censored">failures.</span> <span class="censored">Through</span> <span class="censored">the</span> <span class="censored">power</span> <span class="censored">of</span> <span class="censored">looking</span> <span class="censored">at</span> <span class="censored">debuginfo,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">extract</span> <span class="censored">the</span> <span class="censored">name</span> <code class="language-plaintext highlighter-rouge"><span class="censored">MyTest</span></code> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">binary,</span> <span class="censored">and</span> <span class="censored">use</span> <span class="censored">that</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">name</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">test</span> <span class="censored">directly.</span></p> <p><span class="censored">That’s</span> <span class="censored">right,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">C++</span> <span class="censored">test</span> <span class="censored">framework</span> <span class="censored">with</span> <em><span class="censored">no</span> <span class="censored">macros</span> <span class="censored">at</span> <span class="censored">all</span></em><span class="censored">!</span></p> <p><span class="censored">Meanwhile,</span> <span class="censored">at</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//best/cli</span></code> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">find</span> <span class="censored">a</span> <span class="censored">robust</span> <span class="censored">CLI</span> <span class="censored">parsing</span> <span class="censored">library,</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">spirit</span> <span class="censored">of</span> <a href="https://docs.rs/clap/latest/clap/_derive/index.html"><code class="language-plaintext highlighter-rouge"><span class="censored">#[derive(clap::Parser)]</span></code></a> <span class="censored">and</span> <span class="censored">other</span> <span class="censored">similar</span> <span class="censored">Rust</span> <span class="censored">libraries.</span> <span class="censored">The</span> <span class="censored">way</span> <span class="censored">it</span> <span class="censored">works</span> <span class="censored">is</span> <span class="censored">you</span> <span class="censored">first</span> <span class="censored">define</span> <span class="censored">a</span> <span class="censored">reflectable</span> <span class="censored">struct,</span> <span class="censored">whose</span> <span class="censored">fields</span> <span class="censored">correspond</span> <span class="censored">to</span> <span class="censored">CLI</span> <span class="censored">flags.</span> <span class="censored">A</span> <span class="censored">very</span> <span class="censored">basic</span> <span class="censored">example</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">found</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">test.h</span></code><span class="censored">,</span> <span class="censored">since</span> <span class="censored">test</span> <span class="censored">binaries</span> <span class="censored">define</span> <span class="censored">their</span> <span class="censored">own</span> <span class="censored">flags:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k"><span class="censored">struct</span></span> <span class="nc"><span class="censored">test</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">flags</span></span> <span class="k"><span class="censored">final</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">vec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">strbuf</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">skip</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">vec</span></span><span class="o"><span class="censored">&lt;</span></span><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">strbuf</span></span><span class="o"><span class="censored">&gt;</span></span> <span class="n"><span class="censored">filters</span></span><span class="p"><span class="censored">;</span></span>

  <span class="k"><span class="censored">constexpr</span></span> <span class="k"><span class="censored">friend</span></span> <span class="k"><span class="censored">auto</span></span> <span class="n"><span class="censored">BestReflect</span></span><span class="p"><span class="censored">(</span></span><span class="k"><span class="censored">auto</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">m</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">flags</span></span><span class="o"><span class="censored">*</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">m</span></span><span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">infer</span></span><span class="p"><span class="censored">()</span></span>
      <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">with</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">cli</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">app</span></span><span class="p"><span class="censored">{.</span></span><span class="n"><span class="censored">about</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"a</span> <span class="censored">best</span> <span class="censored">unit</span> <span class="censored">test</span> <span class="censored">binary"</span></span><span class="p"><span class="censored">})</span></span>
      <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">with</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">flags</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">skip</span></span><span class="p"><span class="censored">,</span></span>
            <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">cli</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">flag</span></span><span class="p"><span class="censored">{</span></span>
              <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">arg</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"FILTER"</span></span><span class="p"><span class="censored">,</span></span>
              <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">help</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"Skip</span> <span class="censored">tests</span> <span class="censored">whose</span> <span class="censored">names</span> <span class="censored">contain</span> <span class="censored">FILTER"</span></span><span class="p"><span class="censored">,</span></span>
            <span class="p"><span class="censored">})</span></span>
      <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">with</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">flags</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">filters</span></span><span class="p"><span class="censored">,</span></span>
            <span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">cli</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">positional</span></span><span class="p"><span class="censored">{</span></span>
              <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">name</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"FILTERS"</span></span><span class="p"><span class="censored">,</span></span>
              <span class="p"><span class="censored">.</span></span><span class="n"><span class="censored">help</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"Include</span> <span class="censored">only</span> <span class="censored">tests</span> <span class="censored">whose</span> <span class="censored">names</span> <span class="censored">contain</span> <span class="censored">FILTER"</span></span><span class="p"><span class="censored">,</span></span>
            <span class="p"><span class="censored">});</span></span>
  <span class="p"><span class="censored">}</span></span>
<span class="p"><span class="censored">};</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">Using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::mirror::with</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">apply</span> <span class="censored">tags</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">individual</span> <span class="censored">fields</span> <span class="censored">that</span> <span class="censored">describe</span> <span class="censored">how</span> <span class="censored">they</span> <span class="censored">should</span> <span class="censored">be</span> <span class="censored">parsed</span> <span class="censored">and</span> <span class="censored">displayed</span> <span class="censored">as</span> <span class="censored">CLI</span> <span class="censored">flags.</span> <span class="censored">A</span> <span class="censored">more</span> <span class="censored">complicated,</span> <span class="censored">full-featured</span> <span class="censored">example</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">found</span> <span class="censored">at</span> <a href="https://github.com/mcy/best/blob/main/best/cli/toy_flags.h"><code class="language-plaintext highlighter-rouge"><span class="censored">toy_flags.h</span></code></a><span class="censored">,</span> <span class="censored">which</span> <span class="censored">exercises</span> <span class="censored">most</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">CLI</span> <span class="censored">parser’s</span> <span class="censored">features.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">best::parse_flags<myflags>(...)</myflags></span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">parse</span> <span class="censored">a</span> <span class="censored">particular</span> <span class="censored">flag</span> <span class="censored">struct</span> <span class="censored">from</span> <span class="censored">program</span> <span class="censored">inputs,</span> <span class="censored">independent</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">actual</span> <code class="language-plaintext highlighter-rouge"><span class="censored">argv</span></code> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">program.</span> <span class="censored">A</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::cli</span></code> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">actual</span> <span class="censored">parser</span> <span class="censored">metadata,</span> <span class="censored">but</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">generally</span> <span class="censored">user-accessible;</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">constructed</span> <span class="censored">automatically</span> <span class="censored">using</span> <span class="censored">reflection.</span></p> <p><span class="censored">Streamlining</span> <span class="censored">top-level</span> <span class="censored">app</span> <span class="censored">execution</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">done</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::app</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">fully</span> <span class="censored">replaces</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">main()</span></code> <span class="censored">function.</span> <span class="censored">Defining</span> <span class="censored">an</span> <span class="censored">app</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">similar</span> <span class="censored">to</span> <span class="censored">defining</span> <span class="censored">a</span> <span class="censored">test:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n"><span class="censored">best</span></span><span class="o"><span class="censored">::</span></span><span class="n"><span class="censored">app</span></span> <span class="n"><span class="censored">MyApp</span></span> <span class="o"><span class="censored">=</span></span> <span class="p"><span class="censored">[](</span></span><span class="n"><span class="censored">MyFlags</span></span><span class="o"><span class="censored">&amp;</span></span> <span class="n"><span class="censored">flags</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">Do</span> <span class="censored">something</span> <span class="censored">cool!</span></span>
<span class="p"><span class="censored">};</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">C++</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">will</span> <span class="censored">automatically</span> <span class="censored">record</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">inputs,</span> <span class="censored">run</span> <span class="censored">the</span> <span class="censored">flag</span> <span class="censored">parser</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">MyFlags</span></code> <span class="censored">(printing</span> <code class="language-plaintext highlighter-rouge"><span class="censored">--help</span></code> <span class="censored">and</span> <span class="censored">existing,</span> <span class="censored">when</span> <span class="censored">requested),</span> <span class="censored">and</span> <span class="censored">then</span> <span class="censored">call</span> <span class="censored">the</span> <span class="censored">body</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">lambda.</span></p> <p><span class="censored">The</span> <span class="censored">lambda</span> <span class="censored">can</span> <span class="censored">either</span> <span class="censored">return</span> <code class="language-plaintext highlighter-rouge"><span class="censored">void</span></code><span class="censored">,</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">int</span></code> <span class="censored">(as</span> <span class="censored">an</span> <span class="censored">exit</span> <span class="censored">code)</span> <span class="censored">or</span> <span class="censored">even</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::result</span></code><span class="censored">,</span> <span class="censored">like</span> <span class="censored">Rust.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::app</span></code> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">where</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">argv</span></code> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">requested</span> <span class="censored">by</span> <span class="censored">other</span> <span class="censored">parts</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">program.</span></p> <h2 id="whats-next"><a href="#whats-next"><span class="censored">What’s</span> <span class="censored">Next?</span></a></h2> <p><span class="censored">There’s</span> <span class="censored">still</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">stuff</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">add</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best</span></code><span class="censored">.</span> <span class="censored">There’s</span> <span class="censored">no</span> <span class="censored">synchronization</span> <span class="censored">primitives,</span> <span class="censored">neither</span> <span class="censored">atomics</span> <span class="censored">nor</span> <span class="censored">locks</span> <span class="censored">or</span> <span class="censored">channels.</span> <span class="censored">There’s</span> <span class="censored">no</span> <span class="censored">I/O;</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">work-in-progress</span> <span class="censored">PR</span> <span class="censored">to</span> <span class="censored">add</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::path</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::file</span></code><span class="censored">.</span> <span class="censored">I’d</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">my</span> <span class="censored">own</span> <span class="censored">math</span> <span class="censored">library,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::rc</span></code> <span class="censored">(reference-counting),</span> <span class="censored">and</span> <span class="censored">portable</span> <span class="censored">SIMD.</span> <span class="censored">There’s</span> <span class="censored">also</span> <span class="censored">some</span> <span class="censored">other</span> <span class="censored">OS</span> <span class="censored">APIs</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">build,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">signals</span> <span class="censored">and</span> <span class="censored">subprocesses.</span> <span class="censored">I</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">add</span> <span class="censored">a</span> <span class="censored">robust</span> <span class="censored">PRNG,</span> <span class="censored">time</span> <span class="censored">APIs,</span> <span class="censored">networking,</span> <span class="censored">and</span> <span class="censored">stack</span> <span class="censored">symbolization.</span></p> <p><span class="censored">Building</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">C++</span> <span class="censored">library</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">work,</span> <span class="censored">not</span> <span class="censored">the</span> <span class="censored">least</span> <span class="censored">because</span> <span class="censored">C++</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">tricky</span> <span class="censored">language</span> <span class="censored">and</span> <span class="censored">writing</span> <span class="censored">exhaustive</span> <span class="censored">tests</span> <span class="censored">is</span> <span class="censored">tedious.</span> <span class="censored">But</span> <span class="censored">it</span> <span class="censored">manages</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">C++</span> <span class="censored">fun</span> <span class="censored">for</span> <span class="censored">me</span> <span class="censored">again!</span></p> <p><span class="censored">I</span> <span class="censored">would</span> <span class="censored">love</span> <span class="censored">to</span> <span class="censored">see</span> <span class="censored">contributions</span> <span class="censored">some</span> <span class="censored">day.</span> <span class="censored">I</span> <span class="censored">don’t</span> <span class="censored">expect</span> <span class="censored">anyone</span> <span class="censored">to</span> <span class="censored">actually</span> <span class="censored">use</span> <span class="censored">this,</span> <span class="censored">but</span> <span class="censored">to</span> <span class="censored">me,</span> <span class="censored">it</span> <span class="censored">proves</span> <span class="censored">C++</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">so</span> <span class="censored">much</span> <span class="censored">better.</span></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:terrible-people" role="doc-endnote"> <p><span class="censored">They</span> <span class="censored">are</span> <span class="censored">also</span> <a href="https://patricia.no/2022/03/08/cppcon.html"><span class="censored">terrible</span> <span class="censored">people</span></a><span class="censored">. </span><a href="#fnref:terrible-people" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:jh" role="doc-endnote"> <p><span class="censored">I</span> <span class="censored">will</span> <span class="censored">grant</span> <span class="censored">that</span> <span class="censored">JeanHeyd</span> <span class="censored">has</span> <span class="censored">made</span> <span class="censored">significant</span> <span class="censored">process</span> <span class="censored">where</span> <span class="censored">many</span> <span class="censored">people</span> <span class="censored">believed</span> <span class="censored">was</span> <span class="censored">impossible.</span> <span class="censored">He</span> <span class="censored">appears</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">indomitable</span> <span class="censored">willpower</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">shōnen</span> <span class="censored">protagonist. </span><a href="#fnref:jh" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:abcl" role="doc-endnote"> <p><span class="censored">I</span> <span class="censored">have</span> <span class="censored">heard</span> <span class="censored">an</span> <span class="censored">apocryphal</span> <span class="censored">story</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">namespace</span> <span class="censored">was</span> <span class="censored">going</span> <span class="censored">to</span> <span class="censored">be</span> <code class="language-plaintext highlighter-rouge"><span class="censored">abc</span></code> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">abcl</span></code><span class="censored">,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">was</span> <span class="censored">“Alphabet’s</span> <span class="censored">library”.</span> <span class="censored">This</span> <span class="censored">name</span> <span class="censored">was</span> <span class="censored">ultimately</span> <span class="censored">shot</span> <span class="censored">down</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">office</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">CEO,</span> <span class="censored">or</span> <span class="censored">so</span> <span class="censored">the</span> <span class="censored">legend</span> <span class="censored">goes. </span><a href="#fnref:abcl" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:interval" role="doc-endnote"> <p><span class="censored">This</span> <span class="censored">may</span> <span class="censored">get</span> <span class="censored">renamed</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::interval</span></code> <span class="censored">or</span> <span class="censored">even</span> <code class="language-plaintext highlighter-rouge"><span class="censored">best::range</span></code> <span class="censored">We’ll</span> <span class="censored">see! </span><a href="#fnref:interval" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:swisstable" role="doc-endnote"> <p><span class="censored">The</span> <span class="censored">fourth</span> <span class="censored">time</span> <span class="censored">I’ve</span> <span class="censored">written</span> <span class="censored">one</span> <span class="censored">in</span> <span class="censored">my</span> <span class="censored">career,</span> <span class="censored">lmao.</span> <span class="censored">I</span> <span class="censored">also</span> <span class="censored">wrote</span> <span class="censored">a</span> <a href="https://github.com/google/cwisstable"><span class="censored">C</span> <span class="censored">implementation</span></a> <span class="censored">at</span> <span class="censored">one</span> <span class="censored">point.</span> <span class="censored">My</span> <span class="censored">friend</span> <span class="censored">Matt</span> <span class="censored">has</span> <span class="censored">an</span> <a href="https://www.youtube.com/watch?v=ncHmEUmJZf4"><span class="censored">excellent</span> <span class="censored">introduction</span></a> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">Swisstable</span> <span class="censored">data</span> <span class="censored">structure. </span><a href="#fnref:swisstable" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-07-16</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/16/hyperpb/"><span class="censored">Parsing</span> <span class="censored">Protobuf</span> <span class="censored">Like</span> <span class="censored">Never</span> <span class="censored">Before</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-07</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/07/nosplit/"><span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-06-03</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#7:</span> <span class="censored">Scoping</span> <span class="censored">It</span> <span class="censored">Out</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>