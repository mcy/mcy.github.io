<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Parsing Protobuf Like Never Before &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Parsing Protobuf Like Never Before &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/hyperpb-23d8f7a5667146c8fdc57dcae631df9498d017c0.png"> <meta property="og:title" content="Parsing Protobuf Like Never Before &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/hyperpb-23d8f7a5667146c8fdc57dcae631df9498d017c0.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/07/16/hyperpb/"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-07-16 • 4119 words • 45 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#go">#go</a> • <a href="https://mcyoung.xyz/tags.html#dark-arts">#dark-arts</a> • <a href="https://mcyoung.xyz/tags.html#protobuf">#protobuf</a> </span> <h1><a href="/2025/07/16/hyperpb/"> Parsing Protobuf Like Never Before </a></h1> </div> <div class="post"> <p>Historically I have worked on many projects related to high-performance Protobuf, be that on the C++ runtime, on the Rust runtime, or on integrating <a href="https://github.com/protocolbuffers/protobuf/tree/main/upb">UPB</a>, the fastest Protobuf runtime, written by my colleague <a href="https://blog.reverberate.org/2021/04/21/musttail-efficient-interpreters.html">Josh Haberman</a>. I <em>generally</em> don’t post directly about my current job, but my most recent toy-turned-product is something I’m very excited to write about: <a href="https://github.com/bufbuild/hyperpb-go"><code class="language-plaintext highlighter-rouge">hyperpb</code></a>.</p> <p>Here’s how we measure up against other Go Protobuf parsers. This is a subset of my benchmarks, since the benchmark suite contains many dozens of specimens. This was recorded on an AMD Zen 4 machine.</p> <figure style="max-width: 95%;"> <p><img src="https://mcyoung.xyz/public/images/hyperpb/benches.svg" alt=""/></p> <figcaption> <p>Throughput for various configurations of <code class="language-plaintext highlighter-rouge">hyperpb</code> (colored bars) vs. competing parsers (grey bars). Each successive <code class="language-plaintext highlighter-rouge">hyperpb</code> includes all previous optimizations, corresponding to <a href="#zerocopy-strings">zerocopy mode</a>, <a href="#arena-reuse">arena reuse</a>, and <a href="#tdptype">profile-guided optimization</a>. Bigger is better.</p> </figcaption> </figure> <p>Traditionally, Protobuf backends would generate parsers by generating source code specialized to each type. Naively, this would give the best performance, because everything would be “right-sized” to a particular message type. Unfortunately, now that we know better, there are a bunch of drawbacks:</p> <ol> <li>Every type you care about must be compiled ahead-of-time. Tricky for when you want to build something generic over schemas your users provide you.</li> <li>Every type contributes to a cost on the instruction cache, meaning that if your program parses a lot of different types, it will essentially flush your instruction cache any time you enter a parser. Worse still, if a parse involves enough types, the parser itself will hit instruction decoding throughput issues.</li> </ol> <p>These effects are not directly visible in normal workloads, but other side-effects are visible: for example, giant switches on field numbers can turn into chains of branch instructions, meaning that higher-numbered fields will be quite slow. Even binary-searching on field numbers isn’t exactly ideal. However, we know that every Protobuf codec ever emits fields in index order (i.e., declaration order in the <code class="language-plaintext highlighter-rouge">.proto</code> file), which is a data conditioning fact we don’t take advantage of with a switch.</p> <p>UPB solves this problem. It is a small C kernel for parsing Protobuf messages, which is completely dynamic: a UPB “parser” is actually a collection of data tables that are evaluated by a <em>table-driven parser</em>. In other words, a UPB parser is actually configuration for an interpreter VM, which executes Protobuf messages as its bytecode. UPB also contains many arena optimizations to improve allocation throughput when parsing complex messages.</p> <p><code class="language-plaintext highlighter-rouge">hyperpb</code> is a brand new library, written in the most cursed Go imaginable, which brings many of the optimizations of UPB to Go, and many new ones, while being tuned to Go’s own weird needs. The result leaves the competition in the dust in virtually every benchmark, while being completely runtime-dynamic. This means it’s faster than Protobuf Go’s own generated code, <em>and</em> <a href="https://github.com/planetscale/vtprotobuf"><code class="language-plaintext highlighter-rouge">vtprotobuf</code></a> (a popular but non-conforming<sup id="fnref:vtproto" role="doc-noteref"><a href="#fn:vtproto" class="footnote" rel="footnote">1</a></sup> parser generator for Go).</p> <p>This post is about some of the internals of <code class="language-plaintext highlighter-rouge">hyperpb</code>. I have also prepared a more sales-ey writeup, which you can read on <a href="https://buf.build/blog/introducing-hyperpb">the Buf blog</a>.</p> <h2 id="why-reinvent-upb"><a href="#why-reinvent-upb">Why Reinvent UPB?</a></h2> <p>UPB is awesome. It can slot easily into any language that has C FFI, which is basically every language ever.</p> <p>Unfortunately, Go’s C FFI is really, really bad. It’s hard to overstate how bad cgo is. There isn’t a good way to cooperate with C on memory allocation (C can’t really handle Go memory without a lot of problems, due to the GC). Having C memory get cleaned up by the GC requires finalizers, which are very slow. Calling into C is very slow, because Go pessimistically assumes that C requires a large stack, and also calling into C does nasty things to the scheduler.</p> <p>All of these things can be worked around, of course. For a while I considered compiling UPB to assembly, and rewriting that assembly into Go’s awful assembly syntax<sup id="fnref:go-asm" role="doc-noteref"><a href="#fn:go-asm" class="footnote" rel="footnote">2</a></sup>, and then having Go assemble UPB out of that. This presents a few issues though, particularly because Go’s assembly calling convention is still in the stone age<sup id="fnref:abi0" role="doc-noteref"><a href="#fn:abi0" class="footnote" rel="footnote">3</a></sup> (arguments are passed on the stack), and because we would still need to do a lot of work to get UPB to match the <code class="language-plaintext highlighter-rouge">protoreflect</code> API.</p> <p>Go also has a few… unique qualities that make writing a Protobuf interpreter an interesting challenge with <em>exciting</em> optimization opportunities.</p> <p>First, of course, is the register ABI, which on <code class="language-plaintext highlighter-rouge">x86_64</code> gives us a whopping <em>nine</em> argument and return registers, meaning that we can simply pass the entire parser state in registers all the time.</p> <p>Second is that Go does not have much UB to speak of, so we can get away with a lot of very evil pointer crimes that we could not in C++ or Rust.</p> <p>Third is that Protobuf Go has a robust reflection system that we can target if we design specifically for it.</p> <p>Also, the Go ecosystem seems much more tolerant of less-than-ideal startup times (because the language <em>loves</em> life-before-main due to <code class="language-plaintext highlighter-rouge">init()</code> functions), so unlike UPB, we can require that the interpreter’s program be generated at runtime, meaning that we can design for online PGO. In other words, we have the perfect storm to create the first-ever Protobuf JIT compiler (which we also refer to as “online PGO” or “real-time PGO”).</p> <h2 id="hyperpbs-api"><a href="#hyperpbs-api">hyperpb’s API</a></h2> <p>Right now, <code class="language-plaintext highlighter-rouge">hyperpb</code>’s API is very simple. There are <code class="language-plaintext highlighter-rouge">hyperpb.Compile*</code> functions that accept some representation of a message descriptor, and return a <code class="language-plaintext highlighter-rouge">*hyperpb.MessageType</code>, which implements the <code class="language-plaintext highlighter-rouge">protoreflect</code> type APIs. This can be used to allocate a new <code class="language-plaintext highlighter-rouge">*hyperpb.Message</code> , which you can shove into <code class="language-plaintext highlighter-rouge">proto.Unmarshal</code> and do reflection on the result. However, you can’t mutate <code class="language-plaintext highlighter-rouge">*hyperpb.Message</code>s currently, because the main use-cases I am optimizing for are read-only. All mutations panic instead.</p> <p>The hero use-case, using Buf’s <code class="language-plaintext highlighter-rouge">protovalidate</code> library, uses reflection to execute validation predicates. It looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c">// Compile a new message type, deserializing an encoded FileDescriptorSet.</span>
<span class="n">msgType</span> <span class="o">:=</span> <span class="n">hyperpb</span><span class="o">.</span><span class="n">CompileForBytes</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="s">"my.api.v1.Request"</span><span class="p">)</span>

<span class="c">// Allocate a new message of that type.</span>
<span class="n">msg</span> <span class="o">:=</span> <span class="n">hyperpb</span><span class="o">.</span><span class="n">NewMessage</span><span class="p">(</span><span class="n">msgType</span><span class="p">)</span>

<span class="c">// Unmarshal like you would any other message, using proto.Unmarshal.</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// Handle parse failure.</span>
<span class="p">}</span>

<span class="c">// Validate the message. Protovalidate uses reflection, so this Just Works.</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">protovalidate</span><span class="o">.</span><span class="n">Validate</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// Handle validation failure.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>We tell users to make sure to cache the compilation step because compilation can be arbitrarily slow: it’s an optimizing compiler! This is not unlike the same warning on <code class="language-plaintext highlighter-rouge">regexp.Compile</code>, which makes it easy to teach users how to use this API correctly.</p> <p>In addition to the main API, there’s a bunch of performance tuning knobs for the compiler, for unmarshaling, and for recording profiles. Types can be recompiled using a recorded profile to be more optimized for the kinds of messages that actually come on the wire. <code class="language-plaintext highlighter-rouge">hyperpb</code> PGO<sup id="fnref:go-pgo" role="doc-noteref"><a href="#fn:go-pgo" class="footnote" rel="footnote">4</a></sup> affects a number of things that we’ll get into as I dive into the implementation details.</p> <h2 id="the-guts"><a href="#the-guts">The Guts</a></h2> <p>Most of the core implementation lives under <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/tdp"><code class="language-plaintext highlighter-rouge">internal/tdp</code></a>. The main components are as follows:</p> <ol> <li><code class="language-plaintext highlighter-rouge">tdp</code>, which defines the “object code format” for the interpreter. This includes definitions for describing types and fields to the parser.</li> <li><code class="language-plaintext highlighter-rouge">tdp/compiler</code>, which contains all of the code for converting a <code class="language-plaintext highlighter-rouge">protoreflect.MessageDescriptor</code> into a <code class="language-plaintext highlighter-rouge">tdp.Library</code>, which contains all of the types relevant to a particular parsing operation.</li> <li><code class="language-plaintext highlighter-rouge">tdp/dynamic</code> defines what dynamic message types look like. The compiler does a bunch of layout work that gets stored in <code class="language-plaintext highlighter-rouge">tdp.Type</code> values, which a <code class="language-plaintext highlighter-rouge">dynamic.Message</code> interprets to find the offsets of fields within itself.</li> <li><code class="language-plaintext highlighter-rouge">tdp/vm</code> contains the core interpreter implementation, including the VM state that is passed in registers everywhere. It also includes hand-optimized routines for parsing varints and validating UTF-8.</li> <li><code class="language-plaintext highlighter-rouge">tdp/thunks</code> defines <em>archetypes</em>, which are classes of fields that all use the same layout and parsers. This corresponds roughly to a <code class="language-plaintext highlighter-rouge">(presence, kind)</code> pair, but not exactly. There are around 200 different archetypes.</li> </ol> <p>This article won’t be a deep-dive into everything in the parser, and even this excludes large portions of <code class="language-plaintext highlighter-rouge">hyperpb</code>. For example, the <a href="https://mcyoung.xyz/2025/04/21/go-arenas/"><code class="language-plaintext highlighter-rouge">internal/arena</code></a> package is already described in a different blogpost of mine. I recommend taking a look at that to learn about how we implement a GC-friendly arena for <code class="language-plaintext highlighter-rouge">hyperpb</code> .</p> <p>Instead, I will give a brief overview of how the object code is organized and how the parser interprets it. I will also go over a few of the more interesting optimizations we have.</p> <h3 id="tdptype"><a href="#tdptype">tdp.Type</a></h3> <p>Every <code class="language-plaintext highlighter-rouge">MessageDescriptor</code> that is reachable from the root message (either as a field or as an extension) becomes a <code class="language-plaintext highlighter-rouge">tdp.Type</code> . This contains the dynamic size of the corresponding message type, a pointer to the type’s default parser (there can be more than one parser for a type) and a variable number of <code class="language-plaintext highlighter-rouge">tdp.Field</code> values. These specify the offset of each field and provide accessor thunks, for actually extracting the value of the field.</p> <p>A <code class="language-plaintext highlighter-rouge">tdp.TypeParser</code> is what the parser VM interprets alongside encoded Protobuf data. It contains all of the information needed for decoding a message in compact form, including <code class="language-plaintext highlighter-rouge">tdp.FieldParser</code>s for each of its fields (and extensions), as well as a hashtable for looking up a field by tag, which is used by the VM as a fallback.</p> <p>The <code class="language-plaintext highlighter-rouge">tdp.FieldParser</code>s each contain:</p> <ol> <li>The same offset information as a <code class="language-plaintext highlighter-rouge">tdp.Field</code>.</li> <li>The field’s tag, in a special format.</li> <li>A function pointer that gets called to parse the field.</li> <li>The next field(s) to try parsing after this one is parsed.</li> </ol> <p>Each <code class="language-plaintext highlighter-rouge">tdp.FieldParser</code> actually corresponds to a possible tag on a record for this message. Some fields have multiple different tags: for example, a <code class="language-plaintext highlighter-rouge">repeated int32</code> can have a <code class="language-plaintext highlighter-rouge">VARINT</code>-type tag for the repeated representation, and a <code class="language-plaintext highlighter-rouge">LEN</code>-type tag for the packed representation.</p> <p>Each field specifies which fields to try next. This allows the compiler to perform <em>field scheduling</em>, by carefully deciding which order to try fields in based both on their declaration order and a rough estimation of their “hotness”, much like branch scheduling happens in a program compiler. This avoids almost all of the work of looking up the next field in the common case, because we have already pre-loaded the correct guess.</p> <p>I haven’t managed to nail down a good algorithm for this yet, but I am working on a system for implementing a type of “branch prediction” for PGO, that tries to provide better predictions for the next fields to try based on what has been seen before.</p> <p>The offset information for a field is more than just a memory offset. A <code class="language-plaintext highlighter-rouge">tdp.Offset</code> includes a bit offset, for fields which request allocation of individual bits in the message’s bitfields. These are used to implement the hasbits of <code class="language-plaintext highlighter-rouge">optional</code> fields (and the values of <code class="language-plaintext highlighter-rouge">bool</code> fields). It also includes a byte offset for larger storage. However, this byte offset can be negative, in which case it’s actually an offset into the <em>cold region</em>.</p> <p>In many messages, most fields won’t be set, particularly extensions. But we would like to avoid having to allocate memory for the very rare (i.e., “cold”) fields. For this, a special “cold region” exists in a separate allocation from the main message, which is referenced via a compressed pointer. If a message happens to need a cold field set, it takes a slow path to allocate a cold region only if needed. Whether a field is cold is a dynamic property that can be affected by PGO.</p> <h3 id="the-parser-vm"><a href="#the-parser-vm">The Parser VM</a></h3> <p>The parser is designed to make maximal use of Go’s generous ABI without spilling anything to the stack that isn’t absolutely necessary. The parser state consists of eight 64-bit integers, split across two types: <code class="language-plaintext highlighter-rouge">vm.P1</code> and <code class="language-plaintext highlighter-rouge">vm.P2</code>. Unfortunately, these can’t be merged due to a <a href="https://github.com/golang/go/issues/72897">compiler bug</a>, as documented in <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/tdp/vm/vm.go#L50"><code class="language-plaintext highlighter-rouge">vm/vm.go</code></a>.</p> <p>Every parser function takes these two structs as its first two arguments, and returns them as its first two results. This ensures that register allocation tries its darnedest to keep those eight integers in the first eight argument registers, even across calls. This leads to the common idiom of</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">var</span> <span class="n">n</span> <span class="kt">int</span>
<span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">DoSomething</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Overwriting the parser state like this ensures that future uses of p1 and p2 use the values that <code class="language-plaintext highlighter-rouge">DoSomething</code> places in registers for us.</p> <p>I spent a lot of time and a lot of profiling catching all of the places where Go would incorrectly spill parser state to the stack, which would result in stalls. I found quite a few codegen bugs in the process. Particularly notable (and shocking!) is <a href="https://github.com/golang/go/issues/73589">#73589</a>. Go has somehow made it a decade without a very basic pointer-to-SSA lifting pass (for comparison, this is a heavy-lifting cleanup pass (<code class="language-plaintext highlighter-rouge">mem2reg</code>) in LLVM).</p> <p>The core loop of the VM goes something like this:</p> <ol> <li>Are we out of bytes to parse? If so, pop a parser stack frame<sup id="fnref:stack" role="doc-noteref"><a href="#fn:stack" class="footnote" rel="footnote">5</a></sup>. If we popped the last stack frame, parsing is done; return success.</li> <li>Parse a tag. This does not fully decode the tag, because <code class="language-plaintext highlighter-rouge">tdp.FieldParser</code>s contain a carefully-formatted, partially-decoded tag to reduce decoding work.</li> <li>Check if the next field we would parse matches the tag. <ol> <li>If yes, call the function pointer <code class="language-plaintext highlighter-rouge">tdp.Field.Parser</code>; update the current field to <code class="language-plaintext highlighter-rouge">tdp.Field.NextOk</code>; goto 1.</li> <li>If no, update the current field to <code class="language-plaintext highlighter-rouge">tdp.Field.NextErr</code>; goto 3.</li> <li>If no “enough times”, fall through.</li> </ol> </li> <li>Slow path: hit <code class="language-plaintext highlighter-rouge">tdp.Field.Tags</code> to find the matching field for that tag. <ol> <li>If matched, go to 3a.</li> <li>If not, this is an unknown field; put it into the unknown field set; parse a tag and goto 4.</li> </ol> </li> </ol> <p>Naturally, this is implemented as a single function whose control flow consists exclusively of <code class="language-plaintext highlighter-rouge">if</code>s and <code class="language-plaintext highlighter-rouge">goto</code>s, because getting Go to generate good control flow otherwise proved too hard.</p> <p>Now, you might be wondering why the hot loop for the parser includes <strong>calling a virtual function</strong>. Conventional wisdom holds that virtual calls are slow. After all, the actual virtual call instruction is quite slow, because it’s an indirect branch, meaning that it can easily stall the CPU. However, it’s actually <em>much faster than the alternatives</em> in this case, due to a few quirks of our workload and how modern CPUs are designed:</p> <ol> <li>Modern CPUs are not <em>great</em> at traversing complex “branch mazes”. This means that selecting one of ~100 alternatives using branches, even if they are well-predicted and you use unrolled binary search, is still likely to result in frequent mispredictions, and is an obstacle to other JIT optimizations in the processor’s backend.</li> <li>Predicting a single indirect branch with dozens of popular targets <em>is</em> something modern CPUs are pretty good at. Chips and Cheese have a <a href="https://chipsandcheese.com/i/138977313/indirect-branch-prediction">great writeup</a> on the indirect prediction characteristics of Zen 4 chips.</li> </ol> <p>In fact, the “optimized” form of a large switch is a jump table, which is essentially an array of function pointers. Rather than doing a large number of comparisons and direct branches, a jump table turns a switch into a load and an indirect branch.</p> <p>This is great news for us, because it means we can make use of a powerful assumption about most messages: most messages only feature a handful of field archetypes. How often is it that you see a message which has more in it than <code class="language-plaintext highlighter-rouge">int32</code>, <code class="language-plaintext highlighter-rouge">int64</code>, <code class="language-plaintext highlighter-rouge">string</code> , and submessages? In effect, this allows us to have a very large “instruction set”, consisting of all of the different field archetypes, but a particular message only pays for what it uses. The fewer archetypes it uses <em>at runtime</em>, the better the CPU can predict this indirect jump.</p> <p>On the other hand, we can just keep adding archetypes over time to specialize for common parse workloads, which PGO can select for. Adding new archetypes that are not used by most messages does not incur a performance penalty.</p> <h2 id="other-optimizations"><a href="#other-optimizations">Other Optimizations</a></h2> <p>We’ve already discussed the hot/cold split, and briefly touched on the message bitfields used for <code class="language-plaintext highlighter-rouge">bool</code>s and hasbits. I’d like to mention a few other cool optimizations that help cover all our bases, as far as high-performance parsing does.</p> <h3 id="zerocopy-strings"><a href="#zerocopy-strings">Zerocopy Strings</a></h3> <p>The fastest <code class="language-plaintext highlighter-rouge">memcpy</code> implementation is the one you don’t call. For this reason, we try to, whenever possible, avoid copying anything out of the input buffer. <code class="language-plaintext highlighter-rouge">string</code>s and <code class="language-plaintext highlighter-rouge">bytes</code> are represented as <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/zc/zc.go"><code class="language-plaintext highlighter-rouge">zc.Range</code>s</a>, which are a packed pair of offset+length in a <code class="language-plaintext highlighter-rouge">uint64</code>. Protobuf is not able to handle lengths greater than 2GB properly, so we can assume that this covers all the data we could ever care about. This means that a <code class="language-plaintext highlighter-rouge">bytes</code> field is 8 bytes, rather than 24, in our representation.</p> <p>Zerocopy is also used for packed fields. For example, a <code class="language-plaintext highlighter-rouge">repeated double</code> will typically be encoded as a <code class="language-plaintext highlighter-rouge">LEN</code> record. The number of <code class="language-plaintext highlighter-rouge">float64</code>s in this record is equal to its length divided by 8, and the <code class="language-plaintext highlighter-rouge">float64</code>s are already encoded in IEEE754 format for us. So we can just retain the whole repeated fields as a <code class="language-plaintext highlighter-rouge">zc.Range</code> . Of course, we need to be able to handle cases where there are multiple disjoint records, so the backing <a href="https://github.com/bufbuild/hyperpb-go/blob/main/internal/tdp/repeated/scalars.go"><code class="language-plaintext highlighter-rouge">repeated.Scalars</code></a> can also function as a 24-byte arena slice. Being able to switch between these modes gracefully is a delicate and carefully-tested part of the repeated field thunks.</p> <p>Surprisingly, we also use zerocopy for varint fields, such as <code class="language-plaintext highlighter-rouge">repeated int32</code>. Varints are variable-length, so we can’t just index directly into the packed buffer to get the <code class="language-plaintext highlighter-rouge">n</code> th element… unless all of the elements happen to be the same size. In the case that every varint is one byte (so, between 0 and 127), we can zerocopy the packed field. This is a relatively common scenario, too, so it results in big savings<sup id="fnref:rep-benches" role="doc-noteref"><a href="#fn:rep-benches" class="footnote" rel="footnote">6</a></sup>. We <em>already</em> count the number of varints in the packed field in order to preallocate space for it, so this doesn’t add extra cost. This counting is very efficient because I have manually vectorized the loop.</p> <h3 id="repeated-preloads"><a href="#repeated-preloads">Repeated Preloads</a></h3> <p>PGO records the median size of each repeated/map field, and that is used to calculate a “preload” for each repeated field. Whenever the field is first allocated, it is pre-allocated using the preload to try to right-size the field with minimal waste.</p> <p>Using the median ensures that large outliers don’t result in huge memory waste; instead, this guarantees that at least 50% of repeated fields will only need to allocate from the arena once. Packed fields don’t use the preload, since in the common case only one record appears for packed fields. This mostly benefits string- and message-typed repeated fields, which can’t be packed.</p> <h3 id="map-optimizations"><a href="#map-optimizations">Map Optimizations</a></h3> <p>We don’t use Go’s built-in map, because it has significant overhead in some cases: in particular, it has to support Go’s mutation-during-iteration semantics, as well as deletion. Although both are Swisstables<sup id="fnref:map-benches" role="doc-noteref"><a href="#fn:map-benches" class="footnote" rel="footnote">7</a></sup> under the hood, my implementation can afford to take a few shortcuts. It also allows our implementation to use arena-managed memory. <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/swiss/table.go"><code class="language-plaintext highlighter-rouge">swiss.Table</code>s</a> are used both for the backing store of <code class="language-plaintext highlighter-rouge">map</code> fields, and for maps inside of <code class="language-plaintext highlighter-rouge">tdp.Type</code>s.</p> <p>Currently, the hash used is the variant of <a href="https://github.com/rust-lang/rustc-hash">fxhash used by the Rust compiler</a>. This greatly out-performs Go’s <a href="https://pkg.go.dev/hash/maphash">maphash</a> for integers, but maphash is better for larger strings. I hope to maybe switch to maphash at some point for large strings, but it hasn’t been a priority.</p> <h3 id="arena-reuse"><a href="#arena-reuse">Arena Reuse</a></h3> <p>Hitting the Go allocator is always going to be a little slow, because it’s a general-case allocator. Ideally, we should learn the estimated memory requirements for a particular workload, and then allocate a single block of that size for the arena to portion out.</p> <p>The best way to do this is via <em>arena reuse</em> In the context of a service, each request has a bounded lifetime on the message that it parses. Once that lifetime is over (the request is complete), the message is discarded. This gives the programmer an opportunity to <em>reset</em> the backing arena, so that it keeps its largest memory block for re-allocation.</p> <p>You can show that over time, this will cause the arena to never hit the Go allocator. If the largest block is too small for a message, a block twice as large will wind up getting allocated. Messages that use the same amount of memory will keep doubling the largest block, until the largest block is large enough to fit the whole message. Memory usage will be at worst 2x the size of this message. Note that, thanks to extensive use of zero-copy optimizations, we can often avoid allocating memory for large portions of the message.</p> <p>Of course, arena re-use poses a memory safety danger, if the previously allocated message is kept around after the arena is reset. For this reason, it’s not the default behavior. Using arena resets is a double-digit percentage improvement, however.</p> <h3 id="oneof-unions"><a href="#oneof-unions">Oneof Unions</a></h3> <p>Go does not properly support unions, because the GC does not keep the necessary book-keeping to distinguish a memory location that may be an integer <em>or</em> a pointer at runtime. Instead, this gets worked around using interfaces, which is always a pointer to some memory. Go’s GC can handle untyped pointers just fine, so this just works.</p> <p>The generated API for Protobuf Go uses interface values for <code class="language-plaintext highlighter-rouge">oneof</code>s. This API is… pretty messy to use, unfortunately, and triggers unnecessary allocations, (much like <code class="language-plaintext highlighter-rouge">optional</code> fields do in the open API).</p> <p>However, my arena design (<a href="https://mcyoung.xyz/2025/04/21/go-arenas/">read about it here</a>) makes it possible to store arena pointers on the arena as if they are integers, since the GC does not need to scan through arena memory. Thus, our <code class="language-plaintext highlighter-rouge">oneof</code>s are true unions, like in C++.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p><code class="language-plaintext highlighter-rouge">hyperpb</code> is really exciting because its growing JIT capabilities offer an improvement in the state of the art over UPB. It’s also been a really fun challenge working around Go compiler bugs to get the best assembly possible. The code is already so well-optimized that re-building the benchmarks with the Go compiler’s own PGO mode (based on a profile collected from the benchmarks) didn’t really seem to move the needle!</p> <p>I’m always working on making <code class="language-plaintext highlighter-rouge">hyperpb</code> better (I get paid for it!) and I’m always excited to try new optimizations. If you think of something, file an issue! I have meticulously commented most things within <code class="language-plaintext highlighter-rouge">hyperpb</code> , so it should be pretty easy to get an idea of where things are if you want to contribute.</p> <p>I would like to write more posts diving into some of the weeds of the implementation. I can’t promise anything, but there’s lots to talk about. For now… have fun source-diving!</p> <p>There’s a lot of other things we could be doing: for example, we could be using SIMD to parse varints, we could have smarter parser scheduling, we could be allocating small submessages inline to improve locality… there’s still so much we can do!</p> <p>And most importantly, I hope you’ve learned something new about performance optimization!</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:vtproto" role="doc-endnote"> <p>vtprotobuf gets <em>a lot</em> of things wrong that make it beat us in like two benchmarks, because it’s <em>so</em> sloppy. For example, vtprotobuf believes that it’s ok to not validate UTF-8 strings. This is <em>non-conforming</em> behavior. It also believes that map entries’ fields are always in order and always populated, meaning that valid Protobuf messages containing maps can be parsed <em>incorrectly</em>. This sloppiness is unacceptable, which is why <code class="language-plaintext highlighter-rouge">hyperpb</code> goes to great lengths to implement all of Protobuf correctly. <a href="#fnref:vtproto" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:go-asm" role="doc-endnote"> <p>Never gonna let Rob live that one down. Of all of Rob’s careless design decisions, the assembler is definitely one of the least forgivable ones. <a href="#fnref:go-asm" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:abi0" role="doc-endnote"> <p>There are only really two pieces of code in <code class="language-plaintext highlighter-rouge">hyperpb</code> that could benefit from hand-written assembly: varint decoding and UTF-8 validation. Both of these vectorize well, however, <code class="language-plaintext highlighter-rouge">ABI0</code> is so inefficient that no hand-written implementation will be faster.</p> <p>If I do wind up doing this, it will require a build tag like <code class="language-plaintext highlighter-rouge">hyperasm</code>, along with something like <code class="language-plaintext highlighter-rouge">-gcflags=buf.build/go/hyperpb/internal/asm/...=-+</code> to treat the assembly implementations as part of the Go runtime, allowing the use of <code class="language-plaintext highlighter-rouge">ABIInternal</code>. But even then, this only speeds up parsing of large (&gt;2 byte) varints. <a href="#fnref:abi0" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:go-pgo" role="doc-endnote"> <p>This is PGO performed by <code class="language-plaintext highlighter-rouge">hyperpb</code> itself; this is unrelated to <code class="language-plaintext highlighter-rouge">gc</code>’s own PGO mode, which seems to not actually make <code class="language-plaintext highlighter-rouge">hyperpb</code> faster. <a href="#fnref:go-pgo" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:stack" role="doc-endnote"> <p>Yes, the parser manages its own stack separate from the goroutine stack. This ensures that nothing in the parser has to be reentrant. The only time the stack is pushed to is when we “recurse” into a submessage. <a href="#fnref:stack" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:rep-benches" role="doc-endnote"> <p>Large packed repeated fields are where the biggest wins are for us. Being able to zero-copy large packed <code class="language-plaintext highlighter-rouge">int32</code> fields full of small values allows us to eliminate all of the overhead that the other runtimes are paying for; we also choose different parsing strategies depending on the byte-to-varint ratio of the record.</p> <figure style="max-width: 95%;"> <p><img src="https://mcyoung.xyz/public/images/hyperpb/repeated.svg" alt=""/></p> <figcaption> <p>Throughput for various repeated field benchmarks. This excludes the <code class="language-plaintext highlighter-rouge">repeated fixed32</code> benchmarks, since those achieve such high throughputs (~20 Gbps) that they make the chart unreadable.</p> </figcaption> </figure> <p>These optimizations account for the performance difference between <code class="language-plaintext highlighter-rouge">descriptor/#00</code> and <code class="language-plaintext highlighter-rouge">descriptor/#01</code> in the first benchmark chart. The latter is a <code class="language-plaintext highlighter-rouge">FileDescriptorSet</code> containing <code class="language-plaintext highlighter-rouge">SourceCodeInfo</code>, Protobuf’s janky debuginfo format. It is dominated by <code class="language-plaintext highlighter-rouge">repeated int32</code> fields.</p> <p>NB: This chart is currently missing the Y-axis, I need to have it re-made. <a href="#fnref:rep-benches" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:map-benches" role="doc-endnote"> <p>Map parsing performance has been a bit of a puzzle. <code class="language-plaintext highlighter-rouge">vtprotobuf</code> cheats by rejecting some valid map entry encodings, such as (in Protoscope) <code class="language-plaintext highlighter-rouge">{1: {"key"}}</code> (value is implied to be <code class="language-plaintext highlighter-rouge">""</code>), while mis-parsing others, such as <code class="language-plaintext highlighter-rouge">{2: {"value"} 1: {"key"}}</code> (fields can go in any order), since they don’t actually validate the field numbers like <code class="language-plaintext highlighter-rouge">hyperpb</code> does.</p> <p>Here’s where the benchmarks currently stand for maps:</p> <figure style="max-width: 95%;"> <p><img src="https://mcyoung.xyz/public/images/hyperpb/maps.svg" alt=""/></p> <figcaption> <p>Throughput for various map parsing benchmarks.</p> </figcaption> </figure> <p>Maps, I’m told, are not very popular in Protobuf, so they’re not something I have tried to optimize as hard as packed repeated fields. <a href="#fnref:map-benches" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-07-14</span> / <h6 style="display:inline"><a href="/2025/07/14/best/">The Best C++ Library</a></h6> <li> <span class="post-meta">2025-07-07</span> / <h6 style="display:inline"><a href="/2025/07/07/nosplit/">What's //go:nosplit for?</a></h6> <li> <span class="post-meta">2025-06-03</span> / <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/">Protobuf Tip #7: Scoping It Out</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-07-16</span> <span class="censored">•</span> <span class="censored">4119</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">45</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#go"><span class="censored">#go</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#dark-arts"><span class="censored">#dark-arts</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf"><span class="censored">#protobuf</span></a> </span> <h1><a href="/2025/07/16/hyperpb/"> <span class="censored">Parsing</span> <span class="censored">Protobuf</span> <span class="censored">Like</span> <span class="censored">Never</span> <span class="censored">Before</span> </a></h1> </div> <div class="post"> <p><span class="censored">Historically</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">worked</span> <span class="censored">on</span> <span class="censored">many</span> <span class="censored">projects</span> <span class="censored">related</span> <span class="censored">to</span> <span class="censored">high-performance</span> <span class="censored">Protobuf,</span> <span class="censored">be</span> <span class="censored">that</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">C++</span> <span class="censored">runtime,</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">Rust</span> <span class="censored">runtime,</span> <span class="censored">or</span> <span class="censored">on</span> <span class="censored">integrating</span> <a href="https://github.com/protocolbuffers/protobuf/tree/main/upb"><span class="censored">UPB</span></a><span class="censored">,</span> <span class="censored">the</span> <span class="censored">fastest</span> <span class="censored">Protobuf</span> <span class="censored">runtime,</span> <span class="censored">written</span> <span class="censored">by</span> <span class="censored">my</span> <span class="censored">colleague</span> <a href="https://blog.reverberate.org/2021/04/21/musttail-efficient-interpreters.html"><span class="censored">Josh</span> <span class="censored">Haberman</span></a><span class="censored">.</span> <span class="censored">I</span> <em><span class="censored">generally</span></em> <span class="censored">don’t</span> <span class="censored">post</span> <span class="censored">directly</span> <span class="censored">about</span> <span class="censored">my</span> <span class="censored">current</span> <span class="censored">job,</span> <span class="censored">but</span> <span class="censored">my</span> <span class="censored">most</span> <span class="censored">recent</span> <span class="censored">toy-turned-product</span> <span class="censored">is</span> <span class="censored">something</span> <span class="censored">I’m</span> <span class="censored">very</span> <span class="censored">excited</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">about:</span> <a href="https://github.com/bufbuild/hyperpb-go"><code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code></a><span class="censored">.</span></p> <p><span class="censored">Here’s</span> <span class="censored">how</span> <span class="censored">we</span> <span class="censored">measure</span> <span class="censored">up</span> <span class="censored">against</span> <span class="censored">other</span> <span class="censored">Go</span> <span class="censored">Protobuf</span> <span class="censored">parsers.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">subset</span> <span class="censored">of</span> <span class="censored">my</span> <span class="censored">benchmarks,</span> <span class="censored">since</span> <span class="censored">the</span> <span class="censored">benchmark</span> <span class="censored">suite</span> <span class="censored">contains</span> <span class="censored">many</span> <span class="censored">dozens</span> <span class="censored">of</span> <span class="censored">specimens.</span> <span class="censored">This</span> <span class="censored">was</span> <span class="censored">recorded</span> <span class="censored">on</span> <span class="censored">an</span> <span class="censored">AMD</span> <span class="censored">Zen</span> <span class="censored">4</span> <span class="censored">machine.</span></p> <figure style="max-width: 95%;"> <p><img src="https://mcyoung.xyz/public/images/hyperpb/benches.svg" alt=""></p> <figcaption> <p><span class="censored">Throughput</span> <span class="censored">for</span> <span class="censored">various</span> <span class="censored">configurations</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">(colored</span> <span class="censored">bars)</span> <span class="censored">vs.</span> <span class="censored">competing</span> <span class="censored">parsers</span> <span class="censored">(grey</span> <span class="censored">bars).</span> <span class="censored">Each</span> <span class="censored">successive</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">includes</span> <span class="censored">all</span> <span class="censored">previous</span> <span class="censored">optimizations,</span> <span class="censored">corresponding</span> <span class="censored">to</span> <a href="#zerocopy-strings"><span class="censored">zerocopy</span> <span class="censored">mode</span></a><span class="censored">,</span> <a href="#arena-reuse"><span class="censored">arena</span> <span class="censored">reuse</span></a><span class="censored">,</span> <span class="censored">and</span> <a href="#tdptype"><span class="censored">profile-guided</span> <span class="censored">optimization</span></a><span class="censored">.</span> <span class="censored">Bigger</span> <span class="censored">is</span> <span class="censored">better.</span></p> </figcaption> </figure> <p><span class="censored">Traditionally,</span> <span class="censored">Protobuf</span> <span class="censored">backends</span> <span class="censored">would</span> <span class="censored">generate</span> <span class="censored">parsers</span> <span class="censored">by</span> <span class="censored">generating</span> <span class="censored">source</span> <span class="censored">code</span> <span class="censored">specialized</span> <span class="censored">to</span> <span class="censored">each</span> <span class="censored">type.</span> <span class="censored">Naively,</span> <span class="censored">this</span> <span class="censored">would</span> <span class="censored">give</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">performance,</span> <span class="censored">because</span> <span class="censored">everything</span> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">“right-sized”</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">particular</span> <span class="censored">message</span> <span class="censored">type.</span> <span class="censored">Unfortunately,</span> <span class="censored">now</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">know</span> <span class="censored">better,</span> <span class="censored">there</span> <span class="censored">are</span> <span class="censored">a</span> <span class="censored">bunch</span> <span class="censored">of</span> <span class="censored">drawbacks:</span></p> <ol> <li> <span class="censored">Every</span> <span class="censored">type</span> <span class="censored">you</span> <span class="censored">care</span> <span class="censored">about</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">compiled</span> <span class="censored">ahead-of-time.</span> <span class="censored">Tricky</span> <span class="censored">for</span> <span class="censored">when</span> <span class="censored">you</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">build</span> <span class="censored">something</span> <span class="censored">generic</span> <span class="censored">over</span> <span class="censored">schemas</span> <span class="censored">your</span> <span class="censored">users</span> <span class="censored">provide</span> <span class="censored">you.</span> </li> <li> <span class="censored">Every</span> <span class="censored">type</span> <span class="censored">contributes</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">cost</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">instruction</span> <span class="censored">cache,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">if</span> <span class="censored">your</span> <span class="censored">program</span> <span class="censored">parses</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">different</span> <span class="censored">types,</span> <span class="censored">it</span> <span class="censored">will</span> <span class="censored">essentially</span> <span class="censored">flush</span> <span class="censored">your</span> <span class="censored">instruction</span> <span class="censored">cache</span> <span class="censored">any</span> <span class="censored">time</span> <span class="censored">you</span> <span class="censored">enter</span> <span class="censored">a</span> <span class="censored">parser.</span> <span class="censored">Worse</span> <span class="censored">still,</span> <span class="censored">if</span> <span class="censored">a</span> <span class="censored">parse</span> <span class="censored">involves</span> <span class="censored">enough</span> <span class="censored">types,</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">itself</span> <span class="censored">will</span> <span class="censored">hit</span> <span class="censored">instruction</span> <span class="censored">decoding</span> <span class="censored">throughput</span> <span class="censored">issues.</span> </li> </ol> <p><span class="censored">These</span> <span class="censored">effects</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">directly</span> <span class="censored">visible</span> <span class="censored">in</span> <span class="censored">normal</span> <span class="censored">workloads,</span> <span class="censored">but</span> <span class="censored">other</span> <span class="censored">side-effects</span> <span class="censored">are</span> <span class="censored">visible:</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">giant</span> <span class="censored">switches</span> <span class="censored">on</span> <span class="censored">field</span> <span class="censored">numbers</span> <span class="censored">can</span> <span class="censored">turn</span> <span class="censored">into</span> <span class="censored">chains</span> <span class="censored">of</span> <span class="censored">branch</span> <span class="censored">instructions,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">higher-numbered</span> <span class="censored">fields</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">quite</span> <span class="censored">slow.</span> <span class="censored">Even</span> <span class="censored">binary-searching</span> <span class="censored">on</span> <span class="censored">field</span> <span class="censored">numbers</span> <span class="censored">isn’t</span> <span class="censored">exactly</span> <span class="censored">ideal.</span> <span class="censored">However,</span> <span class="censored">we</span> <span class="censored">know</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">Protobuf</span> <span class="censored">codec</span> <span class="censored">ever</span> <span class="censored">emits</span> <span class="censored">fields</span> <span class="censored">in</span> <span class="censored">index</span> <span class="censored">order</span> <span class="censored">(i.e.,</span> <span class="censored">declaration</span> <span class="censored">order</span> <span class="censored">in</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.proto</span></code> <span class="censored">file),</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">data</span> <span class="censored">conditioning</span> <span class="censored">fact</span> <span class="censored">we</span> <span class="censored">don’t</span> <span class="censored">take</span> <span class="censored">advantage</span> <span class="censored">of</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">switch.</span></p> <p><span class="censored">UPB</span> <span class="censored">solves</span> <span class="censored">this</span> <span class="censored">problem.</span> <span class="censored">It</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">small</span> <span class="censored">C</span> <span class="censored">kernel</span> <span class="censored">for</span> <span class="censored">parsing</span> <span class="censored">Protobuf</span> <span class="censored">messages,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">completely</span> <span class="censored">dynamic:</span> <span class="censored">a</span> <span class="censored">UPB</span> <span class="censored">“parser”</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">a</span> <span class="censored">collection</span> <span class="censored">of</span> <span class="censored">data</span> <span class="censored">tables</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">evaluated</span> <span class="censored">by</span> <span class="censored">a</span> <em><span class="censored">table-driven</span> <span class="censored">parser</span></em><span class="censored">.</span> <span class="censored">In</span> <span class="censored">other</span> <span class="censored">words,</span> <span class="censored">a</span> <span class="censored">UPB</span> <span class="censored">parser</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">configuration</span> <span class="censored">for</span> <span class="censored">an</span> <span class="censored">interpreter</span> <span class="censored">VM,</span> <span class="censored">which</span> <span class="censored">executes</span> <span class="censored">Protobuf</span> <span class="censored">messages</span> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">bytecode.</span> <span class="censored">UPB</span> <span class="censored">also</span> <span class="censored">contains</span> <span class="censored">many</span> <span class="censored">arena</span> <span class="censored">optimizations</span> <span class="censored">to</span> <span class="censored">improve</span> <span class="censored">allocation</span> <span class="censored">throughput</span> <span class="censored">when</span> <span class="censored">parsing</span> <span class="censored">complex</span> <span class="censored">messages.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">brand</span> <span class="censored">new</span> <span class="censored">library,</span> <span class="censored">written</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">cursed</span> <span class="censored">Go</span> <span class="censored">imaginable,</span> <span class="censored">which</span> <span class="censored">brings</span> <span class="censored">many</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">optimizations</span> <span class="censored">of</span> <span class="censored">UPB</span> <span class="censored">to</span> <span class="censored">Go,</span> <span class="censored">and</span> <span class="censored">many</span> <span class="censored">new</span> <span class="censored">ones,</span> <span class="censored">while</span> <span class="censored">being</span> <span class="censored">tuned</span> <span class="censored">to</span> <span class="censored">Go’s</span> <span class="censored">own</span> <span class="censored">weird</span> <span class="censored">needs.</span> <span class="censored">The</span> <span class="censored">result</span> <span class="censored">leaves</span> <span class="censored">the</span> <span class="censored">competition</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">dust</span> <span class="censored">in</span> <span class="censored">virtually</span> <span class="censored">every</span> <span class="censored">benchmark,</span> <span class="censored">while</span> <span class="censored">being</span> <span class="censored">completely</span> <span class="censored">runtime-dynamic.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">it’s</span> <span class="censored">faster</span> <span class="censored">than</span> <span class="censored">Protobuf</span> <span class="censored">Go’s</span> <span class="censored">own</span> <span class="censored">generated</span> <span class="censored">code,</span> <em><span class="censored">and</span></em> <a href="https://github.com/planetscale/vtprotobuf"><code class="language-plaintext highlighter-rouge"><span class="censored">vtprotobuf</span></code></a> <span class="censored">(a</span> <span class="censored">popular</span> <span class="censored">but</span> <span class="censored">non-conforming</span><sup id="fnref:vtproto" role="doc-noteref"><a href="#fn:vtproto" class="footnote" rel="footnote"><span class="censored">1</span></a></sup> <span class="censored">parser</span> <span class="censored">generator</span> <span class="censored">for</span> <span class="censored">Go).</span></p> <p><span class="censored">This</span> <span class="censored">post</span> <span class="censored">is</span> <span class="censored">about</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">internals</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code><span class="censored">.</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">also</span> <span class="censored">prepared</span> <span class="censored">a</span> <span class="censored">more</span> <span class="censored">sales-ey</span> <span class="censored">writeup,</span> <span class="censored">which</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">read</span> <span class="censored">on</span> <a href="https://buf.build/blog/introducing-hyperpb"><span class="censored">the</span> <span class="censored">Buf</span> <span class="censored">blog</span></a><span class="censored">.</span></p> <h2 id="why-reinvent-upb"><a href="#why-reinvent-upb"><span class="censored">Why</span> <span class="censored">Reinvent</span> <span class="censored">UPB?</span></a></h2> <p><span class="censored">UPB</span> <span class="censored">is</span> <span class="censored">awesome.</span> <span class="censored">It</span> <span class="censored">can</span> <span class="censored">slot</span> <span class="censored">easily</span> <span class="censored">into</span> <span class="censored">any</span> <span class="censored">language</span> <span class="censored">that</span> <span class="censored">has</span> <span class="censored">C</span> <span class="censored">FFI,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">basically</span> <span class="censored">every</span> <span class="censored">language</span> <span class="censored">ever.</span></p> <p><span class="censored">Unfortunately,</span> <span class="censored">Go’s</span> <span class="censored">C</span> <span class="censored">FFI</span> <span class="censored">is</span> <span class="censored">really,</span> <span class="censored">really</span> <span class="censored">bad.</span> <span class="censored">It’s</span> <span class="censored">hard</span> <span class="censored">to</span> <span class="censored">overstate</span> <span class="censored">how</span> <span class="censored">bad</span> <span class="censored">cgo</span> <span class="censored">is.</span> <span class="censored">There</span> <span class="censored">isn’t</span> <span class="censored">a</span> <span class="censored">good</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">cooperate</span> <span class="censored">with</span> <span class="censored">C</span> <span class="censored">on</span> <span class="censored">memory</span> <span class="censored">allocation</span> <span class="censored">(C</span> <span class="censored">can’t</span> <span class="censored">really</span> <span class="censored">handle</span> <span class="censored">Go</span> <span class="censored">memory</span> <span class="censored">without</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">problems,</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">GC).</span> <span class="censored">Having</span> <span class="censored">C</span> <span class="censored">memory</span> <span class="censored">get</span> <span class="censored">cleaned</span> <span class="censored">up</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">GC</span> <span class="censored">requires</span> <span class="censored">finalizers,</span> <span class="censored">which</span> <span class="censored">are</span> <span class="censored">very</span> <span class="censored">slow.</span> <span class="censored">Calling</span> <span class="censored">into</span> <span class="censored">C</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">slow,</span> <span class="censored">because</span> <span class="censored">Go</span> <span class="censored">pessimistically</span> <span class="censored">assumes</span> <span class="censored">that</span> <span class="censored">C</span> <span class="censored">requires</span> <span class="censored">a</span> <span class="censored">large</span> <span class="censored">stack,</span> <span class="censored">and</span> <span class="censored">also</span> <span class="censored">calling</span> <span class="censored">into</span> <span class="censored">C</span> <span class="censored">does</span> <span class="censored">nasty</span> <span class="censored">things</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">scheduler.</span></p> <p><span class="censored">All</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">things</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">worked</span> <span class="censored">around,</span> <span class="censored">of</span> <span class="censored">course.</span> <span class="censored">For</span> <span class="censored">a</span> <span class="censored">while</span> <span class="censored">I</span> <span class="censored">considered</span> <span class="censored">compiling</span> <span class="censored">UPB</span> <span class="censored">to</span> <span class="censored">assembly,</span> <span class="censored">and</span> <span class="censored">rewriting</span> <span class="censored">that</span> <span class="censored">assembly</span> <span class="censored">into</span> <span class="censored">Go’s</span> <span class="censored">awful</span> <span class="censored">assembly</span> <span class="censored">syntax</span><sup id="fnref:go-asm" role="doc-noteref"><a href="#fn:go-asm" class="footnote" rel="footnote"><span class="censored">2</span></a></sup><span class="censored">,</span> <span class="censored">and</span> <span class="censored">then</span> <span class="censored">having</span> <span class="censored">Go</span> <span class="censored">assemble</span> <span class="censored">UPB</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">that.</span> <span class="censored">This</span> <span class="censored">presents</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">issues</span> <span class="censored">though,</span> <span class="censored">particularly</span> <span class="censored">because</span> <span class="censored">Go’s</span> <span class="censored">assembly</span> <span class="censored">calling</span> <span class="censored">convention</span> <span class="censored">is</span> <span class="censored">still</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">stone</span> <span class="censored">age</span><sup id="fnref:abi0" role="doc-noteref"><a href="#fn:abi0" class="footnote" rel="footnote"><span class="censored">3</span></a></sup> <span class="censored">(arguments</span> <span class="censored">are</span> <span class="censored">passed</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">stack),</span> <span class="censored">and</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">would</span> <span class="censored">still</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">work</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">UPB</span> <span class="censored">to</span> <span class="censored">match</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoreflect</span></code> <span class="censored">API.</span></p> <p><span class="censored">Go</span> <span class="censored">also</span> <span class="censored">has</span> <span class="censored">a</span> <span class="censored">few…</span> <span class="censored">unique</span> <span class="censored">qualities</span> <span class="censored">that</span> <span class="censored">make</span> <span class="censored">writing</span> <span class="censored">a</span> <span class="censored">Protobuf</span> <span class="censored">interpreter</span> <span class="censored">an</span> <span class="censored">interesting</span> <span class="censored">challenge</span> <span class="censored">with</span> <em><span class="censored">exciting</span></em> <span class="censored">optimization</span> <span class="censored">opportunities.</span></p> <p><span class="censored">First,</span> <span class="censored">of</span> <span class="censored">course,</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">register</span> <span class="censored">ABI,</span> <span class="censored">which</span> <span class="censored">on</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x86_64</span></code> <span class="censored">gives</span> <span class="censored">us</span> <span class="censored">a</span> <span class="censored">whopping</span> <em><span class="censored">nine</span></em> <span class="censored">argument</span> <span class="censored">and</span> <span class="censored">return</span> <span class="censored">registers,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">simply</span> <span class="censored">pass</span> <span class="censored">the</span> <span class="censored">entire</span> <span class="censored">parser</span> <span class="censored">state</span> <span class="censored">in</span> <span class="censored">registers</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">time.</span></p> <p><span class="censored">Second</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">Go</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">have</span> <span class="censored">much</span> <span class="censored">UB</span> <span class="censored">to</span> <span class="censored">speak</span> <span class="censored">of,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">get</span> <span class="censored">away</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">very</span> <span class="censored">evil</span> <span class="censored">pointer</span> <span class="censored">crimes</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">not</span> <span class="censored">in</span> <span class="censored">C++</span> <span class="censored">or</span> <span class="censored">Rust.</span></p> <p><span class="censored">Third</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">Protobuf</span> <span class="censored">Go</span> <span class="censored">has</span> <span class="censored">a</span> <span class="censored">robust</span> <span class="censored">reflection</span> <span class="censored">system</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">target</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">design</span> <span class="censored">specifically</span> <span class="censored">for</span> <span class="censored">it.</span></p> <p><span class="censored">Also,</span> <span class="censored">the</span> <span class="censored">Go</span> <span class="censored">ecosystem</span> <span class="censored">seems</span> <span class="censored">much</span> <span class="censored">more</span> <span class="censored">tolerant</span> <span class="censored">of</span> <span class="censored">less-than-ideal</span> <span class="censored">startup</span> <span class="censored">times</span> <span class="censored">(because</span> <span class="censored">the</span> <span class="censored">language</span> <em><span class="censored">loves</span></em> <span class="censored">life-before-main</span> <span class="censored">due</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">init()</span></code> <span class="censored">functions),</span> <span class="censored">so</span> <span class="censored">unlike</span> <span class="censored">UPB,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">require</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">interpreter’s</span> <span class="censored">program</span> <span class="censored">be</span> <span class="censored">generated</span> <span class="censored">at</span> <span class="censored">runtime,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">design</span> <span class="censored">for</span> <span class="censored">online</span> <span class="censored">PGO.</span> <span class="censored">In</span> <span class="censored">other</span> <span class="censored">words,</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">perfect</span> <span class="censored">storm</span> <span class="censored">to</span> <span class="censored">create</span> <span class="censored">the</span> <span class="censored">first-ever</span> <span class="censored">Protobuf</span> <span class="censored">JIT</span> <span class="censored">compiler</span> <span class="censored">(which</span> <span class="censored">we</span> <span class="censored">also</span> <span class="censored">refer</span> <span class="censored">to</span> <span class="censored">as</span> <span class="censored">“online</span> <span class="censored">PGO”</span> <span class="censored">or</span> <span class="censored">“real-time</span> <span class="censored">PGO”).</span></p> <h2 id="hyperpbs-api"><a href="#hyperpbs-api"><span class="censored">hyperpb’s</span> <span class="censored">API</span></a></h2> <p><span class="censored">Right</span> <span class="censored">now,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code><span class="censored">’s</span> <span class="censored">API</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">simple.</span> <span class="censored">There</span> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb.Compile*</span></code> <span class="censored">functions</span> <span class="censored">that</span> <span class="censored">accept</span> <span class="censored">some</span> <span class="censored">representation</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">message</span> <span class="censored">descriptor,</span> <span class="censored">and</span> <span class="censored">return</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*hyperpb.MessageType</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">implements</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoreflect</span></code> <span class="censored">type</span> <span class="censored">APIs.</span> <span class="censored">This</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">a</span> <span class="censored">new</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*hyperpb.Message</span></code> <span class="censored">,</span> <span class="censored">which</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">shove</span> <span class="censored">into</span> <code class="language-plaintext highlighter-rouge"><span class="censored">proto.Unmarshal</span></code> <span class="censored">and</span> <span class="censored">do</span> <span class="censored">reflection</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">result.</span> <span class="censored">However,</span> <span class="censored">you</span> <span class="censored">can’t</span> <span class="censored">mutate</span> <code class="language-plaintext highlighter-rouge"><span class="censored">*hyperpb.Message</span></code><span class="censored">s</span> <span class="censored">currently,</span> <span class="censored">because</span> <span class="censored">the</span> <span class="censored">main</span> <span class="censored">use-cases</span> <span class="censored">I</span> <span class="censored">am</span> <span class="censored">optimizing</span> <span class="censored">for</span> <span class="censored">are</span> <span class="censored">read-only.</span> <span class="censored">All</span> <span class="censored">mutations</span> <span class="censored">panic</span> <span class="censored">instead.</span></p> <p><span class="censored">The</span> <span class="censored">hero</span> <span class="censored">use-case,</span> <span class="censored">using</span> <span class="censored">Buf’s</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protovalidate</span></code> <span class="censored">library,</span> <span class="censored">uses</span> <span class="censored">reflection</span> <span class="censored">to</span> <span class="censored">execute</span> <span class="censored">validation</span> <span class="censored">predicates.</span> <span class="censored">It</span> <span class="censored">looks</span> <span class="censored">like</span> <span class="censored">this:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c"><span class="censored">//</span> <span class="censored">Compile</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">message</span> <span class="censored">type,</span> <span class="censored">deserializing</span> <span class="censored">an</span> <span class="censored">encoded</span> <span class="censored">FileDescriptorSet.</span></span>
<span class="n"><span class="censored">msgType</span></span> <span class="o"><span class="censored">:=</span></span> <span class="n"><span class="censored">hyperpb</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">CompileForBytes</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">schema</span></span><span class="p"><span class="censored">,</span></span> <span class="s"><span class="censored">"my.api.v1.Request"</span></span><span class="p"><span class="censored">)</span></span>

<span class="c"><span class="censored">//</span> <span class="censored">Allocate</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">message</span> <span class="censored">of</span> <span class="censored">that</span> <span class="censored">type.</span></span>
<span class="n"><span class="censored">msg</span></span> <span class="o"><span class="censored">:=</span></span> <span class="n"><span class="censored">hyperpb</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">NewMessage</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">msgType</span></span><span class="p"><span class="censored">)</span></span>

<span class="c"><span class="censored">//</span> <span class="censored">Unmarshal</span> <span class="censored">like</span> <span class="censored">you</span> <span class="censored">would</span> <span class="censored">any</span> <span class="censored">other</span> <span class="censored">message,</span> <span class="censored">using</span> <span class="censored">proto.Unmarshal.</span></span>
<span class="k"><span class="censored">if</span></span> <span class="n"><span class="censored">err</span></span> <span class="o"><span class="censored">:=</span></span> <span class="n"><span class="censored">proto</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Unmarshal</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">data</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">msg</span></span><span class="p"><span class="censored">);</span></span> <span class="n"><span class="censored">err</span></span> <span class="o"><span class="censored">!=</span></span> <span class="no"><span class="censored">nil</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">Handle</span> <span class="censored">parse</span> <span class="censored">failure.</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="c"><span class="censored">//</span> <span class="censored">Validate</span> <span class="censored">the</span> <span class="censored">message.</span> <span class="censored">Protovalidate</span> <span class="censored">uses</span> <span class="censored">reflection,</span> <span class="censored">so</span> <span class="censored">this</span> <span class="censored">Just</span> <span class="censored">Works.</span></span>
<span class="k"><span class="censored">if</span></span> <span class="n"><span class="censored">err</span></span> <span class="o"><span class="censored">:=</span></span> <span class="n"><span class="censored">protovalidate</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Validate</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">msg</span></span><span class="p"><span class="censored">);</span></span> <span class="n"><span class="censored">err</span></span> <span class="o"><span class="censored">!=</span></span> <span class="no"><span class="censored">nil</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">Handle</span> <span class="censored">validation</span> <span class="censored">failure.</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">We</span> <span class="censored">tell</span> <span class="censored">users</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">sure</span> <span class="censored">to</span> <span class="censored">cache</span> <span class="censored">the</span> <span class="censored">compilation</span> <span class="censored">step</span> <span class="censored">because</span> <span class="censored">compilation</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">arbitrarily</span> <span class="censored">slow:</span> <span class="censored">it’s</span> <span class="censored">an</span> <span class="censored">optimizing</span> <span class="censored">compiler!</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">unlike</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">warning</span> <span class="censored">on</span> <code class="language-plaintext highlighter-rouge"><span class="censored">regexp.Compile</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">makes</span> <span class="censored">it</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">teach</span> <span class="censored">users</span> <span class="censored">how</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">this</span> <span class="censored">API</span> <span class="censored">correctly.</span></p> <p><span class="censored">In</span> <span class="censored">addition</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">main</span> <span class="censored">API,</span> <span class="censored">there’s</span> <span class="censored">a</span> <span class="censored">bunch</span> <span class="censored">of</span> <span class="censored">performance</span> <span class="censored">tuning</span> <span class="censored">knobs</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">compiler,</span> <span class="censored">for</span> <span class="censored">unmarshaling,</span> <span class="censored">and</span> <span class="censored">for</span> <span class="censored">recording</span> <span class="censored">profiles.</span> <span class="censored">Types</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">recompiled</span> <span class="censored">using</span> <span class="censored">a</span> <span class="censored">recorded</span> <span class="censored">profile</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">more</span> <span class="censored">optimized</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">kinds</span> <span class="censored">of</span> <span class="censored">messages</span> <span class="censored">that</span> <span class="censored">actually</span> <span class="censored">come</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">wire.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">PGO</span><sup id="fnref:go-pgo" role="doc-noteref"><a href="#fn:go-pgo" class="footnote" rel="footnote"><span class="censored">4</span></a></sup> <span class="censored">affects</span> <span class="censored">a</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">things</span> <span class="censored">that</span> <span class="censored">we’ll</span> <span class="censored">get</span> <span class="censored">into</span> <span class="censored">as</span> <span class="censored">I</span> <span class="censored">dive</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">implementation</span> <span class="censored">details.</span></p> <h2 id="the-guts"><a href="#the-guts"><span class="censored">The</span> <span class="censored">Guts</span></a></h2> <p><span class="censored">Most</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">core</span> <span class="censored">implementation</span> <span class="censored">lives</span> <span class="censored">under</span> <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/tdp"><code class="language-plaintext highlighter-rouge"><span class="censored">internal/tdp</span></code></a><span class="censored">.</span> <span class="censored">The</span> <span class="censored">main</span> <span class="censored">components</span> <span class="censored">are</span> <span class="censored">as</span> <span class="censored">follows:</span></p> <ol> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">defines</span> <span class="censored">the</span> <span class="censored">“object</span> <span class="censored">code</span> <span class="censored">format”</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">interpreter.</span> <span class="censored">This</span> <span class="censored">includes</span> <span class="censored">definitions</span> <span class="censored">for</span> <span class="censored">describing</span> <span class="censored">types</span> <span class="censored">and</span> <span class="censored">fields</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">parser.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp/compiler</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">contains</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">code</span> <span class="censored">for</span> <span class="censored">converting</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoreflect.MessageDescriptor</span></code> <span class="censored">into</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Library</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">contains</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">types</span> <span class="censored">relevant</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">particular</span> <span class="censored">parsing</span> <span class="censored">operation.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp/dynamic</span></code> <span class="censored">defines</span> <span class="censored">what</span> <span class="censored">dynamic</span> <span class="censored">message</span> <span class="censored">types</span> <span class="censored">look</span> <span class="censored">like.</span> <span class="censored">The</span> <span class="censored">compiler</span> <span class="censored">does</span> <span class="censored">a</span> <span class="censored">bunch</span> <span class="censored">of</span> <span class="censored">layout</span> <span class="censored">work</span> <span class="censored">that</span> <span class="censored">gets</span> <span class="censored">stored</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Type</span></code> <span class="censored">values,</span> <span class="censored">which</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">dynamic.Message</span></code> <span class="censored">interprets</span> <span class="censored">to</span> <span class="censored">find</span> <span class="censored">the</span> <span class="censored">offsets</span> <span class="censored">of</span> <span class="censored">fields</span> <span class="censored">within</span> <span class="censored">itself.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp/vm</span></code> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">core</span> <span class="censored">interpreter</span> <span class="censored">implementation,</span> <span class="censored">including</span> <span class="censored">the</span> <span class="censored">VM</span> <span class="censored">state</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">passed</span> <span class="censored">in</span> <span class="censored">registers</span> <span class="censored">everywhere.</span> <span class="censored">It</span> <span class="censored">also</span> <span class="censored">includes</span> <span class="censored">hand-optimized</span> <span class="censored">routines</span> <span class="censored">for</span> <span class="censored">parsing</span> <span class="censored">varints</span> <span class="censored">and</span> <span class="censored">validating</span> <span class="censored">UTF-8.</span> </li> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp/thunks</span></code> <span class="censored">defines</span> <em><span class="censored">archetypes</span></em><span class="censored">,</span> <span class="censored">which</span> <span class="censored">are</span> <span class="censored">classes</span> <span class="censored">of</span> <span class="censored">fields</span> <span class="censored">that</span> <span class="censored">all</span> <span class="censored">use</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">layout</span> <span class="censored">and</span> <span class="censored">parsers.</span> <span class="censored">This</span> <span class="censored">corresponds</span> <span class="censored">roughly</span> <span class="censored">to</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">(presence,</span> <span class="censored">kind)</span></code> <span class="censored">pair,</span> <span class="censored">but</span> <span class="censored">not</span> <span class="censored">exactly.</span> <span class="censored">There</span> <span class="censored">are</span> <span class="censored">around</span> <span class="censored">200</span> <span class="censored">different</span> <span class="censored">archetypes.</span> </li> </ol> <p><span class="censored">This</span> <span class="censored">article</span> <span class="censored">won’t</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">deep-dive</span> <span class="censored">into</span> <span class="censored">everything</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">parser,</span> <span class="censored">and</span> <span class="censored">even</span> <span class="censored">this</span> <span class="censored">excludes</span> <span class="censored">large</span> <span class="censored">portions</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code><span class="censored">.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">the</span> <a href="https://mcyoung.xyz/2025/04/21/go-arenas/"><code class="language-plaintext highlighter-rouge"><span class="censored">internal/arena</span></code></a> <span class="censored">package</span> <span class="censored">is</span> <span class="censored">already</span> <span class="censored">described</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">different</span> <span class="censored">blogpost</span> <span class="censored">of</span> <span class="censored">mine.</span> <span class="censored">I</span> <span class="censored">recommend</span> <span class="censored">taking</span> <span class="censored">a</span> <span class="censored">look</span> <span class="censored">at</span> <span class="censored">that</span> <span class="censored">to</span> <span class="censored">learn</span> <span class="censored">about</span> <span class="censored">how</span> <span class="censored">we</span> <span class="censored">implement</span> <span class="censored">a</span> <span class="censored">GC-friendly</span> <span class="censored">arena</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">.</span></p> <p><span class="censored">Instead,</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">give</span> <span class="censored">a</span> <span class="censored">brief</span> <span class="censored">overview</span> <span class="censored">of</span> <span class="censored">how</span> <span class="censored">the</span> <span class="censored">object</span> <span class="censored">code</span> <span class="censored">is</span> <span class="censored">organized</span> <span class="censored">and</span> <span class="censored">how</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">interprets</span> <span class="censored">it.</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">also</span> <span class="censored">go</span> <span class="censored">over</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">more</span> <span class="censored">interesting</span> <span class="censored">optimizations</span> <span class="censored">we</span> <span class="censored">have.</span></p> <h3 id="tdptype"><a href="#tdptype"><span class="censored">tdp.Type</span></a></h3> <p><span class="censored">Every</span> <code class="language-plaintext highlighter-rouge"><span class="censored">MessageDescriptor</span></code> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">reachable</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">root</span> <span class="censored">message</span> <span class="censored">(either</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">or</span> <span class="censored">as</span> <span class="censored">an</span> <span class="censored">extension)</span> <span class="censored">becomes</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Type</span></code> <span class="censored">.</span> <span class="censored">This</span> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">dynamic</span> <span class="censored">size</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">corresponding</span> <span class="censored">message</span> <span class="censored">type,</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">type’s</span> <span class="censored">default</span> <span class="censored">parser</span> <span class="censored">(there</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">more</span> <span class="censored">than</span> <span class="censored">one</span> <span class="censored">parser</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">type)</span> <span class="censored">and</span> <span class="censored">a</span> <span class="censored">variable</span> <span class="censored">number</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Field</span></code> <span class="censored">values.</span> <span class="censored">These</span> <span class="censored">specify</span> <span class="censored">the</span> <span class="censored">offset</span> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">field</span> <span class="censored">and</span> <span class="censored">provide</span> <span class="censored">accessor</span> <span class="censored">thunks,</span> <span class="censored">for</span> <span class="censored">actually</span> <span class="censored">extracting</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">field.</span></p> <p><span class="censored">A</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.TypeParser</span></code> <span class="censored">is</span> <span class="censored">what</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">VM</span> <span class="censored">interprets</span> <span class="censored">alongside</span> <span class="censored">encoded</span> <span class="censored">Protobuf</span> <span class="censored">data.</span> <span class="censored">It</span> <span class="censored">contains</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">information</span> <span class="censored">needed</span> <span class="censored">for</span> <span class="censored">decoding</span> <span class="censored">a</span> <span class="censored">message</span> <span class="censored">in</span> <span class="censored">compact</span> <span class="censored">form,</span> <span class="censored">including</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.FieldParser</span></code><span class="censored">s</span> <span class="censored">for</span> <span class="censored">each</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">fields</span> <span class="censored">(and</span> <span class="censored">extensions),</span> <span class="censored">as</span> <span class="censored">well</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">hashtable</span> <span class="censored">for</span> <span class="censored">looking</span> <span class="censored">up</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">by</span> <span class="censored">tag,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">VM</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">fallback.</span></p> <p><span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.FieldParser</span></code><span class="censored">s</span> <span class="censored">each</span> <span class="censored">contain:</span></p> <ol> <li> <span class="censored">The</span> <span class="censored">same</span> <span class="censored">offset</span> <span class="censored">information</span> <span class="censored">as</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Field</span></code><span class="censored">.</span> </li> <li> <span class="censored">The</span> <span class="censored">field’s</span> <span class="censored">tag,</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">special</span> <span class="censored">format.</span> </li> <li> <span class="censored">A</span> <span class="censored">function</span> <span class="censored">pointer</span> <span class="censored">that</span> <span class="censored">gets</span> <span class="censored">called</span> <span class="censored">to</span> <span class="censored">parse</span> <span class="censored">the</span> <span class="censored">field.</span> </li> <li> <span class="censored">The</span> <span class="censored">next</span> <span class="censored">field(s)</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">parsing</span> <span class="censored">after</span> <span class="censored">this</span> <span class="censored">one</span> <span class="censored">is</span> <span class="censored">parsed.</span> </li> </ol> <p><span class="censored">Each</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.FieldParser</span></code> <span class="censored">actually</span> <span class="censored">corresponds</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">possible</span> <span class="censored">tag</span> <span class="censored">on</span> <span class="censored">a</span> <span class="censored">record</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">message.</span> <span class="censored">Some</span> <span class="censored">fields</span> <span class="censored">have</span> <span class="censored">multiple</span> <span class="censored">different</span> <span class="censored">tags:</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">repeated</span> <span class="censored">int32</span></code> <span class="censored">can</span> <span class="censored">have</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">VARINT</span></code><span class="censored">-type</span> <span class="censored">tag</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">repeated</span> <span class="censored">representation,</span> <span class="censored">and</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">LEN</span></code><span class="censored">-type</span> <span class="censored">tag</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">packed</span> <span class="censored">representation.</span></p> <p><span class="censored">Each</span> <span class="censored">field</span> <span class="censored">specifies</span> <span class="censored">which</span> <span class="censored">fields</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">next.</span> <span class="censored">This</span> <span class="censored">allows</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">to</span> <span class="censored">perform</span> <em><span class="censored">field</span> <span class="censored">scheduling</span></em><span class="censored">,</span> <span class="censored">by</span> <span class="censored">carefully</span> <span class="censored">deciding</span> <span class="censored">which</span> <span class="censored">order</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">fields</span> <span class="censored">in</span> <span class="censored">based</span> <span class="censored">both</span> <span class="censored">on</span> <span class="censored">their</span> <span class="censored">declaration</span> <span class="censored">order</span> <span class="censored">and</span> <span class="censored">a</span> <span class="censored">rough</span> <span class="censored">estimation</span> <span class="censored">of</span> <span class="censored">their</span> <span class="censored">“hotness”,</span> <span class="censored">much</span> <span class="censored">like</span> <span class="censored">branch</span> <span class="censored">scheduling</span> <span class="censored">happens</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">program</span> <span class="censored">compiler.</span> <span class="censored">This</span> <span class="censored">avoids</span> <span class="censored">almost</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">work</span> <span class="censored">of</span> <span class="censored">looking</span> <span class="censored">up</span> <span class="censored">the</span> <span class="censored">next</span> <span class="censored">field</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">common</span> <span class="censored">case,</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">already</span> <span class="censored">pre-loaded</span> <span class="censored">the</span> <span class="censored">correct</span> <span class="censored">guess.</span></p> <p><span class="censored">I</span> <span class="censored">haven’t</span> <span class="censored">managed</span> <span class="censored">to</span> <span class="censored">nail</span> <span class="censored">down</span> <span class="censored">a</span> <span class="censored">good</span> <span class="censored">algorithm</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">yet,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">am</span> <span class="censored">working</span> <span class="censored">on</span> <span class="censored">a</span> <span class="censored">system</span> <span class="censored">for</span> <span class="censored">implementing</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">of</span> <span class="censored">“branch</span> <span class="censored">prediction”</span> <span class="censored">for</span> <span class="censored">PGO,</span> <span class="censored">that</span> <span class="censored">tries</span> <span class="censored">to</span> <span class="censored">provide</span> <span class="censored">better</span> <span class="censored">predictions</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">next</span> <span class="censored">fields</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">based</span> <span class="censored">on</span> <span class="censored">what</span> <span class="censored">has</span> <span class="censored">been</span> <span class="censored">seen</span> <span class="censored">before.</span></p> <p><span class="censored">The</span> <span class="censored">offset</span> <span class="censored">information</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">is</span> <span class="censored">more</span> <span class="censored">than</span> <span class="censored">just</span> <span class="censored">a</span> <span class="censored">memory</span> <span class="censored">offset.</span> <span class="censored">A</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Offset</span></code> <span class="censored">includes</span> <span class="censored">a</span> <span class="censored">bit</span> <span class="censored">offset,</span> <span class="censored">for</span> <span class="censored">fields</span> <span class="censored">which</span> <span class="censored">request</span> <span class="censored">allocation</span> <span class="censored">of</span> <span class="censored">individual</span> <span class="censored">bits</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">message’s</span> <span class="censored">bitfields.</span> <span class="censored">These</span> <span class="censored">are</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">implement</span> <span class="censored">the</span> <span class="censored">hasbits</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">optional</span></code> <span class="censored">fields</span> <span class="censored">(and</span> <span class="censored">the</span> <span class="censored">values</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">bool</span></code> <span class="censored">fields).</span> <span class="censored">It</span> <span class="censored">also</span> <span class="censored">includes</span> <span class="censored">a</span> <span class="censored">byte</span> <span class="censored">offset</span> <span class="censored">for</span> <span class="censored">larger</span> <span class="censored">storage.</span> <span class="censored">However,</span> <span class="censored">this</span> <span class="censored">byte</span> <span class="censored">offset</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">negative,</span> <span class="censored">in</span> <span class="censored">which</span> <span class="censored">case</span> <span class="censored">it’s</span> <span class="censored">actually</span> <span class="censored">an</span> <span class="censored">offset</span> <span class="censored">into</span> <span class="censored">the</span> <em><span class="censored">cold</span> <span class="censored">region</span></em><span class="censored">.</span></p> <p><span class="censored">In</span> <span class="censored">many</span> <span class="censored">messages,</span> <span class="censored">most</span> <span class="censored">fields</span> <span class="censored">won’t</span> <span class="censored">be</span> <span class="censored">set,</span> <span class="censored">particularly</span> <span class="censored">extensions.</span> <span class="censored">But</span> <span class="censored">we</span> <span class="censored">would</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">avoid</span> <span class="censored">having</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">memory</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">very</span> <span class="censored">rare</span> <span class="censored">(i.e.,</span> <span class="censored">“cold”)</span> <span class="censored">fields.</span> <span class="censored">For</span> <span class="censored">this,</span> <span class="censored">a</span> <span class="censored">special</span> <span class="censored">“cold</span> <span class="censored">region”</span> <span class="censored">exists</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">separate</span> <span class="censored">allocation</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">main</span> <span class="censored">message,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">referenced</span> <span class="censored">via</span> <span class="censored">a</span> <span class="censored">compressed</span> <span class="censored">pointer.</span> <span class="censored">If</span> <span class="censored">a</span> <span class="censored">message</span> <span class="censored">happens</span> <span class="censored">to</span> <span class="censored">need</span> <span class="censored">a</span> <span class="censored">cold</span> <span class="censored">field</span> <span class="censored">set,</span> <span class="censored">it</span> <span class="censored">takes</span> <span class="censored">a</span> <span class="censored">slow</span> <span class="censored">path</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">a</span> <span class="censored">cold</span> <span class="censored">region</span> <span class="censored">only</span> <span class="censored">if</span> <span class="censored">needed.</span> <span class="censored">Whether</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">is</span> <span class="censored">cold</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">dynamic</span> <span class="censored">property</span> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">affected</span> <span class="censored">by</span> <span class="censored">PGO.</span></p> <h3 id="the-parser-vm"><a href="#the-parser-vm"><span class="censored">The</span> <span class="censored">Parser</span> <span class="censored">VM</span></a></h3> <p><span class="censored">The</span> <span class="censored">parser</span> <span class="censored">is</span> <span class="censored">designed</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">maximal</span> <span class="censored">use</span> <span class="censored">of</span> <span class="censored">Go’s</span> <span class="censored">generous</span> <span class="censored">ABI</span> <span class="censored">without</span> <span class="censored">spilling</span> <span class="censored">anything</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">that</span> <span class="censored">isn’t</span> <span class="censored">absolutely</span> <span class="censored">necessary.</span> <span class="censored">The</span> <span class="censored">parser</span> <span class="censored">state</span> <span class="censored">consists</span> <span class="censored">of</span> <span class="censored">eight</span> <span class="censored">64-bit</span> <span class="censored">integers,</span> <span class="censored">split</span> <span class="censored">across</span> <span class="censored">two</span> <span class="censored">types:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">vm.P1</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">vm.P2</span></code><span class="censored">.</span> <span class="censored">Unfortunately,</span> <span class="censored">these</span> <span class="censored">can’t</span> <span class="censored">be</span> <span class="censored">merged</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">a</span> <a href="https://github.com/golang/go/issues/72897"><span class="censored">compiler</span> <span class="censored">bug</span></a><span class="censored">,</span> <span class="censored">as</span> <span class="censored">documented</span> <span class="censored">in</span> <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/tdp/vm/vm.go#L50"><code class="language-plaintext highlighter-rouge"><span class="censored">vm/vm.go</span></code></a><span class="censored">.</span></p> <p><span class="censored">Every</span> <span class="censored">parser</span> <span class="censored">function</span> <span class="censored">takes</span> <span class="censored">these</span> <span class="censored">two</span> <span class="censored">structs</span> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">first</span> <span class="censored">two</span> <span class="censored">arguments,</span> <span class="censored">and</span> <span class="censored">returns</span> <span class="censored">them</span> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">first</span> <span class="censored">two</span> <span class="censored">results.</span> <span class="censored">This</span> <span class="censored">ensures</span> <span class="censored">that</span> <span class="censored">register</span> <span class="censored">allocation</span> <span class="censored">tries</span> <span class="censored">its</span> <span class="censored">darnedest</span> <span class="censored">to</span> <span class="censored">keep</span> <span class="censored">those</span> <span class="censored">eight</span> <span class="censored">integers</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">first</span> <span class="censored">eight</span> <span class="censored">argument</span> <span class="censored">registers,</span> <span class="censored">even</span> <span class="censored">across</span> <span class="censored">calls.</span> <span class="censored">This</span> <span class="censored">leads</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">common</span> <span class="censored">idiom</span> <span class="censored">of</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">var</span></span> <span class="n"><span class="censored">n</span></span> <span class="kt"><span class="censored">int</span></span>
<span class="n"><span class="censored">p1</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">p2</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">n</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">DoSomething</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">p1</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">p2</span></span><span class="p"><span class="censored">)</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">Overwriting</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">state</span> <span class="censored">like</span> <span class="censored">this</span> <span class="censored">ensures</span> <span class="censored">that</span> <span class="censored">future</span> <span class="censored">uses</span> <span class="censored">of</span> <span class="censored">p1</span> <span class="censored">and</span> <span class="censored">p2</span> <span class="censored">use</span> <span class="censored">the</span> <span class="censored">values</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">DoSomething</span></code> <span class="censored">places</span> <span class="censored">in</span> <span class="censored">registers</span> <span class="censored">for</span> <span class="censored">us.</span></p> <p><span class="censored">I</span> <span class="censored">spent</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">time</span> <span class="censored">and</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">profiling</span> <span class="censored">catching</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">places</span> <span class="censored">where</span> <span class="censored">Go</span> <span class="censored">would</span> <span class="censored">incorrectly</span> <span class="censored">spill</span> <span class="censored">parser</span> <span class="censored">state</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">stack,</span> <span class="censored">which</span> <span class="censored">would</span> <span class="censored">result</span> <span class="censored">in</span> <span class="censored">stalls.</span> <span class="censored">I</span> <span class="censored">found</span> <span class="censored">quite</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">codegen</span> <span class="censored">bugs</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">process.</span> <span class="censored">Particularly</span> <span class="censored">notable</span> <span class="censored">(and</span> <span class="censored">shocking!)</span> <span class="censored">is</span> <a href="https://github.com/golang/go/issues/73589"><span class="censored">#73589</span></a><span class="censored">.</span> <span class="censored">Go</span> <span class="censored">has</span> <span class="censored">somehow</span> <span class="censored">made</span> <span class="censored">it</span> <span class="censored">a</span> <span class="censored">decade</span> <span class="censored">without</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">basic</span> <span class="censored">pointer-to-SSA</span> <span class="censored">lifting</span> <span class="censored">pass</span> <span class="censored">(for</span> <span class="censored">comparison,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">heavy-lifting</span> <span class="censored">cleanup</span> <span class="censored">pass</span> <span class="censored">(</span><code class="language-plaintext highlighter-rouge"><span class="censored">mem2reg</span></code><span class="censored">)</span> <span class="censored">in</span> <span class="censored">LLVM).</span></p> <p><span class="censored">The</span> <span class="censored">core</span> <span class="censored">loop</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">VM</span> <span class="censored">goes</span> <span class="censored">something</span> <span class="censored">like</span> <span class="censored">this:</span></p> <ol> <li> <span class="censored">Are</span> <span class="censored">we</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">bytes</span> <span class="censored">to</span> <span class="censored">parse?</span> <span class="censored">If</span> <span class="censored">so,</span> <span class="censored">pop</span> <span class="censored">a</span> <span class="censored">parser</span> <span class="censored">stack</span> <span class="censored">frame</span><sup id="fnref:stack" role="doc-noteref"><a href="#fn:stack" class="footnote" rel="footnote"><span class="censored">5</span></a></sup><span class="censored">.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">popped</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">stack</span> <span class="censored">frame,</span> <span class="censored">parsing</span> <span class="censored">is</span> <span class="censored">done;</span> <span class="censored">return</span> <span class="censored">success.</span> </li> <li> <span class="censored">Parse</span> <span class="censored">a</span> <span class="censored">tag.</span> <span class="censored">This</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">fully</span> <span class="censored">decode</span> <span class="censored">the</span> <span class="censored">tag,</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.FieldParser</span></code><span class="censored">s</span> <span class="censored">contain</span> <span class="censored">a</span> <span class="censored">carefully-formatted,</span> <span class="censored">partially-decoded</span> <span class="censored">tag</span> <span class="censored">to</span> <span class="censored">reduce</span> <span class="censored">decoding</span> <span class="censored">work.</span> </li> <li> <span class="censored">Check</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">next</span> <span class="censored">field</span> <span class="censored">we</span> <span class="censored">would</span> <span class="censored">parse</span> <span class="censored">matches</span> <span class="censored">the</span> <span class="censored">tag.</span> <ol> <li> <span class="censored">If</span> <span class="censored">yes,</span> <span class="censored">call</span> <span class="censored">the</span> <span class="censored">function</span> <span class="censored">pointer</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Field.Parser</span></code><span class="censored">;</span> <span class="censored">update</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">field</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Field.NextOk</span></code><span class="censored">;</span> <span class="censored">goto</span> <span class="censored">1.</span> </li> <li> <span class="censored">If</span> <span class="censored">no,</span> <span class="censored">update</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">field</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Field.NextErr</span></code><span class="censored">;</span> <span class="censored">goto</span> <span class="censored">3.</span> </li> <li> <span class="censored">If</span> <span class="censored">no</span> <span class="censored">“enough</span> <span class="censored">times”,</span> <span class="censored">fall</span> <span class="censored">through.</span> </li> </ol> </li> <li> <span class="censored">Slow</span> <span class="censored">path:</span> <span class="censored">hit</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Field.Tags</span></code> <span class="censored">to</span> <span class="censored">find</span> <span class="censored">the</span> <span class="censored">matching</span> <span class="censored">field</span> <span class="censored">for</span> <span class="censored">that</span> <span class="censored">tag.</span> <ol> <li> <span class="censored">If</span> <span class="censored">matched,</span> <span class="censored">go</span> <span class="censored">to</span> <span class="censored">3a.</span> </li> <li> <span class="censored">If</span> <span class="censored">not,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">unknown</span> <span class="censored">field;</span> <span class="censored">put</span> <span class="censored">it</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">unknown</span> <span class="censored">field</span> <span class="censored">set;</span> <span class="censored">parse</span> <span class="censored">a</span> <span class="censored">tag</span> <span class="censored">and</span> <span class="censored">goto</span> <span class="censored">4.</span> </li> </ol> </li> </ol> <p><span class="censored">Naturally,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">implemented</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">single</span> <span class="censored">function</span> <span class="censored">whose</span> <span class="censored">control</span> <span class="censored">flow</span> <span class="censored">consists</span> <span class="censored">exclusively</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">if</span></code><span class="censored">s</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code><span class="censored">s,</span> <span class="censored">because</span> <span class="censored">getting</span> <span class="censored">Go</span> <span class="censored">to</span> <span class="censored">generate</span> <span class="censored">good</span> <span class="censored">control</span> <span class="censored">flow</span> <span class="censored">otherwise</span> <span class="censored">proved</span> <span class="censored">too</span> <span class="censored">hard.</span></p> <p><span class="censored">Now,</span> <span class="censored">you</span> <span class="censored">might</span> <span class="censored">be</span> <span class="censored">wondering</span> <span class="censored">why</span> <span class="censored">the</span> <span class="censored">hot</span> <span class="censored">loop</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">includes</span> <strong><span class="censored">calling</span> <span class="censored">a</span> <span class="censored">virtual</span> <span class="censored">function</span></strong><span class="censored">.</span> <span class="censored">Conventional</span> <span class="censored">wisdom</span> <span class="censored">holds</span> <span class="censored">that</span> <span class="censored">virtual</span> <span class="censored">calls</span> <span class="censored">are</span> <span class="censored">slow.</span> <span class="censored">After</span> <span class="censored">all,</span> <span class="censored">the</span> <span class="censored">actual</span> <span class="censored">virtual</span> <span class="censored">call</span> <span class="censored">instruction</span> <span class="censored">is</span> <span class="censored">quite</span> <span class="censored">slow,</span> <span class="censored">because</span> <span class="censored">it’s</span> <span class="censored">an</span> <span class="censored">indirect</span> <span class="censored">branch,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">easily</span> <span class="censored">stall</span> <span class="censored">the</span> <span class="censored">CPU.</span> <span class="censored">However,</span> <span class="censored">it’s</span> <span class="censored">actually</span> <em><span class="censored">much</span> <span class="censored">faster</span> <span class="censored">than</span> <span class="censored">the</span> <span class="censored">alternatives</span></em> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">case,</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">quirks</span> <span class="censored">of</span> <span class="censored">our</span> <span class="censored">workload</span> <span class="censored">and</span> <span class="censored">how</span> <span class="censored">modern</span> <span class="censored">CPUs</span> <span class="censored">are</span> <span class="censored">designed:</span></p> <ol> <li> <span class="censored">Modern</span> <span class="censored">CPUs</span> <span class="censored">are</span> <span class="censored">not</span> <em><span class="censored">great</span></em> <span class="censored">at</span> <span class="censored">traversing</span> <span class="censored">complex</span> <span class="censored">“branch</span> <span class="censored">mazes”.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">selecting</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">~100</span> <span class="censored">alternatives</span> <span class="censored">using</span> <span class="censored">branches,</span> <span class="censored">even</span> <span class="censored">if</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">well-predicted</span> <span class="censored">and</span> <span class="censored">you</span> <span class="censored">use</span> <span class="censored">unrolled</span> <span class="censored">binary</span> <span class="censored">search,</span> <span class="censored">is</span> <span class="censored">still</span> <span class="censored">likely</span> <span class="censored">to</span> <span class="censored">result</span> <span class="censored">in</span> <span class="censored">frequent</span> <span class="censored">mispredictions,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">obstacle</span> <span class="censored">to</span> <span class="censored">other</span> <span class="censored">JIT</span> <span class="censored">optimizations</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">processor’s</span> <span class="censored">backend.</span> </li> <li> <span class="censored">Predicting</span> <span class="censored">a</span> <span class="censored">single</span> <span class="censored">indirect</span> <span class="censored">branch</span> <span class="censored">with</span> <span class="censored">dozens</span> <span class="censored">of</span> <span class="censored">popular</span> <span class="censored">targets</span> <em><span class="censored">is</span></em> <span class="censored">something</span> <span class="censored">modern</span> <span class="censored">CPUs</span> <span class="censored">are</span> <span class="censored">pretty</span> <span class="censored">good</span> <span class="censored">at.</span> <span class="censored">Chips</span> <span class="censored">and</span> <span class="censored">Cheese</span> <span class="censored">have</span> <span class="censored">a</span> <a href="https://chipsandcheese.com/i/138977313/indirect-branch-prediction"><span class="censored">great</span> <span class="censored">writeup</span></a> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">indirect</span> <span class="censored">prediction</span> <span class="censored">characteristics</span> <span class="censored">of</span> <span class="censored">Zen</span> <span class="censored">4</span> <span class="censored">chips.</span> </li> </ol> <p><span class="censored">In</span> <span class="censored">fact,</span> <span class="censored">the</span> <span class="censored">“optimized”</span> <span class="censored">form</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">large</span> <span class="censored">switch</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">jump</span> <span class="censored">table,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">essentially</span> <span class="censored">an</span> <span class="censored">array</span> <span class="censored">of</span> <span class="censored">function</span> <span class="censored">pointers.</span> <span class="censored">Rather</span> <span class="censored">than</span> <span class="censored">doing</span> <span class="censored">a</span> <span class="censored">large</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">comparisons</span> <span class="censored">and</span> <span class="censored">direct</span> <span class="censored">branches,</span> <span class="censored">a</span> <span class="censored">jump</span> <span class="censored">table</span> <span class="censored">turns</span> <span class="censored">a</span> <span class="censored">switch</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">load</span> <span class="censored">and</span> <span class="censored">an</span> <span class="censored">indirect</span> <span class="censored">branch.</span></p> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">great</span> <span class="censored">news</span> <span class="censored">for</span> <span class="censored">us,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">means</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">make</span> <span class="censored">use</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">powerful</span> <span class="censored">assumption</span> <span class="censored">about</span> <span class="censored">most</span> <span class="censored">messages:</span> <span class="censored">most</span> <span class="censored">messages</span> <span class="censored">only</span> <span class="censored">feature</span> <span class="censored">a</span> <span class="censored">handful</span> <span class="censored">of</span> <span class="censored">field</span> <span class="censored">archetypes.</span> <span class="censored">How</span> <span class="censored">often</span> <span class="censored">is</span> <span class="censored">it</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">see</span> <span class="censored">a</span> <span class="censored">message</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">more</span> <span class="censored">in</span> <span class="censored">it</span> <span class="censored">than</span> <code class="language-plaintext highlighter-rouge"><span class="censored">int32</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">int64</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">string</span></code> <span class="censored">,</span> <span class="censored">and</span> <span class="censored">submessages?</span> <span class="censored">In</span> <span class="censored">effect,</span> <span class="censored">this</span> <span class="censored">allows</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">large</span> <span class="censored">“instruction</span> <span class="censored">set”,</span> <span class="censored">consisting</span> <span class="censored">of</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">different</span> <span class="censored">field</span> <span class="censored">archetypes,</span> <span class="censored">but</span> <span class="censored">a</span> <span class="censored">particular</span> <span class="censored">message</span> <span class="censored">only</span> <span class="censored">pays</span> <span class="censored">for</span> <span class="censored">what</span> <span class="censored">it</span> <span class="censored">uses.</span> <span class="censored">The</span> <span class="censored">fewer</span> <span class="censored">archetypes</span> <span class="censored">it</span> <span class="censored">uses</span> <em><span class="censored">at</span> <span class="censored">runtime</span></em><span class="censored">,</span> <span class="censored">the</span> <span class="censored">better</span> <span class="censored">the</span> <span class="censored">CPU</span> <span class="censored">can</span> <span class="censored">predict</span> <span class="censored">this</span> <span class="censored">indirect</span> <span class="censored">jump.</span></p> <p><span class="censored">On</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">hand,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">just</span> <span class="censored">keep</span> <span class="censored">adding</span> <span class="censored">archetypes</span> <span class="censored">over</span> <span class="censored">time</span> <span class="censored">to</span> <span class="censored">specialize</span> <span class="censored">for</span> <span class="censored">common</span> <span class="censored">parse</span> <span class="censored">workloads,</span> <span class="censored">which</span> <span class="censored">PGO</span> <span class="censored">can</span> <span class="censored">select</span> <span class="censored">for.</span> <span class="censored">Adding</span> <span class="censored">new</span> <span class="censored">archetypes</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">most</span> <span class="censored">messages</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">incur</span> <span class="censored">a</span> <span class="censored">performance</span> <span class="censored">penalty.</span></p> <h2 id="other-optimizations"><a href="#other-optimizations"><span class="censored">Other</span> <span class="censored">Optimizations</span></a></h2> <p><span class="censored">We’ve</span> <span class="censored">already</span> <span class="censored">discussed</span> <span class="censored">the</span> <span class="censored">hot/cold</span> <span class="censored">split,</span> <span class="censored">and</span> <span class="censored">briefly</span> <span class="censored">touched</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">message</span> <span class="censored">bitfields</span> <span class="censored">used</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">bool</span></code><span class="censored">s</span> <span class="censored">and</span> <span class="censored">hasbits.</span> <span class="censored">I’d</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">mention</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">other</span> <span class="censored">cool</span> <span class="censored">optimizations</span> <span class="censored">that</span> <span class="censored">help</span> <span class="censored">cover</span> <span class="censored">all</span> <span class="censored">our</span> <span class="censored">bases,</span> <span class="censored">as</span> <span class="censored">far</span> <span class="censored">as</span> <span class="censored">high-performance</span> <span class="censored">parsing</span> <span class="censored">does.</span></p> <h3 id="zerocopy-strings"><a href="#zerocopy-strings"><span class="censored">Zerocopy</span> <span class="censored">Strings</span></a></h3> <p><span class="censored">The</span> <span class="censored">fastest</span> <code class="language-plaintext highlighter-rouge"><span class="censored">memcpy</span></code> <span class="censored">implementation</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">one</span> <span class="censored">you</span> <span class="censored">don’t</span> <span class="censored">call.</span> <span class="censored">For</span> <span class="censored">this</span> <span class="censored">reason,</span> <span class="censored">we</span> <span class="censored">try</span> <span class="censored">to,</span> <span class="censored">whenever</span> <span class="censored">possible,</span> <span class="censored">avoid</span> <span class="censored">copying</span> <span class="censored">anything</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">input</span> <span class="censored">buffer.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">string</span></code><span class="censored">s</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">bytes</span></code> <span class="censored">are</span> <span class="censored">represented</span> <span class="censored">as</span> <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/zc/zc.go"><code class="language-plaintext highlighter-rouge"><span class="censored">zc.Range</span></code><span class="censored">s</span></a><span class="censored">,</span> <span class="censored">which</span> <span class="censored">are</span> <span class="censored">a</span> <span class="censored">packed</span> <span class="censored">pair</span> <span class="censored">of</span> <span class="censored">offset+length</span> <span class="censored">in</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">uint64</span></code><span class="censored">.</span> <span class="censored">Protobuf</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">handle</span> <span class="censored">lengths</span> <span class="censored">greater</span> <span class="censored">than</span> <span class="censored">2GB</span> <span class="censored">properly,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">assume</span> <span class="censored">that</span> <span class="censored">this</span> <span class="censored">covers</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">data</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">ever</span> <span class="censored">care</span> <span class="censored">about.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">bytes</span></code> <span class="censored">field</span> <span class="censored">is</span> <span class="censored">8</span> <span class="censored">bytes,</span> <span class="censored">rather</span> <span class="censored">than</span> <span class="censored">24,</span> <span class="censored">in</span> <span class="censored">our</span> <span class="censored">representation.</span></p> <p><span class="censored">Zerocopy</span> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">packed</span> <span class="censored">fields.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">repeated</span> <span class="censored">double</span></code> <span class="censored">will</span> <span class="censored">typically</span> <span class="censored">be</span> <span class="censored">encoded</span> <span class="censored">as</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">LEN</span></code> <span class="censored">record.</span> <span class="censored">The</span> <span class="censored">number</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">float64</span></code><span class="censored">s</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">record</span> <span class="censored">is</span> <span class="censored">equal</span> <span class="censored">to</span> <span class="censored">its</span> <span class="censored">length</span> <span class="censored">divided</span> <span class="censored">by</span> <span class="censored">8,</span> <span class="censored">and</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">float64</span></code><span class="censored">s</span> <span class="censored">are</span> <span class="censored">already</span> <span class="censored">encoded</span> <span class="censored">in</span> <span class="censored">IEEE754</span> <span class="censored">format</span> <span class="censored">for</span> <span class="censored">us.</span> <span class="censored">So</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">just</span> <span class="censored">retain</span> <span class="censored">the</span> <span class="censored">whole</span> <span class="censored">repeated</span> <span class="censored">fields</span> <span class="censored">as</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">zc.Range</span></code> <span class="censored">.</span> <span class="censored">Of</span> <span class="censored">course,</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">handle</span> <span class="censored">cases</span> <span class="censored">where</span> <span class="censored">there</span> <span class="censored">are</span> <span class="censored">multiple</span> <span class="censored">disjoint</span> <span class="censored">records,</span> <span class="censored">so</span> <span class="censored">the</span> <span class="censored">backing</span> <a href="https://github.com/bufbuild/hyperpb-go/blob/main/internal/tdp/repeated/scalars.go"><code class="language-plaintext highlighter-rouge"><span class="censored">repeated.Scalars</span></code></a> <span class="censored">can</span> <span class="censored">also</span> <span class="censored">function</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">24-byte</span> <span class="censored">arena</span> <span class="censored">slice.</span> <span class="censored">Being</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">switch</span> <span class="censored">between</span> <span class="censored">these</span> <span class="censored">modes</span> <span class="censored">gracefully</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">delicate</span> <span class="censored">and</span> <span class="censored">carefully-tested</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">repeated</span> <span class="censored">field</span> <span class="censored">thunks.</span></p> <p><span class="censored">Surprisingly,</span> <span class="censored">we</span> <span class="censored">also</span> <span class="censored">use</span> <span class="censored">zerocopy</span> <span class="censored">for</span> <span class="censored">varint</span> <span class="censored">fields,</span> <span class="censored">such</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">repeated</span> <span class="censored">int32</span></code><span class="censored">.</span> <span class="censored">Varints</span> <span class="censored">are</span> <span class="censored">variable-length,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can’t</span> <span class="censored">just</span> <span class="censored">index</span> <span class="censored">directly</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">packed</span> <span class="censored">buffer</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">n</span></code> <span class="censored">th</span> <span class="censored">element…</span> <span class="censored">unless</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">elements</span> <span class="censored">happen</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">size.</span> <span class="censored">In</span> <span class="censored">the</span> <span class="censored">case</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">varint</span> <span class="censored">is</span> <span class="censored">one</span> <span class="censored">byte</span> <span class="censored">(so,</span> <span class="censored">between</span> <span class="censored">0</span> <span class="censored">and</span> <span class="censored">127),</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">zerocopy</span> <span class="censored">the</span> <span class="censored">packed</span> <span class="censored">field.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">relatively</span> <span class="censored">common</span> <span class="censored">scenario,</span> <span class="censored">too,</span> <span class="censored">so</span> <span class="censored">it</span> <span class="censored">results</span> <span class="censored">in</span> <span class="censored">big</span> <span class="censored">savings</span><sup id="fnref:rep-benches" role="doc-noteref"><a href="#fn:rep-benches" class="footnote" rel="footnote"><span class="censored">6</span></a></sup><span class="censored">.</span> <span class="censored">We</span> <em><span class="censored">already</span></em> <span class="censored">count</span> <span class="censored">the</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">varints</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">packed</span> <span class="censored">field</span> <span class="censored">in</span> <span class="censored">order</span> <span class="censored">to</span> <span class="censored">preallocate</span> <span class="censored">space</span> <span class="censored">for</span> <span class="censored">it,</span> <span class="censored">so</span> <span class="censored">this</span> <span class="censored">doesn’t</span> <span class="censored">add</span> <span class="censored">extra</span> <span class="censored">cost.</span> <span class="censored">This</span> <span class="censored">counting</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">efficient</span> <span class="censored">because</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">manually</span> <span class="censored">vectorized</span> <span class="censored">the</span> <span class="censored">loop.</span></p> <h3 id="repeated-preloads"><a href="#repeated-preloads"><span class="censored">Repeated</span> <span class="censored">Preloads</span></a></h3> <p><span class="censored">PGO</span> <span class="censored">records</span> <span class="censored">the</span> <span class="censored">median</span> <span class="censored">size</span> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">repeated/map</span> <span class="censored">field,</span> <span class="censored">and</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">calculate</span> <span class="censored">a</span> <span class="censored">“preload”</span> <span class="censored">for</span> <span class="censored">each</span> <span class="censored">repeated</span> <span class="censored">field.</span> <span class="censored">Whenever</span> <span class="censored">the</span> <span class="censored">field</span> <span class="censored">is</span> <span class="censored">first</span> <span class="censored">allocated,</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">pre-allocated</span> <span class="censored">using</span> <span class="censored">the</span> <span class="censored">preload</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">to</span> <span class="censored">right-size</span> <span class="censored">the</span> <span class="censored">field</span> <span class="censored">with</span> <span class="censored">minimal</span> <span class="censored">waste.</span></p> <p><span class="censored">Using</span> <span class="censored">the</span> <span class="censored">median</span> <span class="censored">ensures</span> <span class="censored">that</span> <span class="censored">large</span> <span class="censored">outliers</span> <span class="censored">don’t</span> <span class="censored">result</span> <span class="censored">in</span> <span class="censored">huge</span> <span class="censored">memory</span> <span class="censored">waste;</span> <span class="censored">instead,</span> <span class="censored">this</span> <span class="censored">guarantees</span> <span class="censored">that</span> <span class="censored">at</span> <span class="censored">least</span> <span class="censored">50%</span> <span class="censored">of</span> <span class="censored">repeated</span> <span class="censored">fields</span> <span class="censored">will</span> <span class="censored">only</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">arena</span> <span class="censored">once.</span> <span class="censored">Packed</span> <span class="censored">fields</span> <span class="censored">don’t</span> <span class="censored">use</span> <span class="censored">the</span> <span class="censored">preload,</span> <span class="censored">since</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">common</span> <span class="censored">case</span> <span class="censored">only</span> <span class="censored">one</span> <span class="censored">record</span> <span class="censored">appears</span> <span class="censored">for</span> <span class="censored">packed</span> <span class="censored">fields.</span> <span class="censored">This</span> <span class="censored">mostly</span> <span class="censored">benefits</span> <span class="censored">string-</span> <span class="censored">and</span> <span class="censored">message-typed</span> <span class="censored">repeated</span> <span class="censored">fields,</span> <span class="censored">which</span> <span class="censored">can’t</span> <span class="censored">be</span> <span class="censored">packed.</span></p> <h3 id="map-optimizations"><a href="#map-optimizations"><span class="censored">Map</span> <span class="censored">Optimizations</span></a></h3> <p><span class="censored">We</span> <span class="censored">don’t</span> <span class="censored">use</span> <span class="censored">Go’s</span> <span class="censored">built-in</span> <span class="censored">map,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">has</span> <span class="censored">significant</span> <span class="censored">overhead</span> <span class="censored">in</span> <span class="censored">some</span> <span class="censored">cases:</span> <span class="censored">in</span> <span class="censored">particular,</span> <span class="censored">it</span> <span class="censored">has</span> <span class="censored">to</span> <span class="censored">support</span> <span class="censored">Go’s</span> <span class="censored">mutation-during-iteration</span> <span class="censored">semantics,</span> <span class="censored">as</span> <span class="censored">well</span> <span class="censored">as</span> <span class="censored">deletion.</span> <span class="censored">Although</span> <span class="censored">both</span> <span class="censored">are</span> <span class="censored">Swisstables</span><sup id="fnref:map-benches" role="doc-noteref"><a href="#fn:map-benches" class="footnote" rel="footnote"><span class="censored">7</span></a></sup> <span class="censored">under</span> <span class="censored">the</span> <span class="censored">hood,</span> <span class="censored">my</span> <span class="censored">implementation</span> <span class="censored">can</span> <span class="censored">afford</span> <span class="censored">to</span> <span class="censored">take</span> <span class="censored">a</span> <span class="censored">few</span> <span class="censored">shortcuts.</span> <span class="censored">It</span> <span class="censored">also</span> <span class="censored">allows</span> <span class="censored">our</span> <span class="censored">implementation</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">arena-managed</span> <span class="censored">memory.</span> <a href="https://github.com/bufbuild/hyperpb-go/tree/main/internal/swiss/table.go"><code class="language-plaintext highlighter-rouge"><span class="censored">swiss.Table</span></code><span class="censored">s</span></a> <span class="censored">are</span> <span class="censored">used</span> <span class="censored">both</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">backing</span> <span class="censored">store</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">map</span></code> <span class="censored">fields,</span> <span class="censored">and</span> <span class="censored">for</span> <span class="censored">maps</span> <span class="censored">inside</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tdp.Type</span></code><span class="censored">s.</span></p> <p><span class="censored">Currently,</span> <span class="censored">the</span> <span class="censored">hash</span> <span class="censored">used</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">variant</span> <span class="censored">of</span> <a href="https://github.com/rust-lang/rustc-hash"><span class="censored">fxhash</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">Rust</span> <span class="censored">compiler</span></a><span class="censored">.</span> <span class="censored">This</span> <span class="censored">greatly</span> <span class="censored">out-performs</span> <span class="censored">Go’s</span> <a href="https://pkg.go.dev/hash/maphash"><span class="censored">maphash</span></a> <span class="censored">for</span> <span class="censored">integers,</span> <span class="censored">but</span> <span class="censored">maphash</span> <span class="censored">is</span> <span class="censored">better</span> <span class="censored">for</span> <span class="censored">larger</span> <span class="censored">strings.</span> <span class="censored">I</span> <span class="censored">hope</span> <span class="censored">to</span> <span class="censored">maybe</span> <span class="censored">switch</span> <span class="censored">to</span> <span class="censored">maphash</span> <span class="censored">at</span> <span class="censored">some</span> <span class="censored">point</span> <span class="censored">for</span> <span class="censored">large</span> <span class="censored">strings,</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">hasn’t</span> <span class="censored">been</span> <span class="censored">a</span> <span class="censored">priority.</span></p> <h3 id="arena-reuse"><a href="#arena-reuse"><span class="censored">Arena</span> <span class="censored">Reuse</span></a></h3> <p><span class="censored">Hitting</span> <span class="censored">the</span> <span class="censored">Go</span> <span class="censored">allocator</span> <span class="censored">is</span> <span class="censored">always</span> <span class="censored">going</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">little</span> <span class="censored">slow,</span> <span class="censored">because</span> <span class="censored">it’s</span> <span class="censored">a</span> <span class="censored">general-case</span> <span class="censored">allocator.</span> <span class="censored">Ideally,</span> <span class="censored">we</span> <span class="censored">should</span> <span class="censored">learn</span> <span class="censored">the</span> <span class="censored">estimated</span> <span class="censored">memory</span> <span class="censored">requirements</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">particular</span> <span class="censored">workload,</span> <span class="censored">and</span> <span class="censored">then</span> <span class="censored">allocate</span> <span class="censored">a</span> <span class="censored">single</span> <span class="censored">block</span> <span class="censored">of</span> <span class="censored">that</span> <span class="censored">size</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">arena</span> <span class="censored">to</span> <span class="censored">portion</span> <span class="censored">out.</span></p> <p><span class="censored">The</span> <span class="censored">best</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">via</span> <em><span class="censored">arena</span> <span class="censored">reuse</span></em> <span class="censored">In</span> <span class="censored">the</span> <span class="censored">context</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">service,</span> <span class="censored">each</span> <span class="censored">request</span> <span class="censored">has</span> <span class="censored">a</span> <span class="censored">bounded</span> <span class="censored">lifetime</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">message</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">parses.</span> <span class="censored">Once</span> <span class="censored">that</span> <span class="censored">lifetime</span> <span class="censored">is</span> <span class="censored">over</span> <span class="censored">(the</span> <span class="censored">request</span> <span class="censored">is</span> <span class="censored">complete),</span> <span class="censored">the</span> <span class="censored">message</span> <span class="censored">is</span> <span class="censored">discarded.</span> <span class="censored">This</span> <span class="censored">gives</span> <span class="censored">the</span> <span class="censored">programmer</span> <span class="censored">an</span> <span class="censored">opportunity</span> <span class="censored">to</span> <em><span class="censored">reset</span></em> <span class="censored">the</span> <span class="censored">backing</span> <span class="censored">arena,</span> <span class="censored">so</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">keeps</span> <span class="censored">its</span> <span class="censored">largest</span> <span class="censored">memory</span> <span class="censored">block</span> <span class="censored">for</span> <span class="censored">re-allocation.</span></p> <p><span class="censored">You</span> <span class="censored">can</span> <span class="censored">show</span> <span class="censored">that</span> <span class="censored">over</span> <span class="censored">time,</span> <span class="censored">this</span> <span class="censored">will</span> <span class="censored">cause</span> <span class="censored">the</span> <span class="censored">arena</span> <span class="censored">to</span> <span class="censored">never</span> <span class="censored">hit</span> <span class="censored">the</span> <span class="censored">Go</span> <span class="censored">allocator.</span> <span class="censored">If</span> <span class="censored">the</span> <span class="censored">largest</span> <span class="censored">block</span> <span class="censored">is</span> <span class="censored">too</span> <span class="censored">small</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">message,</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">twice</span> <span class="censored">as</span> <span class="censored">large</span> <span class="censored">will</span> <span class="censored">wind</span> <span class="censored">up</span> <span class="censored">getting</span> <span class="censored">allocated.</span> <span class="censored">Messages</span> <span class="censored">that</span> <span class="censored">use</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">amount</span> <span class="censored">of</span> <span class="censored">memory</span> <span class="censored">will</span> <span class="censored">keep</span> <span class="censored">doubling</span> <span class="censored">the</span> <span class="censored">largest</span> <span class="censored">block,</span> <span class="censored">until</span> <span class="censored">the</span> <span class="censored">largest</span> <span class="censored">block</span> <span class="censored">is</span> <span class="censored">large</span> <span class="censored">enough</span> <span class="censored">to</span> <span class="censored">fit</span> <span class="censored">the</span> <span class="censored">whole</span> <span class="censored">message.</span> <span class="censored">Memory</span> <span class="censored">usage</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">at</span> <span class="censored">worst</span> <span class="censored">2x</span> <span class="censored">the</span> <span class="censored">size</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">message.</span> <span class="censored">Note</span> <span class="censored">that,</span> <span class="censored">thanks</span> <span class="censored">to</span> <span class="censored">extensive</span> <span class="censored">use</span> <span class="censored">of</span> <span class="censored">zero-copy</span> <span class="censored">optimizations,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">often</span> <span class="censored">avoid</span> <span class="censored">allocating</span> <span class="censored">memory</span> <span class="censored">for</span> <span class="censored">large</span> <span class="censored">portions</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">message.</span></p> <p><span class="censored">Of</span> <span class="censored">course,</span> <span class="censored">arena</span> <span class="censored">re-use</span> <span class="censored">poses</span> <span class="censored">a</span> <span class="censored">memory</span> <span class="censored">safety</span> <span class="censored">danger,</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">previously</span> <span class="censored">allocated</span> <span class="censored">message</span> <span class="censored">is</span> <span class="censored">kept</span> <span class="censored">around</span> <span class="censored">after</span> <span class="censored">the</span> <span class="censored">arena</span> <span class="censored">is</span> <span class="censored">reset.</span> <span class="censored">For</span> <span class="censored">this</span> <span class="censored">reason,</span> <span class="censored">it’s</span> <span class="censored">not</span> <span class="censored">the</span> <span class="censored">default</span> <span class="censored">behavior.</span> <span class="censored">Using</span> <span class="censored">arena</span> <span class="censored">resets</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">double-digit</span> <span class="censored">percentage</span> <span class="censored">improvement,</span> <span class="censored">however.</span></p> <h3 id="oneof-unions"><a href="#oneof-unions"><span class="censored">Oneof</span> <span class="censored">Unions</span></a></h3> <p><span class="censored">Go</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">properly</span> <span class="censored">support</span> <span class="censored">unions,</span> <span class="censored">because</span> <span class="censored">the</span> <span class="censored">GC</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">keep</span> <span class="censored">the</span> <span class="censored">necessary</span> <span class="censored">book-keeping</span> <span class="censored">to</span> <span class="censored">distinguish</span> <span class="censored">a</span> <span class="censored">memory</span> <span class="censored">location</span> <span class="censored">that</span> <span class="censored">may</span> <span class="censored">be</span> <span class="censored">an</span> <span class="censored">integer</span> <em><span class="censored">or</span></em> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">at</span> <span class="censored">runtime.</span> <span class="censored">Instead,</span> <span class="censored">this</span> <span class="censored">gets</span> <span class="censored">worked</span> <span class="censored">around</span> <span class="censored">using</span> <span class="censored">interfaces,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">always</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">some</span> <span class="censored">memory.</span> <span class="censored">Go’s</span> <span class="censored">GC</span> <span class="censored">can</span> <span class="censored">handle</span> <span class="censored">untyped</span> <span class="censored">pointers</span> <span class="censored">just</span> <span class="censored">fine,</span> <span class="censored">so</span> <span class="censored">this</span> <span class="censored">just</span> <span class="censored">works.</span></p> <p><span class="censored">The</span> <span class="censored">generated</span> <span class="censored">API</span> <span class="censored">for</span> <span class="censored">Protobuf</span> <span class="censored">Go</span> <span class="censored">uses</span> <span class="censored">interface</span> <span class="censored">values</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">oneof</span></code><span class="censored">s.</span> <span class="censored">This</span> <span class="censored">API</span> <span class="censored">is…</span> <span class="censored">pretty</span> <span class="censored">messy</span> <span class="censored">to</span> <span class="censored">use,</span> <span class="censored">unfortunately,</span> <span class="censored">and</span> <span class="censored">triggers</span> <span class="censored">unnecessary</span> <span class="censored">allocations,</span> <span class="censored">(much</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">optional</span></code> <span class="censored">fields</span> <span class="censored">do</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">open</span> <span class="censored">API).</span></p> <p><span class="censored">However,</span> <span class="censored">my</span> <span class="censored">arena</span> <span class="censored">design</span> <span class="censored">(</span><a href="https://mcyoung.xyz/2025/04/21/go-arenas/"><span class="censored">read</span> <span class="censored">about</span> <span class="censored">it</span> <span class="censored">here</span></a><span class="censored">)</span> <span class="censored">makes</span> <span class="censored">it</span> <span class="censored">possible</span> <span class="censored">to</span> <span class="censored">store</span> <span class="censored">arena</span> <span class="censored">pointers</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">arena</span> <span class="censored">as</span> <span class="censored">if</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">integers,</span> <span class="censored">since</span> <span class="censored">the</span> <span class="censored">GC</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">scan</span> <span class="censored">through</span> <span class="censored">arena</span> <span class="censored">memory.</span> <span class="censored">Thus,</span> <span class="censored">our</span> <code class="language-plaintext highlighter-rouge"><span class="censored">oneof</span></code><span class="censored">s</span> <span class="censored">are</span> <span class="censored">true</span> <span class="censored">unions,</span> <span class="censored">like</span> <span class="censored">in</span> <span class="censored">C++.</span></p> <h2 id="conclusion"><a href="#conclusion"><span class="censored">Conclusion</span></a></h2> <p><code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">is</span> <span class="censored">really</span> <span class="censored">exciting</span> <span class="censored">because</span> <span class="censored">its</span> <span class="censored">growing</span> <span class="censored">JIT</span> <span class="censored">capabilities</span> <span class="censored">offer</span> <span class="censored">an</span> <span class="censored">improvement</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">state</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">art</span> <span class="censored">over</span> <span class="censored">UPB.</span> <span class="censored">It’s</span> <span class="censored">also</span> <span class="censored">been</span> <span class="censored">a</span> <span class="censored">really</span> <span class="censored">fun</span> <span class="censored">challenge</span> <span class="censored">working</span> <span class="censored">around</span> <span class="censored">Go</span> <span class="censored">compiler</span> <span class="censored">bugs</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">assembly</span> <span class="censored">possible.</span> <span class="censored">The</span> <span class="censored">code</span> <span class="censored">is</span> <span class="censored">already</span> <span class="censored">so</span> <span class="censored">well-optimized</span> <span class="censored">that</span> <span class="censored">re-building</span> <span class="censored">the</span> <span class="censored">benchmarks</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">Go</span> <span class="censored">compiler’s</span> <span class="censored">own</span> <span class="censored">PGO</span> <span class="censored">mode</span> <span class="censored">(based</span> <span class="censored">on</span> <span class="censored">a</span> <span class="censored">profile</span> <span class="censored">collected</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">benchmarks)</span> <span class="censored">didn’t</span> <span class="censored">really</span> <span class="censored">seem</span> <span class="censored">to</span> <span class="censored">move</span> <span class="censored">the</span> <span class="censored">needle!</span></p> <p><span class="censored">I’m</span> <span class="censored">always</span> <span class="censored">working</span> <span class="censored">on</span> <span class="censored">making</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">better</span> <span class="censored">(I</span> <span class="censored">get</span> <span class="censored">paid</span> <span class="censored">for</span> <span class="censored">it!)</span> <span class="censored">and</span> <span class="censored">I’m</span> <span class="censored">always</span> <span class="censored">excited</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">new</span> <span class="censored">optimizations.</span> <span class="censored">If</span> <span class="censored">you</span> <span class="censored">think</span> <span class="censored">of</span> <span class="censored">something,</span> <span class="censored">file</span> <span class="censored">an</span> <span class="censored">issue!</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">meticulously</span> <span class="censored">commented</span> <span class="censored">most</span> <span class="censored">things</span> <span class="censored">within</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">,</span> <span class="censored">so</span> <span class="censored">it</span> <span class="censored">should</span> <span class="censored">be</span> <span class="censored">pretty</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">an</span> <span class="censored">idea</span> <span class="censored">of</span> <span class="censored">where</span> <span class="censored">things</span> <span class="censored">are</span> <span class="censored">if</span> <span class="censored">you</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">contribute.</span></p> <p><span class="censored">I</span> <span class="censored">would</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">more</span> <span class="censored">posts</span> <span class="censored">diving</span> <span class="censored">into</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">weeds</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">implementation.</span> <span class="censored">I</span> <span class="censored">can’t</span> <span class="censored">promise</span> <span class="censored">anything,</span> <span class="censored">but</span> <span class="censored">there’s</span> <span class="censored">lots</span> <span class="censored">to</span> <span class="censored">talk</span> <span class="censored">about.</span> <span class="censored">For</span> <span class="censored">now…</span> <span class="censored">have</span> <span class="censored">fun</span> <span class="censored">source-diving!</span></p> <p><span class="censored">There’s</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">other</span> <span class="censored">things</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">doing:</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">using</span> <span class="censored">SIMD</span> <span class="censored">to</span> <span class="censored">parse</span> <span class="censored">varints,</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">have</span> <span class="censored">smarter</span> <span class="censored">parser</span> <span class="censored">scheduling,</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">allocating</span> <span class="censored">small</span> <span class="censored">submessages</span> <span class="censored">inline</span> <span class="censored">to</span> <span class="censored">improve</span> <span class="censored">locality…</span> <span class="censored">there’s</span> <span class="censored">still</span> <span class="censored">so</span> <span class="censored">much</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">do!</span></p> <p><span class="censored">And</span> <span class="censored">most</span> <span class="censored">importantly,</span> <span class="censored">I</span> <span class="censored">hope</span> <span class="censored">you’ve</span> <span class="censored">learned</span> <span class="censored">something</span> <span class="censored">new</span> <span class="censored">about</span> <span class="censored">performance</span> <span class="censored">optimization!</span></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:vtproto" role="doc-endnote"> <p><span class="censored">vtprotobuf</span> <span class="censored">gets</span> <em><span class="censored">a</span> <span class="censored">lot</span></em> <span class="censored">of</span> <span class="censored">things</span> <span class="censored">wrong</span> <span class="censored">that</span> <span class="censored">make</span> <span class="censored">it</span> <span class="censored">beat</span> <span class="censored">us</span> <span class="censored">in</span> <span class="censored">like</span> <span class="censored">two</span> <span class="censored">benchmarks,</span> <span class="censored">because</span> <span class="censored">it’s</span> <em><span class="censored">so</span></em> <span class="censored">sloppy.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">vtprotobuf</span> <span class="censored">believes</span> <span class="censored">that</span> <span class="censored">it’s</span> <span class="censored">ok</span> <span class="censored">to</span> <span class="censored">not</span> <span class="censored">validate</span> <span class="censored">UTF-8</span> <span class="censored">strings.</span> <span class="censored">This</span> <span class="censored">is</span> <em><span class="censored">non-conforming</span></em> <span class="censored">behavior.</span> <span class="censored">It</span> <span class="censored">also</span> <span class="censored">believes</span> <span class="censored">that</span> <span class="censored">map</span> <span class="censored">entries’</span> <span class="censored">fields</span> <span class="censored">are</span> <span class="censored">always</span> <span class="censored">in</span> <span class="censored">order</span> <span class="censored">and</span> <span class="censored">always</span> <span class="censored">populated,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">valid</span> <span class="censored">Protobuf</span> <span class="censored">messages</span> <span class="censored">containing</span> <span class="censored">maps</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">parsed</span> <em><span class="censored">incorrectly</span></em><span class="censored">.</span> <span class="censored">This</span> <span class="censored">sloppiness</span> <span class="censored">is</span> <span class="censored">unacceptable,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">why</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">goes</span> <span class="censored">to</span> <span class="censored">great</span> <span class="censored">lengths</span> <span class="censored">to</span> <span class="censored">implement</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">Protobuf</span> <span class="censored">correctly. </span><a href="#fnref:vtproto" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:go-asm" role="doc-endnote"> <p><span class="censored">Never</span> <span class="censored">gonna</span> <span class="censored">let</span> <span class="censored">Rob</span> <span class="censored">live</span> <span class="censored">that</span> <span class="censored">one</span> <span class="censored">down.</span> <span class="censored">Of</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">Rob’s</span> <span class="censored">careless</span> <span class="censored">design</span> <span class="censored">decisions,</span> <span class="censored">the</span> <span class="censored">assembler</span> <span class="censored">is</span> <span class="censored">definitely</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">least</span> <span class="censored">forgivable</span> <span class="censored">ones. </span><a href="#fnref:go-asm" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:abi0" role="doc-endnote"> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">only</span> <span class="censored">really</span> <span class="censored">two</span> <span class="censored">pieces</span> <span class="censored">of</span> <span class="censored">code</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">that</span> <span class="censored">could</span> <span class="censored">benefit</span> <span class="censored">from</span> <span class="censored">hand-written</span> <span class="censored">assembly:</span> <span class="censored">varint</span> <span class="censored">decoding</span> <span class="censored">and</span> <span class="censored">UTF-8</span> <span class="censored">validation.</span> <span class="censored">Both</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">vectorize</span> <span class="censored">well,</span> <span class="censored">however,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">ABI0</span></code> <span class="censored">is</span> <span class="censored">so</span> <span class="censored">inefficient</span> <span class="censored">that</span> <span class="censored">no</span> <span class="censored">hand-written</span> <span class="censored">implementation</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">faster.</span></p> <p><span class="censored">If</span> <span class="censored">I</span> <span class="censored">do</span> <span class="censored">wind</span> <span class="censored">up</span> <span class="censored">doing</span> <span class="censored">this,</span> <span class="censored">it</span> <span class="censored">will</span> <span class="censored">require</span> <span class="censored">a</span> <span class="censored">build</span> <span class="censored">tag</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperasm</span></code><span class="censored">,</span> <span class="censored">along</span> <span class="censored">with</span> <span class="censored">something</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-gcflags=buf.build/go/hyperpb/internal/asm/...=-+</span></code> <span class="censored">to</span> <span class="censored">treat</span> <span class="censored">the</span> <span class="censored">assembly</span> <span class="censored">implementations</span> <span class="censored">as</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">Go</span> <span class="censored">runtime,</span> <span class="censored">allowing</span> <span class="censored">the</span> <span class="censored">use</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">ABIInternal</span></code><span class="censored">.</span> <span class="censored">But</span> <span class="censored">even</span> <span class="censored">then,</span> <span class="censored">this</span> <span class="censored">only</span> <span class="censored">speeds</span> <span class="censored">up</span> <span class="censored">parsing</span> <span class="censored">of</span> <span class="censored">large</span> <span class="censored">(&gt;2</span> <span class="censored">byte)</span> <span class="censored">varints. </span><a href="#fnref:abi0" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:go-pgo" role="doc-endnote"> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">PGO</span> <span class="censored">performed</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">itself;</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">unrelated</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">gc</span></code><span class="censored">’s</span> <span class="censored">own</span> <span class="censored">PGO</span> <span class="censored">mode,</span> <span class="censored">which</span> <span class="censored">seems</span> <span class="censored">to</span> <span class="censored">not</span> <span class="censored">actually</span> <span class="censored">make</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">faster. </span><a href="#fnref:go-pgo" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:stack" role="doc-endnote"> <p><span class="censored">Yes,</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">manages</span> <span class="censored">its</span> <span class="censored">own</span> <span class="censored">stack</span> <span class="censored">separate</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">goroutine</span> <span class="censored">stack.</span> <span class="censored">This</span> <span class="censored">ensures</span> <span class="censored">that</span> <span class="censored">nothing</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">parser</span> <span class="censored">has</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">reentrant.</span> <span class="censored">The</span> <span class="censored">only</span> <span class="censored">time</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">is</span> <span class="censored">pushed</span> <span class="censored">to</span> <span class="censored">is</span> <span class="censored">when</span> <span class="censored">we</span> <span class="censored">“recurse”</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">submessage. </span><a href="#fnref:stack" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:rep-benches" role="doc-endnote"> <p><span class="censored">Large</span> <span class="censored">packed</span> <span class="censored">repeated</span> <span class="censored">fields</span> <span class="censored">are</span> <span class="censored">where</span> <span class="censored">the</span> <span class="censored">biggest</span> <span class="censored">wins</span> <span class="censored">are</span> <span class="censored">for</span> <span class="censored">us.</span> <span class="censored">Being</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">zero-copy</span> <span class="censored">large</span> <span class="censored">packed</span> <code class="language-plaintext highlighter-rouge"><span class="censored">int32</span></code> <span class="censored">fields</span> <span class="censored">full</span> <span class="censored">of</span> <span class="censored">small</span> <span class="censored">values</span> <span class="censored">allows</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">eliminate</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">overhead</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">runtimes</span> <span class="censored">are</span> <span class="censored">paying</span> <span class="censored">for;</span> <span class="censored">we</span> <span class="censored">also</span> <span class="censored">choose</span> <span class="censored">different</span> <span class="censored">parsing</span> <span class="censored">strategies</span> <span class="censored">depending</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">byte-to-varint</span> <span class="censored">ratio</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">record.</span></p> <figure style="max-width: 95%;"> <p><img src="https://mcyoung.xyz/public/images/hyperpb/repeated.svg" alt=""></p> <figcaption> <p><span class="censored">Throughput</span> <span class="censored">for</span> <span class="censored">various</span> <span class="censored">repeated</span> <span class="censored">field</span> <span class="censored">benchmarks.</span> <span class="censored">This</span> <span class="censored">excludes</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">repeated</span> <span class="censored">fixed32</span></code> <span class="censored">benchmarks,</span> <span class="censored">since</span> <span class="censored">those</span> <span class="censored">achieve</span> <span class="censored">such</span> <span class="censored">high</span> <span class="censored">throughputs</span> <span class="censored">(~20</span> <span class="censored">Gbps)</span> <span class="censored">that</span> <span class="censored">they</span> <span class="censored">make</span> <span class="censored">the</span> <span class="censored">chart</span> <span class="censored">unreadable.</span></p> </figcaption> </figure> <p><span class="censored">These</span> <span class="censored">optimizations</span> <span class="censored">account</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">performance</span> <span class="censored">difference</span> <span class="censored">between</span> <code class="language-plaintext highlighter-rouge"><span class="censored">descriptor/#00</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">descriptor/#01</span></code> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">first</span> <span class="censored">benchmark</span> <span class="censored">chart.</span> <span class="censored">The</span> <span class="censored">latter</span> <span class="censored">is</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">FileDescriptorSet</span></code> <span class="censored">containing</span> <code class="language-plaintext highlighter-rouge"><span class="censored">SourceCodeInfo</span></code><span class="censored">,</span> <span class="censored">Protobuf’s</span> <span class="censored">janky</span> <span class="censored">debuginfo</span> <span class="censored">format.</span> <span class="censored">It</span> <span class="censored">is</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">repeated</span> <span class="censored">int32</span></code> <span class="censored">fields.</span></p> <p><span class="censored">NB:</span> <span class="censored">This</span> <span class="censored">chart</span> <span class="censored">is</span> <span class="censored">currently</span> <span class="censored">missing</span> <span class="censored">the</span> <span class="censored">Y-axis,</span> <span class="censored">I</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">it</span> <span class="censored">re-made. </span><a href="#fnref:rep-benches" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:map-benches" role="doc-endnote"> <p><span class="censored">Map</span> <span class="censored">parsing</span> <span class="censored">performance</span> <span class="censored">has</span> <span class="censored">been</span> <span class="censored">a</span> <span class="censored">bit</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">puzzle.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">vtprotobuf</span></code> <span class="censored">cheats</span> <span class="censored">by</span> <span class="censored">rejecting</span> <span class="censored">some</span> <span class="censored">valid</span> <span class="censored">map</span> <span class="censored">entry</span> <span class="censored">encodings,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">(in</span> <span class="censored">Protoscope)</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{1:</span> <span class="censored">{"key"}}</span></code> <span class="censored">(value</span> <span class="censored">is</span> <span class="censored">implied</span> <span class="censored">to</span> <span class="censored">be</span> <code class="language-plaintext highlighter-rouge"><span class="censored">""</span></code><span class="censored">),</span> <span class="censored">while</span> <span class="censored">mis-parsing</span> <span class="censored">others,</span> <span class="censored">such</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{2:</span> <span class="censored">{"value"}</span> <span class="censored">1:</span> <span class="censored">{"key"}}</span></code> <span class="censored">(fields</span> <span class="censored">can</span> <span class="censored">go</span> <span class="censored">in</span> <span class="censored">any</span> <span class="censored">order),</span> <span class="censored">since</span> <span class="censored">they</span> <span class="censored">don’t</span> <span class="censored">actually</span> <span class="censored">validate</span> <span class="censored">the</span> <span class="censored">field</span> <span class="censored">numbers</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">hyperpb</span></code> <span class="censored">does.</span></p> <p><span class="censored">Here’s</span> <span class="censored">where</span> <span class="censored">the</span> <span class="censored">benchmarks</span> <span class="censored">currently</span> <span class="censored">stand</span> <span class="censored">for</span> <span class="censored">maps:</span></p> <figure style="max-width: 95%;"> <p><img src="https://mcyoung.xyz/public/images/hyperpb/maps.svg" alt=""></p> <figcaption> <p><span class="censored">Throughput</span> <span class="censored">for</span> <span class="censored">various</span> <span class="censored">map</span> <span class="censored">parsing</span> <span class="censored">benchmarks.</span></p> </figcaption> </figure> <p><span class="censored">Maps,</span> <span class="censored">I’m</span> <span class="censored">told,</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">very</span> <span class="censored">popular</span> <span class="censored">in</span> <span class="censored">Protobuf,</span> <span class="censored">so</span> <span class="censored">they’re</span> <span class="censored">not</span> <span class="censored">something</span> <span class="censored">I</span> <span class="censored">have</span> <span class="censored">tried</span> <span class="censored">to</span> <span class="censored">optimize</span> <span class="censored">as</span> <span class="censored">hard</span> <span class="censored">as</span> <span class="censored">packed</span> <span class="censored">repeated</span> <span class="censored">fields. </span><a href="#fnref:map-benches" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-07-14</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/14/best/"><span class="censored">The</span> <span class="censored">Best</span> <span class="censored">C++</span> <span class="censored">Library</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-07</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/07/nosplit/"><span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-06-03</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#7:</span> <span class="censored">Scoping</span> <span class="censored">It</span> <span class="censored">Out</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>