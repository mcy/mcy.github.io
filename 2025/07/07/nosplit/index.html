<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> What's //go:nosplit for? &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="What's //go:nosplit for? &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/nosplit-b02a721848c0063cf64d4a1017bb2d5f6a8099a6.png"> <meta property="og:title" content="What's //go:nosplit for? &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/nosplit-b02a721848c0063cf64d4a1017bb2d5f6a8099a6.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/07/07/nosplit/"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-07-07 • 1880 words • 15 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#go">#go</a> • <a href="https://mcyoung.xyz/tags.html#dark-arts">#dark-arts</a> </span> <h1><a href="/2025/07/07/nosplit/"> What's //go:nosplit for? </a></h1> </div> <div class="post"> <p>Most people don’t know that Go has special syntax for directives. Unfortunately, it’s not real syntax, it’s just a comment. For example, <code class="language-plaintext highlighter-rouge">//go:noinline</code> causes the next function declaration to never get inlined, which is useful for changing the inlining cost of functions that call it.</p> <p>There are three types of directives:</p> <ol> <li> <p>The ones documented in <a href="https://pkg.go.dev/cmd/compile#hdr-Function_Directives"><code class="language-plaintext highlighter-rouge">gc</code>’s doc comment</a>. This includes <code class="language-plaintext highlighter-rouge">//go:noinline</code> and <code class="language-plaintext highlighter-rouge">//line</code>.</p> </li> <li> <p>The ones documented elsewhere, such as <code class="language-plaintext highlighter-rouge">//go:build</code> and <code class="language-plaintext highlighter-rouge">//go:generate</code>.</p> </li> <li> <p>The ones documented in <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.24.4:src/runtime/HACKING.md">runtime/HACKING.md</a>, which can only be used if the <code class="language-plaintext highlighter-rouge">-+</code> flag is passed to <code class="language-plaintext highlighter-rouge">gc</code>. This includes <code class="language-plaintext highlighter-rouge">//go:nowritebarrier</code>.</p> </li> <li> <p>The ones not documented at all, whose existence can be discovered by searching the compiler’s tests. These include <code class="language-plaintext highlighter-rouge">//go:nocheckptr</code>, <code class="language-plaintext highlighter-rouge">//go:nointerface</code>, and <code class="language-plaintext highlighter-rouge">//go:debug</code>.</p> </li> </ol> <p>We are most interested in a directive of the first type, <code class="language-plaintext highlighter-rouge">//go:nosplit</code>. According to the documentation:</p> <blockquote> <p>The <code class="language-plaintext highlighter-rouge">//go:nosplit</code> directive must be followed by a function declaration. It specifies that the function must omit its usual stack overflow check. This is most commonly used by low-level runtime code invoked at times when it is unsafe for the calling goroutine to be preempted.</p> </blockquote> <p>What does this even mean? Normal program code can use this annotation, but its behavior is poorly specified. Let’s dig in.</p> <h2 id="go-stack-growth"><a href="#go-stack-growth">Go Stack Growth</a></h2> <p>Go allocates very small stacks for new goroutines, which grow their stack dynamically. This allows a program to spawn a large number of short-lived goroutines without spending a lot of memory on their stacks.</p> <p>This means that it’s very easy to overflow the stack. Every function knows how large its stack is, and <code class="language-plaintext highlighter-rouge">runtime.g</code>, the goroutine struct, contains the end position of the stack; if the stack pointer is less than it (the stack grows up) control passes to <code class="language-plaintext highlighter-rouge">runtime.morestack</code>, which effectively preempts the goroutine while its stack is resized.</p> <p>In effect, every Go function has the following code around it:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="err">TEXT</span>    <span class="p">.</span><span class="err">f</span><span class="p">(</span><span class="err">SB</span><span class="p">),</span> <span class="err">ABIInternal</span><span class="p">,</span> <span class="err">$</span><span class="m">24-16</span>
  <span class="err">CMPQ</span>    <span class="err">SP</span><span class="p">,</span> <span class="m">16</span><span class="p">(</span><span class="err">R14</span><span class="p">)</span>
  <span class="err">JLS</span>     <span class="err">grow</span>
  <span class="err">PUSHQ</span>   <span class="err">BP</span>
  <span class="err">MOVQ</span>    <span class="err">SP</span><span class="p">,</span> <span class="err">BP</span>
  <span class="err">SUBQ</span>    <span class="err">$</span><span class="m">16</span><span class="p">,</span> <span class="err">SP</span>
  <span class="err">//</span> <span class="err">Function</span> <span class="err">body</span><span class="p">...</span>
  <span class="err">ADDQ</span>    <span class="err">$</span><span class="m">16</span><span class="p">,</span> <span class="err">SP</span>
  <span class="err">POPQ</span>    <span class="err">BP</span>
  <span class="err">RET</span>
<span class="nl">grow:</span>
  <span class="err">MOVQ</span>    <span class="err">AX</span><span class="p">,</span> <span class="m">8</span><span class="p">(</span><span class="err">SP</span><span class="p">)</span>
  <span class="err">MOVQ</span>    <span class="err">BX</span><span class="p">,</span> <span class="m">16</span><span class="p">(</span><span class="err">SP</span><span class="p">)</span>
  <span class="err">CALL</span>    <span class="err">runtime</span><span class="p">.</span><span class="err">morestack_noctxt</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span>
  <span class="err">MOVQ</span>    <span class="m">8</span><span class="p">(</span><span class="err">SP</span><span class="p">),</span> <span class="err">AX</span>
  <span class="err">MOVQ</span>    <span class="m">16</span><span class="p">(</span><span class="err">SP</span><span class="p">),</span> <span class="err">BX</span>
  <span class="err">JMP</span>     <span class="p">.</span><span class="err">f</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly (Go Syntax)</div></div></div> <p>Note that <code class="language-plaintext highlighter-rouge">r14</code> holds a pointer to the current <code class="language-plaintext highlighter-rouge">runtime.g</code>, and the stack limit is the third word-sized field (<code class="language-plaintext highlighter-rouge">runtime.g.stackguard0</code>) in that struct, hence the offset of 16. If the stack is about to be exhausted, it jumps to a special block at the end of the function that spills all of the argument registers, traps into the runtime, and, once that’s done, unspills the arguments and re-starts the function.</p> <p>Note that arguments are spilled <em>before</em> adjusting <code class="language-plaintext highlighter-rouge">rsp</code>, which means that the arguments are written to the <em>caller’s</em> stack frame. This is part of Go’s ABI; callers must allocate space at the top of their stack frames for any function that they call to spill all of its registers for preemption<sup id="fnref:unused-spill" role="doc-noteref"><a href="#fn:unused-spill" class="footnote" rel="footnote">1</a></sup>.</p> <p>Preemption is not reentrant, which means that functions that are running in the context of a preempted G or with no G at all must not be preempted by this check.</p> <h2 id="nosplit-functions"><a href="#nosplit-functions">Nosplit Functions</a></h2> <p>The <code class="language-plaintext highlighter-rouge">//go:nosplit</code> directive marks a function as “nosplit”, or a “non-splitting function”. “Splitting” has nothing to do with what this directive does.</p> <blockquote> <h4 id="segmented-stacks"><a href="#segmented-stacks">Segmented Stacks</a></h4> <p>In the bad old days, Go’s stacks were <em>split</em> up into <em>segments</em>, where each segment ended with a pointer to the next, effectively replacing the stack’s single array with a linked list of such arrays.</p> <p>Segmented stacks were terrible. Instead of triggering a resize, these prologues were responsible for updating <code class="language-plaintext highlighter-rouge">rsp</code> to the next (or previous) block by following this pointer, whenever the current segment bottomed out. This meant that if a function call happened to be on a segment boundary, it would be <em>extremely slow</em> in comparison to other function calls, due to the significant work required to update <code class="language-plaintext highlighter-rouge">rsp</code> correctly.</p> <p>This meant that unlucky sizing of stack frames meant sudden performance cliffs. Fun!</p> <p>Go has since figured out that segmented stacks are a terrible idea. In the process of implementing a correct GC stack scanning algorithm (which it did not have for many stable releases), it also gained the ability to copy the contents of a stack from one location to another, updating pointers in such a way that user code wouldn’t notice.</p> <p>This stack splitting code is where the name “nosplit” comes from.</p> </blockquote> <p>A nosplit function does not load and branch on <code class="language-plaintext highlighter-rouge">runtime.g.stackguard0</code>, and simply assumes it has enough stack. This means that nosplit functions will not preempt themselves, and, as a result, are noticeably faster to call in a hot loop. Don’t believe me?</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c">//go:noinline</span>
<span class="k">func</span> <span class="n">noinline</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{}</span>

<span class="c">//go:nosplit</span>
<span class="k">func</span> <span class="n">nosplit</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="n">noinline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">}</span>
<span class="k">func</span> <span class="n">yessplit</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="n">noinline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">BenchmarkCall</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">b</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="s">"nosplit"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">b</span><span class="o">.</span><span class="n">Loop</span><span class="p">()</span> <span class="p">{</span> <span class="n">nosplit</span><span class="p">(</span><span class="m">42</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">})</span>
  <span class="n">b</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="s">"yessplit"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">b</span><span class="o">.</span><span class="n">Loop</span><span class="p">()</span> <span class="p">{</span> <span class="n">yessplit</span><span class="p">(</span><span class="m">42</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>If we profile this and pull up the timings for each function, here’s what we get:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="m">390</span><span class="err">ms</span>      <span class="m">390</span><span class="err">ms</span>           <span class="err">func</span> <span class="err">nosplit</span><span class="p">(x</span> <span class="err">int</span><span class="p">)</span> <span class="p">{</span> <span class="k">noinline</span><span class="p">(x)</span> <span class="p">}</span>
 <span class="m">60</span><span class="err">ms</span>       <span class="m">60</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fd80:</span>     <span class="err">PUSHQ</span> <span class="err">BP</span>
 <span class="m">10</span><span class="err">ms</span>       <span class="m">10</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fd81:</span>     <span class="err">MOVQ</span> <span class="err">SP</span><span class="p">,</span> <span class="err">BP</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fd84:</span>     <span class="err">SUBQ</span> <span class="err">$</span><span class="m">0x8</span><span class="p">,</span> <span class="err">SP</span>
 <span class="m">60</span><span class="err">ms</span>       <span class="m">60</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fd88:</span>     <span class="err">CALL</span> <span class="p">.</span><span class="k">noinline</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span>
<span class="m">190</span><span class="err">ms</span>      <span class="m">190</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fd8d:</span>     <span class="err">ADDQ</span> <span class="err">$</span><span class="m">0x8</span><span class="p">,</span> <span class="err">SP</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fd91:</span>     <span class="err">POPQ</span> <span class="err">BP</span>
 <span class="m">70</span><span class="err">ms</span>       <span class="m">70</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fd92:</span>     <span class="err">RET</span>

<span class="m">440</span><span class="err">ms</span>      <span class="m">490</span><span class="err">ms</span>           <span class="err">func</span> <span class="err">yessplit</span><span class="p">(x</span> <span class="err">int</span><span class="p">)</span> <span class="p">{</span> <span class="k">noinline</span><span class="p">(x)</span> <span class="p">}</span>
 <span class="m">50</span><span class="err">ms</span>       <span class="m">50</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fda0:</span>     <span class="err">CMPQ</span> <span class="err">SP</span><span class="p">,</span> <span class="m">0x10</span><span class="p">(</span><span class="err">R14</span><span class="p">)</span>
 <span class="m">20</span><span class="err">ms</span>       <span class="m">20</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fda4:</span>     <span class="err">JBE</span> <span class="m">0x51fdb9</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fda6:</span>     <span class="err">PUSHQ</span> <span class="err">BP</span>
 <span class="m">20</span><span class="err">ms</span>       <span class="m">20</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fda7:</span>     <span class="err">MOVQ</span> <span class="err">SP</span><span class="p">,</span> <span class="err">BP</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdaa:</span>     <span class="err">SUBQ</span> <span class="err">$</span><span class="m">0x8</span><span class="p">,</span> <span class="err">SP</span>
 <span class="m">10</span><span class="err">ms</span>       <span class="m">60</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fdae:</span>     <span class="err">CALL</span> <span class="p">.</span><span class="k">noinline</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span>
<span class="m">200</span><span class="err">ms</span>      <span class="m">200</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fdb3:</span>     <span class="err">ADDQ</span> <span class="err">$</span><span class="m">0x8</span><span class="p">,</span> <span class="err">SP</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdb7:</span>     <span class="err">POPQ</span> <span class="err">BP</span>
<span class="m">140</span><span class="err">ms</span>      <span class="m">140</span><span class="err">ms</span>   <span class="m">51</span><span class="nl">fdb8:</span>     <span class="err">RET</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdb9:</span>     <span class="err">MOVQ</span> <span class="err">AX</span><span class="p">,</span> <span class="m">0x8</span><span class="p">(</span><span class="err">SP</span><span class="p">)</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdbe:</span>     <span class="err">NOPW</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdc0:</span>     <span class="err">CALL</span> <span class="err">runtime</span><span class="p">.</span><span class="err">morestack_noctxt</span><span class="p">.</span><span class="err">abi0</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdc5:</span>     <span class="err">MOVQ</span> <span class="m">0x8</span><span class="p">(</span><span class="err">SP</span><span class="p">),</span> <span class="err">AX</span>
    <span class="p">.</span>          <span class="p">.</span>   <span class="m">51</span><span class="nl">fdca:</span>     <span class="err">JMP</span> <span class="p">.</span><span class="err">yessplit</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly (Go Syntax)</div></div></div> <p>The time spent at each instruction (for the whole benchmark, where I made sure equal time was spent on each test case with <code class="language-plaintext highlighter-rouge">-benchtime Nx</code>) is comparable for all of the instructions these functions share, but an additional ~2% cost is incurred for the stack check.</p> <p>This is a very artificial setup, because the <code class="language-plaintext highlighter-rouge">g</code> struct is always in L1 in the <code class="language-plaintext highlighter-rouge">yessplit</code> benchmark due to the fact that no other memory operations occur in the loop. However, for very hot code that needs to saturate the cache, this can have an outsized effect due to cache misses. We can enhance this benchmark by adding an assembly function that executes <code class="language-plaintext highlighter-rouge">clflush [r14]</code>, which causes the <code class="language-plaintext highlighter-rouge">g</code> struct to be ejected from all caches.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="err">TEXT</span> <span class="p">.</span><span class="err">clflush</span><span class="p">(</span><span class="err">SB</span><span class="p">)</span>
  <span class="err">CLFLUSH</span> <span class="p">(</span><span class="err">R14</span><span class="p">)</span>  <span class="err">//</span> <span class="err">Eject</span> <span class="err">the</span> <span class="err">pointee</span> <span class="err">of</span> <span class="err">r14</span> <span class="k">from</span> <span class="err">all</span> <span class="err">caches</span><span class="p">.</span>
  <span class="err">RET</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly (Go Syntax)</div></div></div> <p>If we add a call to this function to both benchmark loops, we see the staggering cost of a cold fetch from RAM show up in every function call: 120.1 nanosecods for <code class="language-plaintext highlighter-rouge">BenchmarkCall/nosplit</code>, versus 332.1 nanoseconds for <code class="language-plaintext highlighter-rouge">BenchmarkCall/yessplit</code>. The 200 nanosecond difference is a fetch from main memory. An L1 miss is about 15 times less expensive, so if the <code class="language-plaintext highlighter-rouge">g</code> struct manages to get kicked out of L1, you’re paying about 15 or so nanoseconds, or about two map lookups!</p> <p>Despite the language resisting adding an inlining heuristic, which programmers would place everywhere without knowing what it does, they <em>did</em> provide something worse that makes code noticeably faster: nosplit.</p> <h2 id="but-its-harmless"><a href="#but-its-harmless">But It’s Harmless…?</a></h2> <p>Consider the following program<sup id="fnref:consider" role="doc-noteref"><a href="#fn:consider" class="footnote" rel="footnote">2</a></sup>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c">//go:nosplit</span>
<span class="k">func</span> <span class="n">x</span><span class="p">(</span><span class="n">y</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="m">1</span><span class="p">)</span> <span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Naturally, this will instantly overflow the stack. Instead, we get a really scary linker error:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">x.x: nosplit stack over 792 byte limit
</span><span class="gp">x.x&lt;1&gt;</span><span class="w">
</span><span class="gp">    grows 24 bytes, calls x.x&lt;1&gt;</span><span class="w">
</span><span class="go">    infinite cycle</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>The Go linker contains a check to verify that any chain of nosplit functions which call nosplit functions do not overflow a small window of extra stack, which is where the stack frames of nosplit functions live if they go past <code class="language-plaintext highlighter-rouge">stackguard0</code>.</p> <p>Every stack frame contributes some stack use (for the return address, at minimum), so the number of functions you can call before you get this error is limited. And because every function needs to allocate space for all of its callees to spill their arguments if necessary, you can hit this limit every fast if every one of these functions uses every available argument register (ask me how I know).</p> <p>Also, turning on fuzzing instruments the code by inserting nosplit calls into the fuzzer runtime around branches, meaning that turning on fuzzing can <em>previously fine code to no longer link</em>. Stack usage also varies slightly by architecture, meaning that code which builds in one architecture fails to link in others (most visible when going from 32-bit to 64-bit).</p> <p>There is no easy way to control directives using build tags (two poorly-designed features collide), so you cannot just “turn off” performance-sensitive nosplits for debugging, either.</p> <p>For this reason, you must be <em>very very careful</em> about using nosplit for performance.</p> <h3 id="virtual-nosplit-functions"><a href="#virtual-nosplit-functions">Virtual Nosplit Functions</a></h3> <p>Excitingly, nosplit functions whose addresses are taken do not have special codegen, allowing us to defeat the linker stack check by using virtual function calls.</p> <p>Consider the following program:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">var</span> <span class="n">f</span> <span class="k">func</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>

<span class="c">//go:nosplit</span>
<span class="k">func</span> <span class="n">x</span><span class="p">(</span><span class="n">y</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="n">f</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="m">1</span><span class="p">)</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">x</span>
  <span class="n">f</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This will quickly exhaust the main G’s tiny stack and segfault in the most violent way imaginable, preventing the runtime from printing a debug trace. All this program outputs is <code class="language-plaintext highlighter-rouge">signal: segmentation fault</code>.</p> <p>This is <a href="https://github.com/golang/go/issues/74478">probably a bug</a>.</p> <h2 id="other-side-effects"><a href="#other-side-effects">Other Side Effects</a></h2> <p>It turns out that nosplit has various other fun side-effects that are not documented anywhere. The main thing it does is it contributes to whether a function is considered “unsafe” by the runtime.</p> <p>Consider the following program:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"fmt"</span>
  <span class="s">"os"</span>
  <span class="s">"runtime"</span>
  <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="k">range</span> <span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">{}</span>
    <span class="p">}()</span>
  <span class="p">}</span>
  <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span> <span class="c">// Wait for all the other Gs to start.</span>

  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This program will make sure that every P becomes bound to a G that loops forever, meaning they will never trap into the runtime. Thus, this program will hang forever, never printing its result and exiting. But that’s not what happens.</p> <p>Thanks to asynchronous preemption, the scheduler will detect Gs that have been running for too long, and preempt its M by sending a signal to it (<a href="https://cs.opensource.google/go/go/+/master:src/runtime/signal_unix.go;l=43">due to happenstance</a>, this is <code class="language-plaintext highlighter-rouge">SIGURG</code> of all things.)</p> <p>However, asynchronous preemption is only possible when the M stops due to the signal at a safe point, as determined by <code class="language-plaintext highlighter-rouge">runtime.isAsyncSafePoint</code>. It includes the following block of code:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go">	<span class="n">up</span><span class="p">,</span> <span class="n">startpc</span> <span class="o">:=</span> <span class="n">pcdatavalue2</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abi</span><span class="o">.</span><span class="n">PCDATA_UnsafePoint</span><span class="p">,</span> <span class="n">pc</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">up</span> <span class="o">==</span> <span class="n">abi</span><span class="o">.</span><span class="n">UnsafePointUnsafe</span> <span class="p">{</span>
		<span class="c">// Unsafe-point marked by compiler. This includes</span>
		<span class="c">// atomic sequences (e.g., write barrier) and nosplit</span>
		<span class="c">// functions (except at calls).</span>
		<span class="k">return</span> <span class="no">false</span><span class="p">,</span> <span class="m">0</span>
	<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>If we chase down where this value is set, we’ll find that it is set explicitly for write barrier sequences, for any function that is “part of the runtime” (as defined by being built with the <code class="language-plaintext highlighter-rouge">-+</code> flag) and <em>for any nosplit function</em>.</p> <p>With a small modification of hoisting the <code class="language-plaintext highlighter-rouge">go</code> body into a nosplit function, the following program will run forever: it will never wake up from <code class="language-plaintext highlighter-rouge">time.Sleep</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"fmt"</span>
  <span class="s">"os"</span>
  <span class="s">"runtime"</span>
  <span class="s">"time"</span>
<span class="p">)</span>

<span class="c">//go:nosplit</span>
<span class="k">func</span> <span class="n">forever</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="k">range</span> <span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">go</span> <span class="n">forever</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span> <span class="c">// Wait for all the other Gs to start.</span>

  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Even though there is work to do, every P is bound to a G that will never reach a safe point, so there will never be a P available to run the main goroutine.</p> <p>This represents another potential danger of using nosplit functions: those that do not call preemptable functions must terminate promptly, or risk livelocking the whole runtime.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>I use nosplit <em>a lot</em>, because I write high-performance, low-latency Go. This is a very insane thing to do, which has caused me to slowly generate bug reports whenever I hit strange corner cases.</p> <p>For example, there are many cases where spill regions are allocated for functions that never use them, for example, functions which only call nosplit functions allocate space for them to spill their arguments, which they don’t do.<sup id="fnref:spill-area" role="doc-noteref"><a href="#fn:spill-area" class="footnote" rel="footnote">3</a></sup></p> <p>This is a documented Go language feature which:</p> <ol> <li>Isn’t very well-documented (the async preemption behavior certainly isn’t)!</li> <li>Has very scary optimization-dependent build failures.</li> <li>Can cause livelock and mysterious segfaults.</li> <li>Can be used in user programs that don’t <code class="language-plaintext highlighter-rouge">import "unsafe"</code>!</li> <li>And it makes code faster!</li> </ol> <p>I’m surprised such a massive footgun exists at all, buuuut it’s a measureable benchmark improvement for me, so it’s impossible to tell if it’s bad or not.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:unused-spill" role="doc-endnote"> <p>The astute reader will observe that because preemption is not reentrant, only one of these spill regions will be in use at at time in a G. This is a known bug in the ABI, and is essentially a bodge to enable easy adoption of passing arguments by register, without needing all of the parts of the runtime that expect arguments to be spilled to the stack, as was the case in the slow old days when Go’s ABI on every platform was “<code class="language-plaintext highlighter-rouge">i386-unknown-linux</code> but worse”, i.e., arguments went on the stack and made the CPU’s store queue sad.</p> <p>I recently filed <a href="https://github.com/golang/go/issues/74413">a bug about this</a> that boils down to “add a field to <code class="language-plaintext highlighter-rouge">runtime.g</code> to use a spill space”, which seems to me to be simpler than the alternatives described in the <code class="language-plaintext highlighter-rouge">ABIInternal</code> spec. <a href="#fnref:unused-spill" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:consider" role="doc-endnote"> <p>Basically every bug report I write starts with these four words and it means you’re about to see the worst program ever written. <a href="#fnref:consider" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:spill-area" role="doc-endnote"> <p>The spill area is also used for spilling arguments across calls, but in this case, it is not necessary for the caller to allocate it for a nosplit function. <a href="#fnref:spill-area" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-06-03</span> / <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/">Protobuf Tip #7: Scoping It Out</a></h6> <li> <span class="post-meta">2025-05-20</span> / <h6 style="display:inline"><a href="/2025/05/20/protobuf-tip-6/">Protobuf Tip #6: The Subtle Dangers of Enum Aliases</a></h6> <li> <span class="post-meta">2025-05-13</span> / <h6 style="display:inline"><a href="/2025/05/13/protobuf-tip-5/">Protobuf Tip #5: Avoid import public/weak</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-07-07</span> <span class="censored">•</span> <span class="censored">1880</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">15</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#go"><span class="censored">#go</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#dark-arts"><span class="censored">#dark-arts</span></a> </span> <h1><a href="/2025/07/07/nosplit/"> <span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span> </a></h1> </div> <div class="post"> <p><span class="censored">Most</span> <span class="censored">people</span> <span class="censored">don’t</span> <span class="censored">know</span> <span class="censored">that</span> <span class="censored">Go</span> <span class="censored">has</span> <span class="censored">special</span> <span class="censored">syntax</span> <span class="censored">for</span> <span class="censored">directives.</span> <span class="censored">Unfortunately,</span> <span class="censored">it’s</span> <span class="censored">not</span> <span class="censored">real</span> <span class="censored">syntax,</span> <span class="censored">it’s</span> <span class="censored">just</span> <span class="censored">a</span> <span class="censored">comment.</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:noinline</span></code> <span class="censored">causes</span> <span class="censored">the</span> <span class="censored">next</span> <span class="censored">function</span> <span class="censored">declaration</span> <span class="censored">to</span> <span class="censored">never</span> <span class="censored">get</span> <span class="censored">inlined,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">changing</span> <span class="censored">the</span> <span class="censored">inlining</span> <span class="censored">cost</span> <span class="censored">of</span> <span class="censored">functions</span> <span class="censored">that</span> <span class="censored">call</span> <span class="censored">it.</span></p> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">three</span> <span class="censored">types</span> <span class="censored">of</span> <span class="censored">directives:</span></p> <ol> <li> <p><span class="censored">The</span> <span class="censored">ones</span> <span class="censored">documented</span> <span class="censored">in</span> <a href="https://pkg.go.dev/cmd/compile#hdr-Function_Directives"><code class="language-plaintext highlighter-rouge"><span class="censored">gc</span></code><span class="censored">’s</span> <span class="censored">doc</span> <span class="censored">comment</span></a><span class="censored">.</span> <span class="censored">This</span> <span class="censored">includes</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:noinline</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//line</span></code><span class="censored">.</span></p> </li> <li> <p><span class="censored">The</span> <span class="censored">ones</span> <span class="censored">documented</span> <span class="censored">elsewhere,</span> <span class="censored">such</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:build</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:generate</span></code><span class="censored">.</span></p> </li> <li> <p><span class="censored">The</span> <span class="censored">ones</span> <span class="censored">documented</span> <span class="censored">in</span> <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.24.4:src/runtime/HACKING.md"><span class="censored">runtime/HACKING.md</span></a><span class="censored">,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">only</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">if</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-+</span></code> <span class="censored">flag</span> <span class="censored">is</span> <span class="censored">passed</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">gc</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">includes</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:nowritebarrier</span></code><span class="censored">.</span></p> </li> <li> <p><span class="censored">The</span> <span class="censored">ones</span> <span class="censored">not</span> <span class="censored">documented</span> <span class="censored">at</span> <span class="censored">all,</span> <span class="censored">whose</span> <span class="censored">existence</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">discovered</span> <span class="censored">by</span> <span class="censored">searching</span> <span class="censored">the</span> <span class="censored">compiler’s</span> <span class="censored">tests.</span> <span class="censored">These</span> <span class="censored">include</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:nocheckptr</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:nointerface</span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:debug</span></code><span class="censored">.</span></p> </li> </ol> <p><span class="censored">We</span> <span class="censored">are</span> <span class="censored">most</span> <span class="censored">interested</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">directive</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">first</span> <span class="censored">type,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:nosplit</span></code><span class="censored">.</span> <span class="censored">According</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">documentation:</span></p> <blockquote> <p><span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:nosplit</span></code> <span class="censored">directive</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">followed</span> <span class="censored">by</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">declaration.</span> <span class="censored">It</span> <span class="censored">specifies</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">function</span> <span class="censored">must</span> <span class="censored">omit</span> <span class="censored">its</span> <span class="censored">usual</span> <span class="censored">stack</span> <span class="censored">overflow</span> <span class="censored">check.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">most</span> <span class="censored">commonly</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">low-level</span> <span class="censored">runtime</span> <span class="censored">code</span> <span class="censored">invoked</span> <span class="censored">at</span> <span class="censored">times</span> <span class="censored">when</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">unsafe</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">calling</span> <span class="censored">goroutine</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">preempted.</span></p> </blockquote> <p><span class="censored">What</span> <span class="censored">does</span> <span class="censored">this</span> <span class="censored">even</span> <span class="censored">mean?</span> <span class="censored">Normal</span> <span class="censored">program</span> <span class="censored">code</span> <span class="censored">can</span> <span class="censored">use</span> <span class="censored">this</span> <span class="censored">annotation,</span> <span class="censored">but</span> <span class="censored">its</span> <span class="censored">behavior</span> <span class="censored">is</span> <span class="censored">poorly</span> <span class="censored">specified.</span> <span class="censored">Let’s</span> <span class="censored">dig</span> <span class="censored">in.</span></p> <h2 id="go-stack-growth"><a href="#go-stack-growth"><span class="censored">Go</span> <span class="censored">Stack</span> <span class="censored">Growth</span></a></h2> <p><span class="censored">Go</span> <span class="censored">allocates</span> <span class="censored">very</span> <span class="censored">small</span> <span class="censored">stacks</span> <span class="censored">for</span> <span class="censored">new</span> <span class="censored">goroutines,</span> <span class="censored">which</span> <span class="censored">grow</span> <span class="censored">their</span> <span class="censored">stack</span> <span class="censored">dynamically.</span> <span class="censored">This</span> <span class="censored">allows</span> <span class="censored">a</span> <span class="censored">program</span> <span class="censored">to</span> <span class="censored">spawn</span> <span class="censored">a</span> <span class="censored">large</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">short-lived</span> <span class="censored">goroutines</span> <span class="censored">without</span> <span class="censored">spending</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">memory</span> <span class="censored">on</span> <span class="censored">their</span> <span class="censored">stacks.</span></p> <p><span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">it’s</span> <span class="censored">very</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">overflow</span> <span class="censored">the</span> <span class="censored">stack.</span> <span class="censored">Every</span> <span class="censored">function</span> <span class="censored">knows</span> <span class="censored">how</span> <span class="censored">large</span> <span class="censored">its</span> <span class="censored">stack</span> <span class="censored">is,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">runtime.g</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">goroutine</span> <span class="censored">struct,</span> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">end</span> <span class="censored">position</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">stack;</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">pointer</span> <span class="censored">is</span> <span class="censored">less</span> <span class="censored">than</span> <span class="censored">it</span> <span class="censored">(the</span> <span class="censored">stack</span> <span class="censored">grows</span> <span class="censored">up)</span> <span class="censored">control</span> <span class="censored">passes</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">runtime.morestack</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">effectively</span> <span class="censored">preempts</span> <span class="censored">the</span> <span class="censored">goroutine</span> <span class="censored">while</span> <span class="censored">its</span> <span class="censored">stack</span> <span class="censored">is</span> <span class="censored">resized.</span></p> <p><span class="censored">In</span> <span class="censored">effect,</span> <span class="censored">every</span> <span class="censored">Go</span> <span class="censored">function</span> <span class="censored">has</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">code</span> <span class="censored">around</span> <span class="censored">it:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="err"><span class="censored">TEXT</span></span>    <span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">f</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">),</span></span> <span class="err"><span class="censored">ABIInternal</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">24-16</span></span>
  <span class="err"><span class="censored">CMPQ</span></span>    <span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">16</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">R14</span></span><span class="p"><span class="censored">)</span></span>
  <span class="err"><span class="censored">JLS</span></span>     <span class="err"><span class="censored">grow</span></span>
  <span class="err"><span class="censored">PUSHQ</span></span>   <span class="err"><span class="censored">BP</span></span>
  <span class="err"><span class="censored">MOVQ</span></span>    <span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">BP</span></span>
  <span class="err"><span class="censored">SUBQ</span></span>    <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">16</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">SP</span></span>
  <span class="err"><span class="censored">//</span></span> <span class="err"><span class="censored">Function</span></span> <span class="err"><span class="censored">body</span></span><span class="p"><span class="censored">...</span></span>
  <span class="err"><span class="censored">ADDQ</span></span>    <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">16</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">SP</span></span>
  <span class="err"><span class="censored">POPQ</span></span>    <span class="err"><span class="censored">BP</span></span>
  <span class="err"><span class="censored">RET</span></span>
<span class="nl"><span class="censored">grow:</span></span>
  <span class="err"><span class="censored">MOVQ</span></span>    <span class="err"><span class="censored">AX</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">8</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">)</span></span>
  <span class="err"><span class="censored">MOVQ</span></span>    <span class="err"><span class="censored">BX</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">16</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">)</span></span>
  <span class="err"><span class="censored">CALL</span></span>    <span class="err"><span class="censored">runtime</span></span><span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">morestack_noctxt</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span>
  <span class="err"><span class="censored">MOVQ</span></span>    <span class="m"><span class="censored">8</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">),</span></span> <span class="err"><span class="censored">AX</span></span>
  <span class="err"><span class="censored">MOVQ</span></span>    <span class="m"><span class="censored">16</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">),</span></span> <span class="err"><span class="censored">BX</span></span>
  <span class="err"><span class="censored">JMP</span></span>     <span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">f</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"> <span class="censored">x86</span> <span class="censored">Assembly</span> <span class="censored">(Go</span> <span class="censored">Syntax)</span> </div></div> </div> <p><span class="censored">Note</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">r14</span></code> <span class="censored">holds</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">current</span> <code class="language-plaintext highlighter-rouge"><span class="censored">runtime.g</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">limit</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">third</span> <span class="censored">word-sized</span> <span class="censored">field</span> <span class="censored">(</span><code class="language-plaintext highlighter-rouge"><span class="censored">runtime.g.stackguard0</span></code><span class="censored">)</span> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">struct,</span> <span class="censored">hence</span> <span class="censored">the</span> <span class="censored">offset</span> <span class="censored">of</span> <span class="censored">16.</span> <span class="censored">If</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">is</span> <span class="censored">about</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">exhausted,</span> <span class="censored">it</span> <span class="censored">jumps</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">special</span> <span class="censored">block</span> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">end</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">function</span> <span class="censored">that</span> <span class="censored">spills</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">argument</span> <span class="censored">registers,</span> <span class="censored">traps</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">runtime,</span> <span class="censored">and,</span> <span class="censored">once</span> <span class="censored">that’s</span> <span class="censored">done,</span> <span class="censored">unspills</span> <span class="censored">the</span> <span class="censored">arguments</span> <span class="censored">and</span> <span class="censored">re-starts</span> <span class="censored">the</span> <span class="censored">function.</span></p> <p><span class="censored">Note</span> <span class="censored">that</span> <span class="censored">arguments</span> <span class="censored">are</span> <span class="censored">spilled</span> <em><span class="censored">before</span></em> <span class="censored">adjusting</span> <code class="language-plaintext highlighter-rouge"><span class="censored">rsp</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">arguments</span> <span class="censored">are</span> <span class="censored">written</span> <span class="censored">to</span> <span class="censored">the</span> <em><span class="censored">caller’s</span></em> <span class="censored">stack</span> <span class="censored">frame.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">Go’s</span> <span class="censored">ABI;</span> <span class="censored">callers</span> <span class="censored">must</span> <span class="censored">allocate</span> <span class="censored">space</span> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">top</span> <span class="censored">of</span> <span class="censored">their</span> <span class="censored">stack</span> <span class="censored">frames</span> <span class="censored">for</span> <span class="censored">any</span> <span class="censored">function</span> <span class="censored">that</span> <span class="censored">they</span> <span class="censored">call</span> <span class="censored">to</span> <span class="censored">spill</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">registers</span> <span class="censored">for</span> <span class="censored">preemption</span><sup id="fnref:unused-spill" role="doc-noteref"><a href="#fn:unused-spill" class="footnote" rel="footnote"><span class="censored">1</span></a></sup><span class="censored">.</span></p> <p><span class="censored">Preemption</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">reentrant,</span> <span class="censored">which</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">functions</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">running</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">context</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">preempted</span> <span class="censored">G</span> <span class="censored">or</span> <span class="censored">with</span> <span class="censored">no</span> <span class="censored">G</span> <span class="censored">at</span> <span class="censored">all</span> <span class="censored">must</span> <span class="censored">not</span> <span class="censored">be</span> <span class="censored">preempted</span> <span class="censored">by</span> <span class="censored">this</span> <span class="censored">check.</span></p> <h2 id="nosplit-functions"><a href="#nosplit-functions"><span class="censored">Nosplit</span> <span class="censored">Functions</span></a></h2> <p><span class="censored">The</span> <code class="language-plaintext highlighter-rouge"><span class="censored">//go:nosplit</span></code> <span class="censored">directive</span> <span class="censored">marks</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">as</span> <span class="censored">“nosplit”,</span> <span class="censored">or</span> <span class="censored">a</span> <span class="censored">“non-splitting</span> <span class="censored">function”.</span> <span class="censored">“Splitting”</span> <span class="censored">has</span> <span class="censored">nothing</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">with</span> <span class="censored">what</span> <span class="censored">this</span> <span class="censored">directive</span> <span class="censored">does.</span></p> <blockquote> <h4 id="segmented-stacks"><a href="#segmented-stacks"><span class="censored">Segmented</span> <span class="censored">Stacks</span></a></h4> <p><span class="censored">In</span> <span class="censored">the</span> <span class="censored">bad</span> <span class="censored">old</span> <span class="censored">days,</span> <span class="censored">Go’s</span> <span class="censored">stacks</span> <span class="censored">were</span> <em><span class="censored">split</span></em> <span class="censored">up</span> <span class="censored">into</span> <em><span class="censored">segments</span></em><span class="censored">,</span> <span class="censored">where</span> <span class="censored">each</span> <span class="censored">segment</span> <span class="censored">ended</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">next,</span> <span class="censored">effectively</span> <span class="censored">replacing</span> <span class="censored">the</span> <span class="censored">stack’s</span> <span class="censored">single</span> <span class="censored">array</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">linked</span> <span class="censored">list</span> <span class="censored">of</span> <span class="censored">such</span> <span class="censored">arrays.</span></p> <p><span class="censored">Segmented</span> <span class="censored">stacks</span> <span class="censored">were</span> <span class="censored">terrible.</span> <span class="censored">Instead</span> <span class="censored">of</span> <span class="censored">triggering</span> <span class="censored">a</span> <span class="censored">resize,</span> <span class="censored">these</span> <span class="censored">prologues</span> <span class="censored">were</span> <span class="censored">responsible</span> <span class="censored">for</span> <span class="censored">updating</span> <code class="language-plaintext highlighter-rouge"><span class="censored">rsp</span></code> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">next</span> <span class="censored">(or</span> <span class="censored">previous)</span> <span class="censored">block</span> <span class="censored">by</span> <span class="censored">following</span> <span class="censored">this</span> <span class="censored">pointer,</span> <span class="censored">whenever</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">segment</span> <span class="censored">bottomed</span> <span class="censored">out.</span> <span class="censored">This</span> <span class="censored">meant</span> <span class="censored">that</span> <span class="censored">if</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">call</span> <span class="censored">happened</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">on</span> <span class="censored">a</span> <span class="censored">segment</span> <span class="censored">boundary,</span> <span class="censored">it</span> <span class="censored">would</span> <span class="censored">be</span> <em><span class="censored">extremely</span> <span class="censored">slow</span></em> <span class="censored">in</span> <span class="censored">comparison</span> <span class="censored">to</span> <span class="censored">other</span> <span class="censored">function</span> <span class="censored">calls,</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">significant</span> <span class="censored">work</span> <span class="censored">required</span> <span class="censored">to</span> <span class="censored">update</span> <code class="language-plaintext highlighter-rouge"><span class="censored">rsp</span></code> <span class="censored">correctly.</span></p> <p><span class="censored">This</span> <span class="censored">meant</span> <span class="censored">that</span> <span class="censored">unlucky</span> <span class="censored">sizing</span> <span class="censored">of</span> <span class="censored">stack</span> <span class="censored">frames</span> <span class="censored">meant</span> <span class="censored">sudden</span> <span class="censored">performance</span> <span class="censored">cliffs.</span> <span class="censored">Fun!</span></p> <p><span class="censored">Go</span> <span class="censored">has</span> <span class="censored">since</span> <span class="censored">figured</span> <span class="censored">out</span> <span class="censored">that</span> <span class="censored">segmented</span> <span class="censored">stacks</span> <span class="censored">are</span> <span class="censored">a</span> <span class="censored">terrible</span> <span class="censored">idea.</span> <span class="censored">In</span> <span class="censored">the</span> <span class="censored">process</span> <span class="censored">of</span> <span class="censored">implementing</span> <span class="censored">a</span> <span class="censored">correct</span> <span class="censored">GC</span> <span class="censored">stack</span> <span class="censored">scanning</span> <span class="censored">algorithm</span> <span class="censored">(which</span> <span class="censored">it</span> <span class="censored">did</span> <span class="censored">not</span> <span class="censored">have</span> <span class="censored">for</span> <span class="censored">many</span> <span class="censored">stable</span> <span class="censored">releases),</span> <span class="censored">it</span> <span class="censored">also</span> <span class="censored">gained</span> <span class="censored">the</span> <span class="censored">ability</span> <span class="censored">to</span> <span class="censored">copy</span> <span class="censored">the</span> <span class="censored">contents</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">stack</span> <span class="censored">from</span> <span class="censored">one</span> <span class="censored">location</span> <span class="censored">to</span> <span class="censored">another,</span> <span class="censored">updating</span> <span class="censored">pointers</span> <span class="censored">in</span> <span class="censored">such</span> <span class="censored">a</span> <span class="censored">way</span> <span class="censored">that</span> <span class="censored">user</span> <span class="censored">code</span> <span class="censored">wouldn’t</span> <span class="censored">notice.</span></p> <p><span class="censored">This</span> <span class="censored">stack</span> <span class="censored">splitting</span> <span class="censored">code</span> <span class="censored">is</span> <span class="censored">where</span> <span class="censored">the</span> <span class="censored">name</span> <span class="censored">“nosplit”</span> <span class="censored">comes</span> <span class="censored">from.</span></p> </blockquote> <p><span class="censored">A</span> <span class="censored">nosplit</span> <span class="censored">function</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">load</span> <span class="censored">and</span> <span class="censored">branch</span> <span class="censored">on</span> <code class="language-plaintext highlighter-rouge"><span class="censored">runtime.g.stackguard0</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">simply</span> <span class="censored">assumes</span> <span class="censored">it</span> <span class="censored">has</span> <span class="censored">enough</span> <span class="censored">stack.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">nosplit</span> <span class="censored">functions</span> <span class="censored">will</span> <span class="censored">not</span> <span class="censored">preempt</span> <span class="censored">themselves,</span> <span class="censored">and,</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">result,</span> <span class="censored">are</span> <span class="censored">noticeably</span> <span class="censored">faster</span> <span class="censored">to</span> <span class="censored">call</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">hot</span> <span class="censored">loop.</span> <span class="censored">Don’t</span> <span class="censored">believe</span> <span class="censored">me?</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c"><span class="censored">//go:noinline</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">noinline</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span> <span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{}</span></span>

<span class="c"><span class="censored">//go:nosplit</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">nosplit</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span> <span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="n"><span class="censored">noinline</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">}</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">yessplit</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span> <span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="n"><span class="censored">noinline</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">BenchmarkCall</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">testing</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">B</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Run</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"nosplit"</span></span><span class="p"><span class="censored">,</span></span> <span class="k"><span class="censored">func</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">testing</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">B</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="k"><span class="censored">for</span></span> <span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Loop</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span> <span class="n"><span class="censored">nosplit</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">42</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">}</span></span>
  <span class="p"><span class="censored">})</span></span>
  <span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Run</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"yessplit"</span></span><span class="p"><span class="censored">,</span></span> <span class="k"><span class="censored">func</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">*</span></span><span class="n"><span class="censored">testing</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">B</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="k"><span class="censored">for</span></span> <span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Loop</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span> <span class="n"><span class="censored">yessplit</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">42</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">}</span></span>
  <span class="p"><span class="censored">})</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">If</span> <span class="censored">we</span> <span class="censored">profile</span> <span class="censored">this</span> <span class="censored">and</span> <span class="censored">pull</span> <span class="censored">up</span> <span class="censored">the</span> <span class="censored">timings</span> <span class="censored">for</span> <span class="censored">each</span> <span class="censored">function,</span> <span class="censored">here’s</span> <span class="censored">what</span> <span class="censored">we</span> <span class="censored">get:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="m"><span class="censored">390</span></span><span class="err"><span class="censored">ms</span></span>      <span class="m"><span class="censored">390</span></span><span class="err"><span class="censored">ms</span></span>           <span class="err"><span class="censored">func</span></span> <span class="err"><span class="censored">nosplit</span></span><span class="p"><span class="censored">(x</span></span> <span class="err"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="k"><span class="censored">noinline</span></span><span class="p"><span class="censored">(x)</span></span> <span class="p"><span class="censored">}</span></span>
 <span class="m"><span class="censored">60</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">60</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd80:</span></span>     <span class="err"><span class="censored">PUSHQ</span></span> <span class="err"><span class="censored">BP</span></span>
 <span class="m"><span class="censored">10</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">10</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd81:</span></span>     <span class="err"><span class="censored">MOVQ</span></span> <span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">BP</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd84:</span></span>     <span class="err"><span class="censored">SUBQ</span></span> <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">0x8</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">SP</span></span>
 <span class="m"><span class="censored">60</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">60</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd88:</span></span>     <span class="err"><span class="censored">CALL</span></span> <span class="p"><span class="censored">.</span></span><span class="k"><span class="censored">noinline</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span>
<span class="m"><span class="censored">190</span></span><span class="err"><span class="censored">ms</span></span>      <span class="m"><span class="censored">190</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd8d:</span></span>     <span class="err"><span class="censored">ADDQ</span></span> <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">0x8</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">SP</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd91:</span></span>     <span class="err"><span class="censored">POPQ</span></span> <span class="err"><span class="censored">BP</span></span>
 <span class="m"><span class="censored">70</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">70</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fd92:</span></span>     <span class="err"><span class="censored">RET</span></span>

<span class="m"><span class="censored">440</span></span><span class="err"><span class="censored">ms</span></span>      <span class="m"><span class="censored">490</span></span><span class="err"><span class="censored">ms</span></span>           <span class="err"><span class="censored">func</span></span> <span class="err"><span class="censored">yessplit</span></span><span class="p"><span class="censored">(x</span></span> <span class="err"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="k"><span class="censored">noinline</span></span><span class="p"><span class="censored">(x)</span></span> <span class="p"><span class="censored">}</span></span>
 <span class="m"><span class="censored">50</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">50</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fda0:</span></span>     <span class="err"><span class="censored">CMPQ</span></span> <span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0x10</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">R14</span></span><span class="p"><span class="censored">)</span></span>
 <span class="m"><span class="censored">20</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">20</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fda4:</span></span>     <span class="err"><span class="censored">JBE</span></span> <span class="m"><span class="censored">0x51fdb9</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fda6:</span></span>     <span class="err"><span class="censored">PUSHQ</span></span> <span class="err"><span class="censored">BP</span></span>
 <span class="m"><span class="censored">20</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">20</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fda7:</span></span>     <span class="err"><span class="censored">MOVQ</span></span> <span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">BP</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdaa:</span></span>     <span class="err"><span class="censored">SUBQ</span></span> <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">0x8</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">SP</span></span>
 <span class="m"><span class="censored">10</span></span><span class="err"><span class="censored">ms</span></span>       <span class="m"><span class="censored">60</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdae:</span></span>     <span class="err"><span class="censored">CALL</span></span> <span class="p"><span class="censored">.</span></span><span class="k"><span class="censored">noinline</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span>
<span class="m"><span class="censored">200</span></span><span class="err"><span class="censored">ms</span></span>      <span class="m"><span class="censored">200</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdb3:</span></span>     <span class="err"><span class="censored">ADDQ</span></span> <span class="err"><span class="censored">$</span></span><span class="m"><span class="censored">0x8</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">SP</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdb7:</span></span>     <span class="err"><span class="censored">POPQ</span></span> <span class="err"><span class="censored">BP</span></span>
<span class="m"><span class="censored">140</span></span><span class="err"><span class="censored">ms</span></span>      <span class="m"><span class="censored">140</span></span><span class="err"><span class="censored">ms</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdb8:</span></span>     <span class="err"><span class="censored">RET</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdb9:</span></span>     <span class="err"><span class="censored">MOVQ</span></span> <span class="err"><span class="censored">AX</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0x8</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">)</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdbe:</span></span>     <span class="err"><span class="censored">NOPW</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdc0:</span></span>     <span class="err"><span class="censored">CALL</span></span> <span class="err"><span class="censored">runtime</span></span><span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">morestack_noctxt</span></span><span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">abi0</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdc5:</span></span>     <span class="err"><span class="censored">MOVQ</span></span> <span class="m"><span class="censored">0x8</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SP</span></span><span class="p"><span class="censored">),</span></span> <span class="err"><span class="censored">AX</span></span>
    <span class="p"><span class="censored">.</span></span>          <span class="p"><span class="censored">.</span></span>   <span class="m"><span class="censored">51</span></span><span class="nl"><span class="censored">fdca:</span></span>     <span class="err"><span class="censored">JMP</span></span> <span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">yessplit</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"> <span class="censored">x86</span> <span class="censored">Assembly</span> <span class="censored">(Go</span> <span class="censored">Syntax)</span> </div></div> </div> <p><span class="censored">The</span> <span class="censored">time</span> <span class="censored">spent</span> <span class="censored">at</span> <span class="censored">each</span> <span class="censored">instruction</span> <span class="censored">(for</span> <span class="censored">the</span> <span class="censored">whole</span> <span class="censored">benchmark,</span> <span class="censored">where</span> <span class="censored">I</span> <span class="censored">made</span> <span class="censored">sure</span> <span class="censored">equal</span> <span class="censored">time</span> <span class="censored">was</span> <span class="censored">spent</span> <span class="censored">on</span> <span class="censored">each</span> <span class="censored">test</span> <span class="censored">case</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-benchtime</span> <span class="censored">Nx</span></code><span class="censored">)</span> <span class="censored">is</span> <span class="censored">comparable</span> <span class="censored">for</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">instructions</span> <span class="censored">these</span> <span class="censored">functions</span> <span class="censored">share,</span> <span class="censored">but</span> <span class="censored">an</span> <span class="censored">additional</span> <span class="censored">~2%</span> <span class="censored">cost</span> <span class="censored">is</span> <span class="censored">incurred</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">check.</span></p> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">artificial</span> <span class="censored">setup,</span> <span class="censored">because</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">g</span></code> <span class="censored">struct</span> <span class="censored">is</span> <span class="censored">always</span> <span class="censored">in</span> <span class="censored">L1</span> <span class="censored">in</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">yessplit</span></code> <span class="censored">benchmark</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">fact</span> <span class="censored">that</span> <span class="censored">no</span> <span class="censored">other</span> <span class="censored">memory</span> <span class="censored">operations</span> <span class="censored">occur</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">loop.</span> <span class="censored">However,</span> <span class="censored">for</span> <span class="censored">very</span> <span class="censored">hot</span> <span class="censored">code</span> <span class="censored">that</span> <span class="censored">needs</span> <span class="censored">to</span> <span class="censored">saturate</span> <span class="censored">the</span> <span class="censored">cache,</span> <span class="censored">this</span> <span class="censored">can</span> <span class="censored">have</span> <span class="censored">an</span> <span class="censored">outsized</span> <span class="censored">effect</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">cache</span> <span class="censored">misses.</span> <span class="censored">We</span> <span class="censored">can</span> <span class="censored">enhance</span> <span class="censored">this</span> <span class="censored">benchmark</span> <span class="censored">by</span> <span class="censored">adding</span> <span class="censored">an</span> <span class="censored">assembly</span> <span class="censored">function</span> <span class="censored">that</span> <span class="censored">executes</span> <code class="language-plaintext highlighter-rouge"><span class="censored">clflush</span> <span class="censored">[r14]</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">causes</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">g</span></code> <span class="censored">struct</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">ejected</span> <span class="censored">from</span> <span class="censored">all</span> <span class="censored">caches.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="err"><span class="censored">TEXT</span></span> <span class="p"><span class="censored">.</span></span><span class="err"><span class="censored">clflush</span></span><span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">SB</span></span><span class="p"><span class="censored">)</span></span>
  <span class="err"><span class="censored">CLFLUSH</span></span> <span class="p"><span class="censored">(</span></span><span class="err"><span class="censored">R14</span></span><span class="p"><span class="censored">)</span></span>  <span class="err"><span class="censored">//</span></span> <span class="err"><span class="censored">Eject</span></span> <span class="err"><span class="censored">the</span></span> <span class="err"><span class="censored">pointee</span></span> <span class="err"><span class="censored">of</span></span> <span class="err"><span class="censored">r14</span></span> <span class="k"><span class="censored">from</span></span> <span class="err"><span class="censored">all</span></span> <span class="err"><span class="censored">caches</span></span><span class="p"><span class="censored">.</span></span>
  <span class="err"><span class="censored">RET</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"> <span class="censored">x86</span> <span class="censored">Assembly</span> <span class="censored">(Go</span> <span class="censored">Syntax)</span> </div></div> </div> <p><span class="censored">If</span> <span class="censored">we</span> <span class="censored">add</span> <span class="censored">a</span> <span class="censored">call</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">function</span> <span class="censored">to</span> <span class="censored">both</span> <span class="censored">benchmark</span> <span class="censored">loops,</span> <span class="censored">we</span> <span class="censored">see</span> <span class="censored">the</span> <span class="censored">staggering</span> <span class="censored">cost</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">cold</span> <span class="censored">fetch</span> <span class="censored">from</span> <span class="censored">RAM</span> <span class="censored">show</span> <span class="censored">up</span> <span class="censored">in</span> <span class="censored">every</span> <span class="censored">function</span> <span class="censored">call:</span> <span class="censored">120.1</span> <span class="censored">nanosecods</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BenchmarkCall/nosplit</span></code><span class="censored">,</span> <span class="censored">versus</span> <span class="censored">332.1</span> <span class="censored">nanoseconds</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">BenchmarkCall/yessplit</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">200</span> <span class="censored">nanosecond</span> <span class="censored">difference</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">fetch</span> <span class="censored">from</span> <span class="censored">main</span> <span class="censored">memory.</span> <span class="censored">An</span> <span class="censored">L1</span> <span class="censored">miss</span> <span class="censored">is</span> <span class="censored">about</span> <span class="censored">15</span> <span class="censored">times</span> <span class="censored">less</span> <span class="censored">expensive,</span> <span class="censored">so</span> <span class="censored">if</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">g</span></code> <span class="censored">struct</span> <span class="censored">manages</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">kicked</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">L1,</span> <span class="censored">you’re</span> <span class="censored">paying</span> <span class="censored">about</span> <span class="censored">15</span> <span class="censored">or</span> <span class="censored">so</span> <span class="censored">nanoseconds,</span> <span class="censored">or</span> <span class="censored">about</span> <span class="censored">two</span> <span class="censored">map</span> <span class="censored">lookups!</span></p> <p><span class="censored">Despite</span> <span class="censored">the</span> <span class="censored">language</span> <span class="censored">resisting</span> <span class="censored">adding</span> <span class="censored">an</span> <span class="censored">inlining</span> <span class="censored">heuristic,</span> <span class="censored">which</span> <span class="censored">programmers</span> <span class="censored">would</span> <span class="censored">place</span> <span class="censored">everywhere</span> <span class="censored">without</span> <span class="censored">knowing</span> <span class="censored">what</span> <span class="censored">it</span> <span class="censored">does,</span> <span class="censored">they</span> <em><span class="censored">did</span></em> <span class="censored">provide</span> <span class="censored">something</span> <span class="censored">worse</span> <span class="censored">that</span> <span class="censored">makes</span> <span class="censored">code</span> <span class="censored">noticeably</span> <span class="censored">faster:</span> <span class="censored">nosplit.</span></p> <h2 id="but-its-harmless"><a href="#but-its-harmless"><span class="censored">But</span> <span class="censored">It’s</span> <span class="censored">Harmless…?</span></a></h2> <p><span class="censored">Consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">program</span><sup id="fnref:consider" role="doc-noteref"><a href="#fn:consider" class="footnote" rel="footnote"><span class="censored">2</span></a></sup><span class="censored">:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c"><span class="censored">//go:nosplit</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">y</span></span> <span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">y</span></span><span class="o"><span class="censored">+</span></span><span class="m"><span class="censored">1</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">Naturally,</span> <span class="censored">this</span> <span class="censored">will</span> <span class="censored">instantly</span> <span class="censored">overflow</span> <span class="censored">the</span> <span class="censored">stack.</span> <span class="censored">Instead,</span> <span class="censored">we</span> <span class="censored">get</span> <span class="censored">a</span> <span class="censored">really</span> <span class="censored">scary</span> <span class="censored">linker</span> <span class="censored">error:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go"><span class="censored">x.x:</span> <span class="censored">nosplit</span> <span class="censored">stack</span> <span class="censored">over</span> <span class="censored">792</span> <span class="censored">byte</span> <span class="censored">limit</span>
</span><span class="gp"><span class="censored">x.x&lt;1&gt;</span></span><span class="w">
</span><span class="gp">    <span class="censored">grows</span> <span class="censored">24</span> <span class="censored">bytes,</span> <span class="censored">calls</span> <span class="censored">x.x&lt;1&gt;</span></span><span class="w">
</span><span class="go">    <span class="censored">infinite</span> <span class="censored">cycle</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">The</span> <span class="censored">Go</span> <span class="censored">linker</span> <span class="censored">contains</span> <span class="censored">a</span> <span class="censored">check</span> <span class="censored">to</span> <span class="censored">verify</span> <span class="censored">that</span> <span class="censored">any</span> <span class="censored">chain</span> <span class="censored">of</span> <span class="censored">nosplit</span> <span class="censored">functions</span> <span class="censored">which</span> <span class="censored">call</span> <span class="censored">nosplit</span> <span class="censored">functions</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">overflow</span> <span class="censored">a</span> <span class="censored">small</span> <span class="censored">window</span> <span class="censored">of</span> <span class="censored">extra</span> <span class="censored">stack,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">where</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">frames</span> <span class="censored">of</span> <span class="censored">nosplit</span> <span class="censored">functions</span> <span class="censored">live</span> <span class="censored">if</span> <span class="censored">they</span> <span class="censored">go</span> <span class="censored">past</span> <code class="language-plaintext highlighter-rouge"><span class="censored">stackguard0</span></code><span class="censored">.</span></p> <p><span class="censored">Every</span> <span class="censored">stack</span> <span class="censored">frame</span> <span class="censored">contributes</span> <span class="censored">some</span> <span class="censored">stack</span> <span class="censored">use</span> <span class="censored">(for</span> <span class="censored">the</span> <span class="censored">return</span> <span class="censored">address,</span> <span class="censored">at</span> <span class="censored">minimum),</span> <span class="censored">so</span> <span class="censored">the</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">functions</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">call</span> <span class="censored">before</span> <span class="censored">you</span> <span class="censored">get</span> <span class="censored">this</span> <span class="censored">error</span> <span class="censored">is</span> <span class="censored">limited.</span> <span class="censored">And</span> <span class="censored">because</span> <span class="censored">every</span> <span class="censored">function</span> <span class="censored">needs</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">space</span> <span class="censored">for</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">callees</span> <span class="censored">to</span> <span class="censored">spill</span> <span class="censored">their</span> <span class="censored">arguments</span> <span class="censored">if</span> <span class="censored">necessary,</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">hit</span> <span class="censored">this</span> <span class="censored">limit</span> <span class="censored">every</span> <span class="censored">fast</span> <span class="censored">if</span> <span class="censored">every</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">functions</span> <span class="censored">uses</span> <span class="censored">every</span> <span class="censored">available</span> <span class="censored">argument</span> <span class="censored">register</span> <span class="censored">(ask</span> <span class="censored">me</span> <span class="censored">how</span> <span class="censored">I</span> <span class="censored">know).</span></p> <p><span class="censored">Also,</span> <span class="censored">turning</span> <span class="censored">on</span> <span class="censored">fuzzing</span> <span class="censored">instruments</span> <span class="censored">the</span> <span class="censored">code</span> <span class="censored">by</span> <span class="censored">inserting</span> <span class="censored">nosplit</span> <span class="censored">calls</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">fuzzer</span> <span class="censored">runtime</span> <span class="censored">around</span> <span class="censored">branches,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">turning</span> <span class="censored">on</span> <span class="censored">fuzzing</span> <span class="censored">can</span> <em><span class="censored">previously</span> <span class="censored">fine</span> <span class="censored">code</span> <span class="censored">to</span> <span class="censored">no</span> <span class="censored">longer</span> <span class="censored">link</span></em><span class="censored">.</span> <span class="censored">Stack</span> <span class="censored">usage</span> <span class="censored">also</span> <span class="censored">varies</span> <span class="censored">slightly</span> <span class="censored">by</span> <span class="censored">architecture,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">code</span> <span class="censored">which</span> <span class="censored">builds</span> <span class="censored">in</span> <span class="censored">one</span> <span class="censored">architecture</span> <span class="censored">fails</span> <span class="censored">to</span> <span class="censored">link</span> <span class="censored">in</span> <span class="censored">others</span> <span class="censored">(most</span> <span class="censored">visible</span> <span class="censored">when</span> <span class="censored">going</span> <span class="censored">from</span> <span class="censored">32-bit</span> <span class="censored">to</span> <span class="censored">64-bit).</span></p> <p><span class="censored">There</span> <span class="censored">is</span> <span class="censored">no</span> <span class="censored">easy</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">control</span> <span class="censored">directives</span> <span class="censored">using</span> <span class="censored">build</span> <span class="censored">tags</span> <span class="censored">(two</span> <span class="censored">poorly-designed</span> <span class="censored">features</span> <span class="censored">collide),</span> <span class="censored">so</span> <span class="censored">you</span> <span class="censored">cannot</span> <span class="censored">just</span> <span class="censored">“turn</span> <span class="censored">off”</span> <span class="censored">performance-sensitive</span> <span class="censored">nosplits</span> <span class="censored">for</span> <span class="censored">debugging,</span> <span class="censored">either.</span></p> <p><span class="censored">For</span> <span class="censored">this</span> <span class="censored">reason,</span> <span class="censored">you</span> <span class="censored">must</span> <span class="censored">be</span> <em><span class="censored">very</span> <span class="censored">very</span> <span class="censored">careful</span></em> <span class="censored">about</span> <span class="censored">using</span> <span class="censored">nosplit</span> <span class="censored">for</span> <span class="censored">performance.</span></p> <h3 id="virtual-nosplit-functions"><a href="#virtual-nosplit-functions"><span class="censored">Virtual</span> <span class="censored">Nosplit</span> <span class="censored">Functions</span></a></h3> <p><span class="censored">Excitingly,</span> <span class="censored">nosplit</span> <span class="censored">functions</span> <span class="censored">whose</span> <span class="censored">addresses</span> <span class="censored">are</span> <span class="censored">taken</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">have</span> <span class="censored">special</span> <span class="censored">codegen,</span> <span class="censored">allowing</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">defeat</span> <span class="censored">the</span> <span class="censored">linker</span> <span class="censored">stack</span> <span class="censored">check</span> <span class="censored">by</span> <span class="censored">using</span> <span class="censored">virtual</span> <span class="censored">function</span> <span class="censored">calls.</span></p> <p><span class="censored">Consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">program:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">package</span></span> <span class="n"><span class="censored">main</span></span>

<span class="k"><span class="censored">var</span></span> <span class="n"><span class="censored">f</span></span> <span class="k"><span class="censored">func</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span>

<span class="c"><span class="censored">//go:nosplit</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">y</span></span> <span class="kt"><span class="censored">int</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span> <span class="n"><span class="censored">f</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">y</span></span><span class="o"><span class="censored">+</span></span><span class="m"><span class="censored">1</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">main</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">f</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">x</span></span>
  <span class="n"><span class="censored">f</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">will</span> <span class="censored">quickly</span> <span class="censored">exhaust</span> <span class="censored">the</span> <span class="censored">main</span> <span class="censored">G’s</span> <span class="censored">tiny</span> <span class="censored">stack</span> <span class="censored">and</span> <span class="censored">segfault</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">violent</span> <span class="censored">way</span> <span class="censored">imaginable,</span> <span class="censored">preventing</span> <span class="censored">the</span> <span class="censored">runtime</span> <span class="censored">from</span> <span class="censored">printing</span> <span class="censored">a</span> <span class="censored">debug</span> <span class="censored">trace.</span> <span class="censored">All</span> <span class="censored">this</span> <span class="censored">program</span> <span class="censored">outputs</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">signal:</span> <span class="censored">segmentation</span> <span class="censored">fault</span></code><span class="censored">.</span></p> <p><span class="censored">This</span> <span class="censored">is</span> <a href="https://github.com/golang/go/issues/74478"><span class="censored">probably</span> <span class="censored">a</span> <span class="censored">bug</span></a><span class="censored">.</span></p> <h2 id="other-side-effects"><a href="#other-side-effects"><span class="censored">Other</span> <span class="censored">Side</span> <span class="censored">Effects</span></a></h2> <p><span class="censored">It</span> <span class="censored">turns</span> <span class="censored">out</span> <span class="censored">that</span> <span class="censored">nosplit</span> <span class="censored">has</span> <span class="censored">various</span> <span class="censored">other</span> <span class="censored">fun</span> <span class="censored">side-effects</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">documented</span> <span class="censored">anywhere.</span> <span class="censored">The</span> <span class="censored">main</span> <span class="censored">thing</span> <span class="censored">it</span> <span class="censored">does</span> <span class="censored">is</span> <span class="censored">it</span> <span class="censored">contributes</span> <span class="censored">to</span> <span class="censored">whether</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">is</span> <span class="censored">considered</span> <span class="censored">“unsafe”</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">runtime.</span></p> <p><span class="censored">Consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">program:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">package</span></span> <span class="n"><span class="censored">main</span></span>

<span class="k"><span class="censored">import</span></span> <span class="p"><span class="censored">(</span></span>
  <span class="s"><span class="censored">"fmt"</span></span>
  <span class="s"><span class="censored">"os"</span></span>
  <span class="s"><span class="censored">"runtime"</span></span>
  <span class="s"><span class="censored">"time"</span></span>
<span class="p"><span class="censored">)</span></span>

<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">main</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">for</span></span> <span class="k"><span class="censored">range</span></span> <span class="n"><span class="censored">runtime</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">GOMAXPROCS</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="k"><span class="censored">go</span></span> <span class="k"><span class="censored">func</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
      <span class="k"><span class="censored">for</span></span> <span class="p"><span class="censored">{}</span></span>
    <span class="p"><span class="censored">}()</span></span>
  <span class="p"><span class="censored">}</span></span>
  <span class="n"><span class="censored">time</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Sleep</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">time</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Second</span></span><span class="p"><span class="censored">)</span></span> <span class="c"><span class="censored">//</span> <span class="censored">Wait</span> <span class="censored">for</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">Gs</span> <span class="censored">to</span> <span class="censored">start.</span></span>

  <span class="n"><span class="censored">fmt</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Println</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"Hello,</span> <span class="censored">world!"</span></span><span class="p"><span class="censored">)</span></span>
  <span class="n"><span class="censored">os</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Exit</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">program</span> <span class="censored">will</span> <span class="censored">make</span> <span class="censored">sure</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">P</span> <span class="censored">becomes</span> <span class="censored">bound</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">G</span> <span class="censored">that</span> <span class="censored">loops</span> <span class="censored">forever,</span> <span class="censored">meaning</span> <span class="censored">they</span> <span class="censored">will</span> <span class="censored">never</span> <span class="censored">trap</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">runtime.</span> <span class="censored">Thus,</span> <span class="censored">this</span> <span class="censored">program</span> <span class="censored">will</span> <span class="censored">hang</span> <span class="censored">forever,</span> <span class="censored">never</span> <span class="censored">printing</span> <span class="censored">its</span> <span class="censored">result</span> <span class="censored">and</span> <span class="censored">exiting.</span> <span class="censored">But</span> <span class="censored">that’s</span> <span class="censored">not</span> <span class="censored">what</span> <span class="censored">happens.</span></p> <p><span class="censored">Thanks</span> <span class="censored">to</span> <span class="censored">asynchronous</span> <span class="censored">preemption,</span> <span class="censored">the</span> <span class="censored">scheduler</span> <span class="censored">will</span> <span class="censored">detect</span> <span class="censored">Gs</span> <span class="censored">that</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">running</span> <span class="censored">for</span> <span class="censored">too</span> <span class="censored">long,</span> <span class="censored">and</span> <span class="censored">preempt</span> <span class="censored">its</span> <span class="censored">M</span> <span class="censored">by</span> <span class="censored">sending</span> <span class="censored">a</span> <span class="censored">signal</span> <span class="censored">to</span> <span class="censored">it</span> <span class="censored">(</span><a href="https://cs.opensource.google/go/go/+/master:src/runtime/signal_unix.go;l=43"><span class="censored">due</span> <span class="censored">to</span> <span class="censored">happenstance</span></a><span class="censored">,</span> <span class="censored">this</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">SIGURG</span></code> <span class="censored">of</span> <span class="censored">all</span> <span class="censored">things.)</span></p> <p><span class="censored">However,</span> <span class="censored">asynchronous</span> <span class="censored">preemption</span> <span class="censored">is</span> <span class="censored">only</span> <span class="censored">possible</span> <span class="censored">when</span> <span class="censored">the</span> <span class="censored">M</span> <span class="censored">stops</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">signal</span> <span class="censored">at</span> <span class="censored">a</span> <span class="censored">safe</span> <span class="censored">point,</span> <span class="censored">as</span> <span class="censored">determined</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">runtime.isAsyncSafePoint</span></code><span class="censored">.</span> <span class="censored">It</span> <span class="censored">includes</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">block</span> <span class="censored">of</span> <span class="censored">code:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go">	<span class="n"><span class="censored">up</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">startpc</span></span> <span class="o"><span class="censored">:=</span></span> <span class="n"><span class="censored">pcdatavalue2</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">f</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">abi</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">PCDATA_UnsafePoint</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">pc</span></span><span class="p"><span class="censored">)</span></span>
	<span class="k"><span class="censored">if</span></span> <span class="n"><span class="censored">up</span></span> <span class="o"><span class="censored">==</span></span> <span class="n"><span class="censored">abi</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">UnsafePointUnsafe</span></span> <span class="p"><span class="censored">{</span></span>
		<span class="c"><span class="censored">//</span> <span class="censored">Unsafe-point</span> <span class="censored">marked</span> <span class="censored">by</span> <span class="censored">compiler.</span> <span class="censored">This</span> <span class="censored">includes</span></span>
		<span class="c"><span class="censored">//</span> <span class="censored">atomic</span> <span class="censored">sequences</span> <span class="censored">(e.g.,</span> <span class="censored">write</span> <span class="censored">barrier)</span> <span class="censored">and</span> <span class="censored">nosplit</span></span>
		<span class="c"><span class="censored">//</span> <span class="censored">functions</span> <span class="censored">(except</span> <span class="censored">at</span> <span class="censored">calls).</span></span>
		<span class="k"><span class="censored">return</span></span> <span class="no"><span class="censored">false</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>
	<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">If</span> <span class="censored">we</span> <span class="censored">chase</span> <span class="censored">down</span> <span class="censored">where</span> <span class="censored">this</span> <span class="censored">value</span> <span class="censored">is</span> <span class="censored">set,</span> <span class="censored">we’ll</span> <span class="censored">find</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">set</span> <span class="censored">explicitly</span> <span class="censored">for</span> <span class="censored">write</span> <span class="censored">barrier</span> <span class="censored">sequences,</span> <span class="censored">for</span> <span class="censored">any</span> <span class="censored">function</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">“part</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">runtime”</span> <span class="censored">(as</span> <span class="censored">defined</span> <span class="censored">by</span> <span class="censored">being</span> <span class="censored">built</span> <span class="censored">with</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">-+</span></code> <span class="censored">flag)</span> <span class="censored">and</span> <em><span class="censored">for</span> <span class="censored">any</span> <span class="censored">nosplit</span> <span class="censored">function</span></em><span class="censored">.</span></p> <p><span class="censored">With</span> <span class="censored">a</span> <span class="censored">small</span> <span class="censored">modification</span> <span class="censored">of</span> <span class="censored">hoisting</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">go</span></code> <span class="censored">body</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">nosplit</span> <span class="censored">function,</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">program</span> <span class="censored">will</span> <span class="censored">run</span> <span class="censored">forever:</span> <span class="censored">it</span> <span class="censored">will</span> <span class="censored">never</span> <span class="censored">wake</span> <span class="censored">up</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">time.Sleep</span></code><span class="censored">.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">package</span></span> <span class="n"><span class="censored">main</span></span>

<span class="k"><span class="censored">import</span></span> <span class="p"><span class="censored">(</span></span>
  <span class="s"><span class="censored">"fmt"</span></span>
  <span class="s"><span class="censored">"os"</span></span>
  <span class="s"><span class="censored">"runtime"</span></span>
  <span class="s"><span class="censored">"time"</span></span>
<span class="p"><span class="censored">)</span></span>

<span class="c"><span class="censored">//go:nosplit</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">forever</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">for</span></span> <span class="p"><span class="censored">{}</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">main</span></span><span class="p"><span class="censored">()</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">for</span></span> <span class="k"><span class="censored">range</span></span> <span class="n"><span class="censored">runtime</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">GOMAXPROCS</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="k"><span class="censored">go</span></span> <span class="n"><span class="censored">forever</span></span><span class="p"><span class="censored">()</span></span>
  <span class="p"><span class="censored">}</span></span>
  <span class="n"><span class="censored">time</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Sleep</span></span><span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">time</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Second</span></span><span class="p"><span class="censored">)</span></span> <span class="c"><span class="censored">//</span> <span class="censored">Wait</span> <span class="censored">for</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">Gs</span> <span class="censored">to</span> <span class="censored">start.</span></span>

  <span class="n"><span class="censored">fmt</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Println</span></span><span class="p"><span class="censored">(</span></span><span class="s"><span class="censored">"Hello,</span> <span class="censored">world!"</span></span><span class="p"><span class="censored">)</span></span>
  <span class="n"><span class="censored">os</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">Exit</span></span><span class="p"><span class="censored">(</span></span><span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Go</span></div></div> </div> <p><span class="censored">Even</span> <span class="censored">though</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">work</span> <span class="censored">to</span> <span class="censored">do,</span> <span class="censored">every</span> <span class="censored">P</span> <span class="censored">is</span> <span class="censored">bound</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">G</span> <span class="censored">that</span> <span class="censored">will</span> <span class="censored">never</span> <span class="censored">reach</span> <span class="censored">a</span> <span class="censored">safe</span> <span class="censored">point,</span> <span class="censored">so</span> <span class="censored">there</span> <span class="censored">will</span> <span class="censored">never</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">P</span> <span class="censored">available</span> <span class="censored">to</span> <span class="censored">run</span> <span class="censored">the</span> <span class="censored">main</span> <span class="censored">goroutine.</span></p> <p><span class="censored">This</span> <span class="censored">represents</span> <span class="censored">another</span> <span class="censored">potential</span> <span class="censored">danger</span> <span class="censored">of</span> <span class="censored">using</span> <span class="censored">nosplit</span> <span class="censored">functions:</span> <span class="censored">those</span> <span class="censored">that</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">call</span> <span class="censored">preemptable</span> <span class="censored">functions</span> <span class="censored">must</span> <span class="censored">terminate</span> <span class="censored">promptly,</span> <span class="censored">or</span> <span class="censored">risk</span> <span class="censored">livelocking</span> <span class="censored">the</span> <span class="censored">whole</span> <span class="censored">runtime.</span></p> <h2 id="conclusion"><a href="#conclusion"><span class="censored">Conclusion</span></a></h2> <p><span class="censored">I</span> <span class="censored">use</span> <span class="censored">nosplit</span> <em><span class="censored">a</span> <span class="censored">lot</span></em><span class="censored">,</span> <span class="censored">because</span> <span class="censored">I</span> <span class="censored">write</span> <span class="censored">high-performance,</span> <span class="censored">low-latency</span> <span class="censored">Go.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">insane</span> <span class="censored">thing</span> <span class="censored">to</span> <span class="censored">do,</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">caused</span> <span class="censored">me</span> <span class="censored">to</span> <span class="censored">slowly</span> <span class="censored">generate</span> <span class="censored">bug</span> <span class="censored">reports</span> <span class="censored">whenever</span> <span class="censored">I</span> <span class="censored">hit</span> <span class="censored">strange</span> <span class="censored">corner</span> <span class="censored">cases.</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <span class="censored">there</span> <span class="censored">are</span> <span class="censored">many</span> <span class="censored">cases</span> <span class="censored">where</span> <span class="censored">spill</span> <span class="censored">regions</span> <span class="censored">are</span> <span class="censored">allocated</span> <span class="censored">for</span> <span class="censored">functions</span> <span class="censored">that</span> <span class="censored">never</span> <span class="censored">use</span> <span class="censored">them,</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">functions</span> <span class="censored">which</span> <span class="censored">only</span> <span class="censored">call</span> <span class="censored">nosplit</span> <span class="censored">functions</span> <span class="censored">allocate</span> <span class="censored">space</span> <span class="censored">for</span> <span class="censored">them</span> <span class="censored">to</span> <span class="censored">spill</span> <span class="censored">their</span> <span class="censored">arguments,</span> <span class="censored">which</span> <span class="censored">they</span> <span class="censored">don’t</span> <span class="censored">do.</span><sup id="fnref:spill-area" role="doc-noteref"><a href="#fn:spill-area" class="footnote" rel="footnote"><span class="censored">3</span></a></sup></p> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">documented</span> <span class="censored">Go</span> <span class="censored">language</span> <span class="censored">feature</span> <span class="censored">which:</span></p> <ol> <li> <span class="censored">Isn’t</span> <span class="censored">very</span> <span class="censored">well-documented</span> <span class="censored">(the</span> <span class="censored">async</span> <span class="censored">preemption</span> <span class="censored">behavior</span> <span class="censored">certainly</span> <span class="censored">isn’t)!</span> </li> <li> <span class="censored">Has</span> <span class="censored">very</span> <span class="censored">scary</span> <span class="censored">optimization-dependent</span> <span class="censored">build</span> <span class="censored">failures.</span> </li> <li> <span class="censored">Can</span> <span class="censored">cause</span> <span class="censored">livelock</span> <span class="censored">and</span> <span class="censored">mysterious</span> <span class="censored">segfaults.</span> </li> <li> <span class="censored">Can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">in</span> <span class="censored">user</span> <span class="censored">programs</span> <span class="censored">that</span> <span class="censored">don’t</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">"unsafe"</span></code><span class="censored">!</span> </li> <li> <span class="censored">And</span> <span class="censored">it</span> <span class="censored">makes</span> <span class="censored">code</span> <span class="censored">faster!</span> </li> </ol> <p><span class="censored">I’m</span> <span class="censored">surprised</span> <span class="censored">such</span> <span class="censored">a</span> <span class="censored">massive</span> <span class="censored">footgun</span> <span class="censored">exists</span> <span class="censored">at</span> <span class="censored">all,</span> <span class="censored">buuuut</span> <span class="censored">it’s</span> <span class="censored">a</span> <span class="censored">measureable</span> <span class="censored">benchmark</span> <span class="censored">improvement</span> <span class="censored">for</span> <span class="censored">me,</span> <span class="censored">so</span> <span class="censored">it’s</span> <span class="censored">impossible</span> <span class="censored">to</span> <span class="censored">tell</span> <span class="censored">if</span> <span class="censored">it’s</span> <span class="censored">bad</span> <span class="censored">or</span> <span class="censored">not.</span></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:unused-spill" role="doc-endnote"> <p><span class="censored">The</span> <span class="censored">astute</span> <span class="censored">reader</span> <span class="censored">will</span> <span class="censored">observe</span> <span class="censored">that</span> <span class="censored">because</span> <span class="censored">preemption</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">reentrant,</span> <span class="censored">only</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">spill</span> <span class="censored">regions</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">in</span> <span class="censored">use</span> <span class="censored">at</span> <span class="censored">at</span> <span class="censored">time</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">G.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">known</span> <span class="censored">bug</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">ABI,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">essentially</span> <span class="censored">a</span> <span class="censored">bodge</span> <span class="censored">to</span> <span class="censored">enable</span> <span class="censored">easy</span> <span class="censored">adoption</span> <span class="censored">of</span> <span class="censored">passing</span> <span class="censored">arguments</span> <span class="censored">by</span> <span class="censored">register,</span> <span class="censored">without</span> <span class="censored">needing</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">parts</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">runtime</span> <span class="censored">that</span> <span class="censored">expect</span> <span class="censored">arguments</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">spilled</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">stack,</span> <span class="censored">as</span> <span class="censored">was</span> <span class="censored">the</span> <span class="censored">case</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">slow</span> <span class="censored">old</span> <span class="censored">days</span> <span class="censored">when</span> <span class="censored">Go’s</span> <span class="censored">ABI</span> <span class="censored">on</span> <span class="censored">every</span> <span class="censored">platform</span> <span class="censored">was</span> <span class="censored">“</span><code class="language-plaintext highlighter-rouge"><span class="censored">i386-unknown-linux</span></code> <span class="censored">but</span> <span class="censored">worse”,</span> <span class="censored">i.e.,</span> <span class="censored">arguments</span> <span class="censored">went</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">and</span> <span class="censored">made</span> <span class="censored">the</span> <span class="censored">CPU’s</span> <span class="censored">store</span> <span class="censored">queue</span> <span class="censored">sad.</span></p> <p><span class="censored">I</span> <span class="censored">recently</span> <span class="censored">filed</span> <a href="https://github.com/golang/go/issues/74413"><span class="censored">a</span> <span class="censored">bug</span> <span class="censored">about</span> <span class="censored">this</span></a> <span class="censored">that</span> <span class="censored">boils</span> <span class="censored">down</span> <span class="censored">to</span> <span class="censored">“add</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">runtime.g</span></code> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">a</span> <span class="censored">spill</span> <span class="censored">space”,</span> <span class="censored">which</span> <span class="censored">seems</span> <span class="censored">to</span> <span class="censored">me</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">simpler</span> <span class="censored">than</span> <span class="censored">the</span> <span class="censored">alternatives</span> <span class="censored">described</span> <span class="censored">in</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">ABIInternal</span></code> <span class="censored">spec. </span><a href="#fnref:unused-spill" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:consider" role="doc-endnote"> <p><span class="censored">Basically</span> <span class="censored">every</span> <span class="censored">bug</span> <span class="censored">report</span> <span class="censored">I</span> <span class="censored">write</span> <span class="censored">starts</span> <span class="censored">with</span> <span class="censored">these</span> <span class="censored">four</span> <span class="censored">words</span> <span class="censored">and</span> <span class="censored">it</span> <span class="censored">means</span> <span class="censored">you’re</span> <span class="censored">about</span> <span class="censored">to</span> <span class="censored">see</span> <span class="censored">the</span> <span class="censored">worst</span> <span class="censored">program</span> <span class="censored">ever</span> <span class="censored">written. </span><a href="#fnref:consider" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:spill-area" role="doc-endnote"> <p><span class="censored">The</span> <span class="censored">spill</span> <span class="censored">area</span> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">spilling</span> <span class="censored">arguments</span> <span class="censored">across</span> <span class="censored">calls,</span> <span class="censored">but</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">case,</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">necessary</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">caller</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">it</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">nosplit</span> <span class="censored">function. </span><a href="#fnref:spill-area" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-06-03</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#7:</span> <span class="censored">Scoping</span> <span class="censored">It</span> <span class="censored">Out</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-05-20</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/05/20/protobuf-tip-6/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#6:</span> <span class="censored">The</span> <span class="censored">Subtle</span> <span class="censored">Dangers</span> <span class="censored">of</span> <span class="censored">Enum</span> <span class="censored">Aliases</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-05-13</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/05/13/protobuf-tip-5/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#5:</span> <span class="censored">Avoid</span> <span class="censored">import</span> <span class="censored">public/weak</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>