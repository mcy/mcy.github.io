<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Protobuf Tip #1: Field Names Are Forever &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Protobuf Tip #1: Field Names Are Forever &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/protobuf-tip-1-24a0cd292bb8ec6ed0ffcb85f1d6fff9565fe339.png"> <meta property="og:title" content="Protobuf Tip #1: Field Names Are Forever &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/protobuf-tip-1-24a0cd292bb8ec6ed0ffcb85f1d6fff9565fe339.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/04/08/protobuf-tip-1/"> <link rel="canonical" href="https://buf.build/blog/totw-1-field-names"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://github.com/mcy">GitHub</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-04-08 • 742 words • 6 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/04/08/protobuf-tip-1/"> Protobuf Tip #1: Field Names Are Forever </a></h1> </div> <div class="post"> <p><em>I wake up every morning and grab the morning paper. Then I look at the obituary page. If my name is not on it, I get up. –Ben Franklin</em></p> <p>TL;DR: Don’t rename fields. Even though there are a slim number of cases where you can get away with it, it’s rarely worth doing, and is a potential source of bugs.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-1-field-names">buf.build blog</a>.</p> </blockquote> <h2 id="names-and-tags"><a href="#names-and-tags">Names and Tags</a></h2> <p>Protobuf message fields have <em>field tags</em> that are used in the binary wire format to discriminate fields. This means that the wire format serialization does not actually depend on the <em>names</em> of the fields. For example, the following messages will use the exact same serialization format.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Foo</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Foo2</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In fact, the designers of Protobuf intended for it to be feasible to rename an in-use field. However, they were not successful: it can still be a breaking change.</p> <h2 id="schema-consumers-need-to-update"><a href="#schema-consumers-need-to-update">Schema Consumers Need to Update</a></h2> <p>If your schema is public, the generated code will change. For example, renaming a field from <code class="language-plaintext highlighter-rouge">first_name</code> to <code class="language-plaintext highlighter-rouge">given_name</code> will cause the corresponding Go accessor to change from <code class="language-plaintext highlighter-rouge">FirstName</code> to <code class="language-plaintext highlighter-rouge">GivenName</code>, potentially breaking downstream consumers.</p> <p>Renaming a field to a “better” name is almost never a worthwhile change, simply because of this breakage.</p> <h2 id="json-serialization-breaks"><a href="#json-serialization-breaks">JSON Serialization Breaks</a></h2> <p>Wire format serialization doesn’t look at names, but JSON does! This means that <code class="language-plaintext highlighter-rouge">Foo</code> and <code class="language-plaintext highlighter-rouge">Foo2</code> above serialize as <code class="language-plaintext highlighter-rouge">{"bar":"content"}</code> and <code class="language-plaintext highlighter-rouge">{"bar2":"content"}</code> respectively, making them non-interchangeable.</p> <p>This can be partially mitigated by using the <code class="language-plaintext highlighter-rouge">[json_name = "..."]</code> option on a field. However, this doesn’t actually work, because many Protobuf runtimes’ JSON codecs will accept both the name set in <code class="language-plaintext highlighter-rouge">json_name</code>, <em>and</em> the specified field name. So <code class="language-plaintext highlighter-rouge">string given_name = 1 [json_name = "firstName"];</code> will allow deserializing from a key named <code class="language-plaintext highlighter-rouge">given_name</code>, but not <code class="language-plaintext highlighter-rouge">first_name</code> like it used to. This is still a breaking protocol change!</p> <p>This is a place where Protobuf could have done better—if <code class="language-plaintext highlighter-rouge">json_name</code> had been a <code class="language-plaintext highlighter-rouge">repeated string</code>, this wire format breakage would have been avoidable. However, for reasons given below, renames are still a bad idea.</p> <h2 id="reflection"><a href="#reflection">Reflection!</a></h2> <p>Even if you could avoid source and JSON breakages, the names are always visible to reflection. Although it’s <em>very</em> hard to guard against reflection breakages in general (since it can even see the order fields are declared in), this is one part of reflection that can be especially insidious—for example, if callers choose to sort fields by name, or if some middleware is using the name of a field to identify its frequency, or logging/redaction needs.</p> <p>Don’t change the name, because reflection means you can’t know what’ll go wrong!</p> <h2 id="but-i-really-have-to"><a href="#but-i-really-have-to">But I Really Have To!</a></h2> <p>There are valid reasons for wanting to rename a field, such as expanding its scope. For example, <code class="language-plaintext highlighter-rouge">first_name</code> and <code class="language-plaintext highlighter-rouge">given_name</code> are not the same concept: in the Sinosphere, as well as in Hungary, the first name in a person’s full name is their family name, not their given name.</p> <p>Or maybe a field that previously referred to a monetary amount, say <code class="language-plaintext highlighter-rouge">cost_usd</code>, is being updated to not specify the currency:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Before</span> <span class="p">{</span>
  <span class="kt">sint64</span> <span class="na">cost_usd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">After</span> <span class="p">{</span>
  <span class="kd">enum</span> <span class="n">Currency</span> <span class="p">{</span>
    <span class="na">CURRENCY_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">CURRENCY_USD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="na">CURRENCY_EUR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="na">CURRENCY_JPY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="na">CURRENCY_USD_1000TH</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 0.1 cents.</span>
  <span class="p">}</span>

  <span class="kt">sint64</span> <span class="na">cost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Currency</span> <span class="na">currency</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In cases like this, <strong>renaming the field is a terrible idea</strong>. Setting aside source code or JSON breakage, the new field has completely different semantics. If an old consumer, expecting a price in USD, receives a new wire format message serialized from <code class="language-plaintext highlighter-rouge">{"cost":990,"currency":"CURRENCY_USD_1000TH"}</code>, it will incorrectly interpret the price as 990USD, rather than 0.99USD. That’s a disastrous bug!</p> <p>Instead, the right plan is to add <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">currency</code> side-by-side <code class="language-plaintext highlighter-rouge">cost_usd</code>. Then, readers should first check for <code class="language-plaintext highlighter-rouge">cost_usd</code> when reading <code class="language-plaintext highlighter-rouge">cost</code>, and take that to imply that <code class="language-plaintext highlighter-rouge">currency</code> is <code class="language-plaintext highlighter-rouge">CURRENCY_USD</code> (it’s also worth generating an error if <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">cost_usd</code> are both present).</p> <p><code class="language-plaintext highlighter-rouge">cost_usd</code> can then be marked as <code class="language-plaintext highlighter-rouge">[deprecated = true]</code> . It is possible to even delete <code class="language-plaintext highlighter-rouge">cost_usd</code> in some cases, such as when you control all readers and writers — but if you don’t, the risk is very high. Plus, you kind of need to be able to re-interpret <code class="language-plaintext highlighter-rouge">cost_usd</code> as the value of <code class="language-plaintext highlighter-rouge">cost</code> in perpetuity.</p> <p>If you do wind up deleting them, make sure to reserve the field’s number and name, to avoid accidental re-use.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="n">reserved</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">reserved</span> <span class="s">"cost_usd"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>But try not to. Renaming fields is nothing but tears and pain.</p> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-04-14</span> / <h6 style="display:inline"><a href="/2025/04/14/target-triples/">What the Hell Is a Target Triple?</a></h6> <li> <span class="post-meta">2025-03-11</span> / <h6 style="display:inline"><a href="/2025/03/11/formatters/">The Art of Formatting Code</a></h6> <li> <span class="post-meta">2024-12-16</span> / <h6 style="display:inline"><a href="/2024/12/16/rangefuncs/">Go's Weird Little Iterators</a></h6> </ul> </div> <div class="minimap"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> 2025-04-08 • 742 words • 6 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/04/08/protobuf-tip-1/"> Protobuf Tip #1: Field Names Are Forever </a></h1> </div> <div class="post"> <p><em>I wake up every morning and grab the morning paper. Then I look at the obituary page. If my name is not on it, I get up. –Ben Franklin</em></p> <p>TL;DR: Don’t rename fields. Even though there are a slim number of cases where you can get away with it, it’s rarely worth doing, and is a potential source of bugs.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-1-field-names">buf.build blog</a>.</p> </blockquote> <h2 id="names-and-tags"><a href="#names-and-tags">Names and Tags</a></h2> <p>Protobuf message fields have <em>field tags</em> that are used in the binary wire format to discriminate fields. This means that the wire format serialization does not actually depend on the <em>names</em> of the fields. For example, the following messages will use the exact same serialization format.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Foo</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Foo2</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In fact, the designers of Protobuf intended for it to be feasible to rename an in-use field. However, they were not successful: it can still be a breaking change.</p> <h2 id="schema-consumers-need-to-update"><a href="#schema-consumers-need-to-update">Schema Consumers Need to Update</a></h2> <p>If your schema is public, the generated code will change. For example, renaming a field from <code class="language-plaintext highlighter-rouge">first_name</code> to <code class="language-plaintext highlighter-rouge">given_name</code> will cause the corresponding Go accessor to change from <code class="language-plaintext highlighter-rouge">FirstName</code> to <code class="language-plaintext highlighter-rouge">GivenName</code>, potentially breaking downstream consumers.</p> <p>Renaming a field to a “better” name is almost never a worthwhile change, simply because of this breakage.</p> <h2 id="json-serialization-breaks"><a href="#json-serialization-breaks">JSON Serialization Breaks</a></h2> <p>Wire format serialization doesn’t look at names, but JSON does! This means that <code class="language-plaintext highlighter-rouge">Foo</code> and <code class="language-plaintext highlighter-rouge">Foo2</code> above serialize as <code class="language-plaintext highlighter-rouge">{"bar":"content"}</code> and <code class="language-plaintext highlighter-rouge">{"bar2":"content"}</code> respectively, making them non-interchangeable.</p> <p>This can be partially mitigated by using the <code class="language-plaintext highlighter-rouge">[json_name = "..."]</code> option on a field. However, this doesn’t actually work, because many Protobuf runtimes’ JSON codecs will accept both the name set in <code class="language-plaintext highlighter-rouge">json_name</code>, <em>and</em> the specified field name. So <code class="language-plaintext highlighter-rouge">string given_name = 1 [json_name = "firstName"];</code> will allow deserializing from a key named <code class="language-plaintext highlighter-rouge">given_name</code>, but not <code class="language-plaintext highlighter-rouge">first_name</code> like it used to. This is still a breaking protocol change!</p> <p>This is a place where Protobuf could have done better—if <code class="language-plaintext highlighter-rouge">json_name</code> had been a <code class="language-plaintext highlighter-rouge">repeated string</code>, this wire format breakage would have been avoidable. However, for reasons given below, renames are still a bad idea.</p> <h2 id="reflection"><a href="#reflection">Reflection!</a></h2> <p>Even if you could avoid source and JSON breakages, the names are always visible to reflection. Although it’s <em>very</em> hard to guard against reflection breakages in general (since it can even see the order fields are declared in), this is one part of reflection that can be especially insidious—for example, if callers choose to sort fields by name, or if some middleware is using the name of a field to identify its frequency, or logging/redaction needs.</p> <p>Don’t change the name, because reflection means you can’t know what’ll go wrong!</p> <h2 id="but-i-really-have-to"><a href="#but-i-really-have-to">But I Really Have To!</a></h2> <p>There are valid reasons for wanting to rename a field, such as expanding its scope. For example, <code class="language-plaintext highlighter-rouge">first_name</code> and <code class="language-plaintext highlighter-rouge">given_name</code> are not the same concept: in the Sinosphere, as well as in Hungary, the first name in a person’s full name is their family name, not their given name.</p> <p>Or maybe a field that previously referred to a monetary amount, say <code class="language-plaintext highlighter-rouge">cost_usd</code>, is being updated to not specify the currency:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Before</span> <span class="p">{</span>
  <span class="kt">sint64</span> <span class="na">cost_usd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">After</span> <span class="p">{</span>
  <span class="kd">enum</span> <span class="n">Currency</span> <span class="p">{</span>
    <span class="na">CURRENCY_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">CURRENCY_USD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="na">CURRENCY_EUR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="na">CURRENCY_JPY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="na">CURRENCY_USD_1000TH</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 0.1 cents.</span>
  <span class="p">}</span>

  <span class="kt">sint64</span> <span class="na">cost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Currency</span> <span class="na">currency</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In cases like this, <strong>renaming the field is a terrible idea</strong>. Setting aside source code or JSON breakage, the new field has completely different semantics. If an old consumer, expecting a price in USD, receives a new wire format message serialized from <code class="language-plaintext highlighter-rouge">{"cost":990,"currency":"CURRENCY_USD_1000TH"}</code>, it will incorrectly interpret the price as 990USD, rather than 0.99USD. That’s a disastrous bug!</p> <p>Instead, the right plan is to add <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">currency</code> side-by-side <code class="language-plaintext highlighter-rouge">cost_usd</code>. Then, readers should first check for <code class="language-plaintext highlighter-rouge">cost_usd</code> when reading <code class="language-plaintext highlighter-rouge">cost</code>, and take that to imply that <code class="language-plaintext highlighter-rouge">currency</code> is <code class="language-plaintext highlighter-rouge">CURRENCY_USD</code> (it’s also worth generating an error if <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">cost_usd</code> are both present).</p> <p><code class="language-plaintext highlighter-rouge">cost_usd</code> can then be marked as <code class="language-plaintext highlighter-rouge">[deprecated = true]</code> . It is possible to even delete <code class="language-plaintext highlighter-rouge">cost_usd</code> in some cases, such as when you control all readers and writers — but if you don’t, the risk is very high. Plus, you kind of need to be able to re-interpret <code class="language-plaintext highlighter-rouge">cost_usd</code> as the value of <code class="language-plaintext highlighter-rouge">cost</code> in perpetuity.</p> <p>If you do wind up deleting them, make sure to reserve the field’s number and name, to avoid accidental re-use.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="n">reserved</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">reserved</span> <span class="s">"cost_usd"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>But try not to. Renaming fields is nothing but tears and pain.</p> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-04-14</span> / <h6 style="display:inline"><a href="/2025/04/14/target-triples/">What the Hell Is a Target Triple?</a></h6> <li> <span class="post-meta">2025-03-11</span> / <h6 style="display:inline"><a href="/2025/03/11/formatters/">The Art of Formatting Code</a></h6> <li> <span class="post-meta">2024-12-16</span> / <h6 style="display:inline"><a href="/2024/12/16/rangefuncs/">Go's Weird Little Iterators</a></h6> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>