<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Protobuf Tip #2: Compress Your Protos! &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Protobuf Tip #2: Compress Your Protos! &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/protobuf-tip-2-e7e68143c4a71b1c7de105ad260358fcd7bad0a3.png"> <meta property="og:title" content="Protobuf Tip #2: Compress Your Protos! &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/protobuf-tip-2-e7e68143c4a71b1c7de105ad260358fcd7bad0a3.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/04/15/protobuf-tip-2/"> <link rel="canonical" href="https://buf.build/blog/totw-2-compress-protos"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-04-15 • 804 words • 8 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/04/15/protobuf-tip-2/"> Protobuf Tip #2: Compress Your Protos! </a></h1> </div> <div class="post"> <p><em>As a matter of fact, when compression technology came along, we thought the future in 1996 was about voice. We got it wrong. It is about voice, video, and data, and that is what we have today on these cell phones. –Steve Buyer</em></p> <p>TL;DR: Compression is everywhere: CDNs, HTTP servers, even in RPC frameworks like Connect. This pervasiveness means that wire size tradeoffs matter less than they used to twenty years ago, when Protobuf was designed.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-2-compress-protos">buf.build blog</a>.</p> </blockquote> <h2 id="varints-from-1998"><a href="#varints-from-1998">Varints from 1998</a></h2> <p>Protobuf’s wire format is intended to be relatively small. It makes use of <em>variable-width integers</em> so that smaller values take up less space on the wire. Fixed width integers might be larger on the wire, but often have faster decoding times.</p> <p>But what if I told you that doesn’t matter?</p> <p>See, most internet traffic is compressed. Bandwidth is precious, and CDN operators don’t want to waste time sending big blobs full of zeros. There are many compression algorithms available, but the state of the art for HTTP requests (which dominates much of global internet traffic) is <a href="https://en.wikipedia.org/wiki/Brotli">Brotli</a>, an algorithm developed at Google in 2013 and standardized in IETF <a href="https://datatracker.ietf.org/doc/html/rfc7932">RFC7932</a> in 2016. There is a very good chance that this article was delivered to your web browser as a Brotli-compressed blob.</p> <h2 id="using-compression"><a href="#using-compression">Using Compression</a></h2> <p>How compression is applied in your case will vary, but both Connect RPC and gRPC support native compression. For example, Connect has an API for injecting compression providers: <a href="https://pkg.go.dev/connectrpc.com/connect#WithCompression">https://pkg.go.dev/connectrpc.com/connect#WithCompression</a>.</p> <p>Connect uses <code class="language-plaintext highlighter-rouge">gzip</code> by default, which uses the DEFLATE compression algorithm. Providing your own compression algorithm (such as Brotli) is pretty simple, as shown by <a href="https://github.com/mattrobenolt/connect-brotli/blob/921ee0236bcd2d66827590c6890bb850e56516ad/connect_brotli.go">this third-party package</a>.</p> <p>Other services may compress for you transparently. Any competent CDN will likely use Brotli (or <code class="language-plaintext highlighter-rouge">gzip</code> or <code class="language-plaintext highlighter-rouge">zlib</code>, but probably Brotli) to compress any files it serves for you. (In fact, JavaScript and HTML minimization can often be rendered irrelevant by HTTP compression, too.)</p> <p>It’s important to remember that Protobuf predates pervasive compression: if it didn’t, it would almost certainly not use variable-width integers for anything. It only uses them because they offer a primitive form of compression in exchange for being slower to decode. If that tradeoff was eliminated, Protobuf would almost certainly only use fixed-width integers on the wire.</p> <h2 id="how-good-is-it-really"><a href="#how-good-is-it-really">How Good Is It Really?</a></h2> <p>Let’s do some apples-to-apples comparisons. Consider the following Protobuf type.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Foo</span> <span class="p">{</span>
	<span class="k">repeated</span> <span class="kt">int32</span> <span class="na">varints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">repeated</span> <span class="kt">sfixed32</span> <span class="na">fixeds</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>There are two fields that contain essentially the same data, which can be encoded in four different ways: as old-style repeated fields, as packed fields, and the integers can be encoded as varints or fixed32 values.</p> <p>Using <a href="https://github.com/protocolbuffers/protoscope">Protoscope</a>, we can create some data that exercises these four cases:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># a.pb, repeated varint
</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span>
<span class="mi">1</span><span class="p">:</span> <span class="mi">2</span>
<span class="mi">1</span><span class="p">:</span> <span class="mi">3</span>
<span class="c1"># ...
</span>
<span class="c1"># b.pb, packed varint
</span><span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
  <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span>
  <span class="c1"># ...
</span><span class="p">}</span>

<span class="c1"># c.pb, repeated fixed32
</span><span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="n">i32</span>
<span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="n">i32</span>
<span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="n">i32</span>

<span class="c1"># d.pb, packed fixed32
</span><span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
  <span class="mi">1</span><span class="n">i32</span> <span class="mi">2</span><span class="n">i32</span> <span class="mi">3</span><span class="n">i32</span>
  <span class="c1"># ...
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protoscope</div></div></div> <p>Each blob contains the integers from 1 to 1000 encoded in different ways. I’ll compress each one using gzip, zlib, and Brotli, using their default compression levels, and arrange their sizes, in bytes, in the table below.</p> <table> <thead> <tr> <th>File</th> <th>Uncompressed</th> <th><code class="language-plaintext highlighter-rouge">gzip</code> (DEFLATE)</th> <th><code class="language-plaintext highlighter-rouge">zlib</code></th> <th>Brotli</th> </tr> </thead> <tbody> <tr> <td>a.pb</td> <td>2875</td> <td>1899</td> <td>1878</td> <td>1094</td> </tr> <tr> <td>b.pb</td> <td>1877</td> <td>1534</td> <td>1524</td> <td>885</td> </tr> <tr> <td>c.pb</td> <td>5005</td> <td>1577</td> <td>1567</td> <td>1140</td> </tr> <tr> <td>d.pb</td> <td>4007</td> <td>1440</td> <td>1916</td> <td>1140</td> </tr> </tbody> </table> <p>Compression achieves incredible results: Brotli manages to get all of the files down to around 1.1 kB, except for the packed varints, which it gets about 250 bytes smaller! Of course, that’s only because most of the values in that repeated field are small. If the values range from 100000 to 101000, b.pb and d.pb are 3006 and 4007 bytes respectively (see that d.pb’s size is unchanged!), but when compressed with brotli, the lead for b.pb starts to disappear: 1039 bytes vs. 1163 bytes. Now it’s only 120 bytes smaller.</p> <h2 id="are-varints-still-better"><a href="#are-varints-still-better">Are Varints Still Better?</a></h2> <p>Applying compression can often have similar results to replacing everything with varints, but not exactly: using a varint will likely always be slightly smaller, at least when using state-of-the-art compression like Brotli. But you can pretty much always assume you <em>will</em> be using compression, such as to compress HTTP headers and other ancillary content in your request. Compression is generic and highly optimized—it applies to all data, regardless of schema, and is often far more optimized than application-level codecs like those in a Protobuf library.</p> <p>Not to mention, you should definitely be compressing any large data blobs you’re storing on disk, too!</p> <p>As a result, you can usually disregard many encoded size concerns when making tradeoffs in designing a Protobuf type. Fixed integer types will decode faster, so if decoding speed is important to you, and you’re worried about the size on the wire, don’t. It’s almost certainly already taken care of at a different layer of the stack.</p> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-07-16</span> / <h6 style="display:inline"><a href="/2025/07/16/hyperpb/">Parsing Protobuf Like Never Before</a></h6> <li> <span class="post-meta">2025-07-14</span> / <h6 style="display:inline"><a href="/2025/07/14/best/">The Best C++ Library</a></h6> <li> <span class="post-meta">2025-07-07</span> / <h6 style="display:inline"><a href="/2025/07/07/nosplit/">What's //go:nosplit for?</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-04-15</span> <span class="censored">•</span> <span class="censored">804</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">8</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips"><span class="censored">#protobuf-tips</span></a> </span> <h1><a href="/2025/04/15/protobuf-tip-2/"> <span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#2:</span> <span class="censored">Compress</span> <span class="censored">Your</span> <span class="censored">Protos!</span> </a></h1> </div> <div class="post"> <p><em><span class="censored">As</span> <span class="censored">a</span> <span class="censored">matter</span> <span class="censored">of</span> <span class="censored">fact,</span> <span class="censored">when</span> <span class="censored">compression</span> <span class="censored">technology</span> <span class="censored">came</span> <span class="censored">along,</span> <span class="censored">we</span> <span class="censored">thought</span> <span class="censored">the</span> <span class="censored">future</span> <span class="censored">in</span> <span class="censored">1996</span> <span class="censored">was</span> <span class="censored">about</span> <span class="censored">voice.</span> <span class="censored">We</span> <span class="censored">got</span> <span class="censored">it</span> <span class="censored">wrong.</span> <span class="censored">It</span> <span class="censored">is</span> <span class="censored">about</span> <span class="censored">voice,</span> <span class="censored">video,</span> <span class="censored">and</span> <span class="censored">data,</span> <span class="censored">and</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">what</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">today</span> <span class="censored">on</span> <span class="censored">these</span> <span class="censored">cell</span> <span class="censored">phones.</span> <span class="censored">–Steve</span> <span class="censored">Buyer</span></em></p> <p><span class="censored">TL;DR:</span> <span class="censored">Compression</span> <span class="censored">is</span> <span class="censored">everywhere:</span> <span class="censored">CDNs,</span> <span class="censored">HTTP</span> <span class="censored">servers,</span> <span class="censored">even</span> <span class="censored">in</span> <span class="censored">RPC</span> <span class="censored">frameworks</span> <span class="censored">like</span> <span class="censored">Connect.</span> <span class="censored">This</span> <span class="censored">pervasiveness</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">wire</span> <span class="censored">size</span> <span class="censored">tradeoffs</span> <span class="censored">matter</span> <span class="censored">less</span> <span class="censored">than</span> <span class="censored">they</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">twenty</span> <span class="censored">years</span> <span class="censored">ago,</span> <span class="censored">when</span> <span class="censored">Protobuf</span> <span class="censored">was</span> <span class="censored">designed.</span></p> <blockquote> <p><span class="censored">I’m</span> <span class="censored">editing</span> <span class="censored">a</span> <span class="censored">series</span> <span class="censored">of</span> <span class="censored">best</span> <span class="censored">practice</span> <span class="censored">pieces</span> <span class="censored">on</span> <span class="censored">Protobuf,</span> <span class="censored">a</span> <span class="censored">language</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">work</span> <span class="censored">on</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">lots</span> <span class="censored">of</span> <span class="censored">evil</span> <span class="censored">corner-cases.These</span> <span class="censored">are</span> <span class="censored">shorter</span> <span class="censored">than</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">typically</span> <span class="censored">post</span> <span class="censored">here,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">think</span> <span class="censored">it</span> <span class="censored">fits</span> <span class="censored">with</span> <span class="censored">what</span> <span class="censored">you,</span> <span class="censored">dear</span> <span class="censored">reader,</span> <span class="censored">come</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">blog</span> <span class="censored">for.</span> <span class="censored">These</span> <span class="censored">tips</span> <span class="censored">are</span> <span class="censored">also</span> <span class="censored">posted</span> <span class="censored">on</span> <span class="censored">the</span> <a href="https://buf.build/blog/totw-2-compress-protos"><span class="censored">buf.build</span> <span class="censored">blog</span></a><span class="censored">.</span></p> </blockquote> <h2 id="varints-from-1998"><a href="#varints-from-1998"><span class="censored">Varints</span> <span class="censored">from</span> <span class="censored">1998</span></a></h2> <p><span class="censored">Protobuf’s</span> <span class="censored">wire</span> <span class="censored">format</span> <span class="censored">is</span> <span class="censored">intended</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">relatively</span> <span class="censored">small.</span> <span class="censored">It</span> <span class="censored">makes</span> <span class="censored">use</span> <span class="censored">of</span> <em><span class="censored">variable-width</span> <span class="censored">integers</span></em> <span class="censored">so</span> <span class="censored">that</span> <span class="censored">smaller</span> <span class="censored">values</span> <span class="censored">take</span> <span class="censored">up</span> <span class="censored">less</span> <span class="censored">space</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">wire.</span> <span class="censored">Fixed</span> <span class="censored">width</span> <span class="censored">integers</span> <span class="censored">might</span> <span class="censored">be</span> <span class="censored">larger</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">wire,</span> <span class="censored">but</span> <span class="censored">often</span> <span class="censored">have</span> <span class="censored">faster</span> <span class="censored">decoding</span> <span class="censored">times.</span></p> <p><span class="censored">But</span> <span class="censored">what</span> <span class="censored">if</span> <span class="censored">I</span> <span class="censored">told</span> <span class="censored">you</span> <span class="censored">that</span> <span class="censored">doesn’t</span> <span class="censored">matter?</span></p> <p><span class="censored">See,</span> <span class="censored">most</span> <span class="censored">internet</span> <span class="censored">traffic</span> <span class="censored">is</span> <span class="censored">compressed.</span> <span class="censored">Bandwidth</span> <span class="censored">is</span> <span class="censored">precious,</span> <span class="censored">and</span> <span class="censored">CDN</span> <span class="censored">operators</span> <span class="censored">don’t</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">waste</span> <span class="censored">time</span> <span class="censored">sending</span> <span class="censored">big</span> <span class="censored">blobs</span> <span class="censored">full</span> <span class="censored">of</span> <span class="censored">zeros.</span> <span class="censored">There</span> <span class="censored">are</span> <span class="censored">many</span> <span class="censored">compression</span> <span class="censored">algorithms</span> <span class="censored">available,</span> <span class="censored">but</span> <span class="censored">the</span> <span class="censored">state</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">art</span> <span class="censored">for</span> <span class="censored">HTTP</span> <span class="censored">requests</span> <span class="censored">(which</span> <span class="censored">dominates</span> <span class="censored">much</span> <span class="censored">of</span> <span class="censored">global</span> <span class="censored">internet</span> <span class="censored">traffic)</span> <span class="censored">is</span> <a href="https://en.wikipedia.org/wiki/Brotli"><span class="censored">Brotli</span></a><span class="censored">,</span> <span class="censored">an</span> <span class="censored">algorithm</span> <span class="censored">developed</span> <span class="censored">at</span> <span class="censored">Google</span> <span class="censored">in</span> <span class="censored">2013</span> <span class="censored">and</span> <span class="censored">standardized</span> <span class="censored">in</span> <span class="censored">IETF</span> <a href="https://datatracker.ietf.org/doc/html/rfc7932"><span class="censored">RFC7932</span></a> <span class="censored">in</span> <span class="censored">2016.</span> <span class="censored">There</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">good</span> <span class="censored">chance</span> <span class="censored">that</span> <span class="censored">this</span> <span class="censored">article</span> <span class="censored">was</span> <span class="censored">delivered</span> <span class="censored">to</span> <span class="censored">your</span> <span class="censored">web</span> <span class="censored">browser</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">Brotli-compressed</span> <span class="censored">blob.</span></p> <h2 id="using-compression"><a href="#using-compression"><span class="censored">Using</span> <span class="censored">Compression</span></a></h2> <p><span class="censored">How</span> <span class="censored">compression</span> <span class="censored">is</span> <span class="censored">applied</span> <span class="censored">in</span> <span class="censored">your</span> <span class="censored">case</span> <span class="censored">will</span> <span class="censored">vary,</span> <span class="censored">but</span> <span class="censored">both</span> <span class="censored">Connect</span> <span class="censored">RPC</span> <span class="censored">and</span> <span class="censored">gRPC</span> <span class="censored">support</span> <span class="censored">native</span> <span class="censored">compression.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">Connect</span> <span class="censored">has</span> <span class="censored">an</span> <span class="censored">API</span> <span class="censored">for</span> <span class="censored">injecting</span> <span class="censored">compression</span> <span class="censored">providers:</span> <a href="https://pkg.go.dev/connectrpc.com/connect#WithCompression"><span class="censored">https://pkg.go.dev/connectrpc.com/connect#WithCompression</span></a><span class="censored">.</span></p> <p><span class="censored">Connect</span> <span class="censored">uses</span> <code class="language-plaintext highlighter-rouge"><span class="censored">gzip</span></code> <span class="censored">by</span> <span class="censored">default,</span> <span class="censored">which</span> <span class="censored">uses</span> <span class="censored">the</span> <span class="censored">DEFLATE</span> <span class="censored">compression</span> <span class="censored">algorithm.</span> <span class="censored">Providing</span> <span class="censored">your</span> <span class="censored">own</span> <span class="censored">compression</span> <span class="censored">algorithm</span> <span class="censored">(such</span> <span class="censored">as</span> <span class="censored">Brotli)</span> <span class="censored">is</span> <span class="censored">pretty</span> <span class="censored">simple,</span> <span class="censored">as</span> <span class="censored">shown</span> <span class="censored">by</span> <a href="https://github.com/mattrobenolt/connect-brotli/blob/921ee0236bcd2d66827590c6890bb850e56516ad/connect_brotli.go"><span class="censored">this</span> <span class="censored">third-party</span> <span class="censored">package</span></a><span class="censored">.</span></p> <p><span class="censored">Other</span> <span class="censored">services</span> <span class="censored">may</span> <span class="censored">compress</span> <span class="censored">for</span> <span class="censored">you</span> <span class="censored">transparently.</span> <span class="censored">Any</span> <span class="censored">competent</span> <span class="censored">CDN</span> <span class="censored">will</span> <span class="censored">likely</span> <span class="censored">use</span> <span class="censored">Brotli</span> <span class="censored">(or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">gzip</span></code> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">zlib</span></code><span class="censored">,</span> <span class="censored">but</span> <span class="censored">probably</span> <span class="censored">Brotli)</span> <span class="censored">to</span> <span class="censored">compress</span> <span class="censored">any</span> <span class="censored">files</span> <span class="censored">it</span> <span class="censored">serves</span> <span class="censored">for</span> <span class="censored">you.</span> <span class="censored">(In</span> <span class="censored">fact,</span> <span class="censored">JavaScript</span> <span class="censored">and</span> <span class="censored">HTML</span> <span class="censored">minimization</span> <span class="censored">can</span> <span class="censored">often</span> <span class="censored">be</span> <span class="censored">rendered</span> <span class="censored">irrelevant</span> <span class="censored">by</span> <span class="censored">HTTP</span> <span class="censored">compression,</span> <span class="censored">too.)</span></p> <p><span class="censored">It’s</span> <span class="censored">important</span> <span class="censored">to</span> <span class="censored">remember</span> <span class="censored">that</span> <span class="censored">Protobuf</span> <span class="censored">predates</span> <span class="censored">pervasive</span> <span class="censored">compression:</span> <span class="censored">if</span> <span class="censored">it</span> <span class="censored">didn’t,</span> <span class="censored">it</span> <span class="censored">would</span> <span class="censored">almost</span> <span class="censored">certainly</span> <span class="censored">not</span> <span class="censored">use</span> <span class="censored">variable-width</span> <span class="censored">integers</span> <span class="censored">for</span> <span class="censored">anything.</span> <span class="censored">It</span> <span class="censored">only</span> <span class="censored">uses</span> <span class="censored">them</span> <span class="censored">because</span> <span class="censored">they</span> <span class="censored">offer</span> <span class="censored">a</span> <span class="censored">primitive</span> <span class="censored">form</span> <span class="censored">of</span> <span class="censored">compression</span> <span class="censored">in</span> <span class="censored">exchange</span> <span class="censored">for</span> <span class="censored">being</span> <span class="censored">slower</span> <span class="censored">to</span> <span class="censored">decode.</span> <span class="censored">If</span> <span class="censored">that</span> <span class="censored">tradeoff</span> <span class="censored">was</span> <span class="censored">eliminated,</span> <span class="censored">Protobuf</span> <span class="censored">would</span> <span class="censored">almost</span> <span class="censored">certainly</span> <span class="censored">only</span> <span class="censored">use</span> <span class="censored">fixed-width</span> <span class="censored">integers</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">wire.</span></p> <h2 id="how-good-is-it-really"><a href="#how-good-is-it-really"><span class="censored">How</span> <span class="censored">Good</span> <span class="censored">Is</span> <span class="censored">It</span> <span class="censored">Really?</span></a></h2> <p><span class="censored">Let’s</span> <span class="censored">do</span> <span class="censored">some</span> <span class="censored">apples-to-apples</span> <span class="censored">comparisons.</span> <span class="censored">Consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">Protobuf</span> <span class="censored">type.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd"><span class="censored">message</span></span> <span class="nc"><span class="censored">Foo</span></span> <span class="p"><span class="censored">{</span></span>
	<span class="k"><span class="censored">repeated</span></span> <span class="kt"><span class="censored">int32</span></span> <span class="na"><span class="censored">varints</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
	<span class="k"><span class="censored">repeated</span></span> <span class="kt"><span class="censored">sfixed32</span></span> <span class="na"><span class="censored">fixeds</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Protobuf</span></div></div> </div> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">two</span> <span class="censored">fields</span> <span class="censored">that</span> <span class="censored">contain</span> <span class="censored">essentially</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">data,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">encoded</span> <span class="censored">in</span> <span class="censored">four</span> <span class="censored">different</span> <span class="censored">ways:</span> <span class="censored">as</span> <span class="censored">old-style</span> <span class="censored">repeated</span> <span class="censored">fields,</span> <span class="censored">as</span> <span class="censored">packed</span> <span class="censored">fields,</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">integers</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">encoded</span> <span class="censored">as</span> <span class="censored">varints</span> <span class="censored">or</span> <span class="censored">fixed32</span> <span class="censored">values.</span></p> <p><span class="censored">Using</span> <a href="https://github.com/protocolbuffers/protoscope"><span class="censored">Protoscope</span></a><span class="censored">,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">create</span> <span class="censored">some</span> <span class="censored">data</span> <span class="censored">that</span> <span class="censored">exercises</span> <span class="censored">these</span> <span class="censored">four</span> <span class="censored">cases:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"><span class="censored">#</span> <span class="censored">a.pb,</span> <span class="censored">repeated</span> <span class="censored">varint</span>
</span><span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">:</span></span> <span class="mi"><span class="censored">1</span></span>
<span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">:</span></span> <span class="mi"><span class="censored">2</span></span>
<span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">:</span></span> <span class="mi"><span class="censored">3</span></span>
<span class="c1"><span class="censored">#</span> <span class="censored">...</span>
</span>
<span class="c1"><span class="censored">#</span> <span class="censored">b.pb,</span> <span class="censored">packed</span> <span class="censored">varint</span>
</span><span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">:</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="mi"><span class="censored">1</span></span> <span class="mi"><span class="censored">2</span></span> <span class="mi"><span class="censored">3</span></span>
  <span class="c1"><span class="censored">#</span> <span class="censored">...</span>
</span><span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">#</span> <span class="censored">c.pb,</span> <span class="censored">repeated</span> <span class="censored">fixed32</span>
</span><span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">:</span></span> <span class="mi"><span class="censored">1</span></span><span class="n"><span class="censored">i32</span></span>
<span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">:</span></span> <span class="mi"><span class="censored">2</span></span><span class="n"><span class="censored">i32</span></span>
<span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">:</span></span> <span class="mi"><span class="censored">3</span></span><span class="n"><span class="censored">i32</span></span>

<span class="c1"><span class="censored">#</span> <span class="censored">d.pb,</span> <span class="censored">packed</span> <span class="censored">fixed32</span>
</span><span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">:</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="mi"><span class="censored">1</span></span><span class="n"><span class="censored">i32</span></span> <span class="mi"><span class="censored">2</span></span><span class="n"><span class="censored">i32</span></span> <span class="mi"><span class="censored">3</span></span><span class="n"><span class="censored">i32</span></span>
  <span class="c1"><span class="censored">#</span> <span class="censored">...</span>
</span><span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Protoscope</span></div></div> </div> <p><span class="censored">Each</span> <span class="censored">blob</span> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">integers</span> <span class="censored">from</span> <span class="censored">1</span> <span class="censored">to</span> <span class="censored">1000</span> <span class="censored">encoded</span> <span class="censored">in</span> <span class="censored">different</span> <span class="censored">ways.</span> <span class="censored">I’ll</span> <span class="censored">compress</span> <span class="censored">each</span> <span class="censored">one</span> <span class="censored">using</span> <span class="censored">gzip,</span> <span class="censored">zlib,</span> <span class="censored">and</span> <span class="censored">Brotli,</span> <span class="censored">using</span> <span class="censored">their</span> <span class="censored">default</span> <span class="censored">compression</span> <span class="censored">levels,</span> <span class="censored">and</span> <span class="censored">arrange</span> <span class="censored">their</span> <span class="censored">sizes,</span> <span class="censored">in</span> <span class="censored">bytes,</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">table</span> <span class="censored">below.</span></p> <table> <thead> <tr> <th><span class="censored">File</span></th> <th><span class="censored">Uncompressed</span></th> <th> <code class="language-plaintext highlighter-rouge"><span class="censored">gzip</span></code> <span class="censored">(DEFLATE)</span> </th> <th><code class="language-plaintext highlighter-rouge"><span class="censored">zlib</span></code></th> <th><span class="censored">Brotli</span></th> </tr> </thead> <tbody> <tr> <td><span class="censored">a.pb</span></td> <td><span class="censored">2875</span></td> <td><span class="censored">1899</span></td> <td><span class="censored">1878</span></td> <td><span class="censored">1094</span></td> </tr> <tr> <td><span class="censored">b.pb</span></td> <td><span class="censored">1877</span></td> <td><span class="censored">1534</span></td> <td><span class="censored">1524</span></td> <td><span class="censored">885</span></td> </tr> <tr> <td><span class="censored">c.pb</span></td> <td><span class="censored">5005</span></td> <td><span class="censored">1577</span></td> <td><span class="censored">1567</span></td> <td><span class="censored">1140</span></td> </tr> <tr> <td><span class="censored">d.pb</span></td> <td><span class="censored">4007</span></td> <td><span class="censored">1440</span></td> <td><span class="censored">1916</span></td> <td><span class="censored">1140</span></td> </tr> </tbody> </table> <p><span class="censored">Compression</span> <span class="censored">achieves</span> <span class="censored">incredible</span> <span class="censored">results:</span> <span class="censored">Brotli</span> <span class="censored">manages</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">files</span> <span class="censored">down</span> <span class="censored">to</span> <span class="censored">around</span> <span class="censored">1.1</span> <span class="censored">kB,</span> <span class="censored">except</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">packed</span> <span class="censored">varints,</span> <span class="censored">which</span> <span class="censored">it</span> <span class="censored">gets</span> <span class="censored">about</span> <span class="censored">250</span> <span class="censored">bytes</span> <span class="censored">smaller!</span> <span class="censored">Of</span> <span class="censored">course,</span> <span class="censored">that’s</span> <span class="censored">only</span> <span class="censored">because</span> <span class="censored">most</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">values</span> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">repeated</span> <span class="censored">field</span> <span class="censored">are</span> <span class="censored">small.</span> <span class="censored">If</span> <span class="censored">the</span> <span class="censored">values</span> <span class="censored">range</span> <span class="censored">from</span> <span class="censored">100000</span> <span class="censored">to</span> <span class="censored">101000,</span> <span class="censored">b.pb</span> <span class="censored">and</span> <span class="censored">d.pb</span> <span class="censored">are</span> <span class="censored">3006</span> <span class="censored">and</span> <span class="censored">4007</span> <span class="censored">bytes</span> <span class="censored">respectively</span> <span class="censored">(see</span> <span class="censored">that</span> <span class="censored">d.pb’s</span> <span class="censored">size</span> <span class="censored">is</span> <span class="censored">unchanged!),</span> <span class="censored">but</span> <span class="censored">when</span> <span class="censored">compressed</span> <span class="censored">with</span> <span class="censored">brotli,</span> <span class="censored">the</span> <span class="censored">lead</span> <span class="censored">for</span> <span class="censored">b.pb</span> <span class="censored">starts</span> <span class="censored">to</span> <span class="censored">disappear:</span> <span class="censored">1039</span> <span class="censored">bytes</span> <span class="censored">vs.</span> <span class="censored">1163</span> <span class="censored">bytes.</span> <span class="censored">Now</span> <span class="censored">it’s</span> <span class="censored">only</span> <span class="censored">120</span> <span class="censored">bytes</span> <span class="censored">smaller.</span></p> <h2 id="are-varints-still-better"><a href="#are-varints-still-better"><span class="censored">Are</span> <span class="censored">Varints</span> <span class="censored">Still</span> <span class="censored">Better?</span></a></h2> <p><span class="censored">Applying</span> <span class="censored">compression</span> <span class="censored">can</span> <span class="censored">often</span> <span class="censored">have</span> <span class="censored">similar</span> <span class="censored">results</span> <span class="censored">to</span> <span class="censored">replacing</span> <span class="censored">everything</span> <span class="censored">with</span> <span class="censored">varints,</span> <span class="censored">but</span> <span class="censored">not</span> <span class="censored">exactly:</span> <span class="censored">using</span> <span class="censored">a</span> <span class="censored">varint</span> <span class="censored">will</span> <span class="censored">likely</span> <span class="censored">always</span> <span class="censored">be</span> <span class="censored">slightly</span> <span class="censored">smaller,</span> <span class="censored">at</span> <span class="censored">least</span> <span class="censored">when</span> <span class="censored">using</span> <span class="censored">state-of-the-art</span> <span class="censored">compression</span> <span class="censored">like</span> <span class="censored">Brotli.</span> <span class="censored">But</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">pretty</span> <span class="censored">much</span> <span class="censored">always</span> <span class="censored">assume</span> <span class="censored">you</span> <em><span class="censored">will</span></em> <span class="censored">be</span> <span class="censored">using</span> <span class="censored">compression,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">to</span> <span class="censored">compress</span> <span class="censored">HTTP</span> <span class="censored">headers</span> <span class="censored">and</span> <span class="censored">other</span> <span class="censored">ancillary</span> <span class="censored">content</span> <span class="censored">in</span> <span class="censored">your</span> <span class="censored">request.</span> <span class="censored">Compression</span> <span class="censored">is</span> <span class="censored">generic</span> <span class="censored">and</span> <span class="censored">highly</span> <span class="censored">optimized—it</span> <span class="censored">applies</span> <span class="censored">to</span> <span class="censored">all</span> <span class="censored">data,</span> <span class="censored">regardless</span> <span class="censored">of</span> <span class="censored">schema,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">often</span> <span class="censored">far</span> <span class="censored">more</span> <span class="censored">optimized</span> <span class="censored">than</span> <span class="censored">application-level</span> <span class="censored">codecs</span> <span class="censored">like</span> <span class="censored">those</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">Protobuf</span> <span class="censored">library.</span></p> <p><span class="censored">Not</span> <span class="censored">to</span> <span class="censored">mention,</span> <span class="censored">you</span> <span class="censored">should</span> <span class="censored">definitely</span> <span class="censored">be</span> <span class="censored">compressing</span> <span class="censored">any</span> <span class="censored">large</span> <span class="censored">data</span> <span class="censored">blobs</span> <span class="censored">you’re</span> <span class="censored">storing</span> <span class="censored">on</span> <span class="censored">disk,</span> <span class="censored">too!</span></p> <p><span class="censored">As</span> <span class="censored">a</span> <span class="censored">result,</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">usually</span> <span class="censored">disregard</span> <span class="censored">many</span> <span class="censored">encoded</span> <span class="censored">size</span> <span class="censored">concerns</span> <span class="censored">when</span> <span class="censored">making</span> <span class="censored">tradeoffs</span> <span class="censored">in</span> <span class="censored">designing</span> <span class="censored">a</span> <span class="censored">Protobuf</span> <span class="censored">type.</span> <span class="censored">Fixed</span> <span class="censored">integer</span> <span class="censored">types</span> <span class="censored">will</span> <span class="censored">decode</span> <span class="censored">faster,</span> <span class="censored">so</span> <span class="censored">if</span> <span class="censored">decoding</span> <span class="censored">speed</span> <span class="censored">is</span> <span class="censored">important</span> <span class="censored">to</span> <span class="censored">you,</span> <span class="censored">and</span> <span class="censored">you’re</span> <span class="censored">worried</span> <span class="censored">about</span> <span class="censored">the</span> <span class="censored">size</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">wire,</span> <span class="censored">don’t.</span> <span class="censored">It’s</span> <span class="censored">almost</span> <span class="censored">certainly</span> <span class="censored">already</span> <span class="censored">taken</span> <span class="censored">care</span> <span class="censored">of</span> <span class="censored">at</span> <span class="censored">a</span> <span class="censored">different</span> <span class="censored">layer</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">stack.</span></p> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-07-16</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/16/hyperpb/"><span class="censored">Parsing</span> <span class="censored">Protobuf</span> <span class="censored">Like</span> <span class="censored">Never</span> <span class="censored">Before</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-14</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/14/best/"><span class="censored">The</span> <span class="censored">Best</span> <span class="censored">C++</span> <span class="censored">Library</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-07</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/07/nosplit/"><span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>