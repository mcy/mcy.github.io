<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Why SSA? &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/styles.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script src="https://mcyoung.xyz/public/js/nsfw.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Why SSA? &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/ssa-1-b79112da21ec3e15691884c06e369be3a1fb3407.png"> <meta property="og:title" content="Why SSA? &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/ssa-1-b79112da21ec3e15691884c06e369be3a1fb3407.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/10/21/ssa-1/"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://mcyoung.xyz/art">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile">&copy; 2025 Miguel Young de la Sota <br> <div style="font-size: 95%;"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> </div></span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-10-21 • 5756 words • 63 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#optimization">#optimization</a> • <a href="https://mcyoung.xyz/tags.html#toolchains">#toolchains</a> </span> <h1><a href="/2025/10/21/ssa-1/"> Why SSA? </a></h1> </div> <div class="post"> <p>If you’ve read anything about compilers in the last two decades or so, you have almost certainly heard of <em>SSA compilers</em>, a popular architecture featured in many optimizing compilers, including ahead-of-time compilers such as LLVM, GCC, Go, CUDA (and various shader compilers), Swift<sup id="fnref:swift" role="doc-noteref"><a href="#fn:swift" class="footnote" rel="footnote">1</a></sup>, and MSVC<sup id="fnref:msvc" role="doc-noteref"><a href="#fn:msvc" class="footnote" rel="footnote">2</a></sup>, and just-in-time compilers such as HotSpot C2<sup id="fnref:hotspot" role="doc-noteref"><a href="#fn:hotspot" class="footnote" rel="footnote">3</a></sup>, V8<sup id="fnref:v8" role="doc-noteref"><a href="#fn:v8" class="footnote" rel="footnote">4</a></sup>, SpiderMonkey<sup id="fnref:spidermonkey" role="doc-noteref"><a href="#fn:spidermonkey" class="footnote" rel="footnote">5</a></sup>, LuaJIT, and the Android Runtime<sup id="fnref:art" role="doc-noteref"><a href="#fn:art" class="footnote" rel="footnote">6</a></sup>.</p> <p>SSA is hugely popular, to the point that most compiler projects no longer bother with other IRs for optimization<sup id="fnref:ghc" role="doc-noteref"><a href="#fn:ghc" class="footnote" rel="footnote">7</a></sup>. This is because SSA is incredibly nimble at the types of program analysis and transformation that compiler optimizations want to do on your code. But <em>why</em>? Many of my friends who don’t do compilers often say that compilers seem like opaque magical black boxes, and SSA, as it often appears in the literature, is impenetrably complex.</p> <p>But it’s not! SSA is actually very simple once you forget everything you think your programs are actually doing. We will develop the concept of SSA form, a simple SSA IR, prove facts about it, and design some optimizations on it.</p> <blockquote id="note:1" class="note"> <p><a href="#note:1"><span class="chip">note</span></a></p> <p>I have <a href="https://mcyoung.xyz/2023/08/01/llvm-ir">previously written</a> about the granddaddy of all modern SSA compilers, LLVM. This article is about SSA in general, and won’t really have anything to do with LLVM. However, it may be helpful to read that article to make some of the things in this article feel more concrete.</p> </blockquote> <h2 id="what-is-ssa"><a href="#what-is-ssa">What Is SSA?</a></h2> <p>SSA is a property of <em>intermediate representations</em> (IRs), primarily used by compilers for optimizing imperative code that target a <em>register machine</em>. Register machines are computers that feature a fixed set of <em>registers</em> that can be used as the operands for instructions: this includes virtually all physical processors, including CPUs, GPUs, and weird tings like DSPs.</p> <p>SSA is most frequently found in compiler <em>middle-ends</em>, the optimizing component between the <em>frontend</em> (which deals with the <em>surface language</em> programmers write, and lowers it into the middle-end’s IR), and the <em>backend</em> (which takes the optimized IR and lowers it into the target platform’s assembly).</p> <p>SSA IRs, however, often have little resemblance to the surface language they lower out of, or the assembly language they target. This is because neither of these representations make it easy for a compiler to intuit optimization opportunities.</p> <h3 id="imperative-code-is-hard"><a href="#imperative-code-is-hard">Imperative Code Is Hard</a></h3> <p>Imperative code consists of a sequence of operations that mutate the executing machine’s state to produce a desired result. For example, consider the following C program:</p> <div class="codeblock" id="code:1"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:1">C</a></div></div> <p>This program returns <code class="language-plaintext highlighter-rouge">0</code> no matter what its input is, so we can optimize it down to this:</p> <div class="codeblock" id="code:2"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:2">C</a></div></div> <p>But, how would you write a general algorithm to detect that all of the operations cancel out? You’re forced to keep in mind <em>program order</em> to perform the necessary dataflow analysis, following mutations of <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> through the program. But this isn’t very general, and traversing all of those paths makes the search space for large functions very big. Instead, you would like to rewrite the program such that <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> gradually get replaced with the expression that calculates the most recent value, like this:</p> <div class="codeblock" id="code:3"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">-</span> <span class="n">b2</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">a3</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:3">C</a></div></div> <p>Then we can replace each occurrence of a variable with its right-hand side recursively…</p> <div class="codeblock" id="code:4"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a3</span> <span class="o">=</span> <span class="p">(</span><span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:4">C</a></div></div> <p>Then fold the constants together…</p> <div class="codeblock" id="code:5"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">-</span> <span class="n">argc</span>
  <span class="k">return</span> <span class="n">argc</span> <span class="o">-</span> <span class="n">argc</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:5">C</a></div></div> <p>And finally, we see that we’re returning <code class="language-plaintext highlighter-rouge">argc - argc</code>, and can replace it with <code class="language-plaintext highlighter-rouge">0</code>. All the other variables are now unused, so we can delete them.</p> <p>The reason this works so well is because we took a function with mutation, and converted it into a <em>combinatorial circuit</em>, a type of digital logic circuit that has no state, and which is very easy to analyze. The dependencies between <em>nodes</em> in the circuit (corresponding to primitive operations such as addition or multiplication) are obvious from its structure. For example, consider the following circuit diagram for a one-bit multiplier:</p> <figure> <p><img src="https://mcyoung.xyz/public/images/multiplier.png" style="filter:invert(100%);"/></p> <figcaption>A binary multiplier (Wikipedia)</figcaption> </figure> <p>This graph representation of an operation program has two huge benefits:</p> <ol> <li> <p>The powerful tools of graph theory can be used to algorithmically analyze the program and discover useful properties, such as operations that are independent of each other or whose results are never used.</p> </li> <li> <p>The operations are not ordered with respect to each other except when there is a dependency; this is useful for reordering operations, something compilers really like to do.</p> </li> </ol> <p>The reason combinatorial circuits are the best circuits is because they are <em>directed acyclic graphs</em> (DAGs) which admit really nice algorithms. For example, longest path in a graph is <a href="https://en.wikipedia.org/wiki/NP-hardness">NP-hard</a> (and because <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo mathvariant="normal">≠</mo><mi>N</mi><mi>P</mi></mrow><annotation encoding="application/x-tex">P \neq NP</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">NP</span></span></span></span></span><sup id="fnref:p-np" role="doc-noteref"><a href="#fn:p-np" class="footnote" rel="footnote">8</a></sup>, has complexity <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(2^n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>). However, if the graph is a DAG, it admits an <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> solution!</p> <p>To understand this benefit, consider another program:</p> <div class="codeblock" id="code:6"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">*=</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="n">y</span> <span class="o">*=</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:6">C</a></div></div> <p>Suppose we wanted to replace each variable with its definition like we did before. We can’t <em>just</em> replace each constant variable with the expression that defines it though, because we would wind up with a different program!</p> <div class="codeblock" id="code:7"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">*=</span> <span class="n">y</span><span class="p">;</span>
  <span class="c1">// const int z = y; // Replace z with its definition.</span>
  <span class="n">y</span> <span class="o">*=</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:7">C</a></div></div> <p>Now, we pick up an extra <code class="language-plaintext highlighter-rouge">y</code> term because the squaring operation is no longer unused! We can put this into circuit form, but it requires inserting new variables for every mutation.</p> <p>But we can’t do this when complex control flow is involved! So all of our algorithms need to carefully account for mutations and program order, meaning that we don’t get to use the nice graph algorithms without careful modification.</p> <h2 id="the-ssa-invariant"><a href="#the-ssa-invariant">The SSA Invariant</a></h2> <p>SSA stands for “static single assignment”, and was developed in the 80s as a way to enhance the existing three-argument code (where every statement is in the form <code class="language-plaintext highlighter-rouge">x = y op z</code>) so that every program was circuit-like, using a very similar procedure to the one described above.</p> <p>The SSA invariant states that every variable in the program is assigned to by precisely one operation. If every operation in the program is visited once, they form a combinatorial circuit. Transformations are required to respect this invariant. In circuit form, a program is a graph where operations are nodes, and “registers” (which is what variables are usually called in SSA) are edges (specifically, each output of an operation corresponds to a register).</p> <p>But, again, control flow. We can’t hope to circuitize a loop, right? The key observation of SSA is that <em>most</em> parts of a program are circuit-like. A <em>basic block</em> is a maximal circuital component of a program. Simply put, it is a sequence of non-control flow operations, and a final <em>terminator</em> operation that transfers control to another basic block.</p> <p>The basic blocks themselves form a graph, the <em>control flow graph</em>, or CFG. This formulation of SSA is sometimes called SSA-CFG<sup id="fnref:non-cfg" role="doc-noteref"><a href="#fn:non-cfg" class="footnote" rel="footnote">9</a></sup>. This graph is <em>not</em> a DAG in general; however, separating the program into basic blocks conveniently factors out the “non-DAG” parts of the program, allowing for simpler analysis within basic blocks.</p> <p>There are two equivalent formalisms for SSA-CFG. The traditional one uses special “phi” operations (often called <em>phi nodes</em>, which is what I will call them here) to link registers across basic blocks. This is the formalism LLVM uses. A more modern approach, used by MLIR, is <em>block arguments</em>: each basic block specifies parameters, like a function, and blocks transferring control flow to it must pass arguments of those types to it.</p> <h3 id="my-first-ir"><a href="#my-first-ir">My First IR</a></h3> <p>Let’s look at some code. First, consider the following C function which calculates Fibonacci numbers using a loop.</p> <div class="codeblock" id="code:8"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">fib</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:8">C</a></div></div> <p>How might we express this in an SSA-CFG IR? Let’s start inventing our SSA IR! It will look a <em>little bit</em> like LLVM IR, since that’s what I’m used to looking at.</p> <div class="codeblock" id="code:fib-ir"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c">// Globals (including functions) start with $, registers with %.</span>
<span class="c">// Each function declares a signature.</span>
<span class="k">func</span> <span class="n">fib</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i32</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// The first block has no label and can't be "jumped to".</span>
    <span class="c">//</span>
    <span class="c">// Single-argument goto jumps directly into a block with</span>
    <span class="c">// the given arguments.</span>
    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>

  <span class="c">// Block labels start with a `!`, can contain dots, and</span>
  <span class="c">// define parameters. Register names are scoped to a block.</span>
  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// Integer comparison: %n &gt; 0.</span>
    <span class="o">%</span><span class="n">cont</span> <span class="o">=</span> <span class="n">cmp</span><span class="o">.</span><span class="n">gt</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span>

    <span class="c">// Multi-argument goto is a switch statement. The compiler</span>
    <span class="c">// may assume that `%cont` is among the cases listed in the</span>
    <span class="c">// goto.</span>
    <span class="k">goto</span> <span class="o">%</span><span class="n">cont</span> <span class="p">{</span>
      <span class="m">0</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">ret</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">),</span> <span class="c">// Goto can jump to the function exit.</span>
      <span class="m">1</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">),</span>
    <span class="p">}</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// Addition and subtraction.</span>
    <span class="o">%</span><span class="n">c</span>    <span class="o">=</span> <span class="n">add</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
    <span class="o">%</span><span class="n">n</span><span class="m">.2</span>  <span class="o">=</span> <span class="n">sub</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">1</span>

    <span class="c">// Note the assignments in @loop.start:</span>
    <span class="c">// %n = %n.2, %a = %b, %b = %c.</span>
    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="m">.2</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:fib-ir">SSA-CFG</a></div></div> <p>Every block ends in a <code class="language-plaintext highlighter-rouge">goto</code>, which transfers control to one of several possible blocks. In the process, it calls that block with the given arguments. One can think of a basic block as a tiny function which <em>tails</em><sup id="fnref:tail-call" role="doc-noteref"><a href="#fn:tail-call" class="footnote" rel="footnote">10</a></sup> into other basic blocks in the same function.</p> <blockquote id="aside:phi-nodes" class="aside"> <p><a href="#aside:phi-nodes"><span class="chip">aside</span><span class="title">Phi Nodes</span></a></p> <p>LLVM IR is… older, so it uses the older formalism of phi nodes. “Phi” comes from “phony”, because it is an operation that doesn’t do anything; it just links registers from predecessors.</p> <p>A <code class="language-plaintext highlighter-rouge">phi</code> operation is essentially a switch-case on the predecessors, each case selecting a register from that predecessor (or an immediate). For example, <code class="language-plaintext highlighter-rouge">@loop.start</code> has two predecessors, the implicit entry block <code class="language-plaintext highlighter-rouge">@entry</code>, and <code class="language-plaintext highlighter-rouge">@loop.body</code>. In a phi node IR, instead of taking a block argument for <code class="language-plaintext highlighter-rouge">%n</code>, it would specify</p> <div class="codeblock" id="code:9"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="o">&gt;</span>   <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="n">phi</span> <span class="p">{</span> <span class="err">@</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="m">0</span><span class="p">,</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span> <span class="o">-&gt;</span> <span class="o">%</span><span class="n">n</span><span class="m">.2</span> <span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:9">SSA-CFG</a></div></div> <p>The value of the <code class="language-plaintext highlighter-rouge">phi</code> operation is the value from whichever block jumped to this one.</p> <p>This can be awkward to type out by hand and read, but is a more convenient representation for describing algorithms (just “add a phi node” instead of “add a parameter and a corresponding argument”) and for the in-memory representation, but is otherwise completely equivalent.</p> </blockquote> <p>It’s a bit easier to understand the transformation from C to our IR if we first rewrite the C to use goto instead of a for loop:</p> <div class="codeblock" id="code:10"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">fib</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 <span class="nl">start:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">goto</span> <span class="n">start</span>

<span class="nl">ret:</span>
  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:10">C</a></div></div> <p>However, we still have mutation in the picture, so this isn’t SSA. To get into SSA, we need to replace every assignment with a new register, and somehow insert block arguments…</p> <h3 id="entering-ssa-form"><a href="#entering-ssa-form">Entering SSA Form</a></h3> <p>The <a href="#code:fib-ir">above IR code</a> is already partially optimized; the named variables in the C program have been <em>lifted</em> out of memory and into registers. If we represent each named variable in our C program with a pointer, we can avoid needing to put the program into SSA form immediately. This technique is used by frontends that lower into LLVM, like Clang.</p> <p>We’ll enhance our IR by adding a <code class="language-plaintext highlighter-rouge">stack</code> declaration for functions, which defines scratch space on the stack for the function to use. Each stack slot produces a pointer that we can <code class="language-plaintext highlighter-rouge">load</code> from and <code class="language-plaintext highlighter-rouge">store</code> to.</p> <p>Our Fibonacci function would now look like so:</p> <div class="codeblock" id="code:fib-memory"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="o">&amp;</span><span class="n">fib</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i32</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Declare stack slots.</span>
    <span class="o">%</span><span class="n">np</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>
    <span class="o">%</span><span class="n">ap</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>
    <span class="o">%</span><span class="n">bp</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>

    <span class="c">// Load initial values into them.</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="m">0</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="m">1</span>

    <span class="c">// Start the loop.</span>
    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">)</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="o">:</span> <span class="n">ptr</span><span class="p">)</span><span class="o">:</span>
    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">np</span>
    <span class="o">%</span><span class="n">cont</span> <span class="o">=</span> <span class="n">cmp</span><span class="o">.</span><span class="n">gt</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span>

    <span class="k">goto</span> <span class="o">%</span><span class="n">cont</span> <span class="p">{</span>
      <span class="m">0</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">exit</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="p">)</span>
      <span class="m">1</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">),</span>
    <span class="p">}</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="o">:</span> <span class="n">ptr</span><span class="p">)</span><span class="o">:</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">ap</span>
    <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">bp</span>
    <span class="o">%</span><span class="n">c</span> <span class="o">=</span> <span class="n">add</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span>

    <span class="o">%</span><span class="n">n</span>   <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">np</span>
    <span class="o">%</span><span class="n">n</span><span class="m">.2</span> <span class="o">=</span> <span class="n">sub</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">1</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="m">.2</span>

    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">)</span>

  <span class="err">@</span><span class="n">exit</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="o">:</span> <span class="n">ptr</span><span class="p">)</span><span class="o">:</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">ap</span>
    <span class="k">goto</span> <span class="err">@</span><span class="n">ret</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:fib-memory">SSA-CFG</a></div></div> <p>Any time we reference a named variable, we load from its stack slot, and any time we assign it, we store to that slot. This is very easy to get into from C, but the code sucks because it’s doing lots of unnecessary pointer operations. How do we get from this to the register-only function I showed earlier?</p> <blockquote id="aside:program-order" class="aside"> <p><a href="#aside:program-order"><span class="chip">aside</span><span class="title">Program Order</span></a></p> <p>We want program order to not matter for the purposes of reordering, but as we’ve written code here, program order <em>does</em> matter: loads depend on prior stores but stores don’t produce a value that can be used to link the two operations.</p> <p>We can restore not having program order by introducing operands representing an “address space”; loads and stores take an address space as an argument, and stores return a new address space. An address space, or <code class="language-plaintext highlighter-rouge">mem</code>, represents the state of some region of memory. Loads and stores are independent when they are not connected by a <code class="language-plaintext highlighter-rouge">mem</code> argument.</p> <p>This type of enhancement is used by Go’s SSA IR, for example. However, it adds a layer of complexity to the examples, so instead I will hand-wave this away.</p> </blockquote> <h2 id="the-dominance-relation"><a href="#the-dominance-relation">The Dominance Relation</a></h2> <p>Now we need to prove some properties about CFGs that are important for the definition and correctness of our optimization passes.</p> <p>First, some definitions.</p> <blockquote id="def:1" class="def"> <p><a href="#def:1"><span class="chip">definition</span></a></p> <p>The <strong>predecessors</strong> (or “preds”) of a basic block is the set of blocks with an outgoing edge <strong>to</strong> that block. A block may be its own predecessors.</p> </blockquote> <p>Some literature calls the above “direct” or immediate predecessors. For example, the preds of in our <a href="#code:fib-memory">example</a> are <code class="language-plaintext highlighter-rouge">@loop.start</code> are <code class="language-plaintext highlighter-rouge">@entry</code> (the special name for the function entry-point) <code class="language-plaintext highlighter-rouge">@loop.body</code>.</p> <blockquote id="def:2" class="def"> <p><a href="#def:2"><span class="chip">definition</span></a></p> <p>The <strong>successors</strong> (no, not “succs”) of a basic block is the set of blocks with an outgoing edge <strong>from</strong> that block. A block may be its own successors.</p> </blockquote> <p>The sucessors of <code class="language-plaintext highlighter-rouge">@loop.start</code> are <code class="language-plaintext highlighter-rouge">@exit</code> and <code class="language-plaintext highlighter-rouge">@loop.body</code>. The successors are listed in the loop’s <code class="language-plaintext highlighter-rouge">goto</code>.</p> <p>If a block <code class="language-plaintext highlighter-rouge">@a</code> is a transitive pred of a block <code class="language-plaintext highlighter-rouge">@b</code>, we say that <code class="language-plaintext highlighter-rouge">@a</code> <em>weakly dominates</em> <code class="language-plaintext highlighter-rouge">@b</code>, or that it is a <em>weak dominator</em> of <code class="language-plaintext highlighter-rouge">@b</code>. For example, <code class="language-plaintext highlighter-rouge">@entry</code>, <code class="language-plaintext highlighter-rouge">@loop.start</code> and <code class="language-plaintext highlighter-rouge">@loop.body</code> both weakly dominate <code class="language-plaintext highlighter-rouge">@exit</code>.</p> <p>However, this is not usually an especially useful relationship. Instead, we want to speak of dominators:</p> <blockquote id="def:3" class="def"> <p><a href="#def:3"><span class="chip">definition</span></a></p> <p>A block <code class="language-plaintext highlighter-rouge">@a</code> is a <strong>dominator</strong> (or <strong>dominates</strong>) <code class="language-plaintext highlighter-rouge">@b</code> if every pred of <code class="language-plaintext highlighter-rouge">@b</code> is dominated by <code class="language-plaintext highlighter-rouge">@a</code>, or if <code class="language-plaintext highlighter-rouge">@a</code> is <code class="language-plaintext highlighter-rouge">@b</code> itself.</p> <p>Equivalently, the dominator set of <code class="language-plaintext highlighter-rouge">@b</code> is the intersection of the dominator sets of its preds, plus <code class="language-plaintext highlighter-rouge">@b</code>.</p> </blockquote> <p>The dominance relation has some nice order properties that are necessary for defining the core graph algorithms of SSA.</p> <h3 id="some-graph-theory"><a href="#some-graph-theory">Some Graph Theory</a></h3> <p>We only consider CFGs which are flowgraphs, that is, all blocks are reachable from the root block <code class="language-plaintext highlighter-rouge">@entry</code>, which has no preds. This is necessary to eliminate some pathological graphs from our proofs. Importantly, we can always ask for an acyclic path<sup id="fnref:acyclic" role="doc-noteref"><a href="#fn:acyclic" class="footnote" rel="footnote">11</a></sup> from <code class="language-plaintext highlighter-rouge">@entry</code> to any block <code class="language-plaintext highlighter-rouge">@b</code>.</p> <p>An equivalent way to state the dominance relationship is that from every path from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code> contains all of <code class="language-plaintext highlighter-rouge">@b</code>’s dominators.</p> <blockquote id="prop:1" class="prop"> <p><a href="#prop:1"><span class="chip">proposition</span></a></p> <p><code class="language-plaintext highlighter-rouge">@a</code> dominates <code class="language-plaintext highlighter-rouge">@b</code> iff every path from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code> contains <code class="language-plaintext highlighter-rouge">@a</code>.</p> <blockquote id="proof:1" class="proof"> <p><a href="#proof:1"><span class="chip">proof</span></a></p> <p>First, assume every <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code> path contains <code class="language-plaintext highlighter-rouge">@a</code>. If <code class="language-plaintext highlighter-rouge">@b</code> is <code class="language-plaintext highlighter-rouge">@a</code>, we’re done. Otherwise we need to prove each predecessor of <code class="language-plaintext highlighter-rouge">@b</code> is dominated by <code class="language-plaintext highlighter-rouge">@a</code>; we do this by induction on the length of acyclic paths from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code>. Consider preds <code class="language-plaintext highlighter-rouge">@p</code> of <code class="language-plaintext highlighter-rouge">@b</code> that are not <code class="language-plaintext highlighter-rouge">@a</code>, and consider all acyclic paths <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@p</code>; by appending <code class="language-plaintext highlighter-rouge">@b</code> to them, we have an acyclic path <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">p&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code>, which must contain <code class="language-plaintext highlighter-rouge">@a</code>. Because both the last and second-to-last elements of this are not <code class="language-plaintext highlighter-rouge">@a</code>, it must be within the shorter path <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> which is shorter than <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">p&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>. Thus, by induction, <code class="language-plaintext highlighter-rouge">@a</code> dominates <code class="language-plaintext highlighter-rouge">@p</code> and therefore <code class="language-plaintext highlighter-rouge">@b</code></p> <p>Going the other way, if <code class="language-plaintext highlighter-rouge">@a</code> dominates <code class="language-plaintext highlighter-rouge">@b</code>, and consider a path <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code>. The second-to-last element of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> is a pred <code class="language-plaintext highlighter-rouge">@p</code> of <code class="language-plaintext highlighter-rouge">@b</code>; if it is <code class="language-plaintext highlighter-rouge">@a</code> we are done. Otherwise, we can consider the path <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> made by deleting <code class="language-plaintext highlighter-rouge">@b</code> at the end. <code class="language-plaintext highlighter-rouge">@p</code> is dominated by <code class="language-plaintext highlighter-rouge">@a</code>, and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">p&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> is shorter than <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span>, so we can proceed by induction as above.</p> </blockquote> </blockquote> <p>Onto those nice properties. Dominance allows us to take an arbitrarily complicated CFG and extract from it a DAG, composed of blocks ordered by dominance.</p> <blockquote id="thm:1" class="thm"> <p><a href="#thm:1"><span class="chip">theorem</span></a></p> <p>The dominance relation is a partial order.</p> <blockquote id="proof:2" class="proof"> <p><a href="#proof:2"><span class="chip">proof</span></a></p> <p>Dominance is reflexive and transitive by definition, so we only need to show blocks can’t dominate each other.</p> <p>Suppose distinct <code class="language-plaintext highlighter-rouge">@a</code> and <code class="language-plaintext highlighter-rouge">@b</code> dominate each other.Pick an acyclic path<span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@a</code>. Because <code class="language-plaintext highlighter-rouge">@b</code> dominates <code class="language-plaintext highlighter-rouge">@a</code>, there is a prefix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">p&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> of this path ending in <code class="language-plaintext highlighter-rouge">@b</code>. But because <code class="language-plaintext highlighter-rouge">@a</code> dominates <code class="language-plaintext highlighter-rouge">@b</code>, some prefix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">p&#x27;&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′′</span></span></span></span></span></span></span></span></span></span></span></span></span> of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">p&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> ends in <code class="language-plaintext highlighter-rouge">@a</code>. But now <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span> must contain <code class="language-plaintext highlighter-rouge">@a</code> twice, contradicting that it is acyclic.</p> </blockquote> </blockquote> <p>This allows us to write <code class="language-plaintext highlighter-rouge">@a &lt; @b</code> when <code class="language-plaintext highlighter-rouge">@a</code> dominates <code class="language-plaintext highlighter-rouge">@b</code>. There is an even more refined graph structure that we can build out of dominators, which follows immediately from the partial order theorem.</p> <blockquote id="cor:1" class="cor"> <p><a href="#cor:1"><span class="chip">corollary</span></a></p> <p>The dominators of a basic block are totally ordered by the dominance relation.</p> <blockquote id="proof:3" class="proof"> <p><a href="#proof:3"><span class="chip">proof</span></a></p> <p>Suppose <code class="language-plaintext highlighter-rouge">@a1 &lt; @b</code> and <code class="language-plaintext highlighter-rouge">@a2 &lt; @b</code>, but neither dominates the other. Then, there must exist acyclic paths from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code> which contain both, but in different orders. Take the subpaths of those paths which follow <code class="language-plaintext highlighter-rouge">@entry ... @a1</code>, and <code class="language-plaintext highlighter-rouge">@a1 ... @b</code>, neither of which contains <code class="language-plaintext highlighter-rouge">@a2</code>. Concatenating these paths yields a path from <code class="language-plaintext highlighter-rouge">@entry</code> to <code class="language-plaintext highlighter-rouge">@b</code> that does not contain <code class="language-plaintext highlighter-rouge">@a2</code>, a contradiction.</p> </blockquote> </blockquote> <p>This tells us that the DAG we get from the dominance relation is actually a tree, rooted at <code class="language-plaintext highlighter-rouge">@entry</code>. The parent of a node in this tree is called its <em>immediate dominator</em>.</p> <p>Computing dominators can be done iteratively: the dominator set of a block <code class="language-plaintext highlighter-rouge">@b</code> is the intersection the dominator sets of its preds, plus <code class="language-plaintext highlighter-rouge">@b</code>. This algorithm runs in quadratic time.</p> <p>A better algorithm is the Lengauer-Tarjan algorithm[^lta]. It is relatively simple, but explaining how to implement it is a bit out of scope for this article. I found a nice treatment of it <a href="https://www.cs.utexas.edu/~misra/Lengauer+Tarjan.pdf">here</a>.</p> <p>What’s important is we can compute the dominator tree without breaking the bank, and given any node, we can ask for its immediate dominator. Using immediate dominators, we can introduce the final, important property of dominators.</p> <blockquote id="def:4" class="def"> <p><a href="#def:4"><span class="chip">definition</span></a></p> <p>The <em>dominance frontier</em> of a block <code class="language-plaintext highlighter-rouge">@a</code> is the set of all blocks not dominated by <code class="language-plaintext highlighter-rouge">@a</code> with at least one pred which <code class="language-plaintext highlighter-rouge">@a</code> dominates.</p> </blockquote> <p>These are points where control flow merges from <em>distinct</em> paths: one containing <code class="language-plaintext highlighter-rouge">@a</code> and one not. The dominance frontier of <code class="language-plaintext highlighter-rouge">@loop.body</code> is <code class="language-plaintext highlighter-rouge">@loop.start</code>, whose preds are <code class="language-plaintext highlighter-rouge">@entry</code> and <code class="language-plaintext highlighter-rouge">@loop.body</code>.</p> <p>There are many ways to calculate dominance frontiers, but with a dominance tree in hand, we can do it like this:</p> <blockquote id="alg:dominance-frontiers" class="alg"> <p><a href="#alg:dominance-frontiers"><span class="chip">algorithm</span><span class="title">Dominance Frontiers.</span></a></p> <p>For each block <code class="language-plaintext highlighter-rouge">@b</code> with more than one pred, for each of its preds, let <code class="language-plaintext highlighter-rouge">@p</code> be that pred. Add <code class="language-plaintext highlighter-rouge">@b</code> to the dominance frontier of <code class="language-plaintext highlighter-rouge">@p</code> and all of its dominators, stopping when encountering <code class="language-plaintext highlighter-rouge">@b</code>’ immediate dominator.</p> <blockquote id="proof:4" class="proof"> <p><a href="#proof:4"><span class="chip">proof</span></a></p> <p>We need to prove that every block examined by the algorithm winds up in the correct frontiers.</p> <p>First, we check that every examined block <code class="language-plaintext highlighter-rouge">@b</code> is added to the correct frontier. If <code class="language-plaintext highlighter-rouge">@a &lt; @p</code>, where <code class="language-plaintext highlighter-rouge">@p</code> is a pred of <code class="language-plaintext highlighter-rouge">@b</code>, and a <code class="language-plaintext highlighter-rouge">@d</code> is <code class="language-plaintext highlighter-rouge">@b</code>’s immediate dominator, then if <code class="language-plaintext highlighter-rouge">@a &lt; @d</code>, <code class="language-plaintext highlighter-rouge">@b</code> is not in its frontier, because <code class="language-plaintext highlighter-rouge">@a</code> must dominate <code class="language-plaintext highlighter-rouge">@b</code>. Otherwise, <code class="language-plaintext highlighter-rouge">@b</code> must be in <code class="language-plaintext highlighter-rouge">@a</code>’s frontier, because <code class="language-plaintext highlighter-rouge">@a</code> dominates a pred but it cannot dominate <code class="language-plaintext highlighter-rouge">@b</code>, because then it would be dominated by <code class="language-plaintext highlighter-rouge">@i</code>, a contradiction.</p> <p>Second, we check that every frontier is complete. Consider a block <code class="language-plaintext highlighter-rouge">@a</code>. If an examined block <code class="language-plaintext highlighter-rouge">@b</code> is in its frontier, then <code class="language-plaintext highlighter-rouge">@a</code> must be among the dominators of some pred <code class="language-plaintext highlighter-rouge">@p</code>, and it must be dominated by <code class="language-plaintext highlighter-rouge">@b</code>’s immediate dominator; otherwise, <code class="language-plaintext highlighter-rouge">@a</code> would dominate <code class="language-plaintext highlighter-rouge">@b</code> (and thus <code class="language-plaintext highlighter-rouge">@b</code> would not be in its frontier). Thus, <code class="language-plaintext highlighter-rouge">@b</code> gets added to <code class="language-plaintext highlighter-rouge">@a</code>’s dominator.</p> </blockquote> </blockquote> <p>You might notice that all of these algorithms are quadratic. This is actually a very good time complexity for a compilers-related graph algorithm. Cubic and quartic algorithms are not especially uncommon, and yes, your optimizing compiler’s time complexity is probably cubic or quartic in the size of the program!</p> <h2 id="lifting-memory"><a href="#lifting-memory">Lifting Memory</a></h2> <p>Ok. Let’s construct an optimization. We want to figure out if we can replace a load from a pointer with the most recent store to that pointer. This will allow us to fully lift values out of memory by cancelling out store/load pairs.</p> <p>This will make use of yet another implicit graph data structure.</p> <blockquote id="def:5" class="def"> <p><a href="#def:5"><span class="chip">definition</span></a></p> <p>The <strong>dataflow graph</strong> is the directed graph made up of the internal circuit graphs of each each basic block, connected along block arguments.</p> <p>To <strong>follow a use-def chain</strong> is to walk this graph forward from an operation to discover operations that potentially depend on it, or backwards to find operations it potentially depends on.</p> </blockquote> <p>It’s important to remember that the dataflow graph, like the CFG, does <em>not</em> have a well defined “up” direction. Navigating it and the CFG requires the dominator tree.</p> <p>One other important thing to remember here is that every instruction in a basic block always executes if the block executes. In much of this analysis, we need to appeal to “program order” to select the last load in a block, but we are always able to do so. This is an important property of basic blocks that makes them essential for constructing optimizations.</p> <h3 id="forward-dataflow"><a href="#forward-dataflow">Forward Dataflow</a></h3> <p>For a given <code class="language-plaintext highlighter-rouge">store %p, %v</code>, we want to identify all loads that depend on it. We can follow the use-def chain of <code class="language-plaintext highlighter-rouge">%p</code> to find which blocks contain loads that potentially depend on the store (call it <code class="language-plaintext highlighter-rouge">%s</code>).</p> <p>First, we can eliminate loads within the same basic block (call it <code class="language-plaintext highlighter-rouge">@a</code>). Replace all <code class="language-plaintext highlighter-rouge">load %p</code> instructions after <code class="language-plaintext highlighter-rouge">s</code> (but before any other <code class="language-plaintext highlighter-rouge">store %p, _</code>s, in program order) with <code class="language-plaintext highlighter-rouge">%v</code>’s def. If <code class="language-plaintext highlighter-rouge">s</code> is not the last store in this block, we’re done.</p> <p>Otherwise, follow the use-def chain of <code class="language-plaintext highlighter-rouge">%p</code> to successors which use <code class="language-plaintext highlighter-rouge">%p</code>, i.e., successors whose <code class="language-plaintext highlighter-rouge">goto</code> case has <code class="language-plaintext highlighter-rouge">%p</code> as at least one argument. Recurse into those successors, and now replacing the pointer <code class="language-plaintext highlighter-rouge">%p</code> of interest with the parameters of the successor which were set to <code class="language-plaintext highlighter-rouge">%p</code> (more than one argument may be <code class="language-plaintext highlighter-rouge">%p</code>).</p> <p>If successor <code class="language-plaintext highlighter-rouge">@b</code> loads from one of the registers holding <code class="language-plaintext highlighter-rouge">%p</code>, replace all such loads before a store to <code class="language-plaintext highlighter-rouge">%p</code>. We also now need to send <code class="language-plaintext highlighter-rouge">%v</code> into <code class="language-plaintext highlighter-rouge">@b</code> somehow.</p> <p>This is where we run into something of a wrinkle. If <code class="language-plaintext highlighter-rouge">@b</code> has exactly one predecessor, we need to add a new block argument to pass whichever register is holding <code class="language-plaintext highlighter-rouge">%v</code> (which exists by induction). If <code class="language-plaintext highlighter-rouge">%v</code> is already passed into <code class="language-plaintext highlighter-rouge">@b</code> by another argument, we can use that one.</p> <p>However, if <code class="language-plaintext highlighter-rouge">@b</code> has multiple predecessors, we need to make sure that every path from <code class="language-plaintext highlighter-rouge">@a</code> to <code class="language-plaintext highlighter-rouge">@b</code> sends <code class="language-plaintext highlighter-rouge">%v</code>, and canonicalizing those will be tricky. Worse still, if <code class="language-plaintext highlighter-rouge">@b</code> is in <code class="language-plaintext highlighter-rouge">@a</code>’s domination frontier, a <em>different</em> store could be contributing to that load! For this reason, dataflow from stores to loads is not a great strategy.</p> <p>Instead, we’ll look at dataflow from loads backwards to stores (in general, dataflow from uses to defs tends to be more useful), which we can use to augment the above forward dataflow analysis to remove the complex issues around domination frontiers.</p> <h3 id="dependency-analysis"><a href="#dependency-analysis">Dependency Analysis</a></h3> <p>Let’s analyze loads instead. For each <code class="language-plaintext highlighter-rouge">load %p</code> in <code class="language-plaintext highlighter-rouge">@a</code>, we want to determine all stores that could potentially contribute to its value. We can find those stores as follows:</p> <p>We want to be able to determine which register in a given block corresponds to the value of <code class="language-plaintext highlighter-rouge">%p</code>, and then find its last store in that block.</p> <p>To do this, we’ll flood-fill the CFG backwards in BFS order. This means that we’ll follow preds (through the use-def chain) recursively, visiting each pred before visiting their preds, and never revisiting a basic block (except we may need to come back to <code class="language-plaintext highlighter-rouge">@a</code> at the end).</p> <p>Determining the “equivalent”<sup id="fnref:equiv-reg" role="doc-noteref"><a href="#fn:equiv-reg" class="footnote" rel="footnote">12</a></sup> of <code class="language-plaintext highlighter-rouge">%p</code> in <code class="language-plaintext highlighter-rouge">@b</code> (we’ll call it <code class="language-plaintext highlighter-rouge">%p.b</code>) can be done recursively: while examining <code class="language-plaintext highlighter-rouge">@b</code>, follow the def of <code class="language-plaintext highlighter-rouge">%p.b</code>. If <code class="language-plaintext highlighter-rouge">%p.b</code> is a block parameter, for each pred <code class="language-plaintext highlighter-rouge">@c</code>, set <code class="language-plaintext highlighter-rouge">%p.c</code> to the corresponding argument in the <code class="language-plaintext highlighter-rouge">@b(...)</code> case in <code class="language-plaintext highlighter-rouge">@c</code>’s <code class="language-plaintext highlighter-rouge">goto</code>.</p> <p>Using this information, we can collect all stores that the load potentially depends on. If a predecessor <code class="language-plaintext highlighter-rouge">@b</code> stores to <code class="language-plaintext highlighter-rouge">%p.b</code>, we add the last such store in <code class="language-plaintext highlighter-rouge">@b</code> (in program order) to our set of stores, and do not recurse to <code class="language-plaintext highlighter-rouge">@b</code>’s preds (because this store overwrites all past stores). Note that we <em>may</em> revisit <code class="language-plaintext highlighter-rouge">@a</code> in this process, and collect a store to <code class="language-plaintext highlighter-rouge">%p</code> from it occurs in the block. This is necessary in the case of loops.</p> <p>The result is a set <code class="language-plaintext highlighter-rouge">stores</code> of <code class="language-plaintext highlighter-rouge">(store %p.s %v.s, @s)</code> pairs. In the process, we also collected a set of all blocks visited, <code class="language-plaintext highlighter-rouge">subgraph</code>, which are dominators of <code class="language-plaintext highlighter-rouge">@a</code> which we need to plumb a <code class="language-plaintext highlighter-rouge">%v.b</code> through. This process is called <em>memory dependency analysis</em>, and is a key component of many optimizations.</p> <blockquote id="note:2" class="note"> <p><a href="#note:2"><span class="chip">note</span></a></p> <p>Not all contributing operations are stores. Some may be references to globals (which we’re disregarding), or function arguments or the results of a function call (which means we probably can’t lift this load). For example <code class="language-plaintext highlighter-rouge">%p</code> gets traced all the way back to a function argument, there is a code path which loads from a pointer whose stores we can’t see.</p> </blockquote> <p>It may also trace back to a stack slot that is potentially not stored to. This means there is a code path that can potentially load uninitialized memory. Like LLVM, we can assume this is not observable behavior, so we can discount such dependencies. If all of the dependencies are uninitialized loads, we can potentially delete not just the load, but operations which depend on it (reverse dataflow analysis is the origin of so-called “time-traveling” UB).</p> <h3 id="lifting-loads"><a href="#lifting-loads">Lifting Loads</a></h3> <p>Now that we have the full set of dependency information, we can start lifting loads. Loads can be safely lifted when all of their dependencies are stores in the current function, or dependencies we can disregard thanks to UB in the surface language (such as <code class="language-plaintext highlighter-rouge">null</code> loads or uninitialized loads).</p> <blockquote id="note:3" class="note"> <p><a href="#note:3"><span class="chip">note</span></a></p> <p>There is a lot of fuss in this algorithm about plumbing values through block arguments. A lot of IRs make a simplifying change, where every block implicitly receives the registers from its dominators as block arguments.</p> <p>I am keeping the fuss because it makes it clearer what’s going on, but in practice, most of this plumbing, except at dominance frontiers, would be happening in the background.</p> </blockquote> <p>Suppose we can safely lift some load. Now we need to plumb the stored values down to the load. For each block <code class="language-plaintext highlighter-rouge">@b</code> in <code class="language-plaintext highlighter-rouge">subgraph</code> (all other blocks will now be in <code class="language-plaintext highlighter-rouge">subgraph</code> unless stated otherwise). We will be building two mappings: one <code class="language-plaintext highlighter-rouge">(@s, @b) -&gt; %v.s.b</code>, which is the register equivalent to <code class="language-plaintext highlighter-rouge">%v.s</code> in that block. We will also be building a map <code class="language-plaintext highlighter-rouge">@b -&gt; %v.b</code>, which is the value that <code class="language-plaintext highlighter-rouge">%p</code> must have in that block.</p> <ol> <li> <p>Prepare a work queue, with each <code class="language-plaintext highlighter-rouge">@s</code> in it initially.</p> </li> <li> <p>Pop a block <code class="language-plaintext highlighter-rouge">@a</code> form the queue. For each successor <code class="language-plaintext highlighter-rouge">@b</code> (in <code class="language-plaintext highlighter-rouge">subgraph</code>):</p> <ol> <li> <p>If <code class="language-plaintext highlighter-rouge">%v.b</code> isn’t already defined, add it as a block argument. Have <code class="language-plaintext highlighter-rouge">@a</code> pass <code class="language-plaintext highlighter-rouge">%v.a</code> to that argument.</p> </li> <li> <p>If <code class="language-plaintext highlighter-rouge">@b</code> hasn’t been visited yet, and isn’t the block containing the load we’re deleting, add it to the queue.</p> </li> </ol> </li> </ol> <p>Once we’re done, if <code class="language-plaintext highlighter-rouge">@a</code> is the block that contains the load, we can now replace all loads to <code class="language-plaintext highlighter-rouge">%p</code> before any stores to <code class="language-plaintext highlighter-rouge">%p</code> with <code class="language-plaintext highlighter-rouge">%v.a</code>.</p> <blockquote id="tip:1" class="tip"> <p><a href="#tip:1"><span class="chip">tip</span></a></p> <p>There are cases where this whole process can be skipped, by applying a “peephole” optimization. For example, stores followed by loads within the same basic block can be optimized away locally, leaving the heavy-weight analysis for cross-block store/load pairs.</p> </blockquote> <h3 id="worked-example"><a href="#worked-example">Worked Example</a></h3> <p>Here’s the result of doing dependency analysis on our Fibonacci function. Each load is annotated with the blocks and stores in <code class="language-plaintext highlighter-rouge">stores</code>.</p> <div class="codeblock" id="code:11"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="o">&amp;</span><span class="n">fib</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i32</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">np</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>
    <span class="o">%</span><span class="n">ap</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>
    <span class="o">%</span><span class="n">bp</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>

    <span class="n">store</span> <span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span>  <span class="c">// S1</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="m">0</span>   <span class="c">// S2</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="m">1</span>   <span class="c">// S3</span>

    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">)</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="o">:</span> <span class="n">ptr</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// @entry: S1</span>
    <span class="c">// @loop.body: S6</span>
    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">np</span>  <span class="c">// L1</span>
    <span class="o">%</span><span class="n">cont</span> <span class="o">=</span> <span class="n">cmp</span><span class="o">.</span><span class="n">gt</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span>

    <span class="k">goto</span> <span class="o">%</span><span class="n">cont</span> <span class="p">{</span>
      <span class="m">0</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">exit</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="p">)</span>
      <span class="m">1</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">),</span>
    <span class="p">}</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="o">:</span> <span class="n">ptr</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// @entry: S1</span>
    <span class="c">// @loop.body: S4</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">ap</span>  <span class="c">// L2</span>
    <span class="c">// @entry: S2</span>
    <span class="c">// @loop.body: S5</span>
    <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">bp</span>  <span class="c">// L3</span>
    <span class="o">%</span><span class="n">c</span> <span class="o">=</span> <span class="n">add</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span> <span class="c">// S4</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span> <span class="c">// S5</span>

    <span class="c">// @entry: S1</span>
    <span class="c">// @loop.body: S6</span>
    <span class="o">%</span><span class="n">n</span>   <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">np</span>  <span class="c">// L3</span>
    <span class="o">%</span><span class="n">n</span><span class="m">.2</span> <span class="o">=</span> <span class="n">sub</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">1</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="m">.2</span>  <span class="c">// S6</span>

    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">)</span>

  <span class="err">@</span><span class="n">exit</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="o">:</span> <span class="n">ptr</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// @entry: S2</span>
    <span class="c">// @loop.body: S5</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">load</span> <span class="o">%</span><span class="n">ap</span>  <span class="c">// L4</span>
    <span class="k">goto</span> <span class="err">@</span><span class="n">ret</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:11">SSA-CFG</a></div></div> <p>Let’s look at <code class="language-plaintext highlighter-rouge">L1</code>. Is contributing loads are in <code class="language-plaintext highlighter-rouge">@entry</code> and <code class="language-plaintext highlighter-rouge">@loop.body</code>. So we add a new parameter <code class="language-plaintext highlighter-rouge">%n</code>: in <code class="language-plaintext highlighter-rouge">@entry</code>, we call that parameter with <code class="language-plaintext highlighter-rouge">%n</code> (since that’s stored to it in <code class="language-plaintext highlighter-rouge">@entry</code>), while in <code class="language-plaintext highlighter-rouge">@loop.body</code>, we pass <code class="language-plaintext highlighter-rouge">%n.2</code>.</p> <p>What about L4? The contributing loads are also in <code class="language-plaintext highlighter-rouge">@entry</code> and <code class="language-plaintext highlighter-rouge">@loop.body</code>, but one of those isn’t a pred of <code class="language-plaintext highlighter-rouge">@exit</code>. <code class="language-plaintext highlighter-rouge">@loop.start</code> is also in the subgraph for this load, though. So, starting from <code class="language-plaintext highlighter-rouge">@entry</code>, we add a new parameter <code class="language-plaintext highlighter-rouge">%a</code> to <code class="language-plaintext highlighter-rouge">@loop.body</code> and feed <code class="language-plaintext highlighter-rouge">0</code> (the stored value, an immediate this time) through it. Now looking at <code class="language-plaintext highlighter-rouge">@loop.body</code>, we see there is already a parameter for this load (<code class="language-plaintext highlighter-rouge">%a</code>), so we just pass <code class="language-plaintext highlighter-rouge">%b</code> as that argument. Now we process <code class="language-plaintext highlighter-rouge">@loop.start</code>, which <code class="language-plaintext highlighter-rouge">@entry</code> pushed onto the queue. <code class="language-plaintext highlighter-rouge">@exit</code> gets a new parameter <code class="language-plaintext highlighter-rouge">%a</code>, which is fed <code class="language-plaintext highlighter-rouge">@loop.start</code>’s own <code class="language-plaintext highlighter-rouge">%a</code>. We do not re-process <code class="language-plaintext highlighter-rouge">@loop.body</code>, even though it also appears in <code class="language-plaintext highlighter-rouge">@loop.start</code>’s gotos, because we already visited it.</p> <p>After doing this for the other two loads, we get this:</p> <div class="codeblock" id="code:12"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="o">&amp;</span><span class="n">fib</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i32</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">np</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>
    <span class="o">%</span><span class="n">ap</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>
    <span class="o">%</span><span class="n">bp</span> <span class="o">=</span> <span class="n">stack</span> <span class="n">i32</span>

    <span class="n">store</span> <span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span>  <span class="c">// S1</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="m">0</span>   <span class="c">// S2</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="m">1</span>   <span class="c">// S3</span>

    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="o">:</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// @entry: S1</span>
    <span class="c">// @loop.body: S6</span>
    <span class="c">// %n = load %np  // L1</span>
    <span class="o">%</span><span class="n">cont</span> <span class="o">=</span> <span class="n">cmp</span><span class="o">.</span><span class="n">gt</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span>

    <span class="k">goto</span> <span class="o">%</span><span class="n">cont</span> <span class="p">{</span>
      <span class="m">0</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">exit</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">)</span>
      <span class="m">1</span> <span class="o">-&gt;</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">),</span>
    <span class="p">}</span>

  <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="o">:</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// @entry: S1</span>
    <span class="c">// @loop.body: S4</span>
    <span class="c">// %a = load %ap  // L2</span>
    <span class="c">// @entry: S2</span>
    <span class="c">// @loop.body: S5</span>
    <span class="c">// %b = load %bp  // L3</span>
    <span class="o">%</span><span class="n">c</span> <span class="o">=</span> <span class="n">add</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span> <span class="c">// S4</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span> <span class="c">// S5</span>

    <span class="c">// @entry: S1</span>
    <span class="c">// @loop.body: S6</span>
    <span class="c">// %n   = load %np  // L3</span>
    <span class="o">%</span><span class="n">n</span><span class="m">.2</span> <span class="o">=</span> <span class="n">sub</span> <span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="m">1</span>
    <span class="n">store</span> <span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="m">.2</span>  <span class="c">// S6</span>

    <span class="k">goto</span> <span class="err">@</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">%</span><span class="n">np</span><span class="p">,</span> <span class="o">%</span><span class="n">ap</span><span class="p">,</span> <span class="o">%</span><span class="n">bp</span><span class="p">,</span> <span class="o">%</span><span class="n">n</span><span class="m">.2</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span><span class="p">)</span>

  <span class="err">@</span><span class="n">exit</span><span class="p">(</span><span class="o">%</span><span class="n">ap</span><span class="o">:</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span><span class="o">:</span>
    <span class="c">// @entry: S2</span>
    <span class="c">// @loop.body: S5</span>
    <span class="c">// %a = load %ap  // L4</span>
    <span class="k">goto</span> <span class="err">@</span><span class="n">ret</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:12">SSA-CFG</a></div></div> <p>After lifting, if we know that a stack slot’s pointer does not escape (i.e., none of its uses wind up going into a function call<sup id="fnref:calls-only" role="doc-noteref"><a href="#fn:calls-only" class="footnote" rel="footnote">13</a></sup>) or a write to a global (or a pointer that escapes), we can delete every store to that pointer. If we delete every store to a stack slot, we can delete the stack slot altogether (there should be no loads left for that stack slot at this point).</p> <h3 id="complications"><a href="#complications">Complications</a></h3> <p>This analysis is simple, because it assumes pointers do not alias in general. Alias analysis is necessary for more accurate dependency analysis. This is necessary, for example, for lifting loads of fields of structs through subobject pointers, and dealing with pointer arithmetic in general.</p> <p>However, our dependency analysis <em>is</em> robust to passing different pointers as arguments to the same block from different predecessors. This is the case that is specifically handled by all of the fussing about with dominance frontiers. This robustness ultimately comes from SSA’s circuital nature.</p> <p>Similarly, this analysis needs to be tweaked to deal with something like <code class="language-plaintext highlighter-rouge">select %cond, %a, %b</code> (a ternary, essentially). <code class="language-plaintext highlighter-rouge">select</code>s of pointers need to be replaced with <code class="language-plaintext highlighter-rouge">select</code>s of the loaded values, which means we need to do the lifting transformation “all at once”: lifting some liftable loads will leave the IR in an inconsistent state, until all of them have been lifted.</p> <h2 id="cleanup-passes"><a href="#cleanup-passes">Cleanup Passes</a></h2> <p>Many optimizations will make a mess of the CFG, so it’s useful to have simple passes that “clean up” the mess left by transformations. Here’s some easy examples.</p> <h3 id="unused-result-elimination"><a href="#unused-result-elimination">Unused Result Elimination</a></h3> <p>If an operation’s result has zero uses, and the operation has no side-effects, it can be deleted. This allows us to then delete operations that it depended on that now have no side effects. Doing this is very simple, due to the circuital nature of SSA: collect all instructions whose outputs have zero uses, and delete them. Then, examine the defs of their operands; if those operations now have no uses, delete them, and recurse.</p> <p>This bubbles up all the way to block arguments. Deleting block arguments is a bit trickier, but we can use a work queue to do it. Put all of the blocks into a work queue.</p> <ol> <li> <p>Pop a block from the queue.</p> </li> <li> <p>Run unused result elimination on its operations.</p> </li> <li> <p>If it now has parameters with no uses, remove those parameters.</p> </li> <li> <p>For each pred, delete the corresponding arguments to this block. Then, Place those preds into the work queue (since some of their operations may have lost their last use).</p> </li> <li> <p>If there is still work left, go to 1.</p> </li> </ol> <h3 id="simplifying-the-cfg"><a href="#simplifying-the-cfg">Simplifying the CFG</a></h3> <p>There are many CFG configurations that are redundant and can be simplified to reduce the number of basic blocks.</p> <p>For example, unreachable code can help delete blocks. Other optimizations may cause the <code class="language-plaintext highlighter-rouge">goto</code> at the end of a function to be empty (because all of its successors were optimized away). We treat an empty <code class="language-plaintext highlighter-rouge">goto</code> as being unreachable (since it has no cases!), so we can delete every operation in the block up to the last non-pure operation. If we delete every instruction in the block, we can delete the block entirely, and delete it from its preds’ <code class="language-plaintext highlighter-rouge">goto</code>s. This is a form of <em>dead code elimination</em>, or DCE, which combines with the previous optimization to aggressively delete redundant code.</p> <p>Some jumps are redundant. For example, if a block has exactly one pred and one successor, the pred’s <code class="language-plaintext highlighter-rouge">goto</code> case for that block can be wired directly to the successor. Similarly, if two blocks are each other’s unique predecessor/successor, they can be <em>fused</em>, creating a single block by connecting the input blocks’ circuits directly, instead of through a <code class="language-plaintext highlighter-rouge">goto</code>.</p> <p>If we have a ternary <code class="language-plaintext highlighter-rouge">select</code> operation, we can do more sophisticated fusion. If a block has two successors, both of which the same unique successor, and those successors consist only of gotos, we can fuse all four blocks, replacing the CFG diamond with a <code class="language-plaintext highlighter-rouge">select</code>. In terms of C, this is this transformation:</p> <div class="code-multicol"> <div class="codeblock" id="code:13"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Before.</span>
<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:13">C</a></div></div> <div class="codeblock" id="code:14"><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// After.</span>
<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cond</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:14">C</a></div></div> </div> <p>LLVM’s CFG simplification pass is very sophisticated and can eliminate complex forms of control flow.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>I am hoping to write more about SSA optimization passes. This is a very rich subject, and viewing optimizations in isolation is a great way to understand how a sophisticated optimization pipeline is built out of simple, dumb components.</p> <p>It’s also a practical application of graph theory that shows just how powerful it can be, and (at least in my opinion), is an intuitive setting for understanding graph theory, which can feel very abstract otherwise.</p> <p>In the future, I’d like to cover CSE/GVN, loop optimizations, and, if I’m feeling brave, getting out of SSA into a finite-register machine (backends are not my strong suit!).</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:swift" role="doc-endnote"> <p>Specifically the Swift frontend before lowering into LLVM IR. <a href="#fnref:swift" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:msvc" role="doc-endnote"> <p>Microsoft Visual C++, a non-conforming C++ compiler sold by Microsoft <a href="#fnref:msvc" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:hotspot" role="doc-endnote"> <p>HotSpot is the JVM implementation provided by OpenJDK; C2 is the “second compiler”, which has the best performance among HotSpot’s Java execution engines. <a href="#fnref:hotspot" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:v8" role="doc-endnote"> <p>V8 is Chromium’s JavaScript runtime. <a href="#fnref:v8" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:spidermonkey" role="doc-endnote"> <p>SpiderMonkey is Firefox’s JavaScript runtime. <a href="#fnref:spidermonkey" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:art" role="doc-endnote"> <p>The Android Runtime (ART) is the “JVM” (scare quotes) on the Android platform. <a href="#fnref:art" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ghc" role="doc-endnote"> <p>The Glasgow Haskell Compiler (GHC), does <em>not</em> use SSA; it (like some other pure-functional languages) uses a continuation-oriented IR (compare to Scheme’s <code class="language-plaintext highlighter-rouge">call/cc</code>). <a href="#fnref:ghc" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:p-np" role="doc-endnote"> <p>Every compiler person firmly believes that <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo mathvariant="normal">≠</mo><mi>N</mi><mi>P</mi></mrow><annotation encoding="application/x-tex">P \neq NP</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">NP</span></span></span></span></span>, because program optimization is full of NP-hard problems and we would have definitely found polynomial ideal register allocation by now if it existed. <a href="#fnref:p-np" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:non-cfg" role="doc-endnote"> <p>Some more recent IRs use a different version of SSA called “structured control flow”, or SCF. Wasm is a notable example of an SCF IR. SSA-SCF is equivalent to SSA-CFG, and polynomial time algorithms exist for losslessly converting between them (LLVM compiling Wasm, for example, converts its CFG into SCF using a “relooping algorithm”).</p> <p>In SCF, operations like switch statements and loops are represented as macro operations that <em>contain</em> basic blocks. For example, a <code class="language-plaintext highlighter-rouge">switch</code> operation might take a value as input, select a basic block to execute based on that, and return the value that basic block evaluates to as its output.</p> <p><a href="https://arxiv.org/abs/1912.05036">RVSDG</a> is a notable innovation in this space, because it allows circuit analysis of entire imperative programs.</p> <p>I am convering SSA-CFG instead of SSA-SCF simply because it’s more common, and because it’s what LLVM IR is.</p> <p>See also this <a href="https://llvm.org/devmtg/2024-04/slides/TechnicalTalks/Bock-LiftingCFGs.pdf">MLIR presentation</a> for converting between the two. <a href="#fnref:non-cfg" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:tail-call" role="doc-endnote"> <p>Tail calling is when a function call is the last operation in a function; this allows the caller to jump directly to the callee, recycling its own stack frame for it instead of requiring it to allocate its own. <a href="#fnref:tail-call" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:acyclic" role="doc-endnote"> <p>Given any path from <code class="language-plaintext highlighter-rouge">@a</code> to <code class="language-plaintext highlighter-rouge">@b</code>, we can make it acyclic by replacing each subpath from <code class="language-plaintext highlighter-rouge">@c</code> to <code class="language-plaintext highlighter-rouge">@c</code> with a single <code class="language-plaintext highlighter-rouge">@c</code> node. <a href="#fnref:acyclic" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:equiv-reg" role="doc-endnote"> <p>When moving from a basic block to a pred, a register in that block which is defined as a block parameter corresponds to some register (or immediate) in each predecessor. That is the “equivalent” of <code class="language-plaintext highlighter-rouge">%p</code>.</p> <p>One possible option for the “equivalent” is an immediate: for example, <code class="language-plaintext highlighter-rouge">null</code> or the address of a global. In the case of a global <code class="language-plaintext highlighter-rouge">&amp;g</code>, assuming no data races, we would instead need alias information to tell if stores to this global within the current function (a) exist and (b) are liftable at all.</p> <p>If the equivalent is <code class="language-plaintext highlighter-rouge">null</code>, we can proceed in one of two ways depending on optimization level. If we want loads of <code class="language-plaintext highlighter-rouge">null</code> to trap (as in Go), we need to mark this load as not being liftable, because it may trap. If we want loads of <code class="language-plaintext highlighter-rouge">null</code> to be UB, we simply ignore that pred, because we can assume (for our analysis) that if the pointer is <code class="language-plaintext highlighter-rouge">null</code>, it is never loaded from. <a href="#fnref:equiv-reg" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:calls-only" role="doc-endnote"> <p>Returned stack pointers do <em>not</em> escape: stack slots’ lifetimes end at function exit, so we return a dangling pointer, which we assume are never loaded. So stores to that pointer before returning it can be discarded. <a href="#fnref:calls-only" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-10-30</span> / <h6 style="display:inline"><a href="/2025/10/30/living-room-2/">Living Room 2</a></h6> <li> <span class="post-meta">2025-10-28</span> / <h6 style="display:inline"><a href="/2025/10/28/boombox-boobs/">Boombox Boobs</a></h6> <li> <span class="post-meta">2025-10-27</span> / <h6 style="display:inline"><a href="/2025/10/27/living-room/">Living Room</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-10-21</span> <span class="censored">•</span> <span class="censored">5756</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">63</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#optimization"><span class="censored">#optimization</span></a> <span class="censored">•</span> <a href="https://mcyoung.xyz/tags.html#toolchains"><span class="censored">#toolchains</span></a> </span> <h1><a href="/2025/10/21/ssa-1/"> <span class="censored">Why</span> <span class="censored">SSA?</span> </a></h1> </div> <div class="post"> <p><span class="censored">If</span> <span class="censored">you’ve</span> <span class="censored">read</span> <span class="censored">anything</span> <span class="censored">about</span> <span class="censored">compilers</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">two</span> <span class="censored">decades</span> <span class="censored">or</span> <span class="censored">so,</span> <span class="censored">you</span> <span class="censored">have</span> <span class="censored">almost</span> <span class="censored">certainly</span> <span class="censored">heard</span> <span class="censored">of</span> <em><span class="censored">SSA</span> <span class="censored">compilers</span></em><span class="censored">,</span> <span class="censored">a</span> <span class="censored">popular</span> <span class="censored">architecture</span> <span class="censored">featured</span> <span class="censored">in</span> <span class="censored">many</span> <span class="censored">optimizing</span> <span class="censored">compilers,</span> <span class="censored">including</span> <span class="censored">ahead-of-time</span> <span class="censored">compilers</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">LLVM,</span> <span class="censored">GCC,</span> <span class="censored">Go,</span> <span class="censored">CUDA</span> <span class="censored">(and</span> <span class="censored">various</span> <span class="censored">shader</span> <span class="censored">compilers),</span> <span class="censored">Swift</span><sup id="fnref:swift" role="doc-noteref"><a href="#fn:swift" class="footnote" rel="footnote"><span class="censored">1</span></a></sup><span class="censored">,</span> <span class="censored">and</span> <span class="censored">MSVC</span><sup id="fnref:msvc" role="doc-noteref"><a href="#fn:msvc" class="footnote" rel="footnote"><span class="censored">2</span></a></sup><span class="censored">,</span> <span class="censored">and</span> <span class="censored">just-in-time</span> <span class="censored">compilers</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">HotSpot</span> <span class="censored">C2</span><sup id="fnref:hotspot" role="doc-noteref"><a href="#fn:hotspot" class="footnote" rel="footnote"><span class="censored">3</span></a></sup><span class="censored">,</span> <span class="censored">V8</span><sup id="fnref:v8" role="doc-noteref"><a href="#fn:v8" class="footnote" rel="footnote"><span class="censored">4</span></a></sup><span class="censored">,</span> <span class="censored">SpiderMonkey</span><sup id="fnref:spidermonkey" role="doc-noteref"><a href="#fn:spidermonkey" class="footnote" rel="footnote"><span class="censored">5</span></a></sup><span class="censored">,</span> <span class="censored">LuaJIT,</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">Android</span> <span class="censored">Runtime</span><sup id="fnref:art" role="doc-noteref"><a href="#fn:art" class="footnote" rel="footnote"><span class="censored">6</span></a></sup><span class="censored">.</span></p> <p><span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">hugely</span> <span class="censored">popular,</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">point</span> <span class="censored">that</span> <span class="censored">most</span> <span class="censored">compiler</span> <span class="censored">projects</span> <span class="censored">no</span> <span class="censored">longer</span> <span class="censored">bother</span> <span class="censored">with</span> <span class="censored">other</span> <span class="censored">IRs</span> <span class="censored">for</span> <span class="censored">optimization</span><sup id="fnref:ghc" role="doc-noteref"><a href="#fn:ghc" class="footnote" rel="footnote"><span class="censored">7</span></a></sup><span class="censored">.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">because</span> <span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">incredibly</span> <span class="censored">nimble</span> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">types</span> <span class="censored">of</span> <span class="censored">program</span> <span class="censored">analysis</span> <span class="censored">and</span> <span class="censored">transformation</span> <span class="censored">that</span> <span class="censored">compiler</span> <span class="censored">optimizations</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">on</span> <span class="censored">your</span> <span class="censored">code.</span> <span class="censored">But</span> <em><span class="censored">why</span></em><span class="censored">?</span> <span class="censored">Many</span> <span class="censored">of</span> <span class="censored">my</span> <span class="censored">friends</span> <span class="censored">who</span> <span class="censored">don’t</span> <span class="censored">do</span> <span class="censored">compilers</span> <span class="censored">often</span> <span class="censored">say</span> <span class="censored">that</span> <span class="censored">compilers</span> <span class="censored">seem</span> <span class="censored">like</span> <span class="censored">opaque</span> <span class="censored">magical</span> <span class="censored">black</span> <span class="censored">boxes,</span> <span class="censored">and</span> <span class="censored">SSA,</span> <span class="censored">as</span> <span class="censored">it</span> <span class="censored">often</span> <span class="censored">appears</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">literature,</span> <span class="censored">is</span> <span class="censored">impenetrably</span> <span class="censored">complex.</span></p> <p><span class="censored">But</span> <span class="censored">it’s</span> <span class="censored">not!</span> <span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">very</span> <span class="censored">simple</span> <span class="censored">once</span> <span class="censored">you</span> <span class="censored">forget</span> <span class="censored">everything</span> <span class="censored">you</span> <span class="censored">think</span> <span class="censored">your</span> <span class="censored">programs</span> <span class="censored">are</span> <span class="censored">actually</span> <span class="censored">doing.</span> <span class="censored">We</span> <span class="censored">will</span> <span class="censored">develop</span> <span class="censored">the</span> <span class="censored">concept</span> <span class="censored">of</span> <span class="censored">SSA</span> <span class="censored">form,</span> <span class="censored">a</span> <span class="censored">simple</span> <span class="censored">SSA</span> <span class="censored">IR,</span> <span class="censored">prove</span> <span class="censored">facts</span> <span class="censored">about</span> <span class="censored">it,</span> <span class="censored">and</span> <span class="censored">design</span> <span class="censored">some</span> <span class="censored">optimizations</span> <span class="censored">on</span> <span class="censored">it.</span></p> <blockquote id="note:1" class="note"> <p><a href="#note:1"><span class="chip"><span class="censored">note</span></span></a></p> <p><span class="censored">I</span> <span class="censored">have</span> <a href="https://mcyoung.xyz/2023/08/01/llvm-ir"><span class="censored">previously</span> <span class="censored">written</span></a> <span class="censored">about</span> <span class="censored">the</span> <span class="censored">granddaddy</span> <span class="censored">of</span> <span class="censored">all</span> <span class="censored">modern</span> <span class="censored">SSA</span> <span class="censored">compilers,</span> <span class="censored">LLVM.</span> <span class="censored">This</span> <span class="censored">article</span> <span class="censored">is</span> <span class="censored">about</span> <span class="censored">SSA</span> <span class="censored">in</span> <span class="censored">general,</span> <span class="censored">and</span> <span class="censored">won’t</span> <span class="censored">really</span> <span class="censored">have</span> <span class="censored">anything</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">with</span> <span class="censored">LLVM.</span> <span class="censored">However,</span> <span class="censored">it</span> <span class="censored">may</span> <span class="censored">be</span> <span class="censored">helpful</span> <span class="censored">to</span> <span class="censored">read</span> <span class="censored">that</span> <span class="censored">article</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">things</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">article</span> <span class="censored">feel</span> <span class="censored">more</span> <span class="censored">concrete.</span></p> </blockquote> <h2 id="what-is-ssa"><a href="#what-is-ssa"><span class="censored">What</span> <span class="censored">Is</span> <span class="censored">SSA?</span></a></h2> <p><span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">property</span> <span class="censored">of</span> <em><span class="censored">intermediate</span> <span class="censored">representations</span></em> <span class="censored">(IRs),</span> <span class="censored">primarily</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">compilers</span> <span class="censored">for</span> <span class="censored">optimizing</span> <span class="censored">imperative</span> <span class="censored">code</span> <span class="censored">that</span> <span class="censored">target</span> <span class="censored">a</span> <em><span class="censored">register</span> <span class="censored">machine</span></em><span class="censored">.</span> <span class="censored">Register</span> <span class="censored">machines</span> <span class="censored">are</span> <span class="censored">computers</span> <span class="censored">that</span> <span class="censored">feature</span> <span class="censored">a</span> <span class="censored">fixed</span> <span class="censored">set</span> <span class="censored">of</span> <em><span class="censored">registers</span></em> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">operands</span> <span class="censored">for</span> <span class="censored">instructions:</span> <span class="censored">this</span> <span class="censored">includes</span> <span class="censored">virtually</span> <span class="censored">all</span> <span class="censored">physical</span> <span class="censored">processors,</span> <span class="censored">including</span> <span class="censored">CPUs,</span> <span class="censored">GPUs,</span> <span class="censored">and</span> <span class="censored">weird</span> <span class="censored">tings</span> <span class="censored">like</span> <span class="censored">DSPs.</span></p> <p><span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">most</span> <span class="censored">frequently</span> <span class="censored">found</span> <span class="censored">in</span> <span class="censored">compiler</span> <em><span class="censored">middle-ends</span></em><span class="censored">,</span> <span class="censored">the</span> <span class="censored">optimizing</span> <span class="censored">component</span> <span class="censored">between</span> <span class="censored">the</span> <em><span class="censored">frontend</span></em> <span class="censored">(which</span> <span class="censored">deals</span> <span class="censored">with</span> <span class="censored">the</span> <em><span class="censored">surface</span> <span class="censored">language</span></em> <span class="censored">programmers</span> <span class="censored">write,</span> <span class="censored">and</span> <span class="censored">lowers</span> <span class="censored">it</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">middle-end’s</span> <span class="censored">IR),</span> <span class="censored">and</span> <span class="censored">the</span> <em><span class="censored">backend</span></em> <span class="censored">(which</span> <span class="censored">takes</span> <span class="censored">the</span> <span class="censored">optimized</span> <span class="censored">IR</span> <span class="censored">and</span> <span class="censored">lowers</span> <span class="censored">it</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">target</span> <span class="censored">platform’s</span> <span class="censored">assembly).</span></p> <p><span class="censored">SSA</span> <span class="censored">IRs,</span> <span class="censored">however,</span> <span class="censored">often</span> <span class="censored">have</span> <span class="censored">little</span> <span class="censored">resemblance</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">surface</span> <span class="censored">language</span> <span class="censored">they</span> <span class="censored">lower</span> <span class="censored">out</span> <span class="censored">of,</span> <span class="censored">or</span> <span class="censored">the</span> <span class="censored">assembly</span> <span class="censored">language</span> <span class="censored">they</span> <span class="censored">target.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">because</span> <span class="censored">neither</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">representations</span> <span class="censored">make</span> <span class="censored">it</span> <span class="censored">easy</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">compiler</span> <span class="censored">to</span> <span class="censored">intuit</span> <span class="censored">optimization</span> <span class="censored">opportunities.</span></p> <h3 id="imperative-code-is-hard"><a href="#imperative-code-is-hard"><span class="censored">Imperative</span> <span class="censored">Code</span> <span class="censored">Is</span> <span class="censored">Hard</span></a></h3> <p><span class="censored">Imperative</span> <span class="censored">code</span> <span class="censored">consists</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">sequence</span> <span class="censored">of</span> <span class="censored">operations</span> <span class="censored">that</span> <span class="censored">mutate</span> <span class="censored">the</span> <span class="censored">executing</span> <span class="censored">machine’s</span> <span class="censored">state</span> <span class="censored">to</span> <span class="censored">produce</span> <span class="censored">a</span> <span class="censored">desired</span> <span class="censored">result.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">C</span> <span class="censored">program:</span></p> <div class="codeblock" id="code:1"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">main</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">,</span></span> <span class="kt"><span class="censored">char</span></span><span class="o"><span class="censored">**</span></span> <span class="n"><span class="censored">argv</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">+=</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">-=</span></span> <span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:1"><span class="censored">C</span></a></div> </div> <p><span class="censored">This</span> <span class="censored">program</span> <span class="censored">returns</span> <code class="language-plaintext highlighter-rouge"><span class="censored">0</span></code> <span class="censored">no</span> <span class="censored">matter</span> <span class="censored">what</span> <span class="censored">its</span> <span class="censored">input</span> <span class="censored">is,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">optimize</span> <span class="censored">it</span> <span class="censored">down</span> <span class="censored">to</span> <span class="censored">this:</span></p> <div class="codeblock" id="code:2"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">main</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">,</span></span> <span class="kt"><span class="censored">char</span></span><span class="o"><span class="censored">**</span></span> <span class="n"><span class="censored">argv</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:2"><span class="censored">C</span></a></div> </div> <p><span class="censored">But,</span> <span class="censored">how</span> <span class="censored">would</span> <span class="censored">you</span> <span class="censored">write</span> <span class="censored">a</span> <span class="censored">general</span> <span class="censored">algorithm</span> <span class="censored">to</span> <span class="censored">detect</span> <span class="censored">that</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">operations</span> <span class="censored">cancel</span> <span class="censored">out?</span> <span class="censored">You’re</span> <span class="censored">forced</span> <span class="censored">to</span> <span class="censored">keep</span> <span class="censored">in</span> <span class="censored">mind</span> <em><span class="censored">program</span> <span class="censored">order</span></em> <span class="censored">to</span> <span class="censored">perform</span> <span class="censored">the</span> <span class="censored">necessary</span> <span class="censored">dataflow</span> <span class="censored">analysis,</span> <span class="censored">following</span> <span class="censored">mutations</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b</span></code> <span class="censored">through</span> <span class="censored">the</span> <span class="censored">program.</span> <span class="censored">But</span> <span class="censored">this</span> <span class="censored">isn’t</span> <span class="censored">very</span> <span class="censored">general,</span> <span class="censored">and</span> <span class="censored">traversing</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">those</span> <span class="censored">paths</span> <span class="censored">makes</span> <span class="censored">the</span> <span class="censored">search</span> <span class="censored">space</span> <span class="censored">for</span> <span class="censored">large</span> <span class="censored">functions</span> <span class="censored">very</span> <span class="censored">big.</span> <span class="censored">Instead,</span> <span class="censored">you</span> <span class="censored">would</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">rewrite</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">such</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b</span></code> <span class="censored">gradually</span> <span class="censored">get</span> <span class="censored">replaced</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">expression</span> <span class="censored">that</span> <span class="censored">calculates</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">recent</span> <span class="censored">value,</span> <span class="censored">like</span> <span class="censored">this:</span></p> <div class="codeblock" id="code:3"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">main</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">,</span></span> <span class="kt"><span class="censored">char</span></span><span class="o"><span class="censored">**</span></span> <span class="n"><span class="censored">argv</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a3</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">a2</span></span> <span class="o"><span class="censored">-</span></span> <span class="n"><span class="censored">b2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">a3</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:3"><span class="censored">C</span></a></div> </div> <p><span class="censored">Then</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">replace</span> <span class="censored">each</span> <span class="censored">occurrence</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">variable</span> <span class="censored">with</span> <span class="censored">its</span> <span class="censored">right-hand</span> <span class="censored">side</span> <span class="censored">recursively…</span></p> <div class="codeblock" id="code:4"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">main</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">,</span></span> <span class="kt"><span class="censored">char</span></span><span class="o"><span class="censored">**</span></span> <span class="n"><span class="censored">argv</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a3</span></span> <span class="o"><span class="censored">=</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">)</span></span> <span class="o"><span class="censored">-</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">);</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">)</span></span> <span class="o"><span class="censored">-</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">);</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:4"><span class="censored">C</span></a></div> </div> <p><span class="censored">Then</span> <span class="censored">fold</span> <span class="censored">the</span> <span class="censored">constants</span> <span class="censored">together…</span></p> <div class="codeblock" id="code:5"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">main</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">,</span></span> <span class="kt"><span class="censored">char</span></span><span class="o"><span class="censored">**</span></span> <span class="n"><span class="censored">argv</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">3</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">b2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">+</span></span> <span class="mi"><span class="censored">3</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a3</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">-</span></span> <span class="n"><span class="censored">argc</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">argc</span></span> <span class="o"><span class="censored">-</span></span> <span class="n"><span class="censored">argc</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:5"><span class="censored">C</span></a></div> </div> <p><span class="censored">And</span> <span class="censored">finally,</span> <span class="censored">we</span> <span class="censored">see</span> <span class="censored">that</span> <span class="censored">we’re</span> <span class="censored">returning</span> <code class="language-plaintext highlighter-rouge"><span class="censored">argc</span> <span class="censored">-</span> <span class="censored">argc</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">can</span> <span class="censored">replace</span> <span class="censored">it</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">0</span></code><span class="censored">.</span> <span class="censored">All</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">variables</span> <span class="censored">are</span> <span class="censored">now</span> <span class="censored">unused,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">delete</span> <span class="censored">them.</span></p> <p><span class="censored">The</span> <span class="censored">reason</span> <span class="censored">this</span> <span class="censored">works</span> <span class="censored">so</span> <span class="censored">well</span> <span class="censored">is</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">took</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">with</span> <span class="censored">mutation,</span> <span class="censored">and</span> <span class="censored">converted</span> <span class="censored">it</span> <span class="censored">into</span> <span class="censored">a</span> <em><span class="censored">combinatorial</span> <span class="censored">circuit</span></em><span class="censored">,</span> <span class="censored">a</span> <span class="censored">type</span> <span class="censored">of</span> <span class="censored">digital</span> <span class="censored">logic</span> <span class="censored">circuit</span> <span class="censored">that</span> <span class="censored">has</span> <span class="censored">no</span> <span class="censored">state,</span> <span class="censored">and</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">analyze.</span> <span class="censored">The</span> <span class="censored">dependencies</span> <span class="censored">between</span> <em><span class="censored">nodes</span></em> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">circuit</span> <span class="censored">(corresponding</span> <span class="censored">to</span> <span class="censored">primitive</span> <span class="censored">operations</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">addition</span> <span class="censored">or</span> <span class="censored">multiplication)</span> <span class="censored">are</span> <span class="censored">obvious</span> <span class="censored">from</span> <span class="censored">its</span> <span class="censored">structure.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">circuit</span> <span class="censored">diagram</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">one-bit</span> <span class="censored">multiplier:</span></p> <figure> <p><img src="https://mcyoung.xyz/public/images/multiplier.png" style="filter:invert(100%);"></p> <figcaption><span class="censored">A</span> <span class="censored">binary</span> <span class="censored">multiplier</span> <span class="censored">(Wikipedia)</span></figcaption> </figure> <p><span class="censored">This</span> <span class="censored">graph</span> <span class="censored">representation</span> <span class="censored">of</span> <span class="censored">an</span> <span class="censored">operation</span> <span class="censored">program</span> <span class="censored">has</span> <span class="censored">two</span> <span class="censored">huge</span> <span class="censored">benefits:</span></p> <ol> <li> <p><span class="censored">The</span> <span class="censored">powerful</span> <span class="censored">tools</span> <span class="censored">of</span> <span class="censored">graph</span> <span class="censored">theory</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">algorithmically</span> <span class="censored">analyze</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">and</span> <span class="censored">discover</span> <span class="censored">useful</span> <span class="censored">properties,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">operations</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">independent</span> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">other</span> <span class="censored">or</span> <span class="censored">whose</span> <span class="censored">results</span> <span class="censored">are</span> <span class="censored">never</span> <span class="censored">used.</span></p> </li> <li> <p><span class="censored">The</span> <span class="censored">operations</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">ordered</span> <span class="censored">with</span> <span class="censored">respect</span> <span class="censored">to</span> <span class="censored">each</span> <span class="censored">other</span> <span class="censored">except</span> <span class="censored">when</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">dependency;</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">useful</span> <span class="censored">for</span> <span class="censored">reordering</span> <span class="censored">operations,</span> <span class="censored">something</span> <span class="censored">compilers</span> <span class="censored">really</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">do.</span></p> </li> </ol> <p><span class="censored">The</span> <span class="censored">reason</span> <span class="censored">combinatorial</span> <span class="censored">circuits</span> <span class="censored">are</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">circuits</span> <span class="censored">is</span> <span class="censored">because</span> <span class="censored">they</span> <span class="censored">are</span> <em><span class="censored">directed</span> <span class="censored">acyclic</span> <span class="censored">graphs</span></em> <span class="censored">(DAGs)</span> <span class="censored">which</span> <span class="censored">admit</span> <span class="censored">really</span> <span class="censored">nice</span> <span class="censored">algorithms.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">longest</span> <span class="censored">path</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">graph</span> <span class="censored">is</span> <a href="https://en.wikipedia.org/wiki/NP-hardness"><span class="censored">NP-hard</span></a> <span class="censored">(and</span> <span class="censored">because</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">P</span></mi><mo mathvariant="normal"><span class="censored">≠</span></mo><mi><span class="censored">N</span></mi><mi><span class="censored">P</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">P</span> <span class="censored">\neq</span> <span class="censored">NP</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;"><span class="censored">P</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"><span class="censored"></span></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel"><span class="censored">=</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;"><span class="censored">NP</span></span></span></span></span></span><sup id="fnref:p-np" role="doc-noteref"><a href="#fn:p-np" class="footnote" rel="footnote"><span class="censored">8</span></a></sup><span class="censored">,</span> <span class="censored">has</span> <span class="censored">complexity</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">O</span></mi><mo stretchy="false"><span class="censored">(</span></mo><msup><mn><span class="censored">2</span></mn><mi><span class="censored">n</span></mi></msup><mo stretchy="false"><span class="censored">)</span></mo></mrow><annotation encoding="application/x-tex"><span class="censored">O(2^n)</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;"><span class="censored">O</span></span><span class="mopen"><span class="censored">(</span></span><span class="mord"><span class="mord"><span class="censored">2</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight"><span class="censored">n</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="censored">)</span></span></span></span></span></span><span class="censored">).</span> <span class="censored">However,</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">graph</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">DAG,</span> <span class="censored">it</span> <span class="censored">admits</span> <span class="censored">an</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">O</span></mi><mo stretchy="false"><span class="censored">(</span></mo><mi><span class="censored">n</span></mi><mo stretchy="false"><span class="censored">)</span></mo></mrow><annotation encoding="application/x-tex"><span class="censored">O(n)</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;"><span class="censored">O</span></span><span class="mopen"><span class="censored">(</span></span><span class="mord mathnormal"><span class="censored">n</span></span><span class="mclose"><span class="censored">)</span></span></span></span></span></span> <span class="censored">solution!</span></p> <p><span class="censored">To</span> <span class="censored">understand</span> <span class="censored">this</span> <span class="censored">benefit,</span> <span class="censored">consider</span> <span class="censored">another</span> <span class="censored">program:</span></p> <div class="codeblock" id="code:6"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">f</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">y</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">*</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">*=</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">const</span></span> <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">z</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">y</span></span> <span class="o"><span class="censored">*=</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">+</span></span> <span class="n"><span class="censored">z</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:6"><span class="censored">C</span></a></div> </div> <p><span class="censored">Suppose</span> <span class="censored">we</span> <span class="censored">wanted</span> <span class="censored">to</span> <span class="censored">replace</span> <span class="censored">each</span> <span class="censored">variable</span> <span class="censored">with</span> <span class="censored">its</span> <span class="censored">definition</span> <span class="censored">like</span> <span class="censored">we</span> <span class="censored">did</span> <span class="censored">before.</span> <span class="censored">We</span> <span class="censored">can’t</span> <em><span class="censored">just</span></em> <span class="censored">replace</span> <span class="censored">each</span> <span class="censored">constant</span> <span class="censored">variable</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">expression</span> <span class="censored">that</span> <span class="censored">defines</span> <span class="censored">it</span> <span class="censored">though,</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">would</span> <span class="censored">wind</span> <span class="censored">up</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">different</span> <span class="censored">program!</span></p> <div class="codeblock" id="code:7"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">f</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">y</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">*</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">*=</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>
  <span class="c1"><span class="censored">//</span> <span class="censored">const</span> <span class="censored">int</span> <span class="censored">z</span> <span class="censored">=</span> <span class="censored">y;</span> <span class="censored">//</span> <span class="censored">Replace</span> <span class="censored">z</span> <span class="censored">with</span> <span class="censored">its</span> <span class="censored">definition.</span></span>
  <span class="n"><span class="censored">y</span></span> <span class="o"><span class="censored">*=</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">+</span></span> <span class="n"><span class="censored">y</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:7"><span class="censored">C</span></a></div> </div> <p><span class="censored">Now,</span> <span class="censored">we</span> <span class="censored">pick</span> <span class="censored">up</span> <span class="censored">an</span> <span class="censored">extra</span> <code class="language-plaintext highlighter-rouge"><span class="censored">y</span></code> <span class="censored">term</span> <span class="censored">because</span> <span class="censored">the</span> <span class="censored">squaring</span> <span class="censored">operation</span> <span class="censored">is</span> <span class="censored">no</span> <span class="censored">longer</span> <span class="censored">unused!</span> <span class="censored">We</span> <span class="censored">can</span> <span class="censored">put</span> <span class="censored">this</span> <span class="censored">into</span> <span class="censored">circuit</span> <span class="censored">form,</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">requires</span> <span class="censored">inserting</span> <span class="censored">new</span> <span class="censored">variables</span> <span class="censored">for</span> <span class="censored">every</span> <span class="censored">mutation.</span></p> <p><span class="censored">But</span> <span class="censored">we</span> <span class="censored">can’t</span> <span class="censored">do</span> <span class="censored">this</span> <span class="censored">when</span> <span class="censored">complex</span> <span class="censored">control</span> <span class="censored">flow</span> <span class="censored">is</span> <span class="censored">involved!</span> <span class="censored">So</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">our</span> <span class="censored">algorithms</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">carefully</span> <span class="censored">account</span> <span class="censored">for</span> <span class="censored">mutations</span> <span class="censored">and</span> <span class="censored">program</span> <span class="censored">order,</span> <span class="censored">meaning</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">don’t</span> <span class="censored">get</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">the</span> <span class="censored">nice</span> <span class="censored">graph</span> <span class="censored">algorithms</span> <span class="censored">without</span> <span class="censored">careful</span> <span class="censored">modification.</span></p> <h2 id="the-ssa-invariant"><a href="#the-ssa-invariant"><span class="censored">The</span> <span class="censored">SSA</span> <span class="censored">Invariant</span></a></h2> <p><span class="censored">SSA</span> <span class="censored">stands</span> <span class="censored">for</span> <span class="censored">“static</span> <span class="censored">single</span> <span class="censored">assignment”,</span> <span class="censored">and</span> <span class="censored">was</span> <span class="censored">developed</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">80s</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">enhance</span> <span class="censored">the</span> <span class="censored">existing</span> <span class="censored">three-argument</span> <span class="censored">code</span> <span class="censored">(where</span> <span class="censored">every</span> <span class="censored">statement</span> <span class="censored">is</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">form</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x</span> <span class="censored">=</span> <span class="censored">y</span> <span class="censored">op</span> <span class="censored">z</span></code><span class="censored">)</span> <span class="censored">so</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">program</span> <span class="censored">was</span> <span class="censored">circuit-like,</span> <span class="censored">using</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">similar</span> <span class="censored">procedure</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">one</span> <span class="censored">described</span> <span class="censored">above.</span></p> <p><span class="censored">The</span> <span class="censored">SSA</span> <span class="censored">invariant</span> <span class="censored">states</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">variable</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">is</span> <span class="censored">assigned</span> <span class="censored">to</span> <span class="censored">by</span> <span class="censored">precisely</span> <span class="censored">one</span> <span class="censored">operation.</span> <span class="censored">If</span> <span class="censored">every</span> <span class="censored">operation</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">is</span> <span class="censored">visited</span> <span class="censored">once,</span> <span class="censored">they</span> <span class="censored">form</span> <span class="censored">a</span> <span class="censored">combinatorial</span> <span class="censored">circuit.</span> <span class="censored">Transformations</span> <span class="censored">are</span> <span class="censored">required</span> <span class="censored">to</span> <span class="censored">respect</span> <span class="censored">this</span> <span class="censored">invariant.</span> <span class="censored">In</span> <span class="censored">circuit</span> <span class="censored">form,</span> <span class="censored">a</span> <span class="censored">program</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">graph</span> <span class="censored">where</span> <span class="censored">operations</span> <span class="censored">are</span> <span class="censored">nodes,</span> <span class="censored">and</span> <span class="censored">“registers”</span> <span class="censored">(which</span> <span class="censored">is</span> <span class="censored">what</span> <span class="censored">variables</span> <span class="censored">are</span> <span class="censored">usually</span> <span class="censored">called</span> <span class="censored">in</span> <span class="censored">SSA)</span> <span class="censored">are</span> <span class="censored">edges</span> <span class="censored">(specifically,</span> <span class="censored">each</span> <span class="censored">output</span> <span class="censored">of</span> <span class="censored">an</span> <span class="censored">operation</span> <span class="censored">corresponds</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">register).</span></p> <p><span class="censored">But,</span> <span class="censored">again,</span> <span class="censored">control</span> <span class="censored">flow.</span> <span class="censored">We</span> <span class="censored">can’t</span> <span class="censored">hope</span> <span class="censored">to</span> <span class="censored">circuitize</span> <span class="censored">a</span> <span class="censored">loop,</span> <span class="censored">right?</span> <span class="censored">The</span> <span class="censored">key</span> <span class="censored">observation</span> <span class="censored">of</span> <span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">that</span> <em><span class="censored">most</span></em> <span class="censored">parts</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">program</span> <span class="censored">are</span> <span class="censored">circuit-like.</span> <span class="censored">A</span> <em><span class="censored">basic</span> <span class="censored">block</span></em> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">maximal</span> <span class="censored">circuital</span> <span class="censored">component</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">program.</span> <span class="censored">Simply</span> <span class="censored">put,</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">sequence</span> <span class="censored">of</span> <span class="censored">non-control</span> <span class="censored">flow</span> <span class="censored">operations,</span> <span class="censored">and</span> <span class="censored">a</span> <span class="censored">final</span> <em><span class="censored">terminator</span></em> <span class="censored">operation</span> <span class="censored">that</span> <span class="censored">transfers</span> <span class="censored">control</span> <span class="censored">to</span> <span class="censored">another</span> <span class="censored">basic</span> <span class="censored">block.</span></p> <p><span class="censored">The</span> <span class="censored">basic</span> <span class="censored">blocks</span> <span class="censored">themselves</span> <span class="censored">form</span> <span class="censored">a</span> <span class="censored">graph,</span> <span class="censored">the</span> <em><span class="censored">control</span> <span class="censored">flow</span> <span class="censored">graph</span></em><span class="censored">,</span> <span class="censored">or</span> <span class="censored">CFG.</span> <span class="censored">This</span> <span class="censored">formulation</span> <span class="censored">of</span> <span class="censored">SSA</span> <span class="censored">is</span> <span class="censored">sometimes</span> <span class="censored">called</span> <span class="censored">SSA-CFG</span><sup id="fnref:non-cfg" role="doc-noteref"><a href="#fn:non-cfg" class="footnote" rel="footnote"><span class="censored">9</span></a></sup><span class="censored">.</span> <span class="censored">This</span> <span class="censored">graph</span> <span class="censored">is</span> <em><span class="censored">not</span></em> <span class="censored">a</span> <span class="censored">DAG</span> <span class="censored">in</span> <span class="censored">general;</span> <span class="censored">however,</span> <span class="censored">separating</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">into</span> <span class="censored">basic</span> <span class="censored">blocks</span> <span class="censored">conveniently</span> <span class="censored">factors</span> <span class="censored">out</span> <span class="censored">the</span> <span class="censored">“non-DAG”</span> <span class="censored">parts</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">program,</span> <span class="censored">allowing</span> <span class="censored">for</span> <span class="censored">simpler</span> <span class="censored">analysis</span> <span class="censored">within</span> <span class="censored">basic</span> <span class="censored">blocks.</span></p> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">two</span> <span class="censored">equivalent</span> <span class="censored">formalisms</span> <span class="censored">for</span> <span class="censored">SSA-CFG.</span> <span class="censored">The</span> <span class="censored">traditional</span> <span class="censored">one</span> <span class="censored">uses</span> <span class="censored">special</span> <span class="censored">“phi”</span> <span class="censored">operations</span> <span class="censored">(often</span> <span class="censored">called</span> <em><span class="censored">phi</span> <span class="censored">nodes</span></em><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">call</span> <span class="censored">them</span> <span class="censored">here)</span> <span class="censored">to</span> <span class="censored">link</span> <span class="censored">registers</span> <span class="censored">across</span> <span class="censored">basic</span> <span class="censored">blocks.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">formalism</span> <span class="censored">LLVM</span> <span class="censored">uses.</span> <span class="censored">A</span> <span class="censored">more</span> <span class="censored">modern</span> <span class="censored">approach,</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">MLIR,</span> <span class="censored">is</span> <em><span class="censored">block</span> <span class="censored">arguments</span></em><span class="censored">:</span> <span class="censored">each</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">specifies</span> <span class="censored">parameters,</span> <span class="censored">like</span> <span class="censored">a</span> <span class="censored">function,</span> <span class="censored">and</span> <span class="censored">blocks</span> <span class="censored">transferring</span> <span class="censored">control</span> <span class="censored">flow</span> <span class="censored">to</span> <span class="censored">it</span> <span class="censored">must</span> <span class="censored">pass</span> <span class="censored">arguments</span> <span class="censored">of</span> <span class="censored">those</span> <span class="censored">types</span> <span class="censored">to</span> <span class="censored">it.</span></p> <h3 id="my-first-ir"><a href="#my-first-ir"><span class="censored">My</span> <span class="censored">First</span> <span class="censored">IR</span></a></h3> <p><span class="censored">Let’s</span> <span class="censored">look</span> <span class="censored">at</span> <span class="censored">some</span> <span class="censored">code.</span> <span class="censored">First,</span> <span class="censored">consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">C</span> <span class="censored">function</span> <span class="censored">which</span> <span class="censored">calculates</span> <span class="censored">Fibonacci</span> <span class="censored">numbers</span> <span class="censored">using</span> <span class="censored">a</span> <span class="censored">loop.</span></p> <div class="codeblock" id="code:8"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">fib</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">for</span></span> <span class="p"><span class="censored">(;</span></span> <span class="n"><span class="censored">n</span></span> <span class="o"><span class="censored">&gt;</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span> <span class="o"><span class="censored">--</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">c</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">+</span></span> <span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">;</span></span>
    <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">c</span></span><span class="p"><span class="censored">;</span></span>
  <span class="p"><span class="censored">}</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:8"><span class="censored">C</span></a></div> </div> <p><span class="censored">How</span> <span class="censored">might</span> <span class="censored">we</span> <span class="censored">express</span> <span class="censored">this</span> <span class="censored">in</span> <span class="censored">an</span> <span class="censored">SSA-CFG</span> <span class="censored">IR?</span> <span class="censored">Let’s</span> <span class="censored">start</span> <span class="censored">inventing</span> <span class="censored">our</span> <span class="censored">SSA</span> <span class="censored">IR!</span> <span class="censored">It</span> <span class="censored">will</span> <span class="censored">look</span> <span class="censored">a</span> <em><span class="censored">little</span> <span class="censored">bit</span></em> <span class="censored">like</span> <span class="censored">LLVM</span> <span class="censored">IR,</span> <span class="censored">since</span> <span class="censored">that’s</span> <span class="censored">what</span> <span class="censored">I’m</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">looking</span> <span class="censored">at.</span></p> <div class="codeblock" id="code:fib-ir"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c"><span class="censored">//</span> <span class="censored">Globals</span> <span class="censored">(including</span> <span class="censored">functions)</span> <span class="censored">start</span> <span class="censored">with</span> <span class="censored">$,</span> <span class="censored">registers</span> <span class="censored">with</span> <span class="censored">%.</span></span>
<span class="c"><span class="censored">//</span> <span class="censored">Each</span> <span class="censored">function</span> <span class="censored">declares</span> <span class="censored">a</span> <span class="censored">signature.</span></span>
<span class="k"><span class="censored">func</span></span> <span class="n"><span class="censored">fib</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">The</span> <span class="censored">first</span> <span class="censored">block</span> <span class="censored">has</span> <span class="censored">no</span> <span class="censored">label</span> <span class="censored">and</span> <span class="censored">can't</span> <span class="censored">be</span> <span class="censored">"jumped</span> <span class="censored">to".</span></span>
    <span class="c"><span class="censored">//</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">Single-argument</span> <span class="censored">goto</span> <span class="censored">jumps</span> <span class="censored">directly</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">with</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">the</span> <span class="censored">given</span> <span class="censored">arguments.</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span><span class="p"><span class="censored">)</span></span>

  <span class="c"><span class="censored">//</span> <span class="censored">Block</span> <span class="censored">labels</span> <span class="censored">start</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">`!`,</span> <span class="censored">can</span> <span class="censored">contain</span> <span class="censored">dots,</span> <span class="censored">and</span></span>
  <span class="c"><span class="censored">//</span> <span class="censored">define</span> <span class="censored">parameters.</span> <span class="censored">Register</span> <span class="censored">names</span> <span class="censored">are</span> <span class="censored">scoped</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">block.</span></span>
  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">Integer</span> <span class="censored">comparison:</span> <span class="censored">%n</span> <span class="censored">&gt;</span> <span class="censored">0.</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">cmp</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">gt</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>

    <span class="c"><span class="censored">//</span> <span class="censored">Multi-argument</span> <span class="censored">goto</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">switch</span> <span class="censored">statement.</span> <span class="censored">The</span> <span class="censored">compiler</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">may</span> <span class="censored">assume</span> <span class="censored">that</span> <span class="censored">`%cont`</span> <span class="censored">is</span> <span class="censored">among</span> <span class="censored">the</span> <span class="censored">cases</span> <span class="censored">listed</span> <span class="censored">in</span> <span class="censored">the</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">goto.</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="p"><span class="censored">{</span></span>
      <span class="m"><span class="censored">0</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">ret</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">),</span></span> <span class="c"><span class="censored">//</span> <span class="censored">Goto</span> <span class="censored">can</span> <span class="censored">jump</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">function</span> <span class="censored">exit.</span></span>
      <span class="m"><span class="censored">1</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">),</span></span>
    <span class="p"><span class="censored">}</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">Addition</span> <span class="censored">and</span> <span class="censored">subtraction.</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span>    <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">add</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span>  <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">sub</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>

    <span class="c"><span class="censored">//</span> <span class="censored">Note</span> <span class="censored">the</span> <span class="censored">assignments</span> <span class="censored">in</span> <span class="censored">@loop.start:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">%n</span> <span class="censored">=</span> <span class="censored">%n.2,</span> <span class="censored">%a</span> <span class="censored">=</span> <span class="censored">%b,</span> <span class="censored">%b</span> <span class="censored">=</span> <span class="censored">%c.</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:fib-ir"><span class="censored">SSA-CFG</span></a></div> </div> <p><span class="censored">Every</span> <span class="censored">block</span> <span class="censored">ends</span> <span class="censored">in</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">transfers</span> <span class="censored">control</span> <span class="censored">to</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">several</span> <span class="censored">possible</span> <span class="censored">blocks.</span> <span class="censored">In</span> <span class="censored">the</span> <span class="censored">process,</span> <span class="censored">it</span> <span class="censored">calls</span> <span class="censored">that</span> <span class="censored">block</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">given</span> <span class="censored">arguments.</span> <span class="censored">One</span> <span class="censored">can</span> <span class="censored">think</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">tiny</span> <span class="censored">function</span> <span class="censored">which</span> <em><span class="censored">tails</span></em><sup id="fnref:tail-call" role="doc-noteref"><a href="#fn:tail-call" class="footnote" rel="footnote"><span class="censored">10</span></a></sup> <span class="censored">into</span> <span class="censored">other</span> <span class="censored">basic</span> <span class="censored">blocks</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">function.</span></p> <blockquote id="aside:phi-nodes" class="aside"> <p><a href="#aside:phi-nodes"><span class="chip"><span class="censored">aside</span></span><span class="title"><span class="censored">Phi</span> <span class="censored">Nodes</span></span></a></p> <p><span class="censored">LLVM</span> <span class="censored">IR</span> <span class="censored">is…</span> <span class="censored">older,</span> <span class="censored">so</span> <span class="censored">it</span> <span class="censored">uses</span> <span class="censored">the</span> <span class="censored">older</span> <span class="censored">formalism</span> <span class="censored">of</span> <span class="censored">phi</span> <span class="censored">nodes.</span> <span class="censored">“Phi”</span> <span class="censored">comes</span> <span class="censored">from</span> <span class="censored">“phony”,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">operation</span> <span class="censored">that</span> <span class="censored">doesn’t</span> <span class="censored">do</span> <span class="censored">anything;</span> <span class="censored">it</span> <span class="censored">just</span> <span class="censored">links</span> <span class="censored">registers</span> <span class="censored">from</span> <span class="censored">predecessors.</span></p> <p><span class="censored">A</span> <code class="language-plaintext highlighter-rouge"><span class="censored">phi</span></code> <span class="censored">operation</span> <span class="censored">is</span> <span class="censored">essentially</span> <span class="censored">a</span> <span class="censored">switch-case</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">predecessors,</span> <span class="censored">each</span> <span class="censored">case</span> <span class="censored">selecting</span> <span class="censored">a</span> <span class="censored">register</span> <span class="censored">from</span> <span class="censored">that</span> <span class="censored">predecessor</span> <span class="censored">(or</span> <span class="censored">an</span> <span class="censored">immediate).</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code> <span class="censored">has</span> <span class="censored">two</span> <span class="censored">predecessors,</span> <span class="censored">the</span> <span class="censored">implicit</span> <span class="censored">entry</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">.</span> <span class="censored">In</span> <span class="censored">a</span> <span class="censored">phi</span> <span class="censored">node</span> <span class="censored">IR,</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">taking</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">argument</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%n</span></code><span class="censored">,</span> <span class="censored">it</span> <span class="censored">would</span> <span class="censored">specify</span></p> <div class="codeblock" id="code:9"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="o"><span class="censored">&gt;</span></span>   <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">phi</span></span> <span class="p"><span class="censored">{</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">entry</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">,</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span> <span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:9"><span class="censored">SSA-CFG</span></a></div> </div> <p><span class="censored">The</span> <span class="censored">value</span> <span class="censored">of</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">phi</span></code> <span class="censored">operation</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">from</span> <span class="censored">whichever</span> <span class="censored">block</span> <span class="censored">jumped</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">one.</span></p> <p><span class="censored">This</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">awkward</span> <span class="censored">to</span> <span class="censored">type</span> <span class="censored">out</span> <span class="censored">by</span> <span class="censored">hand</span> <span class="censored">and</span> <span class="censored">read,</span> <span class="censored">but</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">more</span> <span class="censored">convenient</span> <span class="censored">representation</span> <span class="censored">for</span> <span class="censored">describing</span> <span class="censored">algorithms</span> <span class="censored">(just</span> <span class="censored">“add</span> <span class="censored">a</span> <span class="censored">phi</span> <span class="censored">node”</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">“add</span> <span class="censored">a</span> <span class="censored">parameter</span> <span class="censored">and</span> <span class="censored">a</span> <span class="censored">corresponding</span> <span class="censored">argument”)</span> <span class="censored">and</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">in-memory</span> <span class="censored">representation,</span> <span class="censored">but</span> <span class="censored">is</span> <span class="censored">otherwise</span> <span class="censored">completely</span> <span class="censored">equivalent.</span></p> </blockquote> <p><span class="censored">It’s</span> <span class="censored">a</span> <span class="censored">bit</span> <span class="censored">easier</span> <span class="censored">to</span> <span class="censored">understand</span> <span class="censored">the</span> <span class="censored">transformation</span> <span class="censored">from</span> <span class="censored">C</span> <span class="censored">to</span> <span class="censored">our</span> <span class="censored">IR</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">first</span> <span class="censored">rewrite</span> <span class="censored">the</span> <span class="censored">C</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">goto</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">for</span> <span class="censored">loop:</span></p> <div class="codeblock" id="code:10"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt"><span class="censored">int</span></span> <span class="nf"><span class="censored">fib</span></span><span class="p"><span class="censored">(</span></span><span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
 <span class="nl"><span class="censored">start:</span></span>
  <span class="k"><span class="censored">if</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">n</span></span> <span class="o"><span class="censored">&gt;</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">)</span></span> <span class="k"><span class="censored">goto</span></span> <span class="n"><span class="censored">ret</span></span><span class="p"><span class="censored">;</span></span>

  <span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">c</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">+</span></span> <span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">;</span></span>
  <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">,</span></span> <span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">c</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">goto</span></span> <span class="n"><span class="censored">start</span></span>

<span class="nl"><span class="censored">ret:</span></span>
  <span class="k"><span class="censored">return</span></span> <span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:10"><span class="censored">C</span></a></div> </div> <p><span class="censored">However,</span> <span class="censored">we</span> <span class="censored">still</span> <span class="censored">have</span> <span class="censored">mutation</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">picture,</span> <span class="censored">so</span> <span class="censored">this</span> <span class="censored">isn’t</span> <span class="censored">SSA.</span> <span class="censored">To</span> <span class="censored">get</span> <span class="censored">into</span> <span class="censored">SSA,</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">replace</span> <span class="censored">every</span> <span class="censored">assignment</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">register,</span> <span class="censored">and</span> <span class="censored">somehow</span> <span class="censored">insert</span> <span class="censored">block</span> <span class="censored">arguments…</span></p> <h3 id="entering-ssa-form"><a href="#entering-ssa-form"><span class="censored">Entering</span> <span class="censored">SSA</span> <span class="censored">Form</span></a></h3> <p><span class="censored">The</span> <a href="#code:fib-ir"><span class="censored">above</span> <span class="censored">IR</span> <span class="censored">code</span></a> <span class="censored">is</span> <span class="censored">already</span> <span class="censored">partially</span> <span class="censored">optimized;</span> <span class="censored">the</span> <span class="censored">named</span> <span class="censored">variables</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">C</span> <span class="censored">program</span> <span class="censored">have</span> <span class="censored">been</span> <em><span class="censored">lifted</span></em> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">memory</span> <span class="censored">and</span> <span class="censored">into</span> <span class="censored">registers.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">represent</span> <span class="censored">each</span> <span class="censored">named</span> <span class="censored">variable</span> <span class="censored">in</span> <span class="censored">our</span> <span class="censored">C</span> <span class="censored">program</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">pointer,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">avoid</span> <span class="censored">needing</span> <span class="censored">to</span> <span class="censored">put</span> <span class="censored">the</span> <span class="censored">program</span> <span class="censored">into</span> <span class="censored">SSA</span> <span class="censored">form</span> <span class="censored">immediately.</span> <span class="censored">This</span> <span class="censored">technique</span> <span class="censored">is</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">frontends</span> <span class="censored">that</span> <span class="censored">lower</span> <span class="censored">into</span> <span class="censored">LLVM,</span> <span class="censored">like</span> <span class="censored">Clang.</span></p> <p><span class="censored">We’ll</span> <span class="censored">enhance</span> <span class="censored">our</span> <span class="censored">IR</span> <span class="censored">by</span> <span class="censored">adding</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">stack</span></code> <span class="censored">declaration</span> <span class="censored">for</span> <span class="censored">functions,</span> <span class="censored">which</span> <span class="censored">defines</span> <span class="censored">scratch</span> <span class="censored">space</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">function</span> <span class="censored">to</span> <span class="censored">use.</span> <span class="censored">Each</span> <span class="censored">stack</span> <span class="censored">slot</span> <span class="censored">produces</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">can</span> <code class="language-plaintext highlighter-rouge"><span class="censored">load</span></code> <span class="censored">from</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">store</span></code> <span class="censored">to.</span></p> <p><span class="censored">Our</span> <span class="censored">Fibonacci</span> <span class="censored">function</span> <span class="censored">would</span> <span class="censored">now</span> <span class="censored">look</span> <span class="censored">like</span> <span class="censored">so:</span></p> <div class="codeblock" id="code:fib-memory"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">func</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">fib</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">Declare</span> <span class="censored">stack</span> <span class="censored">slots.</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>

    <span class="c"><span class="censored">//</span> <span class="censored">Load</span> <span class="censored">initial</span> <span class="censored">values</span> <span class="censored">into</span> <span class="censored">them.</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>

    <span class="c"><span class="censored">//</span> <span class="censored">Start</span> <span class="censored">the</span> <span class="censored">loop.</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">)</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">cmp</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">gt</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="p"><span class="censored">{</span></span>
      <span class="m"><span class="censored">0</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">exit</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">)</span></span>
      <span class="m"><span class="censored">1</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">),</span></span>
    <span class="p"><span class="censored">}</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">add</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span>

    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span>   <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">sub</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">)</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">exit</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">ret</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:fib-memory"><span class="censored">SSA-CFG</span></a></div> </div> <p><span class="censored">Any</span> <span class="censored">time</span> <span class="censored">we</span> <span class="censored">reference</span> <span class="censored">a</span> <span class="censored">named</span> <span class="censored">variable,</span> <span class="censored">we</span> <span class="censored">load</span> <span class="censored">from</span> <span class="censored">its</span> <span class="censored">stack</span> <span class="censored">slot,</span> <span class="censored">and</span> <span class="censored">any</span> <span class="censored">time</span> <span class="censored">we</span> <span class="censored">assign</span> <span class="censored">it,</span> <span class="censored">we</span> <span class="censored">store</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">slot.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">into</span> <span class="censored">from</span> <span class="censored">C,</span> <span class="censored">but</span> <span class="censored">the</span> <span class="censored">code</span> <span class="censored">sucks</span> <span class="censored">because</span> <span class="censored">it’s</span> <span class="censored">doing</span> <span class="censored">lots</span> <span class="censored">of</span> <span class="censored">unnecessary</span> <span class="censored">pointer</span> <span class="censored">operations.</span> <span class="censored">How</span> <span class="censored">do</span> <span class="censored">we</span> <span class="censored">get</span> <span class="censored">from</span> <span class="censored">this</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">register-only</span> <span class="censored">function</span> <span class="censored">I</span> <span class="censored">showed</span> <span class="censored">earlier?</span></p> <blockquote id="aside:program-order" class="aside"> <p><a href="#aside:program-order"><span class="chip"><span class="censored">aside</span></span><span class="title"><span class="censored">Program</span> <span class="censored">Order</span></span></a></p> <p><span class="censored">We</span> <span class="censored">want</span> <span class="censored">program</span> <span class="censored">order</span> <span class="censored">to</span> <span class="censored">not</span> <span class="censored">matter</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">purposes</span> <span class="censored">of</span> <span class="censored">reordering,</span> <span class="censored">but</span> <span class="censored">as</span> <span class="censored">we’ve</span> <span class="censored">written</span> <span class="censored">code</span> <span class="censored">here,</span> <span class="censored">program</span> <span class="censored">order</span> <em><span class="censored">does</span></em> <span class="censored">matter:</span> <span class="censored">loads</span> <span class="censored">depend</span> <span class="censored">on</span> <span class="censored">prior</span> <span class="censored">stores</span> <span class="censored">but</span> <span class="censored">stores</span> <span class="censored">don’t</span> <span class="censored">produce</span> <span class="censored">a</span> <span class="censored">value</span> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">link</span> <span class="censored">the</span> <span class="censored">two</span> <span class="censored">operations.</span></p> <p><span class="censored">We</span> <span class="censored">can</span> <span class="censored">restore</span> <span class="censored">not</span> <span class="censored">having</span> <span class="censored">program</span> <span class="censored">order</span> <span class="censored">by</span> <span class="censored">introducing</span> <span class="censored">operands</span> <span class="censored">representing</span> <span class="censored">an</span> <span class="censored">“address</span> <span class="censored">space”;</span> <span class="censored">loads</span> <span class="censored">and</span> <span class="censored">stores</span> <span class="censored">take</span> <span class="censored">an</span> <span class="censored">address</span> <span class="censored">space</span> <span class="censored">as</span> <span class="censored">an</span> <span class="censored">argument,</span> <span class="censored">and</span> <span class="censored">stores</span> <span class="censored">return</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">address</span> <span class="censored">space.</span> <span class="censored">An</span> <span class="censored">address</span> <span class="censored">space,</span> <span class="censored">or</span> <code class="language-plaintext highlighter-rouge"><span class="censored">mem</span></code><span class="censored">,</span> <span class="censored">represents</span> <span class="censored">the</span> <span class="censored">state</span> <span class="censored">of</span> <span class="censored">some</span> <span class="censored">region</span> <span class="censored">of</span> <span class="censored">memory.</span> <span class="censored">Loads</span> <span class="censored">and</span> <span class="censored">stores</span> <span class="censored">are</span> <span class="censored">independent</span> <span class="censored">when</span> <span class="censored">they</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">connected</span> <span class="censored">by</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">mem</span></code> <span class="censored">argument.</span></p> <p><span class="censored">This</span> <span class="censored">type</span> <span class="censored">of</span> <span class="censored">enhancement</span> <span class="censored">is</span> <span class="censored">used</span> <span class="censored">by</span> <span class="censored">Go’s</span> <span class="censored">SSA</span> <span class="censored">IR,</span> <span class="censored">for</span> <span class="censored">example.</span> <span class="censored">However,</span> <span class="censored">it</span> <span class="censored">adds</span> <span class="censored">a</span> <span class="censored">layer</span> <span class="censored">of</span> <span class="censored">complexity</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">examples,</span> <span class="censored">so</span> <span class="censored">instead</span> <span class="censored">I</span> <span class="censored">will</span> <span class="censored">hand-wave</span> <span class="censored">this</span> <span class="censored">away.</span></p> </blockquote> <h2 id="the-dominance-relation"><a href="#the-dominance-relation"><span class="censored">The</span> <span class="censored">Dominance</span> <span class="censored">Relation</span></a></h2> <p><span class="censored">Now</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">prove</span> <span class="censored">some</span> <span class="censored">properties</span> <span class="censored">about</span> <span class="censored">CFGs</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">important</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">definition</span> <span class="censored">and</span> <span class="censored">correctness</span> <span class="censored">of</span> <span class="censored">our</span> <span class="censored">optimization</span> <span class="censored">passes.</span></p> <p><span class="censored">First,</span> <span class="censored">some</span> <span class="censored">definitions.</span></p> <blockquote id="def:1" class="def"> <p><a href="#def:1"><span class="chip"><span class="censored">definition</span></span></a></p> <p><span class="censored">The</span> <strong><span class="censored">predecessors</span></strong> <span class="censored">(or</span> <span class="censored">“preds”)</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">blocks</span> <span class="censored">with</span> <span class="censored">an</span> <span class="censored">outgoing</span> <span class="censored">edge</span> <strong><span class="censored">to</span></strong> <span class="censored">that</span> <span class="censored">block.</span> <span class="censored">A</span> <span class="censored">block</span> <span class="censored">may</span> <span class="censored">be</span> <span class="censored">its</span> <span class="censored">own</span> <span class="censored">predecessors.</span></p> </blockquote> <p><span class="censored">Some</span> <span class="censored">literature</span> <span class="censored">calls</span> <span class="censored">the</span> <span class="censored">above</span> <span class="censored">“direct”</span> <span class="censored">or</span> <span class="censored">immediate</span> <span class="censored">predecessors.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">the</span> <span class="censored">preds</span> <span class="censored">of</span> <span class="censored">in</span> <span class="censored">our</span> <a href="#code:fib-memory"><span class="censored">example</span></a> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">(the</span> <span class="censored">special</span> <span class="censored">name</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">function</span> <span class="censored">entry-point)</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">.</span></p> <blockquote id="def:2" class="def"> <p><a href="#def:2"><span class="chip"><span class="censored">definition</span></span></a></p> <p><span class="censored">The</span> <strong><span class="censored">successors</span></strong> <span class="censored">(no,</span> <span class="censored">not</span> <span class="censored">“succs”)</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">blocks</span> <span class="censored">with</span> <span class="censored">an</span> <span class="censored">outgoing</span> <span class="censored">edge</span> <strong><span class="censored">from</span></strong> <span class="censored">that</span> <span class="censored">block.</span> <span class="censored">A</span> <span class="censored">block</span> <span class="censored">may</span> <span class="censored">be</span> <span class="censored">its</span> <span class="censored">own</span> <span class="censored">successors.</span></p> </blockquote> <p><span class="censored">The</span> <span class="censored">sucessors</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@exit</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">successors</span> <span class="censored">are</span> <span class="censored">listed</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">loop’s</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code><span class="censored">.</span></p> <p><span class="censored">If</span> <span class="censored">a</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">transitive</span> <span class="censored">pred</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">say</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <em><span class="censored">weakly</span> <span class="censored">dominates</span></em> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">or</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">a</span> <em><span class="censored">weak</span> <span class="censored">dominator</span></em> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">For</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code> <span class="censored">both</span> <span class="censored">weakly</span> <span class="censored">dominate</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@exit</span></code><span class="censored">.</span></p> <p><span class="censored">However,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">usually</span> <span class="censored">an</span> <span class="censored">especially</span> <span class="censored">useful</span> <span class="censored">relationship.</span> <span class="censored">Instead,</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">speak</span> <span class="censored">of</span> <span class="censored">dominators:</span></p> <blockquote id="def:3" class="def"> <p><a href="#def:3"><span class="chip"><span class="censored">definition</span></span></a></p> <p><span class="censored">A</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">is</span> <span class="censored">a</span> <strong><span class="censored">dominator</span></strong> <span class="censored">(or</span> <strong><span class="censored">dominates</span></strong><span class="censored">)</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">if</span> <span class="censored">every</span> <span class="censored">pred</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">or</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">itself.</span></p> <p><span class="censored">Equivalently,</span> <span class="censored">the</span> <span class="censored">dominator</span> <span class="censored">set</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">intersection</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">dominator</span> <span class="censored">sets</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">preds,</span> <span class="censored">plus</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span></p> </blockquote> <p><span class="censored">The</span> <span class="censored">dominance</span> <span class="censored">relation</span> <span class="censored">has</span> <span class="censored">some</span> <span class="censored">nice</span> <span class="censored">order</span> <span class="censored">properties</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">necessary</span> <span class="censored">for</span> <span class="censored">defining</span> <span class="censored">the</span> <span class="censored">core</span> <span class="censored">graph</span> <span class="censored">algorithms</span> <span class="censored">of</span> <span class="censored">SSA.</span></p> <h3 id="some-graph-theory"><a href="#some-graph-theory"><span class="censored">Some</span> <span class="censored">Graph</span> <span class="censored">Theory</span></a></h3> <p><span class="censored">We</span> <span class="censored">only</span> <span class="censored">consider</span> <span class="censored">CFGs</span> <span class="censored">which</span> <span class="censored">are</span> <span class="censored">flowgraphs,</span> <span class="censored">that</span> <span class="censored">is,</span> <span class="censored">all</span> <span class="censored">blocks</span> <span class="censored">are</span> <span class="censored">reachable</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">root</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">no</span> <span class="censored">preds.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">necessary</span> <span class="censored">to</span> <span class="censored">eliminate</span> <span class="censored">some</span> <span class="censored">pathological</span> <span class="censored">graphs</span> <span class="censored">from</span> <span class="censored">our</span> <span class="censored">proofs.</span> <span class="censored">Importantly,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">always</span> <span class="censored">ask</span> <span class="censored">for</span> <span class="censored">an</span> <span class="censored">acyclic</span> <span class="censored">path</span><sup id="fnref:acyclic" role="doc-noteref"><a href="#fn:acyclic" class="footnote" rel="footnote"><span class="censored">11</span></a></sup> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <span class="censored">any</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span></p> <p><span class="censored">An</span> <span class="censored">equivalent</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">state</span> <span class="censored">the</span> <span class="censored">dominance</span> <span class="censored">relationship</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">from</span> <span class="censored">every</span> <span class="censored">path</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">contains</span> <span class="censored">all</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">’s</span> <span class="censored">dominators.</span></p> <blockquote id="prop:1" class="prop"> <p><a href="#prop:1"><span class="chip"><span class="censored">proposition</span></span></a></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">iff</span> <span class="censored">every</span> <span class="censored">path</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">contains</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">.</span></p> <blockquote id="proof:1" class="proof"> <p><a href="#proof:1"><span class="chip"><span class="censored">proof</span></span></a></p> <p><span class="censored">First,</span> <span class="censored">assume</span> <span class="censored">every</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">path</span> <span class="censored">contains</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">.</span> <span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">we’re</span> <span class="censored">done.</span> <span class="censored">Otherwise</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">prove</span> <span class="censored">each</span> <span class="censored">predecessor</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">;</span> <span class="censored">we</span> <span class="censored">do</span> <span class="censored">this</span> <span class="censored">by</span> <span class="censored">induction</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">length</span> <span class="censored">of</span> <span class="censored">acyclic</span> <span class="censored">paths</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">Consider</span> <span class="censored">preds</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">not</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">consider</span> <span class="censored">all</span> <span class="censored">acyclic</span> <span class="censored">paths</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code><span class="censored">;</span> <span class="censored">by</span> <span class="censored">appending</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">to</span> <span class="censored">them,</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">an</span> <span class="censored">acyclic</span> <span class="censored">path</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi><span class="censored">p</span></mi><mo mathvariant="normal" lspace="0em" rspace="0em"><span class="censored">′</span></mo></msup></mrow><annotation encoding="application/x-tex"><span class="censored">p'</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal"><span class="censored">p</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="censored">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">must</span> <span class="censored">contain</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">.</span> <span class="censored">Because</span> <span class="censored">both</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">and</span> <span class="censored">second-to-last</span> <span class="censored">elements</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">are</span> <span class="censored">not</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">it</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">within</span> <span class="censored">the</span> <span class="censored">shorter</span> <span class="censored">path</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">shorter</span> <span class="censored">than</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi><span class="censored">p</span></mi><mo mathvariant="normal" lspace="0em" rspace="0em"><span class="censored">′</span></mo></msup></mrow><annotation encoding="application/x-tex"><span class="censored">p'</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal"><span class="censored">p</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="censored">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="censored">.</span> <span class="censored">Thus,</span> <span class="censored">by</span> <span class="censored">induction,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">and</span> <span class="censored">therefore</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code></p> <p><span class="censored">Going</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">way,</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">consider</span> <span class="censored">a</span> <span class="censored">path</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">second-to-last</span> <span class="censored">element</span> <span class="censored">of</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">pred</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">;</span> <span class="censored">if</span> <span class="censored">it</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">we</span> <span class="censored">are</span> <span class="censored">done.</span> <span class="censored">Otherwise,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">consider</span> <span class="censored">the</span> <span class="censored">path</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">made</span> <span class="censored">by</span> <span class="censored">deleting</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">end.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">is</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi><span class="censored">p</span></mi><mo mathvariant="normal" lspace="0em" rspace="0em"><span class="censored">′</span></mo></msup></mrow><annotation encoding="application/x-tex"><span class="censored">p'</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal"><span class="censored">p</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="censored">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="censored">is</span> <span class="censored">shorter</span> <span class="censored">than</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span><span class="censored">,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">proceed</span> <span class="censored">by</span> <span class="censored">induction</span> <span class="censored">as</span> <span class="censored">above.</span></p> </blockquote> </blockquote> <p><span class="censored">Onto</span> <span class="censored">those</span> <span class="censored">nice</span> <span class="censored">properties.</span> <span class="censored">Dominance</span> <span class="censored">allows</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">take</span> <span class="censored">an</span> <span class="censored">arbitrarily</span> <span class="censored">complicated</span> <span class="censored">CFG</span> <span class="censored">and</span> <span class="censored">extract</span> <span class="censored">from</span> <span class="censored">it</span> <span class="censored">a</span> <span class="censored">DAG,</span> <span class="censored">composed</span> <span class="censored">of</span> <span class="censored">blocks</span> <span class="censored">ordered</span> <span class="censored">by</span> <span class="censored">dominance.</span></p> <blockquote id="thm:1" class="thm"> <p><a href="#thm:1"><span class="chip"><span class="censored">theorem</span></span></a></p> <p><span class="censored">The</span> <span class="censored">dominance</span> <span class="censored">relation</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">partial</span> <span class="censored">order.</span></p> <blockquote id="proof:2" class="proof"> <p><a href="#proof:2"><span class="chip"><span class="censored">proof</span></span></a></p> <p><span class="censored">Dominance</span> <span class="censored">is</span> <span class="censored">reflexive</span> <span class="censored">and</span> <span class="censored">transitive</span> <span class="censored">by</span> <span class="censored">definition,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">only</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">show</span> <span class="censored">blocks</span> <span class="censored">can’t</span> <span class="censored">dominate</span> <span class="censored">each</span> <span class="censored">other.</span></p> <p><span class="censored">Suppose</span> <span class="censored">distinct</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">dominate</span> <span class="censored">each</span> <span class="censored">other.Pick</span> <span class="censored">an</span> <span class="censored">acyclic</span> <span class="censored">path</span><span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">.</span> <span class="censored">Because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">dominates</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">prefix</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi><span class="censored">p</span></mi><mo mathvariant="normal" lspace="0em" rspace="0em"><span class="censored">′</span></mo></msup></mrow><annotation encoding="application/x-tex"><span class="censored">p'</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal"><span class="censored">p</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="censored">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">path</span> <span class="censored">ending</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">But</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">some</span> <span class="censored">prefix</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi><span class="censored">p</span></mi><mrow><mo mathvariant="normal"><span class="censored">′</span></mo><mo mathvariant="normal"><span class="censored">′</span></mo></mrow></msup></mrow><annotation encoding="application/x-tex"><span class="censored">p''</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal"><span class="censored">p</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="censored">′′</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="censored">of</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi><span class="censored">p</span></mi><mo mathvariant="normal" lspace="0em" rspace="0em"><span class="censored">′</span></mo></msup></mrow><annotation encoding="application/x-tex"><span class="censored">p'</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal"><span class="censored">p</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="censored">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="censored">ends</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">.</span> <span class="censored">But</span> <span class="censored">now</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">p</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">p</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal"><span class="censored">p</span></span></span></span></span></span> <span class="censored">must</span> <span class="censored">contain</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">twice,</span> <span class="censored">contradicting</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">acyclic.</span></p> </blockquote> </blockquote> <p><span class="censored">This</span> <span class="censored">allows</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">write</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span> <span class="censored">&lt;</span> <span class="censored">@b</span></code> <span class="censored">when</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">There</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">even</span> <span class="censored">more</span> <span class="censored">refined</span> <span class="censored">graph</span> <span class="censored">structure</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">build</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">dominators,</span> <span class="censored">which</span> <span class="censored">follows</span> <span class="censored">immediately</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">partial</span> <span class="censored">order</span> <span class="censored">theorem.</span></p> <blockquote id="cor:1" class="cor"> <p><a href="#cor:1"><span class="chip"><span class="censored">corollary</span></span></a></p> <p><span class="censored">The</span> <span class="censored">dominators</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">are</span> <span class="censored">totally</span> <span class="censored">ordered</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">dominance</span> <span class="censored">relation.</span></p> <blockquote id="proof:3" class="proof"> <p><a href="#proof:3"><span class="chip"><span class="censored">proof</span></span></a></p> <p><span class="censored">Suppose</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a1</span> <span class="censored">&lt;</span> <span class="censored">@b</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a2</span> <span class="censored">&lt;</span> <span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">but</span> <span class="censored">neither</span> <span class="censored">dominates</span> <span class="censored">the</span> <span class="censored">other.</span> <span class="censored">Then,</span> <span class="censored">there</span> <span class="censored">must</span> <span class="censored">exist</span> <span class="censored">acyclic</span> <span class="censored">paths</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">which</span> <span class="censored">contain</span> <span class="censored">both,</span> <span class="censored">but</span> <span class="censored">in</span> <span class="censored">different</span> <span class="censored">orders.</span> <span class="censored">Take</span> <span class="censored">the</span> <span class="censored">subpaths</span> <span class="censored">of</span> <span class="censored">those</span> <span class="censored">paths</span> <span class="censored">which</span> <span class="censored">follow</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span> <span class="censored">...</span> <span class="censored">@a1</span></code><span class="censored">,</span> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a1</span> <span class="censored">...</span> <span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">neither</span> <span class="censored">of</span> <span class="censored">which</span> <span class="censored">contains</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a2</span></code><span class="censored">.</span> <span class="censored">Concatenating</span> <span class="censored">these</span> <span class="censored">paths</span> <span class="censored">yields</span> <span class="censored">a</span> <span class="censored">path</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">that</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">contain</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a2</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">contradiction.</span></p> </blockquote> </blockquote> <p><span class="censored">This</span> <span class="censored">tells</span> <span class="censored">us</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">DAG</span> <span class="censored">we</span> <span class="censored">get</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">dominance</span> <span class="censored">relation</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">a</span> <span class="censored">tree,</span> <span class="censored">rooted</span> <span class="censored">at</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">parent</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">node</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">tree</span> <span class="censored">is</span> <span class="censored">called</span> <span class="censored">its</span> <em><span class="censored">immediate</span> <span class="censored">dominator</span></em><span class="censored">.</span></p> <p><span class="censored">Computing</span> <span class="censored">dominators</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">done</span> <span class="censored">iteratively:</span> <span class="censored">the</span> <span class="censored">dominator</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">intersection</span> <span class="censored">the</span> <span class="censored">dominator</span> <span class="censored">sets</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">preds,</span> <span class="censored">plus</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">algorithm</span> <span class="censored">runs</span> <span class="censored">in</span> <span class="censored">quadratic</span> <span class="censored">time.</span></p> <p><span class="censored">A</span> <span class="censored">better</span> <span class="censored">algorithm</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">Lengauer-Tarjan</span> <span class="censored">algorithm[^lta].</span> <span class="censored">It</span> <span class="censored">is</span> <span class="censored">relatively</span> <span class="censored">simple,</span> <span class="censored">but</span> <span class="censored">explaining</span> <span class="censored">how</span> <span class="censored">to</span> <span class="censored">implement</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">bit</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">scope</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">article.</span> <span class="censored">I</span> <span class="censored">found</span> <span class="censored">a</span> <span class="censored">nice</span> <span class="censored">treatment</span> <span class="censored">of</span> <span class="censored">it</span> <a href="https://www.cs.utexas.edu/~misra/Lengauer+Tarjan.pdf"><span class="censored">here</span></a><span class="censored">.</span></p> <p><span class="censored">What’s</span> <span class="censored">important</span> <span class="censored">is</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">compute</span> <span class="censored">the</span> <span class="censored">dominator</span> <span class="censored">tree</span> <span class="censored">without</span> <span class="censored">breaking</span> <span class="censored">the</span> <span class="censored">bank,</span> <span class="censored">and</span> <span class="censored">given</span> <span class="censored">any</span> <span class="censored">node,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">ask</span> <span class="censored">for</span> <span class="censored">its</span> <span class="censored">immediate</span> <span class="censored">dominator.</span> <span class="censored">Using</span> <span class="censored">immediate</span> <span class="censored">dominators,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">introduce</span> <span class="censored">the</span> <span class="censored">final,</span> <span class="censored">important</span> <span class="censored">property</span> <span class="censored">of</span> <span class="censored">dominators.</span></p> <blockquote id="def:4" class="def"> <p><a href="#def:4"><span class="chip"><span class="censored">definition</span></span></a></p> <p><span class="censored">The</span> <em><span class="censored">dominance</span> <span class="censored">frontier</span></em> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">all</span> <span class="censored">blocks</span> <span class="censored">not</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">with</span> <span class="censored">at</span> <span class="censored">least</span> <span class="censored">one</span> <span class="censored">pred</span> <span class="censored">which</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates.</span></p> </blockquote> <p><span class="censored">These</span> <span class="censored">are</span> <span class="censored">points</span> <span class="censored">where</span> <span class="censored">control</span> <span class="censored">flow</span> <span class="censored">merges</span> <span class="censored">from</span> <em><span class="censored">distinct</span></em> <span class="censored">paths:</span> <span class="censored">one</span> <span class="censored">containing</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">and</span> <span class="censored">one</span> <span class="censored">not.</span> <span class="censored">The</span> <span class="censored">dominance</span> <span class="censored">frontier</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code><span class="censored">,</span> <span class="censored">whose</span> <span class="censored">preds</span> <span class="censored">are</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">.</span></p> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">many</span> <span class="censored">ways</span> <span class="censored">to</span> <span class="censored">calculate</span> <span class="censored">dominance</span> <span class="censored">frontiers,</span> <span class="censored">but</span> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">dominance</span> <span class="censored">tree</span> <span class="censored">in</span> <span class="censored">hand,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">do</span> <span class="censored">it</span> <span class="censored">like</span> <span class="censored">this:</span></p> <blockquote id="alg:dominance-frontiers" class="alg"> <p><a href="#alg:dominance-frontiers"><span class="chip"><span class="censored">algorithm</span></span><span class="title"><span class="censored">Dominance</span> <span class="censored">Frontiers.</span></span></a></p> <p><span class="censored">For</span> <span class="censored">each</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">with</span> <span class="censored">more</span> <span class="censored">than</span> <span class="censored">one</span> <span class="censored">pred,</span> <span class="censored">for</span> <span class="censored">each</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">preds,</span> <span class="censored">let</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">be</span> <span class="censored">that</span> <span class="censored">pred.</span> <span class="censored">Add</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">dominance</span> <span class="censored">frontier</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">and</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">dominators,</span> <span class="censored">stopping</span> <span class="censored">when</span> <span class="censored">encountering</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">’</span> <span class="censored">immediate</span> <span class="censored">dominator.</span></p> <blockquote id="proof:4" class="proof"> <p><a href="#proof:4"><span class="chip"><span class="censored">proof</span></span></a></p> <p><span class="censored">We</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">prove</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">block</span> <span class="censored">examined</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">algorithm</span> <span class="censored">winds</span> <span class="censored">up</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">correct</span> <span class="censored">frontiers.</span></p> <p><span class="censored">First,</span> <span class="censored">we</span> <span class="censored">check</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">examined</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">added</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">correct</span> <span class="censored">frontier.</span> <span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span> <span class="censored">&lt;</span> <span class="censored">@p</span></code><span class="censored">,</span> <span class="censored">where</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">pred</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@d</span></code> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">’s</span> <span class="censored">immediate</span> <span class="censored">dominator,</span> <span class="censored">then</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span> <span class="censored">&lt;</span> <span class="censored">@d</span></code><span class="censored">,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">in</span> <span class="censored">its</span> <span class="censored">frontier,</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">must</span> <span class="censored">dominate</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">.</span> <span class="censored">Otherwise,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">’s</span> <span class="censored">frontier,</span> <span class="censored">because</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">dominates</span> <span class="censored">a</span> <span class="censored">pred</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">cannot</span> <span class="censored">dominate</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">because</span> <span class="censored">then</span> <span class="censored">it</span> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@i</span></code><span class="censored">,</span> <span class="censored">a</span> <span class="censored">contradiction.</span></p> <p><span class="censored">Second,</span> <span class="censored">we</span> <span class="censored">check</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">frontier</span> <span class="censored">is</span> <span class="censored">complete.</span> <span class="censored">Consider</span> <span class="censored">a</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">.</span> <span class="censored">If</span> <span class="censored">an</span> <span class="censored">examined</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">in</span> <span class="censored">its</span> <span class="censored">frontier,</span> <span class="censored">then</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">among</span> <span class="censored">the</span> <span class="censored">dominators</span> <span class="censored">of</span> <span class="censored">some</span> <span class="censored">pred</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@p</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">it</span> <span class="censored">must</span> <span class="censored">be</span> <span class="censored">dominated</span> <span class="censored">by</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">’s</span> <span class="censored">immediate</span> <span class="censored">dominator;</span> <span class="censored">otherwise,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">would</span> <span class="censored">dominate</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">(and</span> <span class="censored">thus</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">would</span> <span class="censored">not</span> <span class="censored">be</span> <span class="censored">in</span> <span class="censored">its</span> <span class="censored">frontier).</span> <span class="censored">Thus,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">gets</span> <span class="censored">added</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">’s</span> <span class="censored">dominator.</span></p> </blockquote> </blockquote> <p><span class="censored">You</span> <span class="censored">might</span> <span class="censored">notice</span> <span class="censored">that</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">these</span> <span class="censored">algorithms</span> <span class="censored">are</span> <span class="censored">quadratic.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">actually</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">good</span> <span class="censored">time</span> <span class="censored">complexity</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">compilers-related</span> <span class="censored">graph</span> <span class="censored">algorithm.</span> <span class="censored">Cubic</span> <span class="censored">and</span> <span class="censored">quartic</span> <span class="censored">algorithms</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">especially</span> <span class="censored">uncommon,</span> <span class="censored">and</span> <span class="censored">yes,</span> <span class="censored">your</span> <span class="censored">optimizing</span> <span class="censored">compiler’s</span> <span class="censored">time</span> <span class="censored">complexity</span> <span class="censored">is</span> <span class="censored">probably</span> <span class="censored">cubic</span> <span class="censored">or</span> <span class="censored">quartic</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">size</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">program!</span></p> <h2 id="lifting-memory"><a href="#lifting-memory"><span class="censored">Lifting</span> <span class="censored">Memory</span></a></h2> <p><span class="censored">Ok.</span> <span class="censored">Let’s</span> <span class="censored">construct</span> <span class="censored">an</span> <span class="censored">optimization.</span> <span class="censored">We</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">figure</span> <span class="censored">out</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">replace</span> <span class="censored">a</span> <span class="censored">load</span> <span class="censored">from</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">most</span> <span class="censored">recent</span> <span class="censored">store</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">pointer.</span> <span class="censored">This</span> <span class="censored">will</span> <span class="censored">allow</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">fully</span> <span class="censored">lift</span> <span class="censored">values</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">memory</span> <span class="censored">by</span> <span class="censored">cancelling</span> <span class="censored">out</span> <span class="censored">store/load</span> <span class="censored">pairs.</span></p> <p><span class="censored">This</span> <span class="censored">will</span> <span class="censored">make</span> <span class="censored">use</span> <span class="censored">of</span> <span class="censored">yet</span> <span class="censored">another</span> <span class="censored">implicit</span> <span class="censored">graph</span> <span class="censored">data</span> <span class="censored">structure.</span></p> <blockquote id="def:5" class="def"> <p><a href="#def:5"><span class="chip"><span class="censored">definition</span></span></a></p> <p><span class="censored">The</span> <strong><span class="censored">dataflow</span> <span class="censored">graph</span></strong> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">directed</span> <span class="censored">graph</span> <span class="censored">made</span> <span class="censored">up</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">internal</span> <span class="censored">circuit</span> <span class="censored">graphs</span> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">each</span> <span class="censored">basic</span> <span class="censored">block,</span> <span class="censored">connected</span> <span class="censored">along</span> <span class="censored">block</span> <span class="censored">arguments.</span></p> <p><span class="censored">To</span> <strong><span class="censored">follow</span> <span class="censored">a</span> <span class="censored">use-def</span> <span class="censored">chain</span></strong> <span class="censored">is</span> <span class="censored">to</span> <span class="censored">walk</span> <span class="censored">this</span> <span class="censored">graph</span> <span class="censored">forward</span> <span class="censored">from</span> <span class="censored">an</span> <span class="censored">operation</span> <span class="censored">to</span> <span class="censored">discover</span> <span class="censored">operations</span> <span class="censored">that</span> <span class="censored">potentially</span> <span class="censored">depend</span> <span class="censored">on</span> <span class="censored">it,</span> <span class="censored">or</span> <span class="censored">backwards</span> <span class="censored">to</span> <span class="censored">find</span> <span class="censored">operations</span> <span class="censored">it</span> <span class="censored">potentially</span> <span class="censored">depends</span> <span class="censored">on.</span></p> </blockquote> <p><span class="censored">It’s</span> <span class="censored">important</span> <span class="censored">to</span> <span class="censored">remember</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">dataflow</span> <span class="censored">graph,</span> <span class="censored">like</span> <span class="censored">the</span> <span class="censored">CFG,</span> <span class="censored">does</span> <em><span class="censored">not</span></em> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">well</span> <span class="censored">defined</span> <span class="censored">“up”</span> <span class="censored">direction.</span> <span class="censored">Navigating</span> <span class="censored">it</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">CFG</span> <span class="censored">requires</span> <span class="censored">the</span> <span class="censored">dominator</span> <span class="censored">tree.</span></p> <p><span class="censored">One</span> <span class="censored">other</span> <span class="censored">important</span> <span class="censored">thing</span> <span class="censored">to</span> <span class="censored">remember</span> <span class="censored">here</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">instruction</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">always</span> <span class="censored">executes</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">block</span> <span class="censored">executes.</span> <span class="censored">In</span> <span class="censored">much</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">analysis,</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">appeal</span> <span class="censored">to</span> <span class="censored">“program</span> <span class="censored">order”</span> <span class="censored">to</span> <span class="censored">select</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">load</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">block,</span> <span class="censored">but</span> <span class="censored">we</span> <span class="censored">are</span> <span class="censored">always</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">so.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">important</span> <span class="censored">property</span> <span class="censored">of</span> <span class="censored">basic</span> <span class="censored">blocks</span> <span class="censored">that</span> <span class="censored">makes</span> <span class="censored">them</span> <span class="censored">essential</span> <span class="censored">for</span> <span class="censored">constructing</span> <span class="censored">optimizations.</span></p> <h3 id="forward-dataflow"><a href="#forward-dataflow"><span class="censored">Forward</span> <span class="censored">Dataflow</span></a></h3> <p><span class="censored">For</span> <span class="censored">a</span> <span class="censored">given</span> <code class="language-plaintext highlighter-rouge"><span class="censored">store</span> <span class="censored">%p,</span> <span class="censored">%v</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">identify</span> <span class="censored">all</span> <span class="censored">loads</span> <span class="censored">that</span> <span class="censored">depend</span> <span class="censored">on</span> <span class="censored">it.</span> <span class="censored">We</span> <span class="censored">can</span> <span class="censored">follow</span> <span class="censored">the</span> <span class="censored">use-def</span> <span class="censored">chain</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">to</span> <span class="censored">find</span> <span class="censored">which</span> <span class="censored">blocks</span> <span class="censored">contain</span> <span class="censored">loads</span> <span class="censored">that</span> <span class="censored">potentially</span> <span class="censored">depend</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">store</span> <span class="censored">(call</span> <span class="censored">it</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%s</span></code><span class="censored">).</span></p> <p><span class="censored">First,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">eliminate</span> <span class="censored">loads</span> <span class="censored">within</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">(call</span> <span class="censored">it</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">).</span> <span class="censored">Replace</span> <span class="censored">all</span> <code class="language-plaintext highlighter-rouge"><span class="censored">load</span> <span class="censored">%p</span></code> <span class="censored">instructions</span> <span class="censored">after</span> <code class="language-plaintext highlighter-rouge"><span class="censored">s</span></code> <span class="censored">(but</span> <span class="censored">before</span> <span class="censored">any</span> <span class="censored">other</span> <code class="language-plaintext highlighter-rouge"><span class="censored">store</span> <span class="censored">%p,</span> <span class="censored">_</span></code><span class="censored">s,</span> <span class="censored">in</span> <span class="censored">program</span> <span class="censored">order)</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v</span></code><span class="censored">’s</span> <span class="censored">def.</span> <span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">s</span></code> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">store</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">block,</span> <span class="censored">we’re</span> <span class="censored">done.</span></p> <p><span class="censored">Otherwise,</span> <span class="censored">follow</span> <span class="censored">the</span> <span class="censored">use-def</span> <span class="censored">chain</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">to</span> <span class="censored">successors</span> <span class="censored">which</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code><span class="censored">,</span> <span class="censored">i.e.,</span> <span class="censored">successors</span> <span class="censored">whose</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code> <span class="censored">case</span> <span class="censored">has</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">as</span> <span class="censored">at</span> <span class="censored">least</span> <span class="censored">one</span> <span class="censored">argument.</span> <span class="censored">Recurse</span> <span class="censored">into</span> <span class="censored">those</span> <span class="censored">successors,</span> <span class="censored">and</span> <span class="censored">now</span> <span class="censored">replacing</span> <span class="censored">the</span> <span class="censored">pointer</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">of</span> <span class="censored">interest</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">parameters</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">successor</span> <span class="censored">which</span> <span class="censored">were</span> <span class="censored">set</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">(more</span> <span class="censored">than</span> <span class="censored">one</span> <span class="censored">argument</span> <span class="censored">may</span> <span class="censored">be</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code><span class="censored">).</span></p> <p><span class="censored">If</span> <span class="censored">successor</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">loads</span> <span class="censored">from</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">registers</span> <span class="censored">holding</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code><span class="censored">,</span> <span class="censored">replace</span> <span class="censored">all</span> <span class="censored">such</span> <span class="censored">loads</span> <span class="censored">before</span> <span class="censored">a</span> <span class="censored">store</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code><span class="censored">.</span> <span class="censored">We</span> <span class="censored">also</span> <span class="censored">now</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">send</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v</span></code> <span class="censored">into</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">somehow.</span></p> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">where</span> <span class="censored">we</span> <span class="censored">run</span> <span class="censored">into</span> <span class="censored">something</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">wrinkle.</span> <span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">has</span> <span class="censored">exactly</span> <span class="censored">one</span> <span class="censored">predecessor,</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">add</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">block</span> <span class="censored">argument</span> <span class="censored">to</span> <span class="censored">pass</span> <span class="censored">whichever</span> <span class="censored">register</span> <span class="censored">is</span> <span class="censored">holding</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v</span></code> <span class="censored">(which</span> <span class="censored">exists</span> <span class="censored">by</span> <span class="censored">induction).</span> <span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v</span></code> <span class="censored">is</span> <span class="censored">already</span> <span class="censored">passed</span> <span class="censored">into</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">by</span> <span class="censored">another</span> <span class="censored">argument,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">use</span> <span class="censored">that</span> <span class="censored">one.</span></p> <p><span class="censored">However,</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">has</span> <span class="censored">multiple</span> <span class="censored">predecessors,</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">sure</span> <span class="censored">that</span> <span class="censored">every</span> <span class="censored">path</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">sends</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">canonicalizing</span> <span class="censored">those</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">tricky.</span> <span class="censored">Worse</span> <span class="censored">still,</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">is</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">’s</span> <span class="censored">domination</span> <span class="censored">frontier,</span> <span class="censored">a</span> <em><span class="censored">different</span></em> <span class="censored">store</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">contributing</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">load!</span> <span class="censored">For</span> <span class="censored">this</span> <span class="censored">reason,</span> <span class="censored">dataflow</span> <span class="censored">from</span> <span class="censored">stores</span> <span class="censored">to</span> <span class="censored">loads</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">a</span> <span class="censored">great</span> <span class="censored">strategy.</span></p> <p><span class="censored">Instead,</span> <span class="censored">we’ll</span> <span class="censored">look</span> <span class="censored">at</span> <span class="censored">dataflow</span> <span class="censored">from</span> <span class="censored">loads</span> <span class="censored">backwards</span> <span class="censored">to</span> <span class="censored">stores</span> <span class="censored">(in</span> <span class="censored">general,</span> <span class="censored">dataflow</span> <span class="censored">from</span> <span class="censored">uses</span> <span class="censored">to</span> <span class="censored">defs</span> <span class="censored">tends</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">more</span> <span class="censored">useful),</span> <span class="censored">which</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">use</span> <span class="censored">to</span> <span class="censored">augment</span> <span class="censored">the</span> <span class="censored">above</span> <span class="censored">forward</span> <span class="censored">dataflow</span> <span class="censored">analysis</span> <span class="censored">to</span> <span class="censored">remove</span> <span class="censored">the</span> <span class="censored">complex</span> <span class="censored">issues</span> <span class="censored">around</span> <span class="censored">domination</span> <span class="censored">frontiers.</span></p> <h3 id="dependency-analysis"><a href="#dependency-analysis"><span class="censored">Dependency</span> <span class="censored">Analysis</span></a></h3> <p><span class="censored">Let’s</span> <span class="censored">analyze</span> <span class="censored">loads</span> <span class="censored">instead.</span> <span class="censored">For</span> <span class="censored">each</span> <code class="language-plaintext highlighter-rouge"><span class="censored">load</span> <span class="censored">%p</span></code> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">determine</span> <span class="censored">all</span> <span class="censored">stores</span> <span class="censored">that</span> <span class="censored">could</span> <span class="censored">potentially</span> <span class="censored">contribute</span> <span class="censored">to</span> <span class="censored">its</span> <span class="censored">value.</span> <span class="censored">We</span> <span class="censored">can</span> <span class="censored">find</span> <span class="censored">those</span> <span class="censored">stores</span> <span class="censored">as</span> <span class="censored">follows:</span></p> <p><span class="censored">We</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">determine</span> <span class="censored">which</span> <span class="censored">register</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">given</span> <span class="censored">block</span> <span class="censored">corresponds</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">then</span> <span class="censored">find</span> <span class="censored">its</span> <span class="censored">last</span> <span class="censored">store</span> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">block.</span></p> <p><span class="censored">To</span> <span class="censored">do</span> <span class="censored">this,</span> <span class="censored">we’ll</span> <span class="censored">flood-fill</span> <span class="censored">the</span> <span class="censored">CFG</span> <span class="censored">backwards</span> <span class="censored">in</span> <span class="censored">BFS</span> <span class="censored">order.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">we’ll</span> <span class="censored">follow</span> <span class="censored">preds</span> <span class="censored">(through</span> <span class="censored">the</span> <span class="censored">use-def</span> <span class="censored">chain)</span> <span class="censored">recursively,</span> <span class="censored">visiting</span> <span class="censored">each</span> <span class="censored">pred</span> <span class="censored">before</span> <span class="censored">visiting</span> <span class="censored">their</span> <span class="censored">preds,</span> <span class="censored">and</span> <span class="censored">never</span> <span class="censored">revisiting</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">(except</span> <span class="censored">we</span> <span class="censored">may</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">come</span> <span class="censored">back</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">end).</span></p> <p><span class="censored">Determining</span> <span class="censored">the</span> <span class="censored">“equivalent”</span><sup id="fnref:equiv-reg" role="doc-noteref"><a href="#fn:equiv-reg" class="footnote" rel="footnote"><span class="censored">12</span></a></sup> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">(we’ll</span> <span class="censored">call</span> <span class="censored">it</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p.b</span></code><span class="censored">)</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">done</span> <span class="censored">recursively:</span> <span class="censored">while</span> <span class="censored">examining</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">follow</span> <span class="censored">the</span> <span class="censored">def</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p.b</span></code><span class="censored">.</span> <span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p.b</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">parameter,</span> <span class="censored">for</span> <span class="censored">each</span> <span class="censored">pred</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@c</span></code><span class="censored">,</span> <span class="censored">set</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p.c</span></code> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">corresponding</span> <span class="censored">argument</span> <span class="censored">in</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b(...)</span></code> <span class="censored">case</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@c</span></code><span class="censored">’s</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code><span class="censored">.</span></p> <p><span class="censored">Using</span> <span class="censored">this</span> <span class="censored">information,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">collect</span> <span class="censored">all</span> <span class="censored">stores</span> <span class="censored">that</span> <span class="censored">the</span> <span class="censored">load</span> <span class="censored">potentially</span> <span class="censored">depends</span> <span class="censored">on.</span> <span class="censored">If</span> <span class="censored">a</span> <span class="censored">predecessor</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">stores</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p.b</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">add</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">such</span> <span class="censored">store</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">(in</span> <span class="censored">program</span> <span class="censored">order)</span> <span class="censored">to</span> <span class="censored">our</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">stores,</span> <span class="censored">and</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">recurse</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">’s</span> <span class="censored">preds</span> <span class="censored">(because</span> <span class="censored">this</span> <span class="censored">store</span> <span class="censored">overwrites</span> <span class="censored">all</span> <span class="censored">past</span> <span class="censored">stores).</span> <span class="censored">Note</span> <span class="censored">that</span> <span class="censored">we</span> <em><span class="censored">may</span></em> <span class="censored">revisit</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">process,</span> <span class="censored">and</span> <span class="censored">collect</span> <span class="censored">a</span> <span class="censored">store</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">from</span> <span class="censored">it</span> <span class="censored">occurs</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">block.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">necessary</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">case</span> <span class="censored">of</span> <span class="censored">loops.</span></p> <p><span class="censored">The</span> <span class="censored">result</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">set</span> <code class="language-plaintext highlighter-rouge"><span class="censored">stores</span></code> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">(store</span> <span class="censored">%p.s</span> <span class="censored">%v.s,</span> <span class="censored">@s)</span></code> <span class="censored">pairs.</span> <span class="censored">In</span> <span class="censored">the</span> <span class="censored">process,</span> <span class="censored">we</span> <span class="censored">also</span> <span class="censored">collected</span> <span class="censored">a</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">all</span> <span class="censored">blocks</span> <span class="censored">visited,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">subgraph</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">are</span> <span class="censored">dominators</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">which</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">plumb</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v.b</span></code> <span class="censored">through.</span> <span class="censored">This</span> <span class="censored">process</span> <span class="censored">is</span> <span class="censored">called</span> <em><span class="censored">memory</span> <span class="censored">dependency</span> <span class="censored">analysis</span></em><span class="censored">,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">key</span> <span class="censored">component</span> <span class="censored">of</span> <span class="censored">many</span> <span class="censored">optimizations.</span></p> <blockquote id="note:2" class="note"> <p><a href="#note:2"><span class="chip"><span class="censored">note</span></span></a></p> <p><span class="censored">Not</span> <span class="censored">all</span> <span class="censored">contributing</span> <span class="censored">operations</span> <span class="censored">are</span> <span class="censored">stores.</span> <span class="censored">Some</span> <span class="censored">may</span> <span class="censored">be</span> <span class="censored">references</span> <span class="censored">to</span> <span class="censored">globals</span> <span class="censored">(which</span> <span class="censored">we’re</span> <span class="censored">disregarding),</span> <span class="censored">or</span> <span class="censored">function</span> <span class="censored">arguments</span> <span class="censored">or</span> <span class="censored">the</span> <span class="censored">results</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">call</span> <span class="censored">(which</span> <span class="censored">means</span> <span class="censored">we</span> <span class="censored">probably</span> <span class="censored">can’t</span> <span class="censored">lift</span> <span class="censored">this</span> <span class="censored">load).</span> <span class="censored">For</span> <span class="censored">example</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">gets</span> <span class="censored">traced</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">way</span> <span class="censored">back</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">argument,</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">code</span> <span class="censored">path</span> <span class="censored">which</span> <span class="censored">loads</span> <span class="censored">from</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">whose</span> <span class="censored">stores</span> <span class="censored">we</span> <span class="censored">can’t</span> <span class="censored">see.</span></p> </blockquote> <p><span class="censored">It</span> <span class="censored">may</span> <span class="censored">also</span> <span class="censored">trace</span> <span class="censored">back</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">stack</span> <span class="censored">slot</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">potentially</span> <span class="censored">not</span> <span class="censored">stored</span> <span class="censored">to.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">code</span> <span class="censored">path</span> <span class="censored">that</span> <span class="censored">can</span> <span class="censored">potentially</span> <span class="censored">load</span> <span class="censored">uninitialized</span> <span class="censored">memory.</span> <span class="censored">Like</span> <span class="censored">LLVM,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">assume</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">observable</span> <span class="censored">behavior,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">discount</span> <span class="censored">such</span> <span class="censored">dependencies.</span> <span class="censored">If</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">dependencies</span> <span class="censored">are</span> <span class="censored">uninitialized</span> <span class="censored">loads,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">potentially</span> <span class="censored">delete</span> <span class="censored">not</span> <span class="censored">just</span> <span class="censored">the</span> <span class="censored">load,</span> <span class="censored">but</span> <span class="censored">operations</span> <span class="censored">which</span> <span class="censored">depend</span> <span class="censored">on</span> <span class="censored">it</span> <span class="censored">(reverse</span> <span class="censored">dataflow</span> <span class="censored">analysis</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">origin</span> <span class="censored">of</span> <span class="censored">so-called</span> <span class="censored">“time-traveling”</span> <span class="censored">UB).</span></p> <h3 id="lifting-loads"><a href="#lifting-loads"><span class="censored">Lifting</span> <span class="censored">Loads</span></a></h3> <p><span class="censored">Now</span> <span class="censored">that</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">full</span> <span class="censored">set</span> <span class="censored">of</span> <span class="censored">dependency</span> <span class="censored">information,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">start</span> <span class="censored">lifting</span> <span class="censored">loads.</span> <span class="censored">Loads</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">safely</span> <span class="censored">lifted</span> <span class="censored">when</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">their</span> <span class="censored">dependencies</span> <span class="censored">are</span> <span class="censored">stores</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">function,</span> <span class="censored">or</span> <span class="censored">dependencies</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">disregard</span> <span class="censored">thanks</span> <span class="censored">to</span> <span class="censored">UB</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">surface</span> <span class="censored">language</span> <span class="censored">(such</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">null</span></code> <span class="censored">loads</span> <span class="censored">or</span> <span class="censored">uninitialized</span> <span class="censored">loads).</span></p> <blockquote id="note:3" class="note"> <p><a href="#note:3"><span class="chip"><span class="censored">note</span></span></a></p> <p><span class="censored">There</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">fuss</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">algorithm</span> <span class="censored">about</span> <span class="censored">plumbing</span> <span class="censored">values</span> <span class="censored">through</span> <span class="censored">block</span> <span class="censored">arguments.</span> <span class="censored">A</span> <span class="censored">lot</span> <span class="censored">of</span> <span class="censored">IRs</span> <span class="censored">make</span> <span class="censored">a</span> <span class="censored">simplifying</span> <span class="censored">change,</span> <span class="censored">where</span> <span class="censored">every</span> <span class="censored">block</span> <span class="censored">implicitly</span> <span class="censored">receives</span> <span class="censored">the</span> <span class="censored">registers</span> <span class="censored">from</span> <span class="censored">its</span> <span class="censored">dominators</span> <span class="censored">as</span> <span class="censored">block</span> <span class="censored">arguments.</span></p> <p><span class="censored">I</span> <span class="censored">am</span> <span class="censored">keeping</span> <span class="censored">the</span> <span class="censored">fuss</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">makes</span> <span class="censored">it</span> <span class="censored">clearer</span> <span class="censored">what’s</span> <span class="censored">going</span> <span class="censored">on,</span> <span class="censored">but</span> <span class="censored">in</span> <span class="censored">practice,</span> <span class="censored">most</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">plumbing,</span> <span class="censored">except</span> <span class="censored">at</span> <span class="censored">dominance</span> <span class="censored">frontiers,</span> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">happening</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">background.</span></p> </blockquote> <p><span class="censored">Suppose</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">safely</span> <span class="censored">lift</span> <span class="censored">some</span> <span class="censored">load.</span> <span class="censored">Now</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">plumb</span> <span class="censored">the</span> <span class="censored">stored</span> <span class="censored">values</span> <span class="censored">down</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">load.</span> <span class="censored">For</span> <span class="censored">each</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">subgraph</span></code> <span class="censored">(all</span> <span class="censored">other</span> <span class="censored">blocks</span> <span class="censored">will</span> <span class="censored">now</span> <span class="censored">be</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">subgraph</span></code> <span class="censored">unless</span> <span class="censored">stated</span> <span class="censored">otherwise).</span> <span class="censored">We</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">building</span> <span class="censored">two</span> <span class="censored">mappings:</span> <span class="censored">one</span> <code class="language-plaintext highlighter-rouge"><span class="censored">(@s,</span> <span class="censored">@b)</span> <span class="censored">-&gt;</span> <span class="censored">%v.s.b</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">register</span> <span class="censored">equivalent</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v.s</span></code> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">block.</span> <span class="censored">We</span> <span class="censored">will</span> <span class="censored">also</span> <span class="censored">be</span> <span class="censored">building</span> <span class="censored">a</span> <span class="censored">map</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span> <span class="censored">-&gt;</span> <span class="censored">%v.b</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">must</span> <span class="censored">have</span> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">block.</span></p> <ol> <li> <p><span class="censored">Prepare</span> <span class="censored">a</span> <span class="censored">work</span> <span class="censored">queue,</span> <span class="censored">with</span> <span class="censored">each</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@s</span></code> <span class="censored">in</span> <span class="censored">it</span> <span class="censored">initially.</span></p> </li> <li> <p><span class="censored">Pop</span> <span class="censored">a</span> <span class="censored">block</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">form</span> <span class="censored">the</span> <span class="censored">queue.</span> <span class="censored">For</span> <span class="censored">each</span> <span class="censored">successor</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">(in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">subgraph</span></code><span class="censored">):</span></p> <ol> <li> <p><span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v.b</span></code> <span class="censored">isn’t</span> <span class="censored">already</span> <span class="censored">defined,</span> <span class="censored">add</span> <span class="censored">it</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">argument.</span> <span class="censored">Have</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">pass</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v.a</span></code> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">argument.</span></p> </li> <li> <p><span class="censored">If</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code> <span class="censored">hasn’t</span> <span class="censored">been</span> <span class="censored">visited</span> <span class="censored">yet,</span> <span class="censored">and</span> <span class="censored">isn’t</span> <span class="censored">the</span> <span class="censored">block</span> <span class="censored">containing</span> <span class="censored">the</span> <span class="censored">load</span> <span class="censored">we’re</span> <span class="censored">deleting,</span> <span class="censored">add</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">queue.</span></p> </li> </ol> </li> </ol> <p><span class="censored">Once</span> <span class="censored">we’re</span> <span class="censored">done,</span> <span class="censored">if</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">block</span> <span class="censored">that</span> <span class="censored">contains</span> <span class="censored">the</span> <span class="censored">load,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">now</span> <span class="censored">replace</span> <span class="censored">all</span> <span class="censored">loads</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">before</span> <span class="censored">any</span> <span class="censored">stores</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%v.a</span></code><span class="censored">.</span></p> <blockquote id="tip:1" class="tip"> <p><a href="#tip:1"><span class="chip"><span class="censored">tip</span></span></a></p> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">cases</span> <span class="censored">where</span> <span class="censored">this</span> <span class="censored">whole</span> <span class="censored">process</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">skipped,</span> <span class="censored">by</span> <span class="censored">applying</span> <span class="censored">a</span> <span class="censored">“peephole”</span> <span class="censored">optimization.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">stores</span> <span class="censored">followed</span> <span class="censored">by</span> <span class="censored">loads</span> <span class="censored">within</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">optimized</span> <span class="censored">away</span> <span class="censored">locally,</span> <span class="censored">leaving</span> <span class="censored">the</span> <span class="censored">heavy-weight</span> <span class="censored">analysis</span> <span class="censored">for</span> <span class="censored">cross-block</span> <span class="censored">store/load</span> <span class="censored">pairs.</span></p> </blockquote> <h3 id="worked-example"><a href="#worked-example"><span class="censored">Worked</span> <span class="censored">Example</span></a></h3> <p><span class="censored">Here’s</span> <span class="censored">the</span> <span class="censored">result</span> <span class="censored">of</span> <span class="censored">doing</span> <span class="censored">dependency</span> <span class="censored">analysis</span> <span class="censored">on</span> <span class="censored">our</span> <span class="censored">Fibonacci</span> <span class="censored">function.</span> <span class="censored">Each</span> <span class="censored">load</span> <span class="censored">is</span> <span class="censored">annotated</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">blocks</span> <span class="censored">and</span> <span class="censored">stores</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">stores</span></code><span class="censored">.</span></p> <div class="codeblock" id="code:11"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">func</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">fib</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>

    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">S1</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>   <span class="c"><span class="censored">//</span> <span class="censored">S2</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>   <span class="c"><span class="censored">//</span> <span class="censored">S3</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">)</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S1</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S6</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">L1</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">cmp</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">gt</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="p"><span class="censored">{</span></span>
      <span class="m"><span class="censored">0</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">exit</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">)</span></span>
      <span class="m"><span class="censored">1</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">),</span></span>
    <span class="p"><span class="censored">}</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S1</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S4</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">L2</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S2</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S5</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">L3</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">add</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span> <span class="c"><span class="censored">//</span> <span class="censored">S4</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span> <span class="c"><span class="censored">//</span> <span class="censored">S5</span></span>

    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S1</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S6</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span>   <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">L3</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">sub</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">S6</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">)</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">exit</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S2</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S5</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">load</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">L4</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">ret</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:11"><span class="censored">SSA-CFG</span></a></div> </div> <p><span class="censored">Let’s</span> <span class="censored">look</span> <span class="censored">at</span> <code class="language-plaintext highlighter-rouge"><span class="censored">L1</span></code><span class="censored">.</span> <span class="censored">Is</span> <span class="censored">contributing</span> <span class="censored">loads</span> <span class="censored">are</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">.</span> <span class="censored">So</span> <span class="censored">we</span> <span class="censored">add</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">parameter</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%n</span></code><span class="censored">:</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">call</span> <span class="censored">that</span> <span class="censored">parameter</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%n</span></code> <span class="censored">(since</span> <span class="censored">that’s</span> <span class="censored">stored</span> <span class="censored">to</span> <span class="censored">it</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">),</span> <span class="censored">while</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">pass</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%n.2</span></code><span class="censored">.</span></p> <p><span class="censored">What</span> <span class="censored">about</span> <span class="censored">L4?</span> <span class="censored">The</span> <span class="censored">contributing</span> <span class="censored">loads</span> <span class="censored">are</span> <span class="censored">also</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">,</span> <span class="censored">but</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">those</span> <span class="censored">isn’t</span> <span class="censored">a</span> <span class="censored">pred</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@exit</span></code><span class="censored">.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code> <span class="censored">is</span> <span class="censored">also</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">subgraph</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">load,</span> <span class="censored">though.</span> <span class="censored">So,</span> <span class="censored">starting</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">add</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">parameter</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%a</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code> <span class="censored">and</span> <span class="censored">feed</span> <code class="language-plaintext highlighter-rouge"><span class="censored">0</span></code> <span class="censored">(the</span> <span class="censored">stored</span> <span class="censored">value,</span> <span class="censored">an</span> <span class="censored">immediate</span> <span class="censored">this</span> <span class="censored">time)</span> <span class="censored">through</span> <span class="censored">it.</span> <span class="censored">Now</span> <span class="censored">looking</span> <span class="censored">at</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">see</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">already</span> <span class="censored">a</span> <span class="censored">parameter</span> <span class="censored">for</span> <span class="censored">this</span> <span class="censored">load</span> <span class="censored">(</span><code class="language-plaintext highlighter-rouge"><span class="censored">%a</span></code><span class="censored">),</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">just</span> <span class="censored">pass</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%b</span></code> <span class="censored">as</span> <span class="censored">that</span> <span class="censored">argument.</span> <span class="censored">Now</span> <span class="censored">we</span> <span class="censored">process</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code><span class="censored">,</span> <span class="censored">which</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@entry</span></code> <span class="censored">pushed</span> <span class="censored">onto</span> <span class="censored">the</span> <span class="censored">queue.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@exit</span></code> <span class="censored">gets</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">parameter</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%a</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">fed</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code><span class="censored">’s</span> <span class="censored">own</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%a</span></code><span class="censored">.</span> <span class="censored">We</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">re-process</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.body</span></code><span class="censored">,</span> <span class="censored">even</span> <span class="censored">though</span> <span class="censored">it</span> <span class="censored">also</span> <span class="censored">appears</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@loop.start</span></code><span class="censored">’s</span> <span class="censored">gotos,</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">already</span> <span class="censored">visited</span> <span class="censored">it.</span></p> <p><span class="censored">After</span> <span class="censored">doing</span> <span class="censored">this</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">other</span> <span class="censored">two</span> <span class="censored">loads,</span> <span class="censored">we</span> <span class="censored">get</span> <span class="censored">this:</span></p> <div class="codeblock" id="code:12"> <figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k"><span class="censored">func</span></span> <span class="o"><span class="censored">&amp;</span></span><span class="n"><span class="censored">fib</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">stack</span></span> <span class="n"><span class="censored">i32</span></span>

    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">S1</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>   <span class="c"><span class="censored">//</span> <span class="censored">S2</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>   <span class="c"><span class="censored">//</span> <span class="censored">S3</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span><span class="p"><span class="censored">)</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S1</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S6</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">%n</span> <span class="censored">=</span> <span class="censored">load</span> <span class="censored">%np</span>  <span class="censored">//</span> <span class="censored">L1</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">cmp</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">gt</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">0</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">cont</span></span> <span class="p"><span class="censored">{</span></span>
      <span class="m"><span class="censored">0</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">exit</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">)</span></span>
      <span class="m"><span class="censored">1</span></span> <span class="o"><span class="censored">-&gt;</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">),</span></span>
    <span class="p"><span class="censored">}</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">body</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S1</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S4</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">%a</span> <span class="censored">=</span> <span class="censored">load</span> <span class="censored">%ap</span>  <span class="censored">//</span> <span class="censored">L2</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S2</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S5</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">%b</span> <span class="censored">=</span> <span class="censored">load</span> <span class="censored">%bp</span>  <span class="censored">//</span> <span class="censored">L3</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">add</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span> <span class="c"><span class="censored">//</span> <span class="censored">S4</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span> <span class="c"><span class="censored">//</span> <span class="censored">S5</span></span>

    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S1</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S6</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">%n</span>   <span class="censored">=</span> <span class="censored">load</span> <span class="censored">%np</span>  <span class="censored">//</span> <span class="censored">L3</span></span>
    <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">sub</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="p"><span class="censored">,</span></span> <span class="m"><span class="censored">1</span></span>
    <span class="n"><span class="censored">store</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span>  <span class="c"><span class="censored">//</span> <span class="censored">S6</span></span>

    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">loop</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">start</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">np</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">bp</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">n</span></span><span class="m"><span class="censored">.2</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">b</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">c</span></span><span class="p"><span class="censored">)</span></span>

  <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">exit</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">ap</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">ptr</span></span><span class="p"><span class="censored">,</span></span> <span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="o"><span class="censored">:</span></span> <span class="n"><span class="censored">i32</span></span><span class="p"><span class="censored">)</span></span><span class="o"><span class="censored">:</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@entry:</span> <span class="censored">S2</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">@loop.body:</span> <span class="censored">S5</span></span>
    <span class="c"><span class="censored">//</span> <span class="censored">%a</span> <span class="censored">=</span> <span class="censored">load</span> <span class="censored">%ap</span>  <span class="censored">//</span> <span class="censored">L4</span></span>
    <span class="k"><span class="censored">goto</span></span> <span class="err"><span class="censored">@</span></span><span class="n"><span class="censored">ret</span></span><span class="p"><span class="censored">(</span></span><span class="o"><span class="censored">%</span></span><span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">)</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:12"><span class="censored">SSA-CFG</span></a></div> </div> <p><span class="censored">After</span> <span class="censored">lifting,</span> <span class="censored">if</span> <span class="censored">we</span> <span class="censored">know</span> <span class="censored">that</span> <span class="censored">a</span> <span class="censored">stack</span> <span class="censored">slot’s</span> <span class="censored">pointer</span> <span class="censored">does</span> <span class="censored">not</span> <span class="censored">escape</span> <span class="censored">(i.e.,</span> <span class="censored">none</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">uses</span> <span class="censored">wind</span> <span class="censored">up</span> <span class="censored">going</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">call</span><sup id="fnref:calls-only" role="doc-noteref"><a href="#fn:calls-only" class="footnote" rel="footnote"><span class="censored">13</span></a></sup><span class="censored">)</span> <span class="censored">or</span> <span class="censored">a</span> <span class="censored">write</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">global</span> <span class="censored">(or</span> <span class="censored">a</span> <span class="censored">pointer</span> <span class="censored">that</span> <span class="censored">escapes),</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">delete</span> <span class="censored">every</span> <span class="censored">store</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">pointer.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">delete</span> <span class="censored">every</span> <span class="censored">store</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">stack</span> <span class="censored">slot,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">delete</span> <span class="censored">the</span> <span class="censored">stack</span> <span class="censored">slot</span> <span class="censored">altogether</span> <span class="censored">(there</span> <span class="censored">should</span> <span class="censored">be</span> <span class="censored">no</span> <span class="censored">loads</span> <span class="censored">left</span> <span class="censored">for</span> <span class="censored">that</span> <span class="censored">stack</span> <span class="censored">slot</span> <span class="censored">at</span> <span class="censored">this</span> <span class="censored">point).</span></p> <h3 id="complications"><a href="#complications"><span class="censored">Complications</span></a></h3> <p><span class="censored">This</span> <span class="censored">analysis</span> <span class="censored">is</span> <span class="censored">simple,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">assumes</span> <span class="censored">pointers</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">alias</span> <span class="censored">in</span> <span class="censored">general.</span> <span class="censored">Alias</span> <span class="censored">analysis</span> <span class="censored">is</span> <span class="censored">necessary</span> <span class="censored">for</span> <span class="censored">more</span> <span class="censored">accurate</span> <span class="censored">dependency</span> <span class="censored">analysis.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">necessary,</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">for</span> <span class="censored">lifting</span> <span class="censored">loads</span> <span class="censored">of</span> <span class="censored">fields</span> <span class="censored">of</span> <span class="censored">structs</span> <span class="censored">through</span> <span class="censored">subobject</span> <span class="censored">pointers,</span> <span class="censored">and</span> <span class="censored">dealing</span> <span class="censored">with</span> <span class="censored">pointer</span> <span class="censored">arithmetic</span> <span class="censored">in</span> <span class="censored">general.</span></p> <p><span class="censored">However,</span> <span class="censored">our</span> <span class="censored">dependency</span> <span class="censored">analysis</span> <em><span class="censored">is</span></em> <span class="censored">robust</span> <span class="censored">to</span> <span class="censored">passing</span> <span class="censored">different</span> <span class="censored">pointers</span> <span class="censored">as</span> <span class="censored">arguments</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">block</span> <span class="censored">from</span> <span class="censored">different</span> <span class="censored">predecessors.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">case</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">specifically</span> <span class="censored">handled</span> <span class="censored">by</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">fussing</span> <span class="censored">about</span> <span class="censored">with</span> <span class="censored">dominance</span> <span class="censored">frontiers.</span> <span class="censored">This</span> <span class="censored">robustness</span> <span class="censored">ultimately</span> <span class="censored">comes</span> <span class="censored">from</span> <span class="censored">SSA’s</span> <span class="censored">circuital</span> <span class="censored">nature.</span></p> <p><span class="censored">Similarly,</span> <span class="censored">this</span> <span class="censored">analysis</span> <span class="censored">needs</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">tweaked</span> <span class="censored">to</span> <span class="censored">deal</span> <span class="censored">with</span> <span class="censored">something</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">select</span> <span class="censored">%cond,</span> <span class="censored">%a,</span> <span class="censored">%b</span></code> <span class="censored">(a</span> <span class="censored">ternary,</span> <span class="censored">essentially).</span> <code class="language-plaintext highlighter-rouge"><span class="censored">select</span></code><span class="censored">s</span> <span class="censored">of</span> <span class="censored">pointers</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">replaced</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">select</span></code><span class="censored">s</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">loaded</span> <span class="censored">values,</span> <span class="censored">which</span> <span class="censored">means</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">the</span> <span class="censored">lifting</span> <span class="censored">transformation</span> <span class="censored">“all</span> <span class="censored">at</span> <span class="censored">once”:</span> <span class="censored">lifting</span> <span class="censored">some</span> <span class="censored">liftable</span> <span class="censored">loads</span> <span class="censored">will</span> <span class="censored">leave</span> <span class="censored">the</span> <span class="censored">IR</span> <span class="censored">in</span> <span class="censored">an</span> <span class="censored">inconsistent</span> <span class="censored">state,</span> <span class="censored">until</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">them</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">lifted.</span></p> <h2 id="cleanup-passes"><a href="#cleanup-passes"><span class="censored">Cleanup</span> <span class="censored">Passes</span></a></h2> <p><span class="censored">Many</span> <span class="censored">optimizations</span> <span class="censored">will</span> <span class="censored">make</span> <span class="censored">a</span> <span class="censored">mess</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">CFG,</span> <span class="censored">so</span> <span class="censored">it’s</span> <span class="censored">useful</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">simple</span> <span class="censored">passes</span> <span class="censored">that</span> <span class="censored">“clean</span> <span class="censored">up”</span> <span class="censored">the</span> <span class="censored">mess</span> <span class="censored">left</span> <span class="censored">by</span> <span class="censored">transformations.</span> <span class="censored">Here’s</span> <span class="censored">some</span> <span class="censored">easy</span> <span class="censored">examples.</span></p> <h3 id="unused-result-elimination"><a href="#unused-result-elimination"><span class="censored">Unused</span> <span class="censored">Result</span> <span class="censored">Elimination</span></a></h3> <p><span class="censored">If</span> <span class="censored">an</span> <span class="censored">operation’s</span> <span class="censored">result</span> <span class="censored">has</span> <span class="censored">zero</span> <span class="censored">uses,</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">operation</span> <span class="censored">has</span> <span class="censored">no</span> <span class="censored">side-effects,</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">deleted.</span> <span class="censored">This</span> <span class="censored">allows</span> <span class="censored">us</span> <span class="censored">to</span> <span class="censored">then</span> <span class="censored">delete</span> <span class="censored">operations</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">depended</span> <span class="censored">on</span> <span class="censored">that</span> <span class="censored">now</span> <span class="censored">have</span> <span class="censored">no</span> <span class="censored">side</span> <span class="censored">effects.</span> <span class="censored">Doing</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">simple,</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">circuital</span> <span class="censored">nature</span> <span class="censored">of</span> <span class="censored">SSA:</span> <span class="censored">collect</span> <span class="censored">all</span> <span class="censored">instructions</span> <span class="censored">whose</span> <span class="censored">outputs</span> <span class="censored">have</span> <span class="censored">zero</span> <span class="censored">uses,</span> <span class="censored">and</span> <span class="censored">delete</span> <span class="censored">them.</span> <span class="censored">Then,</span> <span class="censored">examine</span> <span class="censored">the</span> <span class="censored">defs</span> <span class="censored">of</span> <span class="censored">their</span> <span class="censored">operands;</span> <span class="censored">if</span> <span class="censored">those</span> <span class="censored">operations</span> <span class="censored">now</span> <span class="censored">have</span> <span class="censored">no</span> <span class="censored">uses,</span> <span class="censored">delete</span> <span class="censored">them,</span> <span class="censored">and</span> <span class="censored">recurse.</span></p> <p><span class="censored">This</span> <span class="censored">bubbles</span> <span class="censored">up</span> <span class="censored">all</span> <span class="censored">the</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">block</span> <span class="censored">arguments.</span> <span class="censored">Deleting</span> <span class="censored">block</span> <span class="censored">arguments</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">bit</span> <span class="censored">trickier,</span> <span class="censored">but</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">use</span> <span class="censored">a</span> <span class="censored">work</span> <span class="censored">queue</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">it.</span> <span class="censored">Put</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">blocks</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">work</span> <span class="censored">queue.</span></p> <ol> <li> <p><span class="censored">Pop</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">from</span> <span class="censored">the</span> <span class="censored">queue.</span></p> </li> <li> <p><span class="censored">Run</span> <span class="censored">unused</span> <span class="censored">result</span> <span class="censored">elimination</span> <span class="censored">on</span> <span class="censored">its</span> <span class="censored">operations.</span></p> </li> <li> <p><span class="censored">If</span> <span class="censored">it</span> <span class="censored">now</span> <span class="censored">has</span> <span class="censored">parameters</span> <span class="censored">with</span> <span class="censored">no</span> <span class="censored">uses,</span> <span class="censored">remove</span> <span class="censored">those</span> <span class="censored">parameters.</span></p> </li> <li> <p><span class="censored">For</span> <span class="censored">each</span> <span class="censored">pred,</span> <span class="censored">delete</span> <span class="censored">the</span> <span class="censored">corresponding</span> <span class="censored">arguments</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">block.</span> <span class="censored">Then,</span> <span class="censored">Place</span> <span class="censored">those</span> <span class="censored">preds</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">work</span> <span class="censored">queue</span> <span class="censored">(since</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">their</span> <span class="censored">operations</span> <span class="censored">may</span> <span class="censored">have</span> <span class="censored">lost</span> <span class="censored">their</span> <span class="censored">last</span> <span class="censored">use).</span></p> </li> <li> <p><span class="censored">If</span> <span class="censored">there</span> <span class="censored">is</span> <span class="censored">still</span> <span class="censored">work</span> <span class="censored">left,</span> <span class="censored">go</span> <span class="censored">to</span> <span class="censored">1.</span></p> </li> </ol> <h3 id="simplifying-the-cfg"><a href="#simplifying-the-cfg"><span class="censored">Simplifying</span> <span class="censored">the</span> <span class="censored">CFG</span></a></h3> <p><span class="censored">There</span> <span class="censored">are</span> <span class="censored">many</span> <span class="censored">CFG</span> <span class="censored">configurations</span> <span class="censored">that</span> <span class="censored">are</span> <span class="censored">redundant</span> <span class="censored">and</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">simplified</span> <span class="censored">to</span> <span class="censored">reduce</span> <span class="censored">the</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">basic</span> <span class="censored">blocks.</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <span class="censored">unreachable</span> <span class="censored">code</span> <span class="censored">can</span> <span class="censored">help</span> <span class="censored">delete</span> <span class="censored">blocks.</span> <span class="censored">Other</span> <span class="censored">optimizations</span> <span class="censored">may</span> <span class="censored">cause</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">end</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">empty</span> <span class="censored">(because</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">successors</span> <span class="censored">were</span> <span class="censored">optimized</span> <span class="censored">away).</span> <span class="censored">We</span> <span class="censored">treat</span> <span class="censored">an</span> <span class="censored">empty</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code> <span class="censored">as</span> <span class="censored">being</span> <span class="censored">unreachable</span> <span class="censored">(since</span> <span class="censored">it</span> <span class="censored">has</span> <span class="censored">no</span> <span class="censored">cases!),</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">delete</span> <span class="censored">every</span> <span class="censored">operation</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">block</span> <span class="censored">up</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">non-pure</span> <span class="censored">operation.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">delete</span> <span class="censored">every</span> <span class="censored">instruction</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">block,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">delete</span> <span class="censored">the</span> <span class="censored">block</span> <span class="censored">entirely,</span> <span class="censored">and</span> <span class="censored">delete</span> <span class="censored">it</span> <span class="censored">from</span> <span class="censored">its</span> <span class="censored">preds’</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code><span class="censored">s.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">form</span> <span class="censored">of</span> <em><span class="censored">dead</span> <span class="censored">code</span> <span class="censored">elimination</span></em><span class="censored">,</span> <span class="censored">or</span> <span class="censored">DCE,</span> <span class="censored">which</span> <span class="censored">combines</span> <span class="censored">with</span> <span class="censored">the</span> <span class="censored">previous</span> <span class="censored">optimization</span> <span class="censored">to</span> <span class="censored">aggressively</span> <span class="censored">delete</span> <span class="censored">redundant</span> <span class="censored">code.</span></p> <p><span class="censored">Some</span> <span class="censored">jumps</span> <span class="censored">are</span> <span class="censored">redundant.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">if</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">has</span> <span class="censored">exactly</span> <span class="censored">one</span> <span class="censored">pred</span> <span class="censored">and</span> <span class="censored">one</span> <span class="censored">successor,</span> <span class="censored">the</span> <span class="censored">pred’s</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code> <span class="censored">case</span> <span class="censored">for</span> <span class="censored">that</span> <span class="censored">block</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">wired</span> <span class="censored">directly</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">successor.</span> <span class="censored">Similarly,</span> <span class="censored">if</span> <span class="censored">two</span> <span class="censored">blocks</span> <span class="censored">are</span> <span class="censored">each</span> <span class="censored">other’s</span> <span class="censored">unique</span> <span class="censored">predecessor/successor,</span> <span class="censored">they</span> <span class="censored">can</span> <span class="censored">be</span> <em><span class="censored">fused</span></em><span class="censored">,</span> <span class="censored">creating</span> <span class="censored">a</span> <span class="censored">single</span> <span class="censored">block</span> <span class="censored">by</span> <span class="censored">connecting</span> <span class="censored">the</span> <span class="censored">input</span> <span class="censored">blocks’</span> <span class="censored">circuits</span> <span class="censored">directly,</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">through</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">goto</span></code><span class="censored">.</span></p> <p><span class="censored">If</span> <span class="censored">we</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">ternary</span> <code class="language-plaintext highlighter-rouge"><span class="censored">select</span></code> <span class="censored">operation,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">do</span> <span class="censored">more</span> <span class="censored">sophisticated</span> <span class="censored">fusion.</span> <span class="censored">If</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">has</span> <span class="censored">two</span> <span class="censored">successors,</span> <span class="censored">both</span> <span class="censored">of</span> <span class="censored">which</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">unique</span> <span class="censored">successor,</span> <span class="censored">and</span> <span class="censored">those</span> <span class="censored">successors</span> <span class="censored">consist</span> <span class="censored">only</span> <span class="censored">of</span> <span class="censored">gotos,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">fuse</span> <span class="censored">all</span> <span class="censored">four</span> <span class="censored">blocks,</span> <span class="censored">replacing</span> <span class="censored">the</span> <span class="censored">CFG</span> <span class="censored">diamond</span> <span class="censored">with</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">select</span></code><span class="censored">.</span> <span class="censored">In</span> <span class="censored">terms</span> <span class="censored">of</span> <span class="censored">C,</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">this</span> <span class="censored">transformation:</span></p> <div class="code-multicol"> <div class="codeblock" id="code:13"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1"><span class="censored">//</span> <span class="censored">Before.</span></span>
<span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">x</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">if</span></span> <span class="p"><span class="censored">(</span></span><span class="n"><span class="censored">cond</span></span><span class="p"><span class="censored">)</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">a</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span> <span class="k"><span class="censored">else</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:13"><span class="censored">C</span></a></div> </div> <div class="codeblock" id="code:14"> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1"><span class="censored">//</span> <span class="censored">After.</span></span>
<span class="kt"><span class="censored">int</span></span> <span class="n"><span class="censored">x</span></span> <span class="o"><span class="censored">=</span></span> <span class="n"><span class="censored">cond</span></span> <span class="o"><span class="censored">?</span></span> <span class="n"><span class="censored">a</span></span> <span class="o"><span class="censored">:</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button codeblock-anchor" href="#code:14"><span class="censored">C</span></a></div> </div> </div> <p><span class="censored">LLVM’s</span> <span class="censored">CFG</span> <span class="censored">simplification</span> <span class="censored">pass</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">sophisticated</span> <span class="censored">and</span> <span class="censored">can</span> <span class="censored">eliminate</span> <span class="censored">complex</span> <span class="censored">forms</span> <span class="censored">of</span> <span class="censored">control</span> <span class="censored">flow.</span></p> <h2 id="conclusion"><a href="#conclusion"><span class="censored">Conclusion</span></a></h2> <p><span class="censored">I</span> <span class="censored">am</span> <span class="censored">hoping</span> <span class="censored">to</span> <span class="censored">write</span> <span class="censored">more</span> <span class="censored">about</span> <span class="censored">SSA</span> <span class="censored">optimization</span> <span class="censored">passes.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">rich</span> <span class="censored">subject,</span> <span class="censored">and</span> <span class="censored">viewing</span> <span class="censored">optimizations</span> <span class="censored">in</span> <span class="censored">isolation</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">great</span> <span class="censored">way</span> <span class="censored">to</span> <span class="censored">understand</span> <span class="censored">how</span> <span class="censored">a</span> <span class="censored">sophisticated</span> <span class="censored">optimization</span> <span class="censored">pipeline</span> <span class="censored">is</span> <span class="censored">built</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">simple,</span> <span class="censored">dumb</span> <span class="censored">components.</span></p> <p><span class="censored">It’s</span> <span class="censored">also</span> <span class="censored">a</span> <span class="censored">practical</span> <span class="censored">application</span> <span class="censored">of</span> <span class="censored">graph</span> <span class="censored">theory</span> <span class="censored">that</span> <span class="censored">shows</span> <span class="censored">just</span> <span class="censored">how</span> <span class="censored">powerful</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">be,</span> <span class="censored">and</span> <span class="censored">(at</span> <span class="censored">least</span> <span class="censored">in</span> <span class="censored">my</span> <span class="censored">opinion),</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">intuitive</span> <span class="censored">setting</span> <span class="censored">for</span> <span class="censored">understanding</span> <span class="censored">graph</span> <span class="censored">theory,</span> <span class="censored">which</span> <span class="censored">can</span> <span class="censored">feel</span> <span class="censored">very</span> <span class="censored">abstract</span> <span class="censored">otherwise.</span></p> <p><span class="censored">In</span> <span class="censored">the</span> <span class="censored">future,</span> <span class="censored">I’d</span> <span class="censored">like</span> <span class="censored">to</span> <span class="censored">cover</span> <span class="censored">CSE/GVN,</span> <span class="censored">loop</span> <span class="censored">optimizations,</span> <span class="censored">and,</span> <span class="censored">if</span> <span class="censored">I’m</span> <span class="censored">feeling</span> <span class="censored">brave,</span> <span class="censored">getting</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">SSA</span> <span class="censored">into</span> <span class="censored">a</span> <span class="censored">finite-register</span> <span class="censored">machine</span> <span class="censored">(backends</span> <span class="censored">are</span> <span class="censored">not</span> <span class="censored">my</span> <span class="censored">strong</span> <span class="censored">suit!).</span></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:swift" role="doc-endnote"> <p><span class="censored">Specifically</span> <span class="censored">the</span> <span class="censored">Swift</span> <span class="censored">frontend</span> <span class="censored">before</span> <span class="censored">lowering</span> <span class="censored">into</span> <span class="censored">LLVM</span> <span class="censored">IR. </span><a href="#fnref:swift" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:msvc" role="doc-endnote"> <p><span class="censored">Microsoft</span> <span class="censored">Visual</span> <span class="censored">C++,</span> <span class="censored">a</span> <span class="censored">non-conforming</span> <span class="censored">C++</span> <span class="censored">compiler</span> <span class="censored">sold</span> <span class="censored">by</span> <span class="censored">Microsoft </span><a href="#fnref:msvc" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:hotspot" role="doc-endnote"> <p><span class="censored">HotSpot</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">JVM</span> <span class="censored">implementation</span> <span class="censored">provided</span> <span class="censored">by</span> <span class="censored">OpenJDK;</span> <span class="censored">C2</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">“second</span> <span class="censored">compiler”,</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">the</span> <span class="censored">best</span> <span class="censored">performance</span> <span class="censored">among</span> <span class="censored">HotSpot’s</span> <span class="censored">Java</span> <span class="censored">execution</span> <span class="censored">engines. </span><a href="#fnref:hotspot" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:v8" role="doc-endnote"> <p><span class="censored">V8</span> <span class="censored">is</span> <span class="censored">Chromium’s</span> <span class="censored">JavaScript</span> <span class="censored">runtime. </span><a href="#fnref:v8" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:spidermonkey" role="doc-endnote"> <p><span class="censored">SpiderMonkey</span> <span class="censored">is</span> <span class="censored">Firefox’s</span> <span class="censored">JavaScript</span> <span class="censored">runtime. </span><a href="#fnref:spidermonkey" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:art" role="doc-endnote"> <p><span class="censored">The</span> <span class="censored">Android</span> <span class="censored">Runtime</span> <span class="censored">(ART)</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">“JVM”</span> <span class="censored">(scare</span> <span class="censored">quotes)</span> <span class="censored">on</span> <span class="censored">the</span> <span class="censored">Android</span> <span class="censored">platform. </span><a href="#fnref:art" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:ghc" role="doc-endnote"> <p><span class="censored">The</span> <span class="censored">Glasgow</span> <span class="censored">Haskell</span> <span class="censored">Compiler</span> <span class="censored">(GHC),</span> <span class="censored">does</span> <em><span class="censored">not</span></em> <span class="censored">use</span> <span class="censored">SSA;</span> <span class="censored">it</span> <span class="censored">(like</span> <span class="censored">some</span> <span class="censored">other</span> <span class="censored">pure-functional</span> <span class="censored">languages)</span> <span class="censored">uses</span> <span class="censored">a</span> <span class="censored">continuation-oriented</span> <span class="censored">IR</span> <span class="censored">(compare</span> <span class="censored">to</span> <span class="censored">Scheme’s</span> <code class="language-plaintext highlighter-rouge"><span class="censored">call/cc</span></code><span class="censored">). </span><a href="#fnref:ghc" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:p-np" role="doc-endnote"> <p><span class="censored">Every</span> <span class="censored">compiler</span> <span class="censored">person</span> <span class="censored">firmly</span> <span class="censored">believes</span> <span class="censored">that</span> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi><span class="censored">P</span></mi><mo mathvariant="normal"><span class="censored">≠</span></mo><mi><span class="censored">N</span></mi><mi><span class="censored">P</span></mi></mrow><annotation encoding="application/x-tex"><span class="censored">P</span> <span class="censored">\neq</span> <span class="censored">NP</span></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;"><span class="censored">P</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"><span class="censored"></span></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel"><span class="censored">=</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;"><span class="censored">NP</span></span></span></span></span></span><span class="censored">,</span> <span class="censored">because</span> <span class="censored">program</span> <span class="censored">optimization</span> <span class="censored">is</span> <span class="censored">full</span> <span class="censored">of</span> <span class="censored">NP-hard</span> <span class="censored">problems</span> <span class="censored">and</span> <span class="censored">we</span> <span class="censored">would</span> <span class="censored">have</span> <span class="censored">definitely</span> <span class="censored">found</span> <span class="censored">polynomial</span> <span class="censored">ideal</span> <span class="censored">register</span> <span class="censored">allocation</span> <span class="censored">by</span> <span class="censored">now</span> <span class="censored">if</span> <span class="censored">it</span> <span class="censored">existed. </span><a href="#fnref:p-np" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:non-cfg" role="doc-endnote"> <p><span class="censored">Some</span> <span class="censored">more</span> <span class="censored">recent</span> <span class="censored">IRs</span> <span class="censored">use</span> <span class="censored">a</span> <span class="censored">different</span> <span class="censored">version</span> <span class="censored">of</span> <span class="censored">SSA</span> <span class="censored">called</span> <span class="censored">“structured</span> <span class="censored">control</span> <span class="censored">flow”,</span> <span class="censored">or</span> <span class="censored">SCF.</span> <span class="censored">Wasm</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">notable</span> <span class="censored">example</span> <span class="censored">of</span> <span class="censored">an</span> <span class="censored">SCF</span> <span class="censored">IR.</span> <span class="censored">SSA-SCF</span> <span class="censored">is</span> <span class="censored">equivalent</span> <span class="censored">to</span> <span class="censored">SSA-CFG,</span> <span class="censored">and</span> <span class="censored">polynomial</span> <span class="censored">time</span> <span class="censored">algorithms</span> <span class="censored">exist</span> <span class="censored">for</span> <span class="censored">losslessly</span> <span class="censored">converting</span> <span class="censored">between</span> <span class="censored">them</span> <span class="censored">(LLVM</span> <span class="censored">compiling</span> <span class="censored">Wasm,</span> <span class="censored">for</span> <span class="censored">example,</span> <span class="censored">converts</span> <span class="censored">its</span> <span class="censored">CFG</span> <span class="censored">into</span> <span class="censored">SCF</span> <span class="censored">using</span> <span class="censored">a</span> <span class="censored">“relooping</span> <span class="censored">algorithm”).</span></p> <p><span class="censored">In</span> <span class="censored">SCF,</span> <span class="censored">operations</span> <span class="censored">like</span> <span class="censored">switch</span> <span class="censored">statements</span> <span class="censored">and</span> <span class="censored">loops</span> <span class="censored">are</span> <span class="censored">represented</span> <span class="censored">as</span> <span class="censored">macro</span> <span class="censored">operations</span> <span class="censored">that</span> <em><span class="censored">contain</span></em> <span class="censored">basic</span> <span class="censored">blocks.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">switch</span></code> <span class="censored">operation</span> <span class="censored">might</span> <span class="censored">take</span> <span class="censored">a</span> <span class="censored">value</span> <span class="censored">as</span> <span class="censored">input,</span> <span class="censored">select</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">to</span> <span class="censored">execute</span> <span class="censored">based</span> <span class="censored">on</span> <span class="censored">that,</span> <span class="censored">and</span> <span class="censored">return</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">that</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">evaluates</span> <span class="censored">to</span> <span class="censored">as</span> <span class="censored">its</span> <span class="censored">output.</span></p> <p><a href="https://arxiv.org/abs/1912.05036"><span class="censored">RVSDG</span></a> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">notable</span> <span class="censored">innovation</span> <span class="censored">in</span> <span class="censored">this</span> <span class="censored">space,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">allows</span> <span class="censored">circuit</span> <span class="censored">analysis</span> <span class="censored">of</span> <span class="censored">entire</span> <span class="censored">imperative</span> <span class="censored">programs.</span></p> <p><span class="censored">I</span> <span class="censored">am</span> <span class="censored">convering</span> <span class="censored">SSA-CFG</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">SSA-SCF</span> <span class="censored">simply</span> <span class="censored">because</span> <span class="censored">it’s</span> <span class="censored">more</span> <span class="censored">common,</span> <span class="censored">and</span> <span class="censored">because</span> <span class="censored">it’s</span> <span class="censored">what</span> <span class="censored">LLVM</span> <span class="censored">IR</span> <span class="censored">is.</span></p> <p><span class="censored">See</span> <span class="censored">also</span> <span class="censored">this</span> <a href="https://llvm.org/devmtg/2024-04/slides/TechnicalTalks/Bock-LiftingCFGs.pdf"><span class="censored">MLIR</span> <span class="censored">presentation</span></a> <span class="censored">for</span> <span class="censored">converting</span> <span class="censored">between</span> <span class="censored">the</span> <span class="censored">two. </span><a href="#fnref:non-cfg" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:tail-call" role="doc-endnote"> <p><span class="censored">Tail</span> <span class="censored">calling</span> <span class="censored">is</span> <span class="censored">when</span> <span class="censored">a</span> <span class="censored">function</span> <span class="censored">call</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">last</span> <span class="censored">operation</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">function;</span> <span class="censored">this</span> <span class="censored">allows</span> <span class="censored">the</span> <span class="censored">caller</span> <span class="censored">to</span> <span class="censored">jump</span> <span class="censored">directly</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">callee,</span> <span class="censored">recycling</span> <span class="censored">its</span> <span class="censored">own</span> <span class="censored">stack</span> <span class="censored">frame</span> <span class="censored">for</span> <span class="censored">it</span> <span class="censored">instead</span> <span class="censored">of</span> <span class="censored">requiring</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">allocate</span> <span class="censored">its</span> <span class="censored">own. </span><a href="#fnref:tail-call" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:acyclic" role="doc-endnote"> <p><span class="censored">Given</span> <span class="censored">any</span> <span class="censored">path</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@a</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@b</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">make</span> <span class="censored">it</span> <span class="censored">acyclic</span> <span class="censored">by</span> <span class="censored">replacing</span> <span class="censored">each</span> <span class="censored">subpath</span> <span class="censored">from</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@c</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@c</span></code> <span class="censored">with</span> <span class="censored">a</span> <span class="censored">single</span> <code class="language-plaintext highlighter-rouge"><span class="censored">@c</span></code> <span class="censored">node. </span><a href="#fnref:acyclic" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:equiv-reg" role="doc-endnote"> <p><span class="censored">When</span> <span class="censored">moving</span> <span class="censored">from</span> <span class="censored">a</span> <span class="censored">basic</span> <span class="censored">block</span> <span class="censored">to</span> <span class="censored">a</span> <span class="censored">pred,</span> <span class="censored">a</span> <span class="censored">register</span> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">block</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">defined</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">block</span> <span class="censored">parameter</span> <span class="censored">corresponds</span> <span class="censored">to</span> <span class="censored">some</span> <span class="censored">register</span> <span class="censored">(or</span> <span class="censored">immediate)</span> <span class="censored">in</span> <span class="censored">each</span> <span class="censored">predecessor.</span> <span class="censored">That</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">“equivalent”</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">%p</span></code><span class="censored">.</span></p> <p><span class="censored">One</span> <span class="censored">possible</span> <span class="censored">option</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">“equivalent”</span> <span class="censored">is</span> <span class="censored">an</span> <span class="censored">immediate:</span> <span class="censored">for</span> <span class="censored">example,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">null</span></code> <span class="censored">or</span> <span class="censored">the</span> <span class="censored">address</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">global.</span> <span class="censored">In</span> <span class="censored">the</span> <span class="censored">case</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">global</span> <code class="language-plaintext highlighter-rouge"><span class="censored">&amp;g</span></code><span class="censored">,</span> <span class="censored">assuming</span> <span class="censored">no</span> <span class="censored">data</span> <span class="censored">races,</span> <span class="censored">we</span> <span class="censored">would</span> <span class="censored">instead</span> <span class="censored">need</span> <span class="censored">alias</span> <span class="censored">information</span> <span class="censored">to</span> <span class="censored">tell</span> <span class="censored">if</span> <span class="censored">stores</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">global</span> <span class="censored">within</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">function</span> <span class="censored">(a)</span> <span class="censored">exist</span> <span class="censored">and</span> <span class="censored">(b)</span> <span class="censored">are</span> <span class="censored">liftable</span> <span class="censored">at</span> <span class="censored">all.</span></p> <p><span class="censored">If</span> <span class="censored">the</span> <span class="censored">equivalent</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">null</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">proceed</span> <span class="censored">in</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">two</span> <span class="censored">ways</span> <span class="censored">depending</span> <span class="censored">on</span> <span class="censored">optimization</span> <span class="censored">level.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">loads</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">null</span></code> <span class="censored">to</span> <span class="censored">trap</span> <span class="censored">(as</span> <span class="censored">in</span> <span class="censored">Go),</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">mark</span> <span class="censored">this</span> <span class="censored">load</span> <span class="censored">as</span> <span class="censored">not</span> <span class="censored">being</span> <span class="censored">liftable,</span> <span class="censored">because</span> <span class="censored">it</span> <span class="censored">may</span> <span class="censored">trap.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">loads</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">null</span></code> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">UB,</span> <span class="censored">we</span> <span class="censored">simply</span> <span class="censored">ignore</span> <span class="censored">that</span> <span class="censored">pred,</span> <span class="censored">because</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">assume</span> <span class="censored">(for</span> <span class="censored">our</span> <span class="censored">analysis)</span> <span class="censored">that</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">pointer</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">null</span></code><span class="censored">,</span> <span class="censored">it</span> <span class="censored">is</span> <span class="censored">never</span> <span class="censored">loaded</span> <span class="censored">from. </span><a href="#fnref:equiv-reg" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> <li id="fn:calls-only" role="doc-endnote"> <p><span class="censored">Returned</span> <span class="censored">stack</span> <span class="censored">pointers</span> <span class="censored">do</span> <em><span class="censored">not</span></em> <span class="censored">escape:</span> <span class="censored">stack</span> <span class="censored">slots’</span> <span class="censored">lifetimes</span> <span class="censored">end</span> <span class="censored">at</span> <span class="censored">function</span> <span class="censored">exit,</span> <span class="censored">so</span> <span class="censored">we</span> <span class="censored">return</span> <span class="censored">a</span> <span class="censored">dangling</span> <span class="censored">pointer,</span> <span class="censored">which</span> <span class="censored">we</span> <span class="censored">assume</span> <span class="censored">are</span> <span class="censored">never</span> <span class="censored">loaded.</span> <span class="censored">So</span> <span class="censored">stores</span> <span class="censored">to</span> <span class="censored">that</span> <span class="censored">pointer</span> <span class="censored">before</span> <span class="censored">returning</span> <span class="censored">it</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">discarded. </span><a href="#fnref:calls-only" class="reversefootnote" role="doc-backlink"><span class="censored">↩</span></a></p> </li> </ol> </div> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-10-30</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/10/30/living-room-2/"><span class="censored">Living</span> <span class="censored">Room</span> <span class="censored">2</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-10-28</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/10/28/boombox-boobs/"><span class="censored">Boombox</span> <span class="censored">Boobs</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-10-27</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/10/27/living-room/"><span class="censored">Living</span> <span class="censored">Room</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> &copy; 2025 Miguel Young de la Sota <br> <div style="font-size: 95%;"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> </div> </div> </div> </body> </html>