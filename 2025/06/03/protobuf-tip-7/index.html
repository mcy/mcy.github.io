<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Protobuf Tip #7: Scoping It Out &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Protobuf Tip #7: Scoping It Out &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/protobuf-tip-7-be6351606bdcf3415f28e44a9b389da199807807.png"> <meta property="og:title" content="Protobuf Tip #7: Scoping It Out &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/protobuf-tip-7-be6351606bdcf3415f28e44a9b389da199807807.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/06/03/protobuf-tip-7/"> <link rel="canonical" href="https://buf.build/blog/totw-7-scoping-it-out"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-06-03 • 874 words • 9 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/06/03/protobuf-tip-7/"> Protobuf Tip #7: Scoping It Out </a></h1> </div> <div class="post"> <p><em>You’d need a very specialized electron microscope to get down to the level to actually see a single strand of DNA. – Craig Venter</em></p> <p>TL;DR: <code class="language-plaintext highlighter-rouge">buf convert</code> is a powerful tool for examining wire format dumps, by converting them to JSON and using existing JSON analysis tooling. <code class="language-plaintext highlighter-rouge">protoscope</code> can be used for lower-level analysis, such debugging messages that have been corrupted.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-7-scoping-it-out">buf.build blog</a>.</p> </blockquote> <h2 id="json-from-protobuf"><a href="#json-from-protobuf">JSON from Protobuf?</a></h2> <p>JSON’s human-readable syntax is a big reason why it’s so popular, possibly second only to built-in support in browsers and many languages. It’s easy to examine any JSON document using tools like online prettifiers and the inimitable <code class="language-plaintext highlighter-rouge">jq</code>.</p> <p>But Protobuf is a binary format! This means that you can’t easily use <code class="language-plaintext highlighter-rouge">jq</code> -like tools with it…or can you?</p> <h2 id="transcoding-with-buf-convert"><a href="#transcoding-with-buf-convert">Transcoding with <code class="language-plaintext highlighter-rouge">buf convert</code></a></h2> <p>The Buf CLI offers a utility for transcoding messages between the three Protobuf encoding formats: the wire format, JSON, and textproto; it also supports YAML. This is <code class="language-plaintext highlighter-rouge">buf convert</code>, and it’s very powerful.</p> <p>To perform a conversion, we need four inputs:</p> <ol> <li>A Protobuf source to get types out of. This can be a local <code class="language-plaintext highlighter-rouge">.proto</code> file, an encoded <code class="language-plaintext highlighter-rouge">FileDescriptorSet</code> , or a remote BSR module. <ul> <li>If not provided, but run in a directory that is within a local Buf module, that module will be used as the Protobuf type source.</li> </ul> </li> <li>The name of the top-level type for the message we want to transcode, via the <code class="language-plaintext highlighter-rouge">--type</code> flag.</li> <li>The input message, via the <code class="language-plaintext highlighter-rouge">--from</code> flag.</li> <li>A location to output to, via the <code class="language-plaintext highlighter-rouge">--to</code> flag.</li> </ol> <p><code class="language-plaintext highlighter-rouge">buf convert</code> supports input and output redirection, making it usable as part of a shell pipeline. For example, consider the following Protobuf code in our local Buf module:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="c1">// my_api.proto</span>
<span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
<span class="kn">package</span> <span class="nn">my</span><span class="o">.</span><span class="n">api.v1</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Cart</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">user_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="n">Order</span> <span class="na">orders</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Order</span> <span class="p">{</span>
  <span class="kt">fixed64</span> <span class="na">sku</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">sku_name</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int64</span> <span class="na">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>Then, let’s say we’ve dumped a message of type <code class="language-plaintext highlighter-rouge">my.api.v1.Cart</code> from a service to debug it. And let’s say…well—you can’t just <code class="language-plaintext highlighter-rouge">cat</code> it.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>dump.pb | xxd <span class="nt">-ps</span>
<span class="go">08a946121b097ac8e80400000000120e76616375756d20636c65616e6572
18011220096709b519000000001213686570612066696c7465722c203220
7061636b1806122c093aa8188900000000121f69736f70726f70796c2061
6c636f686f6c203730252c20312067616c6c6f6e1802</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>However, we can use <code class="language-plaintext highlighter-rouge">buf convert</code> to turn it into some nice JSON. We can then pipe it into <code class="language-plaintext highlighter-rouge">jq</code> to format it.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>buf convert <span class="nt">--type</span> my.api.v1.Cart <span class="nt">--from</span> dump.pb <span class="nt">--to</span> -#format<span class="o">=</span>json | jq
<span class="go">{
  "userId": 9001,
  "orders": [
    {
      "sku": "82364538",
      "skuName": "vacuum cleaner",
      "count": "1"
    },
    {
      "sku": "431294823",
      "skuName": "hepa filter, 2 pack",
      "count": "6"
    },
    {
	    "sku": "2300094522",
      "skuName": "isopropyl alcohol 70%, 1 gallon",
      "count": "2"
    }
  ]
}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Now you have the full expressivity of <code class="language-plaintext highlighter-rouge">jq</code> at your disposal. For example, we could pull out the user ID for the cart:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="k">function </span>buf-jq<span class="o">()</span> <span class="o">{</span> buf convert <span class="nt">--type</span> <span class="nv">$1</span> <span class="nt">--from</span> <span class="nv">$2</span> <span class="nt">--to</span> -#format<span class="o">=</span>json | jq <span class="nv">$3</span> <span class="o">}</span>
<span class="gp">$</span><span class="w"> </span>buf-jq my.api.v1.Cart dump.pb <span class="s1">'.userId'</span>
<span class="go">9001</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Or we can extract all of the SKUs that appear in the cart:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>buf-jq my.api.v1.Cart dump.pb <span class="s1">'[.orders[].sku]'</span>
<span class="go">[
  "82364538",
  "431294823",
  "2300094522"
]</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Or we could try calculating how many items are in the cart, total:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>buf-jq my.api.v1.Cart dump.pb <span class="s1">'[.orders[].count] | add'</span>
<span class="go">"162"</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Wait. That’s wrong. The answer should be <code class="language-plaintext highlighter-rouge">9</code>. This illustrates one pitfall to keep in mind when using <code class="language-plaintext highlighter-rouge">jq</code> with Protobuf. Protobuf will <em>sometimes</em> serialize numbers as quoted strings (the C++ reference implementation only does this when they’re integers outside of the IEEE754 representable range, but Go is somewhat lazier, and does it for all 64-bit values).</p> <blockquote> <p>You can test if an <code class="language-plaintext highlighter-rouge">x int64</code> is in the representable float range with this very simple check: <code class="language-plaintext highlighter-rouge">int64(float64(x)) == x)</code>. See <a href="https://go.dev/play/p/T81SbbFg3br">https://go.dev/play/p/T81SbbFg3br</a>. The <a href="https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/json/internal/unparser.cc#L96">equivalent version in C++</a> is much more complicated.</p> </blockquote> <p>This means we need to use the <code class="language-plaintext highlighter-rouge">tonumber</code> conversion function:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>buf-jq my.api.v1.Cart dump.pb <span class="s1">'[.orders[].count | tonumber] | add'</span>
<span class="go">9</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p><code class="language-plaintext highlighter-rouge">jq</code> ’s whole deal is JSON, so it brings with it all of JSON’s pitfalls. This is notable for Protobuf when trying to do arithmetic on 64-bit values. As we saw above, Protobuf serializes integers outside of the 64-bit float representable range (and in some runtimes, some integers inside it).</p> <p>For example, if you have a <code class="language-plaintext highlighter-rouge">repeated int64</code> that you want to sum over, it may produce incorrect answers due to floating-point rounding. For notes on conversions in <code class="language-plaintext highlighter-rouge">jq</code>, see <a href="https://jqlang.org/manual/#identity">https://jqlang.org/manual/#identity</a>.</p> <h2 id="disassembling-with-protoscope"><a href="#disassembling-with-protoscope">Disassembling with <code class="language-plaintext highlighter-rouge">protoscope</code></a></h2> <p><a href="https://github.com/protocolbuffers/protoscope"><code class="language-plaintext highlighter-rouge">protoscope</code></a> is a tool provided by the Protobuf team (which I originally wrote!) for decoding arbitrary data as if it were encoded in the Protobuf wire format. This process is called <em>disassembly</em>. It’s designed to work without a schema available, although it doesn’t produce especially clean output.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>go <span class="nb">install </span>github.com/protocolbuffers/protoscope/cmd/protoscope...@latest
<span class="gp">$</span><span class="w"> </span>protoscope dump.pb
<span class="go">1: 9001
2: {
  1: 82364538i64
  2: {"vacuum cleaner"}
  3: 1
}
2: {
  1: 431294823i64
  2: {
    13: 101
    14: 97
    4: 102
</span><span class="gp">    13: 1.3518748403899336e-153   #</span><span class="w"> </span>0x2032202c7265746ci64
<span class="go">    14: 97
    12:SGROUP
    13:SGROUP
  }
  3: 6
}
2: {
  1: 2300094522i64
  2: {"isopropyl alcohol 70%, 1 gallon"}
  3: 2
}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>The field names are gone; only field numbers are shown. This example also reveals an especially glaring limitation of <code class="language-plaintext highlighter-rouge">protoscope</code>, which is that it can’t tell the difference between string and message fields, so it guesses according to some heuristics. For the first and third elements it was able to grok them as strings, but for <code class="language-plaintext highlighter-rouge">orders[1].sku_name</code>, it incorrectly guessed it was a message and produced garbage.</p> <p>The tradeoff is that not only does <code class="language-plaintext highlighter-rouge">protoscope</code> not need a schema, it also tolerates almost any error, making it possible to analyze messages that have been partly corrupted. If we flip a random bit somewhere in <code class="language-plaintext highlighter-rouge">orders[0]</code>, disassembling the message still succeeds:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>protoscope dump.pb
<span class="go">1: 9001
2: {`0f7ac8e80400000000120e76616375756d20636c65616e65721801`}
2: {
  1: 431294823i64
  2: {
    13: 101
    14: 97
    4: 102
</span><span class="gp">    13: 1.3518748403899336e-153   #</span><span class="w"> </span>0x2032202c7265746ci64
<span class="go">    14: 97
    12:SGROUP
    13:SGROUP
  }
  3: 6
}
2: {
  1: 2300094522i64
  2: {"isopropyl alcohol 70%, 1 gallon"}
  3: 2
}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Although <code class="language-plaintext highlighter-rouge">protoscope</code> did give up on disassembling the corrupted submessage, it still made it through the rest of the dump.</p> <p>Like <code class="language-plaintext highlighter-rouge">buf convert</code>, we can give <code class="language-plaintext highlighter-rouge">protoscope</code> a <code class="language-plaintext highlighter-rouge">FileDescriptorSet</code> to make its heuristic a little smarter.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>protoscope <span class="se">\</span>
<span class="go">  --descriptor-set &lt;(buf build -o -) \
  --message-type my.api.v1.Cart \
  --print-field-names \
  dump.pb
</span><span class="gp">1: 9001                   #</span><span class="w"> </span>user_id
<span class="gp">2: {                      #</span><span class="w"> </span>orders
<span class="gp">  1: 82364538i64          #</span><span class="w"> </span>sku
<span class="gp">  2: {"vacuum cleaner"}   #</span><span class="w"> </span>sku_name
<span class="gp">  3: 1                    #</span><span class="w"> </span>count
<span class="go">}
</span><span class="gp">2: {                          #</span><span class="w"> </span>orders
<span class="gp">  1: 431294823i64             #</span><span class="w"> </span>sku
<span class="gp">  2: {"hepa filter, 2 pack"}  #</span><span class="w"> </span>sku_name
<span class="gp">  3: 6                        #</span><span class="w"> </span>count
<span class="go">}
</span><span class="gp">2: {                                      #</span><span class="w"> </span>orders
<span class="gp">  1: 2300094522i64                        #</span><span class="w"> </span>sku
<span class="gp">  2: {"isopropyl alcohol 70%, 1 gallon"}  #</span><span class="w"> </span>sku_name
<span class="gp">  3: 2                                    #</span><span class="w"> </span>count
<span class="go">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Not only is the second order decoded correctly now, but <code class="language-plaintext highlighter-rouge">protoscope</code> shows the name of each field (via <code class="language-plaintext highlighter-rouge">--print-field-names</code> ). In this mode, <code class="language-plaintext highlighter-rouge">protoscope</code> still decodes partially-valid messages.</p> <p><code class="language-plaintext highlighter-rouge">protoscope</code> also provides a number of other flags for customizing its heuristic in the absence of a <code class="language-plaintext highlighter-rouge">FileDescriporSet</code>. This enables it to be used as a forensic tool for debugging messy data corruption bugs.</p> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-07-16</span> / <h6 style="display:inline"><a href="/2025/07/16/hyperpb/">Parsing Protobuf Like Never Before</a></h6> <li> <span class="post-meta">2025-07-14</span> / <h6 style="display:inline"><a href="/2025/07/14/best/">The Best C++ Library</a></h6> <li> <span class="post-meta">2025-07-07</span> / <h6 style="display:inline"><a href="/2025/07/07/nosplit/">What's //go:nosplit for?</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-06-03</span> <span class="censored">•</span> <span class="censored">874</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">9</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips"><span class="censored">#protobuf-tips</span></a> </span> <h1><a href="/2025/06/03/protobuf-tip-7/"> <span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#7:</span> <span class="censored">Scoping</span> <span class="censored">It</span> <span class="censored">Out</span> </a></h1> </div> <div class="post"> <p><em><span class="censored">You’d</span> <span class="censored">need</span> <span class="censored">a</span> <span class="censored">very</span> <span class="censored">specialized</span> <span class="censored">electron</span> <span class="censored">microscope</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">down</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">level</span> <span class="censored">to</span> <span class="censored">actually</span> <span class="censored">see</span> <span class="censored">a</span> <span class="censored">single</span> <span class="censored">strand</span> <span class="censored">of</span> <span class="censored">DNA.</span> <span class="censored">–</span> <span class="censored">Craig</span> <span class="censored">Venter</span></em></p> <p><span class="censored">TL;DR:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">buf</span> <span class="censored">convert</span></code> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">powerful</span> <span class="censored">tool</span> <span class="censored">for</span> <span class="censored">examining</span> <span class="censored">wire</span> <span class="censored">format</span> <span class="censored">dumps,</span> <span class="censored">by</span> <span class="censored">converting</span> <span class="censored">them</span> <span class="censored">to</span> <span class="censored">JSON</span> <span class="censored">and</span> <span class="censored">using</span> <span class="censored">existing</span> <span class="censored">JSON</span> <span class="censored">analysis</span> <span class="censored">tooling.</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">lower-level</span> <span class="censored">analysis,</span> <span class="censored">such</span> <span class="censored">debugging</span> <span class="censored">messages</span> <span class="censored">that</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">corrupted.</span></p> <blockquote> <p><span class="censored">I’m</span> <span class="censored">editing</span> <span class="censored">a</span> <span class="censored">series</span> <span class="censored">of</span> <span class="censored">best</span> <span class="censored">practice</span> <span class="censored">pieces</span> <span class="censored">on</span> <span class="censored">Protobuf,</span> <span class="censored">a</span> <span class="censored">language</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">work</span> <span class="censored">on</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">lots</span> <span class="censored">of</span> <span class="censored">evil</span> <span class="censored">corner-cases.These</span> <span class="censored">are</span> <span class="censored">shorter</span> <span class="censored">than</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">typically</span> <span class="censored">post</span> <span class="censored">here,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">think</span> <span class="censored">it</span> <span class="censored">fits</span> <span class="censored">with</span> <span class="censored">what</span> <span class="censored">you,</span> <span class="censored">dear</span> <span class="censored">reader,</span> <span class="censored">come</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">blog</span> <span class="censored">for.</span> <span class="censored">These</span> <span class="censored">tips</span> <span class="censored">are</span> <span class="censored">also</span> <span class="censored">posted</span> <span class="censored">on</span> <span class="censored">the</span> <a href="https://buf.build/blog/totw-7-scoping-it-out"><span class="censored">buf.build</span> <span class="censored">blog</span></a><span class="censored">.</span></p> </blockquote> <h2 id="json-from-protobuf"><a href="#json-from-protobuf"><span class="censored">JSON</span> <span class="censored">from</span> <span class="censored">Protobuf?</span></a></h2> <p><span class="censored">JSON’s</span> <span class="censored">human-readable</span> <span class="censored">syntax</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">big</span> <span class="censored">reason</span> <span class="censored">why</span> <span class="censored">it’s</span> <span class="censored">so</span> <span class="censored">popular,</span> <span class="censored">possibly</span> <span class="censored">second</span> <span class="censored">only</span> <span class="censored">to</span> <span class="censored">built-in</span> <span class="censored">support</span> <span class="censored">in</span> <span class="censored">browsers</span> <span class="censored">and</span> <span class="censored">many</span> <span class="censored">languages.</span> <span class="censored">It’s</span> <span class="censored">easy</span> <span class="censored">to</span> <span class="censored">examine</span> <span class="censored">any</span> <span class="censored">JSON</span> <span class="censored">document</span> <span class="censored">using</span> <span class="censored">tools</span> <span class="censored">like</span> <span class="censored">online</span> <span class="censored">prettifiers</span> <span class="censored">and</span> <span class="censored">the</span> <span class="censored">inimitable</span> <code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code><span class="censored">.</span></p> <p><span class="censored">But</span> <span class="censored">Protobuf</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">binary</span> <span class="censored">format!</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">can’t</span> <span class="censored">easily</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code> <span class="censored">-like</span> <span class="censored">tools</span> <span class="censored">with</span> <span class="censored">it…or</span> <span class="censored">can</span> <span class="censored">you?</span></p> <h2 id="transcoding-with-buf-convert"><a href="#transcoding-with-buf-convert"><span class="censored">Transcoding</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">buf</span> <span class="censored">convert</span></code></a></h2> <p><span class="censored">The</span> <span class="censored">Buf</span> <span class="censored">CLI</span> <span class="censored">offers</span> <span class="censored">a</span> <span class="censored">utility</span> <span class="censored">for</span> <span class="censored">transcoding</span> <span class="censored">messages</span> <span class="censored">between</span> <span class="censored">the</span> <span class="censored">three</span> <span class="censored">Protobuf</span> <span class="censored">encoding</span> <span class="censored">formats:</span> <span class="censored">the</span> <span class="censored">wire</span> <span class="censored">format,</span> <span class="censored">JSON,</span> <span class="censored">and</span> <span class="censored">textproto;</span> <span class="censored">it</span> <span class="censored">also</span> <span class="censored">supports</span> <span class="censored">YAML.</span> <span class="censored">This</span> <span class="censored">is</span> <code class="language-plaintext highlighter-rouge"><span class="censored">buf</span> <span class="censored">convert</span></code><span class="censored">,</span> <span class="censored">and</span> <span class="censored">it’s</span> <span class="censored">very</span> <span class="censored">powerful.</span></p> <p><span class="censored">To</span> <span class="censored">perform</span> <span class="censored">a</span> <span class="censored">conversion,</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">four</span> <span class="censored">inputs:</span></p> <ol> <li> <span class="censored">A</span> <span class="censored">Protobuf</span> <span class="censored">source</span> <span class="censored">to</span> <span class="censored">get</span> <span class="censored">types</span> <span class="censored">out</span> <span class="censored">of.</span> <span class="censored">This</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">a</span> <span class="censored">local</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.proto</span></code> <span class="censored">file,</span> <span class="censored">an</span> <span class="censored">encoded</span> <code class="language-plaintext highlighter-rouge"><span class="censored">FileDescriptorSet</span></code> <span class="censored">,</span> <span class="censored">or</span> <span class="censored">a</span> <span class="censored">remote</span> <span class="censored">BSR</span> <span class="censored">module.</span> <ul> <li> <span class="censored">If</span> <span class="censored">not</span> <span class="censored">provided,</span> <span class="censored">but</span> <span class="censored">run</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">directory</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">within</span> <span class="censored">a</span> <span class="censored">local</span> <span class="censored">Buf</span> <span class="censored">module,</span> <span class="censored">that</span> <span class="censored">module</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">Protobuf</span> <span class="censored">type</span> <span class="censored">source.</span> </li> </ul> </li> <li> <span class="censored">The</span> <span class="censored">name</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">top-level</span> <span class="censored">type</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">message</span> <span class="censored">we</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">transcode,</span> <span class="censored">via</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">--type</span></code> <span class="censored">flag.</span> </li> <li> <span class="censored">The</span> <span class="censored">input</span> <span class="censored">message,</span> <span class="censored">via</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">--from</span></code> <span class="censored">flag.</span> </li> <li> <span class="censored">A</span> <span class="censored">location</span> <span class="censored">to</span> <span class="censored">output</span> <span class="censored">to,</span> <span class="censored">via</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">--to</span></code> <span class="censored">flag.</span> </li> </ol> <p><code class="language-plaintext highlighter-rouge"><span class="censored">buf</span> <span class="censored">convert</span></code> <span class="censored">supports</span> <span class="censored">input</span> <span class="censored">and</span> <span class="censored">output</span> <span class="censored">redirection,</span> <span class="censored">making</span> <span class="censored">it</span> <span class="censored">usable</span> <span class="censored">as</span> <span class="censored">part</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">shell</span> <span class="censored">pipeline.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">consider</span> <span class="censored">the</span> <span class="censored">following</span> <span class="censored">Protobuf</span> <span class="censored">code</span> <span class="censored">in</span> <span class="censored">our</span> <span class="censored">local</span> <span class="censored">Buf</span> <span class="censored">module:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="c1"><span class="censored">//</span> <span class="censored">my_api.proto</span></span>
<span class="na"><span class="censored">syntax</span></span> <span class="o"><span class="censored">=</span></span> <span class="s"><span class="censored">"proto3"</span></span><span class="p"><span class="censored">;</span></span>
<span class="kn"><span class="censored">package</span></span> <span class="nn"><span class="censored">my</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">api.v1</span></span><span class="p"><span class="censored">;</span></span>

<span class="kd"><span class="censored">message</span></span> <span class="nc"><span class="censored">Cart</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">int32</span></span> <span class="na"><span class="censored">user_id</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="k"><span class="censored">repeated</span></span> <span class="n"><span class="censored">Order</span></span> <span class="na"><span class="censored">orders</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span>

<span class="kd"><span class="censored">message</span></span> <span class="nc"><span class="censored">Order</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="kt"><span class="censored">fixed64</span></span> <span class="na"><span class="censored">sku</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">string</span></span> <span class="na"><span class="censored">sku_name</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">2</span></span><span class="p"><span class="censored">;</span></span>
  <span class="kt"><span class="censored">int64</span></span> <span class="na"><span class="censored">count</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">3</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Protobuf</span></div></div> </div> <p><span class="censored">Then,</span> <span class="censored">let’s</span> <span class="censored">say</span> <span class="censored">we’ve</span> <span class="censored">dumped</span> <span class="censored">a</span> <span class="censored">message</span> <span class="censored">of</span> <span class="censored">type</span> <code class="language-plaintext highlighter-rouge"><span class="censored">my.api.v1.Cart</span></code> <span class="censored">from</span> <span class="censored">a</span> <span class="censored">service</span> <span class="censored">to</span> <span class="censored">debug</span> <span class="censored">it.</span> <span class="censored">And</span> <span class="censored">let’s</span> <span class="censored">say…well—you</span> <span class="censored">can’t</span> <span class="censored">just</span> <code class="language-plaintext highlighter-rouge"><span class="censored">cat</span></code> <span class="censored">it.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="nb"><span class="censored">cat</span> </span><span class="censored">dump.pb</span> <span class="censored">|</span> <span class="censored">xxd</span> <span class="nt"><span class="censored">-ps</span></span>
<span class="go"><span class="censored">08a946121b097ac8e80400000000120e76616375756d20636c65616e6572</span>
<span class="censored">18011220096709b519000000001213686570612066696c7465722c203220</span>
<span class="censored">7061636b1806122c093aa8188900000000121f69736f70726f70796c2061</span>
<span class="censored">6c636f686f6c203730252c20312067616c6c6f6e1802</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">However,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">buf</span> <span class="censored">convert</span></code> <span class="censored">to</span> <span class="censored">turn</span> <span class="censored">it</span> <span class="censored">into</span> <span class="censored">some</span> <span class="censored">nice</span> <span class="censored">JSON.</span> <span class="censored">We</span> <span class="censored">can</span> <span class="censored">then</span> <span class="censored">pipe</span> <span class="censored">it</span> <span class="censored">into</span> <code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code> <span class="censored">to</span> <span class="censored">format</span> <span class="censored">it.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">buf</span> <span class="censored">convert</span> <span class="nt"><span class="censored">--type</span></span> <span class="censored">my.api.v1.Cart</span> <span class="nt"><span class="censored">--from</span></span> <span class="censored">dump.pb</span> <span class="nt"><span class="censored">--to</span></span> <span class="censored">-#format</span><span class="o"><span class="censored">=</span></span><span class="censored">json</span> <span class="censored">|</span> <span class="censored">jq</span>
<span class="go"><span class="censored">{</span>
  <span class="censored">"userId":</span> <span class="censored">9001,</span>
  <span class="censored">"orders":</span> <span class="censored">[</span>
    <span class="censored">{</span>
      <span class="censored">"sku":</span> <span class="censored">"82364538",</span>
      <span class="censored">"skuName":</span> <span class="censored">"vacuum</span> <span class="censored">cleaner",</span>
      <span class="censored">"count":</span> <span class="censored">"1"</span>
    <span class="censored">},</span>
    <span class="censored">{</span>
      <span class="censored">"sku":</span> <span class="censored">"431294823",</span>
      <span class="censored">"skuName":</span> <span class="censored">"hepa</span> <span class="censored">filter,</span> <span class="censored">2</span> <span class="censored">pack",</span>
      <span class="censored">"count":</span> <span class="censored">"6"</span>
    <span class="censored">},</span>
    <span class="censored">{</span>
	    <span class="censored">"sku":</span> <span class="censored">"2300094522",</span>
      <span class="censored">"skuName":</span> <span class="censored">"isopropyl</span> <span class="censored">alcohol</span> <span class="censored">70%,</span> <span class="censored">1</span> <span class="censored">gallon",</span>
      <span class="censored">"count":</span> <span class="censored">"2"</span>
    <span class="censored">}</span>
  <span class="censored">]</span>
<span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">Now</span> <span class="censored">you</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">full</span> <span class="censored">expressivity</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code> <span class="censored">at</span> <span class="censored">your</span> <span class="censored">disposal.</span> <span class="censored">For</span> <span class="censored">example,</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">pull</span> <span class="censored">out</span> <span class="censored">the</span> <span class="censored">user</span> <span class="censored">ID</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">cart:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="k"><span class="censored">function</span> </span><span class="censored">buf-jq</span><span class="o"><span class="censored">()</span></span> <span class="o"><span class="censored">{</span></span> <span class="censored">buf</span> <span class="censored">convert</span> <span class="nt"><span class="censored">--type</span></span> <span class="nv"><span class="censored">$1</span></span> <span class="nt"><span class="censored">--from</span></span> <span class="nv"><span class="censored">$2</span></span> <span class="nt"><span class="censored">--to</span></span> <span class="censored">-#format</span><span class="o"><span class="censored">=</span></span><span class="censored">json</span> <span class="censored">|</span> <span class="censored">jq</span> <span class="nv"><span class="censored">$3</span></span> <span class="o"><span class="censored">}</span></span>
<span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">buf-jq</span> <span class="censored">my.api.v1.Cart</span> <span class="censored">dump.pb</span> <span class="s1"><span class="censored">'.userId'</span></span>
<span class="go"><span class="censored">9001</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">Or</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">extract</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">SKUs</span> <span class="censored">that</span> <span class="censored">appear</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">cart:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">buf-jq</span> <span class="censored">my.api.v1.Cart</span> <span class="censored">dump.pb</span> <span class="s1"><span class="censored">'[.orders[].sku]'</span></span>
<span class="go"><span class="censored">[</span>
  <span class="censored">"82364538",</span>
  <span class="censored">"431294823",</span>
  <span class="censored">"2300094522"</span>
<span class="censored">]</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">Or</span> <span class="censored">we</span> <span class="censored">could</span> <span class="censored">try</span> <span class="censored">calculating</span> <span class="censored">how</span> <span class="censored">many</span> <span class="censored">items</span> <span class="censored">are</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">cart,</span> <span class="censored">total:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">buf-jq</span> <span class="censored">my.api.v1.Cart</span> <span class="censored">dump.pb</span> <span class="s1"><span class="censored">'[.orders[].count]</span> <span class="censored">|</span> <span class="censored">add'</span></span>
<span class="go"><span class="censored">"162"</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">Wait.</span> <span class="censored">That’s</span> <span class="censored">wrong.</span> <span class="censored">The</span> <span class="censored">answer</span> <span class="censored">should</span> <span class="censored">be</span> <code class="language-plaintext highlighter-rouge"><span class="censored">9</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">illustrates</span> <span class="censored">one</span> <span class="censored">pitfall</span> <span class="censored">to</span> <span class="censored">keep</span> <span class="censored">in</span> <span class="censored">mind</span> <span class="censored">when</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code> <span class="censored">with</span> <span class="censored">Protobuf.</span> <span class="censored">Protobuf</span> <span class="censored">will</span> <em><span class="censored">sometimes</span></em> <span class="censored">serialize</span> <span class="censored">numbers</span> <span class="censored">as</span> <span class="censored">quoted</span> <span class="censored">strings</span> <span class="censored">(the</span> <span class="censored">C++</span> <span class="censored">reference</span> <span class="censored">implementation</span> <span class="censored">only</span> <span class="censored">does</span> <span class="censored">this</span> <span class="censored">when</span> <span class="censored">they’re</span> <span class="censored">integers</span> <span class="censored">outside</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">IEEE754</span> <span class="censored">representable</span> <span class="censored">range,</span> <span class="censored">but</span> <span class="censored">Go</span> <span class="censored">is</span> <span class="censored">somewhat</span> <span class="censored">lazier,</span> <span class="censored">and</span> <span class="censored">does</span> <span class="censored">it</span> <span class="censored">for</span> <span class="censored">all</span> <span class="censored">64-bit</span> <span class="censored">values).</span></p> <blockquote> <p><span class="censored">You</span> <span class="censored">can</span> <span class="censored">test</span> <span class="censored">if</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">x</span> <span class="censored">int64</span></code> <span class="censored">is</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">representable</span> <span class="censored">float</span> <span class="censored">range</span> <span class="censored">with</span> <span class="censored">this</span> <span class="censored">very</span> <span class="censored">simple</span> <span class="censored">check:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">int64(float64(x))</span> <span class="censored">==</span> <span class="censored">x)</span></code><span class="censored">.</span> <span class="censored">See</span> <a href="https://go.dev/play/p/T81SbbFg3br"><span class="censored">https://go.dev/play/p/T81SbbFg3br</span></a><span class="censored">.</span> <span class="censored">The</span> <a href="https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/json/internal/unparser.cc#L96"><span class="censored">equivalent</span> <span class="censored">version</span> <span class="censored">in</span> <span class="censored">C++</span></a> <span class="censored">is</span> <span class="censored">much</span> <span class="censored">more</span> <span class="censored">complicated.</span></p> </blockquote> <p><span class="censored">This</span> <span class="censored">means</span> <span class="censored">we</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">use</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">tonumber</span></code> <span class="censored">conversion</span> <span class="censored">function:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">buf-jq</span> <span class="censored">my.api.v1.Cart</span> <span class="censored">dump.pb</span> <span class="s1"><span class="censored">'[.orders[].count</span> <span class="censored">|</span> <span class="censored">tonumber]</span> <span class="censored">|</span> <span class="censored">add'</span></span>
<span class="go"><span class="censored">9</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code> <span class="censored">’s</span> <span class="censored">whole</span> <span class="censored">deal</span> <span class="censored">is</span> <span class="censored">JSON,</span> <span class="censored">so</span> <span class="censored">it</span> <span class="censored">brings</span> <span class="censored">with</span> <span class="censored">it</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">JSON’s</span> <span class="censored">pitfalls.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">notable</span> <span class="censored">for</span> <span class="censored">Protobuf</span> <span class="censored">when</span> <span class="censored">trying</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">arithmetic</span> <span class="censored">on</span> <span class="censored">64-bit</span> <span class="censored">values.</span> <span class="censored">As</span> <span class="censored">we</span> <span class="censored">saw</span> <span class="censored">above,</span> <span class="censored">Protobuf</span> <span class="censored">serializes</span> <span class="censored">integers</span> <span class="censored">outside</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">64-bit</span> <span class="censored">float</span> <span class="censored">representable</span> <span class="censored">range</span> <span class="censored">(and</span> <span class="censored">in</span> <span class="censored">some</span> <span class="censored">runtimes,</span> <span class="censored">some</span> <span class="censored">integers</span> <span class="censored">inside</span> <span class="censored">it).</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <span class="censored">if</span> <span class="censored">you</span> <span class="censored">have</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">repeated</span> <span class="censored">int64</span></code> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">want</span> <span class="censored">to</span> <span class="censored">sum</span> <span class="censored">over,</span> <span class="censored">it</span> <span class="censored">may</span> <span class="censored">produce</span> <span class="censored">incorrect</span> <span class="censored">answers</span> <span class="censored">due</span> <span class="censored">to</span> <span class="censored">floating-point</span> <span class="censored">rounding.</span> <span class="censored">For</span> <span class="censored">notes</span> <span class="censored">on</span> <span class="censored">conversions</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">jq</span></code><span class="censored">,</span> <span class="censored">see</span> <a href="https://jqlang.org/manual/#identity"><span class="censored">https://jqlang.org/manual/#identity</span></a><span class="censored">.</span></p> <h2 id="disassembling-with-protoscope"><a href="#disassembling-with-protoscope"><span class="censored">Disassembling</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code></a></h2> <p><a href="https://github.com/protocolbuffers/protoscope"><code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code></a> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">tool</span> <span class="censored">provided</span> <span class="censored">by</span> <span class="censored">the</span> <span class="censored">Protobuf</span> <span class="censored">team</span> <span class="censored">(which</span> <span class="censored">I</span> <span class="censored">originally</span> <span class="censored">wrote!)</span> <span class="censored">for</span> <span class="censored">decoding</span> <span class="censored">arbitrary</span> <span class="censored">data</span> <span class="censored">as</span> <span class="censored">if</span> <span class="censored">it</span> <span class="censored">were</span> <span class="censored">encoded</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">Protobuf</span> <span class="censored">wire</span> <span class="censored">format.</span> <span class="censored">This</span> <span class="censored">process</span> <span class="censored">is</span> <span class="censored">called</span> <em><span class="censored">disassembly</span></em><span class="censored">.</span> <span class="censored">It’s</span> <span class="censored">designed</span> <span class="censored">to</span> <span class="censored">work</span> <span class="censored">without</span> <span class="censored">a</span> <span class="censored">schema</span> <span class="censored">available,</span> <span class="censored">although</span> <span class="censored">it</span> <span class="censored">doesn’t</span> <span class="censored">produce</span> <span class="censored">especially</span> <span class="censored">clean</span> <span class="censored">output.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">go</span> <span class="nb"><span class="censored">install</span> </span><span class="censored">github.com/protocolbuffers/protoscope/cmd/protoscope...@latest</span>
<span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">protoscope</span> <span class="censored">dump.pb</span>
<span class="go"><span class="censored">1:</span> <span class="censored">9001</span>
<span class="censored">2:</span> <span class="censored">{</span>
  <span class="censored">1:</span> <span class="censored">82364538i64</span>
  <span class="censored">2:</span> <span class="censored">{"vacuum</span> <span class="censored">cleaner"}</span>
  <span class="censored">3:</span> <span class="censored">1</span>
<span class="censored">}</span>
<span class="censored">2:</span> <span class="censored">{</span>
  <span class="censored">1:</span> <span class="censored">431294823i64</span>
  <span class="censored">2:</span> <span class="censored">{</span>
    <span class="censored">13:</span> <span class="censored">101</span>
    <span class="censored">14:</span> <span class="censored">97</span>
    <span class="censored">4:</span> <span class="censored">102</span>
</span><span class="gp">    <span class="censored">13:</span> <span class="censored">1.3518748403899336e-153</span>   <span class="censored">#</span></span><span class="w"> </span><span class="censored">0x2032202c7265746ci64</span>
<span class="go">    <span class="censored">14:</span> <span class="censored">97</span>
    <span class="censored">12:SGROUP</span>
    <span class="censored">13:SGROUP</span>
  <span class="censored">}</span>
  <span class="censored">3:</span> <span class="censored">6</span>
<span class="censored">}</span>
<span class="censored">2:</span> <span class="censored">{</span>
  <span class="censored">1:</span> <span class="censored">2300094522i64</span>
  <span class="censored">2:</span> <span class="censored">{"isopropyl</span> <span class="censored">alcohol</span> <span class="censored">70%,</span> <span class="censored">1</span> <span class="censored">gallon"}</span>
  <span class="censored">3:</span> <span class="censored">2</span>
<span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">The</span> <span class="censored">field</span> <span class="censored">names</span> <span class="censored">are</span> <span class="censored">gone;</span> <span class="censored">only</span> <span class="censored">field</span> <span class="censored">numbers</span> <span class="censored">are</span> <span class="censored">shown.</span> <span class="censored">This</span> <span class="censored">example</span> <span class="censored">also</span> <span class="censored">reveals</span> <span class="censored">an</span> <span class="censored">especially</span> <span class="censored">glaring</span> <span class="censored">limitation</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code><span class="censored">,</span> <span class="censored">which</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">it</span> <span class="censored">can’t</span> <span class="censored">tell</span> <span class="censored">the</span> <span class="censored">difference</span> <span class="censored">between</span> <span class="censored">string</span> <span class="censored">and</span> <span class="censored">message</span> <span class="censored">fields,</span> <span class="censored">so</span> <span class="censored">it</span> <span class="censored">guesses</span> <span class="censored">according</span> <span class="censored">to</span> <span class="censored">some</span> <span class="censored">heuristics.</span> <span class="censored">For</span> <span class="censored">the</span> <span class="censored">first</span> <span class="censored">and</span> <span class="censored">third</span> <span class="censored">elements</span> <span class="censored">it</span> <span class="censored">was</span> <span class="censored">able</span> <span class="censored">to</span> <span class="censored">grok</span> <span class="censored">them</span> <span class="censored">as</span> <span class="censored">strings,</span> <span class="censored">but</span> <span class="censored">for</span> <code class="language-plaintext highlighter-rouge"><span class="censored">orders[1].sku_name</span></code><span class="censored">,</span> <span class="censored">it</span> <span class="censored">incorrectly</span> <span class="censored">guessed</span> <span class="censored">it</span> <span class="censored">was</span> <span class="censored">a</span> <span class="censored">message</span> <span class="censored">and</span> <span class="censored">produced</span> <span class="censored">garbage.</span></p> <p><span class="censored">The</span> <span class="censored">tradeoff</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">not</span> <span class="censored">only</span> <span class="censored">does</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">not</span> <span class="censored">need</span> <span class="censored">a</span> <span class="censored">schema,</span> <span class="censored">it</span> <span class="censored">also</span> <span class="censored">tolerates</span> <span class="censored">almost</span> <span class="censored">any</span> <span class="censored">error,</span> <span class="censored">making</span> <span class="censored">it</span> <span class="censored">possible</span> <span class="censored">to</span> <span class="censored">analyze</span> <span class="censored">messages</span> <span class="censored">that</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">partly</span> <span class="censored">corrupted.</span> <span class="censored">If</span> <span class="censored">we</span> <span class="censored">flip</span> <span class="censored">a</span> <span class="censored">random</span> <span class="censored">bit</span> <span class="censored">somewhere</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">orders[0]</span></code><span class="censored">,</span> <span class="censored">disassembling</span> <span class="censored">the</span> <span class="censored">message</span> <span class="censored">still</span> <span class="censored">succeeds:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">protoscope</span> <span class="censored">dump.pb</span>
<span class="go"><span class="censored">1:</span> <span class="censored">9001</span>
<span class="censored">2:</span> <span class="censored">{`0f7ac8e80400000000120e76616375756d20636c65616e65721801`}</span>
<span class="censored">2:</span> <span class="censored">{</span>
  <span class="censored">1:</span> <span class="censored">431294823i64</span>
  <span class="censored">2:</span> <span class="censored">{</span>
    <span class="censored">13:</span> <span class="censored">101</span>
    <span class="censored">14:</span> <span class="censored">97</span>
    <span class="censored">4:</span> <span class="censored">102</span>
</span><span class="gp">    <span class="censored">13:</span> <span class="censored">1.3518748403899336e-153</span>   <span class="censored">#</span></span><span class="w"> </span><span class="censored">0x2032202c7265746ci64</span>
<span class="go">    <span class="censored">14:</span> <span class="censored">97</span>
    <span class="censored">12:SGROUP</span>
    <span class="censored">13:SGROUP</span>
  <span class="censored">}</span>
  <span class="censored">3:</span> <span class="censored">6</span>
<span class="censored">}</span>
<span class="censored">2:</span> <span class="censored">{</span>
  <span class="censored">1:</span> <span class="censored">2300094522i64</span>
  <span class="censored">2:</span> <span class="censored">{"isopropyl</span> <span class="censored">alcohol</span> <span class="censored">70%,</span> <span class="censored">1</span> <span class="censored">gallon"}</span>
  <span class="censored">3:</span> <span class="censored">2</span>
<span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">Although</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">did</span> <span class="censored">give</span> <span class="censored">up</span> <span class="censored">on</span> <span class="censored">disassembling</span> <span class="censored">the</span> <span class="censored">corrupted</span> <span class="censored">submessage,</span> <span class="censored">it</span> <span class="censored">still</span> <span class="censored">made</span> <span class="censored">it</span> <span class="censored">through</span> <span class="censored">the</span> <span class="censored">rest</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">dump.</span></p> <p><span class="censored">Like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">buf</span> <span class="censored">convert</span></code><span class="censored">,</span> <span class="censored">we</span> <span class="censored">can</span> <span class="censored">give</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">FileDescriptorSet</span></code> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">its</span> <span class="censored">heuristic</span> <span class="censored">a</span> <span class="censored">little</span> <span class="censored">smarter.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp"><span class="censored">$</span></span><span class="w"> </span><span class="censored">protoscope</span> <span class="se"><span class="censored">\</span></span>
<span class="go">  <span class="censored">--descriptor-set</span> <span class="censored">&lt;(buf</span> <span class="censored">build</span> <span class="censored">-o</span> <span class="censored">-)</span> <span class="censored">\</span>
  <span class="censored">--message-type</span> <span class="censored">my.api.v1.Cart</span> <span class="censored">\</span>
  <span class="censored">--print-field-names</span> <span class="censored">\</span>
  <span class="censored">dump.pb</span>
</span><span class="gp"><span class="censored">1:</span> <span class="censored">9001</span>                   <span class="censored">#</span></span><span class="w"> </span><span class="censored">user_id</span>
<span class="gp"><span class="censored">2:</span> <span class="censored">{</span>                      <span class="censored">#</span></span><span class="w"> </span><span class="censored">orders</span>
<span class="gp">  <span class="censored">1:</span> <span class="censored">82364538i64</span>          <span class="censored">#</span></span><span class="w"> </span><span class="censored">sku</span>
<span class="gp">  <span class="censored">2:</span> <span class="censored">{"vacuum</span> <span class="censored">cleaner"}</span>   <span class="censored">#</span></span><span class="w"> </span><span class="censored">sku_name</span>
<span class="gp">  <span class="censored">3:</span> <span class="censored">1</span>                    <span class="censored">#</span></span><span class="w"> </span><span class="censored">count</span>
<span class="go"><span class="censored">}</span>
</span><span class="gp"><span class="censored">2:</span> <span class="censored">{</span>                          <span class="censored">#</span></span><span class="w"> </span><span class="censored">orders</span>
<span class="gp">  <span class="censored">1:</span> <span class="censored">431294823i64</span>             <span class="censored">#</span></span><span class="w"> </span><span class="censored">sku</span>
<span class="gp">  <span class="censored">2:</span> <span class="censored">{"hepa</span> <span class="censored">filter,</span> <span class="censored">2</span> <span class="censored">pack"}</span>  <span class="censored">#</span></span><span class="w"> </span><span class="censored">sku_name</span>
<span class="gp">  <span class="censored">3:</span> <span class="censored">6</span>                        <span class="censored">#</span></span><span class="w"> </span><span class="censored">count</span>
<span class="go"><span class="censored">}</span>
</span><span class="gp"><span class="censored">2:</span> <span class="censored">{</span>                                      <span class="censored">#</span></span><span class="w"> </span><span class="censored">orders</span>
<span class="gp">  <span class="censored">1:</span> <span class="censored">2300094522i64</span>                        <span class="censored">#</span></span><span class="w"> </span><span class="censored">sku</span>
<span class="gp">  <span class="censored">2:</span> <span class="censored">{"isopropyl</span> <span class="censored">alcohol</span> <span class="censored">70%,</span> <span class="censored">1</span> <span class="censored">gallon"}</span>  <span class="censored">#</span></span><span class="w"> </span><span class="censored">sku_name</span>
<span class="gp">  <span class="censored">3:</span> <span class="censored">2</span>                                    <span class="censored">#</span></span><span class="w"> </span><span class="censored">count</span>
<span class="go"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Console</span></div></div> </div> <p><span class="censored">Not</span> <span class="censored">only</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">second</span> <span class="censored">order</span> <span class="censored">decoded</span> <span class="censored">correctly</span> <span class="censored">now,</span> <span class="censored">but</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">shows</span> <span class="censored">the</span> <span class="censored">name</span> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">field</span> <span class="censored">(via</span> <code class="language-plaintext highlighter-rouge"><span class="censored">--print-field-names</span></code> <span class="censored">).</span> <span class="censored">In</span> <span class="censored">this</span> <span class="censored">mode,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">still</span> <span class="censored">decodes</span> <span class="censored">partially-valid</span> <span class="censored">messages.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">protoscope</span></code> <span class="censored">also</span> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">number</span> <span class="censored">of</span> <span class="censored">other</span> <span class="censored">flags</span> <span class="censored">for</span> <span class="censored">customizing</span> <span class="censored">its</span> <span class="censored">heuristic</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">absence</span> <span class="censored">of</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">FileDescriporSet</span></code><span class="censored">.</span> <span class="censored">This</span> <span class="censored">enables</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">forensic</span> <span class="censored">tool</span> <span class="censored">for</span> <span class="censored">debugging</span> <span class="censored">messy</span> <span class="censored">data</span> <span class="censored">corruption</span> <span class="censored">bugs.</span></p> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-07-16</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/16/hyperpb/"><span class="censored">Parsing</span> <span class="censored">Protobuf</span> <span class="censored">Like</span> <span class="censored">Never</span> <span class="censored">Before</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-14</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/14/best/"><span class="censored">The</span> <span class="censored">Best</span> <span class="censored">C++</span> <span class="censored">Library</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-07-07</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/07/nosplit/"><span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>