<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Protobuf Tip #6: The Subtle Dangers of Enum Aliases &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Protobuf Tip #6: The Subtle Dangers of Enum Aliases &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/protobuf-tip-6-5ddaf3d535a8374552e0163b5a22e05f18add565.png"> <meta property="og:title" content="Protobuf Tip #6: The Subtle Dangers of Enum Aliases &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/protobuf-tip-6-5ddaf3d535a8374552e0163b5a22e05f18add565.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/05/20/protobuf-tip-6/"> <link rel="canonical" href="https://buf.build/blog/totw-6-dangers-of-enum-aliases"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> • <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/feed"> <img style="height: 0.8em; transform: translate(0.07em, 0.15em);" src="https://mcyoung.xyz/public/images/rss.svg"></a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-05-20 • 550 words • 4 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/05/20/protobuf-tip-6/"> Protobuf Tip #6: The Subtle Dangers of Enum Aliases </a></h1> </div> <div class="post"> <p><em>I’ve been very fortunate to dodge a nickname throughout my entire career. I’ve never had one. – Jimmie Johnson</em></p> <p>TL;DR: Enum values can have aliases. This feature is poorly designed and shouldn’t be used. The <a href="https://buf.build/docs/lint/rules/#enum_no_allow_alias"><code class="language-plaintext highlighter-rouge">ENUM_NO_ALLOW_ALIAS</code></a> Buf lint rule prevents you from using them by default.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-5-avoid-import-public-weak">buf.build blog</a>.</p> </blockquote> <h2 id="confusion-and-breakage"><a href="#confusion-and-breakage">Confusion and Breakage</a></h2> <p>Protobuf permits multiple enum values to have the same number. Such enum values are said to be <em>aliases</em> of each other. Protobuf used to allow this by default, but now you have to set a special option, <code class="language-plaintext highlighter-rouge">allow_alias</code>, for the compiler to not reject it.</p> <p>This can be used to effectively rename values without breaking existing code:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kn">package</span> <span class="nn">myapi</span><span class="o">.</span><span class="n">v1</span><span class="p">;</span>

<span class="kd">enum</span> <span class="n">MyEnum</span> <span class="p">{</span>
  <span class="k">option</span> <span class="na">allow_alias</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="na">MY_ENUM_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">MY_ENUM_BAD</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span><span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">];</span>
  <span class="na">MY_ENUM_MORE_SPECIFIC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>This works perfectly fine, and is fully wire-compatible! And unlike renaming a field (see <a href="https://mcyoung.xyz//2025/05/08/protobuf-tip-1">TotW #1</a>), it won’t result in source code breakages.</p> <p>But if you use either reflection or JSON, or a runtime like Java that doesn’t cleanly allow enums with multiple names, you’ll be in for a nasty surprise.</p> <p>For example, if you request an enum value from an enum using reflection, such as with <code class="language-plaintext highlighter-rouge">protoreflect.EnumValueDescriptors.ByNumber()</code>, the value you’ll get is the one that appears in the file lexically. In fact, both <code class="language-plaintext highlighter-rouge">myapipb.MyEnum_MY_ENUM_BAD.String()</code> and <code class="language-plaintext highlighter-rouge">myapipb.MyEnum_MY_ENUM_MORE_SPECIFIC.String()</code> return the same value, leading to potential confusion, as the old “bad” value will be used in printed output like logs.</p> <p>You might think, “oh, I’ll switch the order of the aliases”. But that would be an <em>actual</em> wire format break. Not for the binary format, but for JSON. That’s because JSON preferentially stringifies enum values by using their declared name (if the value is in range). So, reordering the values means that what once serialized as <code class="language-plaintext highlighter-rouge">{"my_field": "MY_ENUM_BAD"}</code> now serializes as <code class="language-plaintext highlighter-rouge">{"my_field": "MY_ENUM_MORE_SPECIFIC"}</code> .</p> <p>If an old binary that hasn’t had the new enum value added sees this JSON document, it won’t parse correctly, and you’ll be in for a bad time.</p> <p>You can argue that this is a language bug, and it kind of is. Protobuf should include an equivalent of <code class="language-plaintext highlighter-rouge">json_name</code> for enum values, or mandate that JSON should serialize enum values with multiple names as a number, rather than an arbitrarily chosen enum name. The feature is intended to allow renaming of enum values, but unfortunately Protobuf hobbled it enough that it’s pretty dangerous.</p> <h1 id="what-to-do"><a href="#what-to-do">What To Do</a></h1> <p>Instead, if you <em>really</em> need to rename an enum value for usability or compliance reasons (ideally, not just aesthetics) you’re better off making a new enum type in a new version of your API. As long as the enum value numbers are the same, it’ll be binary-compatible, but it will <em>somewhat</em> reduce the risk of the above JSON confusion.</p> <p>Buf provides a lint rule against this feature, <a href="https://buf.build/docs/lint/rules/#enum_no_allow_alias"><code class="language-plaintext highlighter-rouge">ENUM_NO_ALLOW_ALIAS</code></a> , and Protobuf requires that you specify a magic option to enable this behavior, so in practice you don’t need to worry about this. But remember, the consequences of enum aliases go much further than JSON—they affect anything that uses reflection. So even if you don’t use JSON, you can still get burned.</p> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-07-07</span> / <h6 style="display:inline"><a href="/2025/07/07/nosplit/">What's //go:nosplit for?</a></h6> <li> <span class="post-meta">2025-06-03</span> / <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/">Protobuf Tip #7: Scoping It Out</a></h6> <li> <span class="post-meta">2025-05-13</span> / <h6 style="display:inline"><a href="/2025/05/13/protobuf-tip-5/">Protobuf Tip #5: Avoid import public/weak</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-05-20</span> <span class="censored">•</span> <span class="censored">550</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">4</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips"><span class="censored">#protobuf-tips</span></a> </span> <h1><a href="/2025/05/20/protobuf-tip-6/"> <span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#6:</span> <span class="censored">The</span> <span class="censored">Subtle</span> <span class="censored">Dangers</span> <span class="censored">of</span> <span class="censored">Enum</span> <span class="censored">Aliases</span> </a></h1> </div> <div class="post"> <p><em><span class="censored">I’ve</span> <span class="censored">been</span> <span class="censored">very</span> <span class="censored">fortunate</span> <span class="censored">to</span> <span class="censored">dodge</span> <span class="censored">a</span> <span class="censored">nickname</span> <span class="censored">throughout</span> <span class="censored">my</span> <span class="censored">entire</span> <span class="censored">career.</span> <span class="censored">I’ve</span> <span class="censored">never</span> <span class="censored">had</span> <span class="censored">one.</span> <span class="censored">–</span> <span class="censored">Jimmie</span> <span class="censored">Johnson</span></em></p> <p><span class="censored">TL;DR:</span> <span class="censored">Enum</span> <span class="censored">values</span> <span class="censored">can</span> <span class="censored">have</span> <span class="censored">aliases.</span> <span class="censored">This</span> <span class="censored">feature</span> <span class="censored">is</span> <span class="censored">poorly</span> <span class="censored">designed</span> <span class="censored">and</span> <span class="censored">shouldn’t</span> <span class="censored">be</span> <span class="censored">used.</span> <span class="censored">The</span> <a href="https://buf.build/docs/lint/rules/#enum_no_allow_alias"><code class="language-plaintext highlighter-rouge"><span class="censored">ENUM_NO_ALLOW_ALIAS</span></code></a> <span class="censored">Buf</span> <span class="censored">lint</span> <span class="censored">rule</span> <span class="censored">prevents</span> <span class="censored">you</span> <span class="censored">from</span> <span class="censored">using</span> <span class="censored">them</span> <span class="censored">by</span> <span class="censored">default.</span></p> <blockquote> <p><span class="censored">I’m</span> <span class="censored">editing</span> <span class="censored">a</span> <span class="censored">series</span> <span class="censored">of</span> <span class="censored">best</span> <span class="censored">practice</span> <span class="censored">pieces</span> <span class="censored">on</span> <span class="censored">Protobuf,</span> <span class="censored">a</span> <span class="censored">language</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">work</span> <span class="censored">on</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">lots</span> <span class="censored">of</span> <span class="censored">evil</span> <span class="censored">corner-cases.These</span> <span class="censored">are</span> <span class="censored">shorter</span> <span class="censored">than</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">typically</span> <span class="censored">post</span> <span class="censored">here,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">think</span> <span class="censored">it</span> <span class="censored">fits</span> <span class="censored">with</span> <span class="censored">what</span> <span class="censored">you,</span> <span class="censored">dear</span> <span class="censored">reader,</span> <span class="censored">come</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">blog</span> <span class="censored">for.</span> <span class="censored">These</span> <span class="censored">tips</span> <span class="censored">are</span> <span class="censored">also</span> <span class="censored">posted</span> <span class="censored">on</span> <span class="censored">the</span> <a href="https://buf.build/blog/totw-5-avoid-import-public-weak"><span class="censored">buf.build</span> <span class="censored">blog</span></a><span class="censored">.</span></p> </blockquote> <h2 id="confusion-and-breakage"><a href="#confusion-and-breakage"><span class="censored">Confusion</span> <span class="censored">and</span> <span class="censored">Breakage</span></a></h2> <p><span class="censored">Protobuf</span> <span class="censored">permits</span> <span class="censored">multiple</span> <span class="censored">enum</span> <span class="censored">values</span> <span class="censored">to</span> <span class="censored">have</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">number.</span> <span class="censored">Such</span> <span class="censored">enum</span> <span class="censored">values</span> <span class="censored">are</span> <span class="censored">said</span> <span class="censored">to</span> <span class="censored">be</span> <em><span class="censored">aliases</span></em> <span class="censored">of</span> <span class="censored">each</span> <span class="censored">other.</span> <span class="censored">Protobuf</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">allow</span> <span class="censored">this</span> <span class="censored">by</span> <span class="censored">default,</span> <span class="censored">but</span> <span class="censored">now</span> <span class="censored">you</span> <span class="censored">have</span> <span class="censored">to</span> <span class="censored">set</span> <span class="censored">a</span> <span class="censored">special</span> <span class="censored">option,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">allow_alias</span></code><span class="censored">,</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">compiler</span> <span class="censored">to</span> <span class="censored">not</span> <span class="censored">reject</span> <span class="censored">it.</span></p> <p><span class="censored">This</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">effectively</span> <span class="censored">rename</span> <span class="censored">values</span> <span class="censored">without</span> <span class="censored">breaking</span> <span class="censored">existing</span> <span class="censored">code:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kn"><span class="censored">package</span></span> <span class="nn"><span class="censored">myapi</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">v1</span></span><span class="p"><span class="censored">;</span></span>

<span class="kd"><span class="censored">enum</span></span> <span class="n"><span class="censored">MyEnum</span></span> <span class="p"><span class="censored">{</span></span>
  <span class="k"><span class="censored">option</span></span> <span class="na"><span class="censored">allow_alias</span></span> <span class="o"><span class="censored">=</span></span> <span class="kc"><span class="censored">true</span></span><span class="p"><span class="censored">;</span></span>
  <span class="na"><span class="censored">MY_ENUM_UNSPECIFIED</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">0</span></span><span class="p"><span class="censored">;</span></span>
  <span class="na"><span class="censored">MY_ENUM_BAD</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span> <span class="p"><span class="censored">[</span></span><span class="na"><span class="censored">deprecated</span></span> <span class="o"><span class="censored">=</span></span> <span class="kc"><span class="censored">true</span></span><span class="p"><span class="censored">];</span></span>
  <span class="na"><span class="censored">MY_ENUM_MORE_SPECIFIC</span></span> <span class="o"><span class="censored">=</span></span> <span class="mi"><span class="censored">1</span></span><span class="p"><span class="censored">;</span></span>
<span class="p"><span class="censored">}</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Protobuf</span></div></div> </div> <p><span class="censored">This</span> <span class="censored">works</span> <span class="censored">perfectly</span> <span class="censored">fine,</span> <span class="censored">and</span> <span class="censored">is</span> <span class="censored">fully</span> <span class="censored">wire-compatible!</span> <span class="censored">And</span> <span class="censored">unlike</span> <span class="censored">renaming</span> <span class="censored">a</span> <span class="censored">field</span> <span class="censored">(see</span> <a href="https://mcyoung.xyz//2025/05/08/protobuf-tip-1"><span class="censored">TotW</span> <span class="censored">#1</span></a><span class="censored">),</span> <span class="censored">it</span> <span class="censored">won’t</span> <span class="censored">result</span> <span class="censored">in</span> <span class="censored">source</span> <span class="censored">code</span> <span class="censored">breakages.</span></p> <p><span class="censored">But</span> <span class="censored">if</span> <span class="censored">you</span> <span class="censored">use</span> <span class="censored">either</span> <span class="censored">reflection</span> <span class="censored">or</span> <span class="censored">JSON,</span> <span class="censored">or</span> <span class="censored">a</span> <span class="censored">runtime</span> <span class="censored">like</span> <span class="censored">Java</span> <span class="censored">that</span> <span class="censored">doesn’t</span> <span class="censored">cleanly</span> <span class="censored">allow</span> <span class="censored">enums</span> <span class="censored">with</span> <span class="censored">multiple</span> <span class="censored">names,</span> <span class="censored">you’ll</span> <span class="censored">be</span> <span class="censored">in</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">nasty</span> <span class="censored">surprise.</span></p> <p><span class="censored">For</span> <span class="censored">example,</span> <span class="censored">if</span> <span class="censored">you</span> <span class="censored">request</span> <span class="censored">an</span> <span class="censored">enum</span> <span class="censored">value</span> <span class="censored">from</span> <span class="censored">an</span> <span class="censored">enum</span> <span class="censored">using</span> <span class="censored">reflection,</span> <span class="censored">such</span> <span class="censored">as</span> <span class="censored">with</span> <code class="language-plaintext highlighter-rouge"><span class="censored">protoreflect.EnumValueDescriptors.ByNumber()</span></code><span class="censored">,</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">you’ll</span> <span class="censored">get</span> <span class="censored">is</span> <span class="censored">the</span> <span class="censored">one</span> <span class="censored">that</span> <span class="censored">appears</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">file</span> <span class="censored">lexically.</span> <span class="censored">In</span> <span class="censored">fact,</span> <span class="censored">both</span> <code class="language-plaintext highlighter-rouge"><span class="censored">myapipb.MyEnum_MY_ENUM_BAD.String()</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">myapipb.MyEnum_MY_ENUM_MORE_SPECIFIC.String()</span></code> <span class="censored">return</span> <span class="censored">the</span> <span class="censored">same</span> <span class="censored">value,</span> <span class="censored">leading</span> <span class="censored">to</span> <span class="censored">potential</span> <span class="censored">confusion,</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">old</span> <span class="censored">“bad”</span> <span class="censored">value</span> <span class="censored">will</span> <span class="censored">be</span> <span class="censored">used</span> <span class="censored">in</span> <span class="censored">printed</span> <span class="censored">output</span> <span class="censored">like</span> <span class="censored">logs.</span></p> <p><span class="censored">You</span> <span class="censored">might</span> <span class="censored">think,</span> <span class="censored">“oh,</span> <span class="censored">I’ll</span> <span class="censored">switch</span> <span class="censored">the</span> <span class="censored">order</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">aliases”.</span> <span class="censored">But</span> <span class="censored">that</span> <span class="censored">would</span> <span class="censored">be</span> <span class="censored">an</span> <em><span class="censored">actual</span></em> <span class="censored">wire</span> <span class="censored">format</span> <span class="censored">break.</span> <span class="censored">Not</span> <span class="censored">for</span> <span class="censored">the</span> <span class="censored">binary</span> <span class="censored">format,</span> <span class="censored">but</span> <span class="censored">for</span> <span class="censored">JSON.</span> <span class="censored">That’s</span> <span class="censored">because</span> <span class="censored">JSON</span> <span class="censored">preferentially</span> <span class="censored">stringifies</span> <span class="censored">enum</span> <span class="censored">values</span> <span class="censored">by</span> <span class="censored">using</span> <span class="censored">their</span> <span class="censored">declared</span> <span class="censored">name</span> <span class="censored">(if</span> <span class="censored">the</span> <span class="censored">value</span> <span class="censored">is</span> <span class="censored">in</span> <span class="censored">range).</span> <span class="censored">So,</span> <span class="censored">reordering</span> <span class="censored">the</span> <span class="censored">values</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">what</span> <span class="censored">once</span> <span class="censored">serialized</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{"my_field":</span> <span class="censored">"MY_ENUM_BAD"}</span></code> <span class="censored">now</span> <span class="censored">serializes</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">{"my_field":</span> <span class="censored">"MY_ENUM_MORE_SPECIFIC"}</span></code> <span class="censored">.</span></p> <p><span class="censored">If</span> <span class="censored">an</span> <span class="censored">old</span> <span class="censored">binary</span> <span class="censored">that</span> <span class="censored">hasn’t</span> <span class="censored">had</span> <span class="censored">the</span> <span class="censored">new</span> <span class="censored">enum</span> <span class="censored">value</span> <span class="censored">added</span> <span class="censored">sees</span> <span class="censored">this</span> <span class="censored">JSON</span> <span class="censored">document,</span> <span class="censored">it</span> <span class="censored">won’t</span> <span class="censored">parse</span> <span class="censored">correctly,</span> <span class="censored">and</span> <span class="censored">you’ll</span> <span class="censored">be</span> <span class="censored">in</span> <span class="censored">for</span> <span class="censored">a</span> <span class="censored">bad</span> <span class="censored">time.</span></p> <p><span class="censored">You</span> <span class="censored">can</span> <span class="censored">argue</span> <span class="censored">that</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">a</span> <span class="censored">language</span> <span class="censored">bug,</span> <span class="censored">and</span> <span class="censored">it</span> <span class="censored">kind</span> <span class="censored">of</span> <span class="censored">is.</span> <span class="censored">Protobuf</span> <span class="censored">should</span> <span class="censored">include</span> <span class="censored">an</span> <span class="censored">equivalent</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">json_name</span></code> <span class="censored">for</span> <span class="censored">enum</span> <span class="censored">values,</span> <span class="censored">or</span> <span class="censored">mandate</span> <span class="censored">that</span> <span class="censored">JSON</span> <span class="censored">should</span> <span class="censored">serialize</span> <span class="censored">enum</span> <span class="censored">values</span> <span class="censored">with</span> <span class="censored">multiple</span> <span class="censored">names</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">number,</span> <span class="censored">rather</span> <span class="censored">than</span> <span class="censored">an</span> <span class="censored">arbitrarily</span> <span class="censored">chosen</span> <span class="censored">enum</span> <span class="censored">name.</span> <span class="censored">The</span> <span class="censored">feature</span> <span class="censored">is</span> <span class="censored">intended</span> <span class="censored">to</span> <span class="censored">allow</span> <span class="censored">renaming</span> <span class="censored">of</span> <span class="censored">enum</span> <span class="censored">values,</span> <span class="censored">but</span> <span class="censored">unfortunately</span> <span class="censored">Protobuf</span> <span class="censored">hobbled</span> <span class="censored">it</span> <span class="censored">enough</span> <span class="censored">that</span> <span class="censored">it’s</span> <span class="censored">pretty</span> <span class="censored">dangerous.</span></p> <h1 id="what-to-do"><a href="#what-to-do"><span class="censored">What</span> <span class="censored">To</span> <span class="censored">Do</span></a></h1> <p><span class="censored">Instead,</span> <span class="censored">if</span> <span class="censored">you</span> <em><span class="censored">really</span></em> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">rename</span> <span class="censored">an</span> <span class="censored">enum</span> <span class="censored">value</span> <span class="censored">for</span> <span class="censored">usability</span> <span class="censored">or</span> <span class="censored">compliance</span> <span class="censored">reasons</span> <span class="censored">(ideally,</span> <span class="censored">not</span> <span class="censored">just</span> <span class="censored">aesthetics)</span> <span class="censored">you’re</span> <span class="censored">better</span> <span class="censored">off</span> <span class="censored">making</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">enum</span> <span class="censored">type</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">version</span> <span class="censored">of</span> <span class="censored">your</span> <span class="censored">API.</span> <span class="censored">As</span> <span class="censored">long</span> <span class="censored">as</span> <span class="censored">the</span> <span class="censored">enum</span> <span class="censored">value</span> <span class="censored">numbers</span> <span class="censored">are</span> <span class="censored">the</span> <span class="censored">same,</span> <span class="censored">it’ll</span> <span class="censored">be</span> <span class="censored">binary-compatible,</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">will</span> <em><span class="censored">somewhat</span></em> <span class="censored">reduce</span> <span class="censored">the</span> <span class="censored">risk</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">above</span> <span class="censored">JSON</span> <span class="censored">confusion.</span></p> <p><span class="censored">Buf</span> <span class="censored">provides</span> <span class="censored">a</span> <span class="censored">lint</span> <span class="censored">rule</span> <span class="censored">against</span> <span class="censored">this</span> <span class="censored">feature,</span> <a href="https://buf.build/docs/lint/rules/#enum_no_allow_alias"><code class="language-plaintext highlighter-rouge"><span class="censored">ENUM_NO_ALLOW_ALIAS</span></code></a> <span class="censored">,</span> <span class="censored">and</span> <span class="censored">Protobuf</span> <span class="censored">requires</span> <span class="censored">that</span> <span class="censored">you</span> <span class="censored">specify</span> <span class="censored">a</span> <span class="censored">magic</span> <span class="censored">option</span> <span class="censored">to</span> <span class="censored">enable</span> <span class="censored">this</span> <span class="censored">behavior,</span> <span class="censored">so</span> <span class="censored">in</span> <span class="censored">practice</span> <span class="censored">you</span> <span class="censored">don’t</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">worry</span> <span class="censored">about</span> <span class="censored">this.</span> <span class="censored">But</span> <span class="censored">remember,</span> <span class="censored">the</span> <span class="censored">consequences</span> <span class="censored">of</span> <span class="censored">enum</span> <span class="censored">aliases</span> <span class="censored">go</span> <span class="censored">much</span> <span class="censored">further</span> <span class="censored">than</span> <span class="censored">JSON—they</span> <span class="censored">affect</span> <span class="censored">anything</span> <span class="censored">that</span> <span class="censored">uses</span> <span class="censored">reflection.</span> <span class="censored">So</span> <span class="censored">even</span> <span class="censored">if</span> <span class="censored">you</span> <span class="censored">don’t</span> <span class="censored">use</span> <span class="censored">JSON,</span> <span class="censored">you</span> <span class="censored">can</span> <span class="censored">still</span> <span class="censored">get</span> <span class="censored">burned.</span></p> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-07-07</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/07/07/nosplit/"><span class="censored">What's</span> <span class="censored">//go:nosplit</span> <span class="censored">for?</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-06-03</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/06/03/protobuf-tip-7/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#7:</span> <span class="censored">Scoping</span> <span class="censored">It</span> <span class="censored">Out</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-05-13</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/05/13/protobuf-tip-5/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#5:</span> <span class="censored">Avoid</span> <span class="censored">import</span> <span class="censored">public/weak</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>