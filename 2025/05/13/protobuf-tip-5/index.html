<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Protobuf Tip #5: Avoid import public/weak &middot; mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Protobuf Tip #5: Avoid import public/weak &middot; mcyoung"> <meta name="twitter:image" content="https://mcyoung.xyz/og/protobuf-tip-5-379595302c49dbdd0df33cf65f531a1a82ed756d.png"> <meta property="og:title" content="Protobuf Tip #5: Avoid import public/weak &middot; mcyoung"> <meta property="og:type" content="object"> <meta property="og:image" content="https://mcyoung.xyz/og/protobuf-tip-5-379595302c49dbdd0df33cf65f531a1a82ed756d.png"> <meta property="og:height" content="630"> <meta property="og:width" content="1200"> <meta property="og:url" content="https://mcyoung.xyz/2025/05/13/protobuf-tip-5/"> <link rel="canonical" href="https://buf.build/blog/totw-5-avoid-import-public-weak"> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="https://github.com/mcy"> <img src="https://mcyoung.xyz/public/images/github.svg"></a> • <a class="sidebar-nav-item" href="https://bsky.app/profile/mcy.gay"> <img style="height: 0.75em;" src="https://mcyoung.xyz/public/images/bsky.svg"></a> • <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="post-title"> <span class="post-meta"> 2025-05-13 • 851 words • 7 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/05/13/protobuf-tip-5/"> Protobuf Tip #5: Avoid import public/weak </a></h1> </div> <div class="post"> <p><em>My dad had a guitar but it was acoustic, so I smashed a mirror and glued broken glass to it to make it look more metal. It looked ridiculous! –Max Cavalera</em></p> <p>TL;DR: Avoid <code class="language-plaintext highlighter-rouge">import public</code> and <code class="language-plaintext highlighter-rouge">import weak</code>. The Buf lint rules <a href="https://buf.build/docs/lint/rules/#import_no_public"><code class="language-plaintext highlighter-rouge">IMPORT_NO_PUBLIC</code></a> and <a href="https://buf.build/docs/lint/rules/#import_no_weak"><code class="language-plaintext highlighter-rouge">IMPORT_NO_WEAK</code></a> enforce this for you by default.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-5-avoid-import-public-weak">buf.build blog</a>.</p> </blockquote> <p>Protobuf <code class="language-plaintext highlighter-rouge">import</code>s allow you to specify two special modes: <code class="language-plaintext highlighter-rouge">import public</code> and <code class="language-plaintext highlighter-rouge">import weak</code>. The Buf CLI lints against these by default, but you might be tempted to try using them anyway, especially because <a href="https://github.com/googleapis/googleapis/blob/df58085901d8fb80c2c021e405923bb2351a6f29/google/spanner/v1/spanner.proto#L19">some GCP APIs use <code class="language-plaintext highlighter-rouge">import public</code></a>. What are these modes, and why do they exist?</p> <h2 id="import-visibility"><a href="#import-visibility">Import Visibility</a></h2> <p>Protobuf imports are by file path, a fact that is very strongly baked into the language and its reflection model.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="k">import</span> <span class="s">"my/other/api.proto"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>Importing a file dumps all of its symbols into the current file. For the purposes of name resolution, it’s as if all if the declarations in that file have been pasted into the current file. However, this isn’t transitive. If:</p> <ul> <li><code class="language-plaintext highlighter-rouge">a.proto</code> imports <code class="language-plaintext highlighter-rouge">b.proto</code> …</li> <li>and <code class="language-plaintext highlighter-rouge">b.proto</code> imports <code class="language-plaintext highlighter-rouge">c.proto</code> …</li> <li>and <code class="language-plaintext highlighter-rouge">c.proto</code> defines <code class="language-plaintext highlighter-rouge">foo.Bar</code>…</li> <li>then, <code class="language-plaintext highlighter-rouge">a.proto</code> must import <code class="language-plaintext highlighter-rouge">c.proto</code> to refer to <code class="language-plaintext highlighter-rouge">foo.Bar</code>, even though <code class="language-plaintext highlighter-rouge">b.proto</code> imports it.</li> </ul> <p>This is similar to how importing a package as <code class="language-plaintext highlighter-rouge">.</code> works in Go. When you write <code class="language-plaintext highlighter-rouge">import . "strings"</code>, it dumps all of the declarations from the <code class="language-plaintext highlighter-rouge">strings</code> package into the current file, but not those of any files that <code class="language-plaintext highlighter-rouge">"strings"</code> imports.</p> <p>Now, what’s nice about Go is that packages can be broken up into files in a way that is transparent to users; users of a package import <em>the package</em>, not the files of that package. Unfortunately, Protobuf is not like that, so the file structure of a package leaks to its callers.</p> <p><code class="language-plaintext highlighter-rouge">import public</code> was intended as a mechanism for allowing API writers to break up files that were getting out of control. You can define a new file <code class="language-plaintext highlighter-rouge">new.proto</code> for some of the definitions in <code class="language-plaintext highlighter-rouge">big.proto</code>, move them to the new file, and then add <code class="language-plaintext highlighter-rouge">import public "new.proto";</code> to <code class="language-plaintext highlighter-rouge">big.proto</code>. Existing imports of <code class="language-plaintext highlighter-rouge">big.proto</code> won’t be broken, hooray!</p> <p>Except this feature was designed for C++. In C++, each <code class="language-plaintext highlighter-rouge">.proto</code> file maps to a <code class="language-plaintext highlighter-rouge">.proto.h</code> header, which you <code class="language-plaintext highlighter-rouge">#include</code> in your application code. In C++, <code class="language-plaintext highlighter-rouge">#include</code> behaves like <code class="language-plaintext highlighter-rouge">import public</code>, so marking an import as <code class="language-plaintext highlighter-rouge">public</code> only changes name resolution in Protobuf—the C++ backend doesn’t have to do anything to maintain source compatibility when an import is changed to <code class="language-plaintext highlighter-rouge">public</code>.</p> <p>But other backends, like Go, do not work this way: <code class="language-plaintext highlighter-rouge">import</code> in Go <em>doesn’t</em> pull in symbols transitively, so Go would need to explicitly add aliases for all of the symbols that come in through a public import. That is, if you had:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="c1">// foo.proto</span>
<span class="kn">package</span> <span class="nn">myapi</span><span class="o">.</span><span class="n">v1</span><span class="p">;</span>
<span class="kd">message</span> <span class="nc">Foo</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

<span class="c1">// bar.proto</span>
<span class="kn">package</span> <span class="nn">myotherapi</span><span class="o">.</span><span class="n">v1</span><span class="p">;</span>
<span class="k">import</span> <span class="n">public</span> <span class="s">"foo.proto"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>Then the Go backend has to generate a <code class="language-plaintext highlighter-rouge">type Foo = foopb.Foo</code> in <code class="language-plaintext highlighter-rouge">bar.pb.go</code> to emulate this behavior (in fact, I was surprised to learn Go Protobuf implements this at all). Go <em>happens</em> to implement public imports correctly, but not all backends are as careful, because this feature is obscure.</p> <p>The <a href="https://github.com/googleapis/googleapis/blob/df58085901d8fb80c2c021e405923bb2351a6f29/google/spanner/v1/spanner.proto#L19"><code class="language-plaintext highlighter-rouge">spanner.proto</code></a> example of an <code class="language-plaintext highlighter-rouge">import public</code> isn’t even used for breaking up an existing file; instead, it’s used to not make a huge file bigger and avoid making callers have to add an additional import. This is a <em>bad use</em> of a <em>bad feature!</em></p> <p>Using <code class="language-plaintext highlighter-rouge">import public</code> to effectively “hide” imports makes it harder to understand what a <code class="language-plaintext highlighter-rouge">.proto</code> file is pulling in. If Protobuf imports were at the package/symbol level, like Go or Java, this feature would not need to exist. Unfortunately, Protobuf is closely tailored for C++, and this is one of the consequences.</p> <p>Instead of using <code class="language-plaintext highlighter-rouge">import public</code> to break up a file, simply plan to break up the file in the next version of the API.</p> <p>The <a href="https://buf.build/docs/lint/rules/#import_no_public"><code class="language-plaintext highlighter-rouge">IMPORT_NO_PUBLIC</code></a> Buf lint rule enforces that no one uses this feature by default. It’s tempting, but the footguns aren’t worth it.</p> <h2 id="weak-imports"><a href="#weak-imports">Weak Imports</a></h2> <p>Public imports have a good, if flawed, reason to exist. Their implementation details are the main thing that kneecaps them.</p> <p>Weak imports, however, simply should not exist. They were added to the language to make it easier for some of Google’s enormous binaries to avoid running out of linker memory, by making it so that message types could be dropped if they weren’t accessed. This means that weak imports are “optional”—if the corresponding descriptors are missing at runtime, the C++ runtime can handle it gracefully.</p> <p>This leads to all kinds of implementation complexity and subtle behavior differences across runtimes. Most runtimes implement (or implemented, in the case of those that removed support) <code class="language-plaintext highlighter-rouge">import weak</code> in a buggy or inconsistent way. It’s unlikely the feature will ever be truly removed, even though Google has tried.</p> <p>Don’t use <code class="language-plaintext highlighter-rouge">import weak</code>. It should be treated as completely non-functional. The <a href="https://buf.build/docs/lint/rules/#import_no_weak"><code class="language-plaintext highlighter-rouge">IMPORT_NO_WEAK</code></a> Buf lint rule takes care of this for you.</p> </div> <div class="related post-footer"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <span class="post-meta">2025-05-20</span> / <h6 style="display:inline"><a href="/2025/05/20/protobuf-tip-6/">Protobuf Tip #6: The Subtle Dangers of Enum Aliases</a></h6> <li> <span class="post-meta">2025-04-29</span> / <h6 style="display:inline"><a href="/2025/04/29/protobuf-tip-4/">Protobuf Tip #4: Accepting Mistakes We Can't Fix</a></h6> <li> <span class="post-meta">2025-04-22</span> / <h6 style="display:inline"><a href="/2025/04/22/protobuf-tip-3/">Protobuf Tip #3: Enum Names Need Prefixes</a></h6> </ul> </div> <div class="minimap" aria-hidden="true"> <div class="minimap-size"></div> <div class="minimap-controller"></div> <div class="minimap-content"> <div class="content container"> <div class="post-title"> <span class="post-meta"> <span class="censored">2025-05-13</span> <span class="censored">•</span> <span class="censored">851</span> <span class="censored">words</span> <span class="censored">•</span> <span class="censored">7</span> <span class="censored">minutes</span> <br class="show-if-mobile"> <span class="hide-if-mobile"><span class="censored">•</span></span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips"><span class="censored">#protobuf-tips</span></a> </span> <h1><a href="/2025/05/13/protobuf-tip-5/"> <span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#5:</span> <span class="censored">Avoid</span> <span class="censored">import</span> <span class="censored">public/weak</span> </a></h1> </div> <div class="post"> <p><em><span class="censored">My</span> <span class="censored">dad</span> <span class="censored">had</span> <span class="censored">a</span> <span class="censored">guitar</span> <span class="censored">but</span> <span class="censored">it</span> <span class="censored">was</span> <span class="censored">acoustic,</span> <span class="censored">so</span> <span class="censored">I</span> <span class="censored">smashed</span> <span class="censored">a</span> <span class="censored">mirror</span> <span class="censored">and</span> <span class="censored">glued</span> <span class="censored">broken</span> <span class="censored">glass</span> <span class="censored">to</span> <span class="censored">it</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">it</span> <span class="censored">look</span> <span class="censored">more</span> <span class="censored">metal.</span> <span class="censored">It</span> <span class="censored">looked</span> <span class="censored">ridiculous!</span> <span class="censored">–Max</span> <span class="censored">Cavalera</span></em></p> <p><span class="censored">TL;DR:</span> <span class="censored">Avoid</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">weak</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">Buf</span> <span class="censored">lint</span> <span class="censored">rules</span> <a href="https://buf.build/docs/lint/rules/#import_no_public"><code class="language-plaintext highlighter-rouge"><span class="censored">IMPORT_NO_PUBLIC</span></code></a> <span class="censored">and</span> <a href="https://buf.build/docs/lint/rules/#import_no_weak"><code class="language-plaintext highlighter-rouge"><span class="censored">IMPORT_NO_WEAK</span></code></a> <span class="censored">enforce</span> <span class="censored">this</span> <span class="censored">for</span> <span class="censored">you</span> <span class="censored">by</span> <span class="censored">default.</span></p> <blockquote> <p><span class="censored">I’m</span> <span class="censored">editing</span> <span class="censored">a</span> <span class="censored">series</span> <span class="censored">of</span> <span class="censored">best</span> <span class="censored">practice</span> <span class="censored">pieces</span> <span class="censored">on</span> <span class="censored">Protobuf,</span> <span class="censored">a</span> <span class="censored">language</span> <span class="censored">that</span> <span class="censored">I</span> <span class="censored">work</span> <span class="censored">on</span> <span class="censored">which</span> <span class="censored">has</span> <span class="censored">lots</span> <span class="censored">of</span> <span class="censored">evil</span> <span class="censored">corner-cases.These</span> <span class="censored">are</span> <span class="censored">shorter</span> <span class="censored">than</span> <span class="censored">what</span> <span class="censored">I</span> <span class="censored">typically</span> <span class="censored">post</span> <span class="censored">here,</span> <span class="censored">but</span> <span class="censored">I</span> <span class="censored">think</span> <span class="censored">it</span> <span class="censored">fits</span> <span class="censored">with</span> <span class="censored">what</span> <span class="censored">you,</span> <span class="censored">dear</span> <span class="censored">reader,</span> <span class="censored">come</span> <span class="censored">to</span> <span class="censored">this</span> <span class="censored">blog</span> <span class="censored">for.</span> <span class="censored">These</span> <span class="censored">tips</span> <span class="censored">are</span> <span class="censored">also</span> <span class="censored">posted</span> <span class="censored">on</span> <span class="censored">the</span> <a href="https://buf.build/blog/totw-5-avoid-import-public-weak"><span class="censored">buf.build</span> <span class="censored">blog</span></a><span class="censored">.</span></p> </blockquote> <p><span class="censored">Protobuf</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span></code><span class="censored">s</span> <span class="censored">allow</span> <span class="censored">you</span> <span class="censored">to</span> <span class="censored">specify</span> <span class="censored">two</span> <span class="censored">special</span> <span class="censored">modes:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">weak</span></code><span class="censored">.</span> <span class="censored">The</span> <span class="censored">Buf</span> <span class="censored">CLI</span> <span class="censored">lints</span> <span class="censored">against</span> <span class="censored">these</span> <span class="censored">by</span> <span class="censored">default,</span> <span class="censored">but</span> <span class="censored">you</span> <span class="censored">might</span> <span class="censored">be</span> <span class="censored">tempted</span> <span class="censored">to</span> <span class="censored">try</span> <span class="censored">using</span> <span class="censored">them</span> <span class="censored">anyway,</span> <span class="censored">especially</span> <span class="censored">because</span> <a href="https://github.com/googleapis/googleapis/blob/df58085901d8fb80c2c021e405923bb2351a6f29/google/spanner/v1/spanner.proto#L19"><span class="censored">some</span> <span class="censored">GCP</span> <span class="censored">APIs</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code></a><span class="censored">.</span> <span class="censored">What</span> <span class="censored">are</span> <span class="censored">these</span> <span class="censored">modes,</span> <span class="censored">and</span> <span class="censored">why</span> <span class="censored">do</span> <span class="censored">they</span> <span class="censored">exist?</span></p> <h2 id="import-visibility"><a href="#import-visibility"><span class="censored">Import</span> <span class="censored">Visibility</span></a></h2> <p><span class="censored">Protobuf</span> <span class="censored">imports</span> <span class="censored">are</span> <span class="censored">by</span> <span class="censored">file</span> <span class="censored">path,</span> <span class="censored">a</span> <span class="censored">fact</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">very</span> <span class="censored">strongly</span> <span class="censored">baked</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">language</span> <span class="censored">and</span> <span class="censored">its</span> <span class="censored">reflection</span> <span class="censored">model.</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="k"><span class="censored">import</span></span> <span class="s"><span class="censored">"my/other/api.proto"</span></span><span class="p"><span class="censored">;</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Protobuf</span></div></div> </div> <p><span class="censored">Importing</span> <span class="censored">a</span> <span class="censored">file</span> <span class="censored">dumps</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">its</span> <span class="censored">symbols</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">file.</span> <span class="censored">For</span> <span class="censored">the</span> <span class="censored">purposes</span> <span class="censored">of</span> <span class="censored">name</span> <span class="censored">resolution,</span> <span class="censored">it’s</span> <span class="censored">as</span> <span class="censored">if</span> <span class="censored">all</span> <span class="censored">if</span> <span class="censored">the</span> <span class="censored">declarations</span> <span class="censored">in</span> <span class="censored">that</span> <span class="censored">file</span> <span class="censored">have</span> <span class="censored">been</span> <span class="censored">pasted</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">file.</span> <span class="censored">However,</span> <span class="censored">this</span> <span class="censored">isn’t</span> <span class="censored">transitive.</span> <span class="censored">If:</span></p> <ul> <li> <code class="language-plaintext highlighter-rouge"><span class="censored">a.proto</span></code> <span class="censored">imports</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b.proto</span></code> <span class="censored">…</span> </li> <li> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b.proto</span></code> <span class="censored">imports</span> <code class="language-plaintext highlighter-rouge"><span class="censored">c.proto</span></code> <span class="censored">…</span> </li> <li> <span class="censored">and</span> <code class="language-plaintext highlighter-rouge"><span class="censored">c.proto</span></code> <span class="censored">defines</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.Bar</span></code><span class="censored">…</span> </li> <li> <span class="censored">then,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">a.proto</span></code> <span class="censored">must</span> <span class="censored">import</span> <code class="language-plaintext highlighter-rouge"><span class="censored">c.proto</span></code> <span class="censored">to</span> <span class="censored">refer</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">foo.Bar</span></code><span class="censored">,</span> <span class="censored">even</span> <span class="censored">though</span> <code class="language-plaintext highlighter-rouge"><span class="censored">b.proto</span></code> <span class="censored">imports</span> <span class="censored">it.</span> </li> </ul> <p><span class="censored">This</span> <span class="censored">is</span> <span class="censored">similar</span> <span class="censored">to</span> <span class="censored">how</span> <span class="censored">importing</span> <span class="censored">a</span> <span class="censored">package</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.</span></code> <span class="censored">works</span> <span class="censored">in</span> <span class="censored">Go.</span> <span class="censored">When</span> <span class="censored">you</span> <span class="censored">write</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">.</span> <span class="censored">"strings"</span></code><span class="censored">,</span> <span class="censored">it</span> <span class="censored">dumps</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">declarations</span> <span class="censored">from</span> <span class="censored">the</span> <code class="language-plaintext highlighter-rouge"><span class="censored">strings</span></code> <span class="censored">package</span> <span class="censored">into</span> <span class="censored">the</span> <span class="censored">current</span> <span class="censored">file,</span> <span class="censored">but</span> <span class="censored">not</span> <span class="censored">those</span> <span class="censored">of</span> <span class="censored">any</span> <span class="censored">files</span> <span class="censored">that</span> <code class="language-plaintext highlighter-rouge"><span class="censored">"strings"</span></code> <span class="censored">imports.</span></p> <p><span class="censored">Now,</span> <span class="censored">what’s</span> <span class="censored">nice</span> <span class="censored">about</span> <span class="censored">Go</span> <span class="censored">is</span> <span class="censored">that</span> <span class="censored">packages</span> <span class="censored">can</span> <span class="censored">be</span> <span class="censored">broken</span> <span class="censored">up</span> <span class="censored">into</span> <span class="censored">files</span> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">way</span> <span class="censored">that</span> <span class="censored">is</span> <span class="censored">transparent</span> <span class="censored">to</span> <span class="censored">users;</span> <span class="censored">users</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">package</span> <span class="censored">import</span> <em><span class="censored">the</span> <span class="censored">package</span></em><span class="censored">,</span> <span class="censored">not</span> <span class="censored">the</span> <span class="censored">files</span> <span class="censored">of</span> <span class="censored">that</span> <span class="censored">package.</span> <span class="censored">Unfortunately,</span> <span class="censored">Protobuf</span> <span class="censored">is</span> <span class="censored">not</span> <span class="censored">like</span> <span class="censored">that,</span> <span class="censored">so</span> <span class="censored">the</span> <span class="censored">file</span> <span class="censored">structure</span> <span class="censored">of</span> <span class="censored">a</span> <span class="censored">package</span> <span class="censored">leaks</span> <span class="censored">to</span> <span class="censored">its</span> <span class="censored">callers.</span></p> <p><code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code> <span class="censored">was</span> <span class="censored">intended</span> <span class="censored">as</span> <span class="censored">a</span> <span class="censored">mechanism</span> <span class="censored">for</span> <span class="censored">allowing</span> <span class="censored">API</span> <span class="censored">writers</span> <span class="censored">to</span> <span class="censored">break</span> <span class="censored">up</span> <span class="censored">files</span> <span class="censored">that</span> <span class="censored">were</span> <span class="censored">getting</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">control.</span> <span class="censored">You</span> <span class="censored">can</span> <span class="censored">define</span> <span class="censored">a</span> <span class="censored">new</span> <span class="censored">file</span> <code class="language-plaintext highlighter-rouge"><span class="censored">new.proto</span></code> <span class="censored">for</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">definitions</span> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">big.proto</span></code><span class="censored">,</span> <span class="censored">move</span> <span class="censored">them</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">new</span> <span class="censored">file,</span> <span class="censored">and</span> <span class="censored">then</span> <span class="censored">add</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span> <span class="censored">"new.proto";</span></code> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">big.proto</span></code><span class="censored">.</span> <span class="censored">Existing</span> <span class="censored">imports</span> <span class="censored">of</span> <code class="language-plaintext highlighter-rouge"><span class="censored">big.proto</span></code> <span class="censored">won’t</span> <span class="censored">be</span> <span class="censored">broken,</span> <span class="censored">hooray!</span></p> <p><span class="censored">Except</span> <span class="censored">this</span> <span class="censored">feature</span> <span class="censored">was</span> <span class="censored">designed</span> <span class="censored">for</span> <span class="censored">C++.</span> <span class="censored">In</span> <span class="censored">C++,</span> <span class="censored">each</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.proto</span></code> <span class="censored">file</span> <span class="censored">maps</span> <span class="censored">to</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.proto.h</span></code> <span class="censored">header,</span> <span class="censored">which</span> <span class="censored">you</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#include</span></code> <span class="censored">in</span> <span class="censored">your</span> <span class="censored">application</span> <span class="censored">code.</span> <span class="censored">In</span> <span class="censored">C++,</span> <code class="language-plaintext highlighter-rouge"><span class="censored">#include</span></code> <span class="censored">behaves</span> <span class="censored">like</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code><span class="censored">,</span> <span class="censored">so</span> <span class="censored">marking</span> <span class="censored">an</span> <span class="censored">import</span> <span class="censored">as</span> <code class="language-plaintext highlighter-rouge"><span class="censored">public</span></code> <span class="censored">only</span> <span class="censored">changes</span> <span class="censored">name</span> <span class="censored">resolution</span> <span class="censored">in</span> <span class="censored">Protobuf—the</span> <span class="censored">C++</span> <span class="censored">backend</span> <span class="censored">doesn’t</span> <span class="censored">have</span> <span class="censored">to</span> <span class="censored">do</span> <span class="censored">anything</span> <span class="censored">to</span> <span class="censored">maintain</span> <span class="censored">source</span> <span class="censored">compatibility</span> <span class="censored">when</span> <span class="censored">an</span> <span class="censored">import</span> <span class="censored">is</span> <span class="censored">changed</span> <span class="censored">to</span> <code class="language-plaintext highlighter-rouge"><span class="censored">public</span></code><span class="censored">.</span></p> <p><span class="censored">But</span> <span class="censored">other</span> <span class="censored">backends,</span> <span class="censored">like</span> <span class="censored">Go,</span> <span class="censored">do</span> <span class="censored">not</span> <span class="censored">work</span> <span class="censored">this</span> <span class="censored">way:</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span></code> <span class="censored">in</span> <span class="censored">Go</span> <em><span class="censored">doesn’t</span></em> <span class="censored">pull</span> <span class="censored">in</span> <span class="censored">symbols</span> <span class="censored">transitively,</span> <span class="censored">so</span> <span class="censored">Go</span> <span class="censored">would</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">explicitly</span> <span class="censored">add</span> <span class="censored">aliases</span> <span class="censored">for</span> <span class="censored">all</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">symbols</span> <span class="censored">that</span> <span class="censored">come</span> <span class="censored">in</span> <span class="censored">through</span> <span class="censored">a</span> <span class="censored">public</span> <span class="censored">import.</span> <span class="censored">That</span> <span class="censored">is,</span> <span class="censored">if</span> <span class="censored">you</span> <span class="censored">had:</span></p> <div class="codeblock"> <figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="c1"><span class="censored">//</span> <span class="censored">foo.proto</span></span>
<span class="kn"><span class="censored">package</span></span> <span class="nn"><span class="censored">myapi</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">v1</span></span><span class="p"><span class="censored">;</span></span>
<span class="kd"><span class="censored">message</span></span> <span class="nc"><span class="censored">Foo</span></span> <span class="p"><span class="censored">{</span></span> <span class="o"><span class="censored">...</span></span> <span class="p"><span class="censored">}</span></span>

<span class="c1"><span class="censored">//</span> <span class="censored">bar.proto</span></span>
<span class="kn"><span class="censored">package</span></span> <span class="nn"><span class="censored">myotherapi</span></span><span class="o"><span class="censored">.</span></span><span class="n"><span class="censored">v1</span></span><span class="p"><span class="censored">;</span></span>
<span class="k"><span class="censored">import</span></span> <span class="n"><span class="censored">public</span></span> <span class="s"><span class="censored">"foo.proto"</span></span><span class="p"><span class="censored">;</span></span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button"><span class="censored">Protobuf</span></div></div> </div> <p><span class="censored">Then</span> <span class="censored">the</span> <span class="censored">Go</span> <span class="censored">backend</span> <span class="censored">has</span> <span class="censored">to</span> <span class="censored">generate</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">type</span> <span class="censored">Foo</span> <span class="censored">=</span> <span class="censored">foopb.Foo</span></code> <span class="censored">in</span> <code class="language-plaintext highlighter-rouge"><span class="censored">bar.pb.go</span></code> <span class="censored">to</span> <span class="censored">emulate</span> <span class="censored">this</span> <span class="censored">behavior</span> <span class="censored">(in</span> <span class="censored">fact,</span> <span class="censored">I</span> <span class="censored">was</span> <span class="censored">surprised</span> <span class="censored">to</span> <span class="censored">learn</span> <span class="censored">Go</span> <span class="censored">Protobuf</span> <span class="censored">implements</span> <span class="censored">this</span> <span class="censored">at</span> <span class="censored">all).</span> <span class="censored">Go</span> <em><span class="censored">happens</span></em> <span class="censored">to</span> <span class="censored">implement</span> <span class="censored">public</span> <span class="censored">imports</span> <span class="censored">correctly,</span> <span class="censored">but</span> <span class="censored">not</span> <span class="censored">all</span> <span class="censored">backends</span> <span class="censored">are</span> <span class="censored">as</span> <span class="censored">careful,</span> <span class="censored">because</span> <span class="censored">this</span> <span class="censored">feature</span> <span class="censored">is</span> <span class="censored">obscure.</span></p> <p><span class="censored">The</span> <a href="https://github.com/googleapis/googleapis/blob/df58085901d8fb80c2c021e405923bb2351a6f29/google/spanner/v1/spanner.proto#L19"><code class="language-plaintext highlighter-rouge"><span class="censored">spanner.proto</span></code></a> <span class="censored">example</span> <span class="censored">of</span> <span class="censored">an</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code> <span class="censored">isn’t</span> <span class="censored">even</span> <span class="censored">used</span> <span class="censored">for</span> <span class="censored">breaking</span> <span class="censored">up</span> <span class="censored">an</span> <span class="censored">existing</span> <span class="censored">file;</span> <span class="censored">instead,</span> <span class="censored">it’s</span> <span class="censored">used</span> <span class="censored">to</span> <span class="censored">not</span> <span class="censored">make</span> <span class="censored">a</span> <span class="censored">huge</span> <span class="censored">file</span> <span class="censored">bigger</span> <span class="censored">and</span> <span class="censored">avoid</span> <span class="censored">making</span> <span class="censored">callers</span> <span class="censored">have</span> <span class="censored">to</span> <span class="censored">add</span> <span class="censored">an</span> <span class="censored">additional</span> <span class="censored">import.</span> <span class="censored">This</span> <span class="censored">is</span> <span class="censored">a</span> <em><span class="censored">bad</span> <span class="censored">use</span></em> <span class="censored">of</span> <span class="censored">a</span> <em><span class="censored">bad</span> <span class="censored">feature!</span></em></p> <p><span class="censored">Using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code> <span class="censored">to</span> <span class="censored">effectively</span> <span class="censored">“hide”</span> <span class="censored">imports</span> <span class="censored">makes</span> <span class="censored">it</span> <span class="censored">harder</span> <span class="censored">to</span> <span class="censored">understand</span> <span class="censored">what</span> <span class="censored">a</span> <code class="language-plaintext highlighter-rouge"><span class="censored">.proto</span></code> <span class="censored">file</span> <span class="censored">is</span> <span class="censored">pulling</span> <span class="censored">in.</span> <span class="censored">If</span> <span class="censored">Protobuf</span> <span class="censored">imports</span> <span class="censored">were</span> <span class="censored">at</span> <span class="censored">the</span> <span class="censored">package/symbol</span> <span class="censored">level,</span> <span class="censored">like</span> <span class="censored">Go</span> <span class="censored">or</span> <span class="censored">Java,</span> <span class="censored">this</span> <span class="censored">feature</span> <span class="censored">would</span> <span class="censored">not</span> <span class="censored">need</span> <span class="censored">to</span> <span class="censored">exist.</span> <span class="censored">Unfortunately,</span> <span class="censored">Protobuf</span> <span class="censored">is</span> <span class="censored">closely</span> <span class="censored">tailored</span> <span class="censored">for</span> <span class="censored">C++,</span> <span class="censored">and</span> <span class="censored">this</span> <span class="censored">is</span> <span class="censored">one</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">consequences.</span></p> <p><span class="censored">Instead</span> <span class="censored">of</span> <span class="censored">using</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">public</span></code> <span class="censored">to</span> <span class="censored">break</span> <span class="censored">up</span> <span class="censored">a</span> <span class="censored">file,</span> <span class="censored">simply</span> <span class="censored">plan</span> <span class="censored">to</span> <span class="censored">break</span> <span class="censored">up</span> <span class="censored">the</span> <span class="censored">file</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">next</span> <span class="censored">version</span> <span class="censored">of</span> <span class="censored">the</span> <span class="censored">API.</span></p> <p><span class="censored">The</span> <a href="https://buf.build/docs/lint/rules/#import_no_public"><code class="language-plaintext highlighter-rouge"><span class="censored">IMPORT_NO_PUBLIC</span></code></a> <span class="censored">Buf</span> <span class="censored">lint</span> <span class="censored">rule</span> <span class="censored">enforces</span> <span class="censored">that</span> <span class="censored">no</span> <span class="censored">one</span> <span class="censored">uses</span> <span class="censored">this</span> <span class="censored">feature</span> <span class="censored">by</span> <span class="censored">default.</span> <span class="censored">It’s</span> <span class="censored">tempting,</span> <span class="censored">but</span> <span class="censored">the</span> <span class="censored">footguns</span> <span class="censored">aren’t</span> <span class="censored">worth</span> <span class="censored">it.</span></p> <h2 id="weak-imports"><a href="#weak-imports"><span class="censored">Weak</span> <span class="censored">Imports</span></a></h2> <p><span class="censored">Public</span> <span class="censored">imports</span> <span class="censored">have</span> <span class="censored">a</span> <span class="censored">good,</span> <span class="censored">if</span> <span class="censored">flawed,</span> <span class="censored">reason</span> <span class="censored">to</span> <span class="censored">exist.</span> <span class="censored">Their</span> <span class="censored">implementation</span> <span class="censored">details</span> <span class="censored">are</span> <span class="censored">the</span> <span class="censored">main</span> <span class="censored">thing</span> <span class="censored">that</span> <span class="censored">kneecaps</span> <span class="censored">them.</span></p> <p><span class="censored">Weak</span> <span class="censored">imports,</span> <span class="censored">however,</span> <span class="censored">simply</span> <span class="censored">should</span> <span class="censored">not</span> <span class="censored">exist.</span> <span class="censored">They</span> <span class="censored">were</span> <span class="censored">added</span> <span class="censored">to</span> <span class="censored">the</span> <span class="censored">language</span> <span class="censored">to</span> <span class="censored">make</span> <span class="censored">it</span> <span class="censored">easier</span> <span class="censored">for</span> <span class="censored">some</span> <span class="censored">of</span> <span class="censored">Google’s</span> <span class="censored">enormous</span> <span class="censored">binaries</span> <span class="censored">to</span> <span class="censored">avoid</span> <span class="censored">running</span> <span class="censored">out</span> <span class="censored">of</span> <span class="censored">linker</span> <span class="censored">memory,</span> <span class="censored">by</span> <span class="censored">making</span> <span class="censored">it</span> <span class="censored">so</span> <span class="censored">that</span> <span class="censored">message</span> <span class="censored">types</span> <span class="censored">could</span> <span class="censored">be</span> <span class="censored">dropped</span> <span class="censored">if</span> <span class="censored">they</span> <span class="censored">weren’t</span> <span class="censored">accessed.</span> <span class="censored">This</span> <span class="censored">means</span> <span class="censored">that</span> <span class="censored">weak</span> <span class="censored">imports</span> <span class="censored">are</span> <span class="censored">“optional”—if</span> <span class="censored">the</span> <span class="censored">corresponding</span> <span class="censored">descriptors</span> <span class="censored">are</span> <span class="censored">missing</span> <span class="censored">at</span> <span class="censored">runtime,</span> <span class="censored">the</span> <span class="censored">C++</span> <span class="censored">runtime</span> <span class="censored">can</span> <span class="censored">handle</span> <span class="censored">it</span> <span class="censored">gracefully.</span></p> <p><span class="censored">This</span> <span class="censored">leads</span> <span class="censored">to</span> <span class="censored">all</span> <span class="censored">kinds</span> <span class="censored">of</span> <span class="censored">implementation</span> <span class="censored">complexity</span> <span class="censored">and</span> <span class="censored">subtle</span> <span class="censored">behavior</span> <span class="censored">differences</span> <span class="censored">across</span> <span class="censored">runtimes.</span> <span class="censored">Most</span> <span class="censored">runtimes</span> <span class="censored">implement</span> <span class="censored">(or</span> <span class="censored">implemented,</span> <span class="censored">in</span> <span class="censored">the</span> <span class="censored">case</span> <span class="censored">of</span> <span class="censored">those</span> <span class="censored">that</span> <span class="censored">removed</span> <span class="censored">support)</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">weak</span></code> <span class="censored">in</span> <span class="censored">a</span> <span class="censored">buggy</span> <span class="censored">or</span> <span class="censored">inconsistent</span> <span class="censored">way.</span> <span class="censored">It’s</span> <span class="censored">unlikely</span> <span class="censored">the</span> <span class="censored">feature</span> <span class="censored">will</span> <span class="censored">ever</span> <span class="censored">be</span> <span class="censored">truly</span> <span class="censored">removed,</span> <span class="censored">even</span> <span class="censored">though</span> <span class="censored">Google</span> <span class="censored">has</span> <span class="censored">tried.</span></p> <p><span class="censored">Don’t</span> <span class="censored">use</span> <code class="language-plaintext highlighter-rouge"><span class="censored">import</span> <span class="censored">weak</span></code><span class="censored">.</span> <span class="censored">It</span> <span class="censored">should</span> <span class="censored">be</span> <span class="censored">treated</span> <span class="censored">as</span> <span class="censored">completely</span> <span class="censored">non-functional.</span> <span class="censored">The</span> <a href="https://buf.build/docs/lint/rules/#import_no_weak"><code class="language-plaintext highlighter-rouge"><span class="censored">IMPORT_NO_WEAK</span></code></a> <span class="censored">Buf</span> <span class="censored">lint</span> <span class="censored">rule</span> <span class="censored">takes</span> <span class="censored">care</span> <span class="censored">of</span> <span class="censored">this</span> <span class="censored">for</span> <span class="censored">you.</span></p> </div> <div class="related post-footer"> <h2> <span class="censored">Related</span> <span class="censored">Posts</span> </h2> <ul class="related-posts"> <li> <span class="post-meta"><span class="censored">2025-05-20</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/05/20/protobuf-tip-6/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#6:</span> <span class="censored">The</span> <span class="censored">Subtle</span> <span class="censored">Dangers</span> <span class="censored">of</span> <span class="censored">Enum</span> <span class="censored">Aliases</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-04-29</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/04/29/protobuf-tip-4/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#4:</span> <span class="censored">Accepting</span> <span class="censored">Mistakes</span> <span class="censored">We</span> <span class="censored">Can't</span> <span class="censored">Fix</span></a></h6> </li> <li> <span class="post-meta"><span class="censored">2025-04-22</span></span> <span class="censored">/</span> <h6 style="display:inline"><a href="/2025/04/22/protobuf-tip-3/"><span class="censored">Protobuf</span> <span class="censored">Tip</span> <span class="censored">#3:</span> <span class="censored">Enum</span> <span class="censored">Names</span> <span class="censored">Need</span> <span class="censored">Prefixes</span></a></h6> </li> </ul> </div> </div> </div> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>