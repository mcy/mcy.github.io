<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://mcyoung.xyz/https://mcyoung.xyz/feed.xml" rel="self" type="application/atom+xml"/><link href="https://mcyoung.xyz/https://mcyoung.xyz/" rel="alternate" type="text/html"/><updated>2025-04-14T14:12:11-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/feed.xml</id><title type="html">mcyoung</title><subtitle>I&apos;m Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </subtitle><author><name>Miguel Young de la Sota</name></author><entry><title type="html">What the Hell Is a Target Triple?</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2025/04/14/target-triples/" rel="alternate" type="text/html" title="What the Hell Is a Target Triple?"/><published>2025-04-14T00:00:00-07:00</published><updated>2025-04-14T00:00:00-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2025/04/14/target-triples</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2025/04/14/target-triples/"><![CDATA[<p><em>Cross-compiling</em> is taking a computer program and compiling it for a machine that isn’t the one hosting the compilation. Although historically compilers would only compile for the host machine, this is considered an anachronism: all serious native compilers are now cross-compilers.</p> <p>After all, you don’t want to be building your iPhone app on literal iPhone hardware.</p> <p>Many different compilers have different mechanisms for classifying and identifying <em>targets</em>. A target is a platform that the compiler can produce executable code for. However, due to the runaway popularity of LLVM, virtually all compilers now use <em>target triples</em>. You may have already encountered one, such as the venerable <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code>, or the evil <code class="language-plaintext highlighter-rouge">x86_64-pc-windows</code>. This system is convoluted and <em>almost</em> self-consistent.</p> <p>But what is a target triple, and where did they come from?</p> <h2 id="stupid-gcc-conventions"><a href="#stupid-gcc-conventions">Stupid GCC Conventions</a></h2> <p>So if you go poking around the <a href="https://wiki.osdev.org/Target_Triplet">Target Triplet</a> page on OSDev, you will learn both true and false things about target triples, because this page is about GCC, not native compilers in general.</p> <blockquote> <p>Generally, there is no “ground truth” for what a target triple is. There isn’t some standards body that assigns these names. But as we’ll see, LLVM is the trendsetter.</p> </blockquote> <p>If you run the following command you can learn the target triple for your machine:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>gcc <span class="nt">-dumpmachine</span>
<span class="go">x86_64-linux-gnu</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Now if you’re at all familiar with any system that makes pervasive use of target triples, you will know that this is <em>not a target triple</em>, because this target’s name is <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-gnu</code>, which is what both <code class="language-plaintext highlighter-rouge">clang</code> and <code class="language-plaintext highlighter-rouge">rustc</code> call-</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>clang <span class="nt">-dumpmachine</span>
<span class="go">x86_64-pc-linux-gnu
</span><span class="gp">$</span><span class="w"> </span>rustc <span class="nt">-vV</span> | <span class="nb">grep </span>host
<span class="go">host: x86_64-unknown-linux-gnu</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Oh no.</p> <p>Well, GCC is missing the the <code class="language-plaintext highlighter-rouge">pc</code> or <code class="language-plaintext highlighter-rouge">unknown</code> component, and that’s specifically a GCC thing; it allows omitting parts of the triple in such a way that is unambiguous. And they are a GCC invention, so perhaps it’s best to start by assessing GCC’s beliefs.</p> <p>According to GCC, a target triple is a string of the form <code class="language-plaintext highlighter-rouge">&lt;machine&gt;-&lt;vendor&gt;-&lt;os&gt;</code>. The “machine” part unambiguously identifies the architecture of the system. Practically speaking, this is the assembly language that the compiler will output at the end. The “vendor” part is essentially irrelevant, and mostly is of benefit for sorting related operating systems together. Finally, the “os” part identifies the operating system that this code is being compiled for. The main thing this identifies for a compiler is the executable format: COFF/PE for Windows, Mach-O for Apple’s operating systems, ELF for Linux and friends, and so on (this, however, is an oversimplification).</p> <p>But you may notice that <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-gnu</code> has an extra, fourth entry<sup id="fnref:quad" role="doc-noteref"><a href="#fn:quad" class="footnote" rel="footnote">1</a></sup>, which plays many roles but is most often called the target’s “ABI”. For <code class="language-plaintext highlighter-rouge">linux</code>, it identifies the target’s libc, which has consequences for code generation of some language features, such as thread locals and unwinding. It is optional, since many targets only have one ABI.</p> <h3 id="cross-compiling-with-gcc"><a href="#cross-compiling-with-gcc">Cross Compiling with GCC</a></h3> <p>A critical piece of history here is to understand the really stupid way in which GCC does cross compiling. Traditionally, each GCC binary would be built for <em>one</em> target triple. The full name of a GCC binary would include the triple, so when cross-compiling, you would compile with <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-gcc</code>, link with <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-ld</code>, and so on (here, <code class="language-plaintext highlighter-rouge">gcc</code> is not the fourth ABI component of a triple; it’s just one of the tools in the <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code> toolchain).</p> <p>Nobody with a brain does this<sup id="fnref:toolchain" role="doc-noteref"><a href="#fn:toolchain" class="footnote" rel="footnote">2</a></sup>. LLVM and all cross compilers that follow it instead put all of the backends in one binary, and use a compiler flag like <code class="language-plaintext highlighter-rouge">--target</code> to select the backend.</p> <p>But regardless, this is where target triples come from, and why they look the way they look: they began as prefixes for the names of binaries in <code class="language-plaintext highlighter-rouge">autoconf</code> scripts.</p> <p>But GCC is ancient technology. In the 21st century, LLVM rules all native compilers.</p> <h2 id="names-in-the-ancient-language"><a href="#names-in-the-ancient-language">Names in the Ancient Language</a></h2> <p>LLVM’s target triple list is the one that should be regarded as “most official”, for a few reasons:</p> <ol> <li> <p>Inertia. Everyone and their mother uses LLVM as a middleend and backend, so its naming conventions bubble up into language frontends like <code class="language-plaintext highlighter-rouge">clang</code>, <code class="language-plaintext highlighter-rouge">rustc</code> <code class="language-plaintext highlighter-rouge">swiftc</code>, <code class="language-plaintext highlighter-rouge">icc</code>, and <code class="language-plaintext highlighter-rouge">nvcc</code>.</p> </li> <li> <p>Upstream work by silicon and operating system vendors. LLVM is what people get hired to work on for the most part, not GCC, so its platform-specific conventions often reflect the preferences of vendors.</p> </li> </ol> <p>These are in no small part because Apple, Google, and Nvidia have armies of compiler engineers contributing to LLVM.</p> <p>The sources for “official” target triples are many. Generally, I would describe a target triple as “official” when:</p> <ol> <li> <p>A major compiler (so, <code class="language-plaintext highlighter-rouge">clang</code> or <code class="language-plaintext highlighter-rouge">rustc</code>) uses it. Rust does a way better job than LLVM of documenting their targets, so I prefer to give it deference. You can find Rust’s official triples <a href="https://doc.rust-lang.org/rustc/platform-support.html">here</a>.</p> </li> <li> <p>A platform developer (e.g., a hardware manufacturer, OS vendor) distributes a toolchain with a target triple in the <code class="language-plaintext highlighter-rouge">arch-vendor-os</code> format.</p> </li> </ol> <p>So, what are the names in class (1)? LLVM does not really go out of its way to provide such a list. But we gotta start somewhere, so source-diving it is.</p> <p>We can dig into <a href="https://llvm.org/doxygen/Triple_8cpp_source.html"><code class="language-plaintext highlighter-rouge">Triple.cpp</code></a> in LLVM’s target triple parser. It lists all of the names LLVM recognizes for each part of a triple. Looking at <code class="language-plaintext highlighter-rouge">Triple::parseArch()</code>, we have the following names, including many, many aliases. The first item on the right column is LLVM’s preferred name for the architecture, as indicated by <code class="language-plaintext highlighter-rouge">Triple::getArchTypeName()</code>.</p> <table> <thead> <tr> <th>Architecture</th> <th>Possible Names</th> </tr> </thead> <tbody> <tr> <td><a href="https://en.wikipedia.org/wiki/X86">Intel x86</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">i386</code>, <code class="language-plaintext highlighter-rouge">i486</code>, <code class="language-plaintext highlighter-rouge">i586</code>, <code class="language-plaintext highlighter-rouge">i686</code>, <code class="language-plaintext highlighter-rouge">i786</code>, <code class="language-plaintext highlighter-rouge">i886</code>, <code class="language-plaintext highlighter-rouge">i986</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/X86">Intel x86</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">x86_64</code>, <code class="language-plaintext highlighter-rouge">amd64</code>, <code class="language-plaintext highlighter-rouge">x86_86h</code><sup id="fnref:x86_86h" role="doc-noteref"><a href="#fn:x86_86h" class="footnote" rel="footnote">3</a></sup></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">arm</code>, <code class="language-plaintext highlighter-rouge">xscale</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (32-bit, big-endian)</td> <td><code class="language-plaintext highlighter-rouge">armeb</code>, <code class="language-plaintext highlighter-rouge">xscaleeb</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">aarch64</code>, <code class="language-plaintext highlighter-rouge">aarch64e</code>, <code class="language-plaintext highlighter-rouge">aarch64ec</code>, <code class="language-plaintext highlighter-rouge">arm64</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (64-bit, big-endian)</td> <td><code class="language-plaintext highlighter-rouge">aarch64_be</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (64-bit, ILP32<sup id="fnref:ilp32" role="doc-noteref"><a href="#fn:ilp32" class="footnote" rel="footnote">4</a></sup>)</td> <td><code class="language-plaintext highlighter-rouge">aarch64_32</code>, <code class="language-plaintext highlighter-rouge">arm64_32</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family#Thumb">ARM Thumb</a></td> <td><code class="language-plaintext highlighter-rouge">thumb</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family#Thumb">ARM Thumb</a> (big-endian)</td> <td><code class="language-plaintext highlighter-rouge">thumbeb</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a><sup id="fnref:power" role="doc-noteref"><a href="#fn:power" class="footnote" rel="footnote">5</a></sup> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">powerpc</code>, <code class="language-plaintext highlighter-rouge">powerpcspe</code>, <code class="language-plaintext highlighter-rouge">ppc</code>, <code class="language-plaintext highlighter-rouge">ppc32</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a> (little-endian)</td> <td><code class="language-plaintext highlighter-rouge">powerpcle</code>, <code class="language-plaintext highlighter-rouge">ppcle</code>, <code class="language-plaintext highlighter-rouge">ppc32le</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">powerpc64</code>, <code class="language-plaintext highlighter-rouge">ppu</code>, <code class="language-plaintext highlighter-rouge">ppc64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a> (64-bit, little-endian)</td> <td><code class="language-plaintext highlighter-rouge">powerpc64le</code>, <code class="language-plaintext highlighter-rouge">ppc64le</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">mips</code>, <code class="language-plaintext highlighter-rouge">mipseb</code>, <code class="language-plaintext highlighter-rouge">mipsallegrex</code>, <code class="language-plaintext highlighter-rouge">mipsisa32r6</code>, <code class="language-plaintext highlighter-rouge">mipsr6</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (32-bit, little-endian)</td> <td><code class="language-plaintext highlighter-rouge">mipsel</code>, <code class="language-plaintext highlighter-rouge">mipsallegrexel</code>, <code class="language-plaintext highlighter-rouge">mipsisa32r6el</code>, <code class="language-plaintext highlighter-rouge">mipsr6el</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">mips64</code>, <code class="language-plaintext highlighter-rouge">mips64eb</code>, <code class="language-plaintext highlighter-rouge">mipsn32</code>, <code class="language-plaintext highlighter-rouge">mipsisa64r6</code>, <code class="language-plaintext highlighter-rouge">mips64r6</code>, <code class="language-plaintext highlighter-rouge">mipsn32r6</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (64-bit, little-endian)</td> <td><code class="language-plaintext highlighter-rouge">mips64el</code>, <code class="language-plaintext highlighter-rouge">mipsn32el</code>, <code class="language-plaintext highlighter-rouge">mipsisa64r6el</code>, <code class="language-plaintext highlighter-rouge">mips64r6el</code>, <code class="language-plaintext highlighter-rouge">mipsn32r6el</code></td> </tr> <tr> <td>[RISC-V] (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">riscv32</code></td> </tr> <tr> <td>[RISC-V] (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">riscv64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Z/Architecture">IBM z/Architecture</a></td> <td><code class="language-plaintext highlighter-rouge">s390x</code><sup id="fnref:s390x" role="doc-noteref"><a href="#fn:s390x" class="footnote" rel="footnote">6</a></sup>, <code class="language-plaintext highlighter-rouge">systemz</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a></td> <td><code class="language-plaintext highlighter-rouge">sparc</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a> (little-endian)</td> <td><code class="language-plaintext highlighter-rouge">sparcel</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">sparcv6</code>, <code class="language-plaintext highlighter-rouge">sparc64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/WebAssembly">WebAssembly</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">wasm32</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/WebAssembly">WebAssembly</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">wasm64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Loongson">Loongson</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">loongarch32</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Loongson">Loongson</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">loongarch64</code></td> </tr> </tbody> <tbody> <tr> <td><a href="https://en.wikipedia.org/wiki/Radeon_HD_2000_series">Radeon R600</a></td> <td><code class="language-plaintext highlighter-rouge">r600</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Graphics_Core_Next">AMD GCN</a></td> <td><code class="language-plaintext highlighter-rouge">amdgcn</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Qualcomm_Hexagon">Qualcomm Hexagon</a></td> <td><code class="language-plaintext highlighter-rouge">hexagon</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Parallel_Thread_Execution">Nvidia PTX</a><sup id="fnref:ptx" role="doc-noteref"><a href="#fn:ptx" class="footnote" rel="footnote">7</a></sup> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">nvptx</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Parallel_Thread_Execution">Nvidia PTX</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">nvptx64</code></td> </tr> <tr> <td>AMD IL<sup id="fnref:amdil" role="doc-noteref"><a href="#fn:amdil" class="footnote" rel="footnote">8</a></sup> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">amdil</code></td> </tr> <tr> <td>AMD IL (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">amdil64</code></td> </tr> <tr> <td>Direct-X IL</td> <td><code class="language-plaintext highlighter-rouge">dxil</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Heterogeneous_System_Architecture">HSAIL</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">hsail</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Heterogeneous_System_Architecture">HSAIL</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">hsail64</code></td> </tr> <tr> <td>[Khronos SPIR] (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">spir</code></td> </tr> <tr> <td>[Khronos SPIR] (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">spir64</code></td> </tr> <tr> <td>[Khronos SPIR-V]</td> <td><code class="language-plaintext highlighter-rouge">spirv</code>, …</td> </tr> <tr> <td>[Khronos SPIR-V] (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">spirv32</code>, …</td> </tr> <tr> <td>[Khronos SPIR-V] (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">spirv64</code>, …</td> </tr> <tr> <td><a href="https://developer.android.com/guide/topics/renderscript/compute">Android RenderScript</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">renderscript32</code></td> </tr> <tr> <td><a href="https://developer.android.com/guide/topics/renderscript/compute">Android RenderScript</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">renderscript64</code></td> </tr> <tr> <td><a href="https://en.wikichip.org/wiki/movidius/microarchitectures/shave_v2.0">Movidius SHAVE</a></td> <td><code class="language-plaintext highlighter-rouge">shave</code></td> </tr> </tbody> <tbody> <tr> <td><a href="https://en.wikipedia.org/wiki/AVR_microcontrollers">Atmel AVR</a></td> <td><code class="language-plaintext highlighter-rouge">avr</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Motorola_68000_series">Motorola 68k</a></td> <td><code class="language-plaintext highlighter-rouge">m68k</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARC_(processor)">Argonaut ARC</a></td> <td><code class="language-plaintext highlighter-rouge">arc</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/TI_MSP430">Texas Instruments MSP430</a></td> <td><code class="language-plaintext highlighter-rouge">msp430</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Tensilica">Tensilica Xtensa</a></td> <td><code class="language-plaintext highlighter-rouge">xtensa</code></td> </tr> <tr> <td><a href="https://c-sky.github.io/">C-SKY</a></td> <td><code class="language-plaintext highlighter-rouge">csky</code></td> </tr> <tr> <td><a href="https://github.com/cpc/openasip">OpenASIP</a></td> <td><code class="language-plaintext highlighter-rouge">tce</code></td> </tr> <tr> <td><a href="https://github.com/cpc/openasip">OpenASIP</a> (little-endian)</td> <td><code class="language-plaintext highlighter-rouge">tcele</code></td> </tr> <tr> <td><a href="https://q3k.org/lanai.html">Myracom Lanai</a></td> <td><code class="language-plaintext highlighter-rouge">lanai</code></td> </tr> <tr> <td>XMOS xCore</td> <td><code class="language-plaintext highlighter-rouge">xcore</code></td> </tr> <tr> <td>Kalimba<sup id="fnref:idk" role="doc-noteref"><a href="#fn:idk" class="footnote" rel="footnote">9</a></sup></td> <td><code class="language-plaintext highlighter-rouge">kalimba</code></td> </tr> <tr> <td>ve<sup id="fnref:idk:1" role="doc-noteref"><a href="#fn:idk" class="footnote" rel="footnote">9</a></sup></td> <td><code class="language-plaintext highlighter-rouge">ve</code></td> </tr> </tbody> </table> <p>Here we begin to see that target triples are not a neat system. They are <em>hell</em>. Where a list of architecture names contains a “…”, it means that LLVM accepts many more names.</p> <p>The problem is that architectures often have <em>versions</em> and <em>features</em>, which subtly change how the compiler generates code. For example, when compiling for an <code class="language-plaintext highlighter-rouge">x86_64</code>, we may want to specify that we want AVX512 instructions to be used. On LLVM, you might do that with <code class="language-plaintext highlighter-rouge">-mattr=+avx512</code>. Every architecture has a subtly-different way of doing this, because every architecture had a <em>different GCC</em>! Each variant of GCC would put different things behind <code class="language-plaintext highlighter-rouge">-mXXX</code> flags (<code class="language-plaintext highlighter-rouge">-m</code> for “machine”), meaning that the interface is not actually that uniform. The meanings of <code class="language-plaintext highlighter-rouge">-march</code>, <code class="language-plaintext highlighter-rouge">-mcpu</code>, <code class="language-plaintext highlighter-rouge">-mtune</code>, and <code class="language-plaintext highlighter-rouge">-mattr</code> thus vary wildly for this reason.</p> <p>Because LLVM is supposed to replace GCC (for the most part), it replicates a lot of this wacky behavior.</p> <p>So uh, we gotta talk about 32-bit ARM architecture names.</p> <h3 id="armtargetparsercpp"><a href="#armtargetparsercpp"><code class="language-plaintext highlighter-rouge">ARMTargetParser.cpp</code></a></h3> <p>There is a hellish file in LLVM dedicated to parsing ARM architecture names. Although members of the ARM family have many configurable features (which you can discover with <code class="language-plaintext highlighter-rouge">llc -march aarch64 -mattr help</code><sup id="fnref:llc" role="doc-noteref"><a href="#fn:llc" class="footnote" rel="footnote">10</a></sup>), the name of the architecture is somewhat meaningful, and can hav many options, mostly relating to the many versions of ARM that exist.</p> <p>How bad is it? Well, we can look at all of the various ARM targets that <code class="language-plaintext highlighter-rouge">rustc</code> supports with <code class="language-plaintext highlighter-rouge">rustc --print target-list</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>rustc <span class="nt">--print</span> target-list | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'arm|aarch|thumb'</span> <span class="se">\</span>
<span class="go">  | cut -d- -f1 | sort | uniq
aarch64
aarch64_be
arm
arm64_32
arm64e
arm64ec
armeb
armebv7r
armv4t
armv5te
armv6
armv6k
armv7
armv7a
armv7k
armv7r
armv7s
armv8r
thumbv4t
thumbv5te
thumbv6m
thumbv7a
thumbv7em
thumbv7m
thumbv7neon
thumbv8m.base
thumbv8m.main</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Most of these are 32-bit ARM versions, with profile information attached. These correspond to the names given <a href="https://en.wikipedia.org/wiki/ARM_architecture_family#Cores">here</a>. Why does ARM stick version numbers in the architecture name, instead of using <code class="language-plaintext highlighter-rouge">-mcpu</code> like you would on x86 (e.g. <code class="language-plaintext highlighter-rouge">-mcpu alderlake</code>)? I have no idea, because ARM is not my strong suit. It’s likely because of how early ARM support was added to GCC.</p> <p>Internally, LLVM calls these “subarchitectures”, although ARM gets special handling because there’s so many variants. SPIR-V, Direct X, and MIPS all have subarchitectures, so you might see something like <code class="language-plaintext highlighter-rouge">dxilv1.7</code> if you’re having a bad day.</p> <p>Of course, LLVM’s ARM support also sports some naughty subarchitectures not part of this system, with naughty made up names.</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">arm64e</code> is an Apple thing, which is an enhancement of <code class="language-plaintext highlighter-rouge">aarch64</code> present on some Apple hardware, which adds their own flavor of <a href="https://developer.apple.com/documentation/security/preparing-your-app-to-work-with-pointer-authentication">pointer authentication</a> and some other features.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">arm64ec</code> is a completely unrelated Microsoft invention that is essentially “<code class="language-plaintext highlighter-rouge">aarch64</code> but with an <code class="language-plaintext highlighter-rouge">x86_64</code>-ey ABI” to make <code class="language-plaintext highlighter-rouge">x86_64</code> emulation on what would otherwise be <code class="language-plaintext highlighter-rouge">aarch64-pc-windows-msvc</code> target somewhat more amenable.</p> </li> </ul> <blockquote> <p>Why the Windows people invented a whole other ABI instead of making things clean and simple like Apple did with Rosetta on ARM MacBooks? I have no idea, but <a href="http://www.emulators.com/docs/abc_arm64ec_explained.htm">http://www.emulators.com/docs/abc_arm64ec_explained.htm</a> contains various excuses, none of which I am impressed by. My read is that their compiler org was just worse at life than Apple’s, which is not surprising, since Apple does compilers better than anyone else in the business.</p> </blockquote> <p>Actually, since we’re on the topic of the names of architectures, I have a few things I need to straighten out.</p> <h3 id="made-up-names-of-architectures"><a href="#made-up-names-of-architectures">Made Up Names of Architectures</a></h3> <p>x86 and ARM both seem to attract a lot of people making up nicknames for them, which leads to a lot of confusion in:</p> <ol> <li> <p>What the “real” name is.</p> </li> <li> <p>What name a particular toolchain wants.</p> </li> <li> <p>What name you should use in your own cosmopolitan tooling.</p> </li> </ol> <p>Let’s talk about the incorrect names people like to make up for them. Please consider the following a relatively normative reference on what people call these architectures, based on my own experience with many tools.</p> <p>When we say “x86” unqualified, in 2025, we almost always mean <code class="language-plaintext highlighter-rouge">x86_64</code>, because 32-bit x86 is dead. If you need to talk about 32-bit x86, you should either say “32-bit x86”, “protected mode”<sup id="fnref:x86-modes" role="doc-noteref"><a href="#fn:x86-modes" class="footnote" rel="footnote">11</a></sup>, or “i386” (the first Intel microarchitecture that implemented protected mode)<sup id="fnref:i386" role="doc-noteref"><a href="#fn:i386" class="footnote" rel="footnote">12</a></sup>. You should not call it <code class="language-plaintext highlighter-rouge">x86_32</code> or just <code class="language-plaintext highlighter-rouge">x86</code>.</p> <p>You might also call it IA-32 for Intel Architecture 32, (or <code class="language-plaintext highlighter-rouge">ia32</code>), but nobody calls it that and you risk confusing people with <code class="language-plaintext highlighter-rouge">ia64</code>, or IA-64, the official name of Intel’s failed general-purpose VLIW architecture, <a href="https://en.wikipedia.org/wiki/Itanium">Itanium</a>, which is in no way compatible with x86. <code class="language-plaintext highlighter-rouge">ia64</code> was what GCC and LLVM named Itanium triples with. Itanium support was drowned in a bathtub during the Obama administration, so it’s not really relevant anymore. Rust has never had official Itanium support.</p> <p>32-bit x86 is <em>extremely not</em> called “x32”; this is what Linux used to call its x86 ILP32<sup id="fnref:ilp32:1" role="doc-noteref"><a href="#fn:ilp32" class="footnote" rel="footnote">4</a></sup> variant before it was removed (which, following the ARM names, would have been called <code class="language-plaintext highlighter-rouge">x86_6432</code>).</p> <p>There are also many ficticious names for 64-bit x86, which you should avoid unless you want the younger generation to make fun of you. <code class="language-plaintext highlighter-rouge">amd64</code> refers to AMD’s original implementation of long mode in their K8 microarchitecture, first shipped in their <a href="https://en.wikipedia.org/wiki/Athlon_64">Athlon 64</a> product. AMD still makes the best x86 chips (I am writing this on a machine socketed with a Zen2 Threadripper), sure, but calling it <code class="language-plaintext highlighter-rouge">amd64</code> is silly and also looks a lot like <code class="language-plaintext highlighter-rouge">arm64</code>, and I am honestly kinda annoyed at how much Go code I’ve seen with files named <code class="language-plaintext highlighter-rouge">fast_arm64.s</code> and <code class="language-plaintext highlighter-rouge">fast_amd64.s</code>. Debian also uses <code class="language-plaintext highlighter-rouge">amd64</code>/<code class="language-plaintext highlighter-rouge">arm64</code>, which makes browsing packages kind of annoying.</p> <p>On that topic, you should <em>absolutely not</em> call 64-bit mode <code class="language-plaintext highlighter-rouge">k8</code>, after the AMD K8. Nobody except for weird computer taxonomists like me know what that is. But Bazel calls it that, and it’s really irritating<sup id="fnref:piii" role="doc-noteref"><a href="#fn:piii" class="footnote" rel="footnote">13</a></sup>.</p> <p>You should also not call it <code class="language-plaintext highlighter-rouge">x64</code>. Although LLVM does accept <code class="language-plaintext highlighter-rouge">amd64</code> for historical purposes, no one calls it <code class="language-plaintext highlighter-rouge">x64</code> except for Microsoft. And even though it is fairly prevalent on Windows, I absolutely give my gamedev friends a hard time when they write <code class="language-plaintext highlighter-rouge">x64</code>.</p> <p>On the ARM side, well. Arm<sup id="fnref:arm-holdings" role="doc-noteref"><a href="#fn:arm-holdings" class="footnote" rel="footnote">14</a></sup> has a bad habit of not using consistent naming for 64-bit ARM, since they used both AArch64 and ARM64 for it. However, in compiler land, <code class="language-plaintext highlighter-rouge">aarch64</code> appears to be somewhat more popular.</p> <p>You should also probably stick to the LLVM names for the various architectures, instead of picking your favorite Arm Cortex name (like <code class="language-plaintext highlighter-rouge">cortex_m0</code>).</p> <h2 id="vendors-and-operating-systems"><a href="#vendors-and-operating-systems">Vendors and Operating Systems</a></h2> <p>The worst is over. Let’s now move onto examinining the rest of the triple: the platform vendor, and the operating system.</p> <p>The vendor is intended to identify who is responsible for the ABI definition for that target. Although provides little to no value to the compiler itself, but it does help to sort related targets together. Sort of.</p> <p>Returning to <code class="language-plaintext highlighter-rouge">llvm::Triple</code>, we can examine <code class="language-plaintext highlighter-rouge">Triple::VendorType</code>. Vendors almost always correspond to companies which develop operating systems or other platforms that code runs on, with some exceptions.</p> <p>We can also get the vendors that <code class="language-plaintext highlighter-rouge">rustc</code> knows about with a handy dandy command:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">rustc --print target-list | grep -P '\w+-\w+-' | cut -d- -f2 | sort | uniq</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>The result is this. This is just a representative list; I have left off a few that are not going to be especially recognizeable.</p> <table> <thead> <tr> <th>Vendor</th> <th>Name</th> <th>Example Triple</th> </tr> </thead> <tbody> <tr> <td>Vendor Unknown<sup id="fnref:unknown" role="doc-noteref"><a href="#fn:unknown" class="footnote" rel="footnote">15</a></sup></td> <td><code class="language-plaintext highlighter-rouge">unknown</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code></td> </tr> <tr> <td>“PC”</td> <td><code class="language-plaintext highlighter-rouge">pc</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-pc-windows-msvc</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/AMD">Advanced Micro Devices Inc.</a></td> <td><code class="language-plaintext highlighter-rouge">amd</code></td> <td><code class="language-plaintext highlighter-rouge">amdgcn-amd-gfx906</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Apple_Inc.">Apple Inc.</a></td> <td><code class="language-plaintext highlighter-rouge">apple</code></td> <td><code class="language-plaintext highlighter-rouge">aarch64-apple-ios-sim</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Intel">Intel Corporation</a></td> <td><code class="language-plaintext highlighter-rouge">intel</code></td> <td><code class="language-plaintext highlighter-rouge">i386-intel-elfiamcu</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/IBM">IBM Corporation</a></td> <td><code class="language-plaintext highlighter-rouge">ibm</code></td> <td><code class="language-plaintext highlighter-rouge">powerpc64-ibm-aix</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Mesa_(computer_graphics)">Mesa3D Project</a></td> <td><code class="language-plaintext highlighter-rouge">mesa</code></td> <td><code class="language-plaintext highlighter-rouge">amdgcn-mesa-mesa3d</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_Technologies">MIPS Technologies LLC</a></td> <td><code class="language-plaintext highlighter-rouge">mti</code></td> <td><code class="language-plaintext highlighter-rouge">mips-mti-none-elf</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Nintendo">Nintendo</a></td> <td><code class="language-plaintext highlighter-rouge">nintendo</code></td> <td><code class="language-plaintext highlighter-rouge">armv6k-nintendo-3ds</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Nvidia">Nvidia Corporation</a></td> <td><code class="language-plaintext highlighter-rouge">nvidia</code></td> <td><code class="language-plaintext highlighter-rouge">nvptx64-nvidia-cuda</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Sony_Interactive_Entertainment">Sony Interactive Entertainment</a></td> <td><code class="language-plaintext highlighter-rouge">scei</code>, <code class="language-plaintext highlighter-rouge">sie</code>, <code class="language-plaintext highlighter-rouge">sony</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-sie-ps5</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Sun_Microsystems">Sun Microsystems</a></td> <td><code class="language-plaintext highlighter-rouge">sun</code></td> <td><code class="language-plaintext highlighter-rouge">sparcv9-sun-solaris</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SUSE_S.A.">SUSE S. A.</a></td> <td><code class="language-plaintext highlighter-rouge">suse</code></td> <td><code class="language-plaintext highlighter-rouge">aarch64-suse-linux</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Red_Hat">Red Hat, Inc</a></td> <td><code class="language-plaintext highlighter-rouge">redhat</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-redhat-linux</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Universal_Windows_Platform">Universal Windows Platform</a></td> <td><code class="language-plaintext highlighter-rouge">uwp</code></td> <td><code class="language-plaintext highlighter-rouge">aarch64-uwp-windows-msvc</code></td> </tr> </tbody> </table> <p>Most vendors are the names of organizations that produce hardware or operating systems. For example <code class="language-plaintext highlighter-rouge">suse</code> and <code class="language-plaintext highlighter-rouge">redhat</code> are used for those organizations’ Linux distributions, as a funny branding thing. Some vendors are projects, like the <code class="language-plaintext highlighter-rouge">mesa</code> vendor used with the Mesa3D OpenGL implementation’s triples.</p> <p>The <code class="language-plaintext highlighter-rouge">unknown</code> vendor is used for cases where the vendor is not specified or just not important. For example, the canonical Linux triple is <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code>… although one could argue it should be <code class="language-plaintext highlighter-rouge">x86_64-torvalds-linux</code>. It is not uncommon for companies that sell/distribute Linux distributions to have their own target triples, as do SUSE and sometimes RedHat. Notably, there are no triples with a <code class="language-plaintext highlighter-rouge">google</code> vendor, even though <code class="language-plaintext highlighter-rouge">aarch64-linux-android</code> and <code class="language-plaintext highlighter-rouge">aarch64-unknown-fuchsia</code> should really be called <code class="language-plaintext highlighter-rouge">aarch64-google-linux-android</code> and <code class="language-plaintext highlighter-rouge">aarch64-google-fuchsia</code>. The target triple system begins to show cracks here.</p> <p>The <code class="language-plaintext highlighter-rouge">pc</code> vendor is a bit weirder, and is mostly used by Windows targets. The standard Windows target is <code class="language-plaintext highlighter-rouge">x86_64-pc-windows-msvc</code>, but really it should have been <code class="language-plaintext highlighter-rouge">x86_64-microsoft-windows-msvc</code>. This is likely complicated by the fact that there is also a <code class="language-plaintext highlighter-rouge">x86_64-pc-windows-gnu</code> triple, which is for <a href="https://en.wikipedia.org/wiki/MinGW">MinGW</a> code. This platform, despite running on Windows, is not provided by Microsoft, so it would probably make more sense to be called <code class="language-plaintext highlighter-rouge">x86_64-unknown-windows-gnu</code>.</p> <p>But not all Windows targets are <code class="language-plaintext highlighter-rouge">pc</code>! <a href="https://en.wikipedia.org/wiki/Universal_Windows_Platform">UWP</a> apps use a different triple, that replaces the <code class="language-plaintext highlighter-rouge">pc</code> with <code class="language-plaintext highlighter-rouge">uwp</code>. <code class="language-plaintext highlighter-rouge">rustc</code> provides targets for Windows 7 backports that use a <code class="language-plaintext highlighter-rouge">win7</code> “vendor”.</p> <h3 id="beyond-operating-systems"><a href="#beyond-operating-systems">Beyond Operating Systems</a></h3> <p>The third (or sometimes second, ugh) component of a triple is the operating system, or just “system”, since it’s much more general than that. The main thing that compilers get from this component relates to generating code to interact with the operating system (e.g. SEH on Windows) and various details related to linking, such as object file format and relocations.</p> <p>It’s also used for setting defines like <code class="language-plaintext highlighter-rouge">__linux__</code> in C, which user code can use to determine what to do based on the target.</p> <p>We’ve seen <code class="language-plaintext highlighter-rouge">linux</code> and <code class="language-plaintext highlighter-rouge">windows</code>, but you may have also seen <code class="language-plaintext highlighter-rouge">x86_64-apple-darwin</code>. <em>Darwin?</em></p> <p>The operating system formerly known as Mac OS X (now macOS<sup id="fnref:macos" role="doc-noteref"><a href="#fn:macos" class="footnote" rel="footnote">16</a></sup>) is a POSIX operating system. The POSIX substrate that all the Apple-specific things are built on top of is called Darwin. [Darwin]https://en.wikipedia.org/wiki/Darwin_(operating_system) is a free and open source operating system based on Mach, a research kernel whose name survives in Mach-O, the object file format used by all Apple products.</p> <p>All of the little doodads Apple sells use the actual official names of their OSes, like <code class="language-plaintext highlighter-rouge">aarch64-apple-ios</code>. For, you know, iOS. On your iPhone. Built with Xcode on your iMac.</p> <p><code class="language-plaintext highlighter-rouge">none</code> is a common value for this entry, which usually means a free-standing environment with no operating system. The object file format is usually specified in the fourth entry of the triple, so you might see something like <code class="language-plaintext highlighter-rouge">riscv32imc-unknown-none-elf</code>.</p> <p>Sometimes the triple refers not to an operating system, but to a complete hardware product. This is common with game console triples, which have “operating system” names like <code class="language-plaintext highlighter-rouge">ps4</code>, <code class="language-plaintext highlighter-rouge">psvita</code>, <code class="language-plaintext highlighter-rouge">3ds</code>, and <code class="language-plaintext highlighter-rouge">switch</code>. (Both Sony and Nintendo use LLVM as the basis for their internal toolchains; the Xbox toolchain is just MSVC).</p> <h2 id="abi-abi"><a href="#abi-abi">ABI! ABI!</a></h2> <p>The fourth entry of the triple (and I repeat myself, yes, it’s still a triple) represents the binary interface for the target, when it is ambiguous.</p> <p>For example, Apple targets never have this, because on an Apple platform, you just shut up and use <code class="language-plaintext highlighter-rouge">CoreFoundation.framework</code> as your libc. Except this isn’t true, because of things like <code class="language-plaintext highlighter-rouge">x86_64-apple-ios-sim</code>, the iOS simulator running on an x86 host.</p> <p>On the other hand, Windows targets will usually specify <code class="language-plaintext highlighter-rouge">-msvc</code> or <code class="language-plaintext highlighter-rouge">-gnu</code>, to indicate whether they are built to match MSVC’s ABI or MinGW. Linux targets will usually specify the libc vendor in this position: <code class="language-plaintext highlighter-rouge">-gnu</code> for glibc, <code class="language-plaintext highlighter-rouge">-musl</code> for musl, <code class="language-plaintext highlighter-rouge">-newlib</code> for newlib, and so on.</p> <p>This doesn’t just influence the calling convention; it also influences how language features, such as thread locals and dynamic linking, are handled. This usually requires coordination with the target libc.</p> <p>On ARM free-standing (<code class="language-plaintext highlighter-rouge">armxxx-unknown-none</code>) targets, <code class="language-plaintext highlighter-rouge">-eabi</code> specifies the ARM EABI, which is a standard embeded ABI for ARM. <code class="language-plaintext highlighter-rouge">-eabihf</code> is similar, but indicates that no soft float support is necessary (<code class="language-plaintext highlighter-rouge">hf</code> stands for hardfloat). (Note that Rust does not include a vendor with these architectures, so they’re more like <code class="language-plaintext highlighter-rouge">armv7r-none-eabi</code>).</p> <p>A lot of jankier targets use the ABI portion to specify the object file, such as the aforementioned <code class="language-plaintext highlighter-rouge">riscv32imc-unknown-none-elf</code>.</p> <h2 id="wasm-targets"><a href="#wasm-targets">WASM Targets</a></h2> <p>One last thing to note are the various WebAssembly targets, which completely ignore all of the above conventions. Their triples often only have two components (they are still called triples, hopefully I’ve made that clear by now). Rust is a little bit more on the forefront here than <code class="language-plaintext highlighter-rouge">clang</code> (and anyways I don’t want to get into Emscripten) so I’ll stick to what’s going on in <code class="language-plaintext highlighter-rouge">rustc</code>.</p> <p>There’s a few variants. <code class="language-plaintext highlighter-rouge">wasm32-unknown-unknown</code> (here using <code class="language-plaintext highlighter-rouge">unknown</code> instead of <code class="language-plaintext highlighter-rouge">none</code> as the system, oops) is a completely bare WebAssebly runtime where none of the standard library that needs to interact with the outside world works. This is essentially for building WebAssembly modules to deploy in a browser.</p> <p>There are also the WASI targets, which provide a standard ABI for talking to the host operating system. These are less meant for browsers and more for people who are using WASI as a security boundary. These have names like <code class="language-plaintext highlighter-rouge">wasm32-wasip1</code>, which, unusually, lack a vendor! A “more correct” formulation would have been <code class="language-plaintext highlighter-rouge">wasm32-unknown-wasip1</code>.</p> <h2 id="aside-on-go"><a href="#aside-on-go">Aside on Go</a></h2> <p>Go does the correct thing and distributes a cross compiler. This is well and good.</p> <p>Unfortunately, they decided to be different and special and do not use the target triple system for naming their targets. Instead, you set the <code class="language-plaintext highlighter-rouge">GOARCH</code> and <code class="language-plaintext highlighter-rouge">GOOS</code> environment variables before invoking <code class="language-plaintext highlighter-rouge">gc</code>. This will sometimes be shown printed with a slash between, such as <code class="language-plaintext highlighter-rouge">linux/amd64</code>.</p> <p>Thankfully, they at least provide documentation for a relevant internal package <a href="https://pkg.go.dev/internal/platform">here</a>, which offers the names of various <code class="language-plaintext highlighter-rouge">GOARCH</code> and <code class="language-plaintext highlighter-rouge">GOOS</code> values.</p> <p>They use completely different names from everyone else for a few things, which is guaranteed to trip you up. They use call the 32- and 64-bit variants of x86 <code class="language-plaintext highlighter-rouge">386</code> (note the lack of leading <code class="language-plaintext highlighter-rouge">i</code>) and <code class="language-plaintext highlighter-rouge">amd64</code>. They call 64-bit ARM <code class="language-plaintext highlighter-rouge">arm64</code>, instead of <code class="language-plaintext highlighter-rouge">aarch64</code>. They call little-endian MIPSes <code class="language-plaintext highlighter-rouge">mipsle</code> instead of <code class="language-plaintext highlighter-rouge">mipsel</code>.</p> <p>They also call 32-bit WebAssembly <code class="language-plaintext highlighter-rouge">wasm</code> instead of <code class="language-plaintext highlighter-rouge">wasm32</code>, which is a bit silly, and they use <code class="language-plaintext highlighter-rouge">js/wasm</code> as their equivalent of <code class="language-plaintext highlighter-rouge">wasm32-unknown-unknown</code>, which is <em>very</em> silly.</p> <p>Android is treated as its own operating system, <code class="language-plaintext highlighter-rouge">android</code>, rather than being <code class="language-plaintext highlighter-rouge">linux</code> with a particular ABI; their system also can’t account for ABI variants in general, since Go originally wanted to not have to link any system libraries, something that does not actually work.</p> <p>If you are building a new toolchain, don’t be clever by inventing a cute target triple convention. All you’ll do is annoy people who need to work with a lot of different toolchains by being different and special.</p> <h2 id="inventing-your-own-triples"><a href="#inventing-your-own-triples">Inventing Your Own Triples</a></h2> <p>Realistically, you probably shouldn’t. But if you must, you should probably figure out what you want out of the triple.</p> <p>Odds are there isn’t anything interesting to put in the vendor field, so you will avoid people a lot of pain by picking <code class="language-plaintext highlighter-rouge">unknown</code>. Just include a vendor to avoid pain for people in the future.</p> <p>You should also avoid inventing a new name for an existing architecture. Don’t name your hobby operating system’s triple <code class="language-plaintext highlighter-rouge">amd64-unknown-whatever</code>, please. And you definitely don’t want to have an ABI component. One ABI is enough.</p> <p>If you’re inventing a triple for a free-standing environment, but want to specify something about the hardware configuration, you’re probably gonna want to use <code class="language-plaintext highlighter-rouge">-none-&lt;abi&gt;</code> for your system. For some firmware use-cases, though, the system entry is a better place, such as for the UEFI triples. Although, I have unforunately seen both <code class="language-plaintext highlighter-rouge">x86_64-unknown-uefi</code> and <code class="language-plaintext highlighter-rouge">x86_64-pc-none-uefi</code> in the wild.</p> <p>And most imporantly: this sytem was built up organically. Disabuse yourself now of the idea that the system is consistent and that target triples are easy to parse. Trying to parse them will make you very sad.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:quad" role="doc-endnote"> <p>And no, a “target quadruple” is not a thing and if I catch you saying that I’m gonna bonk you with an Intel optimization manual. <a href="#fnref:quad" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:toolchain" role="doc-endnote"> <p>I’m not sure why GCC does this. I suspect that it’s because computer hard drives used to be small and a GCC with every target would have been too large to cram into every machine. Maybe it has some UNIX philosophy woo mixed into it.</p> <p>Regardless, it’s really annoying and thankfully no one else does this because cross compiling shouldn’t require hunting down a new toolchain for each platform. <a href="#fnref:toolchain" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:x86_86h" role="doc-endnote"> <p>This is for Apple’s later-gen x86 machines, before they went all-in on ARM desktop. <a href="#fnref:x86_86h" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ilp32" role="doc-endnote"> <p>ILP32 means that the <code class="language-plaintext highlighter-rouge">int</code>, <code class="language-plaintext highlighter-rouge">long</code>, and pointer types in C are 32-bit, despite the architecture being 64-bit. This allows writing programs that are small enough top jive in a 32-bit address space, while taking advantage of fast 64-bit operations. It is a bit of a frankentarget. Also existed once as a process mode on <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code> by the name of <code class="language-plaintext highlighter-rouge">x32</code>. <a href="#fnref:ilp32" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:ilp32:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:power" role="doc-endnote"> <p>Not to be confused with POWER, an older IBM CPU. <a href="#fnref:power" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:s390x" role="doc-endnote"> <p>This name is Linux’s name for IBM’s z/Architecture. See <a href="https://en.wikipedia.org/wiki/Linux_on_IBM_Z#Hardware">https://en.wikipedia.org/wiki/Linux_on_IBM_Z#Hardware</a>. <a href="#fnref:s390x" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ptx" role="doc-endnote"> <p>Not a real chip; refers to Nvidia’s PTX IR, which is what CUDA compiles to. <a href="#fnref:ptx" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:amdil" role="doc-endnote"> <p>Similar to PTX; an IR used by AMD for graphics. See <a href="https://openwall.info/wiki/john/development/AMD-IL">https://openwall.info/wiki/john/development/AMD-IL</a>. <a href="#fnref:amdil" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:idk" role="doc-endnote"> <p>No idea what this is, and Google won’t help me. <a href="#fnref:idk" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:idk:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:llc" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge">llc</code> is the LLVM compiler, which takes LLVM IR as its input. Its interface is much more regular than <code class="language-plaintext highlighter-rouge">clang</code>’s because it’s not intended to be a substitute for GCC the way <code class="language-plaintext highlighter-rouge">clang</code> is. <a href="#fnref:llc" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:x86-modes" role="doc-endnote"> <p>Very kernel-hacker-brained name. It references the three processor modes of an x86 machine: real mode, protected mode, long mode, which correspond to 16-, 32-, and 64-bit modes. There is also a secret fourth mode called <a href="https://en.wikipedia.org/wiki/Unreal_mode">unreal mode</a>, which is just what happens when you come down to real mode from protected mode after setting up a protected mode GDT.</p> <p>If you need to refer to real mode, call it “real mode”. Don’t try to be clever by calling it “8086” because you are almost certainly going to be using features that were not in the original Intel 8086. <a href="#fnref:x86-modes" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:i386" role="doc-endnote"> <p>I actually don’t like this name, but it’s the one LLVM uses so I don’t really get to complain. <a href="#fnref:i386" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:piii" role="doc-endnote"> <p>Bazel also calls 32-bit x86 <code class="language-plaintext highlighter-rouge">piii</code>, which stands for, you guessed it, “Pentium III”. Extremely unserious. <a href="#fnref:piii" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:arm-holdings" role="doc-endnote"> <p>The intelectual property around ARM, the architecture famility, is owned by the British company Arm Holdings. Yes, the spelling difference is significant.</p> <p>Relatedly, ARM is not an acronym, and is sometimes styled in all-lowercase as arm. The distant predecesor of Arm Holdings is Acorn Computers. Their first compute, the Acorn Archimedes, contained a chip whose target triple name today might have been <code class="language-plaintext highlighter-rouge">armv1</code>. Here, ARM was an acronym, for Acorn RISC Machine. Wikipedia alleges without citation that the name was at once point changed to Advanced RISC Machine at the behest of Apple, but I am unable to find more details. <a href="#fnref:arm-holdings" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:unknown" role="doc-endnote"> <p>“You are not cool enough for your company to be on the list.” <a href="#fnref:unknown" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:macos" role="doc-endnote"> <p>Which I pronounce as one word, “macos”, to drive people crazy. <a href="#fnref:macos" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="dark-arts"/><category term="assembly"/><summary type="html"><![CDATA[Cross-compiling is taking a computer program and compiling it for a machine that isn’t the one hosting the compilation. Although historically compilers would only compile for the host machine, this is considered an anachronism: all serious native compilers are now cross-compilers.]]></summary></entry><entry><title type="html">Protobuf Tip #1: Field Names Are Forever</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2025/04/08/protobuf-tip-1/" rel="alternate" type="text/html" title="Protobuf Tip #1: Field Names Are Forever"/><published>2025-04-08T00:00:00-07:00</published><updated>2025-04-08T00:00:00-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2025/04/08/protobuf-tip-1</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2025/04/08/protobuf-tip-1/"><![CDATA[<p><em>I wake up every morning and grab the morning paper. Then I look at the obituary page. If my name is not on it, I get up. –Ben Franklin</em></p> <p>TL;DR: Don’t rename fields. Even though there are a slim number of cases where you can get away with it, it’s rarely worth doing, and is a potential source of bugs.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-1-field-names">buf.build blog</a>.</p> </blockquote> <h2 id="names-and-tags"><a href="#names-and-tags">Names and Tags</a></h2> <p>Protobuf message fields have <em>field tags</em> that are used in the binary wire format to discriminate fields. This means that the wire format serialization does not actually depend on the <em>names</em> of the fields. For example, the following messages will use the exact same serialization format.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Foo</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Foo2</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In fact, the designers of Protobuf intended for it to be feasible to rename an in-use field. However, they were not successful: it can still be a breaking change.</p> <h2 id="schema-consumers-need-to-update"><a href="#schema-consumers-need-to-update">Schema Consumers Need to Update</a></h2> <p>If your schema is public, the generated code will change. For example, renaming a field from <code class="language-plaintext highlighter-rouge">first_name</code> to <code class="language-plaintext highlighter-rouge">given_name</code> will cause the corresponding Go accessor to change from <code class="language-plaintext highlighter-rouge">FirstName</code> to <code class="language-plaintext highlighter-rouge">GivenName</code>, potentially breaking downstream consumers.</p> <p>Renaming a field to a “better” name is almost never a worthwhile change, simply because of this breakage.</p> <h2 id="json-serialization-breaks"><a href="#json-serialization-breaks">JSON Serialization Breaks</a></h2> <p>Wire format serialization doesn’t look at names, but JSON does! This means that <code class="language-plaintext highlighter-rouge">Foo</code> and <code class="language-plaintext highlighter-rouge">Foo2</code> above serialize as <code class="language-plaintext highlighter-rouge">{"bar":"content"}</code> and <code class="language-plaintext highlighter-rouge">{"bar2":"content"}</code> respectively, making them non-interchangeable.</p> <p>This can be partially mitigated by using the <code class="language-plaintext highlighter-rouge">[json_name = "..."]</code> option on a field. However, this doesn’t actually work, because many Protobuf runtimes’ JSON codecs will accept both the name set in <code class="language-plaintext highlighter-rouge">json_name</code>, <em>and</em> the specified field name. So <code class="language-plaintext highlighter-rouge">string given_name = 1 [json_name = "firstName"];</code> will allow deserializing from a key named <code class="language-plaintext highlighter-rouge">given_name</code>, but not <code class="language-plaintext highlighter-rouge">first_name</code> like it used to. This is still a breaking protocol change!</p> <p>This is a place where Protobuf could have done better—if <code class="language-plaintext highlighter-rouge">json_name</code> had been a <code class="language-plaintext highlighter-rouge">repeated string</code>, this wire format breakage would have been avoidable. However, for reasons given below, renames are still a bad idea.</p> <h2 id="reflection"><a href="#reflection">Reflection!</a></h2> <p>Even if you could avoid source and JSON breakages, the names are always visible to reflection. Although it’s <em>very</em> hard to guard against reflection breakages in general (since it can even see the order fields are declared in), this is one part of reflection that can be especially insidious—for example, if callers choose to sort fields by name, or if some middleware is using the name of a field to identify its frequency, or logging/redaction needs.</p> <p>Don’t change the name, because reflection means you can’t know what’ll go wrong!</p> <h2 id="but-i-really-have-to"><a href="#but-i-really-have-to">But I Really Have To!</a></h2> <p>There are valid reasons for wanting to rename a field, such as expanding its scope. For example, <code class="language-plaintext highlighter-rouge">first_name</code> and <code class="language-plaintext highlighter-rouge">given_name</code> are not the same concept: in the Sinosphere, as well as in Hungary, the first name in a person’s full name is their family name, not their given name.</p> <p>Or maybe a field that previously referred to a monetary amount, say <code class="language-plaintext highlighter-rouge">cost_usd</code>, is being updated to not specify the currency:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Before</span> <span class="p">{</span>
  <span class="kt">sint64</span> <span class="na">cost_usd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">After</span> <span class="p">{</span>
  <span class="kd">enum</span> <span class="n">Currency</span> <span class="p">{</span>
    <span class="na">CURRENCY_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">CURRENCY_USD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="na">CURRENCY_EUR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="na">CURRENCY_JPY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="na">CURRENCY_USD_1000TH</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 0.1 cents.</span>
  <span class="p">}</span>

  <span class="kt">sint64</span> <span class="na">cost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Currency</span> <span class="na">currency</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In cases like this, <strong>renaming the field is a terrible idea</strong>. Setting aside source code or JSON breakage, the new field has completely different semantics. If an old consumer, expecting a price in USD, receives a new wire format message serialized from <code class="language-plaintext highlighter-rouge">{"cost":990,"currency":"CURRENCY_USD_1000TH"}</code>, it will incorrectly interpret the price as 990USD, rather than 0.99USD. That’s a disastrous bug!</p> <p>Instead, the right plan is to add <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">currency</code> side-by-side <code class="language-plaintext highlighter-rouge">cost_usd</code>. Then, readers should first check for <code class="language-plaintext highlighter-rouge">cost_usd</code> when reading <code class="language-plaintext highlighter-rouge">cost</code>, and take that to imply that <code class="language-plaintext highlighter-rouge">currency</code> is <code class="language-plaintext highlighter-rouge">CURRENCY_USD</code> (it’s also worth generating an error if <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">cost_usd</code> are both present).</p> <p><code class="language-plaintext highlighter-rouge">cost_usd</code> can then be marked as <code class="language-plaintext highlighter-rouge">[deprecated = true]</code> . It is possible to even delete <code class="language-plaintext highlighter-rouge">cost_usd</code> in some cases, such as when you control all readers and writers — but if you don’t, the risk is very high. Plus, you kind of need to be able to re-interpret <code class="language-plaintext highlighter-rouge">cost_usd</code> as the value of <code class="language-plaintext highlighter-rouge">cost</code> in perpetuity.</p> <p>If you do wind up deleting them, make sure to reserve the field’s number and name, to avoid accidental re-use.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="n">reserved</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">reserved</span> <span class="s">"cost_usd"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>But try not to. Renaming fields is nothing but tears and pain.</p>]]></content><author><name>Miguel Young de la Sota</name></author><category term="protobuf-tips"/><summary type="html"><![CDATA[I wake up every morning and grab the morning paper. Then I look at the obituary page. If my name is not on it, I get up. –Ben Franklin]]></summary></entry><entry><title type="html">The Art of Formatting Code</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2025/03/11/formatters/" rel="alternate" type="text/html" title="The Art of Formatting Code"/><published>2025-03-11T00:00:00-07:00</published><updated>2025-03-11T00:00:00-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2025/03/11/formatters</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2025/03/11/formatters/"><![CDATA[<p>Every modern programming language needs a <em>formatter</em> to make your code look pretty and consistent. Formatters are source-transformation tools that parse source code and re-print the resulting AST in some canonical form that normalizes whitespace and optional syntactic constructs. They remove the tedium of matching indentation and brace placement to match a style guide.</p> <p>Go is particularly well-known for providing a formatter as part of its toolchain from day one. It is not a <em>good</em> formatter, though, because it cannot enforce a maximum column width. Later formatters of the 2010s, such as rustfmt and clang-format, do provide this feature, which ensure that individual lines of code don’t get too long.</p> <p>The reason Go doesn’t do this is because the naive approach to formatting code makes it intractable to do so. There are many approaches to implementing this, which can make it seem like a very complicated layout constraint solving problem.</p> <p>So what’s so tricky about formatting code? Aren’t you just printing out an AST?</p> <h2 id="just-an-ast"><a href="#just-an-ast">“Just” an AST</a></h2> <p>An AST<sup id="fnref:pronunciation" role="doc-noteref"><a href="#fn:pronunciation" class="footnote" rel="footnote">1</a></sup> (abstract syntax tree) is a graph representation of a program’s syntax. Let’s consider something like JSON, whose naively-defined AST type might look something like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">enum</span> <span class="n">Json</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
  <span class="nf">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Json</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Object</span><span class="p">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Json</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The AST for the document <code class="language-plaintext highlighter-rouge">{"foo": null, "bar": 42}</code> might look something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">my_doc</span> <span class="o">=</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Object</span><span class="p">([</span>
  <span class="p">(</span><span class="s">"foo"</span><span class="nf">.to_string</span><span class="p">(),</span> <span class="nn">Json</span><span class="p">::</span><span class="n">Null</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"bar"</span><span class="nf">.to_string</span><span class="p">(),</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="mi">42</span><span class="p">)),</span>
<span class="p">]</span><span class="nf">.into</span><span class="p">());</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This AST has some pretty major problems. A formatter must <em>not</em> change the syntactic structure of the program (beyond removing things like redundant braces). Formatting must also be deterministic.</p> <p>First off, <code class="language-plaintext highlighter-rouge">Json::Object</code> is a <code class="language-plaintext highlighter-rouge">HashMap</code>, which is unordered. So it will immediately discard the order of the keys. <code class="language-plaintext highlighter-rouge">Json::String</code> does not retain the escapes from the original string, so <code class="language-plaintext highlighter-rouge">"\n"</code> and <code class="language-plaintext highlighter-rouge">"\u000a"</code> are indistinguishable. <code class="language-plaintext highlighter-rouge">Json::Number</code> will destroy information: JSON numbers can specify values outside of the <code class="language-plaintext highlighter-rouge">f64</code> representable range, but converting to <code class="language-plaintext highlighter-rouge">f64</code> will quantize to the nearest float.</p> <p>Now, JSON doesn’t have comments, but if it did, our AST has no way to record it! So it would destroy all comment information! Plus, if someone has a document that separates keys into stanzas<sup id="fnref:stanza" role="doc-noteref"><a href="#fn:stanza" class="footnote" rel="footnote">2</a></sup>, as shown below, this information is lost too.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"this"</span><span class="p">:</span><span class="w"> </span><span class="s2">"is my first stanza"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"second"</span><span class="p">:</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w">

  </span><span class="nl">"here"</span><span class="p">:</span><span class="w"> </span><span class="s2">"is my second stanza"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"fourth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"line"</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>Truth is, the AST for virtually all competent toolchains are much more complicated than this. Here’s some important properties an AST needs to have to be useful.</p> <ol> <li> <p>Retain <em>span</em> information. Every node in the graph remembers what piece of the file it was parsed from.</p> </li> <li> <p>Retain whitespace information. “Whitespace” typically includes both whitespace characters, and comments.</p> </li> <li> <p>Retain ordering information. The children of each node need to be stored in ordered containers.</p> </li> </ol> <p>The first point is achieved in a number of ways, but boils down to somehow associating to each token a pair of integers<sup id="fnref:offsets" role="doc-noteref"><a href="#fn:offsets" class="footnote" rel="footnote">3</a></sup>, identifying the start and end offsets of the token in the input file.</p> <p>Given the span information for each token, we can then define the span for each node to be the <em>join</em> of its tokens’ spans, namely the start is the min of its constituent tokens’ starts and its end is the max of the ends. This can be easily calculated recursively.</p> <p>Once we have spans, it’s easy to recover the whitespace between any two adjacent syntactic constructs by calculating the text between them. This approach is more robust than, say, associating each comment with a specific token, because it makes it easier to discriminate stanzas for formatting.</p> <p>Being able to retrieve the comments between any two syntax nodes is crucial. Suppose the user writes the following Rust code:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="c1">// HACK: disable this check.</span>
  <span class="nf">some_complicated_check</span><span class="p">();</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>If we’re formatting the binary expression containing the <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, and we can’t query for comments between the LHS and the operator, or the operator and the RHS, the <code class="language-plaintext highlighter-rouge">// HACK</code> comment will get deleted on format, which is pretty bad!</p> <p>An AST that retains this level of information is sometimes called a “concrete syntax tree”. I do not consider this a useful distinction, because any useful AST must retain span and whitespace information, and it’s kind of pointless to implement the same AST more than once. To me, an AST without spans is incomplete.</p> <h3 id="updating-our-json-ast"><a href="#updating-our-json-ast">Updating Our JSON AST</a></h3> <p>With all this in mind, the bare minimum for a “good” AST is gonna be something like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Json</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">JsonKind</span><span class="p">,</span>
  <span class="n">span</span><span class="p">:</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">JsonKind</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
  <span class="nf">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Json</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Object</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="n">Json</span><span class="p">)</span><span class="o">&gt;</span><span class="p">),</span>  <span class="c1">// Vec, not HashMap.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>There are various layout optimizations we can do: for example, the vast majority of strings exist literally in the original file, so there’s no need to copy them into a <code class="language-plaintext highlighter-rouge">String</code>; it’s only necessary if the string contains escapes. My <code class="language-plaintext highlighter-rouge">byteyarn</code> crate, which I wrote about <a href="https://mcyoung.xyz/2023/08/09/yarns">here</a>, is meant to make handling this case easy. So we might rewrite this to be lifetime-bound to the original file.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Json</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">span</span><span class="p">:</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Json</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Object</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Json</span><span class="p">)</span><span class="o">&gt;</span><span class="p">),</span>  <span class="c1">// Vec, not HashMap.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>But wait, there’s some things that don’t have spans here. We need to include spans for the braces of <code class="language-plaintext highlighter-rouge">Array</code> and <code class="language-plaintext highlighter-rouge">Object</code>, their commas, and the colons on object keys. So what we actually get is something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Span</span> <span class="p">{</span>
  <span class="n">start</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
  <span class="n">end</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Json</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">span</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">),</span>

  <span class="n">Array</span> <span class="p">{</span>
    <span class="n">open</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ArrayEntry</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">Object</span> <span class="p">{</span>
    <span class="n">open</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ObjectEntry</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ArrayEntry</span> <span class="p">{</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">Json</span><span class="p">,</span>
  <span class="n">comma</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Span</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ObjectEntry</span> <span class="p">{</span>
  <span class="n">key</span><span class="p">:</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">key_span</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
  <span class="n">colon</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">Json</span><span class="p">,</span>
  <span class="n">comma</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Span</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Implementing an AST is one of my least favorite parts of writing a toolchain, because it’s tedious to ensure all of the details are recorded and properly populated.</p> <h2 id="just-printing-an-ast"><a href="#just-printing-an-ast">“Just” Printing an AST</a></h2> <p>In Rust, you can easily get a nice recursive print of any struct using the <code class="language-plaintext highlighter-rouge">#[derive(Debug)]</code> construct. This is implemented by recursively calling <code class="language-plaintext highlighter-rouge">Debug::fmt()</code> on the elements of a struct, but passing modified <code class="language-plaintext highlighter-rouge">Formatter</code> state to each call to increase the indentation level each time.</p> <p>This enables printing nested structs in a way that looks like Rust syntax when using the <code class="language-plaintext highlighter-rouge">{:#?}</code> specifier.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n">Foo</span> <span class="p">{</span>
  <span class="n">bar</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">Baz</span> <span class="p">{</span>
    <span class="n">quux</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>We can implement a very simple formatter for our JSON AST by walking it recursively.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">String</span><span class="p">,</span> <span class="n">json</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Json</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">match</span> <span class="o">&amp;</span><span class="n">json</span><span class="py">.kind</span> <span class="p">{</span>
    <span class="nn">Json</span><span class="p">::</span><span class="n">Null</span> <span class="p">|</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Bool</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">|</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">|</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">String</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Preserve the input exactly.</span>
      <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">json</span><span class="py">.span.start</span><span class="o">..</span><span class="n">json</span><span class="py">.span.end</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nn">Json</span><span class="p">::</span><span class="n">Array</span> <span class="p">{</span> <span class="n">entries</span><span class="p">,</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'['</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">entries</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nf">fmt</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="py">.value</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span><span class="py">.comma</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">']'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nn">Json</span><span class="p">::</span><span class="n">Object</span> <span class="p">{</span> <span class="n">entries</span><span class="p">,</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'{'</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">entries</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Preserve the key exactly.</span>
        <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">entry</span><span class="py">.key_span.start</span><span class="o">..</span><span class="n">entry</span><span class="py">.key_span.end</span><span class="p">]);</span>

        <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="s">": "</span><span class="p">);</span>
        <span class="nf">fmt</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="py">.value</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span><span class="py">.comma</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'}'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This is essentially what every JSON serializer’s “pretty” mode looks like. It’s linear, it’s simple. But it has one big problem: small lists.</p> <p>If I try to format the document <code class="language-plaintext highlighter-rouge">{"foo": []}</code> using this routine, the output will be</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>This is pretty terrible, but easy to fix by adding a special case:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="nn">Json</span><span class="p">::</span><span class="n">Array</span> <span class="p">{</span> <span class="n">entries</span><span class="p">,</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">entries</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="s">"[]"</span><span class="p">);</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Unfortunately, this doesn’t handle the similar case of a small but non-empty list. <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code> formats as</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>Really, we’d like to keep <code class="language-plaintext highlighter-rouge">"foo": [1, 2]</code> on one line. And now we enter the realm of column wrapping.</p> <h2 id="how-wide-is-a-codepoint"><a href="#how-wide-is-a-codepoint">How Wide Is a Codepoint?</a></h2> <p>The whole point of a formatter is to work with <em>monospaced text</em>, which is text formatted using a monospaced or <em>fixed-width</em> typeface, which means each character is the same width, leading to the measure of the width of lines in <em>columns</em>.</p> <p>So how many columns does the string <code class="language-plaintext highlighter-rouge">cat</code> take up? Three, pretty easy. But we obviously don’t want to count bytes, this isn’t 1971. If we did, <code class="language-plaintext highlighter-rouge">кішка</code>, when UTF-8 encoded, it would be 10, rather than 5 columns wide. So we seem to want to count Unicode characters instead?</p> <p>Oh, but what <em>is</em> a Unicode character? Well, we could say that you’re counting Unicode scalar values (what Rust’s <code class="language-plaintext highlighter-rouge">char</code> and Go’s <code class="language-plaintext highlighter-rouge">rune</code>) types represent. Or you could count grapheme clusters (like Swift’s <code class="language-plaintext highlighter-rouge">Character</code>).</p> <p>But that would give wrong answers. CJK languages’ characters, such as <code class="language-plaintext highlighter-rouge">猫</code>, usually want to be rendered as <em>two</em> columns, even in monospaced contexts. So, you might go to Unicode and discover <a href="https://www.unicode.org/reports/tr11/">UAX#11</a>, and attempt to use it for assigning column widths. But it turns out that the precise rules that monospaced fonts use are not written down in a single place in Unicode. You would also discover that some scripts, such as Arabic, have complex ligature rules that mean that the width of a single character depends on the characters around it.</p> <p>This is a place where you should hunt for a library. <a href="https://docs.rs/unicode-width/latest/unicode_width/#rules-for-determining-width"><code class="language-plaintext highlighter-rouge">unicode_width</code></a> is the one for Rust. Given that Unicode segmentation is a closely associated operation to width, segmentation libraries are a good place to look for a width calculation routine.</p> <p>But most such libraries will still give wrong answers, because of tabs. The tab character <code class="language-plaintext highlighter-rouge">U+0009 CHARACTER TABULATION</code>’s width depends on the width of all characters before it, because a tab is as wide as needed to reach the next <em>tabstop</em>, which is a column position an integer multiple of the <em>tab width</em> (usually 2, 4, or, on most terminals, 8).</p> <p>With a tab width of 4, <code class="language-plaintext highlighter-rouge">"\t"</code>, <code class="language-plaintext highlighter-rouge">"a\t"</code>, and <code class="language-plaintext highlighter-rouge">"abc\t"</code> are all four columns wide. Depending on the context, you will either want to treat tabs as behaving as going to the next tabstop (and thus being variable width), or having a fixed width. The former is necessary for assigning correct column numbers in diagnostics, but we’ll find that the latter is a better match for what we’re doing.</p> <p>The reason for being able to calculate the width of a string is to enable line wrapping. At some point in the 2010s, people started writing a lot of code on laptops, where it is not easy to have two editors side by side on the small screen. This removes the motivation to wrap all lines at 80 columns<sup id="fnref:80-cols" role="doc-noteref"><a href="#fn:80-cols" class="footnote" rel="footnote">4</a></sup>, which in turn results in lines that tend to get arbitrarily long.</p> <p>Line wrapping helps ensure that no matter how wide everyone’s editors are, the code <em>I</em> have to read fits on my very narrow editors.</p> <h2 id="accidentally-quadratic"><a href="#accidentally-quadratic">Accidentally Quadratic</a></h2> <p>A lot of folks’ first formatter recursively formats a node by formatting its children to determine if they fit on one line or not, and based on that, and their length if they are single-line, determine if their parent should break.</p> <p>This is a naive approach, which has several disadvantages. First, it’s very easy to accidentally backtrack, trying to only break smaller and smaller subexpressions until things fit on one line, which can lead to quadratic complexity. The logic for whether a node can break is bespoke per node and that makes it easy to make mistakes.</p> <p>Consider formatting <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code>. In our AST, this will look something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n">Json</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="n">Object</span> <span class="p">{</span>
    <span class="n">open</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">15</span> <span class="p">},</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">ObjectEntry</span> <span class="p">{</span>
      <span class="n">key</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">,</span>
      <span class="n">key_span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="n">colon</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="n">value</span><span class="p">:</span> <span class="n">Json</span> <span class="p">{</span>
        <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="n">Array</span> <span class="p">{</span>
          <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">9</span> <span class="p">},</span>
          <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">14</span> <span class="p">},</span>
          <span class="n">entries</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span>
            <span class="n">ArrayEntry</span> <span class="p">{</span>
              <span class="n">value</span><span class="p">:</span> <span class="n">Json</span> <span class="p">{</span>
                <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
                <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
              <span class="p">},</span>
              <span class="n">comma</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">11</span> <span class="p">}),</span>
            <span class="p">},</span>
            <span class="n">ArrayEntry</span> <span class="p">{</span>
              <span class="n">value</span><span class="p">:</span> <span class="n">Json</span> <span class="p">{</span>
                <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="n">s</span><span class="na">.0</span><span class="p">),</span>
                <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">13</span> <span class="p">},</span>
              <span class="p">},</span>
              <span class="n">comma</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="p">],</span>
        <span class="p">},</span>
        <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">14</span> <span class="p">},</span>
      <span class="p">},</span>
      <span class="n">comma</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
    <span class="p">}],</span>
  <span class="p">},</span>
  <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">15</span> <span class="p">},</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>To format the whole document, we need to know the width of each field in the object to decide whether the object fits on one line. To do that, we need to calculate the width of each value, and add to it the width of the key, and the width of the <code class="language-plaintext highlighter-rouge">: </code> separating them.</p> <p>How can this be accidentally quadratic? If we simply say “format this node” to obtain its width, that will recursively format all of the children it contains without introducing line breaks, performing work that is linear in how many transitive children that node contains. Having done this, we can now decide if we need to introduce line breaks or not, which increases the indentation at which the children are rendered. This means that the children cannot know ahead of time how much of the line is left for them, so we need to recurse into formatting them again, now knowing the indentation at which the direct children are rendered.</p> <p>Thus, each node performs work equal to the number of nodes beneath it. This has resulted in many slow formatters.</p> <p>Now, you could be more clever and have each node be capable of returning its width based on querying its children’s width directly, but that means you need to do complicated arithmetic for each node that needs to be synchronized with the code that actually formats it. Easy to make mistakes.</p> <p>The solution is to invent some kind of model for your document that specifies how lines should be broken if necessary, and which tracks layout information so that it can be computed in one pass, and then used in a second pass to figure out whether to actually break lines or not.</p> <p>This is actually how HTML works. The markup describes constraints on the layout of the content, and then a layout engine, over several passes, calculates sizes, solves constraints, and finally produces a raster image representing that HTML document. Following the lead of HTML, we can design…</p> <h2 id="a-dom-for-your-code"><a href="#a-dom-for-your-code">A DOM for Your Code</a></h2> <p>The HTML DOM is a markup document: a tree of tags where each tag has a type, such as <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;hr&gt;</code>, or <code class="language-plaintext highlighter-rouge">&lt;strong&gt;</code>, properties, such as <code class="language-plaintext highlighter-rouge">&lt;a href=...&gt;</code>, and content consisting of nested tags (and bare text, which every HTML engine just handles as a special kind of tag), such as <code class="language-plaintext highlighter-rouge">&lt;p&gt;Hello &lt;em&gt;World&lt;/em&gt;!&lt;/p&gt;</code>.</p> <p>We obviously want to have a tag for text that should be rendered literally. We also want a tag for line breaks that is distinct from the text tag, so that they can be merged during rendering. It might be good to treat text tags consisting of just whitespace, such as whitespace, specially: two newlines <code class="language-plaintext highlighter-rouge">\n\n</code> are a blank line, but we might want to merge consecutive blank lines. Similarly, we might want to merge consecutive spaces to simplify generating the DOM.</p> <p>Consider formatting a language like C++, where a function can have many modifiers on it that can show up in any order, such as <code class="language-plaintext highlighter-rouge">inline</code>, <code class="language-plaintext highlighter-rouge">virtual</code>, <code class="language-plaintext highlighter-rouge">constexpr</code>, and <code class="language-plaintext highlighter-rouge">explicit</code>. We might want to canonicalize the order of these modifiers. We don’t want to accidentally wind up printing <code class="language-plaintext highlighter-rouge">inline constexpr Foo()</code> because we printed an empty string for <code class="language-plaintext highlighter-rouge">virtual</code>. Having special merging for spaces means that all entities are always one space apart if necessary. This is a small convenience in the DOM that multiplies to significant simplification when lowering from AST to DOM.</p> <p>Another useful tag is something like <code class="language-plaintext highlighter-rouge">&lt;indent by=" "&gt;</code>, which increases the indentation level by some string (or perhaps simply a number of spaces; the string just makes supporting tabs easier) for the tags inside of it. This allows control of indentation in a carefully-scoped manner.</p> <p>Finally, we need some way to group tags that are candidates for “breaking”: if the width of all of the tags inside of a <code class="language-plaintext highlighter-rouge">&lt;group&gt;</code> is greater than the maximum width that group can have (determined by indentation and any elements on the same line as that group), we can set that group to “broken”, and… well, what should breaking do?</p> <p>We want breaking to not just cause certain newlines (at strategic locations) to appear, but we also want it to cause an indentation increase, and in languages with trailing commas like Rust and Go, we want (or in the case of Go, <em>need</em>) to insert a trailing comma only when broken into multiple lines. We can achieve this by allowing any tag to be <em>conditioned</em> on whether the enclosing group is broken or not.</p> <p>Taken all together, we can render the AST for our <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code> document into this DOM, according to the tags we’ve described above.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;group&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"{"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">'"foo"'</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">":"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;group&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"["</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">","</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/indent&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"]"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/group&gt;</span>
  <span class="nt">&lt;/indent&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/group&gt;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">XML</div></div></div> <p>Notice a few things: All of the newlines are set to appear only <code class="language-plaintext highlighter-rouge">if=broken</code>. The space between the two commas only appears if the enclosing group is <em>not</em> broken, that is <code class="language-plaintext highlighter-rouge">if=flat</code>. The groups encompass everything that can move due to a break, which includes the outer braces. This is necessary because if that brace is not part of the group, and it is the only character past the line width limit, it will not cause the group to break.</p> <h3 id="laying-out-your-dom"><a href="#laying-out-your-dom">Laying Out Your DOM</a></h3> <p>The first pass is easy: it measures how wide every node is. But we don’t know whether any groups will break, so how can we measure that without calculating breaks, which depend on indentation, and the width of their children, and…</p> <p>This is one tricky thing about multi-pass graph algorithms (or graph algorithms in general): it can be easy to become overwhelmed trying to factor the dependencies at each node so that they are not cyclic. I struggled with this algorithm, until I realized that the only width we care about is the width <em>if no groups are ever broken</em>.</p> <p>Consider the following logic: if a group needs to break, all of its parents must obviously break, because the group will now contain a newline, so its parents must break no matter what. Therefore, we only consider the width of a node when deciding if a group must break intrinsically, i.e., because all of its children decided not to break. This can happen for a document like the following, where each inner node is quite large, but not large enough to hit the limit.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">],</span><span class="w">
  </span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">]</span><span class="w">
</span><span class="p">]</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>Because we prefer to break outer groups rather than inner groups, we can measure the “widest a single line could be” in one pass, bottom-up: each node’s width is the sum of the width of its children, or its literal contents for <code class="language-plaintext highlighter-rouge">&lt;text&gt;</code> elements. However, we must exclude all text nodes that are <code class="language-plaintext highlighter-rouge">if=broken</code>, because they obviously do not contribute to the single-line length. We can also ignore indentation because indentation never happens in a single line.</p> <p>However, this doesn’t give the full answer for whether a given group should break, because that depends on indentation and what nodes came before on the same line.</p> <p>This means we need to perform a second pass: having laid everything out assuming no group is broken, we must lay things out as they would appear when we render them, taking into account breaking. But now that we know the maximum width of each group if left unbroken, we can make breaking decisions.</p> <p>As we walk the DOM, we keep track of the current column and indentation value. For each group, we decide to break it if either:</p> <ol> <li> <p>Its width, plus the current column value, exceeds the maximum column width.</p> </li> <li> <p>It contains any newlines, something that can be determined in the first pass.</p> </li> </ol> <p>The first case is why we can’t actually treat tabs as if they advance to a tabstop. We cannot know the column at which a node will be placed at the time that we measure its width, so we need to assume the worst case.</p> <p>Whenever we hit a newline, we update the current width to the width induced by indentation, simulating a newline plus indent. We also need to evaluate the condition, if present, on each tag now, since by the time we inspect a non-group tag, we have already made a decision as to whether to break or not.</p> <h3 id="render-it"><a href="#render-it">Render It!</a></h3> <p>Now that everything is determined, rendering is super easy: just walk the DOM and print out all the text nodes that either have no condition or whose condition matches the innermost group they’re inside of.</p> <p>And, of course, this is where we need to be careful with indentation: you don’t want to have lines that end in whitespace, so you should make sure to not print out any spaces until text is written after a newline. This is also a good opportunity to merge adjacent only-newlines text blocks. The merge algorithm I like is to make sure that when <code class="language-plaintext highlighter-rouge">n</code> and <code class="language-plaintext highlighter-rouge">m</code> newline blocks are adjacent, print <code class="language-plaintext highlighter-rouge">max(n, m)</code> newlines. This ensures that a DOM node containing <code class="language-plaintext highlighter-rouge">\n\n\n</code> is respected, while deleting a bunch of <code class="language-plaintext highlighter-rouge">\n</code>s in a row that would result in many blank lines.</p> <p>What’s awesome about this approach is that the layout algorithm is highly generic: you can re-use it for whatever compiler frontend you like, without needing to fuss with layout yourself. There is a very direct conversion from AST to DOM, and the result is very declarative.</p> <h3 id="more-complicated-yaml"><a href="#more-complicated-yaml">More Complicated: YAML</a></h3> <p>YAML is a superset of JSON that SREs use to write sentient configuration files. It has a funny list syntax that we might want to use for multi-line lists, but we might want to keep JSON-style lists for short ones.</p> <p>A document of nested lists might look something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="pi">-</span> <span class="pi">[</span><span class="nv">1</span><span class="pi">,</span> <span class="nv">2</span><span class="pi">,</span> <span class="nv">3</span><span class="pi">,</span> <span class="nv">4</span><span class="pi">,</span> <span class="nv">5</span><span class="pi">,</span> <span class="nv">6</span><span class="pi">,</span> <span class="nv">7</span><span class="pi">,</span> <span class="nv">8</span><span class="pi">,</span> <span class="nv">9</span><span class="pi">,</span> <span class="nv">10</span><span class="pi">,</span> <span class="nv">11</span><span class="pi">,</span> <span class="nv">12</span><span class="pi">]</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">13</span><span class="pi">,</span> <span class="nv">14</span><span class="pi">,</span> <span class="nv">15</span><span class="pi">,</span> <span class="nv">16</span><span class="pi">,</span> <span class="nv">17</span><span class="pi">,</span> <span class="nv">18</span><span class="pi">,</span> <span class="nv">19</span><span class="pi">,</span> <span class="nv">20</span><span class="pi">,</span> <span class="nv">21</span><span class="pi">,</span> <span class="nv">22</span><span class="pi">,</span> <span class="nv">23</span><span class="pi">]</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">YAML</div></div></div> <p>How might we represent this in the DOM? Starting from our original JSON document <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code>, we might go for something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;group&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"{"</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">'"foo"'</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">":"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;group&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"["</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"- "</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/indent&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">","</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"- "</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/indent&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"]"</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/group&gt;</span>
  <span class="nt">&lt;/indent&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"}"</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/group&gt;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">XML</div></div></div> <p>Here, we’ve made the <code class="language-plaintext highlighter-rouge">[]</code> and the comma only appear in flat mode, while in broken mode, we have a <code class="language-plaintext highlighter-rouge">- </code> prefix for each item. The inserted newlines have also changed somewhat, and the indentation blocks have moved: now only the value is indented, since YAML allows the <code class="language-plaintext highlighter-rouge">-</code>s of list items to be at the same indentation level as the parent value for lists nested in objects. (This is a case where some layout logic is language-specific, but now the output is worrying about declarative markup rather than physical measurements.)</p> <p>There are other enhancements you might want to make to the DOM I don’t describe here. For example, comments want to be word-wrapped, but you might not know what the width is until layout happens. Having a separate tag for word-wrapped blocks would help here.</p> <p>Similarly, a mechanism for “partial breaks”, such as for the document below, could be implemented by having a type of line break tag that breaks if the text that follows overflows the column, which can be easily implemented by tracking the position of the last such break tag.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"very"</span><span class="p">,</span><span class="w"> </span><span class="s2">"long"</span><span class="p">,</span><span class="w"> </span><span class="s2">"list"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"of"</span><span class="p">,</span><span class="w"> </span><span class="s2">"strings"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <h2 id="using-this-yourself"><a href="#using-this-yourself">Using This Yourself</a></h2> <p>I think that a really good formatter is essential for any programming language, and I think that a high-quality library that does most of the heavy-lifting is important to make it easier to demand good formatters.</p> <p><a href="https://github.com/mcy/strings/tree/main/allman">So I wrote a Rust library.</a> I haven’t released it on crates.io because I don’t think it’s quite at the state I want, but it turns out that the layout algorithm is very simple, so porting this to other languages should be EZ.</p> <p>Now you have no excuse. :D</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:pronunciation" role="doc-endnote"> <p>Everyone pronounces this acronym “ay ess tee”, but I have a friend who really like to say <em>ast</em>, rhyming with <em>mast</em>, so I’m making a callout post my twitter dot com. <a href="#fnref:pronunciation" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:stanza" role="doc-endnote"> <p>In computing, a group of lines not separated by blank lines is called a stanza, in analogy to the stanzas of a poem, which are typeset with no blank lines between the lines of the stanza. <a href="#fnref:stanza" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:offsets" role="doc-endnote"> <p>You could also just store a string, containing the original text, but storing offsets is necessary for <em>diagnostics</em>, which is the jargon term for a compiler error. Compiler errors are recorded using an AST node as context, and to report the line at which the error occurred, we need to be able to map the node back to its offset in the file.</p> <p>Once we have the offset, we can calculate the line in <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> time using binary search. Having pre-computed an array of the offset of each <code class="language-plaintext highlighter-rouge">\n</code> byte in the input file, binary search will tell us the index and offset of the <code class="language-plaintext highlighter-rouge">\n</code> before the token; this index is the zero-indexed line number, and the string from that <code class="language-plaintext highlighter-rouge">\n</code> to the offset can be used to calculate the column.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">use</span> <span class="nn">unicode_width</span><span class="p">::</span><span class="n">UnicodeWidthStr</span><span class="p">;</span>

<span class="cd">/// Returns the index of each newline. Can be pre-computed and re-used</span>
<span class="cd">/// multiple times.</span>
<span class="k">fn</span> <span class="nf">newlines</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">file</span><span class="nf">.bytes</span><span class="p">()</span>
      <span class="nf">.enumerate</span><span class="p">()</span>
      <span class="nf">.filter_map</span><span class="p">(|(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">)|</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="sc">b'\n'</span><span class="p">)</span><span class="nf">.then_some</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>

<span class="cd">/// Returns the line and column of the given offset, given the line</span>
<span class="cd">/// tarts of the file.</span>
<span class="k">fn</span> <span class="nf">location</span><span class="p">(</span>
  <span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
  <span class="n">newlines</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">usize</span><span class="p">],</span>
  <span class="n">offset</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">match</span> <span class="n">newlines</span><span class="nf">.binary_search</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ok means that offset refers to a newline, so this means</span>
    <span class="c1">// we want to return the width of the line that it ends as</span>
    <span class="c1">// the column.</span>
    <span class="c1">//</span>
    <span class="c1">// Err means that this is after the nth newline, except Err(0),</span>
    <span class="c1">// which means it is before the first one.</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">|</span> <span class="nf">Err</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="o">..</span><span class="n">offset</span><span class="p">]</span><span class="nf">.width</span><span class="p">()),</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="n">newlines</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">..</span><span class="n">offset</span><span class="p">]</span><span class="nf">.width</span><span class="p">()),</span>
    <span class="nf">Err</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="n">newlines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">..</span><span class="n">offset</span><span class="p">]</span><span class="nf">.width</span><span class="p">()),</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p><a href="#fnref:offsets" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:80-cols" role="doc-endnote"> <p>The Rust people keep trying to convince me that it should be 100. They are wrong. 80 is perfect. They only think they need 100 because they use the incorrect tab width of four spaces, rather than two. This is the default for clang-format and it’s <em>perfect</em>. <a href="#fnref:80-cols" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="formats"/><category term="parsing"/><category term="frontend"/><summary type="html"><![CDATA[Every modern programming language needs a formatter to make your code look pretty and consistent. Formatters are source-transformation tools that parse source code and re-print the resulting AST in some canonical form that normalizes whitespace and optional syntactic constructs. They remove the tedium of matching indentation and brace placement to match a style guide.]]></summary></entry><entry><title type="html">Go’s Weird Little Iterators</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2024/12/16/rangefuncs/" rel="alternate" type="text/html" title="Go’s Weird Little Iterators"/><published>2024-12-16T00:00:00-08:00</published><updated>2024-12-16T00:00:00-08:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2024/12/16/rangefuncs</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2024/12/16/rangefuncs/"><![CDATA[<p>A second post on Go silliness (Miguel, aren’t you a C++ programmer?): in 1.23, Go <em>finally</em> added custom iterators. Now, back when I was at Google and involved in the Go compiler as “the annoying Rust guy who gets lunch with us”, there were proposals suggesting adding something like this, implemented as either an interface or a func:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">Iter</span><span class="p">[</span><span class="n">T</span> <span class="n">any</span><span class="p">]</span> <span class="o">=</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This is not what Go did. No, Go did something really weird. And the implementation is <em>incredible</em>.</p> <h2 id="whats-an-iterator"><a href="#whats-an-iterator">What’s an Iterator?</a></h2> <p>An <em>iterator</em>, in the context of programming language design, is a special type of value that can be used to walk through a sequence of values, without necessarily materializing the sequence as whatever the language’s array type is.</p> <p>But, a proper iterator must fit with the language’s looping construct. An <em>iterable type</em> is one which can be used in a for-each loop, such as C++’s <code class="language-plaintext highlighter-rouge">for (T x : y)</code> or Python’s <code class="language-plaintext highlighter-rouge">for x in y</code> (modern languages usually only have a for-each loop as their only <code class="language-plaintext highlighter-rouge">for</code> loop, because C-style for loops are not in anymore).</p> <h3 id="c-iterator-pairs"><a href="#c-iterator-pairs">C++ Iterator Pairs</a></h3> <p>Every language defines a <em>desugaring</em> that defines how custom iteration works in term of the more primitive loops. For example, in C++, when we write <code class="language-plaintext highlighter-rouge">for (T x : y) { ... }</code> (called a <a href="https://en.cppreference.com/w/cpp/language/range-for"><em>range-based for loop</em></a>, added in C++11), desugars as follows<sup id="fnref:cc-range" role="doc-noteref"><a href="#fn:cc-range" class="footnote" rel="footnote">1</a></sup>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="n">__range</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">__begin</span> <span class="o">=</span> <span class="n">begin</span><span class="p">(</span><span class="n">__range</span><span class="p">);</span> <span class="c1">// ADL</span>
<span class="k">auto</span> <span class="n">__end</span> <span class="o">=</span> <span class="n">end</span><span class="p">(</span><span class="n">__range</span><span class="p">);</span>     <span class="c1">// ADL</span>
<span class="k">for</span> <span class="p">(;</span> <span class="n">__begin</span> <span class="o">!=</span> <span class="n">__end</span><span class="p">;</span> <span class="o">++</span><span class="n">__begin</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">__begin</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">break</code>, <code class="language-plaintext highlighter-rouge">continue</code>, and <code class="language-plaintext highlighter-rouge">return</code> inside of the loop body require no special handling: they Just Work, because this is just a plain ol for loop.</p> <p>This begin and end weirdness is because, if the iterator backs an actual array, begin and end can just be pointers to the first element and one-past-the-end and this will Just Work. Before C++11, the convention for C++ iterators was to construct types that imitated pointers; you would usually write loops over non-array types like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">things</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">things</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">whatever</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>C++ simply codified common (if gross) practice. It is very tedious to implement C++ iterators, though. You need to provide a dummy end iterator, you need to provide some kind of comparison operator, and iterators that don’t return a reference out of <code class="language-plaintext highlighter-rouge">operator*()</code> are… weird.</p> <p>Begin and end can be different types (which is how C++20 ranges pretend to be iterable), but being able to query done-ness separately from the next value makes implementation annoying: it means that an iterator that has not begun iteration (i.e., <code class="language-plaintext highlighter-rouge">++</code> has not been executed yet, because it occurs in the loop’s latch, not its header<sup id="fnref:loop-jargon" role="doc-noteref"><a href="#fn:loop-jargon" class="footnote" rel="footnote">2</a></sup>) needs to do extra work to answer <code class="language-plaintext highlighter-rouge">!= end</code>, which usually means an extra bool to keep track of whether iteration has started or not.</p> <p>Here’s what writing an iterator (that is also an iterable usable in a range for-loop) over the non-zero elements of a <code class="language-plaintext highlighter-rouge">std::span&lt;const int&gt;</code> might look like.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">NonZero</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ints</span><span class="p">;</span>

  <span class="k">auto</span> <span class="n">begin</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">auto</span> <span class="n">end</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sentinel</span><span class="p">{};</span> <span class="p">}</span>

  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">sentinel</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ints</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">ints</span> <span class="o">=</span> <span class="n">ints</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ints</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">sentinel</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="k">this</span> <span class="o">==</span> <span class="n">s</span><span class="p">);</span> <span class="p">}</span>

  <span class="n">NonZero</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ints</span> <span class="o">=</span> <span class="n">ints</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">NonZero</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">prev</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="o">++*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">prev</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">}</span>

 <span class="nl">private:</span>
  <span class="k">struct</span> <span class="nc">sentinel</span><span class="p">{};</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>In this case, <code class="language-plaintext highlighter-rouge">operator==</code> is <em>not</em> <code class="language-plaintext highlighter-rouge">const</code>, which is a bit naughty. Purists might argue that this type should have a constructor, which adjusts <code class="language-plaintext highlighter-rouge">ints</code> to point to the first non-zero element on construction, and <code class="language-plaintext highlighter-rouge">operator++</code> to perform the mutation. That would look like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">NonZero</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">NonZero</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ints</span><span class="p">)</span> <span class="o">:</span> <span class="n">ints_</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skip_zeros</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">begin</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">auto</span> <span class="n">end</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sentinel</span><span class="p">{};</span> <span class="p">}</span>

  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">sentinel</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ints</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">sentinel</span> <span class="n">s</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="k">this</span> <span class="o">==</span> <span class="n">s</span><span class="p">);</span> <span class="p">}</span>

  <span class="n">NonZero</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">skip_zeros</span><span class="p">();</span>
    <span class="n">ints</span> <span class="o">=</span> <span class="n">ints</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">NonZero</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">prev</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="o">++*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">prev</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">}</span>

 <span class="nl">private:</span>
  <span class="k">struct</span> <span class="nc">sentinel</span><span class="p">{};</span>
  <span class="kt">void</span> <span class="n">skip_zeros</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ints</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ints</span> <span class="o">=</span> <span class="n">ints</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ints_</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p><code class="language-plaintext highlighter-rouge">std::sentinel_for</code> (C++’s iterator concepts are terribly named) really wants <code class="language-plaintext highlighter-rouge">operator==</code> to be <code class="language-plaintext highlighter-rouge">const</code>, but I could have also just marked <code class="language-plaintext highlighter-rouge">ints</code> as <code class="language-plaintext highlighter-rouge">mutable</code> to avoid that. It it’s not already clear, I really dislike this pattern. See <a href="https://github.com/mcy/best/blob/main/best/iter/iter.h">here</a> for some faffing about with C++ iterators on my part.</p> <h3 id="java-also-got-this-wrong"><a href="#java-also-got-this-wrong">Java Also Got This Wrong</a></h3> <p>At least Java provides a standard iterable interface, thankfully.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">java.util</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">();</span>
  <span class="no">E</span> <span class="nf">next</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Java</div></div></div> <p>The desugaring of <code class="language-plaintext highlighter-rouge">for (T x : y) { ... }</code> is then:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">$iter</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="n">$iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();)</span> <span class="o">{</span>
  <span class="no">T</span> <span class="n">x</span> <span class="o">=</span> <span class="n">$iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Java</div></div></div> <p>Do you see the problem here? Although Java now provides a standard interface, doesn’t require annoying equality comparisons, and doesn’t require an end value, these things are <em>still</em> a pain to implement! You still need to be able to query if you’re done before you’ve had a chance to step through the iterator.</p> <p>Like before, suppose we have an <code class="language-plaintext highlighter-rouge">int[]</code>, and we want to yield every non-zero value in it. How do we construct an iterator for that?</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">int</span><span class="o">[]</span> <span class="n">xs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="kt">var</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="n">xs</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">idx</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(;</span> <span class="o">!</span><span class="n">done</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">array</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span> <span class="n">idx</span><span class="o">++)</span> <span class="o">{}</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">done</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">hasNext</span><span class="o">())</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NoSuchElementException</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">array</span><span class="o">[</span><span class="n">idx</span><span class="o">++];</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">done</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">array</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Java</div></div></div> <p>What a pain. Java’s anonymous classes being wordy aside, it’s annoying and error-prone to do this: it’s tempting to accidentally implement <code class="language-plaintext highlighter-rouge">hasNext</code> by simply checking if the array is empty. (Aside, I hate that <code class="language-plaintext highlighter-rouge">xs.length</code> throws on null arrays. Just return zero like in Go, c’mon).</p> <p>Also, it’s no a single-abstract-method interface, so I can’t use a lambda to create an iterator.</p> <p>At least <code class="language-plaintext highlighter-rouge">break</code>, <code class="language-plaintext highlighter-rouge">continue</code>, and <code class="language-plaintext highlighter-rouge">return</code> Just Work, because the underlying operation is a for loop like before.</p> <h3 id="rust-does-it-better"><a href="#rust-does-it-better">Rust Does It Better</a></h3> <p>Rust <em>also</em> has a standard iterable interface.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c1">// mod core::iter</span>

<span class="k">pub</span> <span class="k">trait</span> <span class="nb">IntoIterator</span> <span class="p">{</span>
  <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>
  <span class="k">type</span> <span class="n">Iter</span><span class="p">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">=</span><span class="k">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="k">fn</span> <span class="nf">into_iter</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Iter</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">trait</span> <span class="nb">Iterator</span> <span class="p">{</span>
  <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>
  <span class="k">fn</span> <span class="nf">next</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="k">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The desugaring for <code class="language-plaintext highlighter-rouge">for x in y { ... }</code> is reasonably straightforward, like in Java:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">__it</span> <span class="o">=</span> <span class="nn">IntoIterator</span><span class="p">::</span><span class="nf">into_iter</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="k">while</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">__it</span><span class="nf">.next</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This is so straightforward that it’s not <em>so</em> unusual to write it yourself, when you don’t plan on consuming the entire iterator. Alternatively, you can partially iterate over an iterator by taking a mutable reference to it. This is useful for iterators that can yield their remainder.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">it</span> <span class="o">=</span> <span class="n">my_slice</span><span class="nf">.chunks_exact</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">it</span> <span class="p">{</span>
  <span class="nf">do_thing</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
<span class="p">}</span>
<span class="nf">do_thing</span><span class="p">(</span><span class="n">it</span><span class="nf">.remainder</span><span class="p">());</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p><code class="language-plaintext highlighter-rouge">break</code>, <code class="language-plaintext highlighter-rouge">continue</code>, and <code class="language-plaintext highlighter-rouge">return</code> work in the obvious way.</p> <p>The interface solves the problems C++ and Java had very cleanly: <code class="language-plaintext highlighter-rouge">next</code> both computes the next item and whether the iterator has more elements. Rust even allows iterators to resume yielding <code class="language-plaintext highlighter-rouge">Some</code> after yielding <code class="language-plaintext highlighter-rouge">None</code>, although few algorithms will make use of this.</p> <p>Implementing the non-zero iterator we’ve been writing so far is quite simple:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">ints</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">i32</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="k">let</span> <span class="n">it</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">iter</span><span class="p">::</span><span class="nf">from_fn</span><span class="p">(</span><span class="k">move</span> <span class="p">||</span> <span class="p">{</span>
  <span class="k">while</span> <span class="n">ints</span><span class="nf">.get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">let</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ints</span><span class="nf">.get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">ints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="p">];</span>
  <span class="n">item</span>
<span class="p">});</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>However, this can be written far more simply<sup id="fnref:size_hint" role="doc-noteref"><a href="#fn:size_hint" class="footnote" rel="footnote">3</a></sup> using iterator combinators:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">ints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">i32</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="k">let</span> <span class="n">it</span> <span class="o">=</span> <span class="n">ints</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.copied</span><span class="p">()</span><span class="nf">.filter</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>It requires a little bit of effort to implement some iterators, but most of the common cases are easy to put together with composition.</p> <p>Python iterators are basically the same thing, but there’s no interface to implement (because Python doesn’t believe in type safety). Lua iterators are similar. The Rust pattern of a function that returns the next item (or a special end-of-sequence value) is relatively popular because of this simplicity and composability, and because they can model a lot of iteration strategies.</p> <h2 id="so-what-did-go-do"><a href="#so-what-did-go-do">So, What Did Go Do?</a></h2> <p>Well. Go has a range for syntax like many other languages. The syntax looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">for</span> <span class="n">x</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">y</span> <span class="p">{</span>
  <span class="c">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>The <code class="language-plaintext highlighter-rouge">x</code> can be a list of places, and the <code class="language-plaintext highlighter-rouge">:=</code> can be plain assignment, <code class="language-plaintext highlighter-rouge">=</code>. You can also write <code class="language-plaintext highlighter-rouge">for range y { ... }</code> if the iteration values aren’t needed.</p> <p>The behavior of this construct, like many others in Go, depends explicitly on the type after <code class="language-plaintext highlighter-rouge">range</code>. Each range iteration can yield zero or more values; the</p> <p>These are:</p> <ol> <li>For <code class="language-plaintext highlighter-rouge">[]T</code>, <code class="language-plaintext highlighter-rouge">[n]T</code>, and <code class="language-plaintext highlighter-rouge">*[n]T</code>, each step yields an index of the slice and the value at that offset, in order.</li> <li>For <code class="language-plaintext highlighter-rouge">map[K]V</code>, each step yields a key and a value, in a random order.</li> <li> <p>For <code class="language-plaintext highlighter-rouge">&lt;- chan T</code>, it desugars into</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">for</span> <span class="p">{</span>
 <span class="n">x</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">y</span>
 <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span> <span class="k">break</span> <span class="p">}</span>
 <span class="c">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> </li> <li> <p>Starting in Go 1.22, ranging on an integer type would desugar into</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">for</span> <span class="n">x</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
 <span class="c">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> </li> </ol> <p>All of these desugars are essentially still just loops, so <code class="language-plaintext highlighter-rouge">break</code>, <code class="language-plaintext highlighter-rouge">continue</code>, <code class="language-plaintext highlighter-rouge">goto</code>, and <code class="language-plaintext highlighter-rouge">return</code> all work as expected.</p> <p>But, how do custom types, like weird map types, implement iteration? The usual<sup id="fnref:chan-iter" role="doc-noteref"><a href="#fn:chan-iter" class="footnote" rel="footnote">4</a></sup> implementation is <a href="https://pkg.go.dev/sync#Map.Range"><code class="language-plaintext highlighter-rouge">sync.Map.Range</code></a>, which looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Map</span><span class="p">)</span> <span class="n">Range</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="n">any</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This function will call <code class="language-plaintext highlighter-rouge">yield</code> for each element in the map. If the function returns <code class="language-plaintext highlighter-rouge">false</code>, iteration will stop. This pattern is not uncommon, but sometimes libraries omit the <code class="language-plaintext highlighter-rouge">bool</code> return (like <a href="https://pkg.go.dev/container/ring@go1.23.4#Ring.Do"><code class="language-plaintext highlighter-rouge">container/ring.Ring.Do</code></a>). Some, like <a href="https://pkg.go.dev/path/filepath#WalkFunc"><code class="language-plaintext highlighter-rouge">filepath.WalkDir</code></a>, have a more complex interface involving errors.</p> <p>This is the template for what became <em>rangefuncs</em>, a mechanism for using the for-range syntax with certain function values.</p> <h2 id="rangefuncs"><a href="#rangefuncs">Rangefuncs</a></h2> <p>The word “rangefunc” does not appear in Go’s specification. It is a term used to refer to them in some documentation, within the compiler, and in the runtime.</p> <p>A rangefunc is any function with one of the following signatures:</p> <ul> <li><code class="language-plaintext highlighter-rouge">func(yield func() bool)</code></li> <li><code class="language-plaintext highlighter-rouge">func(yield func(V) bool)</code></li> <li><code class="language-plaintext highlighter-rouge">func(yield func(K, V) bool)</code></li> </ul> <p>They work like <code class="language-plaintext highlighter-rouge">sync.Map.Range</code> does: the function calls <code class="language-plaintext highlighter-rouge">yield</code> (hereafter simply called “the yield”) for each element, and stops early if yield returns false. The <code class="language-plaintext highlighter-rouge">iter</code> package contains types for the second and third of these:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">iter</span>

<span class="k">type</span> <span class="n">Seq</span><span class="p">[</span><span class="n">V</span> <span class="n">any</span><span class="p">]</span> <span class="k">func</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span>
<span class="k">type</span> <span class="n">Seq2</span><span class="p">[</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span> <span class="n">any</span><span class="p">]</span> <span class="k">func</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>For example, the <code class="language-plaintext highlighter-rouge">slices</code> package provides an adaptor for converting a slice into an iterator that ranges over it.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">slices</span>

<span class="c">// All returns an iterator over index-value pairs in the slice</span>
<span class="c">// in the usual order.</span>
<span class="k">func</span> <span class="n">All</span><span class="p">[</span><span class="n">Slice</span> <span class="err">~</span><span class="p">[]</span><span class="n">E</span><span class="p">,</span> <span class="n">E</span> <span class="n">any</span><span class="p">](</span><span class="n">s</span> <span class="n">Slice</span><span class="p">)</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq2</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="n">E</span><span class="p">]</span> <span class="p">{</span>
	<span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">s</span> <span class="p">{</span>
			<span class="k">if</span> <span class="o">!</span><span class="n">yield</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>So. These things are actually pretty nuts. They break my brain somewhat, because this is the opposite of how iterators usually work. Go calls what I’ve described all the other languages do a “pull iterator”, whereas rangefuncs are “push iterators”.</p> <p>They have a few obvious limitations. For one, you can’t do smart sizing like with Rust or C++ iterators<sup id="fnref:size-hint2" role="doc-noteref"><a href="#fn:size-hint2" class="footnote" rel="footnote">5</a></sup>. Another is that you can’t easily “pause” iteration.</p> <p>But they do have one advantage, which I think is the real reason Go went to so much trouble to implement them (and yes, I will dig into how insane that part is). Using push iterators by default means that users “only” need to write an ordinary for loop packaged into a function. Given that Go makes major performance sacrifices in order to be easy to learn<sup id="fnref:tooling" role="doc-noteref"><a href="#fn:tooling" class="footnote" rel="footnote">6</a></sup>, trying to make it so that an iterator packages the actual looping construct it represents makes quite a bit of sense.</p> <p>Rangefuncs are actually really cool in some respects, because they enable unusual patterns. For example, you can use a rangefunc to provide RAII blocks.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="n">Open</span><span class="p">(</span><span class="n">fs</span> <span class="n">fs</span><span class="o">.</span><span class="n">FS</span><span class="p">,</span> <span class="n">path</span> <span class="kt">string</span><span class="p">)</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq2</span><span class="p">[</span><span class="n">fs</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">fs</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="p">{</span>
      <span class="n">yield</span><span class="p">(</span><span class="no">nil</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">yield</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">Open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">DirFS</span><span class="p">(</span><span class="s">"/"</span><span class="p">),</span> <span class="s">"etc/passwd"</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="c">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Being a block that you can put an epilog onto after yielding a single element is quite powerful! You can also use a nilary rangefunc to simply create a block that you can break out of, instead of having to use <code class="language-plaintext highlighter-rouge">goto</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="n">Once</span><span class="p">()</span> <span class="k">func</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">y</span> <span class="k">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span> <span class="n">y</span><span class="p">()</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="k">range</span> <span class="n">Once</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">canDo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">break</span>
  <span class="p">}</span>

  <span class="n">do</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>So wait. You can return out of rangefunc loops. That means that… Go has non-local returns?!</p> <h2 id="go-now-has-non-local-returns"><a href="#go-now-has-non-local-returns">Go Now Has Non-Local Returns</a></h2> <p>The desugaring for rangefuncs is very complicated. This is because <code class="language-plaintext highlighter-rouge">break</code>, <code class="language-plaintext highlighter-rouge">continue</code>, <code class="language-plaintext highlighter-rouge">goto</code>, and <code class="language-plaintext highlighter-rouge">return</code> all work in a rangefunc! How does this work? Let’s Godbolt it.</p> <p>Let’s start with something really basic: a loop body that just calls a function.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">x</span>

<span class="k">import</span> <span class="s">"iter"</span>

<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">s</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">s</span> <span class="p">{</span>
    <span class="n">sink</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">sink</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This produces the following assembly output (which I’ve reformatted into Intel syntax, and removed some extraneous ABI things, including a writer barrier where <code class="language-plaintext highlighter-rouge">(*)</code> is below).</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">x</span><span class="p">.</span><span class="n">run</span><span class="o">:</span>
    <span class="n">push</span>    <span class="n">rbp</span>
    <span class="n">mov</span>     <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">40</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="kt">int</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_READY</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="s">"type:noalg.struct { F uintptr; X0 *int }"</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">lea</span>     <span class="n">rcx</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">run</span><span class="o">-</span><span class="n">range1</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span><span class="p">],</span> <span class="n">rcx</span>  <span class="c1">// (*)</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">40</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">rbx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">cmp</span>     <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_PANIC</span>
    <span class="n">jeq</span>     <span class="n">panic</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_EXHAUSTED</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">24</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">panic</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_MISSING_PANIC</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">panicrangestate</span>

<span class="n">x</span><span class="p">.</span><span class="n">run</span><span class="o">-</span><span class="n">range1</span><span class="o">:</span>
    <span class="n">push</span>    <span class="n">rbp</span>
    <span class="n">mov</span>     <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rdx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
    <span class="n">cmp</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_READY</span>
    <span class="n">jne</span>     <span class="n">panic2</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">api</span><span class="p">.</span><span class="n">RF_PANIC</span>
    <span class="n">call</span>    <span class="n">x</span><span class="p">.</span><span class="n">sink</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_READY</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">24</span>
    <span class="n">pop</span>     <span class="n">rpb</span>
    <span class="n">ret</span>
<span class="n">panic2</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">rdx</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">panicrangestate</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> <p>This is a lot to take in, but if we look carefully, we decompile this function into a Go function:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">import</span> <span class="p">(</span>
  <span class="s">"internal/abi"</span>
  <span class="s">"runtime"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">s</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span> <span class="p">{</span>
  <span class="n">__state</span> <span class="o">:=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span>
  <span class="n">s</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">v</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">__state</span> <span class="o">!=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_READY</span> <span class="p">{</span>
      <span class="n">runtime</span><span class="o">.</span><span class="n">panicrangestate</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span>
    <span class="n">sink</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c">// Loop body</span>
    <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_READY</span>
    <span class="k">return</span> <span class="no">true</span>
  <span class="p">})</span>
  <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_EXHAUSTED</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Go will actually enforce invariants on the yield it synthesizes in a range for, in order to catch buggy code. In particular, <code class="language-plaintext highlighter-rouge">__state</code> escapes because <code class="language-plaintext highlighter-rouge">s</code> is an arbitrary function, so it gets spilled to the heap.</p> <p>So, what happens when the loop body contains a break? Consider:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">x</span>

<span class="k">import</span> <span class="s">"iter"</span>

<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">s</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">s</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">sink</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">break</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">sink</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>I’ll spare you the assembly listing, since it’s very similar, so I’ll just reverse-engineer the output directly:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">import</span> <span class="p">(</span>
  <span class="s">"internal/abi"</span>
  <span class="s">"runtime"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">s</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span> <span class="p">{</span>
  <span class="n">__state</span> <span class="o">:=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span>
  <span class="n">s</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">v</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">__state</span> <span class="o">!=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_READY</span> <span class="p">{</span>
      <span class="n">runtime</span><span class="o">.</span><span class="n">panicrangestate</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span>
    <span class="k">if</span> <span class="n">sink</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_DONE</span>
      <span class="k">return</span> <span class="no">false</span>
    <span class="p">}</span>
    <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_READY</span>
    <span class="k">return</span> <span class="no">true</span>
  <span class="p">})</span>
  <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_EXHAUSTED</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Non-local returns are much more complicated. Consider:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">x</span>

<span class="k">import</span> <span class="s">"iter"</span>

<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">s</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">s</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">sink</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="o">-</span><span class="m">1</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">sink</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>The resulting assembly is something like this, with some irrelevant code, such as write barriers, removed:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">x</span><span class="p">.</span><span class="n">run</span><span class="o">:</span>
    <span class="n">push</span>    <span class="n">rbp</span>
    <span class="n">mov</span>     <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">56</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="kt">int</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">24</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="kt">int</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="kt">int</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_READY</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="s">"type:noalg.struct { F uintptr; X0 *int; X1 *int; X2 *int }"</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">lea</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">run</span><span class="o">-</span><span class="n">range1</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">rbx</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">24</span><span class="p">],</span> <span class="n">rsi</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">56</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rdi</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">rdi</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">cmp</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_PANIC</span>
    <span class="n">jeq</span>     <span class="n">panic</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_EXHAUSTED</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">cmp</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">jne</span>     <span class="n">resume</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">40</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">resume</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">40</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">panic</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_MISSING_PANIC</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">panicrangestate</span>

<span class="n">x</span><span class="p">.</span><span class="n">run</span><span class="o">-</span><span class="n">range1</span>
    <span class="n">push</span>    <span class="n">rbp</span>
    <span class="n">mov</span>     <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rdx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
    <span class="n">cmp</span>     <span class="n">rbx</span><span class="p">,</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_READY</span>
    <span class="n">jne</span>     <span class="n">panic2</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">56</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">24</span><span class="p">],</span> <span class="n">rsi</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">],</span> <span class="n">rdx</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_PANIC</span>
    <span class="n">call</span>    <span class="n">x</span><span class="p">.</span><span class="n">sink</span>
    <span class="n">test</span>    <span class="n">al</span><span class="p">,</span> <span class="n">al</span>
    <span class="n">jeq</span>     <span class="n">cont</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">56</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rdx</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_DONE</span>
    <span class="n">xor</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">40</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">cont</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">internal</span><span class="o">/</span><span class="n">abi</span><span class="p">.</span><span class="n">RF_READY</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">pop</span>     <span class="n">rpb</span>
    <span class="n">ret</span>
<span class="n">panic</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">rbx</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">panicrangestate</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> <p>Try to reverse engineer this yourself, if you like! If you write this out as Go, here’s what you get:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">import</span> <span class="p">(</span>
  <span class="s">"internal/abi"</span>
  <span class="s">"runtime"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">s</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span> <span class="p">(</span><span class="n">__ret</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">__next</span> <span class="kt">int</span>
  <span class="n">__state</span> <span class="o">:=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span>
  <span class="n">s</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">v</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">__state</span> <span class="o">!=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_READY</span> <span class="p">{</span>
      <span class="n">runtime</span><span class="o">.</span><span class="n">panicrangestate</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span>
    <span class="k">if</span> <span class="n">sink</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_DONE</span>
      <span class="n">__next</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>
      <span class="n">__ret</span> <span class="o">=</span> <span class="n">v</span>
      <span class="k">return</span> <span class="no">false</span>
    <span class="p">}</span>
    <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_READY</span>
    <span class="k">return</span> <span class="no">true</span>
  <span class="p">})</span>
  <span class="n">__state</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_EXHAUSTED</span>
  <span class="k">if</span> <span class="n">__next</span> <span class="o">==</span> <span class="o">-</span><span class="m">1</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">-</span><span class="m">1</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>The reason <code class="language-plaintext highlighter-rouge">__next</code> is an int is because it is also used when exiting the loop via <code class="language-plaintext highlighter-rouge">goto</code> or a <code class="language-plaintext highlighter-rouge">break</code>/<code class="language-plaintext highlighter-rouge">continue</code> with label. It specifies where to jump to after the call into the rangefunc returns. Each potential control flow out of the loop is assigned some negative number.</p> <p>The precise details of the lowering have been <a href="https://cs.opensource.google/go/go/+/master:src/cmd/compile/internal/rangefunc/rewrite.go">exquisitely documented</a> by Russ Cox and David Chase, the primary implementers of the feature.</p> <p>You might be curious what <code class="language-plaintext highlighter-rouge">runtime.panicrangestate</code> does. It’s pretty simple, and it lives in <code class="language-plaintext highlighter-rouge">runtime/panic.go</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">runtime</span>

<span class="c">//go:noinline</span>
<span class="k">func</span> <span class="n">panicrangestate</span><span class="p">(</span><span class="n">state</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_State</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_DONE</span><span class="o">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">rangeDoneError</span><span class="p">)</span>
	<span class="k">case</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_PANIC</span><span class="o">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">rangePanicError</span><span class="p">)</span>
	<span class="k">case</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_EXHAUSTED</span><span class="o">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">rangeExhaustedError</span><span class="p">)</span>
	<span class="k">case</span> <span class="n">abi</span><span class="o">.</span><span class="n">RF_MISSING_PANIC</span><span class="o">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">rangeMissingPanicError</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">throw</span><span class="p">(</span><span class="s">"unexpected state passed to panicrangestate"</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>If you visit this function in <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/runtime/panic.go;l=306?q=panicrangestate&amp;ss=go%2Fgo">runtime/panic.go</a>, you will be greeted by this extremely terrifying comment from Russ Cox immediately after it.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="c">// deferrangefunc is called by functions that are about to</span>
<span class="c">// execute a range-over-function loop in which the loop body</span>
<span class="c">// may execute a defer statement. That defer needs to add to</span>
<span class="c">// the chain for the current function, not the func literal synthesized</span>
<span class="c">// to represent the loop body. To do that, the original function</span>
<span class="c">// calls deferrangefunc to obtain an opaque token representing</span>
<span class="c">// the current frame, and then the loop body uses deferprocat</span>
<span class="c">// instead of deferproc to add to that frame's defer lists.</span>
<span class="c">//</span>
<span class="c">// The token is an 'any' with underlying type *atomic.Pointer[_defer].</span>
<span class="c">// It is the atomically-updated head of a linked list of _defer structs</span>
<span class="c">// representing deferred calls. At the same time, we create a _defer</span>
<span class="c">// struct on the main g._defer list with d.head set to this head pointer.</span>
<span class="c">//</span>
<span class="c">// The g._defer list is now a linked list of deferred calls,</span>
<span class="c">// but an atomic list hanging off:</span>
<span class="c">//</span>
<span class="c">// (increasingly terrifying discussion of concurrent data structures)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This raises one more thing that works in range funcs, seamlessly: <code class="language-plaintext highlighter-rouge">defer</code>. Yes, despite the yield executing multiple call stacks away, possibly on a different goroutine… <code class="language-plaintext highlighter-rouge">defer</code> still gets attached to the calling function.</p> <h2 id="go-now-has-non-local-defer"><a href="#go-now-has-non-local-defer">Go Now Has Non-Local Defer</a></h2> <p>The way defer works is that each G (the goroutine struct, <code class="language-plaintext highlighter-rouge">runtime.g</code>) holds a linked list of defer records, of type <code class="language-plaintext highlighter-rouge">_defer</code>. Each call to <code class="language-plaintext highlighter-rouge">defer</code> sticks one of these onto this list. On function return, Go calls <code class="language-plaintext highlighter-rouge">runtime.deferreturn()</code>, which essentially executes and pops defers off of the list until it finds one whose stack pointer is not the current function’s stack pointer (so, it must belong to another function).</p> <p>Rangefuncs throw a wrench in that mix: if <code class="language-plaintext highlighter-rouge">myFunc.range-n</code> defers, that defer has to be attached to <code class="language-plaintext highlighter-rouge">myFunc</code>’s defer records somehow. So the list must have a way of inserting in the middle.</p> <p>This is what this comment is about: when <code class="language-plaintext highlighter-rouge">defer</code> occurs in the loop body, that defer gets attached to a defer record for that function, using a token that the yield captures; this is later canonicalized when walking the defer list on the way out of <code class="language-plaintext highlighter-rouge">myFunc</code>. Because the yield can escape onto another goroutine, this part of the <code class="language-plaintext highlighter-rouge">defer</code> chain has to be atomic.</p> <p>Incredibly, this approach is extremely robust. For example, if we spawn the yield as a goroutine, and carefully synchronize between that and the outer function, we can force the runtime to hard-crash when <code class="language-plaintext highlighter-rouge">defer</code>ing to a function that has returned.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"sync"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">bad</span><span class="p">()</span> <span class="p">(</span><span class="n">out</span> <span class="k">func</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
	<span class="n">w1</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="n">w2</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>

	<span class="n">out</span> <span class="o">=</span> <span class="n">w2</span><span class="o">.</span><span class="n">Done</span>
	<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="nb">recover</span><span class="p">()</span> <span class="p">}()</span>
	<span class="n">iter</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">go</span> <span class="n">yield</span><span class="p">()</span>
		<span class="n">w1</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span> <span class="c">// Wait to enter yield().</span>
    <span class="c">// This panics once w1.Done() executes, because</span>
    <span class="c">// we exit the rangefunc while yield() is still</span>
    <span class="c">// running. The runtime incorrectly attributes</span>
    <span class="c">// this to recovering in the rangefunc.</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="k">range</span> <span class="n">iter</span> <span class="p">{</span>
		<span class="n">w1</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span> <span class="c">// Allow the outer function to exit the loop.</span>
		<span class="n">w2</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span> <span class="c">// Wait for bad() to return.</span>
		<span class="k">defer</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"bang"</span><span class="p">)</span>
	<span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span> <span class="c">// Unreachable</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">resume</span> <span class="o">:=</span> <span class="n">bad</span><span class="p">()</span>
  <span class="n">resume</span><span class="p">()</span>
  <span class="k">select</span> <span class="p">{}</span>  <span class="c">// Block til crash.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This gets us <code class="language-plaintext highlighter-rouge">fatal error: defer after range func returned</code>. Pretty sick! It accomplishes this by poisoning the token the yield func uses to defer.</p> <p>I have tried various other attempts at causing memory unsafety with rangefuncs, but Go actually does a really good job of avoiding this. The only thing I’ve managed to do that’s especially interesting is to tear the return slot on a function without named returns, but that’s no worse than tearing any other value (which is still really bad, because you can tear interface values, but it’s not <em>worse</em>).</p> <h2 id="pull-iterators-and-coroutines"><a href="#pull-iterators-and-coroutines">Pull Iterators and Coroutines</a></h2> <p>Of course we’re not done. Go provides a mechanism for converting push iterators into pull iterators. Essentially, there is a function that looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">iter</span>

<span class="k">func</span> <span class="n">Pull</span><span class="p">[</span><span class="n">V</span> <span class="n">any</span><span class="p">](</span><span class="n">seq</span> <span class="n">Seq</span><span class="p">[</span><span class="n">V</span><span class="p">])</span> <span class="p">(</span><span class="n">next</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="kt">bool</span><span class="p">),</span> <span class="n">stop</span> <span class="k">func</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">yield</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{</span><span class="n">value</span> <span class="n">V</span><span class="p">;</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">})</span>
  <span class="n">pull</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{}{})</span>
  <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">seq</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">v</span> <span class="n">V</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
      <span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">pull</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">false</span>
      <span class="p">}</span>
      <span class="n">yield</span> <span class="o">&lt;-</span> <span class="k">struct</span><span class="p">{</span><span class="n">value</span> <span class="n">V</span><span class="p">;</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">}{</span><span class="n">v</span><span class="p">,</span> <span class="no">true</span><span class="p">}</span>
    <span class="p">})</span>

    <span class="nb">close</span><span class="p">(</span><span class="n">yield</span><span class="p">)</span>
  <span class="p">}()</span>

  <span class="n">next</span> <span class="o">=</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pull</span> <span class="o">&lt;-</span> <span class="k">struct</span><span class="p">{}{}</span>
    <span class="k">return</span> <span class="o">&lt;-</span><span class="n">yield</span>
  <span class="p">}</span>
  <span class="n">stop</span> <span class="o">=</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="nb">close</span><span class="p">(</span><span class="n">pull</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">return</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Essentially, you can request values with <code class="language-plaintext highlighter-rouge">next()</code>, and <code class="language-plaintext highlighter-rouge">stop()</code> can be used if you finish early. But also, this spawns a whole goroutine and uses channels to communicate and synchronize, which feels very unnecessary.</p> <p>The implementation doesn’t use goroutines. It uses coroutines.</p> <h3 id="giving-up-on-goroutines"><a href="#giving-up-on-goroutines">Giving Up on Goroutines</a></h3> <p>Spawning a goroutine is expensive. Doing so expends scheduler and memory resources. It’s overkill for a helper like this (ironic, because the original premise of Go was that goroutines would be cheap enough to allocate willy-nilly).</p> <p>Go instead implements this using “coroutines”, a mechanism for concurrency without parallelism. This is intended to make context switching very cheap, because it does not need to go through the scheduler: instead, it uses cooperative multitasking.</p> <p>The coroutine interface is something like the following. My “userland” implementation will not be very efficient, because it relies on the scheduler to transfer control. The goroutines may run on different CPUs, so synchronization is necessary for communication, even if they are not running concurrently.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">coro</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"runtime"</span>
  <span class="s">"sync"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Coro</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">m</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">f</span> <span class="k">func</span><span class="p">())</span> <span class="o">*</span><span class="n">Coro</span> <span class="p">{</span>
  <span class="n">c</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="n">Coro</span><span class="p">)</span>
  <span class="n">c</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
  <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">c</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">f</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">c</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Coro</span><span class="p">)</span> <span class="n">Resume</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">c</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
  <span class="n">c</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>When we create a coroutine with <code class="language-plaintext highlighter-rouge">coro.New()</code>, it spawns a goroutine that waits on a mutex. Another goroutine can “take its place” as the mutex holder by calling <code class="language-plaintext highlighter-rouge">c.Resume()</code>, which allows the coroutine spawned by <code class="language-plaintext highlighter-rouge">coro.New</code> to resume and enter <code class="language-plaintext highlighter-rouge">f()</code>.</p> <p>Using the coroutine as a rendezvous point, two goroutines can perform concurrent work: in the case of <code class="language-plaintext highlighter-rouge">iter.Pull</code>, one can be deep inside of whatever loops the iterator wants to do, and the other can request values.</p> <p>Here’s what using my <code class="language-plaintext highlighter-rouge">coro.Coro</code> to implement <code class="language-plaintext highlighter-rouge">iter.Pull</code> might look like:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">iter</span>

<span class="k">func</span> <span class="n">Pull</span><span class="p">[</span><span class="n">V</span> <span class="n">any</span><span class="p">](</span><span class="n">seq</span> <span class="n">Seq</span><span class="p">[</span><span class="n">V</span><span class="p">])</span> <span class="p">(</span><span class="n">next</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="kt">bool</span><span class="p">),</span> <span class="n">stop</span> <span class="k">func</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">var</span> <span class="p">(</span>
    <span class="n">done</span> <span class="kt">bool</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">z</span> <span class="n">V</span>
  <span class="p">)</span>

  <span class="n">c</span> <span class="o">:=</span> <span class="n">coro</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">s</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">v1</span> <span class="n">V</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
      <span class="n">c</span><span class="o">.</span><span class="n">Resume</span><span class="p">()</span>  <span class="c">// Wait for a request for a value.</span>
      <span class="k">if</span> <span class="n">done</span> <span class="p">{</span>
        <span class="c">// This means we resumed from stop(). Break out of the</span>
        <span class="c">// loop.</span>
        <span class="k">return</span> <span class="no">false</span>
      <span class="p">}</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">v1</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">done</span> <span class="p">{</span>
      <span class="c">// Yield the last value.</span>
      <span class="n">c</span><span class="o">.</span><span class="n">Resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">z</span>
    <span class="n">done</span> <span class="o">=</span> <span class="no">true</span>
  <span class="p">})</span>

  <span class="n">next</span> <span class="o">=</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">done</span> <span class="p">{</span> <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="no">false</span> <span class="p">}</span>

    <span class="n">c</span><span class="o">.</span><span class="n">Resume</span><span class="p">()</span>      <span class="c">// Request a value.</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="no">true</span>  <span class="c">// Return it.</span>
  <span class="p">}</span>

  <span class="n">stop</span> <span class="o">=</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">done</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

    <span class="n">done</span> <span class="o">=</span> <span class="no">true</span> <span class="c">// Mark iteration as complete.</span>
    <span class="n">c</span><span class="o">.</span><span class="n">Resume</span><span class="p">()</span>  <span class="c">// Resume the iteration goroutine to it can exit.</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">next</span><span class="p">,</span> <span class="n">stop</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>If you look at the implementation in <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/iter/iter.go"><code class="language-plaintext highlighter-rouge">iter.go</code></a>, it’s basically this, but with a lot of error checking and race detection, to prevent misuse, such as if <code class="language-plaintext highlighter-rouge">next</code> or <code class="language-plaintext highlighter-rouge">stop</code> escape to other goroutines.</p> <p>Now, the main thing that runtime support brings here is that <code class="language-plaintext highlighter-rouge">Resume()</code> is immediate: it does not go to the scheduler, which might not decide to immediately run the goroutine that last called <code class="language-plaintext highlighter-rouge">Resume()</code> for a variety of reasons (for example, to ensure wakeup fairness). Coroutines sidestep fairness, by making <code class="language-plaintext highlighter-rouge">Resume()</code> little more than a jump to the last <code class="language-plaintext highlighter-rouge">Resume()</code> (with registers fixed up accordingly).</p> <p>This is not going to be <em>that</em> cheap: a goroutine still needs to be allocated, and switching needs to poke and prod the underlying Gs a little bit. But it’s a cool optimization, and I hope coroutines eventually make their way into more things in Go, hopefully as a language or <code class="language-plaintext highlighter-rouge">sync</code> primitive.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>Congratulations, you have survived over 3000 words of me going on about iterators. Go’s push iterators are a unique approach to a common language design problem (even if it took a decade for them to materialize).</p> <p>I encountered rangefuncs for the first time earlier this year and have found them absolutely fascinating, both from a “oh my god they actually did that” perspective and from a “how do we express iteration” perspective. I don’t think the result was perfect by any means, and it is unsuitable for languages that need the performance you can only get from pull iterators. I think they would be a great match for a language like Python or Java, though.</p> <p>I’d like to thank David Chase, an old colleague, for tolerating my excited contrived questions about the guts of this feature.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:cc-range" role="doc-endnote"> <p>Ugh, ok. This is the C++20 desugaring, and there are cases where we do not just call <code class="language-plaintext highlighter-rouge">std::begin()</code>. In particular, array references and class type references with <code class="language-plaintext highlighter-rouge">.begin()</code> and <code class="language-plaintext highlighter-rouge">.end()</code> do not call <code class="language-plaintext highlighter-rouge">std::begin()</code> and are open-coded. This means that you can’t use ADL to override these types’ iterator. <a href="#fnref:cc-range" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:loop-jargon" role="doc-endnote"> <p>In compiler jargon, a loop is broken up into three parts: the <em>header</em>, which is where the loop is entered, the <em>body</em>, which is one step of iteration, and the <em>latch</em>, which is the part that jumps back to the start of the body. This is where incrementation in a C-style for loop happens. <a href="#fnref:loop-jargon" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:size_hint" role="doc-endnote"> <p>And with better performance. Rust’s iterators can provide a size hint to help size containers before a call to <code class="language-plaintext highlighter-rouge">collect()</code>, via the <a href="https://doc.rust-lang.org/std/iter/trait.FromIterator.html"><code class="language-plaintext highlighter-rouge">FromIterator</code></a> trait. <a href="#fnref:size_hint" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:chan-iter" role="doc-endnote"> <p>Some people observed that you can use a channel as a custom iterator, by having a parallel goroutine run a for loop to feed the channel. <em>Do not do this.</em> It is slow: it has to transit each element through the heap, forcing anything it points to escape. It takes up an extra M and a P in the scheduler, and requires potentially allocating a stack for a G. It’s probably faster to just build a slice and return that, especially for small iterations. <a href="#fnref:chan-iter" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:size-hint2" role="doc-endnote"> <p>For this reason, I wish that Go had instead defined something along these lines.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">iter</span>

<span class="k">type</span> <span class="n">Seq</span><span class="p">[</span><span class="n">V</span> <span class="n">any</span><span class="p">]</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">Iterate</span><span class="p">(</span><span class="n">yield</span> <span class="k">func</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This is functionally identical to what they did, but it would have permitted future extensions such as the following interface:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">iter</span>

<span class="k">type</span> <span class="n">SizedSeq</span><span class="p">[</span><span class="n">V</span> <span class="n">any</span><span class="p">]</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">Seq</span><span class="p">[</span><span class="n">V</span><span class="p">]</span>

  <span class="n">SizeHint</span><span class="p">()</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="kt">int64</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This would mean that <code class="language-plaintext highlighter-rouge">slices.Collect</code> could be enhanced into something like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">slices</span>

<span class="k">func</span> <span class="n">Collect</span><span class="p">[</span><span class="n">E</span> <span class="n">any</span><span class="p">](</span><span class="n">seq</span> <span class="n">iter</span><span class="o">.</span><span class="n">Seq</span><span class="p">[</span><span class="n">E</span><span class="p">])</span> <span class="p">[]</span><span class="n">E</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">out</span> <span class="p">[]</span><span class="n">E</span>
  <span class="k">if</span> <span class="n">sized</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">seq</span><span class="o">.</span><span class="p">(</span><span class="n">iter</span><span class="o">.</span><span class="n">SizedSeq</span><span class="p">[</span><span class="n">E</span><span class="p">]);</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="n">lower</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">sized</span><span class="o">.</span><span class="n">SizeHint</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">E</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">seq</span> <span class="p">{</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>I don’t think there’s an easy way to patch this up, at this point. <a href="#fnref:size-hint2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:tooling" role="doc-endnote"> <p>Disclaimer: I am not going to dig into Go’s rationale for rangefuncs. Knowing how the sausage is made, most big Go proposals are a mix of understandable reasoning and less reasonable veiled post-hoc justification to compensate for either Google planning/approvals weirdness or because the design was some principal engineer’s pony. This isn’t even a Go thing, it’s a Google culture problem. I say this as the architect of <a href="https://protobuf.dev/editions/overview">Protobuf Editions</a>, the biggest change to Protobuf since Rob’s misguided proto3<sup id="fnref:proto2" role="doc-noteref"><a href="#fn:proto2" class="footnote" rel="footnote">7</a></sup> experiment. <em>I</em> have written this kind of language proposal, on purpose, because bad culture mandated it.</p> <p><em>The purpose of a system is what it does.</em> It is easier to understand a system by observing its response to stimuli, rather than what it says on the tin. So let’s use that lens.</p> <p>Go wants to be easy to learn. It intended to replace C++ at Google (lol, lmao), which, of course, failed disastrously, because performance of the things already written in C++ is tied to revenue. They have successfully pivoted to being an easy-to-learn language that makes it easy to onboard programmers regardless of what they already use, as opposed to onboarding them to C++.</p> <p>This does not mean that Go is user-friendly. In fact, user-friendliness is clearly not a core value. Rob and his greybeard crowd didn’t seem to care about the human aspect of interacting with a toolchain, so Go tooling rarely provides good diagnostics, nor did the language, until the last few years, try to reduce toil. After all, if it is tedious to use but simple, that does make it easy to onboard new programmers.</p> <p>Rust is the opposite: it is very difficult to learn with a famously steep learning curve; however, it is very accessible, because the implementors have sanded down every corner and sharp edge using diagnostics, error messages, and tooling. C++ is neither of these things. It is very difficult to learn, and most compilers are pretty unhelpful (if they diagnose anything at all).</p> <p>I think that Go has at least realized the language can be a pain to use in some situations, which is fueled in part by legitimate UX research. This is why Go has generics and other recent advanced language features, like being able to use the <code class="language-plaintext highlighter-rouge">for</code> syntax with integers or with custom iterators.</p> <p>I think that rangefuncs are easy to learn in the way Go needs them to be. If you expect more users to want to write rangefuncs than users want to write complicated <em>uses</em> of rangefuncs, I think push iterators are the easiest to learn how to use.</p> <p>I think this is a much more important reason for all the trouble that rangefuncs generate for the compiler and runtime than, say, compatibility with existing code; I have not seen many cases in the wild or in the standard library that conform to the rangefunc signatures. <a href="#fnref:tooling" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:proto2" role="doc-endnote"> <p>But please don’t use proto3. I’m telling you that as the guy who maintained the compiler. Just don’t. <a href="#fnref:proto2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="dark-arts"/><category term="go"/><summary type="html"><![CDATA[A second post on Go silliness (Miguel, aren’t you a C++ programmer?): in 1.23, Go finally added custom iterators. Now, back when I was at Google and involved in the Go compiler as “the annoying Rust guy who gets lunch with us”, there were proposals suggesting adding something like this, implemented as either an interface or a func:]]></summary></entry><entry><title type="html">Things You Never Wanted To Know About Go Interfaces</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2024/12/12/go-abi/" rel="alternate" type="text/html" title="Things You Never Wanted To Know About Go Interfaces"/><published>2024-12-12T00:00:00-08:00</published><updated>2024-12-12T00:00:00-08:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2024/12/12/go-abi</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2024/12/12/go-abi/"><![CDATA[<p>Lately I’ve been finding myself writing a bit of Go, and I’ve picked up various fun “layout secrets” that help inform how I write code to minimize hidden allocations, and generally be kind to the optimizer. This article is a series of notes on the topic.</p> <p>This post is about Go implementation details, so they can probably break you at any time if you rely on it. On the other hand, Hyrum’s law is a bitch, so taking your chances may not be that bad. After all, they’re probably never going to be able to properly clean up the mess people made with <code class="language-plaintext highlighter-rouge">//go:linkname</code> with runtime symbols…</p> <p>As with many of my other posts, I’ll assume a basic familiarity with being able to read assembly. I’m using x86 for this post, but it’s worth looking at my <a href="https://mcyoung.xyz//2021/11/09/assembly-1">RISC-V post</a> for a refresher.</p> <h2 id="gc-shapes"><a href="#gc-shapes">GC Shapes</a></h2> <p>The most basic Go-specific concept when it comes to type layouts is the <em>shape</em> of a type. This is an implementation detail of Go’s garbage collector that leaks through the <code class="language-plaintext highlighter-rouge">unsafe</code> package.</p> <p>Like in most native programming languages, every Go type has a size (the number of bytes that type takes up in memory) and an alignment (a power of two that every pointer to that type must be divisible by). Go, like most other languages, requires that size be divisible by the alignment: that is, the size is equal to the stride of an array of that type.</p> <p>The size an alignment of a type can be queried by the intrinsics <a href="https://pkg.go.dev/unsafe#Sizeof"><code class="language-plaintext highlighter-rouge">unsafe.Sizeof</code></a> and <a href="https://pkg.go.dev/unsafe#Alignof"><code class="language-plaintext highlighter-rouge">unsafe.Alignof</code></a>. These are very unwieldy in generic code, so I like to define a couple of helpers<sup id="fnref:constants" role="doc-noteref"><a href="#fn:constants" class="footnote" rel="footnote">1</a></sup>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="n">Size</span><span class="p">[</span><span class="n">T</span> <span class="n">any</span><span class="p">]()</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">v</span> <span class="n">T</span>
  <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">Align</span><span class="p">[</span><span class="n">T</span> <span class="n">any</span><span class="p">]()</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">v</span> <span class="n">T</span>
  <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Alignof</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Together, these two quantities are called the <em>layout</em> of a type (a term common to many native languages). However, the <em>shape</em> of a type also records what pieces thereof contain <em>pointers</em>. This is because memory visible to the GC (such as globals, heap memory, or stack roots) is typed, and the GC needs to know which parts of those types are pointers that it needs to trace through.</p> <p>Because all pointers have the same size and alignment (4 or 8 bytes depending on the system) the pointer words of a type can be represented as a bitset, one bit for every 4 or 8 bytes in the type. This, in fact, is the representation used by the GC<sup id="fnref:gc-programs" role="doc-noteref"><a href="#fn:gc-programs" class="footnote" rel="footnote">2</a></sup>.</p> <p>In particular, this means that whether a field is to be interpreted as an <code class="language-plaintext highlighter-rouge">unsafe.Pointer</code> or as a <code class="language-plaintext highlighter-rouge">uintptr</code> is a static property of the type. As we will see when we discuss interfaces, this restriction prevents a few layout optimizations.</p> <h2 id="slices-and-strings"><a href="#slices-and-strings">Slices and Strings</a></h2> <p>Go is very public about the layout of slices and strings. A slice is</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">slice</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">data</span>     <span class="o">*</span><span class="n">T</span>
  <span class="nb">len</span><span class="p">,</span> <span class="nb">cap</span> <span class="kt">int</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p><code class="language-plaintext highlighter-rouge">len</code> and <code class="language-plaintext highlighter-rouge">cap</code> are extracted by their eponymous builtins, and <code class="language-plaintext highlighter-rouge">data</code> can be obtained using <code class="language-plaintext highlighter-rouge">unsafe.SliceData</code> (or <code class="language-plaintext highlighter-rouge">&amp;s[0]</code> if the slice is nonempty, but that costs a bounds-check).</p> <p>A string has the same layout as a <code class="language-plaintext highlighter-rouge">[]byte</code>, except for a capacity:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="kt">string</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">data</span> <span class="o">*</span><span class="kt">byte</span>
  <span class="nb">len</span>  <span class="kt">int</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Despite essentially being slices, Go treats strings subtly differently. Strings are <code class="language-plaintext highlighter-rouge">comparable</code>, so they can be used as map keys. They are also immutable, which enables a handful of optimizations. Immutability is also why they are <code class="language-plaintext highlighter-rouge">comparable</code>: Go made the mistake of not keeping <code class="language-plaintext highlighter-rouge">const</code> from C, but they really want map keys to be <code class="language-plaintext highlighter-rouge">const</code>.</p> <p>There is nothing stopping us from aliasing strings to data pointed to by a slice: after all, <code class="language-plaintext highlighter-rouge">strings.Builder</code> does it to avoid a copy in <code class="language-plaintext highlighter-rouge">String()</code>. We can implement this easily enough with some <code class="language-plaintext highlighter-rouge">unsafe</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="n">StringAlias</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">unsafe</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">SliceData</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Doing this is perfectly safe, so long as data is not mutated while the returned string is accessible. This allows virtually any slice type to be used as a key in a map, with some caveats.</p> <ol> <li> <p>Types which contain alignment padding cannot be used, because Go does not promise that it zeros memory returned by <code class="language-plaintext highlighter-rouge">new</code>.</p> </li> <li> <p>Types which contain pointers will cause those pointers to become unreachable if the only reference is the aliased string; this is because the pointed to data’s shape contains no pointer words.</p> </li> <li> <p>Incomparable types and interfaces will be compared by address (that is, maps, channels and funcs).</p> </li> </ol> <h3 id="dynamic-arrays-with-reflection"><a href="#dynamic-arrays-with-reflection">Dynamic Arrays with Reflection</a></h3> <p>Now, this isn’t the only to accomplish this: you can create dynamically-sized array types using reflection, like so:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="n">Slice2Array</span><span class="p">[</span><span class="n">T</span> <span class="n">any</span><span class="p">](</span><span class="n">s</span> <span class="p">[]</span><span class="n">T</span><span class="p">)</span> <span class="n">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span> <span class="k">return</span> <span class="no">nil</span> <span class="p">}</span>

  <span class="k">var</span> <span class="n">v</span> <span class="n">T</span>
  <span class="n">elem</span> <span class="o">:=</span> <span class="n">reflect</span><span class="o">.</span><span class="n">TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="n">array</span> <span class="o">:=</span> <span class="n">reflect</span><span class="o">.</span><span class="n">ArrayOf</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">elem</span><span class="p">)</span>

  <span class="c">// NOTE: NewAt will return a reflect.Value containing a</span>
  <span class="c">// pointer, not an array!</span>
  <span class="n">refl</span> <span class="o">:=</span> <span class="n">reflect</span><span class="o">.</span><span class="n">NewAt</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">unsafe</span><span class="o">.</span><span class="n">SliceData</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
  <span class="n">refl</span> <span class="o">=</span> <span class="n">refl</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span> <span class="c">// Dereference to get a pointer-to-array.</span>
  <span class="k">return</span> <span class="n">refl</span><span class="o">.</span><span class="n">Interface</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This will return an <code class="language-plaintext highlighter-rouge">any</code> whose type is <code class="language-plaintext highlighter-rouge">[len(s)]T</code>. You can even type assert it for static array sizes. This any is suitable for placing into a <code class="language-plaintext highlighter-rouge">map[any]T</code>, just as if we had built it with e.g. <code class="language-plaintext highlighter-rouge">any([...]byte("foo"))</code></p> <p>However, and this is not at all obvious from the code here, calling <code class="language-plaintext highlighter-rouge">refl.Interface()</code> will perform a copy of the whole array. <code class="language-plaintext highlighter-rouge">Interface()</code> delegates through a few functions until it calls <code class="language-plaintext highlighter-rouge">reflect.packEface()</code>.</p> <p>The code this function (<a href="https://cs.opensource.google/go/go/+/master:src/reflect/value.go;l=119?q=packEface&amp;ss=go%2Fgo">found here</a>) is reproduced below:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">reflect</span>

<span class="c">// packEface converts v to the empty interface.</span>
<span class="k">func</span> <span class="n">packEface</span><span class="p">(</span><span class="n">v</span> <span class="n">Value</span><span class="p">)</span> <span class="n">any</span> <span class="p">{</span>
	<span class="n">t</span> <span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="n">typ</span><span class="p">()</span>
	<span class="k">var</span> <span class="n">i</span> <span class="n">any</span>
	<span class="n">e</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="n">abi</span><span class="o">.</span><span class="n">EmptyInterface</span><span class="p">)(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">))</span>
	<span class="c">// First, fill in the data portion of the interface.</span>
	<span class="k">switch</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">t</span><span class="o">.</span><span class="n">IfaceIndir</span><span class="p">()</span><span class="o">:</span>
		<span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">flag</span><span class="o">&amp;</span><span class="n">flagIndir</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">"bad indir"</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c">// Value is indirect, and so is the interface we're making.</span>
		<span class="n">ptr</span> <span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="n">ptr</span>
		<span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">flag</span><span class="o">&amp;</span><span class="n">flagAddr</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">:=</span> <span class="n">unsafe_New</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
			<span class="n">typedmemmove</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">c</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">.</span><span class="n">Data</span> <span class="o">=</span> <span class="n">ptr</span>
	<span class="k">case</span> <span class="n">v</span><span class="o">.</span><span class="n">flag</span><span class="o">&amp;</span><span class="n">flagIndir</span> <span class="o">!=</span> <span class="m">0</span><span class="o">:</span>
		<span class="c">// Value is indirect, but interface is direct. We need</span>
		<span class="c">// to load the data at v.ptr into the interface data word.</span>
		<span class="n">e</span><span class="o">.</span><span class="n">Data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">)(</span><span class="n">v</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="c">// Value is direct, and so is the interface.</span>
		<span class="n">e</span><span class="o">.</span><span class="n">Data</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">ptr</span>
	<span class="p">}</span>
	<span class="c">// Now, fill in the type portion. We're very careful here not</span>
	<span class="c">// to have any operation between the e.word and e.typ assignments</span>
	<span class="c">// that would let the garbage collector observe the partially-built</span>
	<span class="c">// interface value.</span>
	<span class="n">e</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">t</span>
	<span class="k">return</span> <span class="n">i</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>The switch determines precisely how the interface data pointer is computed. It turns out that (almost all) array types return true for <code class="language-plaintext highlighter-rouge">t.IfaceIndr()</code>, so the first case is selected, which triggers a copy (that being the call to <code class="language-plaintext highlighter-rouge">unsafe_New()</code> followed by a <code class="language-plaintext highlighter-rouge">typedmemmove</code>). This copy is to ensure that the value of the resulting interface cannot be mutated.</p> <p>Now, if only we knew the layout of Go’s interfaces, we might be able to get somewhere here…</p> <h2 id="the-layout-of-gos-interfaces"><a href="#the-layout-of-gos-interfaces">The Layout of Go’s Interfaces</a></h2> <p>Oh, yes, that’s what this article is about. So, if we look at the <code class="language-plaintext highlighter-rouge">runtime2.go</code> file in the runtime (yes, that’s what it’s called), nestled among the giant scheduler types for Gs, Ps, and Ms, we’ll find a couple of structs that really elucidate what’s going on:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">runtime</span>

<span class="k">type</span> <span class="n">funcval</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">fn</span> <span class="kt">uintptr</span>
	<span class="c">// variable-size, fn-specific data here</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">iface</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">tab</span>  <span class="o">*</span><span class="n">itab</span>
	<span class="n">data</span> <span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">eface</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">_type</span> <span class="o">*</span><span class="n">_type</span>
	<span class="n">data</span>  <span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p><code class="language-plaintext highlighter-rouge">funcval</code> is the layout of a <code class="language-plaintext highlighter-rouge">func()</code>, more on that later. <code class="language-plaintext highlighter-rouge">iface</code> is the layout of your “usual” interface, consisting of an <code class="language-plaintext highlighter-rouge">itab</code> (an interface table, or what Go calls a vtable) and a pointer to some data. <code class="language-plaintext highlighter-rouge">eface</code> is the layout of <code class="language-plaintext highlighter-rouge">any</code> (the artist formerly known as <code class="language-plaintext highlighter-rouge">interface{}</code>, hence the name: <em>e</em>mpty inter<em>face</em>).</p> <p><code class="language-plaintext highlighter-rouge">eface</code> having its own layout is an optimization. Because <code class="language-plaintext highlighter-rouge">any</code> exists to be downcast from dynamically, storing the type directly cuts out a pointer load when doing a type switch on an <code class="language-plaintext highlighter-rouge">any</code> specifically. If we look at what an <code class="language-plaintext highlighter-rouge">itab</code> is (which is “just” an <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/internal/abi/iface.go;l=14"><code class="language-plaintext highlighter-rouge">abi.ITab</code></a>):</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">abi</span>

<span class="c">// The first word of every non-empty interface type contains an *ITab.</span>
<span class="c">// It records the underlying concrete type (Type), the interface type</span>
<span class="c">// it is implementing (Inter), and some ancillary information.</span>
<span class="c">//</span>
<span class="c">// allocated in non-garbage-collected memory</span>
<span class="k">type</span> <span class="n">ITab</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Inter</span> <span class="o">*</span><span class="n">InterfaceType</span>
	<span class="n">Type</span>  <span class="o">*</span><span class="n">Type</span>
	<span class="n">Hash</span>  <span class="kt">uint32</span>     <span class="c">// copy of Type.Hash. Used for type switches.</span>
	<span class="n">Fun</span>   <span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c">// fun[0]==0 means Type does not implement Inter.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <h3 id="codegen-for-interface-operations"><a href="#codegen-for-interface-operations">Codegen for Interface Operations</a></h3> <p>An <code class="language-plaintext highlighter-rouge">ITab</code> contains the same type it would have as an <code class="language-plaintext highlighter-rouge">any</code>, which makes the generated code for a function that upcasts an interface to <code class="language-plaintext highlighter-rouge">any</code> very simple<sup id="fnref:asm" role="doc-noteref"><a href="#fn:asm" class="footnote" rel="footnote">3</a></sup>:</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">func</span> <span class="n">Upcast</span><span class="p">(</span><span class="n">i</span> <span class="n">MyIface</span><span class="p">)</span> <span class="n">any</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">i</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">F</span><span class="o">:</span>
    <span class="n">test</span>    <span class="n">rax</span><span class="p">,</span> <span class="n">rax</span>
    <span class="n">jeq</span>     <span class="n">nil</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">nil</span><span class="o">:</span>
    <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>In the register ABI, the x86 argument (and return) registers are <code class="language-plaintext highlighter-rouge">rax</code>, <code class="language-plaintext highlighter-rouge">rbx</code>, <code class="language-plaintext highlighter-rouge">rcx</code>, <code class="language-plaintext highlighter-rouge">rdi</code>, <code class="language-plaintext highlighter-rouge">rsi</code>, <code class="language-plaintext highlighter-rouge">r8</code>, <code class="language-plaintext highlighter-rouge">r9</code>, <code class="language-plaintext highlighter-rouge">r10</code> and <code class="language-plaintext highlighter-rouge">r11</code> (with <code class="language-plaintext highlighter-rouge">rdx</code> reserved for passing a closure capture, more on that later; <code class="language-plaintext highlighter-rouge">r14</code> holds a pointer to the currently running G).</p> <p>The <code class="language-plaintext highlighter-rouge">*ITab</code> comes in on <code class="language-plaintext highlighter-rouge">rax</code> and the data pointer on <code class="language-plaintext highlighter-rouge">rbx</code>. First, we need to check if this is the nil interface, identified by having a nil itab (or type, in the case of <code class="language-plaintext highlighter-rouge">any</code>). If it is nil, we just return: <code class="language-plaintext highlighter-rouge">rax:rbx</code> already contain the data of a nil <code class="language-plaintext highlighter-rouge">any</code>. Otherwise, we load <code class="language-plaintext highlighter-rouge">ITab.Type</code>, at offset 8, into <code class="language-plaintext highlighter-rouge">rax</code>, and return.</p> <p>How do interface function calls work?</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">type</span> <span class="n">MyIface</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">Method</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">Call</span><span class="p">(</span><span class="n">m</span> <span class="n">MyIface</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="m">42</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Call</span><span class="o">:</span>
    <span class="n">cmp</span>     <span class="n">rsp</span><span class="p">,</span> <span class="p">[</span><span class="n">r14</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">jls</span>     <span class="n">grow</span>
    <span class="n">push</span>    <span class="n">rbp</span>
    <span class="n">mov</span>     <span class="n">rsp</span><span class="p">,</span> <span class="n">rbp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rbx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">rbx</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="mi">42</span>
    <span class="n">call</span>    <span class="n">rcx</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">16</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">grow</span><span class="o">:</span>
    <span class="n">nop</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">rbx</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">morestack_noctxt</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">jmp</span>     <span class="n">foo</span><span class="p">.</span><span class="n">Call</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>This function seems to be doing a lot more than it actually is. Part of it is that its prologue has to do a call to <code class="language-plaintext highlighter-rouge">runtime.morestack_noctxt()</code>, which is simply a call to <code class="language-plaintext highlighter-rouge">runtime.morestack</code> that clobbers <code class="language-plaintext highlighter-rouge">rdx</code>, the closure capture parameter. The meat of it comes when it loads <code class="language-plaintext highlighter-rouge">[rax + 24]</code>, the first element of <code class="language-plaintext highlighter-rouge">ITab.Fun</code>. It then moves the data pointer in <code class="language-plaintext highlighter-rouge">rbx</code> to <code class="language-plaintext highlighter-rouge">rax</code>, the argument into <code class="language-plaintext highlighter-rouge">rbx</code>, and issues the call.</p> <p>What about upcasts? An upcast to a concrete type is quite simple: simply compare the type in the interface (either directly or in the <code class="language-plaintext highlighter-rouge">*ITab</code>) to a particular statically-known one. Downcasting to an interface (sometimes called a <em>sidecast</em>) is much more complicated, because it essentially requires a little bit of reflection.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">type</span> <span class="n">MyIface</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">Method</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">Downcast</span><span class="p">(</span><span class="n">m</span> <span class="n">any</span><span class="p">)</span> <span class="n">MyIface</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="p">(</span><span class="n">MyIface</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Downcast</span><span class="o">:</span>
    <span class="n">cmp</span>     <span class="n">rsp</span><span class="p">,</span> <span class="p">[</span><span class="n">r14</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">jls</span>     <span class="n">grow</span>
    <span class="n">push</span>    <span class="n">rpb</span>
    <span class="n">mov</span>     <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rbx</span>
    <span class="n">test</span>    <span class="n">rax</span><span class="p">,</span> <span class="n">rax</span>
    <span class="n">jeq</span>     <span class="n">nil</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">foo</span><span class="p">..</span><span class="n">typeAssert0</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
<span class="n">hashProbe</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rdi</span><span class="p">,</span> <span class="n">rsi</span>
    <span class="n">and</span>     <span class="n">rsi</span><span class="p">,</span> <span class="n">rdx</span>
    <span class="n">shl</span>     <span class="n">rsi</span><span class="p">,</span> <span class="mi">4</span>
    <span class="n">mov</span>     <span class="n">r8</span><span class="p">,</span> <span class="p">[</span><span class="n">rcx</span> <span class="o">+</span> <span class="n">rsi</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">cmp</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">r8</span>
    <span class="n">jeq</span>     <span class="n">found</span>
    <span class="n">lea</span>     <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">test</span>    <span class="n">r8</span><span class="p">,</span> <span class="n">r8</span>
    <span class="n">jnz</span>     <span class="n">hashProbe</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rbx</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="n">rax</span>
    <span class="n">leq</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">foo</span><span class="p">..</span><span class="n">typeAssert0</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">typeAssert</span>
    <span class="n">mov</span>     <span class="n">rbx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">jmp</span>     <span class="n">done</span>
<span class="n">found</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rcx</span> <span class="o">+</span> <span class="n">rsi</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
<span class="n">done</span><span class="o">:</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">24</span>
    <span class="n">pop</span>     <span class="n">rpb</span>
    <span class="n">ret</span>
<span class="n">nil</span><span class="o">:</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="n">foo</span><span class="p">.</span><span class="n">MyIface</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">panicnildottype</span>
<span class="n">grow</span><span class="o">:</span>
    <span class="c1">// Same as it was in foo.Call above.</span>
    <span class="n">jmp</span>     <span class="n">foo</span><span class="p">.</span><span class="n">Downcast</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>When we request an interface downcast, the Go compiler synthesizes a symbol of type <code class="language-plaintext highlighter-rouge">abi.TypeAssert</code>. Its definition is reproduced below.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">abi</span>

<span class="k">type</span> <span class="n">TypeAssert</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Cache</span>   <span class="o">*</span><span class="n">TypeAssertCache</span>
	<span class="n">Inter</span>   <span class="o">*</span><span class="n">InterfaceType</span>
	<span class="n">CanFail</span> <span class="kt">bool</span>
<span class="p">}</span>
<span class="k">type</span> <span class="n">TypeAssertCache</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Mask</span>    <span class="kt">uintptr</span>
	<span class="n">Entries</span> <span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="n">TypeAssertCacheEntry</span>
<span class="p">}</span>
<span class="k">type</span> <span class="n">TypeAssertCacheEntry</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// type of source value (a *runtime._type)</span>
	<span class="n">Typ</span> <span class="kt">uintptr</span>
	<span class="c">// itab to use for result (a *runtime.itab)</span>
	<span class="c">// nil if CanFail is set and conversion would fail.</span>
	<span class="n">Itab</span> <span class="kt">uintptr</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>The first thing this function does is check if <code class="language-plaintext highlighter-rouge">rax</code> contains 0, i.e., if this is a nil <code class="language-plaintext highlighter-rouge">any</code>, and panics if that’s the case (that’s a call to <code class="language-plaintext highlighter-rouge">runtime.panicnildottype</code>). It then loads <code class="language-plaintext highlighter-rouge">foo..typeAssert0</code>, a synthetic global variable containing an <code class="language-plaintext highlighter-rouge">abi.TypeAssert</code> value. It loads the <code class="language-plaintext highlighter-rouge">Cache</code> field, as well as the <code class="language-plaintext highlighter-rouge">Hash</code> field of the <code class="language-plaintext highlighter-rouge">abi.Type</code> attached to the <code class="language-plaintext highlighter-rouge">any</code>. It masks off the low bits using <code class="language-plaintext highlighter-rouge">typeAssert0.Cache.Mask</code>, and uses that to start probing the very simple open-addressed hash table located in <code class="language-plaintext highlighter-rouge">typeAssert0.Cache.Entries</code>.</p> <p>If it finds a <code class="language-plaintext highlighter-rouge">TypeAssertCacheEntry</code> with the type we’re looking for (compared by address), we’ve found it. We load that entry’s <code class="language-plaintext highlighter-rouge">Itab</code> value into <code class="language-plaintext highlighter-rouge">rax</code> to change the value from being an <code class="language-plaintext highlighter-rouge">any</code> to being a <code class="language-plaintext highlighter-rouge">MyIface</code>, and we’re done.</p> <p>If it finds a <code class="language-plaintext highlighter-rouge">TypeAssertCacheEntry</code> with a nil <code class="language-plaintext highlighter-rouge">Typ</code> pointer, we’re forced to hit the slow path, implemented at <code class="language-plaintext highlighter-rouge">runtime.typeAssert()</code>. This dynamically builds an itab by searching the method set of the type inside the <code class="language-plaintext highlighter-rouge">any</code>.</p> <p>This then calls the reflection code in <code class="language-plaintext highlighter-rouge">runtime.getitab()</code>, which is what actually performs the messy search through the method set, comparing the names and signatures of methods with those in the interface, to produce an itab at runtime.</p> <p>Then, it shoves this the resulting itab into the global itab cache, which is protected by a global lock! There are lots of scary atomics in this code. There are many places where this can potentially panic, bubbling up a type assertion failure to the user.</p> <p>When <code class="language-plaintext highlighter-rouge">runtime.getitab()</code> returns, <code class="language-plaintext highlighter-rouge">runtime.typeAssert()</code> will <em>maybe</em><sup id="fnref:maybe-update" role="doc-noteref"><a href="#fn:maybe-update" class="footnote" rel="footnote">4</a></sup> update the type assertion cache, and return the new itab. This allows the code in our function to return directly, without needing to take another trip into the <code class="language-plaintext highlighter-rouge">hashProbe</code> loop.</p> <p>In theory, PGO could be used to pre-fill the cache, but I couldn’t find any code in the compiler that indicates that this is something they do. In the meantime, you can optimize a hot type assert ahead of time by asserting to a known common type:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="n">DoSomething</span><span class="p">(</span><span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">rs</span> <span class="n">io</span><span class="o">.</span><span class="n">ReadSeeker</span>
  <span class="k">if</span> <span class="n">f</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">os</span><span class="o">.</span><span class="n">File</span><span class="p">);</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="c">// Check for a known implementation first. This only costs</span>
    <span class="c">// a pointer comparison with the *abi.Type in the itab.</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">f</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">f</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">ReadSeeker</span><span class="p">);</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="c">// Do an interface type assertion. This would eventually</span>
    <span class="c">// learn os.File, but the branch above skips that "warmup"</span>
    <span class="c">// time. It also lets the hardware branch predictor allocate</span>
    <span class="c">// a prediction slot just for os.File.</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">f</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c">// ...</span>
  <span class="p">}</span>
<span class="p">}</span> </code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>Type switches, incidentally, use a very similar caching mechanism for switches that include interface types among the cases.</p> <h3 id="what-was-that-about-indirect-interfaces"><a href="#what-was-that-about-indirect-interfaces">What Was That About Indirect Interfaces?</a></h3> <p>Back when we were hacking arrays into existence with reflection, there was some trouble in <code class="language-plaintext highlighter-rouge">reflect.Value.Interface()</code>, where it would do a seemingly unnecessary copy.</p> <p>This is because an interface’s data pointer must be a pointer. If you cram, say, an <code class="language-plaintext highlighter-rouge">int</code> into an <code class="language-plaintext highlighter-rouge">any</code>, Go will spill it to the heap. This is often called <em>boxing</em>, but the Go runtime refers to it as an “indirect interface”.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">func</span> <span class="n">Int2Any</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="n">any</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Int2Any</span><span class="o">:</span>
  <span class="n">push</span>     <span class="n">rbp</span>
  <span class="n">mov</span>      <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
  <span class="n">add</span>      <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span>
  <span class="n">call</span>     <span class="n">runtime</span><span class="p">.</span><span class="n">convT64</span>
  <span class="n">move</span>     <span class="n">rbx</span><span class="p">,</span> <span class="n">rax</span>
  <span class="n">lea</span>      <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="kt">int</span><span class="p">]</span>
  <span class="n">add</span>      <span class="n">rsp</span><span class="p">,</span> <span class="mi">8</span>
  <span class="n">pop</span>      <span class="n">rbp</span>
  <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>Like many other managed languages, Go will skip boxing very small values by instead returning pointers into some global array.</p> <p>Now, this boxing could be avoided: after all, an <code class="language-plaintext highlighter-rouge">int</code> is no larger than a pointer, so we could cram it into the data pointer field directly. However, the GC <em>really</em> doesn’t like that: the GC assumes it can trace through any pointer. Now, the GC <em>could</em> treat interfaces differently, and look at the type/itab pointer to determine if the data value pointer or a scalar. However, this would add significant complexity to both the representation of shapes, and to the tracing code in the GC, resulting in more branches and slower tracing.</p> <p>However, if the type being wrapped in an interface happens to be a pointer, it can just use that pointer value directly.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">func</span> <span class="n">Int2Any</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="n">any</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Int2Any</span><span class="o">:</span>
  <span class="n">move</span>     <span class="n">rbx</span><span class="p">,</span> <span class="n">rax</span>
  <span class="n">lea</span>      <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">type</span><span class="o">:</span><span class="kt">int</span><span class="p">]</span>
  <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>Any type that has the same shape as a pointer will be indirect. This includes maps, channels, and funcs. It also includes one element arrays of such types, such as <code class="language-plaintext highlighter-rouge">[1]*int</code> and <code class="language-plaintext highlighter-rouge">[1]chan error</code>, and single-field structs of such types. Curiously, this does not include structs which contain a zero-sized field before the pointer-sized field, even though those have the same shape as a pointer.</p> <p>This means it’s generally not safe to play games with forging an interface out of a pointer to some type: whether that type is indirect in an interface is a subtle implementation detail of the compiler.</p> <p>And of course, it’s important to remember that if you want to return a value by interface, you had best hope it can get inlined, so the compiler can promote the heap allocation to the stack.</p> <h2 id="function-pointers"><a href="#function-pointers">Function Pointers</a></h2> <p>The last thing to look at are Go’s function pointers. For the longest time, I assumed they had the same layout as an interface: a pointer to closure data, and a hardware function pointer.</p> <p>It turns out the layout is weirder: let’s revisit the <code class="language-plaintext highlighter-rouge">runtime.funcval</code> we found in <code class="language-plaintext highlighter-rouge">runtime2.go</code> earlier.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">runtime</span>

<span class="k">type</span> <span class="n">funcval</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">fn</span> <span class="kt">uintptr</span>
	<span class="c">// variable-size, fn-specific data here</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>This unusual layout is best understood by looking at the generated assembly.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">func</span> <span class="n">Call</span><span class="p">(</span>
  <span class="n">f</span> <span class="k">func</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span><span class="p">,</span>
  <span class="n">x</span> <span class="kt">int</span><span class="p">,</span>
<span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Call</span><span class="o">:</span>
    <span class="n">cmp</span>     <span class="n">rsp</span><span class="p">,</span> <span class="p">[</span><span class="n">r14</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">jls</span>     <span class="n">grow</span>
    <span class="n">push</span>    <span class="n">rpb</span>
    <span class="n">mov</span>     <span class="n">rpb</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span> <span class="n">rax</span>
    <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">rbx</span>
    <span class="n">call</span>    <span class="n">rcx</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">8</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">grow</span><span class="o">:</span>
    <span class="c1">// Same as before.</span>
    <span class="n">jmp</span>     <span class="n">foo</span><span class="p">.</span><span class="n">Call</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>To call <code class="language-plaintext highlighter-rouge">f</code>, first we interpret it as a <code class="language-plaintext highlighter-rouge">*funcval</code> and load <code class="language-plaintext highlighter-rouge">f.fn</code> into a temporary. That is, the first word pointed to by <code class="language-plaintext highlighter-rouge">rax</code> (which holds <code class="language-plaintext highlighter-rouge">f</code> on function entry). Then, we place <code class="language-plaintext highlighter-rouge">f</code> in <code class="language-plaintext highlighter-rouge">rdx</code>, the closure context register. The reason for using this extra magic register will become clear shorter. Then, we arrange the rest of the arguments in their usual registers, and we jump to the address stored in <code class="language-plaintext highlighter-rouge">f.fn</code>.</p> <p>Inside of <code class="language-plaintext highlighter-rouge">f</code>, captures are accessed by offsetting from <code class="language-plaintext highlighter-rouge">rdx</code>. What does one of those closures look like?</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">func</span> <span class="n">Capture</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="k">func</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">y</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Capture</span><span class="o">:</span>
    <span class="n">cmp</span>     <span class="n">rsp</span><span class="p">,</span> <span class="p">[</span><span class="n">r14</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">jls</span>     <span class="n">grow</span>
    <span class="n">push</span>    <span class="n">rpb</span>
    <span class="n">mov</span>     <span class="n">rpb</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rsp</span><span class="p">],</span> <span class="n">rax</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="s">"type:noalg.struct { F uintptr; X0 int }"</span><span class="p">]</span>
    <span class="n">call</span>    <span class="n">runtime</span><span class="p">.</span><span class="n">newobject</span>
    <span class="n">lea</span>     <span class="n">rcx</span><span class="p">,</span> <span class="n">foo</span><span class="p">.</span><span class="n">Capture</span><span class="p">.</span><span class="n">func1</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span><span class="p">]</span>
    <span class="n">mov</span>     <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="n">rcx</span>
    <span class="n">add</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">16</span>
    <span class="n">pop</span>     <span class="n">rbp</span>
    <span class="n">ret</span>
<span class="n">grow</span><span class="o">:</span>
    <span class="c1">// Same as before.</span>
    <span class="n">jmp</span>     <span class="n">foo</span><span class="p">.</span><span class="n">Capture</span>

<span class="n">foo</span><span class="p">.</span><span class="n">Capture</span><span class="p">.</span><span class="n">func1</span><span class="o">:</span>
    <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">imul</span>    <span class="n">rax</span><span class="p">,</span> <span class="n">rcx</span>
    <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>All <code class="language-plaintext highlighter-rouge">Capture</code> is doing is allocating a <code class="language-plaintext highlighter-rouge">funcval</code> with a single <code class="language-plaintext highlighter-rouge">int</code> capture; that’s the <code class="language-plaintext highlighter-rouge">{ F uintptr; X0 int }</code> in the code above. It then places the address of <code class="language-plaintext highlighter-rouge">Capture.func1</code>, which implements the callback, into <code class="language-plaintext highlighter-rouge">F</code>, and the argument of <code class="language-plaintext highlighter-rouge">Capture</code> into <code class="language-plaintext highlighter-rouge">X0</code>.</p> <p>What about when returning a reference to a function? In that case, all that happens is it returns a reference to a global containing the address of the function.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">foo</span>

<span class="k">func</span> <span class="n">Capture</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="k">func</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Id</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">Id</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">foo</span><span class="p">.</span><span class="n">Capture</span><span class="o">:</span>
    <span class="n">lea</span>     <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">foo</span><span class="p">.</span><span class="n">Id</span><span class="err">·</span><span class="n">f</span><span class="p">]</span>
    <span class="n">ret</span>

<span class="n">foo</span><span class="p">.</span><span class="n">Id</span><span class="o">:</span>
    <span class="n">ret</span>

<span class="n">foo</span><span class="p">.</span><span class="n">Id</span><span class="err">·</span><span class="n">f</span><span class="o">:</span>
    <span class="p">.</span><span class="n">quad</span> <span class="n">foo</span><span class="p">.</span><span class="n">Id</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>Because we pass the closure arguments in an extra register not used by regular functions, we don’t need to create a thunk for this case.</p> <p>Unfortunately, we do need to create a thunk for methods, even methods with a pointer receiver. This is because of the following incompatible constraints:</p> <ol> <li> <p>The receiver pointer for a method must point exactly to the value the method is called on. It can’t be a fixed offset before, because that would create an out-of-bounds pointer, which the GC does not tolerate.</p> </li> <li> <p>The closure pointer must point to the start of the funcval, <em>not</em> its captures, because adjusting the pointer to point to the captures would cause it to point one-past-the-end of a value, which the GC <em>also</em> does not tolerate!</p> </li> </ol> <p>Thus, <em>even</em> if methods accepted a pointer receiver via <code class="language-plaintext highlighter-rouge">rdx</code>, closures and methods disagree about where that pointer should be passed.</p> <p>Of course, there are adjustments we can make to fix this problem. For example, we could require that all <code class="language-plaintext highlighter-rouge">funcval</code> values have at least one capture. No-capture <code class="language-plaintext highlighter-rouge">funcvals</code> would have a synthetic <code class="language-plaintext highlighter-rouge">_ byte</code> field. This is not unlike how a non-empty struct whose final field is empty will be padded with an extra <code class="language-plaintext highlighter-rouge">_ byte</code> field: this is specifically to avoid a pointer to that field being a past-the-end pointer. The cost is that every non-capturing closure costs twice as much binary size.</p> <p>Another fix is to make the GC blind to the pointer in <code class="language-plaintext highlighter-rouge">rdx</code>. This will never be the only pointer by which a value is reachable, so it would be safe to replace <code class="language-plaintext highlighter-rouge">mov rdx, rax</code> with a <code class="language-plaintext highlighter-rouge">lea rdx, [rax + 8]</code>. The GC would never know!</p> <p>Until then, beware that writing <code class="language-plaintext highlighter-rouge">return foo.Method</code> secretly allocates 16 bytes or so. (Aside: I used to sit next to the Go team at Google, and I remember having a conversation with Austin Clements about this. Apparently I misremembered, because until recently I thought Go already implemented this optimization!)</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>If you made it this far this is probably you right now:</p> <figure> <p><img src="https://mcyoung.xyz/public/images/stickers/dizzy.png" alt="Miguel as a Whimsicott, dizzy with register names."/></p> </figure> <p>This isn’t intended to be as polished as most of my articles, but there’s been enough things I’ve come across that I wanted to write this all up for my own reference.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:constants" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge">Sizeof</code> and <code class="language-plaintext highlighter-rouge">Alignof</code> are intrinsics, so the compiler will turn them into constants. However, they are only constants if the type being measured is not generic, so wrapping them in a function like this doesn’t actually hurt in generic code. <a href="#fnref:constants" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:gc-programs" role="doc-endnote"> <p>Except for very large types that would have more words than can be recorded by an array of size <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/internal/abi/type.go;l=803;bpv=0"><code class="language-plaintext highlighter-rouge">abi.MaxPtrmaskBytes</code></a>. For larger types, we use GC programs! A GC program is an LZ-compressed bitset serving the same purpose as the pointer bitset most smaller types use. See <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/cmd/internal/gcprog/gcprog.go">gcprog.go</a>.</p> <p>In fact, <code class="language-plaintext highlighter-rouge">reflection</code> knows how to create programs on the fly for most types! See <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/reflect/type.go;l=2658">reflect/type.go</a>. <a href="#fnref:gc-programs" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:asm" role="doc-endnote"> <p>I will be writing assembly examples in Intel-syntax x86. Go’s assembly syntax is horrible and an impediment to the point I’m making. <a href="#fnref:asm" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:maybe-update" role="doc-endnote"> <p>Maybe? Well, the cache will only get updated about 0.1% of the time. This is to amortize the costs of growing the cache. I assume they benchmarked this, and found that the cost of growing the cache makes it only worthwhile when that assertion is getting hammered. <a href="#fnref:maybe-update" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="dark-arts"/><category term="assembly"/><category term="go"/><summary type="html"><![CDATA[Lately I’ve been finding myself writing a bit of Go, and I’ve picked up various fun “layout secrets” that help inform how I write code to minimize hidden allocations, and generally be kind to the optimizer. This article is a series of notes on the topic.]]></summary></entry><entry><title type="html">Nobody Gets Fired for Picking JSON, but Maybe They Should?</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2024/12/10/json-sucks/" rel="alternate" type="text/html" title="Nobody Gets Fired for Picking JSON, but Maybe They Should?"/><published>2024-12-10T00:00:00-08:00</published><updated>2024-12-10T00:00:00-08:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2024/12/10/json-sucks</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2024/12/10/json-sucks/"><![CDATA[<p>JSON is extremely popular but deeply flawed. This article discusses the details of JSON’s design, how it’s used (and misused), and how seemingly helpful “human readability” features cause headaches instead. Crucially, you rarely find JSON-based tools (except dedicated tools like <code class="language-plaintext highlighter-rouge">jq</code>) that can safely handle arbitrary JSON documents without a schema—common corner cases can lead to data corruption!</p> <h2 id="what-is-json"><a href="#what-is-json">What is JSON?</a></h2> <p>JSON is famously simple. In fact, you can <a href="https://www.flickr.com/photos/equanimity/3763158824/in/photostream/">fit the entire grammar on the back of a business card</a>. It’s so omnipresent in REST APIs that you might assume you already know JSON quite well. It has decimal numbers, quoted strings, arrays with square brackets, and key-value maps (called “objects”) with curly braces. A JSON document consists of any of these constructs: <code class="language-plaintext highlighter-rouge">null</code>, <code class="language-plaintext highlighter-rouge">42</code>, and <code class="language-plaintext highlighter-rouge">{"foo":"bar"}</code> are all valid JSON documents.</p> <p>However, the formal definition of JSON is quite complicated. JSON is defined by the IETF document <a href="https://datatracker.ietf.org/doc/html/rfc8259">RFC8259</a> (if you don’t know what the IETF is, it’s the standards body for Internet protocols). However, it’s <em>also</em> normatively defined by <a href="https://ecma-international.org/publications-and-standards/standards/ecma-404/">ECMA-404</a>, which is from ECMA, the standards body that defines JavaScript[^json.org].</p> <p>[^json.org]: Of course, some wise guy will probably want to cite <json.org>. I should underscore: <json.org> is __NOT__ a standard. It is __NOT__ normative. the documents produced by the IETF and by ECMA, which are international standards organizations that represent the industry __ARE__ normative. When a browser implementer wants to implement JSON to the letter, they go to ECMA, not to some dude's 90's ass website.</json.org></json.org></p> <p>JavaScript? Yes, JSON (JavaScript Object Notation) is closely linked with JavaScript and is, in fact, (almost) a subset of it. While JSON’s JavaScript ancestry is the main source of its quirks, several other poor design decisions add additional unforced errors.</p> <p>However, the biggest problem with JSON isn’t any specific design decision but rather the incredible diversity of parser behavior and non-conformance across and within language ecosystems. RFC8259 goes out of its way to call this out:</p> <blockquote> <p>Note, however, that ECMA-404 allows several practices that this specification recommends avoiding in the interests of maximal interoperability.</p> </blockquote> <p>The RFC makes many observations regarding interoperability elsewhere in the document. Probably the most glaring—and terrifying—is how numbers work.</p> <h2 id="everything-is-implementation-defined"><a href="#everything-is-implementation-defined">Everything is Implementation-Defined</a></h2> <p>JSON numbers are encoded in decimal, with an optional minus sign, a fractional part after a decimal point, and a scientific notation exponent. This is similar to how many programming languages define their own numeric literals.</p> <p>Presumably, JSON numbers are meant to be floats, right?</p> <p>Wrong.</p> <p>RFC8259 reveals that the answer is, unfortunately, “whatever you want.”</p> <blockquote> <p>This specification allows implementations to set limits on the range and precision of numbers accepted. Since software that implements IEEE 754 binary64 (double precision) numbers is generally available and widely used, good interoperability can be achieved by implementations that expect no more precision or range than these provide, in the sense that implementations will approximate JSON numbers within the expected precision.</p> </blockquote> <p><code class="language-plaintext highlighter-rouge">binary64</code> is the “standards-ese” name for the type usually known as <code class="language-plaintext highlighter-rouge">double</code> or <code class="language-plaintext highlighter-rouge">float64</code>. Floats have great dynamic range but often can’t represent exact values. For example, <code class="language-plaintext highlighter-rouge">1.1</code> isn’t representable as a float because all floats are fractions of the form <code class="language-plaintext highlighter-rouge">n / 2^m</code> for integers <code class="language-plaintext highlighter-rouge">n</code> and <code class="language-plaintext highlighter-rouge">m</code>, but <code class="language-plaintext highlighter-rouge">1.1 = 11/10</code>, which has a factor of 5 in its denominator. The closest <code class="language-plaintext highlighter-rouge">float64</code> value is</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-text" data-lang="text">2476979795053773 / 2^51 = 1.100000000000000088817841970012523233890533447265625</code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Plaintext</div></div></div> <p>Of course, you might think to declare “all JSON values map to their closest <code class="language-plaintext highlighter-rouge">float64</code> value”. Unfortunately, this value might not be unique. For example, the value <code class="language-plaintext highlighter-rouge">900000000000.00006103515625</code> isn’t representable as a <code class="language-plaintext highlighter-rouge">float64</code>, and it’s precisely between two exact <code class="language-plaintext highlighter-rouge">float64</code> values. Depending on the rounding mode, this rounds to either or <code class="language-plaintext highlighter-rouge">900000000000</code> or <code class="language-plaintext highlighter-rouge">900000000000.0001220703125</code> .</p> <p>IEEE 754 recommends “round ties to even” as the default rounding mode, so for almost all software, the result is <code class="language-plaintext highlighter-rouge">900000000000</code>. But remember, floating-point state is a global variable implemented in hardware, and might just happen to be clobbered by some dependency that calls <code class="language-plaintext highlighter-rouge">fesetround()</code> or a similar system function.</p> <h2 id="data-loss-data-loss"><a href="#data-loss-data-loss">Data Loss! Data Loss!</a></h2> <p>You’re probably thinking, “I don’t care about such fussy precision stuff. None of my numbers have any fractional parts—and there is where you would be wrong. The <code class="language-plaintext highlighter-rouge">n</code> part of <code class="language-plaintext highlighter-rouge">n / 2^m</code> only has 53 bits available, but <code class="language-plaintext highlighter-rouge">int64</code> values fall outside of that range. This means that for very large 64-bit integers, such as randomly generated IDs, a JSON parser that converts integers into floats results in <em>data loss.</em> Go’s <code class="language-plaintext highlighter-rouge">encoding/json</code> package does this, for example.</p> <p>How often does this actually happen for randomly-generated numbers? We can do a little Monte Carlo simulation to find out.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"math"</span>
	<span class="s">"math/big"</span>
	<span class="s">"math/rand"</span>
<span class="p">)</span>

<span class="k">const</span> <span class="n">trials</span> <span class="o">=</span> <span class="m">5</span><span class="n">_000_000</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">misses</span> <span class="kt">int</span>
	<span class="k">var</span> <span class="n">err</span> <span class="n">big</span><span class="o">.</span><span class="n">Float</span>
	<span class="k">for</span> <span class="k">range</span> <span class="n">trials</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">:=</span> <span class="kt">int64</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Uint64</span><span class="p">())</span>
		<span class="n">y</span> <span class="o">:=</span> <span class="kt">int64</span><span class="p">(</span><span class="kt">float64</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c">// Round-trip through binary64.</span>
		<span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="p">{</span>
			<span class="n">misses</span><span class="o">++</span>
			<span class="n">err</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="n">big</span><span class="o">.</span><span class="n">NewFloat</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="kt">float64</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">))))</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span><span class="o">.</span><span class="n">Quo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="n">big</span><span class="o">.</span><span class="n">NewFloat</span><span class="p">(</span><span class="n">trials</span><span class="p">))</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"misses: %d/%d, avg: %f"</span><span class="p">,</span> <span class="n">misses</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output:</span>
<span class="c">// misses: 4970572/5000000, avg: 170.638499</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>It turns out that almost all randomly distributed <code class="language-plaintext highlighter-rouge">int64</code> values are affected by round-trip data loss. Roughly, the only numbers that are safe are those with at most 16 digits (although not exactly: 9,999,999,999,999,999, for example, gets rounded up to a nice round 10 quadrillion).</p> <p>How does this affect you? Suppose you have a JSON document somewhere that includes a user ID and a transcript of their private messages with another user. Data loss due to rounding would result in the wrong user ID being associated with the private messages, which could result in leaking PII or incorrect management of privacy consent (such as GDPR requirements).</p> <p>This isn’t just about <em>your</em> user IDs, mind you. Plenty of other vendors’ IDs are nice big integers, which the JSON grammar can technically accommodate and which random tools will mangle. Some examples:</p> <ul> <li> <p>License keys: for example, Adobe uses 24 digits for <a href="https://helpx.adobe.com/x-productkb/global/invalid-revoked-serial-numbers.html">their serial numbers</a>, which may be tempting to store as an integer.</p> </li> <li> <p>Barcode IDs like the unique serial numbers of medical devices, <a href="https://www.fda.gov/medical-devices/unique-device-identification-system-udi-system/udi-basics">which are tightly regulated</a>.</p> </li> <li> <p>Visa and Mastercard credit card numbers <em>happen</em> to fit in the “safe” range for <code class="language-plaintext highlighter-rouge">binary64</code> , which may lull you into a false sense of security, since they’re so common. But not all credit cards have 16 digit numbers: <a href="https://en.wikipedia.org/wiki/Payment_card_number#Structure">some now support 19</a>.</p> </li> </ul> <p>These are pretty bad compliance consequences purely due to a data serialization format.</p> <p>This problem is avoidable with care. After all, Go can parse JSON into any arbitrary type using reflection. For example, if we replace the inner loop of the Monte Carlo simulation with something like the following:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">for</span> <span class="k">range</span> <span class="n">trials</span> <span class="p">{</span>
	<span class="n">x</span> <span class="o">:=</span> <span class="kt">int64</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Uint64</span><span class="p">())</span>
	<span class="k">var</span> <span class="n">v</span> <span class="k">struct</span><span class="p">{</span> <span class="n">N</span> <span class="kt">int64</span> <span class="p">}</span>
	<span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">`{"N":%d}`</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="n">N</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="p">{</span>
		<span class="c">// ...</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Go</div></div></div> <p>We suddenly see that <code class="language-plaintext highlighter-rouge">x == y</code> in every trial. This is because with type information, Go’s JSON library knows exactly what the target precision is. If we were parsing to an <code class="language-plaintext highlighter-rouge">any</code> instead of to a <code class="language-plaintext highlighter-rouge">struct { N int64 }</code>, we’d be in deep trouble: the outer object would be parsed into a <code class="language-plaintext highlighter-rouge">map[string]any</code>, and the <code class="language-plaintext highlighter-rouge">N</code> field would become a <code class="language-plaintext highlighter-rouge">float64</code>.</p> <p>This means that your system probably can’t safely handle JSON documents with unknown fields. Tools like <code class="language-plaintext highlighter-rouge">jq</code> must be extremely careful about number handling to avoid data loss. This is an easy mistake for third-party tools to make.</p> <p>But again, <code class="language-plaintext highlighter-rouge">float64</code> isn’t the standard—there is no standard. Some implementations might only have 32-bit floats available, making the problem worse. Some implementations might try to be clever, using a <code class="language-plaintext highlighter-rouge">float64</code> for fractional values and an <code class="language-plaintext highlighter-rouge">int64</code> for integer values; however, this still imposes arbitrary limits on the parsed values, potentially resulting in data loss.</p> <p>Some implementations such as Python use bignums, so they appear not to have this problem. However, this can lead to a false sense of security where issues are not caught until it’s too late: some database now contains ostensibly valid but non-interoperable JSON.</p> <p>Protobuf is forced to deal with this in a pretty non-portable way. To avoid data loss, large 64-bit integers are serialized as quoted strings when serializing to JSON. So, instead of writing <code class="language-plaintext highlighter-rouge">{"foo":6574404881820635023}</code>, it emits <code class="language-plaintext highlighter-rouge">{"foo":"6574404881820635023"}</code>. This solves the data loss issue but does not work with other JSON libraries such as Go’s, producing errors like this one:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-text" data-lang="text">json: cannot unmarshal string into Go struct field .N of type int64</code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Plaintext</div></div></div> <h3 id="non-finite-values"><a href="#non-finite-values">Non-Finite Values</a></h3> <p>The special floating point values <code class="language-plaintext highlighter-rouge">Infinity</code>, <code class="language-plaintext highlighter-rouge">-Infinity</code>, and <code class="language-plaintext highlighter-rouge">NaN</code> are not representable: it’s the wild west as to what happens when you try to serialize the equivalent of <code class="language-plaintext highlighter-rouge">{x:1.0/0.0}</code>.</p> <ul> <li>Go refuses to serialize, citing <code class="language-plaintext highlighter-rouge">json: unsupported value: +Inf</code>.</li> <li>Protobuf serializes it as <code class="language-plaintext highlighter-rouge">{"x":"inf"}</code> (or should—it’s unclear which implementations get it right).</li> <li>JavaScript won’t even bother trying: <code class="language-plaintext highlighter-rouge">JSON.stringify({x:Infinity})</code> prints <code class="language-plaintext highlighter-rouge">{"x":null}.</code></li> <li>Python is arguably the worst offender: <code class="language-plaintext highlighter-rouge">json.dumps({"x":float("inf")})</code> prints <code class="language-plaintext highlighter-rouge">{"x":Infinity}</code>, which isn’t even valid JSON per RFC8259.</li> </ul> <p>NaN is arguably an even worse offender, because the NaN payload (yes, <a href="https://doc.rust-lang.org/std/primitive.f32.html#nan-bit-patterns">NaNs have a special payload</a>) is discarded when converting to <code class="language-plaintext highlighter-rouge">"nan"</code> or however your library represents it.</p> <p>Does this affect you? Well, if you’re doing anything with floats, you’re one division-by-zero or overflow away from triggering serialization errors. At best, it’s “benign” data corruption (JavaScript). At worst, when the data is partially user-controlled, it might result in crashes or unparseable output, which is the making of a DoS vector.</p> <p>In comparison, Protobuf serialization can’t fail except due to non-UTF-8 <code class="language-plaintext highlighter-rouge">string</code> fields or cyclic message references, both of which are comparatively unlikely to a NaN popping up in a calculation.</p> <p>The upshot is that all the parsers end up parsing a bunch of crazy things for the special floating-point values over time because of <a href="https://en.wikipedia.org/wiki/Robustness_principle">Postel’s law</a>. RFC8259 makes no effort to provide suggestions for dealing with such real-world situations beyond “tough luck, not interoperable.”</p> <h2 id="text-encodings-and-invalid-unicode"><a href="#text-encodings-and-invalid-unicode">Text Encodings and Invalid Unicode</a></h2> <p>JSON strings are relatively tame, with some marked (but good) divergence from JavaScript. Specifically, JavaScript, being a language of a certain age (along with Java), uses UTF-16 as its Unicode text encoding. Most of the world has realized this is a bad idea (it doubles the size of ASCII text, which makes up almost all of Internet traffic), so JSON uses UTF-8 instead. RFC8259 actually specifies that the whole document MUST be encoded in UTF-8.</p> <p>But when we go to read about Unicode characters in §8.2, we are disappointed: it merely says that it’s <em>really great</em> when all quoted strings consist entirely of Unicode characters, which means that unpaired surrogates are allowed. In effect, the spec merely requires that JSON strings be <a href="https://en.wikipedia.org/wiki/UTF-8#Surrogates">WTF-8</a>: UTF-8 that permits unpaired surrogates.</p> <p>What’s an unpaired surrogate? It’s any encoded Unicode 32-bit value in the range <code class="language-plaintext highlighter-rouge">U+D800</code> to <code class="language-plaintext highlighter-rouge">U+DFFF</code> , which form a gap in the Unicode codepoint range. UTF-8’s variable-length integer encoding can encode them, but their presence in a bytestream makes it invalid UTF-8. WTF-8 is UTF-8 but permitting the appearance of these values.</p> <p>So, who actually supports parsing (or serializing) these? Consider the document <code class="language-plaintext highlighter-rouge">{"x":"\udead"}</code>, which contains an unpaired surrogate, <code class="language-plaintext highlighter-rouge">U+DEAD</code>.</p> <ul> <li> <p>Go gladly deserializes AND serializes it (Go’s strings are arbitrary byte strings, not UTF-8). However, Go serializes a non-UTF-8 string such as <code class="language-plaintext highlighter-rouge">"\xff"</code> as <code class="language-plaintext highlighter-rouge">"\ufffd"</code>, having replaced the invalid byte with a <code class="language-plaintext highlighter-rouge">U+FFFD</code> replacement character (this thing: �).</p> </li> <li> <p>Most Java parsers seem to follow the same behavior as Go, but there are many different parsers available, and we’ve already learned that different JSON parsers may behave differently.</p> </li> <li> <p>JavaScript and Python similarly gladly parse unpaired surrogates, but they also serialize them back without converting them into <code class="language-plaintext highlighter-rouge">U+FFFD</code>.</p> </li> <li> <p>Different Protobuf runtimes may not handle this identically, but the reference C++ implementation (whose JSON codec I wrote!) refuses to parse unpaired surrogates.</p> </li> </ul> <p>There are other surprising pitfalls around strings: are <code class="language-plaintext highlighter-rouge">"x"</code> and <code class="language-plaintext highlighter-rouge">“\x78"</code> the same string? RFC8259 feels the need to call out that they are, for the purposes of checking that object keys are equal. The fact that they feel the need to call it out indicates that this is also a source of potential problems.</p> <h2 id="byte-strings"><a href="#byte-strings">Byte Strings</a></h2> <p>What if I don’t want to send text? A common type of byte blob to send is a cryptographic hash that identifies a document in a content-addressed blobstore, or perhaps a digital signature (an encrypted hash). JSON has no native way of representing byte strings.</p> <p>You could send a quoted string full of ASCII and <code class="language-plaintext highlighter-rouge">\xNN</code> escapes (for bytes which are not in the ASCII range), but this is wasteful in terms of bandwidth, and has serious interoperability problems (as noted above, Go actively destroys data in this case). You could also encode it as an array of JSON numbers, which is much worse for bandwidth and serialization speed.</p> <p>What everyone winds up doing, one way or another, is to rely on base64 encoding. Protobuf, for example, encodes <code class="language-plaintext highlighter-rouge">bytes</code> fields into base64 strings in JSON. This has the unfortunate side-effect of defeating JSON’s human-readable property: if the blob contains mostly ASCII, a human reader can’t tell.</p> <p>Because this isn’t part of JSON, virtually no JSON codec does this decoding for you, particularly because in a schema-less context, there’s nothing to distinguish a byte blob encoded with base64 from an actual textual string that <em>happens</em> to contain valid base64, such as an alphanumeric username.</p> <p>Compared to other problems, this is more like a paper cut, but it’s unnecessary and adds complexity and interop problems. <a href="https://en.wikipedia.org/wiki/Base64#Variants_summary_table">By the way, did you know there are multiple incompatible Base64 alphabets?</a></p> <h1 id="streaming-doesnt-work"><a href="#streaming-doesnt-work">Streaming Doesn’t Work</a></h1> <p>A less obvious problem with JSON is that it can’t be streamed. Almost all JSON documents are objects or arrays and are therefore <em>incomplete</em> until they reach the closing <code class="language-plaintext highlighter-rouge">}</code> or <code class="language-plaintext highlighter-rouge">]</code>, respectively. This means you can’t send a stream of JSON documents that form a part of a larger document without some additional protocol for combining them in post-processing.</p> <p><a href="https://jsonlines.org/">JSONL</a> is the world’s silliest spec that “solves” this problem in the simplest way possible: a JSONL document is a sequence of JSON documents separated by newlines. JSONL <em>is</em> streamable, but because it’s done in the simplest way possible, it only supports streaming a giant array. You can’t, for example, stream an object field-by-field or stream an array within that object.</p> <p>Protobuf doesn’t have this problem: in a nutshell, the Protobuf wire format is as if we removed the braces and brackets from the top-level array or object of a document, and made it so that values with the same key get merged. In the wire format, the equivalent of the JSONL document</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="nl">"bar"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]}</span><span class="w">
</span><span class="p">{</span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"y"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="nl">"bar"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">]}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>is automatically “merged” into the single document</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"y"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"bar"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>This forms the basis of the “message merge” operation, which is intimately connected to how the wire format was designed. We’ll dive into this fundamental operation in a future article.</p> <h1 id="canonicalization-leads-to-data-loss"><a href="#canonicalization-leads-to-data-loss">Canonicalization Leads to Data Loss</a></h1> <p>Thanks to <a href="https://datatracker.ietf.org/doc/html/rfc7519">RFC7519</a> and <a href="https://datatracker.ietf.org/doc/html/rfc7515">RFC7515</a>, which define JSON Web Tokens (JWT) and JSON Web Signatures (JWS), digitally signing JSON documents is a very common operation. However, digital signatures can only sign specific byte blobs and are sensitive to things that JSON isn’t, such as whitespace and key ordering.</p> <p>This results in specifications like <a href="https://datatracker.ietf.org/doc/html/rfc8785">RFC8785</a> for <em>canonicalization</em> of JSON documents. This introduces a new avenue by which existing JSON documents, which accidentally happen to contain non-interoperable (or, thanks to non-conforming implementations such as Python’s) invalid JSON that must be manipulated and reformatted by third-party tools. RFC8785 itself references ECMA-262 (the JavaScript standard) for how to serialize numbers, meaning that it’s <em>required</em> to induce data loss for 64-bit numerical values!</p> <h1 id="is-json-fixable"><a href="#is-json-fixable">Is JSON Fixable?</a></h1> <p>Plainly? No. JSON can’t be fixed because of how extremely popular it is. Common mistakes are baked into the format. Are comments allowed? Trailing commas? Number formats? Nobody knows!</p> <p>What tools are touching your JSON? Are they aware of all of the rakes they can step on? Do they emit invalid JSON (like Python does)? How do you even begin to audit that?</p> <p>Thankfully, you don’t have to use JSON. There are alternatives—BSON, UBJSON, MessagePack, and CBOR are just a few binary formats that try to replicate JSON’s data model. Unfortunately, many of them have their own problems.</p> <p>Protobuf, however, has none of these problems, because it was <em>designed</em> to fulfill needs JSON couldn’t meet. Using a strongly-typed schema system, like Protobuf, makes all of these problems go away.</p>]]></content><author><name>Miguel Young de la Sota</name></author><category term="parsing"/><category term="formats"/><summary type="html"><![CDATA[JSON is extremely popular but deeply flawed. This article discusses the details of JSON’s design, how it’s used (and misused), and how seemingly helpful “human readability” features cause headaches instead. Crucially, you rarely find JSON-based tools (except dedicated tools like jq) that can safely handle arbitrary JSON documents without a schema—common corner cases can lead to data corruption!]]></summary></entry><entry><title type="html">The Rust Calling Convention We Deserve</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2024/04/17/calling-convention/" rel="alternate" type="text/html" title="The Rust Calling Convention We Deserve"/><published>2024-04-17T00:00:00-07:00</published><updated>2024-04-17T00:00:00-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2024/04/17/calling-convention</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2024/04/17/calling-convention/"><![CDATA[<p>I will often say that the so-called “C ABI” is a very bad one, and a relatively unimaginative one when it comes to passing complicated types effectively. A lot of people ask me “ok, what would you use instead”, and I just point them to the <a href="https://go.googlesource.com/go/+/refs/heads/dev.regabi/src/cmd/compile/internal-abi.md">Go register ABI</a>, but it seems most people have trouble filling in the gaps of what I mean. This article explains what I mean in detail.</p> <p>I have discussed <a href="https://mcyoung.xyz//2021/11/09/assembly-1/#the-calling-convention">calling conventions</a> in the past, but as a reminder: the <em>calling convention</em> is the part of the ABI that concerns itself with how to pass arguments to and from a function, and how to actually call a function. This includes which registers arguments go in, which registers values are returned out of, what function prologues/epilogues look like, how unwinding works, etc.</p> <p>This particular post is primarily about x86, but I intend to be reasonably generic (so that what I’ve written applies just as well to ARM, RISC-V, etc). I will assume a general familiarity with x86 assembly, LLVM IR, and Rust (but not rustc’s internals).</p> <h2 id="the-problem"><a href="#the-problem">The Problem</a></h2> <p>Today, like many other natively compiled languages, Rust defines an unspecified0- calling convention that lets it call functions however it likes. In practice, Rust lowers to LLVM’s built-in C calling convention, which LLVM’s prologue/epilogue codegen generates calls for.</p> <p>Rust is fairly conservative: it tries to generate LLVM function signatures that Clang could have plausibly generated. This has two significant benefits:</p> <ol> <li> <p>Good probability debuggers won’t choke on it. This is not a concern on Linux, though, because DWARF is very general and does not bake-in the Linux C ABI. We will concern ourselves only with ELF-based systems and assume that debuggability is a nonissue.</p> </li> <li> <p>It is less likely to tickle LLVM bugs due to using ABI codegen that Clang does not exercise. I think that if Rust tickles LLVM bugs, we should actually fix them (a very small number of rustc contributors do in fact do this).</p> </li> </ol> <p>However, we are too conservative. We get terrible codegen for simple functions:</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">extract</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="p">[</span><span class="nb">i32</span><span class="p">;</span> <span class="mi">3</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
  <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="nl">extract:</span>
  <span class="n">mov</span>   <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
  <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p><code class="language-plaintext highlighter-rouge">arr</code> is 12 bytes wide, so you’d think it would be passed in registers, but no! It is passed by pointer! Rust is actually <em>more</em> conservative than what the Linux C ABI mandates, because it actually passes the <code class="language-plaintext highlighter-rouge">[i32; 3]</code> in registers when <code class="language-plaintext highlighter-rouge">extern "C"</code> is requested.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">extract</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="p">[</span><span class="nb">i32</span><span class="p">;</span> <span class="mi">3</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
  <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="nl">extract:</span>
  <span class="n">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="n">rdi</span>
  <span class="n">shr</span>   <span class="n">rax</span><span class="p">,</span> <span class="mi">32</span>
  <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>The array is passed in <code class="language-plaintext highlighter-rouge">rdi</code> and <code class="language-plaintext highlighter-rouge">rsi</code>, with the <code class="language-plaintext highlighter-rouge">i32</code>s packed into registers. The function moves <code class="language-plaintext highlighter-rouge">rdi</code> into <code class="language-plaintext highlighter-rouge">rax</code>, the output register, and shifts the upper half down.</p> <p>Not only does clang produce patently <em>bad</em> code for passing things by value, but it also knows how to do it better, if you request a standard calling convention! We could be generating <em>way</em> better code than Clang, but we don’t!</p> <p>Hereforth, I will describe how to do it.</p> <h3 id="-zcallconv"><a href="#-zcallconv"><code class="language-plaintext highlighter-rouge">-Zcallconv</code></a></h3> <p>Let’s suppose that we keep the current calling convention for <code class="language-plaintext highlighter-rouge">extern "Rust"</code><sup id="fnref:just-use-extern-c" role="doc-noteref"><a href="#fn:just-use-extern-c" class="footnote" rel="footnote">1</a></sup>, but we add a flag <code class="language-plaintext highlighter-rouge">-Zcallconv</code> that sets the calling convention for <code class="language-plaintext highlighter-rouge">extern "Rust"</code> when compiling a crate. The supported values will be <code class="language-plaintext highlighter-rouge">-Zcallconv=legacy</code> for the current one, and <code class="language-plaintext highlighter-rouge">-Zcallconv=fast</code> for the one we’re going to design. We could even let <code class="language-plaintext highlighter-rouge">-O</code> set <code class="language-plaintext highlighter-rouge">-Zcallconv=fast</code> automatically.</p> <p>Why keep the old calling convention? Although I did sweep debugability under the rug, one nice property <code class="language-plaintext highlighter-rouge">-Zcallconv=fast</code> will not have is that it does not place arguments in the C ABI order, which means that a reader replying on the “Diana’s silk dress cost $89” mnemonic on x86 will get fairly confused.</p> <p>I am also assuming we may not even support <code class="language-plaintext highlighter-rouge">-Zcallconv=fast</code> for some targets, like WASM, where there is no concept of “registers” and “spilling”. It may not even make sense to enable it for for debug builds, because it will produce much worse code with optimizations turned off.</p> <p>There is also a mild wrinkle with function pointers, and <code class="language-plaintext highlighter-rouge">extern "Rust" {}</code> blocks. Because this flag is per-crate, even though functions can advertise which version of <code class="language-plaintext highlighter-rouge">extern "Rust"</code> they use, function pointers have no such luxury. However, calling through a function pointer is slow and rare, so we can simply force them to use <code class="language-plaintext highlighter-rouge">-Zcallconv=legacy</code>. We can generate a shim to translate calling conventions as needed.</p> <p>Similarly, we can, in principle, call any Rust function like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">secret_call</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
  <span class="k">extern</span> <span class="s">"Rust"</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">my_func</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">unsafe</span> <span class="p">{</span> <span class="nf">my_func</span><span class="p">()</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>However, this mechanism can only be used to call unmangled symbols. Thus, we can simply force <code class="language-plaintext highlighter-rouge">#[no_mangle]</code> symbols to use the legacy calling convention.</p> <h2 id="bending-llvm-to-our-will"><a href="#bending-llvm-to-our-will">Bending LLVM to Our Will</a></h2> <p>In an ideal world, LLVM would provide a way for us to specify the calling convention directly. E.g., this argument goes in that register, this return goes in that one, etc. Unfortunately, adding a calling convention to LLVM requires writing a bunch of C++.</p> <p>However, we can get away with specifying our own calling convention by following the following procedure.</p> <ol> <li> <p>First, determine, for a given target triple, the maximum number of values that can be passed “by register”. I will explain how to do this below.</p> </li> <li> <p>Decide how to pass the return value. It will either fit in the output registers, or it will need to be returned “by reference”, in which case we pass an extra <code class="language-plaintext highlighter-rouge">ptr</code> argument to the function (tagged with the <code class="language-plaintext highlighter-rouge">sret</code> attribute) and the actual return value of the function is that pointer.</p> </li> <li> <p>Decide which arguments that have been passed by value need to be demoted to being passed by reference. This will be a heuristic, but generally will be approximately “arguments larger than the by-register space”. For example, on x86, this comes out to 176 bytes.</p> </li> <li> <p>Decide which arguments get passed by register, so as to maximize register space usage. This problem is NP-hard (it’s the knapsack problem) so it will require a heuristic. All other arguments are passed on the stack.</p> </li> <li> <p>Generate the function signature in LLVM IR. This will be all of the arguments that are passed by register encoded as various non-aggregates, such as <code class="language-plaintext highlighter-rouge">i64</code>, <code class="language-plaintext highlighter-rouge">ptr</code>, <code class="language-plaintext highlighter-rouge">double</code>, and <code class="language-plaintext highlighter-rouge">&lt;2 x i64&gt;</code>. What valid choices are for said non-aggregates depends on the target, but the above are what you will generally get on a 64-bit architecture. Arguments passed on the stack will follow the “register inputs”.</p> </li> <li> <p>Generate a function prologue. This is code to decode each Rust-level argument from the register inputs, so that there are <code class="language-plaintext highlighter-rouge">%ssa</code> values corresponding to those that would be present when using <code class="language-plaintext highlighter-rouge">-Zcallconv=legacy</code>. This allows us to generate the same code for the body of the function regardless of calling convention. Redundant decoding code will be eliminated by DCE passes.</p> </li> <li> <p>Generate a function exit block. This is a block that contains a single <code class="language-plaintext highlighter-rouge">phi</code> instruction for the return type as it would be for <code class="language-plaintext highlighter-rouge">-Zcallconv=legacy</code>. This block will encode it into the requisite output format and then <code class="language-plaintext highlighter-rouge">ret</code> as appropriate. All exit paths through the function should <code class="language-plaintext highlighter-rouge">br</code> to this block instead of <code class="language-plaintext highlighter-rouge">ret</code>-ing.</p> </li> <li> <p>If a non-polymorphic, non-inline function may have its address taken (as a function pointer), either because it is exported out of the crate or the crate takes a function pointer to it, generate a shim that uses <code class="language-plaintext highlighter-rouge">-Zcallconv=legacy</code> and immediately tail-calls the real implementation. This is necessary to preserve function pointer equality.</p> </li> </ol> <p>The main upshot here is that we need to cook up heuristics for figuring out what goes in registers (since we allow reordering arguments to get better throughput). This is equivalent to the knapsack problem; knapsack heuristics are beyond the scope of this article. This should happen early enough that this information can be stuffed into <code class="language-plaintext highlighter-rouge">rmeta</code> to avoid needing to recompute it. We may want to use different, faster heuristics depending on <code class="language-plaintext highlighter-rouge">-Copt-level</code>. Note that correctness requires that we forbid linking code generated by multiple different Rust compilers, which is already the case, since Rust breaks ABI from release to release.</p> <h3 id="what-is-llvm-willing-to-do"><a href="#what-is-llvm-willing-to-do">What Is LLVM Willing to Do?</a></h3> <p>Assuming we do that, how do we actually get LLVM to pass things in the way we want it to? We need to determine what the largest “by register” passing LLVM will permit is. The following LLVM program is useful for determining this on a particular version of LLVM:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="nv">%InputI</span> <span class="p">=</span> <span class="k">type</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">]</span>
<span class="nv">%InputF</span> <span class="p">=</span> <span class="k">type</span> <span class="p">[</span><span class="m">0</span> <span class="p">x</span> <span class="kt">double</span><span class="p">]</span>
<span class="nv">%InputV</span> <span class="p">=</span> <span class="k">type</span> <span class="p">[</span><span class="m">8</span> <span class="p">x</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;]</span>

<span class="nv">%OutputI</span> <span class="p">=</span> <span class="k">type</span> <span class="p">[</span><span class="m">3</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">]</span>
<span class="nv">%OutputF</span> <span class="p">=</span> <span class="k">type</span> <span class="p">[</span><span class="m">0</span> <span class="p">x</span> <span class="kt">double</span><span class="p">]</span>
<span class="nv">%OutputV</span> <span class="p">=</span> <span class="k">type</span> <span class="p">[</span><span class="m">4</span> <span class="p">x</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;]</span>

<span class="k">define</span> <span class="kt">void</span> <span class="vg">@inputs</span><span class="p">({</span> <span class="nv">%InputI</span><span class="p">,</span> <span class="nv">%InputF</span><span class="p">,</span> <span class="nv">%InputV</span> <span class="p">})</span> <span class="p">{</span>
  <span class="nv">%p</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">[</span><span class="m">4096</span> <span class="p">x</span> <span class="kt">i8</span><span class="p">]</span>
  <span class="k">store</span> <span class="k">volatile</span> <span class="p">{</span> <span class="nv">%InputI</span><span class="p">,</span> <span class="nv">%InputF</span><span class="p">,</span> <span class="nv">%InputV</span> <span class="p">}</span> <span class="nv">%0</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%p</span>
  <span class="k">ret</span> <span class="kt">void</span>
<span class="p">}</span>

<span class="nv">%Output</span> <span class="p">=</span> <span class="p">{</span> <span class="nv">%OutputI</span><span class="p">,</span> <span class="nv">%OutputF</span><span class="p">,</span> <span class="nv">%OutputV</span> <span class="p">}</span>
<span class="vg">@gOutput</span> <span class="p">=</span> <span class="k">constant</span> <span class="nv">%Output</span> <span class="k">zeroinitializer</span>
<span class="k">define</span> <span class="nv">%Output</span> <span class="vg">@outputs</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">%1</span> <span class="p">=</span> <span class="k">load</span> <span class="nv">%Output</span><span class="p">,</span> <span class="err">ptr</span> <span class="vg">@gOutput</span>
  <span class="k">ret</span> <span class="nv">%Output</span> <span class="nv">%1</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <p>When you pass an aggregate by-value to an LLVM function, LLVM will attempt to “explode” that aggregate into as many registers as possible. There are distinct register classes on different systems. For example, on both x86 and ARM, floats and vectors share the same register class (kind of<sup id="fnref:doubles-and-vectors" role="doc-noteref"><a href="#fn:doubles-and-vectors" class="footnote" rel="footnote">2</a></sup>).</p> <p>The above values are for x86<sup id="fnref:official-support" role="doc-noteref"><a href="#fn:official-support" class="footnote" rel="footnote">3</a></sup>. LLVM will pass six integers and eight SSE vectors by register, and return half as many (3 and 4) by register. Increasing any of the values generates extra loads and stores that indicate LLVM gave up and passed arguments on the stack.</p> <p>The values for <code class="language-plaintext highlighter-rouge">aarch64-unknown-linux</code> are 8 integers and 8 vectors for both inputs and outputs, respectively.</p> <p>This is the maximum number of registers we get to play with for each class. Anything extra gets passed on the stack.</p> <p>I recommend that <em>every function</em> have the same number of by-register arguments. So on x86, EVERY <code class="language-plaintext highlighter-rouge">-Zcallconv=fast</code> function’s signature should look like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="k">declare</span> <span class="p">{[</span><span class="m">3</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">],</span> <span class="p">[</span><span class="m">4</span> <span class="p">x</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;]}</span> <span class="vg">@my_func</span><span class="p">(</span>
  <span class="kt">i64</span> <span class="nv">%rdi</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rsi</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rdx</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rcx</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r8</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r9</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm1</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm2</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm3</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm4</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm5</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm6</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm7</span><span class="p">,</span>
  <span class="c1">; other args...</span>
<span class="p">)</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <p>When passing pointers, the appropriate <code class="language-plaintext highlighter-rouge">i64</code>s should be replaced by <code class="language-plaintext highlighter-rouge">ptr</code>, and when passing <code class="language-plaintext highlighter-rouge">double</code>s, they replace <code class="language-plaintext highlighter-rouge">&lt;2 x i64&gt;</code>s.</p> <p>But you’re probably saying, “Miguel, that’s crazy! Most functions don’t pass 176 bytes!” And you’d be right, if not for the magic of LLVM’s very well-specified <code class="language-plaintext highlighter-rouge">poison</code> semantics.</p> <p>We can get away with not doing extra work if every argument we do not use is passed <code class="language-plaintext highlighter-rouge">poison</code>. Because <code class="language-plaintext highlighter-rouge">poison</code> is equal to “the most convenient possible value at the present moment”, when LLVM sees <code class="language-plaintext highlighter-rouge">poison</code> passed into a function via register, it decides that the most convenient value is “whatever happens to be in the register already”, and so it doesn’t have to touch that register!</p> <p>For example, if we wanted to pass a pointer via <code class="language-plaintext highlighter-rouge">rcx</code>, we would generate the following code.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="c1">; This is a -Zcallconv=fast-style function.</span>
<span class="nv">%Out</span> <span class="p">=</span> <span class="k">type</span> <span class="p">{[</span><span class="m">3</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">],</span> <span class="p">[</span><span class="m">4</span> <span class="p">x</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;]}</span>
<span class="k">define</span> <span class="nv">%Out</span> <span class="vg">@load_rcx</span><span class="p">(</span>
  <span class="kt">i64</span> <span class="nv">%rdi</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rsi</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rdx</span><span class="p">,</span>
  <span class="err">ptr</span> <span class="nv">%rcx</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r8</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r9</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm1</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm2</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm3</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm4</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm5</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm6</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm7</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nv">%load</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i64</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%rcx</span>
  <span class="nv">%out</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="nv">%Out</span> <span class="err">poison</span><span class="p">,</span>
                      <span class="kt">i64</span> <span class="nv">%load</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">ret</span> <span class="nv">%Out</span> <span class="nv">%out</span>
<span class="p">}</span>

<span class="k">declare</span> <span class="err">ptr</span> <span class="vg">@malloc</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span>
<span class="k">define</span> <span class="kt">i64</span> <span class="vg">@make_the_call</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">%1</span> <span class="p">=</span> <span class="k">call</span> <span class="err">ptr</span> <span class="vg">@malloc</span><span class="p">(</span><span class="kt">i64</span> <span class="m">8</span><span class="p">)</span>
  <span class="k">store</span> <span class="kt">i64</span> <span class="m">42</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%1</span>
  <span class="nv">%2</span> <span class="p">=</span> <span class="k">call</span> <span class="nv">%Out</span> <span class="vg">@by_rcx</span><span class="p">(</span>
    <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span>
    <span class="err">ptr</span> <span class="nv">%1</span><span class="p">,</span>     <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">)</span>
  <span class="nv">%3</span> <span class="p">=</span> <span class="k">extractvalue</span> <span class="nv">%Out</span> <span class="nv">%2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span>
  <span class="nv">%4</span> <span class="p">=</span> <span class="k">add</span> <span class="kt">i64</span> <span class="nv">%3</span><span class="p">,</span> <span class="m">42</span>
  <span class="k">ret</span> <span class="kt">i64</span> <span class="nv">%4</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="nl">by_rcx:</span>
  <span class="n">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
  <span class="n">ret</span>

<span class="n">make_the_call</span><span class="o">:</span>
  <span class="n">push</span>  <span class="n">rax</span>
  <span class="n">mov</span>   <span class="n">edi</span><span class="p">,</span> <span class="mi">8</span>
  <span class="n">call</span>  <span class="n">malloc</span>
  <span class="n">mov</span>   <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rax</span><span class="p">],</span> <span class="mi">42</span>
  <span class="n">mov</span>   <span class="n">rcx</span><span class="p">,</span> <span class="n">rax</span>
  <span class="n">call</span>  <span class="n">load_rcx</span>
  <span class="n">add</span>   <span class="n">rax</span><span class="p">,</span> <span class="mi">42</span>
  <span class="n">pop</span>   <span class="n">rcx</span>
  <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p>It is perfectly legal to pass poison to a function, if it does not interact with the poisoned argument in any proscribed way. And as we see, <code class="language-plaintext highlighter-rouge">load_rcx()</code> receives its pointer argument in <code class="language-plaintext highlighter-rouge">rcx</code>, whereas <code class="language-plaintext highlighter-rouge">make_the_call()</code> takes no penalty in setting up the call: loading poison into the other thirteen registers compiles down to nothing<sup id="fnref:requires-opt" role="doc-noteref"><a href="#fn:requires-opt" class="footnote" rel="footnote">4</a></sup>, so it only needs to load the pointer returned by malloc into <code class="language-plaintext highlighter-rouge">rcx</code>.</p> <p>This gives us almost total control over argument passing; unfortunately, it is not total. In an ideal world, the same registers are used for input and output, to allow easier pipelining of calls without introducing extra register traffic. This is true on ARM and RISC-V, but not x86. However, because register ordering is merely a suggestion for us, we can choose to allocate the return registers in whatever order we want. For example, we can pretend the order registers should be allocated in is <code class="language-plaintext highlighter-rouge">rdx</code>, <code class="language-plaintext highlighter-rouge">rcx</code>, <code class="language-plaintext highlighter-rouge">rdi</code>, <code class="language-plaintext highlighter-rouge">rsi</code>, <code class="language-plaintext highlighter-rouge">r8</code>, <code class="language-plaintext highlighter-rouge">r9</code> for inputs, and <code class="language-plaintext highlighter-rouge">rdx</code>, <code class="language-plaintext highlighter-rouge">rcx</code>, <code class="language-plaintext highlighter-rouge">rax</code> for outputs.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="nv">%Out</span> <span class="p">=</span> <span class="k">type</span> <span class="p">{[</span><span class="m">3</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">],</span> <span class="p">[</span><span class="m">4</span> <span class="p">x</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;]}</span>
<span class="k">define</span> <span class="nv">%Out</span> <span class="vg">@square</span><span class="p">(</span>
  <span class="kt">i64</span> <span class="nv">%rdi</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rsi</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rdx</span><span class="p">,</span>
  <span class="err">ptr</span> <span class="nv">%rcx</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r8</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r9</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm1</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm2</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm3</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm4</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm5</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm6</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm7</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nv">%sq</span> <span class="p">=</span> <span class="k">mul</span> <span class="kt">i64</span> <span class="nv">%rdx</span><span class="p">,</span> <span class="nv">%rdx</span>
  <span class="nv">%out</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="nv">%Out</span> <span class="err">poison</span><span class="p">,</span>
                      <span class="kt">i64</span> <span class="nv">%sq</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span>
  <span class="k">ret</span> <span class="nv">%Out</span> <span class="nv">%out</span>
<span class="p">}</span>

<span class="k">define</span> <span class="kt">i64</span> <span class="vg">@make_the_call</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">%2</span> <span class="p">=</span> <span class="k">call</span> <span class="nv">%Out</span> <span class="vg">@square</span><span class="p">(</span>
    <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%0</span><span class="p">,</span>
    <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">)</span>
  <span class="nv">%3</span> <span class="p">=</span> <span class="k">extractvalue</span> <span class="nv">%Out</span> <span class="nv">%2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span>

  <span class="nv">%4</span> <span class="p">=</span> <span class="k">call</span> <span class="nv">%Out</span> <span class="vg">@square</span><span class="p">(</span>
    <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%3</span><span class="p">,</span>
    <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span>
    <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="err">poison</span><span class="p">)</span>
  <span class="nv">%5</span> <span class="p">=</span> <span class="k">extractvalue</span> <span class="nv">%Out</span> <span class="nv">%4</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span>

  <span class="k">ret</span> <span class="kt">i64</span> <span class="nv">%5</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="nl">square:</span>
  <span class="n">imul</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">rdx</span>
  <span class="n">ret</span>

<span class="n">make_the_call</span><span class="o">:</span>
  <span class="n">push</span> <span class="n">rax</span>
  <span class="n">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">rdi</span>
  <span class="n">call</span> <span class="n">square</span>
  <span class="n">call</span> <span class="n">square</span>
  <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rdx</span>
  <span class="n">pop</span> <span class="n">rcx</span>
  <span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> </div> <p><code class="language-plaintext highlighter-rouge">square</code> generates extremely simple code: the input and output register is <code class="language-plaintext highlighter-rouge">rdi</code>, so no extra register traffic needs to be generated. Similarly, when we effectively do <code class="language-plaintext highlighter-rouge">@square(@square(%0))</code>, there is no setup between the functions. This is similar to code seen on aarch64, which uses the same register sequence for input and output. We can see that the “naive” version of this IR produces the exact same code on aarch64 for this reason.</p> <div class="code-multicol"> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="k">define</span> <span class="kt">i64</span> <span class="vg">@square</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">%2</span> <span class="p">=</span> <span class="k">mul</span> <span class="kt">i64</span> <span class="nv">%0</span><span class="p">,</span> <span class="nv">%0</span>
  <span class="k">ret</span> <span class="kt">i64</span> <span class="nv">%2</span>
<span class="p">}</span>

<span class="k">define</span> <span class="kt">i64</span> <span class="vg">@make_the_call</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">%2</span> <span class="p">=</span> <span class="k">call</span> <span class="kt">i64</span> <span class="vg">@square</span><span class="p">(</span><span class="kt">i64</span> <span class="nv">%0</span><span class="p">)</span>
  <span class="nv">%3</span> <span class="p">=</span> <span class="k">call</span> <span class="kt">i64</span> <span class="vg">@square</span><span class="p">(</span><span class="kt">i64</span> <span class="nv">%2</span><span class="p">)</span>
  <span class="k">ret</span> <span class="kt">i64</span> <span class="nv">%3</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="nl">square:</span>
  <span class="n">mul</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x0</span>
  <span class="n">ret</span>

<span class="n">make_the_call</span><span class="o">:</span>
  <span class="n">str</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span><span class="o">!</span>
  <span class="n">bl</span> <span class="n">square</span>
  <span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="err">#</span><span class="mi">16</span>
  <span class="n">b</span> <span class="n">square</span>  <span class="c1">// Tail call.</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">ARM Assembly</div></div></div> </div> <h3 id="rust-structs-and-unions"><a href="#rust-structs-and-unions">Rust Structs and Unions</a></h3> <p>Now that we’ve established total control on how registers are assigned, we can turn towards maximizing use of these registers in Rust.</p> <p>For simplicity, we can assume that rustc has already processed the users’s types into basic aggregates and unions; no enums here! We then have to make some decisions about which portions of the arguments to allocate to registers.</p> <p>First, return values. This is relatively straightforward, since there is only one value to pass. The amount of data we need to return is <em>not</em> the size of the struct. For example, <code class="language-plaintext highlighter-rouge">[(u64, u32); 2]</code> measures 32 bytes wide. However, eight of those bytes are padding! We do not need to preserve padding when returning by value, so we can flatten the struct into <code class="language-plaintext highlighter-rouge">(u64, u32, u64, u32)</code> and sort by size into <code class="language-plaintext highlighter-rouge">(u64, u64, u32, u32)</code>. This has no padding and is 24 bytes wide, which fits into the three return registers LLVM gives us on x86. We define the <em>effective size</em> of a type to be the number of non-<code class="language-plaintext highlighter-rouge">undef</code> bits it occupies. For <code class="language-plaintext highlighter-rouge">[(u64, u32); 2]</code>, this is 192 bits, since it excludes the padding. For <code class="language-plaintext highlighter-rouge">bool</code>, this is one. For <code class="language-plaintext highlighter-rouge">char</code> this is technically 21, but it’s simpler to treat <code class="language-plaintext highlighter-rouge">char</code> as an alias for <code class="language-plaintext highlighter-rouge">u32</code>.</p> <p>The reason for counting bits this way is that it permits significant compaction. For example, returning a struct full of bools can simply bit-pack the bools into a single register.</p> <p>So, a return value is converted to a by-ref return if its effective size is smaller than the output register space (on x86, this is three integer registers and four SSE registers, so we get 88 bytes total, or 704 bits).</p> <p>Argument registers are much harder, because we hit the <a href="https://en.wikipedia.org/wiki/Knapsack_problem">knapsack problem</a>, which is NP-hard. The following relatively naive heuristic is where I would start, but it can be made infinitely smarter over time.</p> <p>First, demote to by-ref any argument whose effective size is larget than the total by-register input space (on x86, 176 bytes or 1408 bits). This means we get a pointer argument instead. This is beneficial to do first, since a single pointer might pack better than the huge struct.</p> <p>Enums should be replaced by the appropriate discriminant-union pair. For example, <code class="language-plaintext highlighter-rouge">Option&lt;i32&gt;</code> is, internally, <code class="language-plaintext highlighter-rouge">(union { i32, () }, i1)</code>, while <code class="language-plaintext highlighter-rouge">Option&lt;Option&lt;i32&gt;&gt;</code> is <code class="language-plaintext highlighter-rouge">(union { i32, (), () }, i2)</code>. Using a small non-power-of-two integer improves our ability to pack things, since enum discriminants are often quite tiny.</p> <p>Next, we need to handle unions. Because mucking about with unions’ uninitialized bits behind our backs is allowed, we need to either pass it as an array of <code class="language-plaintext highlighter-rouge">u8</code>, unless it only has a single non-empty variant, in which case it is replaced with that variant<sup id="fnref:union-optimization" role="doc-noteref"><a href="#fn:union-optimization" class="footnote" rel="footnote">5</a></sup>.</p> <p>Now, we can proceed to flatten everything. All of the converted arguments are flattened into their most primitive components: pointers, integers, floats, and bools. Every field should be no larger than the smallest argument register; this may require splitting large types such as <code class="language-plaintext highlighter-rouge">u128</code> or <code class="language-plaintext highlighter-rouge">f64</code>.</p> <p>This big list of primitives is next sorted by effective size, from smallest to largest. We take the largest prefix of this that will fit in the available register space; everything else goes on the stack.</p> <p>If part of a Rust-level input is sent to the stack in this way, and that part is larger than a small multiple of the pointer size (e.g., 2x), it is demoted to being passed by pointer-on-the-stack, to minimize memory traffic. Everything else is passed directly on the stack in the order those inputs were before the sort. This helps keep regions that need to be copied relatively contiguous, to minimize calls to <code class="language-plaintext highlighter-rouge">memcpy</code>.</p> <p>The things we choose to pass in registers are allocated to registers in reverse size order, so e.g. first 64-bit things, then 32-bit things, etc. This is the same layout algorithm that <code class="language-plaintext highlighter-rouge">repr(Rust)</code> structs use to move all the padding into the tail. Once we get to the <code class="language-plaintext highlighter-rouge">bool</code>s, those are bit-packed, 64 to a register.</p> <p>Here’s a relatively complicated example. My Rust function is as follows:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Options</span> <span class="p">{</span>
  <span class="n">colorize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="n">verbose_debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="n">allow_spurious_failure</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="n">retries</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">trait</span> <span class="n">Context</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">check</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">colorize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="n">do_thing</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op_count</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">dyn</span> <span class="n">Context</span><span class="p">,</span>
                <span class="n">name</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="p">[</span><span class="nb">char</span><span class="p">;</span> <span class="mi">6</span><span class="p">],</span>
                <span class="n">options</span><span class="p">:</span> <span class="n">Options</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span> <span class="p">{</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">op_count</span><span class="p">)</span> <span class="o">=</span> <span class="n">op_count</span> <span class="p">{</span>
    <span class="n">context</span><span class="nf">.check</span><span class="p">(</span><span class="n">op_count</span><span class="p">,</span> <span class="n">options</span><span class="py">.colorize</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">c</span> <span class="k">in</span> <span class="n">code</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">((</span><span class="n">_</span><span class="p">,</span> <span class="n">suf</span><span class="p">))</span> <span class="o">=</span> <span class="n">name</span><span class="nf">.split_once</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">suf</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="s">"idk"</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The codegen for this function is quite complex, so I’ll only cover the prologue and epilogue. After sorting and flattening, our raw argument LLVM types are something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="nl">gprs:</span> <span class="kt">i64</span><span class="p">,</span> <span class="err">ptr</span><span class="p">,</span> <span class="err">ptr</span><span class="p">,</span> <span class="err">ptr</span><span class="p">,</span> <span class="kt">i64</span><span class="p">,</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i32</span>
<span class="nl">xmm0:</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i32</span>
<span class="nl">xmm1:</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <p>Everything fits in registers! So, what does the LLVM function look like on x86?</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="nv">%Out</span> <span class="p">=</span> <span class="k">type</span> <span class="p">{[</span><span class="m">3</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">],</span> <span class="p">[</span><span class="m">4</span> <span class="p">x</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;]}</span>
<span class="k">define</span> <span class="nv">%Out</span> <span class="vg">@do_thing</span><span class="p">(</span>
  <span class="kt">i64</span> <span class="nv">%rdi</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%rsi</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%rdx</span><span class="p">,</span>
  <span class="err">ptr</span> <span class="nv">%rcx</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r8</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r9</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm1</span><span class="p">,</span>
  <span class="c1">; Unused.</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm2</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm3</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm4</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm5</span><span class="p">,</span>
  <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm6</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">2</span> <span class="p">x</span> <span class="kt">i64</span><span class="p">&gt;</span> <span class="nv">%xmm7</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">; First, unpack all the primitives.</span>
  <span class="nv">%r9.0</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i64</span> <span class="nv">%r9</span> <span class="k">to</span> <span class="kt">i32</span>
  <span class="nv">%r9.1.i64</span> <span class="p">=</span> <span class="k">lshr</span> <span class="kt">i64</span> <span class="nv">%r9</span><span class="p">,</span> <span class="m">32</span>
  <span class="nv">%r9.1</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i64</span> <span class="nv">%r9.1.i64</span> <span class="k">to</span> <span class="kt">i32</span>
  <span class="nv">%xmm0.0</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span>
  <span class="nv">%xmm0.1</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">1</span>
  <span class="nv">%xmm0.2</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">2</span>
  <span class="nv">%xmm0.3</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">3</span>
  <span class="nv">%xmm1.0</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm1</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span>
  <span class="nv">%xmm1.1</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">&gt;</span> <span class="nv">%xmm1</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">1</span>
  <span class="nv">%xmm1.1.0</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i32</span> <span class="nv">%xmm1.1</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="nv">%xmm1.1.1.i32</span> <span class="p">=</span> <span class="k">lshr</span> <span class="kt">i32</span> <span class="nv">%xmm1.1</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%xmm1.1.1</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i32</span> <span class="nv">%xmm1.1.1.i32</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="nv">%xmm1.1.2.i32</span> <span class="p">=</span> <span class="k">lshr</span> <span class="kt">i32</span> <span class="nv">%xmm1.1</span><span class="p">,</span> <span class="m">2</span>
  <span class="nv">%xmm1.1.2</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i32</span> <span class="nv">%xmm1.1.2.i32</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="nv">%xmm1.1.3.i32</span> <span class="p">=</span> <span class="k">lshr</span> <span class="kt">i32</span> <span class="nv">%xmm1.1</span><span class="p">,</span> <span class="m">3</span>
  <span class="nv">%xmm1.1.3</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i32</span> <span class="nv">%xmm1.1.3.i32</span> <span class="k">to</span> <span class="kt">i1</span>

  <span class="c1">; Next, reassemble them into concrete values as needed.</span>
  <span class="nv">%op_count.0</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="kt">i64</span><span class="p">,</span> <span class="kt">i1</span> <span class="p">}</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%rdi</span><span class="p">,</span> <span class="m">0</span>
  <span class="nv">%op_count</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="kt">i64</span><span class="p">,</span> <span class="kt">i1</span> <span class="p">}</span> <span class="nv">%op_count.0</span><span class="p">,</span> <span class="kt">i1</span> <span class="nv">%xmm1.1.0</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%context.0</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="err">ptr</span><span class="p">,</span> <span class="err">ptr</span> <span class="p">}</span> <span class="err">poison</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%rsi</span><span class="p">,</span> <span class="m">0</span>
  <span class="nv">%context</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="err">ptr</span><span class="p">,</span> <span class="err">ptr</span> <span class="p">}</span> <span class="nv">%context.0</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%rdx</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%name.0</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="err">ptr</span><span class="p">,</span> <span class="kt">i64</span> <span class="p">}</span> <span class="err">poison</span><span class="p">,</span> <span class="err">ptr</span> <span class="nv">%rcx</span><span class="p">,</span> <span class="m">0</span>
  <span class="nv">%name</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="err">ptr</span><span class="p">,</span> <span class="kt">i64</span> <span class="p">}</span> <span class="nv">%name.0</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%r8</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%code.0</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">]</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%r9.0</span><span class="p">,</span> <span class="m">0</span>
  <span class="nv">%code.1</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">]</span> <span class="nv">%code.0</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%r9.1</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%code.2</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">]</span> <span class="nv">%code.1</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%xmm0.0</span><span class="p">,</span> <span class="m">2</span>
  <span class="nv">%code.3</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">]</span> <span class="nv">%code.2</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%xmm0.1</span><span class="p">,</span> <span class="m">3</span>
  <span class="nv">%code.4</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">]</span> <span class="nv">%code.3</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%xmm0.2</span><span class="p">,</span> <span class="m">4</span>
  <span class="nv">%code</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">[</span><span class="m">6</span> <span class="p">x</span> <span class="kt">i32</span><span class="p">]</span> <span class="nv">%code.4</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%xmm0.3</span><span class="p">,</span> <span class="m">5</span>
  <span class="nv">%options.0</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span> <span class="p">}</span> <span class="err">poison</span><span class="p">,</span> <span class="kt">i32</span> <span class="nv">%xmm1.0</span><span class="p">,</span> <span class="m">0</span>
  <span class="nv">%options.1</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span> <span class="p">}</span> <span class="nv">%options.0</span><span class="p">,</span> <span class="kt">i1</span> <span class="nv">%xmm1.1.1</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%options.2</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span> <span class="p">}</span> <span class="nv">%options.1</span><span class="p">,</span> <span class="kt">i1</span> <span class="nv">%xmm1.1.2</span><span class="p">,</span> <span class="m">2</span>
  <span class="nv">%options</span> <span class="p">=</span> <span class="k">insertvalue</span> <span class="p">{</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span><span class="p">,</span> <span class="kt">i1</span> <span class="p">}</span> <span class="nv">%options.2</span><span class="p">,</span> <span class="kt">i1</span> <span class="nv">%xmm1.1.3</span><span class="p">,</span> <span class="m">3</span>

  <span class="c1">; Codegen as usual.</span>
  <span class="c1">; ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">LLVM IR</div></div></div> <p>Above, <code class="language-plaintext highlighter-rouge">!dbg</code> metadata for the argument values should be attached to the instruction that actually materializes it. This ensures that gdb does something halfway intelligent when you ask it to print argument values.</p> <p>On the other hand, in current rustc, it gives LLVM eight pointer-sized parameters, so it winds up spending all six integer registers, plus two values passed on the stack. Not great!</p> <p>This is not a complete description of what a completely over-engineered calling convention could entail: in some cases we might know that we have additional registers available (such as AVX registers on x86). There are cases where we might want to split a struct across registers and the stack.</p> <p>This also isn’t even getting into what returns <em>could</em> look like. <code class="language-plaintext highlighter-rouge">Result</code>s are often passed through several layers of functions via <code class="language-plaintext highlighter-rouge">?</code>, which can result in a lot of redundant register moves. Often, a <code class="language-plaintext highlighter-rouge">Result</code> is large enough that it doesn’t fit in registers, so each call in the <code class="language-plaintext highlighter-rouge">?</code> stack has to inspect an ok bit by loading it from memory. Instead, a <code class="language-plaintext highlighter-rouge">Result</code> return might be implemented as an out-parameter pointer for the error, with the ok variant’s payload, and the is ok bit, returned as an <code class="language-plaintext highlighter-rouge">Option&lt;T&gt;</code>. There are some fussy details with <code class="language-plaintext highlighter-rouge">Into</code> calls via <code class="language-plaintext highlighter-rouge">?</code>, but the idea is implementable.</p> <h3 id="optimization-dependent-abi"><a href="#optimization-dependent-abi">Optimization-Dependent ABI</a></h3> <p>Now, because we’re Rust, we’ve also got a trick up our sleeve that C doesn’t (but Go does)! When we’re generating the ABI that all callers will see (for <code class="language-plaintext highlighter-rouge">-Zcallconv=fast</code>), we can look at the function body. This means that a crate can advertise the <em>precise</em> ABI (in terms of register-passing) of its functions.</p> <p>This opens the door to a more extreme optimization-based ABIs. We can start by simply throwing out unused arguments: if the function never does anything with a parameter, don’t bother spending registers on it.</p> <p>Another example: suppose that we know that an <code class="language-plaintext highlighter-rouge">&amp;T</code> argument is not retained (a question the borrow checker can answer at this point in the compiler) and is never converted to a raw pointer (or written to memory a raw pointer is taken of, etc). We also know that <code class="language-plaintext highlighter-rouge">T</code> is fairly small, and <code class="language-plaintext highlighter-rouge">T: Freeze</code>. Then, we can replace the reference with the pointee directly, passed by value.</p> <p>The most obvious candidates for this is APIs like <code class="language-plaintext highlighter-rouge">HashMap::get()</code>. If the key is something like an <code class="language-plaintext highlighter-rouge">i32</code>, we need to spill that integer to the stack and pass a pointer to it! This results in unnecessary, avoidable memory traffic.</p> <p>Profile-guided ABI is a step further. We might know that some arguments are hotter than others, which might cause them to be prioritized in the register allocation order.</p> <p>You could even imagine a case where a function takes a very large struct by reference, but three <code class="language-plaintext highlighter-rouge">i64</code> fields are very hot, so the caller can <em>preload</em> those fields, passing them both by register <em>and</em> via the pointer to the large struct. The callee does not see additional cost: it had to issue those loads anyway. However, the caller probably has those values in registers already, which avoids some memory traffic.</p> <p>Instrumentation profiles may even indicate that it makes sense to duplicate whole functions, which are identical except for their ABIs. Maybe they take different arguments by register to avoid costly spills.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>This is a bit more advanced (and ranty) than my usual writing, but this is an aspect of Rust that I find really frustrating. We could be doing <em>so much better</em> than C++ ever can (because of their ABI constraints). None of this is new ideas; this is <em>literally</em> how Go does it!</p> <p>So why don’t we? Part of the reason is that ABI codegen is complex, and as I described above, LLVM gives us very few useful knobs. It’s not a friendly part of rustc, and doing things wrong can have nasty consequences for usability. The other part is a lack of expertise. As of writing, only a handful of people contributing to rustc have the necessary grasp of LLVM’s semantics (and mood swings) to emit the Right Code such that we get good codegen and don’t crash LLVM.</p> <p>Another reason is compilation time. The more complicated the function signatures, the more prologue/epilogue code we have to generate that LLVM has to chew on. But <code class="language-plaintext highlighter-rouge">-Zcallconv</code> is intended to only be used with optimizations turned on, so I don’t think this is a meaningful complaint. Nor do I think the project’s Goodhartization of compilation time as a metric is healthy… but I do not think this is ultimately a relevant drawback.</p> <p>I, unfortunately, do not have the spare time to dive into fixing rustc’s ABI code, but I do know LLVM really well, and I know that this is a place where Rust has a low bus factor. For that reason, I am happy to provide the Rust compiler team expert knowledge on getting LLVM to do the right thing in service of making optimized code faster.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:just-use-extern-c" role="doc-endnote"> <p>Or just switch it to the codepath for <code class="language-plaintext highlighter-rouge">extern "C"</code> or <code class="language-plaintext highlighter-rouge">extern "fastcall"</code> since those are clearly better. We will always need to know how to generate code for the non-<code class="language-plaintext highlighter-rouge">extern "Rust"</code> calling conventions. <a href="#fnref:just-use-extern-c" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:doubles-and-vectors" role="doc-endnote"> <p>It’s Complicated. Passing a <code class="language-plaintext highlighter-rouge">double</code> burns a whole <code class="language-plaintext highlighter-rouge">&lt;2 x i64&gt;</code> slot. This seems bad, but it can be beneficial since keeping a <code class="language-plaintext highlighter-rouge">double</code> in vector registers reduces register traffic, since usually, fp instructions use the vector registers (or the fp registers shadow the vector registers, like on ARM). <a href="#fnref:doubles-and-vectors" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:official-support" role="doc-endnote"> <p>On the one hand, you might say this “extended calling convention” isn’t an explicitly supported part of LLVM’s <code class="language-plaintext highlighter-rouge">ccc</code> calling convention. On the other hand, <a href="hyrumslaw.com">Hyrum’s Law</a> cuts both ways: Rust is big enough of an LLVM user that LLVM cannot simply miscompile all Rust programs at this point, and the IR I propose Rust emits is extremely reasonable.</p> <p>If Rust causes LLVM to misbehave, that’s an LLVM bug, and we should fix LLVM bugs, not work around them. <a href="#fnref:official-support" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:requires-opt" role="doc-endnote"> <p>Only on <code class="language-plaintext highlighter-rouge">-O1</code> or higher, bizarrely. At <code class="language-plaintext highlighter-rouge">-O0</code>, LLVM decides that all of the <code class="language-plaintext highlighter-rouge">poison</code>s must have the same value, so it copies a bunch of registers around needlessly. This seems like a bug? <a href="#fnref:requires-opt" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:union-optimization" role="doc-endnote"> <p>There are other cases where we might want to replace a union with one of its variants: for example, there’s a lot of cases where <code class="language-plaintext highlighter-rouge">Result&lt;&amp;T, Error&gt;</code> is secretly a <code class="language-plaintext highlighter-rouge">union { ptr, u32 }</code>, in which case it should be replaced with a single <code class="language-plaintext highlighter-rouge">ptr</code>. <a href="#fnref:union-optimization" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="dark-arts"/><category term="assembly"/><category term="rust"/><summary type="html"><![CDATA[I will often say that the so-called “C ABI” is a very bad one, and a relatively unimaginative one when it comes to passing complicated types effectively. A lot of people ask me “ok, what would you use instead”, and I just point them to the Go register ABI, but it seems most people have trouble filling in the gaps of what I mean. This article explains what I mean in detail.]]></summary></entry><entry><title type="html">Designing a SIMD Algorithm from Scratch</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2023/11/27/simd-base64/" rel="alternate" type="text/html" title="Designing a SIMD Algorithm from Scratch"/><published>2023-11-27T00:00:00-08:00</published><updated>2023-11-27T00:00:00-08:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2023/11/27/simd-base64</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2023/11/27/simd-base64/"><![CDATA[<p>Another explainer on a fun, esoteric topic: optimizing code with SIMD (single instruction multiple data, also sometimes called <em>vectorization</em>). Designing a good, fast, portable SIMD algorithm is not a simple matter and requires thinking a little bit like a circuit designer.</p> <p>Here’s the mandatory performance benchmark graph to catch your eye.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/graph.png" alt="perf perf perf"/></p> <p>“SIMD” often gets thrown around as a buzzword by performance and HPC (high performance computing) nerds, but I don’t think it’s a topic that has very friendly introductions out there, for a lot of reasons.</p> <ul> <li>It’s not something you will really want to care about unless you think performance is cool.</li> <li>APIs for programming with SIMD in most programming languages are <em>garbage</em> (I’ll get into why).</li> <li>SIMD algorithms are hard to think about if you’re very procedural-programming-brained. A functional programming mindset can help a lot.</li> </ul> <p>This post is mostly about <a href="https://docs.rs/vb64/latest/vb64/"><code class="language-plaintext highlighter-rouge">vb64</code></a> (which stands for <em>v</em>ector <em>b</em>ase<em>64</em>), a base64 codec I wrote to see for myself if Rust’s <code class="language-plaintext highlighter-rouge">std::simd</code> library is any good, but it’s also an excuse to talk about SIMD in general.</p> <p>What <em>is</em> SIMD, anyways? Let’s dive in.</p> <p>If you want to skip straight to the writeup on <code class="language-plaintext highlighter-rouge">vb64</code>, click <a href="#parsing-with-simd">here</a>.</p> <h2 id="problems-with-physics"><a href="#problems-with-physics">Problems with Physics</a></h2> <p>Unfortunately, computers exist in the real world<sup>[citation-needed]</sup>, and are bound by the laws of nature. SIMD has relatively little to do with theoretical CS considerations, and everything to do with <em>physics</em>.</p> <p>In the infancy of modern computing, you could simply improve performance of existing programs by buying new computers. This is often incorrectly attributed to Moore’s law (the number of transistors on IC designs doubles every two years). Moore’s law still appears to hold as of 2023, but some time in the last 15 years the <a href="https://en.wikipedia.org/wiki/Dennard_scaling">Dennard scaling</a> effect broke down. This means that denser transistors eventually means increased power dissipation density. In simpler terms, we don’t know how to continue to increase the clock frequency of computers without literally <em>liquefying</em> them.</p> <p>So, since the early aughts, the hot new thing has been bigger core counts. Make your program more multi-threaded and it will run faster on bigger CPUs. This comes with synchronization overhead, since now the cores need to cooperate. All control flow, be it jumps, virtual calls, or synchronization will result in “stall”.</p> <p>The main causes of stall are <em>branches</em>, instructions that indicate code can take one of two possible paths (like an <code class="language-plaintext highlighter-rouge">if</code> statement), and <em>memory operations</em>. Branches include all control flow: <code class="language-plaintext highlighter-rouge">if</code> statements, loops, function calls, function returns, even <code class="language-plaintext highlighter-rouge">switch</code> statements in C. Memory operations are loads and stores, especially ones that are cache-unfriendly.</p> <h3 id="procedural-code-is-slow"><a href="#procedural-code-is-slow">Procedural Code Is Slow</a></h3> <p>Modern compute cores do not execute code line-by-line, because that would be very inefficient. Suppose I have this program:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">^</span> <span class="n">y</span><span class="p">;</span>
<span class="nd">println!</span><span class="p">(</span><span class="s">"{a}, {b}"</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>There’s no reason for the CPU to wait to finish computing <code class="language-plaintext highlighter-rouge">a</code> before it begins computing <code class="language-plaintext highlighter-rouge">b</code>; it does not depend on <code class="language-plaintext highlighter-rouge">a</code>, and while the add is being executed, the xor circuits are idle. Computers say “program order be damned” and issue the add for <code class="language-plaintext highlighter-rouge">a</code> and the xor for <code class="language-plaintext highlighter-rouge">b</code> simultaneously. This is called <em>instruction-level parallelism</em>, and dependencies that get in the way of it are often called <em>data hazards</em>.</p> <p>Of course, the Zen 2 in the machine I’m writing this with does not have one measly adder per core. It has dozens and dozens! The opportunities for parallelism are massive, as long as the compiler in your CPU’s execution pipeline can clear any data hazards in the way.</p> <p>The better the core can do this, the more it can saturate all of the “functional units” for things like arithmetic, and the more numbers it can crunch per unit time, approaching maximum utilization of the hardware. Whenever the compiler can’t do this, the execution pipeline stalls and your code is slower.</p> <p>Branches stall because they need to wait for the branch condition to be computed before fetching the next instruction (speculative execution is a somewhat iffy workaround for this). Memory operations stall because the data needs to physically arrive at the CPU, and the speed of light is finite in this universe.</p> <p>Trying to reduce stall by improving opportunities for single-core parallelism is not a new idea. Consider the not-so-humble GPU, whose purpose in life is to render images. Images are vectors of pixels (i.e., color values), and rendering operations tend to be highly local. For example, a convolution kernel for a Gaussian blur will be two or even three orders of magnitude smaller than the final image, lending itself to locality.</p> <p>Thus, GPUs are built for divide-and-conquer: they provide primitives for doing batched operations, and extremely limited control flow.</p> <p>“SIMD” is synonymous with “batching”. It stands for “single instruction, multiple data”: a single instruction dispatches parallel operations on multiple <em>lanes</em> of data. GPUs are the original SIMD machines.</p> <h2 id="lane-wise"><a href="#lane-wise">Lane-Wise</a></h2> <p>“SIMD” and “vector” are often used interchangeably. The fundamental unit a SIMD instruction (or “vector instruction”) operates on is a vector: a fixed-size array of numbers that you primarily operate on component-wise These components are called <em>lanes</em>.</p> <p>SIMD vectors are usually quite small, since they need to fit into registers. For example, on my machine, the largest vectors are 256 bits wide. This is enough for 32 bytes (a <code class="language-plaintext highlighter-rouge">u8x32</code>), 4 double-precision floats (an <code class="language-plaintext highlighter-rouge">f64x8</code>), or all kinds of things in between.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/vectors.png" alt="some 256-bit vectors"/></p> <p>Although this doesn’t seem like much, remember that offloading the overhead of keeping the pipeline saturated by a factor of 4x can translate to that big of a speedup in latency.</p> <h3 id="one-bit-lanes"><a href="#one-bit-lanes">One-Bit Lanes</a></h3> <p>The simplest vector operations are bitwise: and, or, xor. Ordinary integers can be thought of as vectors themselves, with respect to the bitwise operations. That’s literally what “bitwise” means: lanes-wise with lanes that are one bit wide. An <code class="language-plaintext highlighter-rouge">i32</code> is, in this regard, an <code class="language-plaintext highlighter-rouge">i1x32</code>.</p> <p>In fact, as a warmup, let’s look at the problem of counting the number of 1 bits in an integer. This operation is called “population count”, or <code class="language-plaintext highlighter-rouge">popcnt</code>. If we view an <code class="language-plaintext highlighter-rouge">i32</code> as an <code class="language-plaintext highlighter-rouge">i1x32</code>, <code class="language-plaintext highlighter-rouge">popcnt</code> is just a fold or reduce operation:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">pub</span> <span class="k">fn</span> <span class="nf">popcnt</span><span class="p">(</span><span class="k">mut</span> <span class="n">x</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">bits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="mi">32</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="k">in</span> <span class="n">bits</span><span class="nf">.iter_mut</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">bits</span><span class="nf">.into_iter</span><span class="p">()</span><span class="nf">.fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">|</span><span class="n">total</span><span class="p">,</span> <span class="n">bit</span><span class="p">|</span> <span class="n">total</span> <span class="o">+</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj ZSI6InB1YiBmbiBwb3BjbnQobXV0IHg6IHUzMikgLT4gdTMyIHtcbiAgbGV0 IG11dCBiaXRzID0gWzA7IDMyXTtcbiAgZm9yIChpLCBiaXQpIGluIGJpdHMu aXRlcl9tdXQoKS5lbnVtZXJhdGUoKSB7XG4gICAgKmJpdCA9ICh4ID4+IGkp ICYgMTtcbiAgfVxuICBiaXRzLmludG9faXRlcigpLmZvbGQoMCwgfHRvdGFs LCBiaXR8IHRvdGFsICsgYml0KVxufSIsImNvbXBpbGVycyI6W3siaWQiOiJi ZXRhIiwib3B0aW9ucyI6Ii1PIn1dfV19 ">godbolt</a><div class="codeblock-button">Rust</div></div></div> <p>In other words, we interpret the integer as an array of bits and then add the bits together to a 32-bit accumulator. Note that the accumulator needs to be higher precision to avoid overflow: accumulating into an <code class="language-plaintext highlighter-rouge">i1</code> (as with the <code class="language-plaintext highlighter-rouge">Iterator::reduce()</code> method) will only tell us whether the number of 1 bits is even or odd.</p> <p>Of course, this produces… comically bad code, frankly. We can do much better if we notice that we can <em>vectorize</em> the addition: first we add all of the adjacent pairs of bits together, then the pairs of pairs, and so on. This means the number of adds is logarithmic in the number of bits in the integer.</p> <p>Visually, what we do is we “unzip” each vector, shift one to line up the lanes, add them, and then repeat with lanes twice as big.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/popcnt.png" alt="first two popcnt merge steps"/></p> <p>This is what that looks like in code.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">pub</span> <span class="k">fn</span> <span class="nf">popcnt</span><span class="p">(</span><span class="k">mut</span> <span class="n">x</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
  <span class="c1">// View x as a i1x32, and split it into two vectors</span>
  <span class="c1">// that contain the even and odd bits, respectively.</span>
  <span class="k">let</span> <span class="n">even</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0x55555555</span><span class="p">;</span> <span class="c1">// 0x5 == 0b0101.</span>
  <span class="k">let</span> <span class="n">odds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0xaaaaaaaa</span><span class="p">;</span> <span class="c1">// 0xa == 0b1010.</span>
  <span class="c1">// Shift odds down to align the bits, and then add them together.</span>
  <span class="c1">// We interpret x now as a i2x16. When adding, each two-bit</span>
  <span class="c1">// lane cannot overflow, because the value in each lane is</span>
  <span class="c1">// either 0b00 or 0b01.</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">even</span> <span class="o">+</span> <span class="p">(</span><span class="n">odds</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

  <span class="c1">// Repeat again but now splitting even and odd bit-pairs.</span>
  <span class="k">let</span> <span class="n">even</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0x33333333</span><span class="p">;</span> <span class="c1">// 0x3 == 0b0011.</span>
  <span class="k">let</span> <span class="n">odds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0xcccccccc</span><span class="p">;</span> <span class="c1">// 0xc == 0b1100.</span>
  <span class="c1">// We need to shift by 2 to align, and now for this addition</span>
  <span class="c1">// we interpret x as a i4x8.</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">even</span> <span class="o">+</span> <span class="p">(</span><span class="n">odds</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

  <span class="c1">// Again. The pattern should now be obvious.</span>
  <span class="k">let</span> <span class="n">even</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0x0f0f0f0f</span><span class="p">;</span> <span class="c1">// 0x0f == 0b00001111.</span>
  <span class="k">let</span> <span class="n">odds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0xf0f0f0f0</span><span class="p">;</span> <span class="c1">// 0xf0 == 0b11110000.</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">even</span> <span class="o">+</span> <span class="p">(</span><span class="n">odds</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// i8x4</span>

  <span class="k">let</span> <span class="n">even</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0x00ff00ff</span><span class="p">;</span>
  <span class="k">let</span> <span class="n">odds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0xff00ff00</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">even</span> <span class="o">+</span> <span class="p">(</span><span class="n">odds</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>  <span class="c1">// i16x2</span>

  <span class="k">let</span> <span class="n">even</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0x0000ffff</span><span class="p">;</span>
  <span class="k">let</span> <span class="n">odds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">0xffff0000</span><span class="p">;</span>
  <span class="c1">// Because the value of `x` is at most 32, although we interpret this as a</span>
  <span class="c1">// i32x1 add, we could get away with just one e.g. i16 add.</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">even</span> <span class="o">+</span> <span class="p">(</span><span class="n">odds</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

  <span class="n">x</span> <span class="c1">// Done. All bits have been added.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj ZSI6InB1YiBmbiBwb3BjbnQobXV0IHg6IHUzMikgLT4gdTMyIHtcbiAgLy8g VmlldyB4IGFzIGEgaTF4MzIsIGFuZCBzcGxpdCBpdCBpbnRvIHR3byB2ZWN0 b3JzXG4gIC8vIHRoYXQgY29udGFpbiB0aGUgZXZlbiBhbmQgb2RkIGJpdHMs IHJlc3BlY3RpdmVseS5cbiAgbGV0IGV2ZW4gPSB4ICYgMHg1NTU1NTU1NTsg Ly8gMHg1ID09IDBiMDEwMS5cbiAgbGV0IG9kZHMgPSB4ICYgMHhhYWFhYWFh YTsgLy8gMHhhID09IDBiMTAxMC5cbiAgLy8gU2hpZnQgb2RkcyBkb3duIHRv IGFsaWduIHRoZSBiaXRzLCBhbmQgdGhlbiBhZGQgdGhlbSB0b2dldGhlci5c biAgLy8gV2UgaW50ZXJwcmV0IHggbm93IGFzIGEgaTJ4MTYuIFdoZW4gYWRk aW5nLCBlYWNoIHR3by1iaXRcbiAgLy8gbGFuZSBjYW5ub3Qgb3ZlcmZsb3cs IGJlY2F1c2UgdGhlIHZhbHVlIGluIGVhY2ggbGFuZSBpc1xuICAvLyBlaXRo ZXIgMGIwMCBvciAwYjAxLlxuICB4ID0gZXZlbiArIChvZGRzID4+IDEpO1xu XG4gIC8vIFJlcGVhdCBhZ2FpbiBidXQgbm93IHNwbGl0dGluZyBldmVuIGFu ZCBvZGQgYml0LXBhaXJzLlxuICBsZXQgZXZlbiA9IHggJiAweDMzMzMzMzMz OyAvLyAweDMgPT0gMGIwMDExLlxuICBsZXQgb2RkcyA9IHggJiAweGNjY2Nj Y2NjOyAvLyAweGMgPT0gMGIxMTAwLlxuICAvLyBXZSBuZWVkIHRvIHNoaWZ0 IGJ5IDIgdG8gYWxpZ24sIGFuZCBub3cgZm9yIHRoaXMgYWRkaXRpb25cbiAg Ly8gd2UgaW50ZXJwcmV0IHggYXMgYSBpNHg4LlxuICB4ID0gZXZlbiArIChv ZGRzID4+IDIpO1xuXG4gIC8vIEFnYWluLiBUaGUgcGF0dGVybiBzaG91bGQg bm93IGJlIG9idmlvdXMuXG4gIGxldCBldmVuID0geCAmIDB4MGYwZjBmMGY7 IC8vIDB4MGYgPT0gMGIwMDAwMTExMS5cbiAgbGV0IG9kZHMgPSB4ICYgMHhm MGYwZjBmMDsgLy8gMHhmMCA9PSAwYjExMTEwMDAwLlxuICB4ID0gZXZlbiAr IChvZGRzID4+IDQpOyAvLyBpOHg0XG5cbiAgbGV0IGV2ZW4gPSB4ICYgMHgw MGZmMDBmZjtcbiAgbGV0IG9kZHMgPSB4ICYgMHhmZjAwZmYwMDtcbiAgeCA9 IGV2ZW4gKyAob2RkcyA+PiA4KTsgIC8vIGkxNngyXG5cbiAgbGV0IGV2ZW4g PSB4ICYgMHgwMDAwZmZmZjtcbiAgbGV0IG9kZHMgPSB4ICYgMHhmZmZmMDAw MDtcbiAgLy8gQmVjYXVzZSB0aGUgdmFsdWUgb2YgYHhgIGlzIGF0IG1vc3Qg MzIsIGFsdGhvdWdoIHdlIGludGVycHJldCB0aGlzIGFzIGFcbiAgLy8gaTMy eDEgYWRkLCB3ZSBjb3VsZCBnZXQgYXdheSB3aXRoIGp1c3Qgb25lIGUuZy4g aTE2IGFkZC5cbiAgeCA9IGV2ZW4gKyAob2RkcyA+PiAxNik7XG5cbiAgeCAv LyBEb25lLiBBbGwgYml0cyBoYXZlIGJlZW4gYWRkZWQuXG59IiwiY29tcGls ZXJzIjpbeyJpZCI6ImJldGEiLCJvcHRpb25zIjoiLU8ifV19XX0=">godbolt</a><div class="codeblock-button">Rust</div></div></div> <p>This still won’t optimize down to a <code class="language-plaintext highlighter-rouge">popcnt</code> instruction, of course. The search scope for such a simplification is in the regime of superoptimizers. However, the generated code is small and fast, which is why this is the ideal implementation of <code class="language-plaintext highlighter-rouge">popcnt</code> for systems without such an instruction.</p> <p>It’s <em>especially</em> nice because it is implementable for e.g. <code class="language-plaintext highlighter-rouge">u64</code> with only one more reduction step (remember: it’s <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>!), and does not at any point require a full <code class="language-plaintext highlighter-rouge">u64</code> addition.</p> <p>Even though this is “just” using scalars, divide-and-conquer approaches like this are the bread and butter of the SIMD programmer.</p> <h3 id="scaling-up-operations-on-real-vectors"><a href="#scaling-up-operations-on-real-vectors">Scaling Up: Operations on Real Vectors</a></h3> <p>Proper SIMD vectors provide more sophisticated semantics than scalars do, particularly because there is more need to provide replacements for things like control flow. Remember, control flow is slow!</p> <p>What’s actually available is highly dependent on the architecture you’re compiling to (more on this later), but the way vector instruction sets are usually structured is something like this.</p> <p>We have <em>vector registers</em> that are kind of like really big general-purpose registers. For example, on x86, most “high performance” cores (like my Zen 2) implement AVX2, which provides 256 bit <code class="language-plaintext highlighter-rouge">ymm</code> vectors. The registers themselves do not have a “lane count”; that is specified by the instructions. For example, the “vector byte add instruction” interprets the register as being divided into eight-byte lanes and adds them. The corresponding x86 instruction is <code class="language-plaintext highlighter-rouge">vpaddb</code>, which interprets a <code class="language-plaintext highlighter-rouge">ymm</code> as an <code class="language-plaintext highlighter-rouge">i8x32</code>.</p> <p>The operations you usually get are:</p> <ol> <li> <p>Bitwise operations. These don’t need to specify a lane width because it’s always implicitly <code class="language-plaintext highlighter-rouge">1</code>: they’re <em>bit</em>wise.</p> </li> <li> <p>Lane-wise arithmetic. This is addition, subtraction, multiplication, division (both int and float), and shifts<sup id="fnref:shifts-are-arithmetic" role="doc-noteref"><a href="#fn:shifts-are-arithmetic" class="footnote" rel="footnote">1</a></sup> (int only). Lane-wise min and max are also common. These require specifying a lane width. Typically the smallest number of lanes is two or four.</p> </li> <li> <p>Lane-wise compare. Given <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code>, we can create a new <em>mask vector</em> <code class="language-plaintext highlighter-rouge">m</code> such that <code class="language-plaintext highlighter-rouge">m[i] = a[i] &lt; b[i]</code> (or any other comparison operation). A mask vector’s lanes contain boolean values with an unusual bit-pattern: all-zeros (for false) or all-ones (for true)<sup id="fnref:minus-true" role="doc-noteref"><a href="#fn:minus-true" class="footnote" rel="footnote">2</a></sup>.</p> <ul> <li>Masks can be used to select between two vectors: for example, given <code class="language-plaintext highlighter-rouge">m</code>, <code class="language-plaintext highlighter-rouge">x</code>, and <code class="language-plaintext highlighter-rouge">y</code>, you can form a fourth vector <code class="language-plaintext highlighter-rouge">z</code> such that <code class="language-plaintext highlighter-rouge">z[i] = m[i] ? a[i] : b[i]</code>.</li> </ul> </li> <li> <p>Shuffles (sometimes called swizzles). Given <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">x</code>, create a third vector <code class="language-plaintext highlighter-rouge">s</code> such that <code class="language-plaintext highlighter-rouge">s[i] = a[x[i]]</code>. <code class="language-plaintext highlighter-rouge">a</code> is used as a lookup table, and <code class="language-plaintext highlighter-rouge">x</code> as a set of indices. Out of bounds produces a special value, usually zero. This emulates parallelized array access without needing to actually touch RAM (RAM is extremely slow).</p> <ul> <li>Often there is a “shuffle2” or “riffle” operation that allows taking elements from one of two vectors. Given <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code>, and <code class="language-plaintext highlighter-rouge">x</code>, we now define <code class="language-plaintext highlighter-rouge">s</code> as being <code class="language-plaintext highlighter-rouge">s[i] = (a ++ b)[x[i]]</code>, where <code class="language-plaintext highlighter-rouge">a ++ b</code> is a double-width concatenation. How this is actually implemented depends on architecture, and it’s easy to build out of single shuffles regardless.</li> </ul> </li> </ol> <p>(1) and (2) are ordinary number crunching. Nothing deeply special about them.</p> <p>The comparison and select operations in (3) are intended to help SIMD code stay “branchless”. Branchless code is written such that it performs the same operations regardless of its inputs, and relies on the properties of those operations to produce correct results. For example, this might mean taking advantage of identities like <code class="language-plaintext highlighter-rouge">x * 0 = 0</code> and <code class="language-plaintext highlighter-rouge">a ^ b ^ a = b</code> to discard “garbage” results.</p> <p>The shuffles described in (4) are much more powerful than meets the eye.</p> <p>For example, “broadcast” (sometimes called “splat”) makes a vector whose lanes are all the same scalar, like Rust’s <code class="language-plaintext highlighter-rouge">[42; N]</code> array literal. A broadcast can be expressed as a shuffle: create a vector with the desired value in the first lane, and then shuffle it with an index vector of <code class="language-plaintext highlighter-rouge">[0, 0, ...]</code>.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/broadcast.png" alt="diagram of a broadcast"/></p> <p>“Interleave” (also called “zip” or “pack”) takes two vectors <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> and creates two new vectors <code class="language-plaintext highlighter-rouge">c</code> and <code class="language-plaintext highlighter-rouge">d</code> whose lanes are alternating lanes from <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code>. If the lane count is <code class="language-plaintext highlighter-rouge">n</code>, then <code class="language-plaintext highlighter-rouge">c = [a[0], b[0], a[1], b[1], ...]</code> and <code class="language-plaintext highlighter-rouge">d = [a[n/2], b[n/2], a[n/2 + 1], b[n/2 + 1], ...]</code>. This can also be implemented as a shuffle2, with shuffle indices of <code class="language-plaintext highlighter-rouge">[0, n, 1, n + 1, ...]</code>. “Deinterleave” (or “unzip”, or “unpack”) is the opposite operation: it interprets a pair of vectors as two halves of a larger vector of pairs, and produces two new vectors consisting of the halves of each pair.</p> <p>Interleave can also be interpreted as taking a <code class="language-plaintext highlighter-rouge">[T; N]</code>, transmuting it to a <code class="language-plaintext highlighter-rouge">[[T; N/2]; 2]</code>, performing a matrix transpose to turn it into a <code class="language-plaintext highlighter-rouge">[[T; 2]; N/2]</code>, and then transmuting that back to <code class="language-plaintext highlighter-rouge">[T; N]</code> again. Deinterleave is the same but it transmutes to <code class="language-plaintext highlighter-rouge">[[T; 2]; N/2]</code> first.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/interleave.png" alt="diagram of a interleave"/></p> <p>“Rotate” takes a vector <code class="language-plaintext highlighter-rouge">a</code> with <code class="language-plaintext highlighter-rouge">n</code> lanes and produces a new vector <code class="language-plaintext highlighter-rouge">b</code> such that <code class="language-plaintext highlighter-rouge">b[i] = a[(i + j) % n]</code>, for some chosen integer <code class="language-plaintext highlighter-rouge">j</code>. This is yet another shuffle, with indices <code class="language-plaintext highlighter-rouge">[j, j + 1, ..., n - 1, 0, 1, ... j - 1]</code>.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/rotate.png" alt="diagram of a rotate"/></p> <p>Shuffles are worth trying to wrap your mind around. SIMD programming is all about reinterpreting larger-than-an-integer-sized blocks of data as smaller blocks of varying sizes, and shuffling is important for getting data into the right “place”.</p> <h3 id="intrinsics-and-instruction-selection"><a href="#intrinsics-and-instruction-selection">Intrinsics and Instruction Selection</a></h3> <p>Earlier, I mentioned that what you get varies by architecture. This section is basically a giant footnote.</p> <p>So, there’s two big factors that go into this.</p> <ol> <li>We’ve learned over time which operations tend to be most useful to programmers. x86 might have something that ARM doesn’t because it “seemed like a good idea at the time” but turned out to be kinda niche.</li> <li>Instruction set extensions are often market differentiators, even within the same vendor. Intel has AVX-512, which provides even more sophisticated instructions, but it’s only available on high-end server chips, because it makes manufacturing more expensive.</li> </ol> <p>Toolchains generalize different extensions as “target features”. Features can be detected at runtime through architecture-specific magic. On Linux, the <code class="language-plaintext highlighter-rouge">lscpu</code> command will list what features the CPU advertises that it recognizes, which correlate with the names of features that e.g. LLVM understands. What features are enabled for a particular function affects how LLVM compiles it. For example, LLVM will only emit <code class="language-plaintext highlighter-rouge">ymm</code>-using code when compiling with <code class="language-plaintext highlighter-rouge">+avx2</code>.</p> <p>So how do you write portable SIMD code? On the surface, the answer is mostly “you don’t”, but it’s more complicated than that, and for that we need to understand how the later parts of a compiler works.</p> <p>When a user requests an add by writing <code class="language-plaintext highlighter-rouge">a + b</code>, how should I decide which instruction to use for it? This seems like a trick question… <em>just</em> an <code class="language-plaintext highlighter-rouge">add</code> right? On x86, even this isn’t so easy, since you have a choice between the actual <code class="language-plaintext highlighter-rouge">add</code> instruction, or a <code class="language-plaintext highlighter-rouge">lea</code> instruction (which, among other things, preserves the <code class="language-plaintext highlighter-rouge">rflags</code> register). This question becomes more complicated for more sophisticated operations. This general problem is called <em>instruction selection</em>.</p> <p>Because which “target features” are enabled affects which instructions are available, they affect instruction selection. When I went over operations “typically available”, this means that compilers will usually be able to select good choices of instructions for them on most architectures.</p> <p>Compiling with something like <code class="language-plaintext highlighter-rouge">-march=native</code> or <code class="language-plaintext highlighter-rouge">-Ctarget-cpu=native</code> gets you “the best” code possible for the machine you’re building on, but it might not be portable<sup id="fnref:abi" role="doc-noteref"><a href="#fn:abi" class="footnote" rel="footnote">3</a></sup> to different processors. Gentoo was quite famous for building packages from source on user machines to take advantage of this (not to mention that they loved using <code class="language-plaintext highlighter-rouge">-O3</code>, which mostly exists to slow down build times with little benefit).</p> <p>There is also runtime feature detection, where a program decides which version of a function to call at runtime by asking the CPU what it supports. Code deployed on heterogenous devices (like cryptography libraries) often make use of this. Doing this correctly is very hard and something I don’t particularly want to dig deeply into here.</p> <p>The situation is made worse by the fact that in C++, you usually write SIMD code using “intrinsics”, which are special functions with inscrutable names like <code class="language-plaintext highlighter-rouge">_mm256_cvtps_epu32</code> that represent a low-level operation in a specific instruction set (this is a float to int cast from AVX2). Intrinsics are defined by hardware vendors, but don’t necessarily map down to single instructions; the compiler can still optimize these instructions by merging, deduplication, and through instruction selection.</p> <p>As a result you wind up writing the same code multiple times for different instruction sets, with only minor maintainability benefits over writing assembly.</p> <p>The alternative is a portable SIMD library, which does some instruction selection behind the scenes at the library level but tries to rely on the compiler for most of the heavy-duty work. For a long time I was skeptical that this approach would actually produce good, competitive code, which brings us to the actual point of this article: using Rust’s portable SIMD library to implement a somewhat fussy algorithm, and measuring performance.</p> <h2 id="parsing-with-simd"><a href="#parsing-with-simd">Parsing with SIMD</a></h2> <p>Let’s design a SIMD implementation for a well-known algorithm. Although it doesn’t look like it at first, the power of shuffles makes it possible to parse text with SIMD. And this parsing can be very, very fast.</p> <p>In this case, we’re going to implement base64 decoding. To review, base64 is an encoding scheme for arbitrary binary data into ASCII. We interpret a byte slice as a bit vector, and divide it into six-bit chunks called <em>sextets</em>. Then, each sextet from 0 to 63 is mapped to an ASCII character:</p> <ol> <li><code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">25</code> go to <code class="language-plaintext highlighter-rouge">'A'</code> to <code class="language-plaintext highlighter-rouge">'Z'</code>.</li> <li><code class="language-plaintext highlighter-rouge">26</code> to <code class="language-plaintext highlighter-rouge">51</code> go to <code class="language-plaintext highlighter-rouge">'a'</code> to <code class="language-plaintext highlighter-rouge">'z'</code>.</li> <li><code class="language-plaintext highlighter-rouge">52</code> to <code class="language-plaintext highlighter-rouge">61</code> go to <code class="language-plaintext highlighter-rouge">'0'</code> to <code class="language-plaintext highlighter-rouge">'9'</code>.</li> <li><code class="language-plaintext highlighter-rouge">62</code> goes to <code class="language-plaintext highlighter-rouge">+</code>.</li> <li><code class="language-plaintext highlighter-rouge">63</code> goes to <code class="language-plaintext highlighter-rouge">/</code>.</li> </ol> <p>There <em>are</em> other variants of base64, but the bulk of the complexity is the same for each variant.</p> <p>There are a few basic pitfalls to keep in mind.</p> <ol> <li> <p>Base64 is a “big endian” format: specifically, the bits in each byte are big endian. Because a sextet can span only parts of a byte, this distinction is important.</p> </li> <li> <p>We need to beware of cases where the input length is not divisible by 4; ostensibly messages should be padded with <code class="language-plaintext highlighter-rouge">=</code> to a multiple of 4, but it’s easy to just handle messages that aren’t padded correctly.</p> </li> </ol> <p>The length of a decoded message is given by this function:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
  <span class="n">input</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="k">match</span> <span class="n">input</span> <span class="o">%</span> <span class="mi">4</span> <span class="p">{</span>
    <span class="mi">1</span> <span class="p">|</span> <span class="mi">2</span> <span class="k">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">3</span> <span class="k">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Given all this, the easiest way to implement base64 is something like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">decode</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span> <span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// Tear off at most two trailing =.</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="k">match</span> <span class="n">data</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">p</span> <span class="o">@</span> <span class="o">..</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">]</span> <span class="p">|</span> <span class="p">[</span><span class="n">p</span> <span class="o">@</span> <span class="o">..</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">]</span> <span class="p">|</span> <span class="n">p</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="c1">// Split the input into chunks of at most 4 bytes.</span>
  <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">data</span><span class="nf">.chunks</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0u32</span><span class="p">;</span>
    <span class="k">for</span> <span class="o">&amp;</span><span class="n">byte</span> <span class="k">in</span> <span class="n">chunk</span> <span class="p">{</span>
      <span class="c1">// Translate each ASCII character into its corresponding</span>
      <span class="c1">// sextet, or return an error.</span>
      <span class="k">let</span> <span class="n">sextet</span> <span class="o">=</span> <span class="k">match</span> <span class="n">byte</span> <span class="p">{</span>
        <span class="sc">b'A'</span><span class="o">..=</span><span class="sc">b'Z'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'A'</span><span class="p">,</span>
        <span class="sc">b'a'</span><span class="o">..=</span><span class="sc">b'z'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'a'</span> <span class="o">+</span> <span class="mi">26</span><span class="p">,</span>
        <span class="sc">b'0'</span><span class="o">..=</span><span class="sc">b'9'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'0'</span> <span class="o">+</span> <span class="mi">52</span><span class="p">,</span>
        <span class="sc">b'+'</span> <span class="k">=&gt;</span> <span class="mi">62</span><span class="p">,</span>
        <span class="sc">b'/'</span> <span class="k">=&gt;</span> <span class="mi">63</span><span class="p">,</span>
        <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nf">Error</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
      <span class="p">};</span>

      <span class="c1">// Append the sextet to the temporary buffer.</span>
      <span class="n">bytes</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>
      <span class="n">bytes</span> <span class="p">|</span><span class="o">=</span> <span class="n">sextet</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Shift things so the actual data winds up at the</span>
    <span class="c1">// top of `bytes`.</span>
    <span class="n">bytes</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">chunk</span><span class="nf">.len</span><span class="p">();</span>

    <span class="c1">// Append the decoded data to `out`, keeping in mind that</span>
    <span class="c1">// `bytes` is big-endian encoded.</span>
    <span class="k">let</span> <span class="n">decoded</span> <span class="o">=</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">());</span>
    <span class="n">out</span><span class="nf">.extend_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="nf">.to_be_bytes</span><span class="p">()[</span><span class="o">..</span><span class="n">decoded</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>So, what’s the process of turning this into a SIMD version? We want to follow one directive with inexorable, robotic dedication.</p> <p><strong>Eliminate all branches.</strong></p> <p>This is not completely feasible, since the input is of variable length. But we can try. There are several branches in this code:</p> <ol> <li>The <code class="language-plaintext highlighter-rouge">for chunk in</code> line. This one is is the length check: it checks if there is any data left to process.</li> <li>The <code class="language-plaintext highlighter-rouge">for &amp;byte in</code> line. This is the hottest loop: it branches once per input byte.</li> <li>The <code class="language-plaintext highlighter-rouge">match byte</code> line is several branches, to determine which of the five “valid” match arms we land in.</li> <li>The <code class="language-plaintext highlighter-rouge">return Err</code> line. Returning in a hot loop is extra control flow, which is not ideal.</li> <li>The call to <code class="language-plaintext highlighter-rouge">decoded_len</code> contains a <code class="language-plaintext highlighter-rouge">match</code>, which generates branches.</li> <li>The call to <code class="language-plaintext highlighter-rouge">Vec::extend_from_slice</code>. This contains not just branches, but potential calls into the allocator. Extremely slow.</li> </ol> <p>(5) is the easiest to deal with. The <code class="language-plaintext highlighter-rouge">match</code> is mapping the values <code class="language-plaintext highlighter-rouge">0, 1, 2, 3</code> to <code class="language-plaintext highlighter-rouge">0, 1, 1, 2</code>. Call this function <code class="language-plaintext highlighter-rouge">f</code>. Then, the sequence given by <code class="language-plaintext highlighter-rouge">x - f(x)</code> is <code class="language-plaintext highlighter-rouge">0, 0, 1, 1</code>. This just happens to equal <code class="language-plaintext highlighter-rouge">x / 2</code> (or <code class="language-plaintext highlighter-rouge">x &gt;&gt; 1</code>), so we can write a completely branchless version of <code class="language-plaintext highlighter-rouge">decoded_len</code> like so.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">pub</span> <span class="k">fn</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
  <span class="k">let</span> <span class="n">mod4</span> <span class="o">=</span> <span class="n">input</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">input</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">mod4</span> <span class="o">-</span> <span class="n">mod4</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj ZSI6InB1YiBmbiBkZWNvZGVkX2xlbihpbnB1dDogdXNpemUpIC0+IHVzaXpl IHtcbiAgbGV0IG1vZDQgPSBpbnB1dCAlIDQ7XG4gIGlucHV0IC8gNCAqIDMg KyAobW9kNCAtIG1vZDQgLyAyKVxufSIsImNvbXBpbGVycyI6W3siaWQiOiJi ZXRhIiwib3B0aW9ucyI6Ii1PIn1dfV19 ">godbolt</a><div class="codeblock-button">Rust</div></div></div> <p>That’s one branch eliminated<sup id="fnref:why-cant-llvm-do-it" role="doc-noteref"><a href="#fn:why-cant-llvm-do-it" class="footnote" rel="footnote">4</a></sup>. ✅</p> <p>The others will not prove so easy. Let’s turn our attention to the innermost loop next, branches (2), (3), and (4).</p> <h3 id="the-hottest-loop"><a href="#the-hottest-loop">The Hottest Loop</a></h3> <p>The superpower of SIMD is that because you operate on so much data at a time, you can unroll the loop so hard it becomes branchless.</p> <p>The insight is this: we want to load at most four bytes, do something to them, and then spit out at most three decoded bytes. While doing this operation, we may encounter a syntax error so we need to report that somehow.</p> <p>Here’s some facts we can take advantage of.</p> <ol> <li>We don’t need to figure out how many bytes are in the “output” of the hot loop: our handy branchless <code class="language-plaintext highlighter-rouge">decoded_len()</code> does that for us.</li> <li>Invalid base64 is extremely rare. We want that syntax error to cost as little as possible. If the user still cares about which byte was the problem, they can scan the input for it after the fact.</li> <li><code class="language-plaintext highlighter-rouge">A</code> is zero in base64. If we’re parsing a truncated chunk, padding it with <code class="language-plaintext highlighter-rouge">A</code> won’t change the value<sup id="fnref:pad-with-A" role="doc-noteref"><a href="#fn:pad-with-A" class="footnote" rel="footnote">5</a></sup>.</li> </ol> <p>This suggests an interface for the body of the “hottest loop”. We can factor it out as a separate function, and simplify since we can assume our input is always four bytes now.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">decode_hot</span><span class="p">(</span><span class="n">ascii</span><span class="p">:</span> <span class="p">[</span><span class="nb">u8</span><span class="p">;</span> <span class="mi">4</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="p">([</span><span class="nb">u8</span><span class="p">;</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0u32</span><span class="p">;</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">ok</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">byte</span> <span class="k">in</span> <span class="n">ascii</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">sextet</span> <span class="o">=</span> <span class="k">match</span> <span class="n">byte</span> <span class="p">{</span>
      <span class="sc">b'A'</span><span class="o">..=</span><span class="sc">b'Z'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'A'</span><span class="p">,</span>
      <span class="sc">b'a'</span><span class="o">..=</span><span class="sc">b'z'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'a'</span> <span class="o">+</span> <span class="mi">26</span><span class="p">,</span>
      <span class="sc">b'0'</span><span class="o">..=</span><span class="sc">b'9'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'0'</span> <span class="o">+</span> <span class="mi">52</span><span class="p">,</span>
      <span class="sc">b'+'</span> <span class="k">=&gt;</span> <span class="mi">62</span><span class="p">,</span>
      <span class="sc">b'/'</span> <span class="k">=&gt;</span> <span class="mi">63</span><span class="p">,</span>
      <span class="n">_</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="n">bytes</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">bytes</span> <span class="p">|</span><span class="o">=</span> <span class="n">sextet</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">&amp;=</span> <span class="n">byte</span> <span class="o">==</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// This is the `to_be_bytes()` call.</span>
  <span class="k">let</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes</span><span class="nf">.to_le_bytes</span><span class="p">();</span>
  <span class="p">([</span><span class="n">b3</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b1</span><span class="p">],</span> <span class="n">ok</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// In decode()...</span>
<span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">data</span><span class="nf">.chunks</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">ascii</span> <span class="o">=</span> <span class="p">[</span><span class="sc">b'A'</span><span class="p">;</span> <span class="mi">4</span><span class="p">];</span>
  <span class="n">ascii</span><span class="p">[</span><span class="o">..</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">()]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>

  <span class="k">let</span> <span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span> <span class="o">=</span> <span class="nf">decode_hot</span><span class="p">(</span><span class="n">ascii</span><span class="p">);</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="n">Error</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">());</span>
  <span class="n">out</span><span class="nf">.extend_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">[</span><span class="o">..</span><span class="n">decoded</span><span class="p">]);</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>You’re probably thinking: why not return <code class="language-plaintext highlighter-rouge">Option&lt;[u8; 3]&gt;</code>? Returning an enum will make it messier to eliminate the <code class="language-plaintext highlighter-rouge">if !ok</code> branch later on (which we will!). We want to write branchless code, so let’s focus on finding a way of producing that three-byte output without needing to do early returns.</p> <p>Now’s when we want to start talking about vectors rather than arrays, so let’s try to rewrite our function as such.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">decode_hot</span><span class="p">(</span><span class="n">ascii</span><span class="p">:</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="nd">unimplemented!</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Note that the output is now four bytes, not three. SIMD lane counts need to be powers of two, and that last element will never get looked at, so we don’t need to worry about what winds up there.</p> <p>The callsite also needs to be tweaked, but only slightly, because <code class="language-plaintext highlighter-rouge">Simd&lt;u8, 4&gt;</code> is <code class="language-plaintext highlighter-rouge">From&lt;[u8; 4]&gt;</code>.</p> <h3 id="ascii-to-sextet"><a href="#ascii-to-sextet">ASCII to Sextet</a></h3> <p>Let’s look at the first part of the <code class="language-plaintext highlighter-rouge">for byte in ascii</code> loop. We need to map each lane of the <code class="language-plaintext highlighter-rouge">Simd&lt;u8, 4&gt;</code> to the corresponding sextet, and somehow signal which ones are invalid. First, notice something special about the <code class="language-plaintext highlighter-rouge">match</code>: almost every arm can be written as <code class="language-plaintext highlighter-rouge">byte - C</code> for some constant <code class="language-plaintext highlighter-rouge">C</code>. The non-range case looks a little silly, but humor me:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">sextet</span> <span class="o">=</span> <span class="k">match</span> <span class="n">byte</span> <span class="p">{</span>
  <span class="sc">b'A'</span><span class="o">..=</span><span class="sc">b'Z'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'A'</span><span class="p">,</span>
  <span class="sc">b'a'</span><span class="o">..=</span><span class="sc">b'z'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'a'</span> <span class="o">+</span> <span class="mi">26</span><span class="p">,</span>
  <span class="sc">b'0'</span><span class="o">..=</span><span class="sc">b'9'</span> <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'0'</span> <span class="o">+</span> <span class="mi">52</span><span class="p">,</span>
  <span class="sc">b'+'</span>        <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'+'</span> <span class="o">+</span> <span class="mi">62</span><span class="p">,</span>
  <span class="sc">b'/'</span>        <span class="k">=&gt;</span> <span class="n">byte</span> <span class="o">-</span> <span class="sc">b'/'</span> <span class="o">+</span> <span class="mi">63</span><span class="p">,</span>
  <span class="n">_</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>So, it should be sufficient to build a vector <code class="language-plaintext highlighter-rouge">offsets</code> that contains the appropriate constant <code class="language-plaintext highlighter-rouge">C</code> for each lane, and then <code class="language-plaintext highlighter-rouge">let sextets = ascii - offsets;</code></p> <p>How can we build <code class="language-plaintext highlighter-rouge">offsets</code>? Using compare-and-select.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c1">// A lane-wise version of `x &gt;= start &amp;&amp; x &lt;= end`.</span>
<span class="k">fn</span> <span class="nf">in_range</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">u8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Mask</span><span class="o">&lt;</span><span class="nb">i8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">bytes</span><span class="nf">.simd_ge</span><span class="p">(</span><span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="n">start</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">bytes</span><span class="nf">.simd_le</span><span class="p">(</span><span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Create masks for each of the five ranges.</span>
<span class="c1">// Note that these are disjoint: for any two masks, m1 &amp; m2 == 0.</span>
<span class="k">let</span> <span class="n">uppers</span> <span class="o">=</span> <span class="nf">in_range</span><span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="sc">b'A'</span><span class="p">,</span> <span class="sc">b'Z'</span><span class="p">);</span>
<span class="k">let</span> <span class="n">lowers</span> <span class="o">=</span> <span class="nf">in_range</span><span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="sc">b'a'</span><span class="p">,</span> <span class="sc">b'z'</span><span class="p">);</span>
<span class="k">let</span> <span class="n">digits</span> <span class="o">=</span> <span class="nf">in_range</span><span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="sc">b'0'</span><span class="p">,</span> <span class="sc">b'9'</span><span class="p">);</span>
<span class="k">let</span> <span class="n">pluses</span> <span class="o">=</span> <span class="n">ascii</span><span class="nf">.simd_eq</span><span class="p">([</span><span class="sc">b'+'</span><span class="p">;</span> <span class="n">N</span><span class="p">]</span><span class="nf">.into</span><span class="p">());</span>
<span class="k">let</span> <span class="n">solidi</span> <span class="o">=</span> <span class="n">ascii</span><span class="nf">.simd_eq</span><span class="p">([</span><span class="sc">b'/'</span><span class="p">;</span> <span class="n">N</span><span class="p">]</span><span class="nf">.into</span><span class="p">());</span>

<span class="c1">// If any byte was invalid, none of the masks will select for it,</span>
<span class="c1">// so that lane will be 0 in the or of all the masks. This is our</span>
<span class="c1">// validation check.</span>
<span class="k">let</span> <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">uppers</span> <span class="p">|</span> <span class="n">lowers</span> <span class="p">|</span> <span class="n">digits</span> <span class="p">|</span> <span class="n">pluses</span> <span class="p">|</span> <span class="n">solidi</span><span class="p">)</span><span class="nf">.all</span><span class="p">();</span>

<span class="c1">// Given a mask, create a new vector by splatting `value`</span>
<span class="c1">// over the set lanes.</span>
<span class="k">fn</span> <span class="nf">masked_splat</span><span class="p">(</span><span class="n">mask</span><span class="p">:</span> <span class="n">Mask</span><span class="o">&lt;</span><span class="nb">i8</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">i8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="nb">i8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">mask</span><span class="nf">.select</span><span class="p">(</span><span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Fill the the lanes of the offset vector by filling the</span>
<span class="c1">// set lanes with the corresponding offset. This is like</span>
<span class="c1">// a "vectorized" version of the `match`.</span>
<span class="k">let</span> <span class="n">offsets</span> <span class="o">=</span> <span class="nf">masked_splat</span><span class="p">(</span><span class="n">uppers</span><span class="p">,</span>  <span class="mi">65</span><span class="p">)</span>
            <span class="p">|</span> <span class="nf">masked_splat</span><span class="p">(</span><span class="n">lowers</span><span class="p">,</span>  <span class="mi">71</span><span class="p">)</span>
            <span class="p">|</span> <span class="nf">masked_splat</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span>  <span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">|</span> <span class="nf">masked_splat</span><span class="p">(</span><span class="n">pluses</span><span class="p">,</span> <span class="o">-</span><span class="mi">19</span><span class="p">)</span>
            <span class="p">|</span> <span class="nf">masked_splat</span><span class="p">(</span><span class="n">solidi</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">);</span>

<span class="c1">// Finally, Build the sextets vector.</span>
<span class="k">let</span> <span class="n">sextets</span> <span class="o">=</span> <span class="n">ascii</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">i8</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This solution is quite elegant, and will produce very competitive code, but it’s not actually ideal. We need to do a lot of comparisons here: eight in total. We also keep lots of values alive at the same time, which might lead to unwanted register pressure.</p> <h3 id="simd-hash-table"><a href="#simd-hash-table">SIMD Hash Table</a></h3> <p>Let’s look at the byte representations of the ranges. <code class="language-plaintext highlighter-rouge">A-Z</code>, <code class="language-plaintext highlighter-rouge">a-z</code>, and <code class="language-plaintext highlighter-rouge">0-9</code> are, as byte ranges, <code class="language-plaintext highlighter-rouge">0x41..0x5b</code>, <code class="language-plaintext highlighter-rouge">0x61..0x7b</code>, and <code class="language-plaintext highlighter-rouge">0x30..0x3a</code>. Notice they all have different high nybbles! What’s more, <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">/</code> are <code class="language-plaintext highlighter-rouge">0x2b</code> and <code class="language-plaintext highlighter-rouge">0x2f</code>, so the function <code class="language-plaintext highlighter-rouge">byte &gt;&gt; 4</code> is <em>almost</em> enough to distinguish all the ranges. If we subtract one if <code class="language-plaintext highlighter-rouge">byte == b'/'</code>, we have a <em>perfect hash</em> for the ranges.</p> <p>In other words, the value <code class="language-plaintext highlighter-rouge">(byte &gt;&gt; 4) - (byte == '/')</code> maps the ranges as follows:</p> <ul> <li><code class="language-plaintext highlighter-rouge">A-Z</code> goes to 4 or 5.</li> <li><code class="language-plaintext highlighter-rouge">a-z</code> goes to 6 or 7.</li> <li><code class="language-plaintext highlighter-rouge">0-9</code> goes to 3.</li> <li><code class="language-plaintext highlighter-rouge">+</code> goes to 2.</li> <li><code class="language-plaintext highlighter-rouge">/</code> goes to 1.</li> </ul> <p>This is small enough that we could cram a lookup table of values for building the <code class="language-plaintext highlighter-rouge">offsets</code> vector into another SIMD vector, and use a shuffle operation to do the lookup.</p> <p>This is not my original idea; I came across a <a href="https://github.com/WojciechMula/base64simd/issues/3">GitHub issue</a> where an anonymous user points out this perfect hash.</p> <p>Our new ascii-to-sextet code looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c1">// Compute the perfect hash for each lane.</span>
<span class="k">let</span> <span class="n">hashes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ascii</span> <span class="o">&gt;&gt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
  <span class="o">+</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">simd_eq</span><span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="sc">b'/'</span><span class="p">))</span>
    <span class="nf">.to_int</span><span class="p">()</span>  <span class="c1">// to_int() is equivalent to masked_splat(-1, 0).</span>
    <span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>

<span class="c1">// Look up offsets based on each hash and subtract them from `ascii`.</span>
<span class="k">let</span> <span class="n">sextets</span> <span class="o">=</span> <span class="n">ascii</span>
    <span class="c1">// This lookup table corresponds to the offsets we used to build the</span>
    <span class="c1">// `offsets` vector in the previous implementation, placed in the</span>
    <span class="c1">// indices that the perfect hash produces.</span>
  <span class="o">-</span> <span class="nn">Simd</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">i8</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">from</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">])</span>
    <span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="nf">.swizzle_dyn</span><span class="p">(</span><span class="n">hashes</span><span class="p">);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>There is a small wrinkle here: <a href="https://doc.rust-lang.org/std/simd/struct.Simd.html#method.swizzle_dyn"><code class="language-plaintext highlighter-rouge">Simd::swizzle_dyn()</code></a> requires that the index array be the same length as the lookup table. This is annoying because right now <code class="language-plaintext highlighter-rouge">ascii</code> is a <code class="language-plaintext highlighter-rouge">Simd&lt;u8, 4&gt;</code>, but that will not be the case later on, so I will simply sweep this under the rug.</p> <p>Note that we no longer get validation as a side-effect of computing the sextets vector. The same GitHub issue also provides an exact bloom-filter for checking that a particular byte is valid; you can see my implementation <a href="https://github.com/mcy/vb64/blob/894f833e933860e070dabcfcc189430c45fecbd7/src/simd.rs#L93">here</a>. I’m not sure how the OP constructed the bloom filter, but the search space is small enough that you could have written a little script to brute force it.</p> <h3 id="riffling-the-sextets"><a href="#riffling-the-sextets">Riffling the Sextets</a></h3> <p>Now comes a much tricker operation: we need to somehow pack all four sextets into three bytes. One way to try to wrap our head around what the packing code in <code class="language-plaintext highlighter-rouge">decode_hot()</code> is doing is to pass in the all-ones sextet in one of the four bytes, and see where those ones end up in the return value.</p> <p>This is not unlike how they use radioactive dyes in biology to track the moment of molecules or cells through an organism.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">bits</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
  <span class="k">let</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="nf">.reverse_bits</span><span class="p">()</span><span class="nf">.to_le_bytes</span><span class="p">();</span>
  <span class="nd">format!</span><span class="p">(</span><span class="s">"{b1:08b} {b2:08b} {b3:08b} {b4:08b}"</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">decode_pack</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="p">[</span><span class="nb">u8</span><span class="p">;</span> <span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">output</span> <span class="o">=</span> <span class="mi">0u32</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">byte</span> <span class="k">in</span> <span class="n">input</span> <span class="p">{</span>
    <span class="n">output</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">output</span> <span class="p">|</span><span class="o">=</span> <span class="n">byte</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">output</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>

  <span class="nd">println!</span><span class="p">(</span><span class="s">"{}</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="nf">bits</span><span class="p">(</span><span class="nn">u32</span><span class="p">::</span><span class="nf">from_be_bytes</span><span class="p">(</span><span class="n">input</span><span class="p">)),</span> <span class="nf">bits</span><span class="p">(</span><span class="n">output</span><span class="p">));</span>
<span class="p">}</span>

<span class="nf">decode_pack</span><span class="p">([</span><span class="mi">0b111111</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
<span class="nf">decode_pack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0b111111</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
<span class="nf">decode_pack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0b111111</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
<span class="nf">decode_pack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0b111111</span><span class="p">]);</span>

<span class="c1">// Output:</span>
<span class="c1">// 11111100 00000000 00000000 00000000</span>
<span class="c1">// 00111111 00000000 00000000 00000000</span>
<span class="c1">//</span>
<span class="c1">// 00000000 11111100 00000000 00000000</span>
<span class="c1">// 11000000 00001111 00000000 00000000</span>
<span class="c1">//</span>
<span class="c1">// 00000000 00000000 11111100 00000000</span>
<span class="c1">// 00000000 11110000 00000011 00000000</span>
<span class="c1">//</span>
<span class="c1">// 00000000 00000000 00000000 11111100</span>
<span class="c1">// 00000000 00000000 11111100 00000000</span></code></pre></figure><div class="codeblock-buttons"><a class="codeblock-button godbolt" href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siaWQiOjEsImxhbmd1YWdlIjoicnVzdCIsInNvdXJj ZSI6InB1YiBmbiBtYWluKCkge1xuZm4gYml0cyh2YWx1ZTogdTMyKSAtPiBT dHJpbmcge1xuICBsZXQgW2IxLCBiMiwgYjMsIGI0XSA9IHZhbHVlLnJldmVy c2VfYml0cygpLnRvX2xlX2J5dGVzKCk7XG4gIGZvcm1hdCEoXCJ7YjE6MDhi fSB7YjI6MDhifSB7YjM6MDhifSB7YjQ6MDhifVwiKVxufVxuXG5mbiBkZWNv ZGVfcGFjayhpbnB1dDogW3U4OyA0XSkge1xuICBsZXQgbXV0IG91dHB1dCA9 IDB1MzI7XG4gIGZvciBieXRlIGluIGlucHV0IHtcbiAgICBvdXRwdXQgPDw9 IDY7XG4gICAgb3V0cHV0IHw9IGJ5dGUgYXMgdTMyO1xuICB9XG4gIG91dHB1 dCA8PD0gODtcblxuICBwcmludGxuIShcInt9XFxue31cXG5cIiwgYml0cyh1 MzI6OmZyb21fYmVfYnl0ZXMoaW5wdXQpKSwgYml0cyhvdXRwdXQpKTtcbn1c blxuZGVjb2RlX3BhY2soWzBiMTExMTExLCAwLCAwLCAwXSk7XG5kZWNvZGVf cGFjayhbMCwgMGIxMTExMTEsIDAsIDBdKTtcbmRlY29kZV9wYWNrKFswLCAw LCAwYjExMTExMSwgMF0pO1xuZGVjb2RlX3BhY2soWzAsIDAsIDAsIDBiMTEx MTExXSk7XG5cbi8vIE91dHB1dDpcbi8vIDExMTExMTAwIDAwMDAwMDAwIDAw MDAwMDAwIDAwMDAwMDAwXG4vLyAwMDExMTExMSAwMDAwMDAwMCAwMDAwMDAw MCAwMDAwMDAwMFxuLy9cbi8vIDAwMDAwMDAwIDExMTExMTAwIDAwMDAwMDAw IDAwMDAwMDAwXG4vLyAxMTAwMDAwMCAwMDAwMTExMSAwMDAwMDAwMCAwMDAw MDAwMFxuLy9cbi8vIDAwMDAwMDAwIDAwMDAwMDAwIDExMTExMTAwIDAwMDAw MDAwXG4vLyAwMDAwMDAwMCAxMTExMDAwMCAwMDAwMDAxMSAwMDAwMDAwMFxu Ly9cbi8vIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDExMTExMTAwXG4v LyAwMDAwMDAwMCAwMDAwMDAwMCAxMTExMTEwMCAwMDAwMDAwMFxufVxuIiwi Y29tcGlsZXJzIjpbXSwiZXhlY3V0b3JzIjpbeyJjb21waWxlclZpc2libGUi OmZhbHNlLCJjb21waWxlck91dHB1dFZpc2libGUiOnRydWUsImNvbXBpbGVy Ijp7ImlkIjoiYmV0YSIsIm9wdGlvbnMiOiIifX1dfV19 ">godbolt</a><div class="codeblock-button">Rust</div></div></div> <p>Bingo. Playing around with the inputs lets us verify which pieces of the bytes wind up where. For example, by passing <code class="language-plaintext highlighter-rouge">0b110000</code> as <code class="language-plaintext highlighter-rouge">input[1]</code>, we see that the two high bits of <code class="language-plaintext highlighter-rouge">input[1]</code> correspond to the low bits of <code class="language-plaintext highlighter-rouge">output[0]</code>. I’ve written the code so that the bits in each byte are printed in little-endian order, so bits on the left are the low bits.</p> <p>Putting this all together, we can draw a schematic of what this operation does to a general <code class="language-plaintext highlighter-rouge">Simd&lt;u8, 4&gt;</code>.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/riffle.png" alt="the riffling operation"/></p> <p>Now, there’s no single instruction that will do this for us. Shuffles can be used to move bytes around, but we’re dealing with <em>pieces</em> of bytes here. We also can’t really do a shift, since we need bits that are overshifted to move into adjacent lanes.</p> <p>The trick is to just make the lanes bigger.</p> <p>Among the operations available for SIMD vectors are lane-wise casts, which allow us to zero-extend, sign-extend, or truncate each lane. So what we can do is cast <code class="language-plaintext highlighter-rouge">sextets</code> to a vector of <code class="language-plaintext highlighter-rouge">u16</code>, do the shift there and then… somehow put the parts back together?</p> <p>Let’s see how far shifting gets us. How much do we need to shift things by? First, notice that the order of the bits within each chunk that doesn’t cross a byte boundary doesn’t change. For example, the four low bits of <code class="language-plaintext highlighter-rouge">input[1]</code> are in the same order when they become the high bits of <code class="language-plaintext highlighter-rouge">output[1]</code>, and the two high bits of <code class="language-plaintext highlighter-rouge">input[1]</code> are also in the same order when they become the low bits of <code class="language-plaintext highlighter-rouge">output[0]</code>.</p> <p>This means we can determine how far to shift by comparing the bit position of the lowest bit of a byte of <code class="language-plaintext highlighter-rouge">input</code> with the bit position of the corresponding bit in <code class="language-plaintext highlighter-rouge">output</code>.</p> <p><code class="language-plaintext highlighter-rouge">input[0]</code>’s low bit is the third bit of <code class="language-plaintext highlighter-rouge">output[0]</code>, so we need to shift <code class="language-plaintext highlighter-rouge">input[0]</code> by 2. <code class="language-plaintext highlighter-rouge">input[1]</code>’s lowest bit is the fifth bit of <code class="language-plaintext highlighter-rouge">output[1]</code>, so we need to shift by 4. Analogously, the shifts for <code class="language-plaintext highlighter-rouge">input[2]</code> and <code class="language-plaintext highlighter-rouge">input[3]</code> turn out to be 6 and 0. In code:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">sextets</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="k">let</span> <span class="n">shifted</span> <span class="o">=</span> <span class="n">sextets</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u16</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">from</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>So now we have a <code class="language-plaintext highlighter-rouge">Simd&lt;u16, 4&gt;</code> that contains the individual chunks that we need to move around, in the high and low bytes of each <code class="language-plaintext highlighter-rouge">u16</code>, which we can think of as being analogous to a <code class="language-plaintext highlighter-rouge">[[u8; 2]; 4]</code>. For example, <code class="language-plaintext highlighter-rouge">shifted[0][0]</code> contains <code class="language-plaintext highlighter-rouge">sextet[0]</code>, but shifted. This corresponds to the red segment in the first schematic. The smaller blue segment is given by <code class="language-plaintext highlighter-rouge">shifted[1][1]</code>, i.e., the high byte of the second <code class="language-plaintext highlighter-rouge">u16</code>. It’s already in the right place within that byte, so we want <code class="language-plaintext highlighter-rouge">output[0] = shifted[0][0] | shifted[1][1]</code>.</p> <p>This suggests a more general strategy: we want to take two vectors, the low bytes and the high bytes of each <code class="language-plaintext highlighter-rouge">u16</code> in <code class="language-plaintext highlighter-rouge">shifted</code>, respectively, and somehow shuffle them so that when or’ed together, they give the desired output.</p> <p>Look at the schematic again: if we had a vector consisting of <code class="language-plaintext highlighter-rouge">[..aaaaaa, ....bbbb, ......cc]</code>, we could or it with a vector like <code class="language-plaintext highlighter-rouge">[bb......, cccc...., dddddd..]</code> to get the desired result.</p> <p>One problem: <code class="language-plaintext highlighter-rouge">dddddd..</code> is <code class="language-plaintext highlighter-rouge">shifted[3][0]</code>, i.e., it’s a low byte. If we change the vector we shift by to <code class="language-plaintext highlighter-rouge">[2, 4, 6, 8]</code>, though, it winds up in <code class="language-plaintext highlighter-rouge">shifted[3][1]</code>, since it’s been shifted up by <code class="language-plaintext highlighter-rouge">8</code> bits: a full byte.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c1">// Split shifted into low byte and high byte vectors.</span>
<span class="c1">// Same way you'd split a single u16 into bytes, but lane-wise.</span>
<span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">shifted</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>
<span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">shifted</span> <span class="o">&gt;&gt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">from</span><span class="p">([</span><span class="mi">8</span><span class="p">;</span> <span class="mi">4</span><span class="p">]))</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>

<span class="c1">// Align the lanes: we want to get shifted[0][0] | shifted[1][1],</span>
<span class="c1">// shifted[1][0] | shifted[2][1], etc.</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="n">hi</span><span class="py">.rotate_lanes_left</span><span class="p">::</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">();</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Et voila, here is our new, totally branchless implementation of <code class="language-plaintext highlighter-rouge">decode_hot()</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">decode_hot</span><span class="p">(</span><span class="n">ascii</span><span class="p">:</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="n">hashes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ascii</span> <span class="o">&gt;&gt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="o">+</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">simd_eq</span><span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="sc">b'/'</span><span class="p">))</span>
      <span class="nf">.to_int</span><span class="p">()</span>
      <span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="k">let</span> <span class="n">sextets</span> <span class="o">=</span> <span class="n">ascii</span>
    <span class="o">-</span> <span class="nn">Simd</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">i8</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">from</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">])</span>
      <span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">()</span>
      <span class="nf">.swizzle_dyn</span><span class="p">(</span><span class="n">hashes</span><span class="p">);</span>  <span class="c1">// Note quite right yet, see next section.</span>

  <span class="k">let</span> <span class="n">ok</span> <span class="o">=</span> <span class="cm">/* bloom filter shenanigans */</span><span class="p">;</span>

  <span class="k">let</span> <span class="n">shifted</span> <span class="o">=</span> <span class="n">sextets</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u16</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">from</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]);</span>
  <span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">shifted</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">shifted</span> <span class="o">&gt;&gt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="n">hi</span><span class="py">.rotate_lanes_left</span><span class="p">::</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The compactness of this solution should not be understated. The simplicity of this solution is a large part of what makes it so efficient, because it aggressively leverages the primitives the hardware offers us.</p> <h3 id="scaling-up"><a href="#scaling-up">Scaling Up</a></h3> <p>Ok, so now we have to contend with a new aspect of our implementation that’s crap: a <code class="language-plaintext highlighter-rouge">Simd&lt;u8, 4&gt;</code> is tiny. That’s not even 128 bits, which are the smallest vector registers on x86. What we need to do is make <code class="language-plaintext highlighter-rouge">decode_hot()</code> generic on the lane count. This will allow us to tune the number of lanes to batch together depending on benchmarks later on.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">decode_hot</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ascii</span><span class="p">:</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
<span class="k">where</span>
  <span class="c1">// This makes sure N is a small power of 2.</span>
  <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="k">let</span> <span class="n">hashes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ascii</span> <span class="o">&gt;&gt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="o">+</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">simd_eq</span><span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="sc">b'/'</span><span class="p">))</span>
      <span class="nf">.to_int</span><span class="p">()</span>
      <span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="k">let</span> <span class="n">sextets</span> <span class="o">=</span> <span class="n">ascii</span>
    <span class="o">-</span> <span class="nf">tiled</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">])</span>
      <span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">()</span>
      <span class="nf">.swizzle_dyn</span><span class="p">(</span><span class="n">hashes</span><span class="p">);</span>  <span class="c1">// Works fine now, as long as N &gt;= 8.</span>

  <span class="k">let</span> <span class="n">ok</span> <span class="o">=</span> <span class="cm">/* bloom filter shenanigans */</span><span class="p">;</span>

  <span class="k">let</span> <span class="n">shifted</span> <span class="o">=</span> <span class="n">sextets</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u16</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="nf">tiled</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]);</span>
  <span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">shifted</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">shifted</span> <span class="o">&gt;&gt;</span> <span class="nn">Simd</span><span class="p">::</span><span class="nf">splat</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="n">hi</span><span class="py">.rotate_lanes_left</span><span class="p">::</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span>
<span class="p">}</span>

<span class="cd">/// Generates a new vector made up of repeated "tiles" of identical</span>
<span class="cd">/// data.</span>
<span class="k">const</span> <span class="k">fn</span> <span class="n">tiled</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tile</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span>
<span class="k">where</span>
  <span class="n">T</span><span class="p">:</span> <span class="n">SimdElement</span><span class="p">,</span>
  <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">N</span><span class="p">];</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="p">{</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">tile</span><span class="nf">.len</span><span class="p">()];</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nn">Simd</span><span class="p">::</span><span class="nf">from_array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>We have to change virtually nothing, which is pretty awesome! But unfortunately, this code is subtly incorrect. Remember how in the <code class="language-plaintext highlighter-rouge">N = 4</code> case, the result of <code class="language-plaintext highlighter-rouge">output</code> had a garbage value that we ignore in its highest lane? Well, now that garbage data is interleaved into output: every fourth lane contains garbage.</p> <p>We can use a shuffle to delete these lanes, thankfully. Specifically, we want <code class="language-plaintext highlighter-rouge">shuffled[i] = output[i + i / 3]</code>, which skips every forth index. So, <code class="language-plaintext highlighter-rouge">shuffled[3] = output[4]</code>, skipping over the garbage value in <code class="language-plaintext highlighter-rouge">output[3]</code>. If <code class="language-plaintext highlighter-rouge">i + i / 3</code> overflows <code class="language-plaintext highlighter-rouge">N</code>, that’s ok, because that’s the high quarter of the final output vector, which is ignored anyways. In code:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">decode_hot</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ascii</span><span class="p">:</span> <span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
<span class="k">where</span>
  <span class="c1">// This makes sure N is a small power of 2.</span>
  <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="cm">/* snip */</span>

  <span class="k">let</span> <span class="n">decoded_chunks</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="n">hi</span><span class="py">.rotate_lanes_left</span><span class="p">::</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="nd">swizzle!</span><span class="p">(</span><span class="n">N</span><span class="p">;</span> <span class="n">decoded_chunks</span><span class="p">,</span> <span class="nd">array!</span><span class="p">(</span><span class="n">N</span><span class="p">;</span> <span class="p">|</span><span class="n">i</span><span class="p">|</span> <span class="n">i</span> <span class="o">+</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">3</span><span class="p">));</span>

  <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <blockquote> <p><code class="language-plaintext highlighter-rouge">swizzle!()</code> is a helper macro<sup id="fnref:macros" role="doc-noteref"><a href="#fn:macros" class="footnote" rel="footnote">6</a></sup> for generating generic implementations of <code class="language-plaintext highlighter-rouge">std::simd::Swizzle</code>, and <code class="language-plaintext highlighter-rouge">array!()</code> is something I wrote for generating generic-length array constants; the closure is called once for each <code class="language-plaintext highlighter-rouge">i in 0..N</code>.</p> </blockquote> <p>So now we can decode 32 base64 bytes in parallel by calling <code class="language-plaintext highlighter-rouge">decode_hot::&lt;32&gt;()</code>. We’ll try to keep things generic from here, so we can tune the lane parameter based on benchmarks.</p> <h3 id="the-outer-loop"><a href="#the-outer-loop">The Outer Loop</a></h3> <p>Let’s look at <code class="language-plaintext highlighter-rouge">decode()</code> again. Let’s start by making it generic on the internal lane count, too.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">decode</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span> <span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span>
<span class="k">where</span>
  <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="k">match</span> <span class="n">data</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">p</span> <span class="o">@</span> <span class="o">..</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">]</span> <span class="p">|</span> <span class="p">[</span><span class="n">p</span> <span class="o">@</span> <span class="o">..</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">]</span> <span class="p">|</span> <span class="n">p</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">data</span><span class="nf">.chunks</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// N-sized chunks now.</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">ascii</span> <span class="o">=</span> <span class="p">[</span><span class="sc">b'A'</span><span class="p">;</span> <span class="n">N</span><span class="p">];</span>
    <span class="n">ascii</span><span class="p">[</span><span class="o">..</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">()]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>

    <span class="k">let</span> <span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span> <span class="o">=</span> <span class="nn">decode_hot</span><span class="p">::</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ascii</span><span class="nf">.into</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="n">Error</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">decoded</span> <span class="o">=</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">());</span>
    <span class="n">out</span><span class="nf">.extend_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dec</span><span class="p">[</span><span class="o">..</span><span class="n">decoded</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>What branches are left? There’s still the branch from <code class="language-plaintext highlighter-rouge">for chunks in ...</code>. It’s not ideal because it can’t do an exact pointer comparison, and needs to do a <code class="language-plaintext highlighter-rouge">&gt;=</code> comparison on a length instead.</p> <p>We call <code class="language-plaintext highlighter-rouge">[T]::copy_from_slice</code>, which is super slow because it needs to make a variable-length <code class="language-plaintext highlighter-rouge">memcpy</code> call, which can’t be inlined. Function calls are branches! The bounds checks are also a problem.</p> <p>We branch on <code class="language-plaintext highlighter-rouge">ok</code> every loop iteration, still. Not returning early in <code class="language-plaintext highlighter-rouge">decode_hot</code> doesn’t win us anything (yet).</p> <p>We potentially call the allocator in <code class="language-plaintext highlighter-rouge">extend_from_slice</code>, and perform another non-inline-able <code class="language-plaintext highlighter-rouge">memcpy</code> call.</p> <h3 id="preallocating-with-slop"><a href="#preallocating-with-slop">Preallocating with Slop</a></h3> <p>The last of these is the easiest to address: we can reserve space in <code class="language-plaintext highlighter-rouge">out</code>, since we know exactly how much data we need to write thanks to <code class="language-plaintext highlighter-rouge">decoded_len</code>. Better yet, we can reserve some “slop”: i.e., scratch space past where the end of the message would be, so we can perform full SIMD stores, instead of the variable-length memcpy.</p> <p>This way, in each iteration, we write the full SIMD vector, including any garbage bytes in the upper quarter. Then, the next write is offset <code class="language-plaintext highlighter-rouge">3/4 * N</code> bytes over, so it overwrites the garbage bytes with decoded message bytes. The garbage bytes from the final right get “deleted” by not being included in the final <code class="language-plaintext highlighter-rouge">Vec::set_len()</code> that “commits” the memory we wrote to.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">decode</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span> <span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span>
<span class="k">where</span> <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="k">match</span> <span class="n">data</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">p</span> <span class="o">@</span> <span class="o">..</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">]</span> <span class="p">|</span> <span class="p">[</span><span class="n">p</span> <span class="o">@</span> <span class="o">..</span><span class="p">,</span> <span class="sc">b'='</span><span class="p">]</span> <span class="p">|</span> <span class="n">p</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="k">let</span> <span class="n">final_len</span> <span class="o">=</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
  <span class="n">out</span><span class="nf">.reserve</span><span class="p">(</span><span class="n">final_len</span> <span class="o">+</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>  <span class="c1">// Reserve with slop.</span>

  <span class="c1">// Get a raw pointer to where we should start writing.</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">out</span><span class="nf">.as_mut_ptr_range</span><span class="p">()</span><span class="nf">.end</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

  <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">data</span><span class="nf">.chunks</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// N-sized chunks now.</span>
    <span class="cm">/* snip */</span>

    <span class="k">let</span> <span class="n">decoded</span> <span class="o">=</span> <span class="nf">decoded_len</span><span class="p">(</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">());</span>
    <span class="k">unsafe</span> <span class="p">{</span>
      <span class="c1">// Do a raw write and advance the pointer.</span>
      <span class="n">ptr</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Simd</span><span class="o">&lt;</span><span class="nb">u8</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="nf">.write_unaligned</span><span class="p">(</span><span class="n">dec</span><span class="p">);</span>
      <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.add</span><span class="p">(</span><span class="n">decoded</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">unsafe</span> <span class="p">{</span>
    <span class="c1">// Update the vector's final length.</span>
    <span class="c1">// This is the final "commit".</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.offset_from</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
    <span class="n">out</span><span class="nf">.set_len</span><span class="p">(</span><span class="n">len</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This is safe, because we’ve pre-allocated exactly the amount of memory we need, and where <code class="language-plaintext highlighter-rouge">ptr</code> lands is equal to the amount of memory actually decoded. We could also compute the final length of <code class="language-plaintext highlighter-rouge">out</code> ahead of time.</p> <p>Note that if we early return due to <code class="language-plaintext highlighter-rouge">if !ok</code>, <code class="language-plaintext highlighter-rouge">out</code> remains unmodified, because even though we did write to its buffer, we never execute the “commit” part, so the code remains correct.</p> <h3 id="delaying-failure"><a href="#delaying-failure">Delaying Failure</a></h3> <p>Next up, we can eliminate the <code class="language-plaintext highlighter-rouge">if !ok</code> branches by waiting to return an error until as late as possible: just before the <code class="language-plaintext highlighter-rouge">set_len</code> call.</p> <p>Remember our observation from before: most base64 encoded blobs are valid, so this unhappy path should be very rare. Also, syntax errors cannot cause code that follows to misbehave arbitrarily, so letting it go wild doesn’t hurt anything.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">decode</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span> <span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span>
<span class="k">where</span> <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="cm">/* snip */</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">error</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">data</span><span class="nf">.chunks</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">ascii</span> <span class="o">=</span> <span class="p">[</span><span class="sc">b'A'</span><span class="p">;</span> <span class="n">N</span><span class="p">];</span>
    <span class="n">ascii</span><span class="p">[</span><span class="o">..</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">()]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>

    <span class="k">let</span> <span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span> <span class="o">=</span> <span class="nn">decode_hot</span><span class="p">::</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ascii</span><span class="nf">.into</span><span class="p">());</span>
    <span class="n">error</span> <span class="p">|</span><span class="o">=</span> <span class="o">!</span><span class="n">ok</span><span class="p">;</span>

    <span class="cm">/* snip */</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="n">Error</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">unsafe</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.offset_from</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
    <span class="n">out</span><span class="nf">.set_len</span><span class="p">(</span><span class="n">len</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The branch is still “there”, sure, but it’s out of the hot loop.</p> <p>Because we never hit the <code class="language-plaintext highlighter-rouge">set_len</code> call and commit whatever garbage we wrote, said garbage essentially disappears when we return early, to be overwritten by future calls to <code class="language-plaintext highlighter-rouge">Vec::push()</code>.</p> <h3 id="unroll-it-harder"><a href="#unroll-it-harder">Unroll It Harder</a></h3> <p>Ok, let’s look at the memcpy from <code class="language-plaintext highlighter-rouge">copy_from_slice</code> at the start of the hot loop. The loop has already been partly unrolled: it does <code class="language-plaintext highlighter-rouge">N</code> iterations with SIMD each step, doing something funny on the last step to make up for the missing data (padding with <code class="language-plaintext highlighter-rouge">A</code>).</p> <p>We can take this a step further by doing an “unroll and jam” optimization. This type of unrolling splits the loop into two parts: a hot vectorized loop and a cold remainder part. The hot loop <em>always</em> handles length <code class="language-plaintext highlighter-rouge">N</code> input, and the remainder runs at most once and handles <code class="language-plaintext highlighter-rouge">i &lt; N</code> input.</p> <p>Rust provides an iterator adapter for hand-rolled (lol) unroll-and-jam: <code class="language-plaintext highlighter-rouge">Iterator::chunks_exact()</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="n">decode</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span> <span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span>
<span class="k">where</span> <span class="n">LaneCount</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">SupportedLaneCount</span><span class="p">,</span>
<span class="p">{</span>
  <span class="cm">/* snip */</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">error</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="k">let</span> <span class="k">mut</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.chunks_exact</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">chunks</span> <span class="p">{</span>
    <span class="c1">// Simd::from_slice() can do a load in one instruction.</span>
    <span class="c1">// The bounds check is easy for the compiler to elide.</span>
    <span class="k">let</span> <span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span> <span class="o">=</span> <span class="nn">decode_hot</span><span class="p">::</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="nn">Simd</span><span class="p">::</span><span class="nf">from_slice</span><span class="p">(</span><span class="n">chunk</span><span class="p">));</span>
    <span class="n">error</span> <span class="p">|</span><span class="o">=</span> <span class="o">!</span><span class="n">ok</span><span class="p">;</span>
    <span class="cm">/* snip */</span>
  <span class="p">}</span>

  <span class="k">let</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">chunks</span><span class="nf">.remainder</span><span class="p">();</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">rest</span><span class="nf">.empty</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">ascii</span> <span class="o">=</span> <span class="p">[</span><span class="sc">b'A'</span><span class="p">;</span> <span class="n">N</span><span class="p">];</span>
    <span class="n">ascii</span><span class="p">[</span><span class="o">..</span><span class="n">chunk</span><span class="nf">.len</span><span class="p">()]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>

    <span class="k">let</span> <span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span> <span class="o">=</span> <span class="nn">decode_hot</span><span class="p">::</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ascii</span><span class="nf">.into</span><span class="p">());</span>
    <span class="cm">/* snip */</span>
  <span class="p">}</span>

  <span class="cm">/* snip */</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Splitting into two parts lets us call <code class="language-plaintext highlighter-rouge">Simd::from_slice()</code>, which performs a single, vector-sized load.</p> <h2 id="so-how-fast-is-it"><a href="#so-how-fast-is-it">So, How Fast Is It?</a></h2> <p>At this point, it looks like we’ve addressed every branch that we can, so some benchmarks are in order. I wrote a benchmark that decodes messages of every length from 0 to something like 200 or 500 bytes, and compared it against the baseline base64 implementation on crates.io.</p> <p>I compiled with <code class="language-plaintext highlighter-rouge">-Zbuild-std</code> and <code class="language-plaintext highlighter-rouge">-Ctarget-cpu=native</code> to try to get the best results. Based on some tuning, <code class="language-plaintext highlighter-rouge">N = 32</code> was the best length, since it used one YMM register for each iteration of the hot loop.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/graph-old.png" alt="a performance graph; our code is really good compared to the baseline, but variance is high"/></p> <p>So, we have the baseline beat. But what’s up with that crazy heartbeat waveform? You can tell it has something to do with the “remainder” part of the loop, since it correlates strongly with <code class="language-plaintext highlighter-rouge">data.len() % 32</code>.</p> <p>I stared at the assembly for a while. I don’t remember what was there, but I think that <code class="language-plaintext highlighter-rouge">copy_from_slice</code> had been inlined and unrolled into a loop that loaded each byte at a time. The moral equivalent of this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">ascii</span> <span class="o">=</span> <span class="p">[</span><span class="sc">b'A'</span><span class="p">;</span> <span class="n">N</span><span class="p">];</span>
<span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">in</span> <span class="nn">Iterator</span><span class="p">::</span><span class="nf">zip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>I decided to try <code class="language-plaintext highlighter-rouge">Simd::gather_or()</code>, which is kind of like a “vectorized load”. It wound up producing worse assembly, so I gave up on using a gather and instead wrote a carefully optimized loading function by hand.</p> <h3 id="unroll-and-jam-revisited"><a href="#unroll-and-jam-revisited">Unroll and Jam, Revisited</a></h3> <p>The idea here is to perform the largest scalar loads Rust offers where possible. The strategy is again unroll and jam: perform <code class="language-plaintext highlighter-rouge">u128</code> loads in a loop and deal with the remainder separately.</p> <p>The hot part looks like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="sc">b'A'</span><span class="p">;</span> <span class="n">N</span><span class="p">];</span>

<span class="c1">// Load a bunch of big 16-byte chunks. LLVM will lower these to XMM loads.</span>
<span class="k">let</span> <span class="n">ascii_ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="nf">.as_mut_ptr</span><span class="p">();</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">write_at</span> <span class="o">=</span> <span class="n">ascii_ptr</span><span class="p">;</span>
<span class="k">if</span> <span class="n">slice</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">slice</span><span class="nf">.len</span><span class="p">()</span> <span class="o">/</span> <span class="mi">16</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span>
      <span class="n">write_at</span> <span class="o">=</span> <span class="n">write_at</span><span class="nf">.add</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

      <span class="k">let</span> <span class="n">word</span> <span class="o">=</span> <span class="n">slice</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u128</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="nf">.read_unaligned</span><span class="p">();</span>
      <span class="n">write_at</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u128</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.write_unaligned</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The cold part seems hard to optimize at first. What’s the least number of unaligned loads you need to do to load 15 bytes from memory? It’s two! You can load a <code class="language-plaintext highlighter-rouge">u64</code> from <code class="language-plaintext highlighter-rouge">p</code>, and then another one from <code class="language-plaintext highlighter-rouge">p + 7</code>; these loads (call them <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code>) overlap by one byte, but we can or them together to merge that byte, so our loaded value is <code class="language-plaintext highlighter-rouge">a as u128 | (b as u128 &lt;&lt; 56)</code>.</p> <p>A similar trick works if the data to load is between a <code class="language-plaintext highlighter-rouge">u32</code> and a <code class="language-plaintext highlighter-rouge">u64</code>. Finally, to load 1, 2, or 3 bytes, we can load <code class="language-plaintext highlighter-rouge">p</code>, <code class="language-plaintext highlighter-rouge">p + len/2</code> and <code class="language-plaintext highlighter-rouge">p + len-1</code>; depending on whether <code class="language-plaintext highlighter-rouge">len</code> is 1, 2, or 3, this will potentially load the same byte multiple times; however, this reduces the number of branches necessary, since we don’t need to distinguish the 1, 2, or 3 lines.</p> <p>This is the kind of code that’s probably easier to read than to explain.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">unsafe</span> <span class="p">{</span>
  <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">slice</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.offset</span><span class="p">(</span><span class="n">write_at</span><span class="nf">.offset_from</span><span class="p">(</span><span class="n">ascii_ptr</span><span class="p">));</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">slice</span><span class="nf">.len</span><span class="p">()</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>

  <span class="k">if</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="p">{</span>
    <span class="c1">// Load two overlapping u64s.</span>
    <span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">ptr</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u64</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.read_unaligned</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u128</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.add</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u64</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.read_unaligned</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u128</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>

    <span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="nn">u128</span><span class="p">::</span><span class="nf">from_ne_bytes</span><span class="p">([</span><span class="sc">b'A'</span><span class="p">;</span> <span class="mi">16</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">write_at</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u128</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.write_unaligned</span><span class="p">(</span><span class="n">data</span> <span class="p">|</span> <span class="n">z</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="p">{</span>
    <span class="c1">// Load two overlapping u32s.</span>
    <span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">ptr</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.read_unaligned</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u64</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.add</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.read_unaligned</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u64</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>

    <span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="nn">u64</span><span class="p">::</span><span class="nf">from_ne_bytes</span><span class="p">([</span><span class="sc">b'A'</span><span class="p">;</span> <span class="mi">8</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">write_at</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u64</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.write_unaligned</span><span class="p">(</span><span class="n">data</span> <span class="p">|</span> <span class="n">z</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Load 3 overlapping u8s.</span>

    <span class="c1">// For len       1       2       3     ...</span>
    <span class="c1">// ... this is  ptr[0]  ptr[0]  ptr[0]</span>
    <span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.read</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="c1">// ... this is  ptr[0]  ptr[1]  ptr[1]</span>
    <span class="k">let</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.add</span><span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="nf">.read</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="c1">// ... this is  ptr[0]  ptr[1]  ptr[2]</span>
    <span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ptr</span><span class="nf">.add</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.read</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">lo</span> <span class="p">|</span> <span class="p">(</span><span class="n">mid</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="p">|</span> <span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="nn">u32</span><span class="p">::</span><span class="nf">from_ne_bytes</span><span class="p">([</span><span class="sc">b'A'</span><span class="p">;</span> <span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">write_at</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span><span class="p">()</span><span class="nf">.write_unaligned</span><span class="p">(</span><span class="n">data</span> <span class="p">|</span> <span class="n">z</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>I learned this type of loading code while contributing to Abseil: it’s very useful for loading variable-length data for data-hungry algorithms, like a codec or a hash function.</p> <p>Here’s the same benchmark again, but with our new loading code.</p> <p><img src="https://mcyoung.xyz/public/images/simd-b64/graph.png" alt="a performance graph; our code is even better and the variance is very tight"/></p> <p>The results are really, really good. The variance is super tight, and our performance is 2x that of the baseline pretty much everywhere. <em>Success.</em></p> <h3 id="encoding-web-safe"><a href="#encoding-web-safe">Encoding? Web-Safe?</a></h3> <p>Writing an encoding function is simple enough: first, implement an <code class="language-plaintext highlighter-rouge">encode_hot()</code> function that reverses the operations from <code class="language-plaintext highlighter-rouge">decode_hot()</code>. The perfect hash from before won’t work, so you’ll need to <a href="https://github.com/mcy/vb64/blob/main/src/simd.rs#L170">invent a new one</a>.</p> <p>Also, the loading/storing code around the encoder is slightly different, too. <code class="language-plaintext highlighter-rouge">vb64</code> implements a very efficient encoding routine too, so I suggest taking a look at the source code if you’re interested.</p> <p>There is a base64 variant called web-safe base64, that replaces the <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">/</code> characters with <code class="language-plaintext highlighter-rouge">-</code> and <code class="language-plaintext highlighter-rouge">_</code>. Building a perfect hash for these is trickier: you would probably have to do something like <code class="language-plaintext highlighter-rouge">(byte &gt;&gt; 4) - (byte == '_' ? '_' : 0)</code>. I don’t support web-safe base64 yet, but only because I haven’t gotten around to it.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>My library doesn’t really solve an important problem; base64 decoding isn’t a bottleneck… anywhere that I know of, really. But writing SIMD code is really fun! Writing branchless code is often overkill but can give you a good appreciation for what your compilers can and <em>can’t</em> do for you.</p> <p>This project was also an excuse to try <code class="language-plaintext highlighter-rouge">std::simd</code>. I think it’s great overall, and generates excellent code. There’s some rough edges I’d like to see fixed to make SIMD code even simpler, but overall I’m very happy with the work that’s been done there.</p> <p>This is probably one of the most complicated posts I’ve written in a long time. SIMD (and performance in general) is a complex topic that requires a breadth of knowledge of tricks and hardware, a lot of which isn’t written down. More of it is written down now, though.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:shifts-are-arithmetic" role="doc-endnote"> <p>Shifts are better understood as arithmetic. They have a lane width, and closely approximate multiplication and division. AVX2 doesn’t even have vector shift <em>or</em> vector division: you emulate it with multiplication. <a href="#fnref:shifts-are-arithmetic" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:minus-true" role="doc-endnote"> <p>The two common representations of <code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">false</code>, i.e. <code class="language-plaintext highlighter-rouge">1</code> and <code class="language-plaintext highlighter-rouge">0</code> or <code class="language-plaintext highlighter-rouge">0xff...</code> and <code class="language-plaintext highlighter-rouge">0</code>, are related by the two’s complement operation.</p> <p>For example, if I write <code class="language-plaintext highlighter-rouge">uint32_t m = -(a == b);</code>, <code class="language-plaintext highlighter-rouge">m</code> will be zero if <code class="language-plaintext highlighter-rouge">a == b</code> is false, and all-ones otherwise. This because applying any arithmetic operation to a <code class="language-plaintext highlighter-rouge">bool</code> promotes it to <code class="language-plaintext highlighter-rouge">int</code>, so <code class="language-plaintext highlighter-rouge">false</code> maps to <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">true</code> maps to <code class="language-plaintext highlighter-rouge">1</code>. Applying the <code class="language-plaintext highlighter-rouge">-</code> sends <code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">1</code> to <code class="language-plaintext highlighter-rouge">-1</code>, and it’s useful to know that in two’s complement, <code class="language-plaintext highlighter-rouge">-1</code> is represented as all-ones.</p> <p>The all-ones representation for <code class="language-plaintext highlighter-rouge">true</code> is useful, because it can be used to implement branchless select very easily. For example,</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="nf">select_if_eq</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">C++</div></div></div> <p>This function returns <code class="language-plaintext highlighter-rouge">x</code> if <code class="language-plaintext highlighter-rouge">a == b</code>, and <code class="language-plaintext highlighter-rouge">y</code> otherwise. Can you tell why? <a href="#fnref:minus-true" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:abi" role="doc-endnote"> <p>Target features also affect ABI in subtle ways that I could write many, many more words on. Compiling libraries you plan to distribute with weird target feature flags is a recipe for disaster. <a href="#fnref:abi" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:why-cant-llvm-do-it" role="doc-endnote"> <p>Why can’t we leave this kind of thing to LLVM? Finding this particular branchless implementation is tricky. LLVM is smart enough to fold the match into a switch table, but that’s unnecessary memory traffic to look at the table. (In this domain, unnecessary memory traffic makes our code slower.)</p> <p>Incidentally, with the code I wrote for the original <code class="language-plaintext highlighter-rouge">decoded_len()</code>, LLVM produces a jump <em>and</em> a lookup table, which is definitely an odd choice? I went down something of a rabbit-hole. https://github.com/rust-lang/rust/issues/118306</p> <p>As for getting LLVM to find the “branchless” version of the lookup table? The search space is quite large, and this kind of “general strength reduction” problem is fairly open (keywords: “superoptimizers”). <a href="#fnref:why-cant-llvm-do-it" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:pad-with-A" role="doc-endnote"> <p>To be clear on why this works: suppose that in our reference implementation, we only handle inputs that are a multiple-of-4 length, and are padded with <code class="language-plaintext highlighter-rouge">=</code> as necessary, and we treat <code class="language-plaintext highlighter-rouge">=</code> as zero in the <code class="language-plaintext highlighter-rouge">match</code>. Then, for the purposes of computing the <code class="language-plaintext highlighter-rouge">bytes</code> value (before appending it to <code class="language-plaintext highlighter-rouge">out</code>), we can assume the chunk length is always 4. <a href="#fnref:pad-with-A" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:macros" role="doc-endnote"> <p>See <a href="https://github.com/mcy/vb64/blob/ed75566393a25d174a2766c3f8947d9c6a506315/src/util.rs"><code class="language-plaintext highlighter-rouge">vb64/src/util.rs</code></a>. <a href="#fnref:macros" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="rust"/><category term="optimization"/><summary type="html"><![CDATA[Another explainer on a fun, esoteric topic: optimizing code with SIMD (single instruction multiple data, also sometimes called vectorization). Designing a good, fast, portable SIMD algorithm is not a simple matter and requires thinking a little bit like a circuit designer.]]></summary></entry><entry><title type="html">What is a Matrix? A Miserable Pile of Coefficients!</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2023/09/29/what-is-a-matrix/" rel="alternate" type="text/html" title="What is a Matrix? A Miserable Pile of Coefficients!"/><published>2023-09-29T00:00:00-07:00</published><updated>2023-09-29T00:00:00-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2023/09/29/what-is-a-matrix</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2023/09/29/what-is-a-matrix/"><![CDATA[<p>Linear algebra is undoubtedly the most useful field in all of algebra. It finds applications in all kinds of science and engineering, like quantum mechanics, graphics programming, and machine learning. It is the “most well-behaved” algebraic theory, in that other abstract algebra topics often try to approximate linear algebra, when possible.</p> <p>For many students, linear algebra means vectors and matrices and determinants, and complex formulas for computing them. Matrices, in particular, come equipped with a fairly complicated, and <em>a fortiori</em> convoluted, multiplication operation.</p> <p>This is not the only way to teach linear algebra, of course. Matrices and their multiplication appear complicated, but actually are a natural and compact way to represent a particular type of <em>function</em>, i.e., a linear map (or linear transformation).</p> <p>This article is a short introduction to viewing linear algebra from the perspective of abstract algebra, from which matrices arise as a computational tool, rather than an object of study in and of themselves. I do assume some degree of familiarity with the idea of a matrix.</p> <h2 id="linear-spaces"><a href="#linear-spaces">Linear Spaces</a></h2> <p>Most linear algebra courses open with a description of vectors in Euclidean space: <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">\R^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span>. Vectors there are defined as tuples of real numbers that can be added, multiplied, and scaled. Two vectors can be combined into a number through the dot product. Vectors come equipped with a notion of magnitude and direction.</p> <p>However, this highly geometric picture can be counterproductive, since it is hard to apply geometric intuition directly to higher dimensions. It also obscures how this connects to working over a different number system, like the complex numbers.</p> <p>Instead, I’d like to open with the concept of a <em>linear space</em>, which is somewhat more abstract than a vector space<sup id="fnref:vs-in-generality" role="doc-noteref"><a href="#fn:vs-in-generality" class="footnote" rel="footnote">1</a></sup>.</p> <p>First, we will need a notion of a “coefficient”, which is essentially something that you can do arithmetic with. We will draw coefficients from a designated <em>ground field</em> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>. A field is a setting for doing arithmetic: a set of objects that can be added, subtracted, and multiplied, and divided in the “usual fashion” along with special <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> values. E.g. <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>+</mo><mn>0</mn><mo>=</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">a + 0 = a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span></span>, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>a</mi><mo>=</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">1a = a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span></span>, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo stretchy="false">(</mo><mi>b</mi><mo>+</mo><mi>c</mi><mo stretchy="false">)</mo><mo>=</mo><mi>a</mi><mi>b</mi><mo>+</mo><mi>a</mi><mi>c</mi></mrow><annotation encoding="application/x-tex">a(b + c) = ab + ac</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span></span></span></span></span>, and so on.</p> <p>Not only are the real numbers <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">R</mi></mrow><annotation encoding="application/x-tex">\R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span></span> a field, but so are the complex numbers <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">C</mi></mrow><annotation encoding="application/x-tex">\C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">C</span></span></span></span></span>, and the rational numbers <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Q</mi></mrow><annotation encoding="application/x-tex">\Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8556em;vertical-align:-0.1667em;"></span><span class="mord mathbb">Q</span></span></span></span></span>. If we drop the “division” requirement, we can also include the integers <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Z</mi></mrow><annotation encoding="application/x-tex">\Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">Z</span></span></span></span></span>, or polynomials with rational coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Q</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\Q[x]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">Q</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span></span></span></span></span>, for example.</p> <p>Having chosen our coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, a linear space <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> <em>over</em> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> is another set of objects that can be added and subtracted (and including a special value <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>)<sup id="fnref:ab-group" role="doc-noteref"><a href="#fn:ab-group" class="footnote" rel="footnote">2</a></sup>, along with a <em>scaling operation</em>, which takes a coefficient <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">c \in K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> and one of our objects <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">v \in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> and produces a new <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>v</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">cv \in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>.</p> <p>The important part of the scaling operation is that it’s compatible with addition: if we have <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">a, b \in K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo separator="true">,</mo><mi>w</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">v, w \in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, we require that</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="center" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>a</mi><mo stretchy="false">(</mo><mi>v</mi><mo>+</mo><mi>w</mi><mo stretchy="false">)</mo><mo>=</mo><mi>a</mi><mi>v</mi><mo>+</mo><mi>a</mi><mi>w</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>b</mi><mo stretchy="false">)</mo><mi>v</mi><mo>=</mo><mi>a</mi><mi>v</mi><mo>+</mo><mi>b</mi><mi>v</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{gather*}a (v + w) = av + aw \\ (a + b) v = av + bv\end{gather*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>This is what makes a linear space “linear”: you can write equations that look like first-degree polynomials (e.g. <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">ax + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span>), and which can be <em>manipulated like first-degree polynomials</em>.</p> <p>These polynomials are called linear because their graph looks like a line. There’s no multiplication, so we can’t have <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">x^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>, but we do have multiplication by a coefficient. This is what makes linear algebra is “linear”.</p> <p>Some examples: <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>-tuples of elements drawn from any field are a linear space over that field, by componentwise addition and scalar multiplication; e.g., <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">R^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span>. Setting <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> shows that every field is a linear space over itself.</p> <p>Polynomials in one variable over some field, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">K[x]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span></span></span></span></span>, are also a linear space, since polynomials can be added together and scaled by a any value in <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> (since lone coefficients are degree zero polynomials). Real-valued functions also form a linear space over <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">R</mi></mrow><annotation encoding="application/x-tex">\R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span></span> in a similar way.</p> <h3 id="linear-transformations"><a href="#linear-transformations">Linear Transformations</a></h3> <p>A linear map is a function <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>:</mo><mi>V</mi><mo>→</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">f: V \to W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> between two linear spaces <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> over <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> which “respects” the linear structure in a particular way. That is, for any <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">c\in K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo separator="true">,</mo><mi>w</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">v, w \in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>,</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="center" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo>+</mo><mi>w</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>w</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>c</mi><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mi>c</mi><mo>⋅</mo><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{gather*}f(v + w) = f(v) + f(w) \\ f(cv) = c \cdot f(v)\end{gather*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>We call this type of relationship (respecting addition and scaling) “linearity”. One way to think of this relationship is that <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> is kind of like a different kind of coefficient, in that it distributes over addition, which commutes with the “ordinary” coefficients from <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>. However, applying <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> produces a value from <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> rather than <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>.</p> <p>Another way to think of it is that if we have a linear polynomial like <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>a</mi><mi>x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">p(x) = ax + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span> in <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span>, then <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mi>p</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(p(x)) = p(f(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span>. We say that <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> <em>commutes</em> with all linear polynomials.</p> <p>The most obvious sort of linear map is scaling. Given any coefficient <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">c \in K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, it defines a “scaling map”:</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="center" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>μ</mi><mi>c</mi></msub><mo>:</mo><mi>V</mi><mo>→</mo><mi>V</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>v</mi><mo>↦</mo><mi>c</mi><mi>v</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{gather*}\mu_c: V \to V \\ v \mapsto cv\end{gather*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↦</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>It’s trivial to check this is a linear map, by plugging it into the above equations: it’s linear because scaling is distributive and commutative.</p> <p>Linear maps are the essential thing we study in linear algebra, since they describe all the different kinds of relationships between linear spaces.</p> <p>Some linear maps are complicated. For example, a function from <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mn>2</mn></msup><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\R^2 \to \R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> that rotates the plane by some angle <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> is linear, as are operations that stretch or shear the plane. However, they can’t “bend” or “fold” the plane: they are all fairly rigid motions. In the linear space <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Q</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\Q[x]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">Q</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span></span></span></span></span> of rational polynomials, multiplication by <em>any</em> polynomial, such as <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span> or <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x^2 - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span>, is a linear map. The notion of “linear map” depends heavily on the space we’re in.</p> <p>Unfortunately, linear maps as they are quite opaque, and do not lend themselves well to calculation. However, we can build an explicit representation using a <em>linear basis</em>.</p> <h2 id="linear-basis"><a href="#linear-basis">Linear Basis</a></h2> <p>For any linear space, we can construct a relatively small of elements such that any element of the space can be expressed as some linear function of these elements.</p> <p>Explicitly, for any <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, we can construct a sequence<sup id="fnref:indices" role="doc-noteref"><a href="#fn:indices" class="footnote" rel="footnote">3</a></sup> <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> such that for any <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">v \in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, we can find <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">c_i \in K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> such that</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mi>i</mi></msub><msub><mi>e</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">v = \sum_i c_i e_i.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>Such a set <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> is called a <em>basis</em> if it is linearly independent: no one <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> can be expressed as a linear function of the rest. The <em>dimension</em> of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, denoted <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>dim</mi><mo>⁡</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\dim V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, is the number of elements in any choice of basis. This value does not depend on the choice of basis<sup id="fnref:invariant-dim" role="doc-noteref"><a href="#fn:invariant-dim" class="footnote" rel="footnote">4</a></sup>.</p> <p>Constructing a basis for any <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> is easy: we can do this recursively. First, pick a random element <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, and define a new linear space <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi mathvariant="normal">/</mi><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">V/e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> where we have identified all elements that differ by a factor of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> as equal (i.e., if <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>−</mo><mi>w</mi><mo>=</mo><mi>c</mi><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">v - w = ce_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord mathnormal">c</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, we treat <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span></span> as equal in <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi mathvariant="normal">/</mi><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">V/e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>).</p> <p>Then, a basis for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> is a basis of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi mathvariant="normal">/</mi><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">V/e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> with <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> added. The construction of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi mathvariant="normal">/</mi><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">V/e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> is essentially “collapsing” the dimension <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> “points” in, giving us a new space where we’ve “deleted” all of the elements that have a nonzero <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">e_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> component.</p> <p>However, this only works when the dimension is finite; more complex methods must be used for infinite-dimensional spaces. For example, the polynomials <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Q</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\Q[x]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">Q</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span></span></span></span></span> are an infinite-dimensional space, with basis elements <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace linebreak="newline"></mspace><mrow><mn>1</mn><mo separator="true">,</mo><mi>x</mi><mo separator="true">,</mo><msup><mi>x</mi><mn>2</mn></msup><mo separator="true">,</mo><msup><mi>x</mi><mn>3</mn></msup><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mspace linebreak="newline"></mspace></mrow></mrow><annotation encoding="application/x-tex">\\{1, x, x^2, x^3, ...\\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">…</span><span class="mspace newline"></span></span></span></span></span></span>. In general, for any linear space <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, it <em>is</em> always possible to arbitrarily choose a basis, although it may be infinite<sup id="fnref:rq" role="doc-noteref"><a href="#fn:rq" class="footnote" rel="footnote">5</a></sup>.</p> <p>Bases are useful because they give us a concrete representation of any element of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>. Given a fixed basis <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, we can represent any <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>c</mi><mi>i</mi></msub><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w = \sum_i c_i e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> by the coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">c_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> themselves. For a finite-dimensional <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, this brings us back <em>column vectors</em>: <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>dim</mi><mo>⁡</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\dim V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span>-tuples of coefficients from <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> that are added and scaled componentwise.</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtext> </mtext><mo><munder><mo><mo>:</mo><mo>=</mo></mo><mrow><mtext>given </mtext><msub><mi>e</mi><mi>i</mi></msub></mrow></munder></mo><mtext> </mtext><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mi>i</mi></msub><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\Mat{c_0 \\ c_1 \\ \vdots \\ c_n} \,\underset{\text{given } e_i}{:=}\, \sum_i c_i e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.46em;vertical-align:-2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3665em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">given </span></span><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">:=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8696em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>The <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>th basis element is represented as the vector whose entries are all <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span> except for the <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>th one, which is <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span>. E.g.,</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtext> </mtext><mo><munder><mo><mo>=</mo></mo><mrow><mtext>given </mtext><msub><mi>e</mi><mi>i</mi></msub></mrow></munder></mo><mtext> </mtext><msub><mi>e</mi><mn>1</mn></msub><mo separator="true">,</mo><mtext> </mtext><mtext> </mtext><mtext> </mtext><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtext> </mtext><mo><munder><mo><mo>=</mo></mo><mrow><mtext>given </mtext><msub><mi>e</mi><mi>i</mi></msub></mrow></munder></mo><mtext> </mtext><msub><mi>e</mi><mn>2</mn></msub><mo separator="true">,</mo><mtext> </mtext><mtext> </mtext><mtext> </mtext><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\Mat{1 \\ 0 \\ \vdots \\ 0} \,\underset{\text{given } e_i}{=}\, e_1, \,\,\, \Mat{0 \\ 1 \\ \vdots \\ 0} \,\underset{\text{given } e_i}{=}\, e_2, \,\,\, ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.46em;vertical-align:-2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3669em;"><span style="top:-2.3665em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">given </span></span><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8696em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:5.46em;vertical-align:-2.48em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3669em;"><span style="top:-2.3665em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">given </span></span><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8696em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>It is important to recall that the choice of basis is <em>arbitrary</em>. From the mathematical perspective, any basis is just as good as any other, although some may be more computationally convenient.</p> <p>Over <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> are sometimes called the “standard basis”, but <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>3</mn><mo separator="true">,</mo><mo>−</mo><mn>4</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(3, -4)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord">4</span><span class="mclose">)</span></span></span></span></span> are also a basis for this space. One easy mistake to make, particularly when working over the tuple space <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">K^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span>, is to confuse the actual elements of the linear space with the coefficient vectors that represent them. Working with abstract linear spaces eliminates this source of confusion.</p> <h3 id="representing-linear-transformations"><a href="#representing-linear-transformations">Representing Linear Transformations</a></h3> <p>Working with finite-dimensional linear spaces <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span>, let’s choose bases <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">d_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span> for them, and let’s consider a linear map <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>:</mo><mi>V</mi><mo>→</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">f: V \to W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span>.</p> <p>The powerful thing about bases is that we can more compactly express the information content of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span>. Given any <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">v \in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, we can decompose it into a linear function of the basis (for some coefficients), so we can write</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mrow><mo fence="true">(</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mi>i</mi></msub><msub><mi>e</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mi>f</mi><mo stretchy="false">(</mo><msub><mi>c</mi><mi>i</mi></msub><msub><mi>e</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mi>i</mi></msub><mo>⋅</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>e</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v) = f\left(\sum_i c_i e_i\right) = \sum_i f(c_i e_i) = \sum_i c_i \cdot f(e_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0277em;vertical-align:-1.2777em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>In other words, to specify <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span>, we <em>only</em> need to specify what it does to each of the <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>dim</mi><mo>⁡</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\dim V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> basis elements. But what’s more, because <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> also has a basis, we can write</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>e</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>d</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">f(e_i) = \sum_j A_{ij} d_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4638em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>Putting these two formulas together, we have an explicit closed form for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span>, given the coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">A_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span> of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span>, and the coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">c_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>:</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><msub><mi>c</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>d</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">f(v) = \sum_{i,j} c_i A_{ij} d_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4638em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>Alternatively, we can express <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span> as column vectors, and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> as the <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> matrix with entires <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">A_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span>. The entries of the resulting column vector are given by the above explicit formula for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span>, fixing the value of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> in each entry.</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><munder><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mn>0</mn><mo separator="true">,</mo><mn>0</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mn>1</mn><mo separator="true">,</mo><mn>0</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mi>n</mi><mo separator="true">,</mo><mn>0</mn></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mn>1</mn><mo separator="true">,</mo><mn>0</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mn>1</mn><mo separator="true">,</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mi>n</mi><mo separator="true">,</mo><mn>1</mn></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>m</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mn>1</mn><mo separator="true">,</mo><mi>m</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>A</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo stretchy="true">⏟</mo></munder><mi>A</mi></munder><mtext> </mtext><munder><munder><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo stretchy="true">⏟</mo></munder><mi>v</mi></munder><mo>=</mo><munder><munder><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>c</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>0</mn></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>c</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>1</mn></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>c</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo stretchy="true">⏟</mo></munder><mrow><mi>A</mi><mi>v</mi></mrow></munder></mrow><annotation encoding="application/x-tex">\underbrace{\Mat{ A_{0,0} &amp; A_{1,0} &amp; \cdots &amp; A_{n,0} \\ A_{1,0} &amp; A_{1,1} &amp; \cdots &amp; A_{n,1} \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ A_{0,m} &amp; A_{1,m} &amp; \cdots &amp; A_{n,m} }}_A \, \underbrace{\Mat{c_0 \\ c_1 \\ \vdots \\ c_n}}_v = \underbrace{\Mat{ \sum_i c_i A_{i,0} \\ \sum_i c_i A_{i,1} \\ \vdots \\ \sum_i c_i A_{i,m} }}_{Av}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.7863em;vertical-align:-3.8063em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-1.1737em;"><span class="pstrut" style="height:4.98em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span><span style="top:-4.98em;"><span class="pstrut" style="height:4.98em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span class="svg-align" style="top:-1.852em;"><span class="pstrut" style="height:4.98em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7 -331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214 c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0 -5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237 -174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-4.98em;"><span class="pstrut" style="height:4.98em;"></span><span class="mord"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.64em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-4.44em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-2.58em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span style="top:-1.38em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.128em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.8063em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-1.3506em;"><span class="pstrut" style="height:4.98em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-4.98em;"><span class="pstrut" style="height:4.98em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span class="svg-align" style="top:-1.852em;"><span class="pstrut" style="height:4.98em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7 -331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214 c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0 -5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237 -174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-4.98em;"><span class="pstrut" style="height:4.98em;"></span><span class="mord"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.128em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.6294em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:6.7863em;vertical-align:-3.8063em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-1.1737em;"><span class="pstrut" style="height:4.98em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-4.98em;"><span class="pstrut" style="height:4.98em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span class="svg-align" style="top:-1.852em;"><span class="pstrut" style="height:4.98em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7 -331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214 c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0 -5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237 -174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-4.98em;"><span class="pstrut" style="height:4.98em;"></span><span class="mord"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.128em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.8063em;"><span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>(Remember, this is all dependent on the choices of bases <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">d_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span>!)</p> <p>Behold, we have derived the matrix-vector multiplication formula: the <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>th entry of the result is the dot product of the vector and the <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>th row of the matrix.</p> <p>But it is crucial to keep in mind that we had to choose bases <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">d_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span> to be entitled to write down a matrix for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span>. The values of the coefficients depend on the choice of basis.</p> <p>If your linear space happens to be <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">\R^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span>, there is an “obvious” choice of basis, but not every linear space over <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">R</mi></mrow><annotation encoding="application/x-tex">\R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span></span> is <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">\R^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span>! Importantly, the actual linear algebra <em>does not</em> change depending on the basis<sup id="fnref:similar" role="doc-noteref"><a href="#fn:similar" class="footnote" rel="footnote">6</a></sup>.</p> <h2 id="matrix-multiplication"><a href="#matrix-multiplication">Matrix Multiplication</a></h2> <p>So, where does matrix multiplication come from? An <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span><sup id="fnref:rc" role="doc-noteref"><a href="#fn:rc" class="footnote" rel="footnote">7</a></sup> matrix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> <em>represents</em> some linear map <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>:</mo><mi>V</mi><mo>→</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">f: V \to W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span>, where <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>dim</mi><mo>⁡</mo><mi>V</mi><mo>=</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">\dim V = n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>dim</mi><mo>⁡</mo><mi>W</mi><mo>=</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">\dim W = m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span>, and appropriate choices of basis (<span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">d_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span>) have been made.</p> <p>Keeping in mind that linear maps are supreme over matrices, suppose we have a third linear space <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span>, and a map <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>:</mo><mi>U</mi><mo>→</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">g: U \to V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, and let <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>=</mo><mi>dim</mi><mo>⁡</mo><mi>U</mi></mrow><annotation encoding="application/x-tex">\ell = \dim U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span>. Choosing a basis <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">h_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span>, we can represent <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></span> as a matrix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> of dimension <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">\ell \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>.</p> <p>Then, we’d like for the matrix product <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">AB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> to be the same matrix we’d get from representing the composite map <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>g</mi><mo>:</mo><mi>U</mi><mo>→</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">fg: U \to W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> as a matrix, using the aforementioned choices of bases for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> (the basis choice for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> should “cancel out”).</p> <p>Recall our formula for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span> in terms of its matrix coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">A_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span> and the coefficients of the input <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>, which we call <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">c_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>. We can produce a similar formula for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">g(u)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span></span>, giving it matrix coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">B_{ki}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, and coefficients <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">b_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> for <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">u</span></span></span></span></span>. (I appologize for the number of indices and coefficients here.)</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><msub><mi>c</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>d</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo separator="true">,</mo><mi>i</mi></mrow></munder><msub><mi>b</mi><mi>k</mi></msub><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><msub><mi>e</mi><mi>i</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}f(v) &amp;= \sum_{i,j} c_i A_{ij} d_j \\ g(u) &amp;= \sum_{k,i} b_k B_{ki} e_i\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.552em;vertical-align:-2.526em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.026em;"><span style="top:-5.026em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span><span style="top:-2.2622em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.526em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.026em;"><span style="top:-5.026em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.2622em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.526em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>If we write <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>g</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(g(u))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">))</span></span></span></span></span>, then <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">c_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> is the coefficient <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> is multiplied by; i.e., we fix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>, and drop it from the summation: <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub><mo>=</mo><msub><mo>∑</mo><mi>k</mi></msub><msub><mi>b</mi><mi>k</mi></msub><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">c_i = \sum_k b_k B_{ki}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>.</p> <p>Substituting that into the above formula, we now have something like the following.</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left right" columnspacing="0em 1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>g</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><munder><mo>∑</mo><mi>k</mi></munder><msub><mi>b</mi><mi>k</mi></msub><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>d</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>g</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><msub><mi>b</mi><mi>k</mi></msub><mrow><mo fence="true">(</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo fence="true">)</mo></mrow><msub><mi>d</mi><mi>j</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mo>⋆</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}f(g(u)) &amp;= \sum_{i,j} \sum_{k} b_k B_{ki} A_{ij} d_j \\ f(g(u)) &amp;= \sum_{k,j} b_k \left(\sum_{i} A_{ij} B_{ki} \right) d_j &amp;(\star)\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.252em;vertical-align:-2.876em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.376em;"><span style="top:-6.076em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">))</span></span></span><span style="top:-2.6122em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">))</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.376em;"><span style="top:-6.076em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.6122em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6122em;"><span style="top:-2.6122em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">⋆</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>In <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>⋆</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\star)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">⋆</span><span class="mclose">)</span></span></span></span></span>, we’ve rearranged things so that the sum in parenthesis is the <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(k,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span>th matrix coefficient of the composite <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>g</mi></mrow><annotation encoding="application/x-tex">fg</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></span>. Because we wanted <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">AB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> to represent <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>g</mi></mrow><annotation encoding="application/x-tex">fg</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></span>, it must be an <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">\ell \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span> matrix whose entries are</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mi>B</mi><msub><mo stretchy="false">)</mo><mrow><mi>k</mi><mi>j</mi></mrow></msub><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">(AB)_{kj} = \sum_{i} A_{ij} B_{ki}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">kj</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p><em>This</em> is matrix multiplication. It arises naturally out of composition of linear maps. In this way, the matrix multiplication formula is not a definition, but a <em>theorem</em> of linear algebra!</p> <blockquote> <h4 id="theorem-matrix-multiplication"><a href="#theorem-matrix-multiplication">Theorem (Matrix Multiplication)</a></h4> <p>Given an <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span> matrix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> and an <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">\ell \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> matrix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>, both with coefficients in <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, then <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">AB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> is an <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">\ell \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span> matrix with entires</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mi>B</mi><msub><mo stretchy="false">)</mo><mrow><mi>k</mi><mi>j</mi></mrow></msub><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>B</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex"> (AB)_{kj} = \sum_{i} A_{ij} B_{ki}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">kj</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ki</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> </blockquote> <p>If the matrix dimension is read as <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>→</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n \to m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span> instead of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span>, the shape requirements are more obvious: two matrices <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> can be multiplied together only when they represent a pair of maps <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>→</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">V \to W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>→</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">U \to V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>.</p> <h3 id="other-consequences-and-conclusion"><a href="#other-consequences-and-conclusion">Other Consequences, and Conclusion</a></h3> <p>The identity matrix is an <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> matrix:</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mi>n</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">I_n = \Mat{ 1 \\ &amp; 1 \\ &amp;&amp; \ddots \\ &amp;&amp;&amp; 1 }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.25em;"><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.95em;"><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>We want it to be such that for any appropriately-sized matrices <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>, it has <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><msub><mi>I</mi><mi>n</mi></msub><mo>=</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">AI_n = A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>n</mi></msub><mi>B</mi><mo>=</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">I_n B = B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>. Lifted up to linear maps, this means that <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">I_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> should represent the identity map <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>→</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">V \to V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>, when <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>dim</mi><mo>⁡</mo><mi>V</mi><mo>=</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">\dim V = n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">dim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>. This map sends each basis element <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> to itself, so the columns of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">I_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> should be the basis vectors, in order:</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋯</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\Mat{1 \\ 0 \\ \vdots \\ 0} \Mat{0 \\ 1 \\ \vdots \\ 0} \cdots \Mat{0 \\ 0 \\ \vdots \\ 1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.46em;vertical-align:-2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>If we shuffle the columns, we’ll get a <em>permutation matrix</em>, which shuffles the coefficients of a column vector. For example, consider this matrix.</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\Mat{ 0 &amp; 1 &amp; 0 \\ 1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84 H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <p>This is similar to the identity, but we’ve swapped the first two columns. Thus, it will swap the first two coefficients of any column vector.</p> <p>Matrices may seem unintuitive when they’re introduced as a subject of study. Every student encountering matrices for the same time may ask “If they add componentwise, why don’t they multiply componentwise too?”</p> <p>However, approaching matrices as a computational and representational tool shows that the convoluted-looking matrix multiplication formula is a direct consequence of linearity.</p> <div class="codeblock"><div class="katex-dpy"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="center" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo>+</mo><mi>w</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>w</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>c</mi><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mi>c</mi><mo>⋅</mo><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{gather*}f(v + w) = f(v) + f(w) \\ f(cv) = c \cdot f(v)\end{gather*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><div class="codeblock-buttons"><div class="codeblock-button">Math</div></div></div> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:vs-in-generality" role="doc-endnote"> <p>In actual modern mathematics, the objects I describe are still called vector spaces, which I think generates unnecessary confusion in this case. “Linear space” is a bit more on the nose for what I’m going for. <a href="#fnref:vs-in-generality" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ab-group" role="doc-endnote"> <p>This type of structure (just the addition part) is also called an “abelian group”. <a href="#fnref:ab-group" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:indices" role="doc-endnote"> <p>Throughout <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>, and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> are indices in some unspecified but ordered indexing set, usually <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{1, 2, ..., n\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">…</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">}</span></span></span></span></span>. I will not bother giving this index set a name. <a href="#fnref:indices" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:invariant-dim" role="doc-endnote"> <p>This is sometimes called the <a href="https://en.wikipedia.org/wiki/Dimension_theorem_for_vector_spaces"><em>dimension theorem</em></a>, which is somewhat tedious to prove. <a href="#fnref:invariant-dim" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:rq" role="doc-endnote"> <p>An example of a messy infinite-dimensional basis is <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">R</mi></mrow><annotation encoding="application/x-tex">\R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span></span> considered as linear space over <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Q</mi></mrow><annotation encoding="application/x-tex">\Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8556em;vertical-align:-0.1667em;"></span><span class="mord mathbb">Q</span></span></span></span></span> (in general, every field is a linear space over its subfields). The basis for this space essentially has to be “<span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span>, and all irrational numbers” except if we include e.g. <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> we can’t include <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>π</mi></mrow><annotation encoding="application/x-tex">e + \frac{1}{2}\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>, which is a <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Q</mi></mrow><annotation encoding="application/x-tex">\Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8556em;vertical-align:-0.1667em;"></span><span class="mord mathbb">Q</span></span></span></span></span>-linear combination of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>.</p> <p>On the other hand, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">C</mi></mrow><annotation encoding="application/x-tex">\C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">C</span></span></span></span></span> is two-dimensional over <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">R</mi></mrow><annotation encoding="application/x-tex">\R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span></span>, with basis <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace linebreak="newline"></mspace><mrow><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mspace linebreak="newline"></mspace></mrow></mrow><annotation encoding="application/x-tex">\\{1, i\\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">i</span><span class="mspace newline"></span></span></span></span></span></span>.</p> <p>Incidentally, this idea of “view a field <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> as a linear space over its subfield <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span>” is such a useful concept that it is called the “degree of the field extension <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mi mathvariant="normal">/</mi><mi>F</mi></mrow><annotation encoding="application/x-tex">K/F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span>”, and given the symbol <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>K</mi><mo>:</mo><mi>F</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[K : F]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mclose">]</span></span></span></span></span>.</p> <p>This, <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi mathvariant="double-struck">R</mi><mo>:</mo><mi mathvariant="double-struck">Q</mi><mo stretchy="false">]</mo><mo>=</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">[\R : \Q] = \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathbb">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">Q</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">∞</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi mathvariant="double-struck">C</mi><mo>:</mo><mi mathvariant="double-struck">R</mi><mo stretchy="false">]</mo><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">[\C : \R] = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathbb">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">R</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span></span>. <a href="#fnref:rq" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:similar" role="doc-endnote"> <p>You may recall from linear algebra class that two matrices <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> of the same shape are <em>similar</em> if there are two appropriately-sized square matrices <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span> such that <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>A</mi><mi>R</mi><mo>=</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">SAR = B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>. These matrices <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> and <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span> represent a <em>change of basis</em>, and indicate that the linear maps <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo>:</mo><mi>V</mi><mo>→</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">A, B: V \to W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span></span> these matrices come from do “the same thing” to elements of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>.</p> <p>Over an algebraically closed field like <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">C</mi></mrow><annotation encoding="application/x-tex">\C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">C</span></span></span></span></span> (i.e. all polynomials have solutions), there is an even stronger way to capture the information content of a linear map via <a href="https://en.wikipedia.org/wiki/Jordan_normal_form"><em>Jordan canonicalization</em></a>, which takes any square matrix <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span> and produces an almost-diagonal square matrix that only depends on the eigenvalues of <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span>, which is the same for similar matrices, and thus basis-independent. <a href="#fnref:similar" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:rc" role="doc-endnote"> <p>Here, as always, matrix dimensions are given in RC (row-column) order. You can think of this as being “input dimension” to “output dimension”. <a href="#fnref:rc" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="math"/><summary type="html"><![CDATA[Linear algebra is undoubtedly the most useful field in all of algebra. It finds applications in all kinds of science and engineering, like quantum mechanics, graphics programming, and machine learning. It is the “most well-behaved” algebraic theory, in that other abstract algebra topics often try to approximate linear algebra, when possible.]]></summary></entry><entry><title type="html">I Wrote A String Type</title><link href="https://mcyoung.xyz/https://mcyoung.xyz/2023/08/09/yarns/" rel="alternate" type="text/html" title="I Wrote A String Type"/><published>2023-08-09T00:00:00-07:00</published><updated>2023-08-09T00:00:00-07:00</updated><id>https://mcyoung.xyz/https://mcyoung.xyz/2023/08/09/yarns</id><content type="html" xml:base="https://mcyoung.xyz/https://mcyoung.xyz/2023/08/09/yarns/"><![CDATA[<p>I write compilers for fun. I can’t help it. Consequently, I also write a lot of parsers. In systems programming, it’s usually a good idea to try to share memory rather than reuse it, so as such my AST types tend to look like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">pub</span> <span class="k">enum</span> <span class="n">Expr</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nf">Int</span><span class="p">(</span><span class="nb">u32</span><span class="p">)</span>
  <span class="nf">Ident</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">'src</span> <span class="nb">str</span><span class="p">),</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Whenever we parse an identifier, rather than copy its name into a fresh <code class="language-plaintext highlighter-rouge">String</code>, we borrow from the input source string. This avoids an extra allocation, an extra copy, and saves a word in the representation. Compilers can be memory-hungry, so it helps to pick a lean representation.</p> <p>Unfortunately, it’s not so easy for quoted strings. Most strings, like <code class="language-plaintext highlighter-rouge">"all my jelly babies"</code>, are “literally” in the original source, like an identifier. But strings with escapes aren’t: <code class="language-plaintext highlighter-rouge">\n</code> is encoded in the source code with the bytes <code class="language-plaintext highlighter-rouge">[0x5c, 0x6e]</code>, but the actual “decoded” value of a string literal replaces each escape with a single <code class="language-plaintext highlighter-rouge">0x0a</code>.</p> <p>The usual solution is a <a href="https://doc.rust-lang.org/std/borrow/enum.Cow.html"><code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code></a>. In the more common, escape-less verison, we can use <code class="language-plaintext highlighter-rouge">Cow::Borrowed</code>, which avoids the extra allocation and copy, and in the escaped version, we decode the escapes into a <code class="language-plaintext highlighter-rouge">String</code> and wrap it in a <code class="language-plaintext highlighter-rouge">Cow::Owned</code>.</p> <p>For example, suppose that we’re writing a parser for a language that has quoted strings with escapes. The string <code class="language-plaintext highlighter-rouge">"all my jelly babies"</code> can be represented as a byte string that borrows the input source code, so we’d use the <code class="language-plaintext highlighter-rouge">Cow::Borrowed</code> variant. This is most strings in any language: escapes tend to be rare.</p> <p>For example, if we have the string <code class="language-plaintext highlighter-rouge">"not UTF-8 \xff"</code>, the actual byte string value is different from that in the source code.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-text" data-lang="text">// Bytes in the source.
hex:   6e 6f 74 20 55 54 46 2d 38 20 5c 78 66 66
ascii: n  o  t     U  T  F  -  8     \  x  f  f

// Bytes represented by the string.
hex:   6e 6f 74 20 55 54 46 2d 38 20 ff
ascii: n  o  t     U  T  F  -  8</code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Plaintext</div></div></div> <p>Escapes are relatively rare, so most strings processed by the parser do not need to pay for an allocation.</p> <p>However, we still pay for that extra word, since <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code> is 24 bytes (unless otherwise specified, all byte counts assume a 64-bit system), which is eight more than our <code class="language-plaintext highlighter-rouge">&amp;str</code>. Even worse, this is bigger than the string data itself, which is 11 bytes.</p> <p>If most of your strings are small (which is not uncommon in an AST parser), you will wind up paying for significant overhead.</p> <p>Over the years I’ve implemented various optimized string types to deal with this use-case, in various contexts. I finally got around to putting all of the tricks I know into a library, which I call <a href="https://docs.rs/byteyarn/latest/byteyarn/"><code class="language-plaintext highlighter-rouge">byteyarn</code></a>. It advertises the following nice properties.</p> <blockquote> <p>A <code class="language-plaintext highlighter-rouge">Yarn</code> is a highly optimized string type that provides a number of useful properties over <code class="language-plaintext highlighter-rouge">String</code>:</p> <ul> <li>Always two pointers wide, so it is always passed into and out of functions in registers.</li> <li>Small string optimization (SSO) up to 15 bytes on 64-bit architectures.</li> <li>Can be either an owned buffer or a borrowed buffer (like <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code>).</li> <li>Can be upcast to <code class="language-plaintext highlighter-rouge">'static</code> lifetime if it was constructed from a known-static string.</li> </ul> </blockquote> <p>I’d like to share how these properties are achieved through careful layout optimization.</p> <h2 id="assumptions"><a href="#assumptions">Assumptions</a></h2> <p>We’re going to start by stating assumptions about how our strings will be used:</p> <ol> <li>Most strings are not mutated most of the time.</li> <li>Most strings are small.</li> <li>Most strings are substrings.</li> </ol> <h3 id="most-strings-are-immutable"><a href="#most-strings-are-immutable">Most Strings are Immutable</a></h3> <p><code class="language-plaintext highlighter-rouge">String</code> is modeled after C++’s <code class="language-plaintext highlighter-rouge">std::string</code>, which is a growable buffer that implements amortized linear-time append. This means that if we are appending <code class="language-plaintext highlighter-rouge">n</code> bytes to the buffer, we only pay for <code class="language-plaintext highlighter-rouge">n</code> bytes of <code class="language-plaintext highlighter-rouge">memcpy</code>.</p> <p>This is a useful but often unnecessary property. For example, Go strings are immutable, and when building up a large string, you are expected to use <code class="language-plaintext highlighter-rouge">strings.Builder</code>, which is implemented as essentially a Rust <code class="language-plaintext highlighter-rouge">String</code>. Java also as a similar story for strings, which allows for highly compact representations of <code class="language-plaintext highlighter-rouge">java.lang.String</code>s.</p> <p>In Rust, this kind of immutable string is represented by a <code class="language-plaintext highlighter-rouge">Box&lt;str&gt;</code>, which is eight bytes smaller than <code class="language-plaintext highlighter-rouge">String</code>. Converting from <code class="language-plaintext highlighter-rouge">String</code> to <code class="language-plaintext highlighter-rouge">Box&lt;str&gt;</code> is just a call to <code class="language-plaintext highlighter-rouge">realloc()</code> to resize the underlying allocation (which is often cheap<sup id="fnref:size-classes" role="doc-noteref"><a href="#fn:size-classes" class="footnote" rel="footnote">1</a></sup>) from being <code class="language-plaintext highlighter-rouge">capacity</code> bytes long to <code class="language-plaintext highlighter-rouge">len</code> bytes long.</p> <p>Thus, this assumption means we only need to store a pointer and a length, which puts our memory footprint floor at 16 bytes.</p> <h3 id="most-strings-are-substrings"><a href="#most-strings-are-substrings">Most Strings are Substrings</a></h3> <p>Suppose again that we’re parsing some textual format. Many structural elements will be verbatim references into the textual input. Not only string literals without escapes, but also identifiers.</p> <p><code class="language-plaintext highlighter-rouge">Box&lt;str&gt;</code> cannot hold borrowed data, because it will always instruct the allocator to free its pointer when it goes out of scope. <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code>, as we saw above, allows us to handle maybe-owned data uniformly, but has a minimum 24 byte overhead. This can’t be made any smaller, because a <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code> can contain a 24-byte <code class="language-plaintext highlighter-rouge">String</code> value.</p> <p>But, we don’t want to store a capacity. Can we avoid the extra word of overhead in <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code>?</p> <h3 id="most-strings-are-small"><a href="#most-strings-are-small">Most Strings are Small</a></h3> <p>Consider a string that is not a substring but which is small. For example, when parsing a string literal like <code class="language-plaintext highlighter-rouge">"Hello, world!\n"</code>, the trailing <code class="language-plaintext highlighter-rouge">\n</code> (bytes <code class="language-plaintext highlighter-rouge">0x5c 0x6e</code>) must be replaced with a newline byte (<code class="language-plaintext highlighter-rouge">0x0a</code>). This means we must handle a tiny heap allocation, 14 bytes long, that is smaller than a <code class="language-plaintext highlighter-rouge">&amp;str</code> referring to it.</p> <p>This is worse for single character<sup id="fnref:character" role="doc-noteref"><a href="#fn:character" class="footnote" rel="footnote">2</a></sup> strings. The overhead for a <code class="language-plaintext highlighter-rouge">Box&lt;str&gt;</code> is large.</p> <ul> <li>The <code class="language-plaintext highlighter-rouge">Box&lt;str&gt;</code> struct itself has a pointer field (eight bytes), and a length field (also eight bytes). Spelled out to show all the stored bits, the length is <code class="language-plaintext highlighter-rouge">0x0000_0000_0000_0001</code>. That’s a lot of zeroes!</li> <li>The pointer itself points to a heap allocation, which will not be a single byte! Allocators are not in the business of handing out such small pieces of memory. Instead, the allocation is likely costing us another eight bytes!</li> </ul> <p>So, the string <code class="language-plaintext highlighter-rouge">"a"</code>, whose data is just a <em>single byte</em>, instead takes up 24 bytes of memory.</p> <p>It turns out that for really small strings we can avoid the allocation altogether, <em>and</em> make effective use of all those zeroes in the <code class="language-plaintext highlighter-rouge">len</code> field.</p> <h2 id="stealing-bits"><a href="#stealing-bits">Stealing Bits</a></h2> <p>Let’s say we want to stick to a budget of 16 bytes for our <code class="language-plaintext highlighter-rouge">Yarn</code> type. Is there any extra space left for data in a <code class="language-plaintext highlighter-rouge">(*mut u8, usize)</code> pair?</p> <p><em>*cracks Fermi estimation knuckles*</em></p> <p>A <code class="language-plaintext highlighter-rouge">usize</code> is 64 bits, which means that the length of an <code class="language-plaintext highlighter-rouge">&amp;str</code> can be anywhere from zero to 18446744073709551615, or around 18 exabytes. For reference, “hundreds of exabytes” is a reasonable ballpark guess for how much RAM exists in 2023 (consider: 4 billion smartphones with 4GB each). More practically, the largest quantity of RAM you can fit in a server blade is measured in terabytes (much more than your measly eight DIMs on your gaming rig).</p> <p>If we instead use one less bit, 63 bits, this halves the maximum representable memory to nine exabytes. If we take another, it’s now four exabytes. Much more memory than you will ever <em>ever</em> want to stick in a string. <a href="https://en.wikipedia.org/wiki/Wikipedia:Size_of_Wikipedia#Size_of_the_English_Wikipedia_database">Wikpedia asserts</a> that Wikimedia Commons contains around 428 terabytes of media (the articles’ text with history is a measly 10 TB).</p> <p>Ah, but you say you’re programming for a 32-bit machine (today, this likely means either a low-end mobile phone, an embedded micro controller, or WASM).</p> <p>On a 32-bit machine it’s a little bit harrier: Now <code class="language-plaintext highlighter-rouge">usize</code> is 32 bits, for a maximum string size of 4 gigabytes (if you remember the 32-bit era, this limit may sound familiar). “Gigabytes” is an amount of memory that you can actually imagine having in a string.</p> <p>Even then, 1 GB of memory (if we steal two bits) on a 32-bit machine is a lot of data. You can only have four strings that big in a single address space, and every 32-bit allocator in the universe will refuse to serve an allocation of that size. If your strings are comparable in size to the whole address space, you should build your own string type.</p> <p>The upshot is that every <code class="language-plaintext highlighter-rouge">&amp;str</code> contains two bits we can reasonably assume are not used. <em>Free real-estate.</em><sup id="fnref:isize" role="doc-noteref"><a href="#fn:isize" class="footnote" rel="footnote">3</a></sup></p> <h3 id="a-hand-written-niche-optimization"><a href="#a-hand-written-niche-optimization">A Hand-Written Niche Optimization</a></h3> <p>Rust has the concept of <em>niches</em>, or invalid bit-patterns of a particular type, which it uses for automatic layout optimization of <code class="language-plaintext highlighter-rouge">enum</code>s. For example, references cannot be null, so the pointer bit-pattern of <code class="language-plaintext highlighter-rouge">0x0000_0000_0000_0000</code> is never used; this bit-pattern is called a “niche”. Consider:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">enum</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">),</span>
  <span class="n">Second</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>An <code class="language-plaintext highlighter-rouge">enum</code> of this form will not need any “extra” space to store the value that discriminates between the two variants: if a <code class="language-plaintext highlighter-rouge">Foo</code>’s bits are all zero, it’s <code class="language-plaintext highlighter-rouge">Foo::Second</code>; otherwise it’s a <code class="language-plaintext highlighter-rouge">Foo::First</code> and the payload is formed from <code class="language-plaintext highlighter-rouge">Foo</code>’s bit-pattern. This, incidentally, is what makes <code class="language-plaintext highlighter-rouge">Option&lt;&amp;T&gt;</code> a valid representation for a “nullable pinter”.</p> <p>There are more general forms of this: <code class="language-plaintext highlighter-rouge">bool</code> is represented as a single byte, of which two bit are valid; the other 254 potential bit-patterns are niches. In Recent versions of Rust, <code class="language-plaintext highlighter-rouge">RawFd</code> has a niche for the all-ones bit-pattern, since POSIX file descriptors are always non-negative <code class="language-plaintext highlighter-rouge">int</code>s.</p> <p>By stealing two bits off of the length, we have given ourselves four niches, which essentially means we’ll have a hand-written version of something like this <code class="language-plaintext highlighter-rouge">enum</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">enum</span> <span class="n">Yarn</span> <span class="p">{</span>
  <span class="nf">First</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">u62</span><span class="p">),</span>
  <span class="nf">Second</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">u62</span><span class="p">),</span>
  <span class="nf">Third</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">u62</span><span class="p">),</span>
  <span class="nf">Fourth</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">u62</span><span class="p">),</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>For reasons that will become clear later, we will specifically steal the <em>high</em> bits of the length, so that to recover the length, we do two shifts<sup id="fnref:two-shifts" role="doc-noteref"><a href="#fn:two-shifts" class="footnote" rel="footnote">4</a></sup> to shift in two high zero bits. Here’s some code that actually implements this for the low level type our string type will be built on.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="nd">#[repr(C)]</span>
<span class="nd">#[derive(Copy,</span> <span class="nd">Clone)]</span>
<span class="k">struct</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span>
  <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="cd">/// Constructs a new RawYarn from raw components: a 2-bit kind,</span>
  <span class="cd">/// a length, and a pointer.</span>
  <span class="k">fn</span> <span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="nd">assert!</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="nn">usize</span><span class="p">::</span><span class="n">MAX</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="s">"no way you have a string that big"</span><span class="p">);</span>

    <span class="n">RawYarn</span> <span class="p">{</span>
      <span class="n">ptr</span><span class="p">,</span>
      <span class="n">len</span><span class="p">:</span> <span class="p">(</span><span class="n">kind</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">&amp;</span> <span class="mi">0b11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="n">BITS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">|</span> <span class="n">len</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cd">/// Extracts the kind back out.</span>
  <span class="k">fn</span> <span class="nf">kind</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
    <span class="p">(</span><span class="k">self</span><span class="py">.len</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="n">BITS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="k">as</span> <span class="nb">u8</span>
  <span class="p">}</span>

  <span class="cd">/// Extracts the slice out (regardless of kind).</span>
  <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">as_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="p">{</span>
    <span class="nn">slice</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="k">self</span><span class="py">.ptr</span><span class="p">,</span> <span class="p">(</span><span class="k">self</span><span class="py">.len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Note that I’ve made this type <code class="language-plaintext highlighter-rouge">Copy</code>, and some functions take it by value. This is for two reasons.</p> <ol> <li> <p>There is a type of <code class="language-plaintext highlighter-rouge">Yarn</code> that is itself <code class="language-plaintext highlighter-rouge">Copy</code>, although I’m not covering it in this article.</p> </li> <li> <p>It is a two-word struct, which means that on most architectures it is eligible to be passed in a pair of registers. Passing it by value in the low-level code helps promote keeping it in registers. This isn’t always possible, as we will see when we discuss “SSO”.</p> </li> </ol> <p>Let’s chose kind <code class="language-plaintext highlighter-rouge">0</code> to mean “this is borrowed data”, and kind <code class="language-plaintext highlighter-rouge">1</code> to be “this is heap-allocated data”. We can use this to remember whether we need to call a destructor.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">pub</span> <span class="k">struct</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">raw</span><span class="p">:</span> <span class="n">RawYarn</span><span class="p">,</span>
  <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">BORROWED</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">const</span> <span class="n">HEAP</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="cd">/// Create a new yarn from borrowed data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">borrowed</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast_mut</span><span class="p">();</span>
    <span class="k">Self</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">:</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">BORROWED</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cd">/// Create a new yarn from owned data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">owned</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast_mut</span><span class="p">();</span>
    <span class="nn">mem</span><span class="p">::</span><span class="nf">forget</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="k">Self</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">:</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">HEAP</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cd">/// Extracts the data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">as_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span>
      <span class="c1">// SAFETY: initialized either from uniquely-owned data,</span>
      <span class="c1">// or borrowed data of lifetime 'a that outlives self.</span>
      <span class="nn">str</span><span class="p">::</span><span class="nf">from_utf8_unchecked</span><span class="p">(</span><span class="k">self</span><span class="py">.raw</span><span class="nf">.as_slice</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="nb">Drop</span> <span class="k">for</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'_</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">self</span><span class="py">.raw</span><span class="nf">.kind</span><span class="p">()</span> <span class="o">==</span> <span class="n">HEAP</span> <span class="p">{</span>
      <span class="k">let</span> <span class="n">dropped</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span>
        <span class="c1">// SAFETY: This is just reconstituting the box we dismantled</span>
        <span class="c1">// in Yarn::owned().</span>
        <span class="nn">Box</span><span class="p">::</span><span class="nf">from_raw</span><span class="p">(</span><span class="k">self</span><span class="py">.raw</span><span class="nf">.as_mut_slice</span><span class="p">())</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">as_slice_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="p">{</span>
    <span class="c1">// Same thing as as_slice, basically. This is just to make</span>
    <span class="c1">// Box::from_raw() above typecheck.</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This gives us a type that strongly resembles <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code> with only half of the bytes. We can even write code to extend the lifetime of a <code class="language-plaintext highlighter-rouge">Yarn</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">impl</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'_</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="cd">/// Removes the bound lifetime from the yarn, allocating if</span>
  <span class="cd">/// necessary.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">immortalize</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="k">'static</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">self</span><span class="py">.raw</span><span class="nf">.kind</span><span class="p">()</span> <span class="o">==</span> <span class="n">BORROWED</span> <span class="p">{</span>
      <span class="k">let</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.as_slice</span><span class="p">()</span><span class="nf">.into</span><span class="p">();</span>
      <span class="k">self</span> <span class="o">=</span> <span class="nn">Yarn</span><span class="p">::</span><span class="nf">owned</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// We need to be careful that we discard the old yarn, since its</span>
    <span class="c1">// destructor may run and delete the heap allocation we created</span>
    <span class="c1">// above.</span>
    <span class="k">let</span> <span class="n">raw</span> <span class="o">=</span> <span class="k">self</span><span class="py">.raw</span><span class="p">;</span>
    <span class="nn">mem</span><span class="p">::</span><span class="nf">forget</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="nn">Yarn</span><span class="p">::</span><span class="o">&lt;</span><span class="k">'static</span><span class="o">&gt;</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">,</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The remaining two niches can be put to use for optimizing small strings.</p> <h2 id="small-string-optimization"><a href="#small-string-optimization">Small String Optimization</a></h2> <p>C++’s <code class="language-plaintext highlighter-rouge">std::string</code> also makes the “most strings are small” assumption. In the <code class="language-plaintext highlighter-rouge">libc++</code> implementation of the standard library, <code class="language-plaintext highlighter-rouge">std::string</code>s of up to 23 bytes never hit the heap!</p> <p>C++ implementations do this by using most of the pointer, length, and capacity fields as a storage buffer for small strings, the so-called “small string optimization” (SSO). In <code class="language-plaintext highlighter-rouge">libc++</code>, in SSO mode, a <code class="language-plaintext highlighter-rouge">std::string</code>’s length fits in one byte, so the other 23 bytes can be used as storage. The capacity isn’t stored at all: an SSO string always has a capacity of 23.</p> <p><code class="language-plaintext highlighter-rouge">RawYarn</code> still has another two niches, so let’s dedicate one to a “small” representation. In small mode, the kind will be 2, and only the 16th byte will be the length.</p> <p>This is why we used the two <em>high</em> bits of <code class="language-plaintext highlighter-rouge">len</code> for our scratch space: no matter what mode it’s in, we can easily extract these bits<sup id="fnref:big-endian" role="doc-noteref"><a href="#fn:big-endian" class="footnote" rel="footnote">5</a></sup>. Some of the existing <code class="language-plaintext highlighter-rouge">RawYarn</code> methods need to be updated, though.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="nd">#[repr(C)]</span>
<span class="nd">#[derive(Copy,</span> <span class="nd">Clone)]</span>
<span class="k">struct</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="n">ptr</span><span class="p">:</span> <span class="n">MaybeUninit</span><span class="o">&lt;*</span><span class="k">mut</span> <span class="nb">u8</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">SMALL</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="k">impl</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="cd">/// Constructs a new RawYarn from raw components: a 2-bit kind,</span>
  <span class="cd">/// a length, and a pointer.</span>
  <span class="k">fn</span> <span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">SMALL</span><span class="p">);</span>
    <span class="nd">assert!</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="nn">usize</span><span class="p">::</span><span class="n">MAX</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="s">"no way you have a string that big"</span><span class="p">);</span>

    <span class="n">RawYarn</span> <span class="p">{</span>
      <span class="n">ptr</span><span class="p">:</span> <span class="nn">MaybeUninit</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span>
      <span class="n">len</span><span class="p">:</span> <span class="p">(</span><span class="n">kind</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">&amp;</span> <span class="mi">0b11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="n">BITS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">|</span> <span class="n">len</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cd">/// Extracts the slice out (regardless of kind).</span>
  <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">as_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">let</span> <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">adjust</span><span class="p">)</span> <span class="o">=</span> <span class="k">match</span> <span class="k">self</span><span class="nf">.kind</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">SMALL</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="k">self</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="k">Self</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u8</span><span class="p">,</span> <span class="nn">usize</span><span class="p">::</span><span class="n">BITS</span> <span class="o">-</span> <span class="mi">8</span><span class="p">),</span>
      <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="k">self</span><span class="py">.ptr</span><span class="nf">.assume_init</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="nn">slice</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="k">self</span><span class="py">.len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">adjust</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>In the non-<code class="language-plaintext highlighter-rouge">SMALL</code> case, we shift twice as before, but in the <code class="language-plaintext highlighter-rouge">SMALL</code> case, we need to get the high byte of the <code class="language-plaintext highlighter-rouge">len</code> field, so we need to shift down by an additional <code class="language-plaintext highlighter-rouge">usize::BITS - 8</code>. No matter what we’ve scribbled on the low bytes of <code class="language-plaintext highlighter-rouge">len</code>, we will always get just the length this way.</p> <p>We also need to use a different pointer value depending on whether we’re in <code class="language-plaintext highlighter-rouge">SMALL</code> mode. This is why <code class="language-plaintext highlighter-rouge">as_slice</code> needs to take a reference argument, since the slice data may be <em>directly</em> in <code class="language-plaintext highlighter-rouge">self</code>!</p> <p>Also, <code class="language-plaintext highlighter-rouge">ptr</code> is a <code class="language-plaintext highlighter-rouge">MaybeUninit</code> now, which will become clear in the next code listing.</p> <p>We should also provide a way to construct small strings.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">const</span> <span class="n">SSO_LEN</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="nn">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">impl</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="cd">/// Create a new small yarn. `data` must be valid for `len` bytes</span>
  <span class="cd">/// and `len` must be smaller than `SSO_LEN`.</span>
  <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">from_small</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">RawYarn</span> <span class="p">{</span>
    <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">SSO_LEN</span><span class="p">);</span>

    <span class="c1">// Create a yarn with an uninitialized pointer value (!!)</span>
    <span class="c1">// and a length whose high byte is packed with `small` and</span>
    <span class="c1">// `len`.</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">yarn</span> <span class="o">=</span> <span class="n">RawYarn</span> <span class="p">{</span>
      <span class="n">ptr</span><span class="p">:</span> <span class="nn">MaybeUninit</span><span class="p">::</span><span class="nf">uninit</span><span class="p">(),</span>
      <span class="n">len</span><span class="p">:</span> <span class="p">(</span><span class="n">SMALL</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="p">|</span> <span class="n">len</span><span class="p">)</span>
          <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="n">BITS</span> <span class="o">-</span> <span class="mi">8</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="c1">// Memcpy the data to the new yarn.</span>
    <span class="c1">// We write directly onto the `yarn` variable. We won't</span>
    <span class="c1">// overwrite the high-byte length because `len` will</span>
    <span class="c1">// never be &gt;= 16.</span>
    <span class="nn">ptr</span><span class="p">::</span><span class="nf">copy_nonoverlapping</span><span class="p">(</span>
      <span class="n">data</span><span class="p">,</span>
      <span class="o">&amp;</span><span class="k">mut</span> <span class="n">yarn</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">RawYarn</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span>
      <span class="n">data</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="n">yarn</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The precise maximum size of an SSO string is a bit more subtle than what’s given above, but it captures the spirit. The <code class="language-plaintext highlighter-rouge">RawYarn::from_small</code> illustrates why the pointer value is hidden in a <code class="language-plaintext highlighter-rouge">MaybeUninit</code>: we’re above to overwrite it with garbage, and in that case it won’t be a pointer at all.</p> <p>We can update our public <code class="language-plaintext highlighter-rouge">Yarn</code> type to use the new small representation whenever possible.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="cd">/// Create a new yarn from borrowed data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">borrowed</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast_mut</span><span class="p">();</span>

    <span class="k">if</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">SSO_LEN</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">raw</span><span class="p">:</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_small</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">},</span>
        <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">Self</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">:</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">BORROWED</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cd">/// Create a new yarn from owned data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">owned</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">data</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">SSO_LEN</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">raw</span><span class="p">:</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_small</span><span class="p">(</span><span class="n">data</span><span class="nf">.len</span><span class="p">(),</span> <span class="n">data</span><span class="nf">.as_ptr</span><span class="p">())</span> <span class="p">},</span>
        <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast_mut</span><span class="p">();</span>
    <span class="nn">mem</span><span class="p">::</span><span class="nf">forget</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="k">Self</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">:</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">HEAP</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>It’s also possible to construct a <code class="language-plaintext highlighter-rouge">Yarn</code> directly from a character now, too!</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="cd">/// Create a new yarn from borrowed data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_char</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">char</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0u8</span><span class="p">;</span> <span class="mi">4</span><span class="p">];</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.encode_utf8</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">buf</span><span class="p">);</span>
    <span class="k">Self</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">:</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_small</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">},</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>(Note that we do not need to update <code class="language-plaintext highlighter-rouge">Yarn::immortalize()</code>; why?)</p> <p>What we have now is a maybe-owned string that does not require an allocation for small strings. However, we still have an extra niche…</p> <h2 id="string-constants"><a href="#string-constants">String Constants</a></h2> <p>String constants in Rust are interesting, because we can actually detect them at compile-time<sup id="fnref:leaks" role="doc-noteref"><a href="#fn:leaks" class="footnote" rel="footnote">6</a></sup>.</p> <p>We can use the last remaining niche, 3, to represent data that came from a string constant, which means that it does not need to be boxed to be immortalized.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">const</span> <span class="n">STATIC</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="cd">/// Create a new yarn from borrowed data.</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_static</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast_mut</span><span class="p">();</span>

    <span class="k">if</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">SSO_LEN</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">raw</span><span class="p">:</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_small</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">},</span>
        <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">Self</span> <span class="p">{</span>
      <span class="n">raw</span><span class="p">:</span> <span class="nn">RawYarn</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">STATIC</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
      <span class="n">_ph</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This function is identical to <code class="language-plaintext highlighter-rouge">Yarn::borrowed</code>, except that <code class="language-plaintext highlighter-rouge">data</code> most now have a static lifetime, and we pass <code class="language-plaintext highlighter-rouge">STATIC</code> to <code class="language-plaintext highlighter-rouge">RawYarn::from_raw_parts()</code>.</p> <p>Because of how we’ve written all of the prior code, this does not require any special support in <code class="language-plaintext highlighter-rouge">Yarn::immortalize()</code> or in the low-level <code class="language-plaintext highlighter-rouge">RawYarn</code> code.</p> <p>The actual <code class="language-plaintext highlighter-rouge">byteyarn</code> library provides a <code class="language-plaintext highlighter-rouge">yarn!()</code> macro that has the same syntax as <code class="language-plaintext highlighter-rouge">format!()</code>. This is the primary way in which yarns are created. It is has been carefully written so that <code class="language-plaintext highlighter-rouge">yarn!("this is a literal")</code> always produces a <code class="language-plaintext highlighter-rouge">STATIC</code> string, rather than a heap-allocated string.</p> <h2 id="an-extra-niche-as-a-treat"><a href="#an-extra-niche-as-a-treat">An extra niche, as a treat?</a></h2> <p>Unfortunately, because of how we’ve written it, <code class="language-plaintext highlighter-rouge">Option&lt;Yarn&gt;</code> is 24 bytes, a whole word larger than a <code class="language-plaintext highlighter-rouge">Yarn</code>. However, there’s still a little gap where we can fit the <code class="language-plaintext highlighter-rouge">None</code> variant. It turns out that because of how we’ve chosen the discriminants, <code class="language-plaintext highlighter-rouge">len</code> is zero if and only if it is an empty <code class="language-plaintext highlighter-rouge">BORROWED</code> string. But this is not the only zero: if the high byte is <code class="language-plaintext highlighter-rouge">0x80</code>, this is an empty <code class="language-plaintext highlighter-rouge">SMALL</code> string. If we simply require that no other empty string is ever constructed (by marking <code class="language-plaintext highlighter-rouge">RawYarn::from_raw_parts()</code> as unsafe and specifying it should not be passed a length of zero), we can guarantee that <code class="language-plaintext highlighter-rouge">len</code> is <em>never</em> zero.</p> <p>Thus, we can update <code class="language-plaintext highlighter-rouge">len</code> to be a <code class="language-plaintext highlighter-rouge">NonZeroUsize</code>.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="nd">#[repr(C)]</span>
<span class="nd">#[derive(Copy,</span> <span class="nd">Clone)]</span>
<span class="k">struct</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="n">ptr</span><span class="p">:</span> <span class="n">MaybeUninit</span><span class="o">&lt;*</span><span class="k">mut</span> <span class="nb">u8</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">len</span><span class="p">:</span> <span class="n">NonZeroUsize</span><span class="p">,</span>  <span class="c1">// (!!)</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">RawYarn</span> <span class="p">{</span>
  <span class="cd">/// Constructs a new RawYarn from raw components: a 2-bit kind,</span>
  <span class="cd">/// a *nonzero* length, and a pointer.</span>
  <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">SMALL</span><span class="p">);</span>
    <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nd">assert!</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="nn">usize</span><span class="p">::</span><span class="n">MAX</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="s">"no way you have a string that big"</span><span class="p">);</span>

    <span class="n">RawYarn</span> <span class="p">{</span>
      <span class="n">ptr</span><span class="p">:</span> <span class="nn">MaybeUninit</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span>
      <span class="n">len</span><span class="p">:</span> <span class="nn">NonZeroUsize</span><span class="p">::</span><span class="nf">new_unchecked</span><span class="p">(</span>
        <span class="p">(</span><span class="n">kind</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">&amp;</span> <span class="mi">0b11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="n">BITS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">|</span> <span class="n">len</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This is a type especially known to the Rust compiler to have a niche bit-pattern of all zeros, which allows <code class="language-plaintext highlighter-rouge">Option&lt;Yarn&gt;</code> to be 16 bytes too. This also has the convenient property that the all zeros bit-pattern for <code class="language-plaintext highlighter-rouge">Option&lt;Yarn&gt;</code> is <code class="language-plaintext highlighter-rouge">None</code>.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>The <a href="https://docs.rs/byteyarn/latest/byteyarn/"><code class="language-plaintext highlighter-rouge">byteyarn</code></a> blurb describes what we’ve built:</p> <blockquote> <p>A <code class="language-plaintext highlighter-rouge">Yarn</code> is a highly optimized string type that provides a number of useful properties over <code class="language-plaintext highlighter-rouge">String</code>:</p> <ul> <li>Always two pointers wide, so it is always passed into and out of functions in registers.</li> <li>Small string optimization (SSO) up to 15 bytes on 64-bit architectures.</li> <li>Can be either an owned buffer or a borrowed buffer (like <code class="language-plaintext highlighter-rouge">Cow&lt;str&gt;</code>).</li> <li>Can be upcast to <code class="language-plaintext highlighter-rouge">'static</code> lifetime if it was constructed from a known-static string.</li> </ul> </blockquote> <p>There are, of course, some trade-offs. Not only do we need the assumptions we made originally to hold, but we also need to relatively care more about memory than cycle-count performance, since basic operations like reading the length of the string require more math (but no extra branching).</p> <p>The actual implementation of <code class="language-plaintext highlighter-rouge">Yarn</code> is a bit more complicated, partly to keep all of the low-level book-keeping in one place, and partly to offer an ergonomic API that makes <code class="language-plaintext highlighter-rouge">Yarn</code> into a mostly-drop-in replacement for <code class="language-plaintext highlighter-rouge">Box&lt;str&gt;</code>.</p> <p>I hope this peek under the hood has given you a new appreciation for what can be achieved by clever layout-hacking.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:size-classes" role="doc-endnote"> <p>Allocators rarely serve you memory with precisely the size you asked for. Instead, they will have some notion of a “size class” that allows them to use more efficient allocation techniques, <a href="https://mcyoung.xyz//2022/06/07/alkyne-gc">which I have written about</a>.</p> <p>As a result, if the size change in a <code class="language-plaintext highlighter-rouge">realloc()</code> would not change the size class, it becomes a no-op, especially if the allocator can take advantage of the current-size information Rust provides it. <a href="#fnref:size-classes" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:character" role="doc-endnote"> <p>Here and henceforth “character” means “32-bit Unicode scalar”. <a href="#fnref:character" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:isize" role="doc-endnote"> <p>Now, you might also point out that Rust and C do not allow an allocation whose size is larger than the pointer offset type (<code class="language-plaintext highlighter-rouge">isize</code> and <code class="language-plaintext highlighter-rouge">ptrdiff_t</code>, respectively). In practice this means that the high bit is <em>always</em> zero according to the language’s own rules.</p> <p>This is true, but we need to steal two bits, and I wanted to demonstrate that this is an extremely reasonable desire. 64-bit integers are so comically large. <a href="#fnref:isize" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:two-shifts" role="doc-endnote"> <p>Interestingly, LLVM will compile <code class="language-plaintext highlighter-rouge">(x &lt;&lt; 2) &gt;&gt; 2</code> to</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">movabs</span> <span class="n">rax</span><span class="p">,</span><span class="mh">0x3fffffffffffffff</span>
<span class="n">and</span>    <span class="n">rax</span><span class="p">,</span><span class="n">rdi</span>
<span class="n">ret</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">x86 Assembly</div></div></div> <p>If we want to play the byte-for-byte game, this costs 14 bytes when encoded in the Intel variable-length encoding. You would think that two shifts would result in marginally smaller code, but no, since the input comes in in <code class="language-plaintext highlighter-rouge">rdi</code> and needs to wind up in <code class="language-plaintext highlighter-rouge">rax</code>.</p> <p>On RISC-V, though, it seems to decide that two shifts is in fact cheaper, and will even optimize <code class="language-plaintext highlighter-rouge">x &amp; 0x3fff_ffff_ffff_ffff</code> back into two shifts. <a href="#fnref:two-shifts" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:big-endian" role="doc-endnote"> <p>This only works on little endian. Thankfully all computers are little endian. <a href="#fnref:big-endian" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:leaks" role="doc-endnote"> <p>Technically, a <code class="language-plaintext highlighter-rouge">&amp;'static str</code> may also point to leaked memory. For our purposes, there is no essential difference. <a href="#fnref:leaks" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name>Miguel Young de la Sota</name></author><category term="dark-arts"/><category term="pointers"/><category term="rust"/><summary type="html"><![CDATA[I write compilers for fun. I can’t help it. Consequently, I also write a lot of parsers. In systems programming, it’s usually a good idea to try to share memory rather than reuse it, so as such my AST types tend to look like this.]]></summary></entry></feed>