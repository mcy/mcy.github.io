<!DOCTYPE html> <html lang="en-us"> <head> <link href="https://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> mcyoung </title> <script async src="https://mcyoung.xyz/public/js/redirect.js"></script> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/syntax-overrides.css"> <link rel="stylesheet" href="https://mcyoung.xyz/public/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"> <link rel="preload" href="https://mcyoung.xyz/public/fonts/abril-fatface.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/rokkitt-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="https://mcyoung.xyz/public/fonts/spline-mono-italic.woff2" as="font" type="font/woff2" crossorigin> <link rel="shortcut icon" href="https://mcyoung.xyz/public/favicon.ico"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <script src="https://mcyoung.xyz/public/js/minimap.js"></script> <script data-goatcounter="https://mcy.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> </head> <body> <div class="sidebar"> <div class="sidebar-avatar hide-if-mobile"> <a href="https://mcyoung.xyz"> <img class="sidebar-avatar" src="https://mcyoung.xyz/public/images/avatar.png" alt="Yeah, I drew this. Check out my art blog."></a> </div> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1><a href="https://mcyoung.xyz"> mcyoung </a></h1> <div class="lead hide-if-mobile">I'm Miguel. I write about compilers, performance, and silly computer things. I also draw Pokémon. </div> </div> <hr class="hide-if-mobile"/> <nav class="sidebar-nav"> <a class="sidebar-nav-item active" href="https://mcyoung.xyz">Home</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/about">About</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/posts">Posts</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/tags">Tags</a> </nav> <nav class="sidebar-nav"> <a class="sidebar-nav-item " href="https://art.mcyoung.xyz">Art</a> • <a class="sidebar-nav-item" href="https://github.com/mcy">GitHub</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/resume">Resumé</a> • <a class="sidebar-nav-item" href="https://mcyoung.xyz/syllabus">Syllabus</a> </nav> <br class="hide-if-mobile"/> <span class="hide-if-mobile"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota</span> </div> </div> <div class="content container"><div class="posts"> <div class="post-preview"> <div class="post-title"> <span class="post-meta"> 2025-04-14 • 4177 words • 34 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#dark-arts">#dark-arts</a> • <a href="https://mcyoung.xyz/tags.html#assembly">#assembly</a> </span> <h1><a href="/2025/04/14/target-triples/"> What the Hell Is a Target Triple? </a></h1> </div> <div class="post"> <p><em>Cross-compiling</em> is taking a computer program and compiling it for a machine that isn’t the one hosting the compilation. Although historically compilers would only compile for the host machine, this is considered an anachronism: all serious native compilers are now cross-compilers.</p> <p>After all, you don’t want to be building your iPhone app on literal iPhone hardware.</p> <p>Many different compilers have different mechanisms for classifying and identifying <em>targets</em>. A target is a platform that the compiler can produce executable code for. However, due to the runaway popularity of LLVM, virtually all compilers now use <em>target triples</em>. You may have already encountered one, such as the venerable <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code>, or the evil <code class="language-plaintext highlighter-rouge">x86_64-pc-windows</code>. This system is convoluted and <em>almost</em> self-consistent.</p> <p>But what is a target triple, and where did they come from?</p> <h2 id="stupid-gcc-conventions"><a href="#stupid-gcc-conventions">Stupid GCC Conventions</a></h2> <p>So if you go poking around the <a href="https://wiki.osdev.org/Target_Triplet">Target Triplet</a> page on OSDev, you will learn both true and false things about target triples, because this page is about GCC, not native compilers in general.</p> <blockquote> <p>Generally, there is no “ground truth” for what a target triple is. There isn’t some standards body that assigns these names. But as we’ll see, LLVM is the trendsetter.</p> </blockquote> <p>If you run the following command you can learn the target triple for your machine:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>gcc <span class="nt">-dumpmachine</span>
<span class="go">x86_64-linux-gnu</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Now if you’re at all familiar with any system that makes pervasive use of target triples, you will know that this is <em>not a target triple</em>, because this target’s name is <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-gnu</code>, which is what both <code class="language-plaintext highlighter-rouge">clang</code> and <code class="language-plaintext highlighter-rouge">rustc</code> call-</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>clang <span class="nt">-dumpmachine</span>
<span class="go">x86_64-pc-linux-gnu
</span><span class="gp">$</span><span class="w"> </span>rustc <span class="nt">-vV</span> | <span class="nb">grep </span>host
<span class="go">host: x86_64-unknown-linux-gnu</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Oh no.</p> <p>Well, GCC is missing the the <code class="language-plaintext highlighter-rouge">pc</code> or <code class="language-plaintext highlighter-rouge">unknown</code> component, and that’s specifically a GCC thing; it allows omitting parts of the triple in such a way that is unambiguous. And they are a GCC invention, so perhaps it’s best to start by assessing GCC’s beliefs.</p> <p>According to GCC, a target triple is a string of the form <code class="language-plaintext highlighter-rouge">&lt;machine&gt;-&lt;vendor&gt;-&lt;os&gt;</code>. The “machine” part unambiguously identifies the architecture of the system. Practically speaking, this is the assembly language that the compiler will output at the end. The “vendor” part is essentially irrelevant, and mostly is of benefit for sorting related operating systems together. Finally, the “os” part identifies the operating system that this code is being compiled for. The main thing this identifies for a compiler is the executable format: COFF/PE for Windows, Mach-O for Apple’s operating systems, ELF for Linux and friends, and so on (this, however, is an oversimplification).</p> <p>But you may notice that <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-gnu</code> has an extra, fourth entry<sup id="fnref:quad" role="doc-noteref"><a href="#fn:quad" class="footnote" rel="footnote">1</a></sup>, which plays many roles but is most often called the target’s “ABI”. For <code class="language-plaintext highlighter-rouge">linux</code>, it identifies the target’s libc, which has consequences for code generation of some language features, such as thread locals and unwinding. It is optional, since many targets only have one ABI.</p> <h3 id="cross-compiling-with-gcc"><a href="#cross-compiling-with-gcc">Cross Compiling with GCC</a></h3> <p>A critical piece of history here is to understand the really stupid way in which GCC does cross compiling. Traditionally, each GCC binary would be built for <em>one</em> target triple. The full name of a GCC binary would include the triple, so when cross-compiling, you would compile with <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-gcc</code>, link with <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux-ld</code>, and so on (here, <code class="language-plaintext highlighter-rouge">gcc</code> is not the fourth ABI component of a triple; it’s just one of the tools in the <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code> toolchain).</p> <p>Nobody with a brain does this<sup id="fnref:toolchain" role="doc-noteref"><a href="#fn:toolchain" class="footnote" rel="footnote">2</a></sup>. LLVM and all cross compilers that follow it instead put all of the backends in one binary, and use a compiler flag like <code class="language-plaintext highlighter-rouge">--target</code> to select the backend.</p> <p>But regardless, this is where target triples come from, and why they look the way they look: they began as prefixes for the names of binaries in <code class="language-plaintext highlighter-rouge">autoconf</code> scripts.</p> <p>But GCC is ancient technology. In the 21st century, LLVM rules all native compilers.</p> <h2 id="names-in-the-ancient-language"><a href="#names-in-the-ancient-language">Names in the Ancient Language</a></h2> <p>LLVM’s target triple list is the one that should be regarded as “most official”, for a few reasons:</p> <ol> <li> <p>Inertia. Everyone and their mother uses LLVM as a middleend and backend, so its naming conventions bubble up into language frontends like <code class="language-plaintext highlighter-rouge">clang</code>, <code class="language-plaintext highlighter-rouge">rustc</code> <code class="language-plaintext highlighter-rouge">swiftc</code>, <code class="language-plaintext highlighter-rouge">icc</code>, and <code class="language-plaintext highlighter-rouge">nvcc</code>.</p> </li> <li> <p>Upstream work by silicon and operating system vendors. LLVM is what people get hired to work on for the most part, not GCC, so its platform-specific conventions often reflect the preferences of vendors.</p> </li> </ol> <p>These are in no small part because Apple, Google, and Nvidia have armies of compiler engineers contributing to LLVM.</p> <p>The sources for “official” target triples are many. Generally, I would describe a target triple as “official” when:</p> <ol> <li> <p>A major compiler (so, <code class="language-plaintext highlighter-rouge">clang</code> or <code class="language-plaintext highlighter-rouge">rustc</code>) uses it. Rust does a way better job than LLVM of documenting their targets, so I prefer to give it deference. You can find Rust’s official triples <a href="https://doc.rust-lang.org/rustc/platform-support.html">here</a>.</p> </li> <li> <p>A platform developer (e.g., a hardware manufacturer, OS vendor) distributes a toolchain with a target triple in the <code class="language-plaintext highlighter-rouge">arch-vendor-os</code> format.</p> </li> </ol> <p>So, what are the names in class (1)? LLVM does not really go out of its way to provide such a list. But we gotta start somewhere, so source-diving it is.</p> <p>We can dig into <a href="https://llvm.org/doxygen/Triple_8cpp_source.html"><code class="language-plaintext highlighter-rouge">Triple.cpp</code></a> in LLVM’s target triple parser. It lists all of the names LLVM recognizes for each part of a triple. Looking at <code class="language-plaintext highlighter-rouge">Triple::parseArch()</code>, we have the following names, including many, many aliases. The first item on the right column is LLVM’s preferred name for the architecture, as indicated by <code class="language-plaintext highlighter-rouge">Triple::getArchTypeName()</code>.</p> <table> <thead> <tr> <th>Architecture</th> <th>Possible Names</th> </tr> </thead> <tbody> <tr> <td><a href="https://en.wikipedia.org/wiki/X86">Intel x86</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">i386</code>, <code class="language-plaintext highlighter-rouge">i486</code>, <code class="language-plaintext highlighter-rouge">i586</code>, <code class="language-plaintext highlighter-rouge">i686</code>, <code class="language-plaintext highlighter-rouge">i786</code>, <code class="language-plaintext highlighter-rouge">i886</code>, <code class="language-plaintext highlighter-rouge">i986</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/X86">Intel x86</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">x86_64</code>, <code class="language-plaintext highlighter-rouge">amd64</code>, <code class="language-plaintext highlighter-rouge">x86_86h</code><sup id="fnref:x86_86h" role="doc-noteref"><a href="#fn:x86_86h" class="footnote" rel="footnote">3</a></sup></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">arm</code>, <code class="language-plaintext highlighter-rouge">xscale</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (32-bit, big-endian)</td> <td><code class="language-plaintext highlighter-rouge">armeb</code>, <code class="language-plaintext highlighter-rouge">xscaleeb</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">aarch64</code>, <code class="language-plaintext highlighter-rouge">aarch64e</code>, <code class="language-plaintext highlighter-rouge">aarch64ec</code>, <code class="language-plaintext highlighter-rouge">arm64</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (64-bit, big-endian)</td> <td><code class="language-plaintext highlighter-rouge">aarch64_be</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> (64-bit, ILP32<sup id="fnref:ilp32" role="doc-noteref"><a href="#fn:ilp32" class="footnote" rel="footnote">4</a></sup>)</td> <td><code class="language-plaintext highlighter-rouge">aarch64_32</code>, <code class="language-plaintext highlighter-rouge">arm64_32</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family#Thumb">ARM Thumb</a></td> <td><code class="language-plaintext highlighter-rouge">thumb</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARM_architecture_family#Thumb">ARM Thumb</a> (big-endian)</td> <td><code class="language-plaintext highlighter-rouge">thumbeb</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a><sup id="fnref:power" role="doc-noteref"><a href="#fn:power" class="footnote" rel="footnote">5</a></sup> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">powerpc</code>, <code class="language-plaintext highlighter-rouge">powerpcspe</code>, <code class="language-plaintext highlighter-rouge">ppc</code>, <code class="language-plaintext highlighter-rouge">ppc32</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a> (little-endian)</td> <td><code class="language-plaintext highlighter-rouge">powerpcle</code>, <code class="language-plaintext highlighter-rouge">ppcle</code>, <code class="language-plaintext highlighter-rouge">ppc32le</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">powerpc64</code>, <code class="language-plaintext highlighter-rouge">ppu</code>, <code class="language-plaintext highlighter-rouge">ppc64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/PowerPC">IBM PowerPC</a> (64-bit, little-endian)</td> <td><code class="language-plaintext highlighter-rouge">powerpc64le</code>, <code class="language-plaintext highlighter-rouge">ppc64le</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">mips</code>, <code class="language-plaintext highlighter-rouge">mipseb</code>, <code class="language-plaintext highlighter-rouge">mipsallegrex</code>, <code class="language-plaintext highlighter-rouge">mipsisa32r6</code>, <code class="language-plaintext highlighter-rouge">mipsr6</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (32-bit, little-endian)</td> <td><code class="language-plaintext highlighter-rouge">mipsel</code>, <code class="language-plaintext highlighter-rouge">mipsallegrexel</code>, <code class="language-plaintext highlighter-rouge">mipsisa32r6el</code>, <code class="language-plaintext highlighter-rouge">mipsr6el</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">mips64</code>, <code class="language-plaintext highlighter-rouge">mips64eb</code>, <code class="language-plaintext highlighter-rouge">mipsn32</code>, <code class="language-plaintext highlighter-rouge">mipsisa64r6</code>, <code class="language-plaintext highlighter-rouge">mips64r6</code>, <code class="language-plaintext highlighter-rouge">mipsn32r6</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_architecture">MIPS</a> (64-bit, little-endian)</td> <td><code class="language-plaintext highlighter-rouge">mips64el</code>, <code class="language-plaintext highlighter-rouge">mipsn32el</code>, <code class="language-plaintext highlighter-rouge">mipsisa64r6el</code>, <code class="language-plaintext highlighter-rouge">mips64r6el</code>, <code class="language-plaintext highlighter-rouge">mipsn32r6el</code></td> </tr> <tr> <td>[RISC-V] (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">riscv32</code></td> </tr> <tr> <td>[RISC-V] (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">riscv64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Z/Architecture">IBM z/Architecture</a></td> <td><code class="language-plaintext highlighter-rouge">s390x</code><sup id="fnref:s390x" role="doc-noteref"><a href="#fn:s390x" class="footnote" rel="footnote">6</a></sup>, <code class="language-plaintext highlighter-rouge">systemz</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a></td> <td><code class="language-plaintext highlighter-rouge">sparc</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a> (little-endian)</td> <td><code class="language-plaintext highlighter-rouge">sparcel</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">sparcv6</code>, <code class="language-plaintext highlighter-rouge">sparc64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/WebAssembly">WebAssembly</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">wasm32</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/WebAssembly">WebAssembly</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">wasm64</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Loongson">Loongson</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">loongarch32</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Loongson">Loongson</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">loongarch64</code></td> </tr> </tbody> <tbody> <tr> <td><a href="https://en.wikipedia.org/wiki/Radeon_HD_2000_series">Radeon R600</a></td> <td><code class="language-plaintext highlighter-rouge">r600</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Graphics_Core_Next">AMD GCN</a></td> <td><code class="language-plaintext highlighter-rouge">amdgcn</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Qualcomm_Hexagon">Qualcomm Hexagon</a></td> <td><code class="language-plaintext highlighter-rouge">hexagon</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Parallel_Thread_Execution">Nvidia PTX</a><sup id="fnref:ptx" role="doc-noteref"><a href="#fn:ptx" class="footnote" rel="footnote">7</a></sup> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">nvptx</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Parallel_Thread_Execution">Nvidia PTX</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">nvptx64</code></td> </tr> <tr> <td>AMD IL<sup id="fnref:amdil" role="doc-noteref"><a href="#fn:amdil" class="footnote" rel="footnote">8</a></sup> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">amdil</code></td> </tr> <tr> <td>AMD IL (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">amdil64</code></td> </tr> <tr> <td>Direct-X IL</td> <td><code class="language-plaintext highlighter-rouge">dxil</code>, …</td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Heterogeneous_System_Architecture">HSAIL</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">hsail</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Heterogeneous_System_Architecture">HSAIL</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">hsail64</code></td> </tr> <tr> <td>[Khronos SPIR] (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">spir</code></td> </tr> <tr> <td>[Khronos SPIR] (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">spir64</code></td> </tr> <tr> <td>[Khronos SPIR-V]</td> <td><code class="language-plaintext highlighter-rouge">spirv</code>, …</td> </tr> <tr> <td>[Khronos SPIR-V] (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">spirv32</code>, …</td> </tr> <tr> <td>[Khronos SPIR-V] (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">spirv64</code>, …</td> </tr> <tr> <td><a href="https://developer.android.com/guide/topics/renderscript/compute">Android RenderScript</a> (32-bit)</td> <td><code class="language-plaintext highlighter-rouge">renderscript32</code></td> </tr> <tr> <td><a href="https://developer.android.com/guide/topics/renderscript/compute">Android RenderScript</a> (64-bit)</td> <td><code class="language-plaintext highlighter-rouge">renderscript64</code></td> </tr> <tr> <td><a href="https://en.wikichip.org/wiki/movidius/microarchitectures/shave_v2.0">Movidius SHAVE</a></td> <td><code class="language-plaintext highlighter-rouge">shave</code></td> </tr> </tbody> <tbody> <tr> <td><a href="https://en.wikipedia.org/wiki/AVR_microcontrollers">Atmel AVR</a></td> <td><code class="language-plaintext highlighter-rouge">avr</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Motorola_68000_series">Motorola 68k</a></td> <td><code class="language-plaintext highlighter-rouge">m68k</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/ARC_(processor)">Argonaut ARC</a></td> <td><code class="language-plaintext highlighter-rouge">arc</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/TI_MSP430">Texas Instruments MSP430</a></td> <td><code class="language-plaintext highlighter-rouge">msp430</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Tensilica">Tensilica Xtensa</a></td> <td><code class="language-plaintext highlighter-rouge">xtensa</code></td> </tr> <tr> <td><a href="https://c-sky.github.io/">C-SKY</a></td> <td><code class="language-plaintext highlighter-rouge">csky</code></td> </tr> <tr> <td><a href="https://github.com/cpc/openasip">OpenASIP</a></td> <td><code class="language-plaintext highlighter-rouge">tce</code></td> </tr> <tr> <td><a href="https://github.com/cpc/openasip">OpenASIP</a> (little-endian)</td> <td><code class="language-plaintext highlighter-rouge">tcele</code></td> </tr> <tr> <td><a href="https://q3k.org/lanai.html">Myracom Lanai</a></td> <td><code class="language-plaintext highlighter-rouge">lanai</code></td> </tr> <tr> <td>XMOS xCore</td> <td><code class="language-plaintext highlighter-rouge">xcore</code></td> </tr> <tr> <td>Kalimba<sup id="fnref:idk" role="doc-noteref"><a href="#fn:idk" class="footnote" rel="footnote">9</a></sup></td> <td><code class="language-plaintext highlighter-rouge">kalimba</code></td> </tr> <tr> <td>ve<sup id="fnref:idk:1" role="doc-noteref"><a href="#fn:idk" class="footnote" rel="footnote">9</a></sup></td> <td><code class="language-plaintext highlighter-rouge">ve</code></td> </tr> </tbody> </table> <p>Here we begin to see that target triples are not a neat system. They are <em>hell</em>. Where a list of architecture names contains a “…”, it means that LLVM accepts many more names.</p> <p>The problem is that architectures often have <em>versions</em> and <em>features</em>, which subtly change how the compiler generates code. For example, when compiling for an <code class="language-plaintext highlighter-rouge">x86_64</code>, we may want to specify that we want AVX512 instructions to be used. On LLVM, you might do that with <code class="language-plaintext highlighter-rouge">-mattr=+avx512</code>. Every architecture has a subtly-different way of doing this, because every architecture had a <em>different GCC</em>! Each variant of GCC would put different things behind <code class="language-plaintext highlighter-rouge">-mXXX</code> flags (<code class="language-plaintext highlighter-rouge">-m</code> for “machine”), meaning that the interface is not actually that uniform. The meanings of <code class="language-plaintext highlighter-rouge">-march</code>, <code class="language-plaintext highlighter-rouge">-mcpu</code>, <code class="language-plaintext highlighter-rouge">-mtune</code>, and <code class="language-plaintext highlighter-rouge">-mattr</code> thus vary wildly for this reason.</p> <p>Because LLVM is supposed to replace GCC (for the most part), it replicates a lot of this wacky behavior.</p> <p>So uh, we gotta talk about 32-bit ARM architecture names.</p> <h3 id="armtargetparsercpp"><a href="#armtargetparsercpp"><code class="language-plaintext highlighter-rouge">ARMTargetParser.cpp</code></a></h3> <p>There is a hellish file in LLVM dedicated to parsing ARM architecture names. Although members of the ARM family have many configurable features (which you can discover with <code class="language-plaintext highlighter-rouge">llc -march aarch64 -mattr help</code><sup id="fnref:llc" role="doc-noteref"><a href="#fn:llc" class="footnote" rel="footnote">10</a></sup>), the name of the architecture is somewhat meaningful, and can hav many options, mostly relating to the many versions of ARM that exist.</p> <p>How bad is it? Well, we can look at all of the various ARM targets that <code class="language-plaintext highlighter-rouge">rustc</code> supports with <code class="language-plaintext highlighter-rouge">rustc --print target-list</code>:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>rustc <span class="nt">--print</span> target-list | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'arm|aarch|thumb'</span> <span class="se">\</span>
<span class="go">  | cut -d- -f1 | sort | uniq
aarch64
aarch64_be
arm
arm64_32
arm64e
arm64ec
armeb
armebv7r
armv4t
armv5te
armv6
armv6k
armv7
armv7a
armv7k
armv7r
armv7s
armv8r
thumbv4t
thumbv5te
thumbv6m
thumbv7a
thumbv7em
thumbv7m
thumbv7neon
thumbv8m.base
thumbv8m.main</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>Most of these are 32-bit ARM versions, with profile information attached. These correspond to the names given <a href="https://en.wikipedia.org/wiki/ARM_architecture_family#Cores">here</a>. Why does ARM stick version numbers in the architecture name, instead of using <code class="language-plaintext highlighter-rouge">-mcpu</code> like you would on x86 (e.g. <code class="language-plaintext highlighter-rouge">-mcpu alderlake</code>)? I have no idea, because ARM is not my strong suit. It’s likely because of how early ARM support was added to GCC.</p> <p>Internally, LLVM calls these “subarchitectures”, although ARM gets special handling because there’s so many variants. SPIR-V, Direct X, and MIPS all have subarchitectures, so you might see something like <code class="language-plaintext highlighter-rouge">dxilv1.7</code> if you’re having a bad day.</p> <p>Of course, LLVM’s ARM support also sports some naughty subarchitectures not part of this system, with naughty made up names.</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">arm64e</code> is an Apple thing, which is an enhancement of <code class="language-plaintext highlighter-rouge">aarch64</code> present on some Apple hardware, which adds their own flavor of <a href="https://developer.apple.com/documentation/security/preparing-your-app-to-work-with-pointer-authentication">pointer authentication</a> and some other features.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">arm64ec</code> is a completely unrelated Microsoft invention that is essentially “<code class="language-plaintext highlighter-rouge">aarch64</code> but with an <code class="language-plaintext highlighter-rouge">x86_64</code>-ey ABI” to make <code class="language-plaintext highlighter-rouge">x86_64</code> emulation on what would otherwise be <code class="language-plaintext highlighter-rouge">aarch64-pc-windows-msvc</code> target somewhat more amenable.</p> </li> </ul> <blockquote> <p>Why the Windows people invented a whole other ABI instead of making things clean and simple like Apple did with Rosetta on ARM MacBooks? I have no idea, but <a href="http://www.emulators.com/docs/abc_arm64ec_explained.htm">http://www.emulators.com/docs/abc_arm64ec_explained.htm</a> contains various excuses, none of which I am impressed by. My read is that their compiler org was just worse at life than Apple’s, which is not surprising, since Apple does compilers better than anyone else in the business.</p> </blockquote> <p>Actually, since we’re on the topic of the names of architectures, I have a few things I need to straighten out.</p> <h3 id="made-up-names-of-architectures"><a href="#made-up-names-of-architectures">Made Up Names of Architectures</a></h3> <p>x86 and ARM both seem to attract a lot of people making up nicknames for them, which leads to a lot of confusion in:</p> <ol> <li> <p>What the “real” name is.</p> </li> <li> <p>What name a particular toolchain wants.</p> </li> <li> <p>What name you should use in your own cosmopolitan tooling.</p> </li> </ol> <p>Let’s talk about the incorrect names people like to make up for them. Please consider the following a relatively normative reference on what people call these architectures, based on my own experience with many tools.</p> <p>When we say “x86” unqualified, in 2025, we almost always mean <code class="language-plaintext highlighter-rouge">x86_64</code>, because 32-bit x86 is dead. If you need to talk about 32-bit x86, you should either say “32-bit x86”, “protected mode”<sup id="fnref:x86-modes" role="doc-noteref"><a href="#fn:x86-modes" class="footnote" rel="footnote">11</a></sup>, or “i386” (the first Intel microarchitecture that implemented protected mode)<sup id="fnref:i386" role="doc-noteref"><a href="#fn:i386" class="footnote" rel="footnote">12</a></sup>. You should not call it <code class="language-plaintext highlighter-rouge">x86_32</code> or just <code class="language-plaintext highlighter-rouge">x86</code>.</p> <p>You might also call it IA-32 for Intel Architecture 32, (or <code class="language-plaintext highlighter-rouge">ia32</code>), but nobody calls it that and you risk confusing people with <code class="language-plaintext highlighter-rouge">ia64</code>, or IA-64, the official name of Intel’s failed general-purpose VLIW architecture, <a href="https://en.wikipedia.org/wiki/Itanium">Itanium</a>, which is in no way compatible with x86. <code class="language-plaintext highlighter-rouge">ia64</code> was what GCC and LLVM named Itanium triples with. Itanium support was drowned in a bathtub during the Obama administration, so it’s not really relevant anymore. Rust has never had official Itanium support.</p> <p>32-bit x86 is <em>extremely not</em> called “x32”; this is what Linux used to call its x86 ILP32<sup id="fnref:ilp32:1" role="doc-noteref"><a href="#fn:ilp32" class="footnote" rel="footnote">4</a></sup> variant before it was removed (which, following the ARM names, would have been called <code class="language-plaintext highlighter-rouge">x86_6432</code>).</p> <p>There are also many ficticious names for 64-bit x86, which you should avoid unless you want the younger generation to make fun of you. <code class="language-plaintext highlighter-rouge">amd64</code> refers to AMD’s original implementation of long mode in their K8 microarchitecture, first shipped in their <a href="https://en.wikipedia.org/wiki/Athlon_64">Athlon 64</a> product. AMD still makes the best x86 chips (I am writing this on a machine socketed with a Zen2 Threadripper), sure, but calling it <code class="language-plaintext highlighter-rouge">amd64</code> is silly and also looks a lot like <code class="language-plaintext highlighter-rouge">arm64</code>, and I am honestly kinda annoyed at how much Go code I’ve seen with files named <code class="language-plaintext highlighter-rouge">fast_arm64.s</code> and <code class="language-plaintext highlighter-rouge">fast_amd64.s</code>. Debian also uses <code class="language-plaintext highlighter-rouge">amd64</code>/<code class="language-plaintext highlighter-rouge">arm64</code>, which makes browsing packages kind of annoying.</p> <p>On that topic, you should <em>absolutely not</em> call 64-bit mode <code class="language-plaintext highlighter-rouge">k8</code>, after the AMD K8. Nobody except for weird computer taxonomists like me know what that is. But Bazel calls it that, and it’s really irritating<sup id="fnref:piii" role="doc-noteref"><a href="#fn:piii" class="footnote" rel="footnote">13</a></sup>.</p> <p>You should also not call it <code class="language-plaintext highlighter-rouge">x64</code>. Although LLVM does accept <code class="language-plaintext highlighter-rouge">amd64</code> for historical purposes, no one calls it <code class="language-plaintext highlighter-rouge">x64</code> except for Microsoft. And even though it is fairly prevalent on Windows, I absolutely give my gamedev friends a hard time when they write <code class="language-plaintext highlighter-rouge">x64</code>.</p> <p>On the ARM side, well. Arm<sup id="fnref:arm-holdings" role="doc-noteref"><a href="#fn:arm-holdings" class="footnote" rel="footnote">14</a></sup> has a bad habit of not using consistent naming for 64-bit ARM, since they used both AArch64 and ARM64 for it. However, in compiler land, <code class="language-plaintext highlighter-rouge">aarch64</code> appears to be somewhat more popular.</p> <p>You should also probably stick to the LLVM names for the various architectures, instead of picking your favorite Arm Cortex name (like <code class="language-plaintext highlighter-rouge">cortex_m0</code>).</p> <h2 id="vendors-and-operating-systems"><a href="#vendors-and-operating-systems">Vendors and Operating Systems</a></h2> <p>The worst is over. Let’s now move onto examinining the rest of the triple: the platform vendor, and the operating system.</p> <p>The vendor is intended to identify who is responsible for the ABI definition for that target. Although provides little to no value to the compiler itself, but it does help to sort related targets together. Sort of.</p> <p>Returning to <code class="language-plaintext highlighter-rouge">llvm::Triple</code>, we can examine <code class="language-plaintext highlighter-rouge">Triple::VendorType</code>. Vendors almost always correspond to companies which develop operating systems or other platforms that code runs on, with some exceptions.</p> <p>We can also get the vendors that <code class="language-plaintext highlighter-rouge">rustc</code> knows about with a handy dandy command:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">rustc --print target-list | grep -P '\w+-\w+-' | cut -d- -f2 | sort | uniq</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Console</div></div></div> <p>The result is this. This is just a representative list; I have left off a few that are not going to be especially recognizeable.</p> <table> <thead> <tr> <th>Vendor</th> <th>Name</th> <th>Example Triple</th> </tr> </thead> <tbody> <tr> <td>Vendor Unknown<sup id="fnref:unknown" role="doc-noteref"><a href="#fn:unknown" class="footnote" rel="footnote">15</a></sup></td> <td><code class="language-plaintext highlighter-rouge">unknown</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code></td> </tr> <tr> <td>“PC”</td> <td><code class="language-plaintext highlighter-rouge">pc</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-pc-windows-msvc</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/AMD">Advanced Micro Devices Inc.</a></td> <td><code class="language-plaintext highlighter-rouge">amd</code></td> <td><code class="language-plaintext highlighter-rouge">amdgcn-amd-gfx906</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Apple_Inc.">Apple Inc.</a></td> <td><code class="language-plaintext highlighter-rouge">apple</code></td> <td><code class="language-plaintext highlighter-rouge">aarch64-apple-ios-sim</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Intel">Intel Corporation</a></td> <td><code class="language-plaintext highlighter-rouge">intel</code></td> <td><code class="language-plaintext highlighter-rouge">i386-intel-elfiamcu</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/IBM">IBM Corporation</a></td> <td><code class="language-plaintext highlighter-rouge">ibm</code></td> <td><code class="language-plaintext highlighter-rouge">powerpc64-ibm-aix</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Mesa_(computer_graphics)">Mesa3D Project</a></td> <td><code class="language-plaintext highlighter-rouge">mesa</code></td> <td><code class="language-plaintext highlighter-rouge">amdgcn-mesa-mesa3d</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/MIPS_Technologies">MIPS Technologies LLC</a></td> <td><code class="language-plaintext highlighter-rouge">mti</code></td> <td><code class="language-plaintext highlighter-rouge">mips-mti-none-elf</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Nintendo">Nintendo</a></td> <td><code class="language-plaintext highlighter-rouge">nintendo</code></td> <td><code class="language-plaintext highlighter-rouge">armv6k-nintendo-3ds</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Nvidia">Nvidia Corporation</a></td> <td><code class="language-plaintext highlighter-rouge">nvidia</code></td> <td><code class="language-plaintext highlighter-rouge">nvptx64-nvidia-cuda</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Sony_Interactive_Entertainment">Sony Interactive Entertainment</a></td> <td><code class="language-plaintext highlighter-rouge">scei</code>, <code class="language-plaintext highlighter-rouge">sie</code>, <code class="language-plaintext highlighter-rouge">sony</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-sie-ps5</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Sun_Microsystems">Sun Microsystems</a></td> <td><code class="language-plaintext highlighter-rouge">sun</code></td> <td><code class="language-plaintext highlighter-rouge">sparcv9-sun-solaris</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/SUSE_S.A.">SUSE S. A.</a></td> <td><code class="language-plaintext highlighter-rouge">suse</code></td> <td><code class="language-plaintext highlighter-rouge">aarch64-suse-linux</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Red_Hat">Red Hat, Inc</a></td> <td><code class="language-plaintext highlighter-rouge">redhat</code></td> <td><code class="language-plaintext highlighter-rouge">x86_64-redhat-linux</code></td> </tr> <tr> <td><a href="https://en.wikipedia.org/wiki/Universal_Windows_Platform">Universal Windows Platform</a></td> <td><code class="language-plaintext highlighter-rouge">uwp</code></td> <td><code class="language-plaintext highlighter-rouge">aarch64-uwp-windows-msvc</code></td> </tr> </tbody> </table> <p>Most vendors are the names of organizations that produce hardware or operating systems. For example <code class="language-plaintext highlighter-rouge">suse</code> and <code class="language-plaintext highlighter-rouge">redhat</code> are used for those organizations’ Linux distributions, as a funny branding thing. Some vendors are projects, like the <code class="language-plaintext highlighter-rouge">mesa</code> vendor used with the Mesa3D OpenGL implementation’s triples.</p> <p>The <code class="language-plaintext highlighter-rouge">unknown</code> vendor is used for cases where the vendor is not specified or just not important. For example, the canonical Linux triple is <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code>… although one could argue it should be <code class="language-plaintext highlighter-rouge">x86_64-torvalds-linux</code>. It is not uncommon for companies that sell/distribute Linux distributions to have their own target triples, as do SUSE and sometimes RedHat. Notably, there are no triples with a <code class="language-plaintext highlighter-rouge">google</code> vendor, even though <code class="language-plaintext highlighter-rouge">aarch64-linux-android</code> and <code class="language-plaintext highlighter-rouge">aarch64-unknown-fuchsia</code> should really be called <code class="language-plaintext highlighter-rouge">aarch64-google-linux-android</code> and <code class="language-plaintext highlighter-rouge">aarch64-google-fuchsia</code>. The target triple system begins to show cracks here.</p> <p>The <code class="language-plaintext highlighter-rouge">pc</code> vendor is a bit weirder, and is mostly used by Windows targets. The standard Windows target is <code class="language-plaintext highlighter-rouge">x86_64-pc-windows-msvc</code>, but really it should have been <code class="language-plaintext highlighter-rouge">x86_64-microsoft-windows-msvc</code>. This is likely complicated by the fact that there is also a <code class="language-plaintext highlighter-rouge">x86_64-pc-windows-gnu</code> triple, which is for <a href="https://en.wikipedia.org/wiki/MinGW">MinGW</a> code. This platform, despite running on Windows, is not provided by Microsoft, so it would probably make more sense to be called <code class="language-plaintext highlighter-rouge">x86_64-unknown-windows-gnu</code>.</p> <p>But not all Windows targets are <code class="language-plaintext highlighter-rouge">pc</code>! <a href="https://en.wikipedia.org/wiki/Universal_Windows_Platform">UWP</a> apps use a different triple, that replaces the <code class="language-plaintext highlighter-rouge">pc</code> with <code class="language-plaintext highlighter-rouge">uwp</code>. <code class="language-plaintext highlighter-rouge">rustc</code> provides targets for Windows 7 backports that use a <code class="language-plaintext highlighter-rouge">win7</code> “vendor”.</p> <h3 id="beyond-operating-systems"><a href="#beyond-operating-systems">Beyond Operating Systems</a></h3> <p>The third (or sometimes second, ugh) component of a triple is the operating system, or just “system”, since it’s much more general than that. The main thing that compilers get from this component relates to generating code to interact with the operating system (e.g. SEH on Windows) and various details related to linking, such as object file format and relocations.</p> <p>It’s also used for setting defines like <code class="language-plaintext highlighter-rouge">__linux__</code> in C, which user code can use to determine what to do based on the target.</p> <p>We’ve seen <code class="language-plaintext highlighter-rouge">linux</code> and <code class="language-plaintext highlighter-rouge">windows</code>, but you may have also seen <code class="language-plaintext highlighter-rouge">x86_64-apple-darwin</code>. <em>Darwin?</em></p> <p>The operating system formerly known as Mac OS X (now macOS<sup id="fnref:macos" role="doc-noteref"><a href="#fn:macos" class="footnote" rel="footnote">16</a></sup>) is a POSIX operating system. The POSIX substrate that all the Apple-specific things are built on top of is called Darwin. <a href="https://en.wikipedia.org/wiki/Darwin_(operating_system)">Darwin</a> is a free and open source operating system based on Mach, a research kernel whose name survives in Mach-O, the object file format used by all Apple products.</p> <p>All of the little doodads Apple sells use the actual official names of their OSes, like <code class="language-plaintext highlighter-rouge">aarch64-apple-ios</code>. For, you know, iOS. On your iPhone. Built with Xcode on your iMac.</p> <p><code class="language-plaintext highlighter-rouge">none</code> is a common value for this entry, which usually means a free-standing environment with no operating system. The object file format is usually specified in the fourth entry of the triple, so you might see something like <code class="language-plaintext highlighter-rouge">riscv32imc-unknown-none-elf</code>.</p> <p>Sometimes the triple refers not to an operating system, but to a complete hardware product. This is common with game console triples, which have “operating system” names like <code class="language-plaintext highlighter-rouge">ps4</code>, <code class="language-plaintext highlighter-rouge">psvita</code>, <code class="language-plaintext highlighter-rouge">3ds</code>, and <code class="language-plaintext highlighter-rouge">switch</code>. (Both Sony and Nintendo use LLVM as the basis for their internal toolchains; the Xbox toolchain is just MSVC).</p> <h2 id="abi-abi"><a href="#abi-abi">ABI! ABI!</a></h2> <p>The fourth entry of the triple (and I repeat myself, yes, it’s still a triple) represents the binary interface for the target, when it is ambiguous.</p> <p>For example, Apple targets never have this, because on an Apple platform, you just shut up and use <code class="language-plaintext highlighter-rouge">CoreFoundation.framework</code> as your libc. Except this isn’t true, because of things like <code class="language-plaintext highlighter-rouge">x86_64-apple-ios-sim</code>, the iOS simulator running on an x86 host.</p> <p>On the other hand, Windows targets will usually specify <code class="language-plaintext highlighter-rouge">-msvc</code> or <code class="language-plaintext highlighter-rouge">-gnu</code>, to indicate whether they are built to match MSVC’s ABI or MinGW. Linux targets will usually specify the libc vendor in this position: <code class="language-plaintext highlighter-rouge">-gnu</code> for glibc, <code class="language-plaintext highlighter-rouge">-musl</code> for musl, <code class="language-plaintext highlighter-rouge">-newlib</code> for newlib, and so on.</p> <p>This doesn’t just influence the calling convention; it also influences how language features, such as thread locals and dynamic linking, are handled. This usually requires coordination with the target libc.</p> <p>On ARM free-standing (<code class="language-plaintext highlighter-rouge">armxxx-unknown-none</code>) targets, <code class="language-plaintext highlighter-rouge">-eabi</code> specifies the ARM EABI, which is a standard embeded ABI for ARM. <code class="language-plaintext highlighter-rouge">-eabihf</code> is similar, but indicates that no soft float support is necessary (<code class="language-plaintext highlighter-rouge">hf</code> stands for hardfloat). (Note that Rust does not include a vendor with these architectures, so they’re more like <code class="language-plaintext highlighter-rouge">armv7r-none-eabi</code>).</p> <p>A lot of jankier targets use the ABI portion to specify the object file, such as the aforementioned <code class="language-plaintext highlighter-rouge">riscv32imc-unknown-none-elf</code>.</p> <h2 id="wasm-targets"><a href="#wasm-targets">WASM Targets</a></h2> <p>One last thing to note are the various WebAssembly targets, which completely ignore all of the above conventions. Their triples often only have two components (they are still called triples, hopefully I’ve made that clear by now). Rust is a little bit more on the forefront here than <code class="language-plaintext highlighter-rouge">clang</code> (and anyways I don’t want to get into Emscripten) so I’ll stick to what’s going on in <code class="language-plaintext highlighter-rouge">rustc</code>.</p> <p>There’s a few variants. <code class="language-plaintext highlighter-rouge">wasm32-unknown-unknown</code> (here using <code class="language-plaintext highlighter-rouge">unknown</code> instead of <code class="language-plaintext highlighter-rouge">none</code> as the system, oops) is a completely bare WebAssebly runtime where none of the standard library that needs to interact with the outside world works. This is essentially for building WebAssembly modules to deploy in a browser.</p> <p>There are also the WASI targets, which provide a standard ABI for talking to the host operating system. These are less meant for browsers and more for people who are using WASI as a security boundary. These have names like <code class="language-plaintext highlighter-rouge">wasm32-wasip1</code>, which, unusually, lack a vendor! A “more correct” formulation would have been <code class="language-plaintext highlighter-rouge">wasm32-unknown-wasip1</code>.</p> <h2 id="aside-on-go"><a href="#aside-on-go">Aside on Go</a></h2> <p>Go does the correct thing and distributes a cross compiler. This is well and good.</p> <p>Unfortunately, they decided to be different and special and do not use the target triple system for naming their targets. Instead, you set the <code class="language-plaintext highlighter-rouge">GOARCH</code> and <code class="language-plaintext highlighter-rouge">GOOS</code> environment variables before invoking <code class="language-plaintext highlighter-rouge">gc</code>. This will sometimes be shown printed with a slash between, such as <code class="language-plaintext highlighter-rouge">linux/amd64</code>.</p> <p>Thankfully, they at least provide documentation for a relevant internal package <a href="https://pkg.go.dev/internal/platform">here</a>, which offers the names of various <code class="language-plaintext highlighter-rouge">GOARCH</code> and <code class="language-plaintext highlighter-rouge">GOOS</code> values.</p> <p>They use completely different names from everyone else for a few things, which is guaranteed to trip you up. They use call the 32- and 64-bit variants of x86 <code class="language-plaintext highlighter-rouge">386</code> (note the lack of leading <code class="language-plaintext highlighter-rouge">i</code>) and <code class="language-plaintext highlighter-rouge">amd64</code>. They call 64-bit ARM <code class="language-plaintext highlighter-rouge">arm64</code>, instead of <code class="language-plaintext highlighter-rouge">aarch64</code>. They call little-endian MIPSes <code class="language-plaintext highlighter-rouge">mipsle</code> instead of <code class="language-plaintext highlighter-rouge">mipsel</code>.</p> <p>They also call 32-bit WebAssembly <code class="language-plaintext highlighter-rouge">wasm</code> instead of <code class="language-plaintext highlighter-rouge">wasm32</code>, which is a bit silly, and they use <code class="language-plaintext highlighter-rouge">js/wasm</code> as their equivalent of <code class="language-plaintext highlighter-rouge">wasm32-unknown-unknown</code>, which is <em>very</em> silly.</p> <p>Android is treated as its own operating system, <code class="language-plaintext highlighter-rouge">android</code>, rather than being <code class="language-plaintext highlighter-rouge">linux</code> with a particular ABI; their system also can’t account for ABI variants in general, since Go originally wanted to not have to link any system libraries, something that does not actually work.</p> <p>If you are building a new toolchain, don’t be clever by inventing a cute target triple convention. All you’ll do is annoy people who need to work with a lot of different toolchains by being different and special.</p> <h2 id="inventing-your-own-triples"><a href="#inventing-your-own-triples">Inventing Your Own Triples</a></h2> <p>Realistically, you probably shouldn’t. But if you must, you should probably figure out what you want out of the triple.</p> <p>Odds are there isn’t anything interesting to put in the vendor field, so you will avoid people a lot of pain by picking <code class="language-plaintext highlighter-rouge">unknown</code>. Just include a vendor to avoid pain for people in the future.</p> <p>You should also avoid inventing a new name for an existing architecture. Don’t name your hobby operating system’s triple <code class="language-plaintext highlighter-rouge">amd64-unknown-whatever</code>, please. And you definitely don’t want to have an ABI component. One ABI is enough.</p> <p>If you’re inventing a triple for a free-standing environment, but want to specify something about the hardware configuration, you’re probably gonna want to use <code class="language-plaintext highlighter-rouge">-none-&lt;abi&gt;</code> for your system. For some firmware use-cases, though, the system entry is a better place, such as for the UEFI triples. Although, I have unforunately seen both <code class="language-plaintext highlighter-rouge">x86_64-unknown-uefi</code> and <code class="language-plaintext highlighter-rouge">x86_64-pc-none-uefi</code> in the wild.</p> <p>And most imporantly: this sytem was built up organically. Disabuse yourself now of the idea that the system is consistent and that target triples are easy to parse. Trying to parse them will make you very sad.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:quad" role="doc-endnote"> <p>And no, a “target quadruple” is not a thing and if I catch you saying that I’m gonna bonk you with an Intel optimization manual. <a href="#fnref:quad" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:toolchain" role="doc-endnote"> <p>I’m not sure why GCC does this. I suspect that it’s because computer hard drives used to be small and a GCC with every target would have been too large to cram into every machine. Maybe it has some UNIX philosophy woo mixed into it.</p> <p>Regardless, it’s really annoying and thankfully no one else does this because cross compiling shouldn’t require hunting down a new toolchain for each platform. <a href="#fnref:toolchain" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:x86_86h" role="doc-endnote"> <p>This is for Apple’s later-gen x86 machines, before they went all-in on ARM desktop. <a href="#fnref:x86_86h" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ilp32" role="doc-endnote"> <p>ILP32 means that the <code class="language-plaintext highlighter-rouge">int</code>, <code class="language-plaintext highlighter-rouge">long</code>, and pointer types in C are 32-bit, despite the architecture being 64-bit. This allows writing programs that are small enough top jive in a 32-bit address space, while taking advantage of fast 64-bit operations. It is a bit of a frankentarget. Also existed once as a process mode on <code class="language-plaintext highlighter-rouge">x86_64-unknown-linux</code> by the name of <code class="language-plaintext highlighter-rouge">x32</code>. <a href="#fnref:ilp32" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:ilp32:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:power" role="doc-endnote"> <p>Not to be confused with POWER, an older IBM CPU. <a href="#fnref:power" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:s390x" role="doc-endnote"> <p>This name is Linux’s name for IBM’s z/Architecture. See <a href="https://en.wikipedia.org/wiki/Linux_on_IBM_Z#Hardware">https://en.wikipedia.org/wiki/Linux_on_IBM_Z#Hardware</a>. <a href="#fnref:s390x" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:ptx" role="doc-endnote"> <p>Not a real chip; refers to Nvidia’s PTX IR, which is what CUDA compiles to. <a href="#fnref:ptx" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:amdil" role="doc-endnote"> <p>Similar to PTX; an IR used by AMD for graphics. See <a href="https://openwall.info/wiki/john/development/AMD-IL">https://openwall.info/wiki/john/development/AMD-IL</a>. <a href="#fnref:amdil" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:idk" role="doc-endnote"> <p>No idea what this is, and Google won’t help me. <a href="#fnref:idk" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:idk:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:llc" role="doc-endnote"> <p><code class="language-plaintext highlighter-rouge">llc</code> is the LLVM compiler, which takes LLVM IR as its input. Its interface is much more regular than <code class="language-plaintext highlighter-rouge">clang</code>’s because it’s not intended to be a substitute for GCC the way <code class="language-plaintext highlighter-rouge">clang</code> is. <a href="#fnref:llc" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:x86-modes" role="doc-endnote"> <p>Very kernel-hacker-brained name. It references the three processor modes of an x86 machine: real mode, protected mode, long mode, which correspond to 16-, 32-, and 64-bit modes. There is also a secret fourth mode called <a href="https://en.wikipedia.org/wiki/Unreal_mode">unreal mode</a>, which is just what happens when you come down to real mode from protected mode after setting up a protected mode GDT.</p> <p>If you need to refer to real mode, call it “real mode”. Don’t try to be clever by calling it “8086” because you are almost certainly going to be using features that were not in the original Intel 8086. <a href="#fnref:x86-modes" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:i386" role="doc-endnote"> <p>I actually don’t like this name, but it’s the one LLVM uses so I don’t really get to complain. <a href="#fnref:i386" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:piii" role="doc-endnote"> <p>Bazel also calls 32-bit x86 <code class="language-plaintext highlighter-rouge">piii</code>, which stands for, you guessed it, “Pentium III”. Extremely unserious. <a href="#fnref:piii" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:arm-holdings" role="doc-endnote"> <p>The intelectual property around ARM, the architecture famility, is owned by the British company Arm Holdings. Yes, the spelling difference is significant.</p> <p>Relatedly, ARM is not an acronym, and is sometimes styled in all-lowercase as arm. The distant predecesor of Arm Holdings is Acorn Computers. Their first compute, the Acorn Archimedes, contained a chip whose target triple name today might have been <code class="language-plaintext highlighter-rouge">armv1</code>. Here, ARM was an acronym, for Acorn RISC Machine. Wikipedia alleges without citation that the name was at once point changed to Advanced RISC Machine at the behest of Apple, but I am unable to find more details. <a href="#fnref:arm-holdings" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:unknown" role="doc-endnote"> <p>“You are not cool enough for your company to be on the list.” <a href="#fnref:unknown" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:macos" role="doc-endnote"> <p>Which I pronounce as one word, “macos”, to drive people crazy. <a href="#fnref:macos" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </div> <div class="post-preview"> <div class="post-title"> <span class="post-meta"> 2025-04-08 • 742 words • 6 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#protobuf-tips">#protobuf-tips</a> </span> <h1><a href="/2025/04/08/protobuf-tip-1/"> Protobuf Tip #1: Field Names Are Forever </a></h1> </div> <div class="post"> <p><em>I wake up every morning and grab the morning paper. Then I look at the obituary page. If my name is not on it, I get up. –Ben Franklin</em></p> <p>TL;DR: Don’t rename fields. Even though there are a slim number of cases where you can get away with it, it’s rarely worth doing, and is a potential source of bugs.</p> <blockquote> <p>I’m editing a series of best practice pieces on Protobuf, a language that I work on which has lots of evil corner-cases.These are shorter than what I typically post here, but I think it fits with what you, dear reader, come to this blog for. These tips are also posted on the <a href="https://buf.build/blog/totw-1-field-names">buf.build blog</a>.</p> </blockquote> <h2 id="names-and-tags"><a href="#names-and-tags">Names and Tags</a></h2> <p>Protobuf message fields have <em>field tags</em> that are used in the binary wire format to discriminate fields. This means that the wire format serialization does not actually depend on the <em>names</em> of the fields. For example, the following messages will use the exact same serialization format.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Foo</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Foo2</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">bar2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In fact, the designers of Protobuf intended for it to be feasible to rename an in-use field. However, they were not successful: it can still be a breaking change.</p> <h2 id="schema-consumers-need-to-update"><a href="#schema-consumers-need-to-update">Schema Consumers Need to Update</a></h2> <p>If your schema is public, the generated code will change. For example, renaming a field from <code class="language-plaintext highlighter-rouge">first_name</code> to <code class="language-plaintext highlighter-rouge">given_name</code> will cause the corresponding Go accessor to change from <code class="language-plaintext highlighter-rouge">FirstName</code> to <code class="language-plaintext highlighter-rouge">GivenName</code>, potentially breaking downstream consumers.</p> <p>Renaming a field to a “better” name is almost never a worthwhile change, simply because of this breakage.</p> <h2 id="json-serialization-breaks"><a href="#json-serialization-breaks">JSON Serialization Breaks</a></h2> <p>Wire format serialization doesn’t look at names, but JSON does! This means that <code class="language-plaintext highlighter-rouge">Foo</code> and <code class="language-plaintext highlighter-rouge">Foo2</code> above serialize as <code class="language-plaintext highlighter-rouge">{"bar":"content"}</code> and <code class="language-plaintext highlighter-rouge">{"bar2":"content"}</code> respectively, making them non-interchangeable.</p> <p>This can be partially mitigated by using the <code class="language-plaintext highlighter-rouge">[json_name = "..."]</code> option on a field. However, this doesn’t actually work, because many Protobuf runtimes’ JSON codecs will accept both the name set in <code class="language-plaintext highlighter-rouge">json_name</code>, <em>and</em> the specified field name. So <code class="language-plaintext highlighter-rouge">string given_name = 1 [json_name = "firstName"];</code> will allow deserializing from a key named <code class="language-plaintext highlighter-rouge">given_name</code>, but not <code class="language-plaintext highlighter-rouge">first_name</code> like it used to. This is still a breaking protocol change!</p> <p>This is a place where Protobuf could have done better—if <code class="language-plaintext highlighter-rouge">json_name</code> had been a <code class="language-plaintext highlighter-rouge">repeated string</code>, this wire format breakage would have been avoidable. However, for reasons given below, renames are still a bad idea.</p> <h2 id="reflection"><a href="#reflection">Reflection!</a></h2> <p>Even if you could avoid source and JSON breakages, the names are always visible to reflection. Although it’s <em>very</em> hard to guard against reflection breakages in general (since it can even see the order fields are declared in), this is one part of reflection that can be especially insidious—for example, if callers choose to sort fields by name, or if some middleware is using the name of a field to identify its frequency, or logging/redaction needs.</p> <p>Don’t change the name, because reflection means you can’t know what’ll go wrong!</p> <h2 id="but-i-really-have-to"><a href="#but-i-really-have-to">But I Really Have To!</a></h2> <p>There are valid reasons for wanting to rename a field, such as expanding its scope. For example, <code class="language-plaintext highlighter-rouge">first_name</code> and <code class="language-plaintext highlighter-rouge">given_name</code> are not the same concept: in the Sinosphere, as well as in Hungary, the first name in a person’s full name is their family name, not their given name.</p> <p>Or maybe a field that previously referred to a monetary amount, say <code class="language-plaintext highlighter-rouge">cost_usd</code>, is being updated to not specify the currency:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Before</span> <span class="p">{</span>
  <span class="kt">sint64</span> <span class="na">cost_usd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">After</span> <span class="p">{</span>
  <span class="kd">enum</span> <span class="n">Currency</span> <span class="p">{</span>
    <span class="na">CURRENCY_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">CURRENCY_USD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="na">CURRENCY_EUR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="na">CURRENCY_JPY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="na">CURRENCY_USD_1000TH</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 0.1 cents.</span>
  <span class="p">}</span>

  <span class="kt">sint64</span> <span class="na">cost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Currency</span> <span class="na">currency</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>In cases like this, <strong>renaming the field is a terrible idea</strong>. Setting aside source code or JSON breakage, the new field has completely different semantics. If an old consumer, expecting a price in USD, receives a new wire format message serialized from <code class="language-plaintext highlighter-rouge">{"cost":990,"currency":"CURRENCY_USD_1000TH"}</code>, it will incorrectly interpret the price as 990USD, rather than 0.99USD. That’s a disastrous bug!</p> <p>Instead, the right plan is to add <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">currency</code> side-by-side <code class="language-plaintext highlighter-rouge">cost_usd</code>. Then, readers should first check for <code class="language-plaintext highlighter-rouge">cost_usd</code> when reading <code class="language-plaintext highlighter-rouge">cost</code>, and take that to imply that <code class="language-plaintext highlighter-rouge">currency</code> is <code class="language-plaintext highlighter-rouge">CURRENCY_USD</code> (it’s also worth generating an error if <code class="language-plaintext highlighter-rouge">cost</code> and <code class="language-plaintext highlighter-rouge">cost_usd</code> are both present).</p> <p><code class="language-plaintext highlighter-rouge">cost_usd</code> can then be marked as <code class="language-plaintext highlighter-rouge">[deprecated = true]</code> . It is possible to even delete <code class="language-plaintext highlighter-rouge">cost_usd</code> in some cases, such as when you control all readers and writers — but if you don’t, the risk is very high. Plus, you kind of need to be able to re-interpret <code class="language-plaintext highlighter-rouge">cost_usd</code> as the value of <code class="language-plaintext highlighter-rouge">cost</code> in perpetuity.</p> <p>If you do wind up deleting them, make sure to reserve the field’s number and name, to avoid accidental re-use.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-protobuf" data-lang="protobuf"><span class="n">reserved</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">reserved</span> <span class="s">"cost_usd"</span><span class="p">;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Protobuf</div></div></div> <p>But try not to. Renaming fields is nothing but tears and pain.</p> </div> </div> <div class="post-preview"> <div class="post-title"> <span class="post-meta"> 2025-03-11 • 3738 words • 31 minutes <br class="show-if-mobile"/> <span class="hide-if-mobile">•</span> <a href="https://mcyoung.xyz/tags.html#formats">#formats</a> • <a href="https://mcyoung.xyz/tags.html#parsing">#parsing</a> • <a href="https://mcyoung.xyz/tags.html#frontend">#frontend</a> </span> <h1><a href="/2025/03/11/formatters/"> The Art of Formatting Code </a></h1> </div> <div class="post"> <p>Every modern programming language needs a <em>formatter</em> to make your code look pretty and consistent. Formatters are source-transformation tools that parse source code and re-print the resulting AST in some canonical form that normalizes whitespace and optional syntactic constructs. They remove the tedium of matching indentation and brace placement to match a style guide.</p> <p>Go is particularly well-known for providing a formatter as part of its toolchain from day one. It is not a <em>good</em> formatter, though, because it cannot enforce a maximum column width. Later formatters of the 2010s, such as rustfmt and clang-format, do provide this feature, which ensure that individual lines of code don’t get too long.</p> <p>The reason Go doesn’t do this is because the naive approach to formatting code makes it intractable to do so. There are many approaches to implementing this, which can make it seem like a very complicated layout constraint solving problem.</p> <p>So what’s so tricky about formatting code? Aren’t you just printing out an AST?</p> <h2 id="just-an-ast"><a href="#just-an-ast">“Just” an AST</a></h2> <p>An AST<sup id="fnref:pronunciation" role="doc-noteref"><a href="#fn:pronunciation" class="footnote" rel="footnote">1</a></sup> (abstract syntax tree) is a graph representation of a program’s syntax. Let’s consider something like JSON, whose naively-defined AST type might look something like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">enum</span> <span class="n">Json</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
  <span class="nf">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Json</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Object</span><span class="p">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Json</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>The AST for the document <code class="language-plaintext highlighter-rouge">{"foo": null, "bar": 42}</code> might look something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">my_doc</span> <span class="o">=</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Object</span><span class="p">([</span>
  <span class="p">(</span><span class="s">"foo"</span><span class="nf">.to_string</span><span class="p">(),</span> <span class="nn">Json</span><span class="p">::</span><span class="n">Null</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"bar"</span><span class="nf">.to_string</span><span class="p">(),</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="mi">42</span><span class="p">)),</span>
<span class="p">]</span><span class="nf">.into</span><span class="p">());</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This AST has some pretty major problems. A formatter must <em>not</em> change the syntactic structure of the program (beyond removing things like redundant braces). Formatting must also be deterministic.</p> <p>First off, <code class="language-plaintext highlighter-rouge">Json::Object</code> is a <code class="language-plaintext highlighter-rouge">HashMap</code>, which is unordered. So it will immediately discard the order of the keys. <code class="language-plaintext highlighter-rouge">Json::String</code> does not retain the escapes from the original string, so <code class="language-plaintext highlighter-rouge">"\n"</code> and <code class="language-plaintext highlighter-rouge">"\u000a"</code> are indistinguishable. <code class="language-plaintext highlighter-rouge">Json::Number</code> will destroy information: JSON numbers can specify values outside of the <code class="language-plaintext highlighter-rouge">f64</code> representable range, but converting to <code class="language-plaintext highlighter-rouge">f64</code> will quantize to the nearest float.</p> <p>Now, JSON doesn’t have comments, but if it did, our AST has no way to record it! So it would destroy all comment information! Plus, if someone has a document that separates keys into stanzas<sup id="fnref:stanza" role="doc-noteref"><a href="#fn:stanza" class="footnote" rel="footnote">2</a></sup>, as shown below, this information is lost too.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"this"</span><span class="p">:</span><span class="w"> </span><span class="s2">"is my first stanza"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"second"</span><span class="p">:</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w">

  </span><span class="nl">"here"</span><span class="p">:</span><span class="w"> </span><span class="s2">"is my second stanza"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"fourth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"line"</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>Truth is, the AST for virtually all competent toolchains are much more complicated than this. Here’s some important properties an AST needs to have to be useful.</p> <ol> <li> <p>Retain <em>span</em> information. Every node in the graph remembers what piece of the file it was parsed from.</p> </li> <li> <p>Retain whitespace information. “Whitespace” typically includes both whitespace characters, and comments.</p> </li> <li> <p>Retain ordering information. The children of each node need to be stored in ordered containers.</p> </li> </ol> <p>The first point is achieved in a number of ways, but boils down to somehow associating to each token a pair of integers<sup id="fnref:offsets" role="doc-noteref"><a href="#fn:offsets" class="footnote" rel="footnote">3</a></sup>, identifying the start and end offsets of the token in the input file.</p> <p>Given the span information for each token, we can then define the span for each node to be the <em>join</em> of its tokens’ spans, namely the start is the min of its constituent tokens’ starts and its end is the max of the ends. This can be easily calculated recursively.</p> <p>Once we have spans, it’s easy to recover the whitespace between any two adjacent syntactic constructs by calculating the text between them. This approach is more robust than, say, associating each comment with a specific token, because it makes it easier to discriminate stanzas for formatting.</p> <p>Being able to retrieve the comments between any two syntax nodes is crucial. Suppose the user writes the following Rust code:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="c1">// HACK: disable this check.</span>
  <span class="nf">some_complicated_check</span><span class="p">();</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>If we’re formatting the binary expression containing the <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, and we can’t query for comments between the LHS and the operator, or the operator and the RHS, the <code class="language-plaintext highlighter-rouge">// HACK</code> comment will get deleted on format, which is pretty bad!</p> <p>An AST that retains this level of information is sometimes called a “concrete syntax tree”. I do not consider this a useful distinction, because any useful AST must retain span and whitespace information, and it’s kind of pointless to implement the same AST more than once. To me, an AST without spans is incomplete.</p> <h3 id="updating-our-json-ast"><a href="#updating-our-json-ast">Updating Our JSON AST</a></h3> <p>With all this in mind, the bare minimum for a “good” AST is gonna be something like this.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Json</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">JsonKind</span><span class="p">,</span>
  <span class="n">span</span><span class="p">:</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">JsonKind</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
  <span class="nf">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Json</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Object</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="n">Json</span><span class="p">)</span><span class="o">&gt;</span><span class="p">),</span>  <span class="c1">// Vec, not HashMap.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>There are various layout optimizations we can do: for example, the vast majority of strings exist literally in the original file, so there’s no need to copy them into a <code class="language-plaintext highlighter-rouge">String</code>; it’s only necessary if the string contains escapes. My <code class="language-plaintext highlighter-rouge">byteyarn</code> crate, which I wrote about <a href="https://mcyoung.xyz/2023/08/09/yarns">here</a>, is meant to make handling this case easy. So we might rewrite this to be lifetime-bound to the original file.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Json</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">span</span><span class="p">:</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Json</span><span class="o">&gt;</span><span class="p">),</span>
  <span class="nf">Object</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Json</span><span class="p">)</span><span class="o">&gt;</span><span class="p">),</span>  <span class="c1">// Vec, not HashMap.</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>But wait, there’s some things that don’t have spans here. We need to include spans for the braces of <code class="language-plaintext highlighter-rouge">Array</code> and <code class="language-plaintext highlighter-rouge">Object</code>, their commas, and the colons on object keys. So what we actually get is something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="n">Span</span> <span class="p">{</span>
  <span class="n">start</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
  <span class="n">end</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Json</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">span</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">JsonKind</span><span class="o">&lt;</span><span class="nv">'src</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">Null</span><span class="p">,</span>
  <span class="nf">Bool</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
  <span class="nf">Number</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">String</span><span class="p">(</span><span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">),</span>

  <span class="n">Array</span> <span class="p">{</span>
    <span class="n">open</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ArrayEntry</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">Object</span> <span class="p">{</span>
    <span class="n">open</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ObjectEntry</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ArrayEntry</span> <span class="p">{</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">Json</span><span class="p">,</span>
  <span class="n">comma</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Span</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ObjectEntry</span> <span class="p">{</span>
  <span class="n">key</span><span class="p">:</span> <span class="n">Yarn</span><span class="o">&lt;</span><span class="nv">'src</span><span class="p">,</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">key_span</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
  <span class="n">colon</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">Json</span><span class="p">,</span>
  <span class="n">comma</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Span</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Implementing an AST is one of my least favorite parts of writing a toolchain, because it’s tedious to ensure all of the details are recorded and properly populated.</p> <h2 id="just-printing-an-ast"><a href="#just-printing-an-ast">“Just” Printing an AST</a></h2> <p>In Rust, you can easily get a nice recursive print of any struct using the <code class="language-plaintext highlighter-rouge">#[derive(Debug)]</code> construct. This is implemented by recursively calling <code class="language-plaintext highlighter-rouge">Debug::fmt()</code> on the elements of a struct, but passing modified <code class="language-plaintext highlighter-rouge">Formatter</code> state to each call to increase the indentation level each time.</p> <p>This enables printing nested structs in a way that looks like Rust syntax when using the <code class="language-plaintext highlighter-rouge">{:#?}</code> specifier.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n">Foo</span> <span class="p">{</span>
  <span class="n">bar</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">Baz</span> <span class="p">{</span>
    <span class="n">quux</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>We can implement a very simple formatter for our JSON AST by walking it recursively.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">String</span><span class="p">,</span> <span class="n">json</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Json</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">match</span> <span class="o">&amp;</span><span class="n">json</span><span class="py">.kind</span> <span class="p">{</span>
    <span class="nn">Json</span><span class="p">::</span><span class="n">Null</span> <span class="p">|</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Bool</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">|</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">|</span> <span class="nn">Json</span><span class="p">::</span><span class="nf">String</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Preserve the input exactly.</span>
      <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">json</span><span class="py">.span.start</span><span class="o">..</span><span class="n">json</span><span class="py">.span.end</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nn">Json</span><span class="p">::</span><span class="n">Array</span> <span class="p">{</span> <span class="n">entries</span><span class="p">,</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'['</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">entries</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nf">fmt</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="py">.value</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span><span class="py">.comma</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">']'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nn">Json</span><span class="p">::</span><span class="n">Object</span> <span class="p">{</span> <span class="n">entries</span><span class="p">,</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'{'</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">entries</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Preserve the key exactly.</span>
        <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">entry</span><span class="py">.key_span.start</span><span class="o">..</span><span class="n">entry</span><span class="py">.key_span.end</span><span class="p">]);</span>

        <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="s">": "</span><span class="p">);</span>
        <span class="nf">fmt</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="py">.value</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span><span class="py">.comma</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="p">{</span>
        <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">out</span><span class="nf">.push</span><span class="p">(</span><span class="sc">'}'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>This is essentially what every JSON serializer’s “pretty” mode looks like. It’s linear, it’s simple. But it has one big problem: small lists.</p> <p>If I try to format the document <code class="language-plaintext highlighter-rouge">{"foo": []}</code> using this routine, the output will be</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>This is pretty terrible, but easy to fix by adding a special case:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="nn">Json</span><span class="p">::</span><span class="n">Array</span> <span class="p">{</span> <span class="n">entries</span><span class="p">,</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">entries</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">out</span><span class="nf">.push_str</span><span class="p">(</span><span class="s">"[]"</span><span class="p">);</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>Unfortunately, this doesn’t handle the similar case of a small but non-empty list. <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code> formats as</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>Really, we’d like to keep <code class="language-plaintext highlighter-rouge">"foo": [1, 2]</code> on one line. And now we enter the realm of column wrapping.</p> <h2 id="how-wide-is-a-codepoint"><a href="#how-wide-is-a-codepoint">How Wide Is a Codepoint?</a></h2> <p>The whole point of a formatter is to work with <em>monospaced text</em>, which is text formatted using a monospaced or <em>fixed-width</em> typeface, which means each character is the same width, leading to the measure of the width of lines in <em>columns</em>.</p> <p>So how many columns does the string <code class="language-plaintext highlighter-rouge">cat</code> take up? Three, pretty easy. But we obviously don’t want to count bytes, this isn’t 1971. If we did, <code class="language-plaintext highlighter-rouge">кішка</code>, when UTF-8 encoded, it would be 10, rather than 5 columns wide. So we seem to want to count Unicode characters instead?</p> <p>Oh, but what <em>is</em> a Unicode character? Well, we could say that you’re counting Unicode scalar values (what Rust’s <code class="language-plaintext highlighter-rouge">char</code> and Go’s <code class="language-plaintext highlighter-rouge">rune</code>) types represent. Or you could count grapheme clusters (like Swift’s <code class="language-plaintext highlighter-rouge">Character</code>).</p> <p>But that would give wrong answers. CJK languages’ characters, such as <code class="language-plaintext highlighter-rouge">猫</code>, usually want to be rendered as <em>two</em> columns, even in monospaced contexts. So, you might go to Unicode and discover <a href="https://www.unicode.org/reports/tr11/">UAX#11</a>, and attempt to use it for assigning column widths. But it turns out that the precise rules that monospaced fonts use are not written down in a single place in Unicode. You would also discover that some scripts, such as Arabic, have complex ligature rules that mean that the width of a single character depends on the characters around it.</p> <p>This is a place where you should hunt for a library. <a href="https://docs.rs/unicode-width/latest/unicode_width/#rules-for-determining-width"><code class="language-plaintext highlighter-rouge">unicode_width</code></a> is the one for Rust. Given that Unicode segmentation is a closely associated operation to width, segmentation libraries are a good place to look for a width calculation routine.</p> <p>But most such libraries will still give wrong answers, because of tabs. The tab character <code class="language-plaintext highlighter-rouge">U+0009 CHARACTER TABULATION</code>’s width depends on the width of all characters before it, because a tab is as wide as needed to reach the next <em>tabstop</em>, which is a column position an integer multiple of the <em>tab width</em> (usually 2, 4, or, on most terminals, 8).</p> <p>With a tab width of 4, <code class="language-plaintext highlighter-rouge">"\t"</code>, <code class="language-plaintext highlighter-rouge">"a\t"</code>, and <code class="language-plaintext highlighter-rouge">"abc\t"</code> are all four columns wide. Depending on the context, you will either want to treat tabs as behaving as going to the next tabstop (and thus being variable width), or having a fixed width. The former is necessary for assigning correct column numbers in diagnostics, but we’ll find that the latter is a better match for what we’re doing.</p> <p>The reason for being able to calculate the width of a string is to enable line wrapping. At some point in the 2010s, people started writing a lot of code on laptops, where it is not easy to have two editors side by side on the small screen. This removes the motivation to wrap all lines at 80 columns<sup id="fnref:80-cols" role="doc-noteref"><a href="#fn:80-cols" class="footnote" rel="footnote">4</a></sup>, which in turn results in lines that tend to get arbitrarily long.</p> <p>Line wrapping helps ensure that no matter how wide everyone’s editors are, the code <em>I</em> have to read fits on my very narrow editors.</p> <h2 id="accidentally-quadratic"><a href="#accidentally-quadratic">Accidentally Quadratic</a></h2> <p>A lot of folks’ first formatter recursively formats a node by formatting its children to determine if they fit on one line or not, and based on that, and their length if they are single-line, determine if their parent should break.</p> <p>This is a naive approach, which has several disadvantages. First, it’s very easy to accidentally backtrack, trying to only break smaller and smaller subexpressions until things fit on one line, which can lead to quadratic complexity. The logic for whether a node can break is bespoke per node and that makes it easy to make mistakes.</p> <p>Consider formatting <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code>. In our AST, this will look something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="n">Json</span> <span class="p">{</span>
  <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="n">Object</span> <span class="p">{</span>
    <span class="n">open</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">15</span> <span class="p">},</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">ObjectEntry</span> <span class="p">{</span>
      <span class="n">key</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">,</span>
      <span class="n">key_span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="n">colon</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="n">value</span><span class="p">:</span> <span class="n">Json</span> <span class="p">{</span>
        <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="n">Array</span> <span class="p">{</span>
          <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">9</span> <span class="p">},</span>
          <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">14</span> <span class="p">},</span>
          <span class="n">entries</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span>
            <span class="n">ArrayEntry</span> <span class="p">{</span>
              <span class="n">value</span><span class="p">:</span> <span class="n">Json</span> <span class="p">{</span>
                <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
                <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
              <span class="p">},</span>
              <span class="n">comma</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">11</span> <span class="p">}),</span>
            <span class="p">},</span>
            <span class="n">ArrayEntry</span> <span class="p">{</span>
              <span class="n">value</span><span class="p">:</span> <span class="n">Json</span> <span class="p">{</span>
                <span class="n">kind</span><span class="p">:</span> <span class="nn">JsonKind</span><span class="p">::</span><span class="nf">Number</span><span class="p">(</span><span class="n">s</span><span class="na">.0</span><span class="p">),</span>
                <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">13</span> <span class="p">},</span>
              <span class="p">},</span>
              <span class="n">comma</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="p">],</span>
        <span class="p">},</span>
        <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">14</span> <span class="p">},</span>
      <span class="p">},</span>
      <span class="n">comma</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
    <span class="p">}],</span>
  <span class="p">},</span>
  <span class="n">span</span><span class="p">:</span> <span class="n">Span</span> <span class="p">{</span> <span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="mi">15</span> <span class="p">},</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p>To format the whole document, we need to know the width of each field in the object to decide whether the object fits on one line. To do that, we need to calculate the width of each value, and add to it the width of the key, and the width of the <code class="language-plaintext highlighter-rouge">: </code> separating them.</p> <p>How can this be accidentally quadratic? If we simply say “format this node” to obtain its width, that will recursively format all of the children it contains without introducing line breaks, performing work that is linear in how many transitive children that node contains. Having done this, we can now decide if we need to introduce line breaks or not, which increases the indentation at which the children are rendered. This means that the children cannot know ahead of time how much of the line is left for them, so we need to recurse into formatting them again, now knowing the indentation at which the direct children are rendered.</p> <p>Thus, each node performs work equal to the number of nodes beneath it. This has resulted in many slow formatters.</p> <p>Now, you could be more clever and have each node be capable of returning its width based on querying its children’s width directly, but that means you need to do complicated arithmetic for each node that needs to be synchronized with the code that actually formats it. Easy to make mistakes.</p> <p>The solution is to invent some kind of model for your document that specifies how lines should be broken if necessary, and which tracks layout information so that it can be computed in one pass, and then used in a second pass to figure out whether to actually break lines or not.</p> <p>This is actually how HTML works. The markup describes constraints on the layout of the content, and then a layout engine, over several passes, calculates sizes, solves constraints, and finally produces a raster image representing that HTML document. Following the lead of HTML, we can design…</p> <h2 id="a-dom-for-your-code"><a href="#a-dom-for-your-code">A DOM for Your Code</a></h2> <p>The HTML DOM is a markup document: a tree of tags where each tag has a type, such as <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;hr&gt;</code>, or <code class="language-plaintext highlighter-rouge">&lt;strong&gt;</code>, properties, such as <code class="language-plaintext highlighter-rouge">&lt;a href=...&gt;</code>, and content consisting of nested tags (and bare text, which every HTML engine just handles as a special kind of tag), such as <code class="language-plaintext highlighter-rouge">&lt;p&gt;Hello &lt;em&gt;World&lt;/em&gt;!&lt;/p&gt;</code>.</p> <p>We obviously want to have a tag for text that should be rendered literally. We also want a tag for line breaks that is distinct from the text tag, so that they can be merged during rendering. It might be good to treat text tags consisting of just whitespace, such as whitespace, specially: two newlines <code class="language-plaintext highlighter-rouge">\n\n</code> are a blank line, but we might want to merge consecutive blank lines. Similarly, we might want to merge consecutive spaces to simplify generating the DOM.</p> <p>Consider formatting a language like C++, where a function can have many modifiers on it that can show up in any order, such as <code class="language-plaintext highlighter-rouge">inline</code>, <code class="language-plaintext highlighter-rouge">virtual</code>, <code class="language-plaintext highlighter-rouge">constexpr</code>, and <code class="language-plaintext highlighter-rouge">explicit</code>. We might want to canonicalize the order of these modifiers. We don’t want to accidentally wind up printing <code class="language-plaintext highlighter-rouge">inline constexpr Foo()</code> because we printed an empty string for <code class="language-plaintext highlighter-rouge">virtual</code>. Having special merging for spaces means that all entities are always one space apart if necessary. This is a small convenience in the DOM that multiplies to significant simplification when lowering from AST to DOM.</p> <p>Another useful tag is something like <code class="language-plaintext highlighter-rouge">&lt;indent by=" "&gt;</code>, which increases the indentation level by some string (or perhaps simply a number of spaces; the string just makes supporting tabs easier) for the tags inside of it. This allows control of indentation in a carefully-scoped manner.</p> <p>Finally, we need some way to group tags that are candidates for “breaking”: if the width of all of the tags inside of a <code class="language-plaintext highlighter-rouge">&lt;group&gt;</code> is greater than the maximum width that group can have (determined by indentation and any elements on the same line as that group), we can set that group to “broken”, and… well, what should breaking do?</p> <p>We want breaking to not just cause certain newlines (at strategic locations) to appear, but we also want it to cause an indentation increase, and in languages with trailing commas like Rust and Go, we want (or in the case of Go, <em>need</em>) to insert a trailing comma only when broken into multiple lines. We can achieve this by allowing any tag to be <em>conditioned</em> on whether the enclosing group is broken or not.</p> <p>Taken all together, we can render the AST for our <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code> document into this DOM, according to the tags we’ve described above.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;group&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"{"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">'"foo"'</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">":"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;group&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"["</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">","</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/indent&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"]"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/group&gt;</span>
  <span class="nt">&lt;/indent&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/group&gt;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">XML</div></div></div> <p>Notice a few things: All of the newlines are set to appear only <code class="language-plaintext highlighter-rouge">if=broken</code>. The space between the two commas only appears if the enclosing group is <em>not</em> broken, that is <code class="language-plaintext highlighter-rouge">if=flat</code>. The groups encompass everything that can move due to a break, which includes the outer braces. This is necessary because if that brace is not part of the group, and it is the only character past the line width limit, it will not cause the group to break.</p> <h3 id="laying-out-your-dom"><a href="#laying-out-your-dom">Laying Out Your DOM</a></h3> <p>The first pass is easy: it measures how wide every node is. But we don’t know whether any groups will break, so how can we measure that without calculating breaks, which depend on indentation, and the width of their children, and…</p> <p>This is one tricky thing about multi-pass graph algorithms (or graph algorithms in general): it can be easy to become overwhelmed trying to factor the dependencies at each node so that they are not cyclic. I struggled with this algorithm, until I realized that the only width we care about is the width <em>if no groups are ever broken</em>.</p> <p>Consider the following logic: if a group needs to break, all of its parents must obviously break, because the group will now contain a newline, so its parents must break no matter what. Therefore, we only consider the width of a node when deciding if a group must break intrinsically, i.e., because all of its children decided not to break. This can happen for a document like the following, where each inner node is quite large, but not large enough to hit the limit.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">],</span><span class="w">
  </span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">]</span><span class="w">
</span><span class="p">]</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <p>Because we prefer to break outer groups rather than inner groups, we can measure the “widest a single line could be” in one pass, bottom-up: each node’s width is the sum of the width of its children, or its literal contents for <code class="language-plaintext highlighter-rouge">&lt;text&gt;</code> elements. However, we must exclude all text nodes that are <code class="language-plaintext highlighter-rouge">if=broken</code>, because they obviously do not contribute to the single-line length. We can also ignore indentation because indentation never happens in a single line.</p> <p>However, this doesn’t give the full answer for whether a given group should break, because that depends on indentation and what nodes came before on the same line.</p> <p>This means we need to perform a second pass: having laid everything out assuming no group is broken, we must lay things out as they would appear when we render them, taking into account breaking. But now that we know the maximum width of each group if left unbroken, we can make breaking decisions.</p> <p>As we walk the DOM, we keep track of the current column and indentation value. For each group, we decide to break it if either:</p> <ol> <li> <p>Its width, plus the current column value, exceeds the maximum column width.</p> </li> <li> <p>It contains any newlines, something that can be determined in the first pass.</p> </li> </ol> <p>The first case is why we can’t actually treat tabs as if they advance to a tabstop. We cannot know the column at which a node will be placed at the time that we measure its width, so we need to assume the worst case.</p> <p>Whenever we hit a newline, we update the current width to the width induced by indentation, simulating a newline plus indent. We also need to evaluate the condition, if present, on each tag now, since by the time we inspect a non-group tag, we have already made a decision as to whether to break or not.</p> <h3 id="render-it"><a href="#render-it">Render It!</a></h3> <p>Now that everything is determined, rendering is super easy: just walk the DOM and print out all the text nodes that either have no condition or whose condition matches the innermost group they’re inside of.</p> <p>And, of course, this is where we need to be careful with indentation: you don’t want to have lines that end in whitespace, so you should make sure to not print out any spaces until text is written after a newline. This is also a good opportunity to merge adjacent only-newlines text blocks. The merge algorithm I like is to make sure that when <code class="language-plaintext highlighter-rouge">n</code> and <code class="language-plaintext highlighter-rouge">m</code> newline blocks are adjacent, print <code class="language-plaintext highlighter-rouge">max(n, m)</code> newlines. This ensures that a DOM node containing <code class="language-plaintext highlighter-rouge">\n\n\n</code> is respected, while deleting a bunch of <code class="language-plaintext highlighter-rouge">\n</code>s in a row that would result in many blank lines.</p> <p>What’s awesome about this approach is that the layout algorithm is highly generic: you can re-use it for whatever compiler frontend you like, without needing to fuss with layout yourself. There is a very direct conversion from AST to DOM, and the result is very declarative.</p> <h3 id="more-complicated-yaml"><a href="#more-complicated-yaml">More Complicated: YAML</a></h3> <p>YAML is a superset of JSON that SREs use to write sentient configuration files. It has a funny list syntax that we might want to use for multi-line lists, but we might want to keep JSON-style lists for short ones.</p> <p>A document of nested lists might look something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="pi">-</span> <span class="pi">[</span><span class="nv">1</span><span class="pi">,</span> <span class="nv">2</span><span class="pi">,</span> <span class="nv">3</span><span class="pi">,</span> <span class="nv">4</span><span class="pi">,</span> <span class="nv">5</span><span class="pi">,</span> <span class="nv">6</span><span class="pi">,</span> <span class="nv">7</span><span class="pi">,</span> <span class="nv">8</span><span class="pi">,</span> <span class="nv">9</span><span class="pi">,</span> <span class="nv">10</span><span class="pi">,</span> <span class="nv">11</span><span class="pi">,</span> <span class="nv">12</span><span class="pi">]</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">13</span><span class="pi">,</span> <span class="nv">14</span><span class="pi">,</span> <span class="nv">15</span><span class="pi">,</span> <span class="nv">16</span><span class="pi">,</span> <span class="nv">17</span><span class="pi">,</span> <span class="nv">18</span><span class="pi">,</span> <span class="nv">19</span><span class="pi">,</span> <span class="nv">20</span><span class="pi">,</span> <span class="nv">21</span><span class="pi">,</span> <span class="nv">22</span><span class="pi">,</span> <span class="nv">23</span><span class="pi">]</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">YAML</div></div></div> <p>How might we represent this in the DOM? Starting from our original JSON document <code class="language-plaintext highlighter-rouge">{"foo": [1, 2]}</code>, we might go for something like this:</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;group&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"{"</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">'"foo"'</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">":"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;group&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"["</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"- "</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/indent&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">","</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">" "</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"- "</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;indent</span> <span class="na">by=</span><span class="s">"  "</span><span class="nt">&gt;</span>
        <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/indent&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"]"</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/group&gt;</span>
  <span class="nt">&lt;/indent&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"\n"</span> <span class="na">if=</span><span class="s">broken</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;text</span> <span class="na">s=</span><span class="s">"}"</span> <span class="na">if=</span><span class="s">flat</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/group&gt;</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">XML</div></div></div> <p>Here, we’ve made the <code class="language-plaintext highlighter-rouge">[]</code> and the comma only appear in flat mode, while in broken mode, we have a <code class="language-plaintext highlighter-rouge">- </code> prefix for each item. The inserted newlines have also changed somewhat, and the indentation blocks have moved: now only the value is indented, since YAML allows the <code class="language-plaintext highlighter-rouge">-</code>s of list items to be at the same indentation level as the parent value for lists nested in objects. (This is a case where some layout logic is language-specific, but now the output is worrying about declarative markup rather than physical measurements.)</p> <p>There are other enhancements you might want to make to the DOM I don’t describe here. For example, comments want to be word-wrapped, but you might not know what the width is until layout happens. Having a separate tag for word-wrapped blocks would help here.</p> <p>Similarly, a mechanism for “partial breaks”, such as for the document below, could be implemented by having a type of line break tag that breaks if the text that follows overflows the column, which can be easily implemented by tracking the position of the last such break tag.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"very"</span><span class="p">,</span><span class="w"> </span><span class="s2">"long"</span><span class="p">,</span><span class="w"> </span><span class="s2">"list"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"of"</span><span class="p">,</span><span class="w"> </span><span class="s2">"strings"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">JSON</div></div></div> <h2 id="using-this-yourself"><a href="#using-this-yourself">Using This Yourself</a></h2> <p>I think that a really good formatter is essential for any programming language, and I think that a high-quality library that does most of the heavy-lifting is important to make it easier to demand good formatters.</p> <p><a href="https://github.com/mcy/strings/tree/main/allman">So I wrote a Rust library.</a> I haven’t released it on crates.io because I don’t think it’s quite at the state I want, but it turns out that the layout algorithm is very simple, so porting this to other languages should be EZ.</p> <p>Now you have no excuse. :D</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:pronunciation" role="doc-endnote"> <p>Everyone pronounces this acronym “ay ess tee”, but I have a friend who really like to say <em>ast</em>, rhyming with <em>mast</em>, so I’m making a callout post my twitter dot com. <a href="#fnref:pronunciation" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:stanza" role="doc-endnote"> <p>In computing, a group of lines not separated by blank lines is called a stanza, in analogy to the stanzas of a poem, which are typeset with no blank lines between the lines of the stanza. <a href="#fnref:stanza" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:offsets" role="doc-endnote"> <p>You could also just store a string, containing the original text, but storing offsets is necessary for <em>diagnostics</em>, which is the jargon term for a compiler error. Compiler errors are recorded using an AST node as context, and to report the line at which the error occurred, we need to be able to map the node back to its offset in the file.</p> <p>Once we have the offset, we can calculate the line in <span class="katex-inl"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> time using binary search. Having pre-computed an array of the offset of each <code class="language-plaintext highlighter-rouge">\n</code> byte in the input file, binary search will tell us the index and offset of the <code class="language-plaintext highlighter-rouge">\n</code> before the token; this index is the zero-indexed line number, and the string from that <code class="language-plaintext highlighter-rouge">\n</code> to the offset can be used to calculate the column.</p> <div class="codeblock"><figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">use</span> <span class="nn">unicode_width</span><span class="p">::</span><span class="n">UnicodeWidthStr</span><span class="p">;</span>

<span class="cd">/// Returns the index of each newline. Can be pre-computed and re-used</span>
<span class="cd">/// multiple times.</span>
<span class="k">fn</span> <span class="nf">newlines</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">file</span><span class="nf">.bytes</span><span class="p">()</span>
      <span class="nf">.enumerate</span><span class="p">()</span>
      <span class="nf">.filter_map</span><span class="p">(|(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">)|</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="sc">b'\n'</span><span class="p">)</span><span class="nf">.then_some</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>

<span class="cd">/// Returns the line and column of the given offset, given the line</span>
<span class="cd">/// tarts of the file.</span>
<span class="k">fn</span> <span class="nf">location</span><span class="p">(</span>
  <span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
  <span class="n">newlines</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">usize</span><span class="p">],</span>
  <span class="n">offset</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">match</span> <span class="n">newlines</span><span class="nf">.binary_search</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ok means that offset refers to a newline, so this means</span>
    <span class="c1">// we want to return the width of the line that it ends as</span>
    <span class="c1">// the column.</span>
    <span class="c1">//</span>
    <span class="c1">// Err means that this is after the nth newline, except Err(0),</span>
    <span class="c1">// which means it is before the first one.</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">|</span> <span class="nf">Err</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="o">..</span><span class="n">offset</span><span class="p">]</span><span class="nf">.width</span><span class="p">()),</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="n">newlines</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">..</span><span class="n">offset</span><span class="p">]</span><span class="nf">.width</span><span class="p">()),</span>
    <span class="nf">Err</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="n">newlines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">..</span><span class="n">offset</span><span class="p">]</span><span class="nf">.width</span><span class="p">()),</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><div class="codeblock-buttons"><div class="codeblock-button">Rust</div></div></div> <p><a href="#fnref:offsets" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:80-cols" role="doc-endnote"> <p>The Rust people keep trying to convince me that it should be 100. They are wrong. 80 is perfect. They only think they need 100 because they use the incorrect tab width of four spaces, rather than two. This is the default for clang-format and it’s <em>perfect</em>. <a href="#fnref:80-cols" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </div> </div> <div class="pagination post-footer"> <span class="pagination-item newer">&lt; Prev</span> • <a class="pagination-item older" href="https://mcyoung.xyz/page2">Next &gt;</a> </div></div> <div class="sidebar show-if-mobile footer"> <div class="container sidebar-sticky"> <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA</a> • <a href="https://varz.mcyoung.xyz/">Site Analytics</a> <br> &copy; 2025 Miguel Young de la Sota </div> </div> </body> </html>